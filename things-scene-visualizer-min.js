(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var OIMO={REVISION:"1.2",nextID:0,proxyID:0,BR_NULL:0,BR_BRUTE_FORCE:1,BR_SWEEP_AND_PRUNE:2,BR_BOUNDING_VOLUME_TREE:3,BODY_NULL:0,BODY_DYNAMIC:1,BODY_STATIC:2,SHAPE_NULL:0,SHAPE_SPHERE:1,SHAPE_BOX:2,SHAPE_CYLINDER:3,SHAPE_TETRA:4,JOINT_NULL:0,JOINT_DISTANCE:1,JOINT_BALL_AND_SOCKET:2,JOINT_HINGE:3,JOINT_WHEEL:4,JOINT_SLIDER:5,JOINT_PRISMATIC:6,WORLD_SCALE:100,INV_SCALE:.01,AABB_PROX:.005,sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,lerp:function(a,b,percent){return a+(b-a)*percent},rand:function(a,b){return OIMO.lerp(a,b,OIMO.random())},randInt:function(a,b,n){return OIMO.lerp(a,b,OIMO.random()).toFixed(n||0)*1},int:function(x){return~~x},fix:function(x,n){return x.toFixed(n||3,10)},clamp:function(value,min,max){return OIMO.max(min,OIMO.min(max,value))},degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,CustomError:null,Error:function(Class,Msg){if(OIMO.CustomError==null)console.error(Class,Msg);else OIMO.CustomError.innerHTML+=Class+" - "+Msg+"<br>"}};var OIMO_ARRAY_TYPE;if(!OIMO_ARRAY_TYPE){OIMO_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array}try{(function(w){var perfNow;var perfNowNames=["now","webkitNow","msNow","mozNow"];if(!!w["performance"])for(var i=0;i<perfNowNames.length;++i){var n=perfNowNames[i];if(!!w["performance"][n]){perfNow=function(){return w["performance"][n]()};break}}if(!perfNow)perfNow=Date.now;OIMO.now=perfNow})(window)}catch(e){OIMO.now=function(){return 0}}OIMO.World=function(TimeStep,BroadPhaseType,Iterations,NoStat){this.timeStep=TimeStep||.01666;this.numIterations=Iterations||8;switch(BroadPhaseType||2){case 1:this.broadPhase=new OIMO.BruteForceBroadPhase;break;case 2:default:this.broadPhase=new OIMO.SAPBroadPhase;break;case 3:this.broadPhase=new OIMO.DBVTBroadPhase;break}this.performance=null;this.isNoStat=NoStat||false;if(!this.isNoStat)this.performance=new OIMO.Performance(this);this.enableRandomizer=true;this.rigidBodies=null;this.numRigidBodies=0;this.contacts=null;this.unusedContacts=null;this.numContacts=0;this.numContactPoints=0;this.joints=null;this.numJoints=0;this.numIslands=0;this.gravity=new OIMO.Vec3(0,-9.80665,0);var numShapeTypes=5;this.detectors=[];this.detectors.length=numShapeTypes;var i=numShapeTypes;while(i--){this.detectors[i]=[];this.detectors[i].length=numShapeTypes}this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector(false);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector(true);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=new OIMO.BoxBoxCollisionDetector;this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_CYLINDER]=new OIMO.CylinderCylinderCollisionDetector;this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_BOX]=new OIMO.BoxCylinderCollisionDetector(true);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_CYLINDER]=new OIMO.BoxCylinderCollisionDetector(false);this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_SPHERE]=new OIMO.SphereCylinderCollisionDetector(true);this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_CYLINDER]=new OIMO.SphereCylinderCollisionDetector(false);this.detectors[OIMO.SHAPE_TETRA][OIMO.SHAPE_TETRA]=new OIMO.TetraTetraCollisionDetector;this.randX=65535;this.randA=98765;this.randB=123456789;this.islandRigidBodies=[];this.islandStack=[];this.islandConstraints=[]};OIMO.World.prototype={constructor:OIMO.World,clear:function(){this.randX=65535;while(this.joints!==null){this.removeJoint(this.joints)}while(this.contacts!==null){this.removeContact(this.contacts)}while(this.rigidBodies!==null){this.removeRigidBody(this.rigidBodies)}OIMO.nextID=0;OIMO.proxyID=0},addRigidBody:function(rigidBody){if(rigidBody.parent){OIMO.Error("World","It is not possible to be added to more than one world one of the rigid body")}rigidBody.parent=this;rigidBody.awake();for(var shape=rigidBody.shapes;shape!==null;shape=shape.next){this.addShape(shape)}if(this.rigidBodies!==null)(this.rigidBodies.prev=rigidBody).next=this.rigidBodies;this.rigidBodies=rigidBody;this.numRigidBodies++},removeRigidBody:function(rigidBody){var remove=rigidBody;if(remove.parent!==this)return;remove.awake();var js=remove.jointLink;while(js!=null){var joint=js.joint;js=js.next;this.removeJoint(joint)}for(var shape=rigidBody.shapes;shape!==null;shape=shape.next){this.removeShape(shape)}var prev=remove.prev;var next=remove.next;if(prev!==null)prev.next=next;if(next!==null)next.prev=prev;if(this.rigidBodies==remove)this.rigidBodies=next;remove.prev=null;remove.next=null;remove.parent=null;this.numRigidBodies--},getByName:function(name){var result=null;var body=this.rigidBodies;while(body!==null){if(body.name!==" "&&body.name===name)result=body;body=body.next}var joint=this.joints;while(joint!==null){if(joint.name!==""&&joint.name===name)result=joint;joint=joint.next}return result},addShape:function(shape){if(!shape.parent||!shape.parent.parent){OIMO.Error("World","It is not possible to be added alone to shape world")}shape.proxy=this.broadPhase.createProxy(shape);shape.updateProxy();this.broadPhase.addProxy(shape.proxy)},removeShape:function(shape){this.broadPhase.removeProxy(shape.proxy);shape.proxy=null},addJoint:function(joint){if(joint.parent){OIMO.Error("World","It is not possible to be added to more than one world one of the joint")}if(this.joints!=null)(this.joints.prev=joint).next=this.joints;this.joints=joint;joint.parent=this;this.numJoints++;joint.awake();joint.attach()},removeJoint:function(joint){var remove=joint;var prev=remove.prev;var next=remove.next;if(prev!==null)prev.next=next;if(next!==null)next.prev=prev;if(this.joints==remove)this.joints=next;remove.prev=null;remove.next=null;this.numJoints--;remove.awake();remove.detach();remove.parent=null},worldscale:function(scale){OIMO.WORLD_SCALE=scale||100;OIMO.INV_SCALE=1/OIMO.WORLD_SCALE},addContact:function(s1,s2){var newContact;if(this.unusedContacts!==null){newContact=this.unusedContacts;this.unusedContacts=this.unusedContacts.next}else{newContact=new OIMO.Contact}newContact.attach(s1,s2);newContact.detector=this.detectors[s1.type][s2.type];if(this.contacts)(this.contacts.prev=newContact).next=this.contacts;this.contacts=newContact;this.numContacts++},removeContact:function(contact){var prev=contact.prev;var next=contact.next;if(next)next.prev=prev;if(prev)prev.next=next;if(this.contacts==contact)this.contacts=next;contact.prev=null;contact.next=null;contact.detach();contact.next=this.unusedContacts;this.unusedContacts=contact;this.numContacts--},checkContact:function(name1,name2){var n1,n2;var contact=this.contacts;while(contact!==null){n1=contact.body1.name||" ";n2=contact.body2.name||" ";if(n1==name1&&n2==name2||n2==name1&&n1==name2){if(contact.touching)return true;else return false}else contact=contact.next}return false},callSleep:function(body){if(!body.allowSleep)return false;if(body.linearVelocity.lengthSq()>.04)return false;if(body.angularVelocity.lengthSq()>.25)return false;return true},step:function(){var time0,time1,time2,time3;var stat=!this.isNoStat?true:false;if(stat)time0=OIMO.now();var body=this.rigidBodies;while(body!==null){body.addedToIsland=false;if(body.sleeping){if(body.linearVelocity.testZero()||body.angularVelocity.testZero()||body.position.testDiff(body.sleepPosition)||body.orientation.testDiff(body.sleepOrientation))body.awake()}body=body.next}if(stat)time1=OIMO.now();this.broadPhase.detectPairs();var pairs=this.broadPhase.pairs;var i=this.broadPhase.numPairs;while(i--){var pair=pairs[i];var s1;var s2;if(pair.shape1.id<pair.shape2.id){s1=pair.shape1;s2=pair.shape2}else{s1=pair.shape2;s2=pair.shape1}var link;if(s1.numContacts<s2.numContacts)link=s1.contactLink;else link=s2.contactLink;var exists=false;while(link){var contact=link.contact;if(contact.shape1==s1&&contact.shape2==s2){contact.persisting=true;exists=true;break}link=link.next}if(!exists){this.addContact(s1,s2)}}if(stat){time2=OIMO.now();this.performance.broadPhaseTime=time2-time1}this.numContactPoints=0;contact=this.contacts;while(contact!==null){if(!contact.persisting){if(contact.shape1.aabb.intersectTest(contact.shape2.aabb)){var next=contact.next;this.removeContact(contact);contact=next;continue}}var b1=contact.body1;var b2=contact.body2;if(b1.isDynamic&&!b1.sleeping||b2.isDynamic&&!b2.sleeping){contact.updateManifold()}this.numContactPoints+=contact.manifold.numPoints;contact.persisting=false;contact.constraint.addedToIsland=false;contact=contact.next}if(stat){time3=OIMO.now();this.performance.narrowPhaseTime=time3-time2}var invTimeStep=1/this.timeStep;var joint;var constraint;for(joint=this.joints;joint!==null;joint=joint.next){joint.addedToIsland=false}this.islandRigidBodies=[];this.islandConstraints=[];this.islandStack=[];time1=OIMO.now();this.numIslands=0;for(var base=this.rigidBodies;base!==null;base=base.next){if(base.addedToIsland||base.isStatic||base.sleeping)continue;if(base.isLonely()){if(base.isDynamic){base.linearVelocity.addTime(this.gravity,this.timeStep)}if(this.callSleep(base)){base.sleepTime+=this.timeStep;if(base.sleepTime>.5)base.sleep();else base.updatePosition(this.timeStep)}else{base.sleepTime=0;base.updatePosition(this.timeStep)}this.numIslands++;continue}var islandNumRigidBodies=0;var islandNumConstraints=0;var stackCount=1;this.islandStack[0]=base;base.addedToIsland=true;do{body=this.islandStack[--stackCount];this.islandStack[stackCount]=null;body.sleeping=false;this.islandRigidBodies[islandNumRigidBodies++]=body;if(body.isStatic)continue;for(var cs=body.contactLink;cs!==null;cs=cs.next){var contact=cs.contact;constraint=contact.constraint;if(constraint.addedToIsland||!contact.touching)continue;this.islandConstraints[islandNumConstraints++]=constraint;constraint.addedToIsland=true;var next=cs.body;if(next.addedToIsland)continue;this.islandStack[stackCount++]=next;next.addedToIsland=true}for(var js=body.jointLink;js!==null;js=js.next){constraint=js.joint;if(constraint.addedToIsland)continue;this.islandConstraints[islandNumConstraints++]=constraint;constraint.addedToIsland=true;next=js.body;if(next.addedToIsland||!next.isDynamic)continue;this.islandStack[stackCount++]=next;next.addedToIsland=true}}while(stackCount!=0);var gVel=(new OIMO.Vec3).addTime(this.gravity,this.timeStep);var j=islandNumRigidBodies;while(j--){body=this.islandRigidBodies[j];if(body.isDynamic){body.linearVelocity.addEqual(gVel)}}if(this.enableRandomizer){j=islandNumConstraints;while(j--){if(j!==0){var swap=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*j|0;constraint=this.islandConstraints[j];this.islandConstraints[j]=this.islandConstraints[swap];this.islandConstraints[swap]=constraint}}}j=islandNumConstraints;while(j--){this.islandConstraints[j].preSolve(this.timeStep,invTimeStep)}var k=this.numIterations;while(k--){j=islandNumConstraints;while(j--){this.islandConstraints[j].solve()}}j=islandNumConstraints;while(j--){this.islandConstraints[j].postSolve();this.islandConstraints[j]=null}var sleepTime=10;j=islandNumRigidBodies;while(j--){body=this.islandRigidBodies[j];if(this.callSleep(body)){body.sleepTime+=this.timeStep;if(body.sleepTime<sleepTime)sleepTime=body.sleepTime}else{body.sleepTime=0;sleepTime=0;continue}}if(sleepTime>.5){j=islandNumRigidBodies;while(j--){this.islandRigidBodies[j].sleep();this.islandRigidBodies[j]=null}}else{j=islandNumRigidBodies;while(j--){this.islandRigidBodies[j].updatePosition(this.timeStep);this.islandRigidBodies[j]=null}}this.numIslands++}if(stat){time2=OIMO.now();this.performance.solvingTime=time2-time1;time2=OIMO.now();this.performance.upfps();this.performance.totalTime=time2-time0}}};OIMO.RigidBody=function(x,y,z,rad,ax,ay,az){this.name=" ";this.MAX_SHAPES=64;this.prev=null;this.next=null;this.type=OIMO.BODY_NULL;this.massInfo=new OIMO.MassInfo;this.position=new OIMO.Vec3(x,y,z);this.orientation=this.rotationAxisToQuad(rad||0,ax||0,ay||0,az||0);this.newPosition=new OIMO.Vec3;this.controlPos=false;this.newOrientation=new OIMO.Quat;this.newRotation=new OIMO.Vec3;this.currentRotation=new OIMO.Vec3;this.controlRot=false;this.controlRotInTime=false;this.linearVelocity=new OIMO.Vec3;this.angularVelocity=new OIMO.Vec3;this.matrix=new OIMO.Mat44;this.parent=null;this.contactLink=null;this.numContacts=0;this.shapes=null;this.numShapes=0;this.jointLink=null;this.numJoints=0;this.sleepPosition=new OIMO.Vec3;this.sleepOrientation=new OIMO.Quat;this.isStatic=false;this.isDynamic=false;this.rotation=new OIMO.Mat33;this.mass=NaN;this.inverseMass=NaN;this.inverseInertia=new OIMO.Mat33;this.localInertia=new OIMO.Mat33;this.inverseLocalInertia=new OIMO.Mat33;this.addedToIsland=false;this.allowSleep=true;this.sleepTime=0;this.sleeping=false};OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(shape){if(shape.parent)OIMO.Error("RigidBody","It is not possible that you add to the multi-rigid body the shape of one");if(this.shapes!=null)(this.shapes.prev=shape).next=this.shapes;this.shapes=shape;shape.parent=this;if(this.parent)this.parent.addShape(shape);this.numShapes++},removeShape:function(shape){var remove=shape;if(remove.parent!=this)return;var prev=remove.prev;var next=remove.next;if(prev!=null)prev.next=next;if(next!=null)next.prev=prev;if(this.shapes==remove)this.shapes=next;remove.prev=null;remove.next=null;remove.parent=null;if(this.parent)this.parent.removeShape(remove);this.numShapes--},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(name){this.parent.checkContact(this.name,name)},setupMass:function(type,AdjustPosition){var adjustPosition=AdjustPosition!==undefined?AdjustPosition:true;this.type=type||OIMO.BODY_DYNAMIC;this.isDynamic=this.type==OIMO.BODY_DYNAMIC;this.isStatic=this.type==OIMO.BODY_STATIC;this.mass=0;this.localInertia.set(0,0,0,0,0,0,0,0,0);var te=this.localInertia.elements;var tmpM=new OIMO.Mat33;var tmpV=new OIMO.Vec3;for(var shape=this.shapes;shape!=null;shape=shape.next){shape.calculateMassInfo(this.massInfo);var shapeMass=this.massInfo.mass;var relX=shape.relativePosition.x;var relY=shape.relativePosition.y;var relZ=shape.relativePosition.z;tmpV.addScale(shape.relativePosition,shapeMass);this.mass+=shapeMass;this.rotateInertia(shape.relativeRotation,this.massInfo.inertia,tmpM);this.localInertia.addEqual(tmpM);te[0]+=shapeMass*(relY*relY+relZ*relZ);te[4]+=shapeMass*(relX*relX+relZ*relZ);te[8]+=shapeMass*(relX*relX+relY*relY);var xy=shapeMass*relX*relY;var yz=shapeMass*relY*relZ;var zx=shapeMass*relZ*relX;te[1]-=xy;te[3]-=xy;te[2]-=yz;te[6]-=yz;te[5]-=zx;te[7]-=zx}this.inverseMass=1/this.mass;tmpV.scaleEqual(this.inverseMass);if(adjustPosition){this.position.addEqual(tmpV);for(shape=this.shapes;shape!=null;shape=shape.next){shape.relativePosition.subEqual(tmpV)}relX=tmpV.x;relY=tmpV.y;relZ=tmpV.z;te[0]-=this.mass*(relY*relY+relZ*relZ);te[4]-=this.mass*(relX*relX+relZ*relZ);te[8]-=this.mass*(relX*relX+relY*relY);xy=this.mass*relX*relY;yz=this.mass*relY*relZ;zx=this.mass*relZ*relX;te[1]+=xy;te[3]+=xy;te[2]+=yz;te[6]+=yz;te[5]+=zx;te[7]+=zx}this.inverseLocalInertia.invert(this.localInertia);if(this.type==OIMO.BODY_STATIC){this.inverseMass=0;this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)}this.syncShapes();this.awake()},awake:function(){if(!this.allowSleep||!this.sleeping)return;this.sleeping=false;this.sleepTime=0;var cs=this.contactLink;while(cs!=null){cs.body.sleepTime=0;cs.body.sleeping=false;cs=cs.next}var js=this.jointLink;while(js!=null){js.body.sleepTime=0;js.body.sleeping=false;js=js.next}for(var shape=this.shapes;shape!=null;shape=shape.next){shape.updateProxy()}},sleep:function(){if(!this.allowSleep||this.sleeping)return;this.linearVelocity.set(0,0,0);this.angularVelocity.set(0,0,0);this.sleepPosition.copy(this.position);this.sleepOrientation.copy(this.orientation);this.sleepTime=0;this.sleeping=true;for(var shape=this.shapes;shape!=null;shape=shape.next){shape.updateProxy()}},isLonely:function(){return this.numJoints==0&&this.numContacts==0},updatePosition:function(timeStep){switch(this.type){case OIMO.BODY_STATIC:this.linearVelocity.set(0,0,0);this.angularVelocity.set(0,0,0);if(this.controlPos){this.position.copy(this.newPosition);this.controlPos=false}if(this.controlRot){this.orientation.copy(this.newOrientation);this.controlRot=false}break;case OIMO.BODY_DYNAMIC:if(this.controlPos){this.angularVelocity.set(0,0,0);this.linearVelocity.set(0,0,0);this.linearVelocity.x=(this.newPosition.x-this.position.x)/timeStep;this.linearVelocity.y=(this.newPosition.y-this.position.y)/timeStep;this.linearVelocity.z=(this.newPosition.z-this.position.z)/timeStep;this.controlPos=false}if(this.controlRot){this.angularVelocity.set(0,0,0);this.orientation.copy(this.newOrientation);this.controlRot=false}this.position.addTime(this.linearVelocity,timeStep);this.orientation.addTime(this.angularVelocity,timeStep);break;default:OIMO.Error("RigidBody","Invalid type.")}this.syncShapes()},rotateInertia:function(rot,inertia,out){var tm1=rot.elements;var tm2=inertia.elements;var a0=tm1[0],a3=tm1[3],a6=tm1[6];var a1=tm1[1],a4=tm1[4],a7=tm1[7];var a2=tm1[2],a5=tm1[5],a8=tm1[8];var b0=tm2[0],b3=tm2[3],b6=tm2[6];var b1=tm2[1],b4=tm2[4],b7=tm2[7];var b2=tm2[2],b5=tm2[5],b8=tm2[8];var e00=a0*b0+a1*b3+a2*b6;var e01=a0*b1+a1*b4+a2*b7;var e02=a0*b2+a1*b5+a2*b8;var e10=a3*b0+a4*b3+a5*b6;var e11=a3*b1+a4*b4+a5*b7;var e12=a3*b2+a4*b5+a5*b8;var e20=a6*b0+a7*b3+a8*b6;var e21=a6*b1+a7*b4+a8*b7;var e22=a6*b2+a7*b5+a8*b8;var oe=out.elements;oe[0]=e00*a0+e01*a1+e02*a2;oe[1]=e00*a3+e01*a4+e02*a5;oe[2]=e00*a6+e01*a7+e02*a8;oe[3]=e10*a0+e11*a1+e12*a2;oe[4]=e10*a3+e11*a4+e12*a5;oe[5]=e10*a6+e11*a7+e12*a8;oe[6]=e20*a0+e21*a1+e22*a2;oe[7]=e20*a3+e21*a4+e22*a5;oe[8]=e20*a6+e21*a7+e22*a8},syncShapes:function(){var s=this.orientation.s;var x=this.orientation.x;var y=this.orientation.y;var z=this.orientation.z;var x2=2*x;var y2=2*y;var z2=2*z;var xx=x*x2;var yy=y*y2;var zz=z*z2;var xy=x*y2;var yz=y*z2;var xz=x*z2;var sx=s*x2;var sy=s*y2;var sz=s*z2;var tr=this.rotation.elements;tr[0]=1-yy-zz;tr[1]=xy-sz;tr[2]=xz+sy;tr[3]=xy+sz;tr[4]=1-xx-zz;tr[5]=yz-sx;tr[6]=xz-sy;tr[7]=yz+sx;tr[8]=1-xx-yy;this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var shape=this.shapes;shape!=null;shape=shape.next){shape.position.mul(this.position,shape.relativePosition,this.rotation);shape.rotation.mul(this.rotation,shape.relativeRotation);shape.updateProxy()}},applyImpulse:function(position,force){this.linearVelocity.addScale(force,this.inverseMass);var rel=new OIMO.Vec3;rel.sub(position,this.position).cross(rel,force).mulMat(this.inverseInertia,rel);this.angularVelocity.addEqual(rel)},rotationVectToQuad:function(rot){var r=OIMO.EulerToAxis(rot.x*OIMO.degtorad,rot.y*OIMO.degtorad,rot.z*OIMO.degtorad);return this.rotationAxisToQuad(r[0],r[1],r[2],r[3])},rotationAxisToQuad:function(rad,ax,ay,az){var len=ax*ax+ay*ay+az*az;if(len>0){len=1/OIMO.sqrt(len);ax*=len;ay*=len;az*=len}var sin=OIMO.sin(rad*.5);var cos=OIMO.cos(rad*.5);return new OIMO.Quat(cos,sin*ax,sin*ay,sin*az)},setPosition:function(pos){this.newPosition.copy(pos).multiplyScalar(OIMO.INV_SCALE);this.controlPos=true},setQuaternion:function(q){this.newOrientation.set(q.x,q.y,q.z,q.w);this.controlRot=true},setRotation:function(rot){this.newOrientation=this.rotationVectToQuad(rot);this.controlRot=true},resetPosition:function(x,y,z){this.linearVelocity.set(0,0,0);this.angularVelocity.set(0,0,0);this.position.set(x,y,z).multiplyScalar(OIMO.INV_SCALE);this.awake()},resetQuaternion:function(q){this.angularVelocity.set(0,0,0);this.orientation=new OIMO.Quat(q.w,q.x,q.y,q.z);this.awake()},resetRotation:function(x,y,z){this.angularVelocity.set(0,0,0);this.orientation=this.rotationVectToQuad(new OIMO.Vec3(x,y,z));this.awake()},getPosition:function(){return(new OIMO.Vec3).scale(this.position,OIMO.WORLD_SCALE)},getRotation:function(){return(new OIMO.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new OIMO.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var m=this.matrix.elements;var r,p;if(!this.sleeping){r=this.rotation.elements;m[0]=r[0];m[1]=r[3];m[2]=r[6];m[3]=0;m[4]=r[1];m[5]=r[4];m[6]=r[7];m[7]=0;m[8]=r[2];m[9]=r[5];m[10]=r[8];m[11]=0;p=this.position;m[12]=p.x*OIMO.WORLD_SCALE;m[13]=p.y*OIMO.WORLD_SCALE;m[14]=p.z*OIMO.WORLD_SCALE;m[15]=0}else{m[15]=1}return m}};OIMO.Body=function(Obj){var obj=Obj||{};if(!obj.world)return;if(obj.type===undefined)obj.type="box";this.name=obj.name||"";this.body=obj.world.add(obj)};OIMO.Body.prototype={constructor:OIMO.Body,setPosition:function(pos){this.body.setPosition(pos)},setQuaternion:function(q){this.body.setQuaternion(q)},setRotation:function(rot){this.body.setRotation(rot)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(x,y,z){this.body.resetPosition(x,y,z)},resetRotation:function(x,y,z){this.body.resetRotation(x,y,z)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(name){this.body.checkContact(name)}};OIMO.Link=function(Obj){var obj=Obj||{};if(!obj.world)return;if(obj.type===undefined)obj.type="jointHinge";this.name=obj.name||"";this.joint=obj.world.add(obj)};OIMO.Link.prototype={constructor:OIMO.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}};OIMO.Dictionary=function(){this.data={};this.keys=[]};OIMO.Dictionary.prototype={constructor:OIMO.Dictionary,set:function(value){var key=value.id;if(!this.get[key])this.keys.push(key);this.data[key]=value},get:function(id){return this.data[id]},del:function(value){var k=this.keys;var n=k.indexOf(value.id);if(n>-1){delete this.data[k[n]];k.splice(n,1)}},reset:function(){var data=this.data,keys=this.keys,key;while(keys.length>0){key=keys.pop();delete data[key]}}};OIMO.Performance=function(world){this.parent=world;this.infos=new OIMO_ARRAY_TYPE(13);this.f=[0,0,0];this.types=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"];this.broadPhase=this.types[this.parent.broadPhase.types];this.version=OIMO.REVISION;this.fps=0;this.broadPhaseTime=0;this.narrowPhaseTime=0;this.solvingTime=0;this.totalTime=0};OIMO.Performance.prototype={upfps:function(){this.f[1]=Date.now();if(this.f[1]-1e3>this.f[0]){this.f[0]=this.f[1];this.fps=this.f[2];this.f[2]=0}this.f[2]++},updatingTime:function(){return OIMO.fix(this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime))},show:function(){var info=["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconde<br><br>","broad-phase &nbsp;"+OIMO.fix(this.broadPhaseTime)+"<br>","narrow-phase "+OIMO.fix(this.narrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+OIMO.fix(this.solvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+OIMO.fix(this.totalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime()+"<br>"].join("\n");return info},toArray:function(){this.infos[0]=this.parent.broadPhase.types;this.infos[1]=this.parent.numRigidBodies;this.infos[2]=this.parent.numContacts;this.infos[3]=this.parent.broadPhase.numPairChecks;this.infos[4]=this.parent.numContactPoints;this.infos[5]=this.parent.numIslands;this.infos[6]=this.broadPhaseTime;this.infos[7]=this.narrowPhaseTime;this.infos[8]=this.solvingTime;this.infos[9]=this.updatingTime();this.infos[10]=this.totalTime;this.infos[11]=this.fps;return this.infos}};OIMO.Mat44=function(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){this.elements=new OIMO_ARRAY_TYPE(16);var te=this.elements;te[0]=n11!==undefined?n11:1;te[4]=n12||0;te[8]=n13||0;te[12]=n14||0;te[1]=n21||0;te[5]=n22!==undefined?n22:1;te[9]=n23||0;te[13]=n24||0;te[2]=n31||0;te[6]=n32||0;te[10]=n33!==undefined?n33:1;te[14]=n34||0;te[3]=n41||0;te[7]=n42||0;te[11]=n43||0;te[15]=n44!==undefined?n44:1};OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){var te=this.elements;te[0]=n11;te[4]=n12;te[8]=n13;te[12]=n14;te[1]=n21;te[5]=n22;te[9]=n23;te[13]=n24;te[2]=n31;te[6]=n32;te[10]=n33;te[14]=n34;te[3]=n41;te[7]=n42;te[11]=n43;te[15]=n44;return this}};OIMO.Mat33=function(e00,e01,e02,e10,e11,e12,e20,e21,e22){this.elements=new OIMO_ARRAY_TYPE(9);var te=this.elements;this.init(e00!==undefined?e00:1,e01||0,e02||0,e10||0,e11!==undefined?e11:1,e12||0,e20||0,e21||0,e22!==undefined?e22:1)};OIMO.Mat33.prototype={constructor:OIMO.Mat33,set:function(e00,e01,e02,e10,e11,e12,e20,e21,e22){var te=this.elements;te[0]=e00;te[1]=e01;te[2]=e02;te[3]=e10;te[4]=e11;te[5]=e12;te[6]=e20;te[7]=e21;te[8]=e22;return this},init:function(e00,e01,e02,e10,e11,e12,e20,e21,e22){var te=this.elements;te[0]=e00;te[1]=e01;te[2]=e02;te[3]=e10;te[4]=e11;te[5]=e12;te[6]=e20;te[7]=e21;te[8]=e22;return this},multiply:function(s){var te=this.elements;te[0]*=s;te[1]*=s;te[2]*=s;te[3]*=s;te[4]*=s;te[5]*=s;te[6]*=s;te[7]*=s;te[8]*=s;return this},add:function(m1,m2){var te=this.elements,tem1=m1.elements,tem2=m2.elements;te[0]=tem1[0]+tem2[0];te[1]=tem1[1]+tem2[1];te[2]=tem1[2]+tem2[2];te[3]=tem1[3]+tem2[3];te[4]=tem1[4]+tem2[4];te[5]=tem1[5]+tem2[5];te[6]=tem1[6]+tem2[6];te[7]=tem1[7]+tem2[7];te[8]=tem1[8]+tem2[8];return this},addEqual:function(m){var te=this.elements,tem=m.elements;te[0]+=tem[0];te[1]+=tem[1];te[2]+=tem[2];te[3]+=tem[3];te[4]+=tem[4];te[5]+=tem[5];te[6]+=tem[6];te[7]+=tem[7];te[8]+=tem[8];return this},sub:function(m1,m2){var te=this.elements,tem1=m1.elements,tem2=m2.elements;te[0]=tem1[0]-tem2[0];te[1]=tem1[1]-tem2[1];te[2]=tem1[2]-tem2[2];te[3]=tem1[3]-tem2[3];te[4]=tem1[4]-tem2[4];te[5]=tem1[5]-tem2[5];te[6]=tem1[6]-tem2[6];te[7]=tem1[7]-tem2[7];te[8]=tem1[8]-tem2[8];return this},subEqual:function(m){var te=this.elements,tem=m.elements;te[0]-=tem[0];te[1]-=tem[1];te[2]-=tem[2];te[3]-=tem[3];te[4]-=tem[4];te[5]-=tem[5];te[6]-=tem[6];te[7]-=tem[7];te[8]-=tem[8];return this},scale:function(m,s){var te=this.elements,tm=m.elements;te[0]=tm[0]*s;te[1]=tm[1]*s;te[2]=tm[2]*s;te[3]=tm[3]*s;te[4]=tm[4]*s;te[5]=tm[5]*s;te[6]=tm[6]*s;te[7]=tm[7]*s;te[8]=tm[8]*s;return this},scaleEqual:function(s){var te=this.elements;te[0]*=s;te[1]*=s;te[2]*=s;te[3]*=s;te[4]*=s;te[5]*=s;te[6]*=s;te[7]*=s;te[8]*=s;return this},mul:function(m1,m2){var te=this.elements,tm1=m1.elements,tm2=m2.elements,a0=tm1[0],a3=tm1[3],a6=tm1[6],a1=tm1[1],a4=tm1[4],a7=tm1[7],a2=tm1[2],a5=tm1[5],a8=tm1[8],b0=tm2[0],b3=tm2[3],b6=tm2[6],b1=tm2[1],b4=tm2[4],b7=tm2[7],b2=tm2[2],b5=tm2[5],b8=tm2[8];te[0]=a0*b0+a1*b3+a2*b6;te[1]=a0*b1+a1*b4+a2*b7;te[2]=a0*b2+a1*b5+a2*b8;te[3]=a3*b0+a4*b3+a5*b6;te[4]=a3*b1+a4*b4+a5*b7;te[5]=a3*b2+a4*b5+a5*b8;te[6]=a6*b0+a7*b3+a8*b6;te[7]=a6*b1+a7*b4+a8*b7;te[8]=a6*b2+a7*b5+a8*b8;return this},mulScale:function(m,sx,sy,sz,Prepend){var prepend=Prepend||false;var te=this.elements,tm=m.elements;if(prepend){te[0]=sx*tm[0];te[1]=sx*tm[1];te[2]=sx*tm[2];te[3]=sy*tm[3];te[4]=sy*tm[4];te[5]=sy*tm[5];te[6]=sz*tm[6];te[7]=sz*tm[7];te[8]=sz*tm[8]}else{te[0]=tm[0]*sx;te[1]=tm[1]*sy;te[2]=tm[2]*sz;te[3]=tm[3]*sx;te[4]=tm[4]*sy;te[5]=tm[5]*sz;te[6]=tm[6]*sx;te[7]=tm[7]*sy;te[8]=tm[8]*sz}return this},mulRotate:function(m,rad,ax,ay,az,Prepend){var prepend=Prepend||false;var s=OIMO.sin(rad);var c=OIMO.cos(rad);var c1=1-c;var r00=ax*ax*c1+c;var r01=ax*ay*c1-az*s;var r02=ax*az*c1+ay*s;var r10=ay*ax*c1+az*s;var r11=ay*ay*c1+c;var r12=ay*az*c1-ax*s;var r20=az*ax*c1-ay*s;var r21=az*ay*c1+ax*s;var r22=az*az*c1+c;var tm=m.elements;var a0=tm[0],a3=tm[3],a6=tm[6];var a1=tm[1],a4=tm[4],a7=tm[7];var a2=tm[2],a5=tm[5],a8=tm[8];var te=this.elements;if(prepend){te[0]=r00*a0+r01*a3+r02*a6;te[1]=r00*a1+r01*a4+r02*a7;te[2]=r00*a2+r01*a5+r02*a8;te[3]=r10*a0+r11*a3+r12*a6;te[4]=r10*a1+r11*a4+r12*a7;te[5]=r10*a2+r11*a5+r12*a8;te[6]=r20*a0+r21*a3+r22*a6;te[7]=r20*a1+r21*a4+r22*a7;te[8]=r20*a2+r21*a5+r22*a8}else{te[0]=a0*r00+a1*r10+a2*r20;te[1]=a0*r01+a1*r11+a2*r21;te[2]=a0*r02+a1*r12+a2*r22;te[3]=a3*r00+a4*r10+a5*r20;te[4]=a3*r01+a4*r11+a5*r21;te[5]=a3*r02+a4*r12+a5*r22;te[6]=a6*r00+a7*r10+a8*r20;te[7]=a6*r01+a7*r11+a8*r21;te[8]=a6*r02+a7*r12+a8*r22}return this},transpose:function(m){var te=this.elements,tm=m.elements;te[0]=tm[0];te[1]=tm[3];te[2]=tm[6];te[3]=tm[1];te[4]=tm[4];te[5]=tm[7];te[6]=tm[2];te[7]=tm[5];te[8]=tm[8];return this},setQuat:function(q){var te=this.elements,x2=2*q.x,y2=2*q.y,z2=2*q.z,xx=q.x*x2,yy=q.y*y2,zz=q.z*z2,xy=q.x*y2,yz=q.y*z2,xz=q.x*z2,sx=q.s*x2,sy=q.s*y2,sz=q.s*z2;te[0]=1-yy-zz;te[1]=xy-sz;te[2]=xz+sy;te[3]=xy+sz;te[4]=1-xx-zz;te[5]=yz-sx;te[6]=xz-sy;te[7]=yz+sx;te[8]=1-xx-yy;return this},invert:function(m){var te=this.elements,tm=m.elements,a0=tm[0],a3=tm[3],a6=tm[6],a1=tm[1],a4=tm[4],a7=tm[7],a2=tm[2],a5=tm[5],a8=tm[8],b01=a4*a8-a7*a5,b11=a7*a2-a1*a8,b21=a1*a5-a4*a2,dt=a0*b01+a3*b11+a6*b21;if(dt!=0){dt=1/dt}te[0]=dt*b01;te[1]=dt*b11;te[2]=dt*b21;te[3]=dt*(a5*a6-a3*a8);te[4]=dt*(a0*a8-a2*a6);te[5]=dt*(a2*a3-a0*a5);te[6]=dt*(a3*a7-a4*a6);te[7]=dt*(a1*a6-a0*a7);te[8]=dt*(a0*a4-a1*a3);return this},toEuler:function(){function clamp(x){return OIMO.min(OIMO.max(x,-1),1)}var te=this.elements;var m11=te[0],m12=te[3],m13=te[6];var m21=te[1],m22=te[4],m23=te[7];var m31=te[2],m32=te[5],m33=te[8];var p=new OIMO.Vec3;var d=new OIMO.Quat;var s;p.y=OIMO.asin(clamp(m13));if(OIMO.abs(m13)<.99999){p.x=OIMO.atan2(-m23,m33);p.z=OIMO.atan2(-m12,m11)}else{p.x=OIMO.atan2(m32,m22);p.z=0}return p},toString:function(){var te=this.elements;var text="Mat33|"+te[0].toFixed(4)+", "+te[1].toFixed(4)+", "+te[2].toFixed(4)+"|\n"+"     |"+te[3].toFixed(4)+", "+te[4].toFixed(4)+", "+te[5].toFixed(4)+"|\n"+"     |"+te[6].toFixed(4)+", "+te[7].toFixed(4)+", "+te[8].toFixed(4)+"|";return text},multiplyScalar:function(s){var te=this.elements;te[0]*=s;te[3]*=s;te[6]*=s;te[1]*=s;te[4]*=s;te[7]*=s;te[2]*=s;te[5]*=s;te[8]*=s;return this},identity:function(){this.set(1,0,0,0,1,0,0,0,1);return this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(m){var me=m.elements;this.set(me[0],me[3],me[6],me[1],me[4],me[7],me[2],me[5],me[8]);return this},fromArray:function(array){this.elements.set(array);return this},toArray:function(){var te=this.elements;return[te[0],te[1],te[2],te[3],te[4],te[5],te[6],te[7],te[8]]}};OIMO.Quat=function(s,x,y,z){this.s=s!==undefined?s:1;this.x=x||0;this.y=y||0;this.z=z||0};OIMO.Quat.prototype={constructor:OIMO.Quat,set:function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.s=w;return this},init:function(s,x,y,z){this.s=s!==undefined?s:1;this.x=x||0;this.y=y||0;this.z=z||0;return this},add:function(q1,q2){this.s=q1.s+q2.s;this.x=q1.x+q2.x;this.y=q1.y+q2.y;this.z=q1.z+q2.z;return this},addTime:function(v,t){var x=v.x;var y=v.y;var z=v.z;var qs=this.s;var qx=this.x;var qy=this.y;var qz=this.z;t*=.5;var ns=(-x*qx-y*qy-z*qz)*t;var nx=(x*qs+y*qz-z*qy)*t;var ny=(-x*qz+y*qs+z*qx)*t;var nz=(x*qy-y*qx+z*qs)*t;qs+=ns;qx+=nx;qy+=ny;qz+=nz;var s=1/OIMO.sqrt(qs*qs+qx*qx+qy*qy+qz*qz);this.s=qs*s;this.x=qx*s;this.y=qy*s;this.z=qz*s;return this},sub:function(q1,q2){this.s=q1.s-q2.s;this.x=q1.x-q2.x;this.y=q1.y-q2.y;this.z=q1.z-q2.z;return this},scale:function(q,s){this.s=q.s*s;this.x=q.x*s;this.y=q.y*s;this.z=q.z*s;return this},mul:function(q1,q2){var ax=q1.x,ay=q1.y,az=q1.z,as=q1.s,bx=q2.x,by=q2.y,bz=q2.z,bs=q2.s;this.x=ax*bs+as*bx+ay*bz-az*by;this.y=ay*bs+as*by+az*bx-ax*bz;this.z=az*bs+as*bz+ax*by-ay*bx;this.s=as*bs-ax*bx-ay*by-az*bz;return this},arc:function(v1,v2){var x1=v1.x;var y1=v1.y;var z1=v1.z;var x2=v2.x;var y2=v2.y;var z2=v2.z;var d=x1*x2+y1*y2+z1*z2;if(d==-1){x2=y1*x1-z1*z1;y2=-z1*y1-x1*x1;z2=x1*z1+y1*y1;d=1/OIMO.sqrt(x2*x2+y2*y2+z2*z2);this.s=0;this.x=x2*d;this.y=y2*d;this.z=z2*d;return this}var cx=y1*z2-z1*y2;var cy=z1*x2-x1*z2;var cz=x1*y2-y1*x2;this.s=OIMO.sqrt((1+d)*.5);d=.5/this.s;this.x=cx*d;this.y=cy*d;this.z=cz*d;return this},normalize:function(q){var len=OIMO.sqrt(q.s*q.s+q.x*q.x+q.y*q.y+q.z*q.z);if(len>0){len=1/len}this.s=q.s*len;this.x=q.x*len;this.y=q.y*len;this.z=q.z*len;return this},invert:function(q){this.s=q.s;this.x=-q.x;this.y=-q.y;this.z=-q.z;return this},length:function(){return OIMO.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(q){this.s=q.s;this.x=q.x;this.y=q.y;this.z=q.z;return this},testDiff:function(q){if(this.s!==q.s||this.x!==q.x||this.y!==q.y||this.z!==q.z)return true;else return false},clone:function(q){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}};OIMO.Quaternion=function(x,y,z,w){this.x=x||0;this.y=y||0;this.z=z||0;this.w=w!==undefined?w:1};OIMO.Quaternion.prototype={constructor:OIMO.Quaternion,setFromRotationMatrix:function(m){var te=m.elements,m11=te[0],m12=te[1],m13=te[2],m21=te[3],m22=te[4],m23=te[5],m31=te[6],m32=te[7],m33=te[8],trace=m11+m22+m33,s;if(trace>0){s=.5/OIMO.sqrt(trace+1);this.w=.25/s;this.x=(m32-m23)*s;this.y=(m13-m31)*s;this.z=(m21-m12)*s}else if(m11>m22&&m11>m33){s=2*OIMO.sqrt(1+m11-m22-m33);this.w=(m32-m23)/s;this.x=.25*s;this.y=(m12+m21)/s;this.z=(m13+m31)/s}else if(m22>m33){s=2*OIMO.sqrt(1+m22-m11-m33);this.w=(m13-m31)/s;this.x=(m12+m21)/s;this.y=.25*s;this.z=(m23+m32)/s}else{s=2*OIMO.sqrt(1+m33-m11-m22);this.w=(m21-m12)/s;this.x=(m13+m31)/s;this.y=(m23+m32)/s;this.z=.25*s}return this}};OIMO.Vec3=function(x,y,z){this.x=x||0;this.y=y||0;this.z=z||0};OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(x,y,z){this.x=x||0;this.y=y||0;this.z=z||0;return this},set:function(x,y,z){this.x=x;this.y=y;this.z=z;return this},add:function(v1,v2){this.x=v1.x+v2.x;this.y=v1.y+v2.y;this.z=v1.z+v2.z;return this},addEqual:function(v){this.x+=v.x;this.y+=v.y;this.z+=v.z;return this},addTime:function(v,t){this.x+=v.x*t;this.y+=v.y*t;this.z+=v.z*t;return this},sub:function(v1,v2){this.x=v1.x-v2.x;this.y=v1.y-v2.y;this.z=v1.z-v2.z;return this},subEqual:function(v){this.x-=v.x;this.y-=v.y;this.z-=v.z;return this},addScale:function(v,s){this.x+=v.x*s;this.y+=v.y*s;this.z+=v.z*s;return this},scale:function(v,s){this.x=v.x*s;this.y=v.y*s;this.z=v.z*s;return this},scaleEqual:function(s){this.x*=s;this.y*=s;this.z*=s;return this},cross:function(v1,v2){var ax=v1.x,ay=v1.y,az=v1.z,bx=v2.x,by=v2.y,bz=v2.z;this.x=ay*bz-az*by;this.y=az*bx-ax*bz;this.z=ax*by-ay*bx;return this},mul:function(o,v,m){var te=m.elements;this.x=o.x+v.x*te[0]+v.y*te[1]+v.z*te[2];this.y=o.y+v.x*te[3]+v.y*te[4]+v.z*te[5];this.z=o.z+v.x*te[6]+v.y*te[7]+v.z*te[8];return this},mulMat:function(m,v){var te=m.elements;this.x=te[0]*v.x+te[1]*v.y+te[2]*v.z;this.y=te[3]*v.x+te[4]*v.y+te[5]*v.z;this.z=te[6]*v.x+te[7]*v.y+te[8]*v.z;return this},normalize:function(v){var x=v.x,y=v.y,z=v.z;var l=x*x+y*y+z*z;if(l>0){l=1/OIMO.sqrt(l);this.x=x*l;this.y=y*l;this.z=z*l}return this},invert:function(v){this.x=-v.x;this.y=-v.y;this.z=-v.z;return this},negate:function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this},dot:function(v){return this.x*v.x+this.y*v.y+this.z*v.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return OIMO.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(v){this.x=v.x;this.y=v.y;this.z=v.z;return this},applyQuaternion:function(q){var x=this.x;var y=this.y;var z=this.z;var qx=q.x;var qy=q.y;var qz=q.z;var qs=q.s;var ix=qs*x+qy*z-qz*y;var iy=qs*y+qz*x-qx*z;var iz=qs*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;this.x=ix*qs+iw*-qx+iy*-qz-iz*-qy;this.y=iy*qs+iw*-qy+iz*-qx-ix*-qz;this.z=iz*qs+iw*-qz+ix*-qy-iy*-qx;return this},testZero:function(){if(this.x!==0||this.y!==0||this.z!==0)return true;else return false},testDiff:function(v){return v.x!==this.x||v.y!==this.y||v.z!==this.z},equals:function(v){return v.x===this.x&&v.y===this.y&&v.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(scalar){if(isFinite(scalar)){this.x*=scalar;this.y*=scalar;this.z*=scalar}else{this.x=0;this.y=0;this.z=0}return this},divideScalar:function(scalar){return this.multiplyScalar(1/scalar)},norm:function(){return this.divideScalar(this.length())}};OIMO.Euler=function(x,y,z,order){this._x=x||0;this._y=y||0;this._z=z||0;this._order=order||OIMO.Euler.DefaultOrder};OIMO.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];OIMO.Euler.DefaultOrder="XYZ";OIMO.clamp=function(x,a,b){return x<a?a:x>b?b:x};OIMO.Euler.prototype={constructor:OIMO.Euler,_x:0,_y:0,_z:0,_order:OIMO.Euler.DefaultOrder,get x(){return this._x},set x(value){this._x=value;this.onChangeCallback()},get y(){return this._y},set y(value){this._y=value;this.onChangeCallback()},get z(){return this._z},set z(value){this._z=value;this.onChangeCallback()},get order(){return this._order},set order(value){this._order=value;this.onChangeCallback()},set:function(x,y,z,order){this._x=x;this._y=y;this._z=z;this._order=order||this._order;this.onChangeCallback();return this},copy:function(euler){this._x=euler._x;this._y=euler._y;this._z=euler._z;this._order=euler._order;this.onChangeCallback();return this},setFromRotationMatrix:function(m,order){var clamp=OIMO.clamp;var te=m.elements;var m11=te[0],m12=te[1],m13=te[2],m21=te[3],m22=te[4],m23=te[5],m31=te[6],m32=te[7],m33=te[8];order=order||this._order;if(order==="XYZ"){this._y=OIMO.asin(clamp(m13,-1,1));if(OIMO.abs(m13)<.99999){this._x=OIMO.atan2(-m23,m33);this._z=OIMO.atan2(-m12,m11)}else{this._x=OIMO.atan2(m32,m22);this._z=0}}else if(order==="YXZ"){this._x=OIMO.asin(-clamp(m23,-1,1));if(OIMO.abs(m23)<.99999){this._y=OIMO.atan2(m13,m33);this._z=OIMO.atan2(m21,m22)}else{this._y=OIMO.atan2(-m31,m11);this._z=0}}else if(order==="ZXY"){this._x=OIMO.asin(clamp(m32,-1,1));if(OIMO.abs(m32)<.99999){this._y=OIMO.atan2(-m31,m33);this._z=OIMO.atan2(-m12,m22)}else{this._y=0;this._z=OIMO.atan2(m21,m11)}}else if(order==="ZYX"){this._y=OIMO.asin(-clamp(m31,-1,1));if(OIMO.abs(m31)<.99999){this._x=OIMO.atan2(m32,m33);this._z=OIMO.atan2(m21,m11)}else{this._x=0;this._z=OIMO.atan2(-m12,m22)}}else if(order==="YZX"){this._z=OIMO.asin(clamp(m21,-1,1));if(OIMO.abs(m21)<.99999){this._x=OIMO.atan2(-m23,m22);this._y=OIMO.atan2(-m31,m11)}else{this._x=0;this._y=OIMO.atan2(m13,m33)}}else if(order==="XZY"){this._z=OIMO.asin(-clamp(m12,-1,1));if(OIMO.abs(m12)<.99999){this._x=OIMO.atan2(m32,m22);this._y=OIMO.atan2(m13,m11)}else{this._x=OIMO.atan2(-m23,m33);this._y=0}}else{console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+order)}this._order=order;this.onChangeCallback();return this},setFromQuaternion:function(q,order,update){var clamp=OIMO.clamp;var sqx=q.x*q.x;var sqy=q.y*q.y;var sqz=q.z*q.z;var sqw=q.s*q.s;order=order||this._order;if(order==="XYZ"){this._x=OIMO.atan2(2*(q.x*q.s-q.y*q.z),sqw-sqx-sqy+sqz);this._y=OIMO.asin(clamp(2*(q.x*q.z+q.y*q.s),-1,1));this._z=OIMO.atan2(2*(q.z*q.s-q.x*q.y),sqw+sqx-sqy-sqz)}else if(order==="YXZ"){this._x=OIMO.asin(clamp(2*(q.x*q.s-q.y*q.z),-1,1));this._y=OIMO.atan2(2*(q.x*q.z+q.y*q.s),sqw-sqx-sqy+sqz);this._z=OIMO.atan2(2*(q.x*q.y+q.z*q.s),sqw-sqx+sqy-sqz)}else if(order==="ZXY"){this._x=OIMO.asin(clamp(2*(q.x*q.s+q.y*q.z),-1,1));this._y=OIMO.atan2(2*(q.y*q.s-q.z*q.x),sqw-sqx-sqy+sqz);this._z=OIMO.atan2(2*(q.z*q.s-q.x*q.y),sqw-sqx+sqy-sqz)}else if(order==="ZYX"){this._x=OIMO.atan2(2*(q.x*q.s+q.z*q.y),sqw-sqx-sqy+sqz);this._y=OIMO.asin(clamp(2*(q.y*q.s-q.x*q.z),-1,1));this._z=OIMO.atan2(2*(q.x*q.y+q.z*q.s),sqw+sqx-sqy-sqz)}else if(order==="YZX"){this._x=OIMO.atan2(2*(q.x*q.s-q.z*q.y),sqw-sqx+sqy-sqz);this._y=OIMO.atan2(2*(q.y*q.s-q.x*q.z),sqw+sqx-sqy-sqz);this._z=OIMO.asin(clamp(2*(q.x*q.y+q.z*q.s),-1,1))}else if(order==="XZY"){this._x=OIMO.atan2(2*(q.x*q.s+q.y*q.z),sqw-sqx+sqy-sqz);this._y=OIMO.atan2(2*(q.x*q.z+q.y*q.s),sqw+sqx-sqy-sqz);this._z=OIMO.asin(clamp(2*(q.z*q.s-q.x*q.y),-1,1))}else{console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+order)}this._order=order;if(update!==false)this.onChangeCallback();return this},reorder:function(){var q=new OIMO.Quat;return function(newOrder){q.setFromEuler(this);this.setFromQuaternion(q,newOrder)}}(),equals:function(euler){return euler._x===this._x&&euler._y===this._y&&euler._z===this._z&&euler._order===this._order},fromArray:function(array){this._x=array[0];this._y=array[1];this._z=array[2];if(array[3]!==undefined)this._order=array[3];this.onChangeCallback();return this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(callback){this.onChangeCallback=callback;return this},onChangeCallback:function(){},clone:function(){return new OIMO.Euler(this._x,this._y,this._z,this._order)}};OIMO.EulerToAxis=function(ox,oy,oz){var c1=OIMO.cos(oy*.5);var s1=OIMO.sin(oy*.5);var c2=OIMO.cos(oz*.5);var s2=OIMO.sin(oz*.5);var c3=OIMO.cos(ox*.5);var s3=OIMO.sin(ox*.5);var c1c2=c1*c2;var s1s2=s1*s2;var w=c1c2*c3-s1s2*s3;var x=c1c2*s3+s1s2*c3;var y=s1*c2*c3+c1*s2*s3;var z=c1*s2*c3-s1*c2*s3;var angle=2*OIMO.acos(w);var norm=x*x+y*y+z*z;if(norm<.001){x=1;y=z=0}else{norm=OIMO.sqrt(norm);x/=norm;y/=norm;z/=norm}return[angle,x,y,z]};OIMO.EulerToMatrix=function(ox,oy,oz){var ch=OIMO.cos(oy);var sh=OIMO.sin(oy);var ca=OIMO.cos(oz);var sa=OIMO.sin(oz);var cb=OIMO.cos(ox);var sb=OIMO.sin(ox);var mtx=new OIMO.Mat33;var te=mtx.elements;te[0]=ch*ca;te[1]=sh*sb-ch*sa*cb;te[2]=ch*sa*sb+sh*cb;te[3]=sa;te[4]=ca*cb;te[5]=-ca*sb;te[6]=-sh*ca;te[7]=sh*sa*cb+ch*sb;te[8]=-sh*sa*sb+ch*cb;return mtx};OIMO.MatrixToEuler=function(mtx){var te=mtx.elements;var x,y,z;if(te[3]>.998){y=OIMO.atan2(te[2],te[8]);z=OIMO.PI/2;x=0}else if(te[3]<-.998){y=OIMO.atan2(te[2],te[8]);z=-OIMO.PI/2;x=0}else{y=OIMO.atan2(-te[6],te[0]);x=OIMO.atan2(-te[5],te[4]);z=OIMO.asin(te[3])}return[x,y,z]};OIMO.unwrapDegrees=function(r){r=r%360;if(r>180)r-=360;if(r<-180)r+=360;return r};OIMO.unwrapRadian=function(r){r=r%OIMO.TwoPI;if(r>OIMO.PI)r-=OIMO.TwoPI;if(r<-OIMO.PI)r+=OIMO.TwoPI;return r};OIMO.Distance3d=function(p1,p2){var xd=p2[0]-p1[0];var yd=p2[1]-p1[1];var zd=p2[2]-p1[2];return OIMO.sqrt(xd*xd+yd*yd+zd*zd)};OIMO.Constraint=function(){this.parent=null;this.body1=null;this.body2=null;this.addedToIsland=false};OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(timeStep,invTimeStep){OIMO.Error("Constraint","Inheritance error.")},solve:function(){OIMO.Error("Constraint","Inheritance error.")},postSolve:function(){OIMO.Error("Constraint","Inheritance error.")}};OIMO.Joint=function(config){OIMO.Constraint.call(this);this.name="";this.type=OIMO.JOINT_NULL;this.prev=null;this.next=null;this.body1=config.body1;this.body2=config.body2;this.localAnchorPoint1=(new OIMO.Vec3).copy(config.localAnchorPoint1);this.localAnchorPoint2=(new OIMO.Vec3).copy(config.localAnchorPoint2);this.relativeAnchorPoint1=new OIMO.Vec3;this.relativeAnchorPoint2=new OIMO.Vec3;this.anchorPoint1=new OIMO.Vec3;this.anchorPoint2=new OIMO.Vec3;this.allowCollision=config.allowCollision;this.b1Link=new OIMO.JointLink(this);this.b2Link=new OIMO.JointLink(this);this.matrix=new OIMO.Mat44};OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype);OIMO.Joint.prototype.constructor=OIMO.Joint;OIMO.Joint.prototype.updateAnchorPoints=function(){this.relativeAnchorPoint1.mulMat(this.body1.rotation,this.localAnchorPoint1);this.relativeAnchorPoint2.mulMat(this.body2.rotation,this.localAnchorPoint2);this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position);this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)};OIMO.Joint.prototype.attach=function(){this.b1Link.body=this.body2;this.b2Link.body=this.body1;if(this.body1.jointLink!=null)(this.b1Link.next=this.body1.jointLink).prev=this.b1Link;else this.b1Link.next=null;this.body1.jointLink=this.b1Link;this.body1.numJoints++;if(this.body2.jointLink!=null)(this.b2Link.next=this.body2.jointLink).prev=this.b2Link;else this.b2Link.next=null;this.body2.jointLink=this.b2Link;this.body2.numJoints++};OIMO.Joint.prototype.detach=function(){var prev=this.b1Link.prev;var next=this.b1Link.next;if(prev!=null)prev.next=next;if(next!=null)next.prev=prev;if(this.body1.jointLink==this.b1Link)this.body1.jointLink=next;this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.body=null;this.body1.numJoints--;prev=this.b2Link.prev;next=this.b2Link.next;if(prev!=null)prev.next=next;if(next!=null)next.prev=prev;if(this.body2.jointLink==this.b2Link)this.body2.jointLink=next;this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.body=null;this.body2.numJoints--;this.b1Link.body=null;this.b2Link.body=null};OIMO.Joint.prototype.awake=function(){this.body1.awake();this.body2.awake()};OIMO.Joint.prototype.preSolve=function(timeStep,invTimeStep){};OIMO.Joint.prototype.solve=function(){};OIMO.Joint.prototype.postSolve=function(){};OIMO.Joint.prototype.remove=function(){this.dispose()};OIMO.Joint.prototype.dispose=function(){this.parent.removeJoint(this)};OIMO.Joint.prototype.getPosition=function(){var p1=(new OIMO.Vec3).scale(this.anchorPoint1,OIMO.WORLD_SCALE);var p2=(new OIMO.Vec3).scale(this.anchorPoint2,OIMO.WORLD_SCALE);return[p1,p2]};OIMO.Joint.prototype.getMatrix=function(){var m=this.matrix.elements;var p1=this.anchorPoint1;var p2=this.anchorPoint2;m[0]=p1.x*OIMO.WORLD_SCALE;m[1]=p1.y*OIMO.WORLD_SCALE;m[2]=p1.z*OIMO.WORLD_SCALE;m[3]=0;m[4]=p2.x*OIMO.WORLD_SCALE;m[5]=p2.y*OIMO.WORLD_SCALE;m[6]=p2.z*OIMO.WORLD_SCALE;m[7]=0;return m};OIMO.JointConfig=function(){this.body1=null;this.body2=null;this.localAnchorPoint1=new OIMO.Vec3;this.localAnchorPoint2=new OIMO.Vec3;this.localAxis1=new OIMO.Vec3;this.localAxis2=new OIMO.Vec3;this.allowCollision=false};OIMO.JointLink=function(joint){this.prev=null;this.next=null;this.body=null;this.joint=joint};OIMO.LimitMotor=function(axis,fixed){fixed=fixed||false;this.axis=axis;this.angle=0;this.lowerLimit=fixed?0:1;this.upperLimit=0;this.motorSpeed=0;this.maxMotorForce=0;this.frequency=0;this.dampingRatio=0};OIMO.LimitMotor.prototype={constructor:OIMO.LimitMotor,setLimit:function(lowerLimit,upperLimit){this.lowerLimit=lowerLimit;this.upperLimit=upperLimit},setMotor:function(motorSpeed,maxMotorForce){this.motorSpeed=motorSpeed;this.maxMotorForce=maxMotorForce},setSpring:function(frequency,dampingRatio){this.frequency=frequency;this.dampingRatio=dampingRatio}};OIMO.BallAndSocketJoint=function(config){OIMO.Joint.call(this,config);this.type=OIMO.JOINT_BALL_AND_SOCKET;this.lc=new OIMO.LinearConstraint(this)};OIMO.BallAndSocketJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.BallAndSocketJoint.prototype.constructor=OIMO.BallAndSocketJoint;OIMO.BallAndSocketJoint.prototype.preSolve=function(timeStep,invTimeStep){this.updateAnchorPoints();this.lc.preSolve(timeStep,invTimeStep)};OIMO.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()};OIMO.BallAndSocketJoint.prototype.postSolve=function(){};OIMO.DistanceJoint=function(config,minDistance,maxDistance){OIMO.Joint.call(this,config);this.type=OIMO.JOINT_DISTANCE;this.normal=new OIMO.Vec3;this.nr=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.normal,true);this.limitMotor.lowerLimit=minDistance;this.limitMotor.upperLimit=maxDistance;this.t=new OIMO.TranslationalConstraint(this,this.limitMotor)};OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.DistanceJoint.prototype.constructor=OIMO.DistanceJoint;OIMO.DistanceJoint.prototype.preSolve=function(timeStep,invTimeStep){this.updateAnchorPoints();this.nr.sub(this.anchorPoint2,this.anchorPoint1);this.normal.normalize(this.nr);this.t.preSolve(timeStep,invTimeStep)};OIMO.DistanceJoint.prototype.solve=function(){this.t.solve()};OIMO.DistanceJoint.prototype.postSolve=function(){};OIMO.HingeJoint=function(config,lowerAngleLimit,upperAngleLimit){OIMO.Joint.call(this,config);this.type=OIMO.JOINT_HINGE;this.localAxis1=config.localAxis1.clone().norm();this.localAxis2=config.localAxis2.clone().norm();this.localAngle1=new OIMO.Vec3(this.localAxis1.y*this.localAxis1.x-this.localAxis1.z*this.localAxis1.z,-this.localAxis1.z*this.localAxis1.y-this.localAxis1.x*this.localAxis1.x,this.localAxis1.x*this.localAxis1.z+this.localAxis1.y*this.localAxis1.y).norm();var arc=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2));this.localAngle2=(new OIMO.Vec3).mulMat(arc,this.localAngle1);this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.ax1=new OIMO.Vec3;this.ax2=new OIMO.Vec3;this.an1=new OIMO.Vec3;this.an2=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.nor,false);this.limitMotor.lowerLimit=lowerAngleLimit;this.limitMotor.upperLimit=upperAngleLimit;this.lc=new OIMO.LinearConstraint(this);this.r3=new OIMO.Rotational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,true),new OIMO.LimitMotor(this.bin,true))};OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.HingeJoint.prototype.constructor=OIMO.HingeJoint;OIMO.HingeJoint.prototype.preSolve=function(timeStep,invTimeStep){var tmp1X,tmp1Y,tmp1Z,limite;this.updateAnchorPoints();this.ax1.mulMat(this.body1.rotation,this.localAxis1);this.ax2.mulMat(this.body2.rotation,this.localAxis2);this.an1.mulMat(this.body1.rotation,this.localAngle1);this.an2.mulMat(this.body2.rotation,this.localAngle2);this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).norm();this.tan.set(this.nor.y*this.nor.x-this.nor.z*this.nor.z,-this.nor.z*this.nor.y-this.nor.x*this.nor.x,this.nor.x*this.nor.z+this.nor.y*this.nor.y).norm();this.bin.set(this.nor.y*this.tan.z-this.nor.z*this.tan.y,this.nor.z*this.tan.x-this.nor.x*this.tan.z,this.nor.x*this.tan.y-this.nor.y*this.tan.x);limite=this.acosClamp(this.an1.x*this.an2.x+this.an1.y*this.an2.y+this.an1.z*this.an2.z);if(this.nor.x*(this.an1.y*this.an2.z-this.an1.z*this.an2.y)+this.nor.y*(this.an1.z*this.an2.x-this.an1.x*this.an2.z)+this.nor.z*(this.an1.x*this.an2.y-this.an1.y*this.an2.x)<0){this.limitMotor.angle=-limite}else{this.limitMotor.angle=limite}tmp1X=this.ax1.y*this.ax2.z-this.ax1.z*this.ax2.y;tmp1Y=this.ax1.z*this.ax2.x-this.ax1.x*this.ax2.z;tmp1Z=this.ax1.x*this.ax2.y-this.ax1.y*this.ax2.x;this.r3.limitMotor2.angle=this.tan.x*tmp1X+this.tan.y*tmp1Y+this.tan.z*tmp1Z;this.r3.limitMotor3.angle=this.bin.x*tmp1X+this.bin.y*tmp1Y+this.bin.z*tmp1Z;this.r3.preSolve(timeStep,invTimeStep);this.lc.preSolve(timeStep,invTimeStep)};OIMO.HingeJoint.prototype.solve=function(){this.r3.solve();this.lc.solve()};OIMO.HingeJoint.prototype.postSolve=function(){};OIMO.HingeJoint.prototype.acosClamp=function(cos){if(cos>1)return 0;else if(cos<-1)return OIMO.PI;else return OIMO.acos(cos)};OIMO.PrismaticJoint=function(config,lowerTranslation,upperTranslation){OIMO.Joint.call(this,config);this.type=OIMO.JOINT_PRISMATIC;this.localAxis1=(new OIMO.Vec3).normalize(config.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(config.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.ac=new OIMO.AngularConstraint(this,(new OIMO.Quat).arc(this.localAxis1,this.localAxis2));this.limitMotor=new OIMO.LimitMotor(this.nor,true);this.limitMotor.lowerLimit=lowerTranslation;this.limitMotor.upperLimit=upperTranslation;this.t3=new OIMO.Translational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,true),new OIMO.LimitMotor(this.bin,true))};OIMO.PrismaticJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.PrismaticJoint.prototype.constructor=OIMO.PrismaticJoint;OIMO.PrismaticJoint.prototype.preSolve=function(timeStep,invTimeStep){var tmpM;var tmp1X;var tmp1Y;var tmp1Z;this.updateAnchorPoints();tmpM=this.body1.rotation.elements;var axis1X=this.localAxis1X*tmpM[0]+this.localAxis1Y*tmpM[1]+this.localAxis1Z*tmpM[2];var axis1Y=this.localAxis1X*tmpM[3]+this.localAxis1Y*tmpM[4]+this.localAxis1Z*tmpM[5];var axis1Z=this.localAxis1X*tmpM[6]+this.localAxis1Y*tmpM[7]+this.localAxis1Z*tmpM[8];tmpM=this.body2.rotation.elements;var axis2X=this.localAxis2X*tmpM[0]+this.localAxis2Y*tmpM[1]+this.localAxis2Z*tmpM[2];var axis2Y=this.localAxis2X*tmpM[3]+this.localAxis2Y*tmpM[4]+this.localAxis2Z*tmpM[5];var axis2Z=this.localAxis2X*tmpM[6]+this.localAxis2Y*tmpM[7]+this.localAxis2Z*tmpM[8];var nx=axis1X*this.body2.inverseMass+axis2X*this.body1.inverseMass;var ny=axis1Y*this.body2.inverseMass+axis2Y*this.body1.inverseMass;var nz=axis1Z*this.body2.inverseMass+axis2Z*this.body1.inverseMass;tmp1X=OIMO.sqrt(nx*nx+ny*ny+nz*nz);if(tmp1X>0)tmp1X=1/tmp1X;nx*=tmp1X;ny*=tmp1X;nz*=tmp1X;var tx=ny*nx-nz*nz;var ty=-nz*ny-nx*nx;var tz=nx*nz+ny*ny;tmp1X=1/OIMO.sqrt(tx*tx+ty*ty+tz*tz);tx*=tmp1X;ty*=tmp1X;tz*=tmp1X;var bx=ny*tz-nz*ty;var by=nz*tx-nx*tz;var bz=nx*ty-ny*tx;this.nor.init(nx,ny,nz);this.tan.init(tx,ty,tz);this.bin.init(bx,by,bz);this.ac.preSolve(timeStep,invTimeStep);this.t3.preSolve(timeStep,invTimeStep)};OIMO.PrismaticJoint.prototype.solve=function(){this.ac.solve();this.t3.solve()};OIMO.PrismaticJoint.prototype.postSolve=function(){};OIMO.SliderJoint=function(config,lowerTranslation,upperTranslation){OIMO.Joint.call(this,config);this.type=OIMO.JOINT_SLIDER;this.localAxis1=(new OIMO.Vec3).normalize(config.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(config.localAxis2);var len;this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;len=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=len;this.localAngAxis1Y*=len;this.localAngAxis1Z*=len;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;var arc=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2));var tarc=arc.elements;this.localAngAxis2X=this.localAngAxis1X*tarc[0]+this.localAngAxis1Y*tarc[1]+this.localAngAxis1Z*tarc[2];this.localAngAxis2Y=this.localAngAxis1X*tarc[3]+this.localAngAxis1Y*tarc[4]+this.localAngAxis1Z*tarc[5];this.localAngAxis2Z=this.localAngAxis1X*tarc[6]+this.localAngAxis1Y*tarc[7]+this.localAngAxis1Z*tarc[8];this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.rotationalLimitMotor=new OIMO.LimitMotor(this.nor,false);this.r3=new OIMO.Rotational3Constraint(this,this.rotationalLimitMotor,new OIMO.LimitMotor(this.tan,true),new OIMO.LimitMotor(this.bin,true));this.translationalLimitMotor=new OIMO.LimitMotor(this.nor,true);this.translationalLimitMotor.lowerLimit=lowerTranslation;this.translationalLimitMotor.upperLimit=upperTranslation;this.t3=new OIMO.Translational3Constraint(this,this.translationalLimitMotor,new OIMO.LimitMotor(this.tan,true),new OIMO.LimitMotor(this.bin,true))};OIMO.SliderJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.SliderJoint.prototype.constructor=OIMO.SliderJoint;OIMO.SliderJoint.prototype.preSolve=function(timeStep,invTimeStep){var tmpM;var tmp1X;var tmp1Y;var tmp1Z;this.updateAnchorPoints();tmpM=this.body1.rotation.elements;var axis1X=this.localAxis1X*tmpM[0]+this.localAxis1Y*tmpM[1]+this.localAxis1Z*tmpM[2];var axis1Y=this.localAxis1X*tmpM[3]+this.localAxis1Y*tmpM[4]+this.localAxis1Z*tmpM[5];var axis1Z=this.localAxis1X*tmpM[6]+this.localAxis1Y*tmpM[7]+this.localAxis1Z*tmpM[8];var angAxis1X=this.localAngAxis1X*tmpM[0]+this.localAngAxis1Y*tmpM[1]+this.localAngAxis1Z*tmpM[2];var angAxis1Y=this.localAngAxis1X*tmpM[3]+this.localAngAxis1Y*tmpM[4]+this.localAngAxis1Z*tmpM[5];var angAxis1Z=this.localAngAxis1X*tmpM[6]+this.localAngAxis1Y*tmpM[7]+this.localAngAxis1Z*tmpM[8];tmpM=this.body2.rotation.elements;var axis2X=this.localAxis2X*tmpM[0]+this.localAxis2Y*tmpM[1]+this.localAxis2Z*tmpM[2];var axis2Y=this.localAxis2X*tmpM[3]+this.localAxis2Y*tmpM[4]+this.localAxis2Z*tmpM[5];var axis2Z=this.localAxis2X*tmpM[6]+this.localAxis2Y*tmpM[7]+this.localAxis2Z*tmpM[8];var angAxis2X=this.localAngAxis2X*tmpM[0]+this.localAngAxis2Y*tmpM[1]+this.localAngAxis2Z*tmpM[2];var angAxis2Y=this.localAngAxis2X*tmpM[3]+this.localAngAxis2Y*tmpM[4]+this.localAngAxis2Z*tmpM[5];var angAxis2Z=this.localAngAxis2X*tmpM[6]+this.localAngAxis2Y*tmpM[7]+this.localAngAxis2Z*tmpM[8];var nx=axis1X*this.body2.inverseMass+axis2X*this.body1.inverseMass;var ny=axis1Y*this.body2.inverseMass+axis2Y*this.body1.inverseMass;var nz=axis1Z*this.body2.inverseMass+axis2Z*this.body1.inverseMass;tmp1X=OIMO.sqrt(nx*nx+ny*ny+nz*nz);if(tmp1X>0)tmp1X=1/tmp1X;nx*=tmp1X;ny*=tmp1X;nz*=tmp1X;var tx=ny*nx-nz*nz;var ty=-nz*ny-nx*nx;var tz=nx*nz+ny*ny;tmp1X=1/OIMO.sqrt(tx*tx+ty*ty+tz*tz);tx*=tmp1X;ty*=tmp1X;tz*=tmp1X;var bx=ny*tz-nz*ty;var by=nz*tx-nx*tz;var bz=nx*ty-ny*tx;this.nor.init(nx,ny,nz);this.tan.init(tx,ty,tz);this.bin.init(bx,by,bz);if(nx*(angAxis1Y*angAxis2Z-angAxis1Z*angAxis2Y)+ny*(angAxis1Z*angAxis2X-angAxis1X*angAxis2Z)+nz*(angAxis1X*angAxis2Y-angAxis1Y*angAxis2X)<0){this.rotationalLimitMotor.angle=-this.acosClamp(angAxis1X*angAxis2X+angAxis1Y*angAxis2Y+angAxis1Z*angAxis2Z)}else{this.rotationalLimitMotor.angle=this.acosClamp(angAxis1X*angAxis2X+angAxis1Y*angAxis2Y+angAxis1Z*angAxis2Z)}tmp1X=axis1Y*axis2Z-axis1Z*axis2Y;tmp1Y=axis1Z*axis2X-axis1X*axis2Z;tmp1Z=axis1X*axis2Y-axis1Y*axis2X;this.r3.limitMotor2.angle=tx*tmp1X+ty*tmp1Y+tz*tmp1Z;this.r3.limitMotor3.angle=bx*tmp1X+by*tmp1Y+bz*tmp1Z;this.r3.preSolve(timeStep,invTimeStep);this.t3.preSolve(timeStep,invTimeStep)};OIMO.SliderJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.SliderJoint.prototype.postSolve=function(){};OIMO.SliderJoint.prototype.acosClamp=function(cos){if(cos>1)return 0;else if(cos<-1)return OIMO.PI;else return OIMO.acos(cos)};OIMO.WheelJoint=function(config){OIMO.Joint.call(this,config);this.type=OIMO.JOINT_WHEEL;this.localAxis1=(new OIMO.Vec3).normalize(config.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(config.localAxis2);var len;this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;var dot=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;if(dot>-1&&dot<1){this.localAngAxis1X=this.localAxis2X-dot*this.localAxis1X;this.localAngAxis1Y=this.localAxis2Y-dot*this.localAxis1Y;this.localAngAxis1Z=this.localAxis2Z-dot*this.localAxis1Z;this.localAngAxis2X=this.localAxis1X-dot*this.localAxis2X;this.localAngAxis2Y=this.localAxis1Y-dot*this.localAxis2Y;this.localAngAxis2Z=this.localAxis1Z-dot*this.localAxis2Z;len=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=len;this.localAngAxis1Y*=len;this.localAngAxis1Z*=len;len=1/OIMO.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z);this.localAngAxis2X*=len;this.localAngAxis2Y*=len;this.localAngAxis2Z*=len}else{this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;len=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=len;this.localAngAxis1Y*=len;this.localAngAxis1Z*=len;var arc=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2));var tarc=arc.elements;this.localAngAxis2X=this.localAngAxis1X*tarc[0]+this.localAngAxis1Y*tarc[1]+this.localAngAxis1Z*tarc[2];this.localAngAxis2Y=this.localAngAxis1X*tarc[3]+this.localAngAxis1Y*tarc[4]+this.localAngAxis1Z*tarc[5];this.localAngAxis2Z=this.localAngAxis1X*tarc[6]+this.localAngAxis1Y*tarc[7]+this.localAngAxis1Z*tarc[8]}this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.translationalLimitMotor=new OIMO.LimitMotor(this.tan,true);this.translationalLimitMotor.frequency=8;this.translationalLimitMotor.dampingRatio=1;this.rotationalLimitMotor1=new OIMO.LimitMotor(this.tan,false);this.rotationalLimitMotor2=new OIMO.LimitMotor(this.bin,false);this.t3=new OIMO.Translational3Constraint(this,new OIMO.LimitMotor(this.nor,true),this.translationalLimitMotor,new OIMO.LimitMotor(this.bin,true));this.t3.weight=1;this.r3=new OIMO.Rotational3Constraint(this,new OIMO.LimitMotor(this.nor,true),this.rotationalLimitMotor1,this.rotationalLimitMotor2)};OIMO.WheelJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.WheelJoint.prototype.constructor=OIMO.WheelJoint;OIMO.WheelJoint.prototype.preSolve=function(timeStep,invTimeStep){var tmpM;var tmp1X;var tmp1Y;var tmp1Z;this.updateAnchorPoints();tmpM=this.body1.rotation.elements;var x1=this.localAxis1X*tmpM[0]+this.localAxis1Y*tmpM[1]+this.localAxis1Z*tmpM[2];var y1=this.localAxis1X*tmpM[3]+this.localAxis1Y*tmpM[4]+this.localAxis1Z*tmpM[5];var z1=this.localAxis1X*tmpM[6]+this.localAxis1Y*tmpM[7]+this.localAxis1Z*tmpM[8];var angAxis1X=this.localAngAxis1X*tmpM[0]+this.localAngAxis1Y*tmpM[1]+this.localAngAxis1Z*tmpM[2];var angAxis1Y=this.localAngAxis1X*tmpM[3]+this.localAngAxis1Y*tmpM[4]+this.localAngAxis1Z*tmpM[5];var angAxis1Z=this.localAngAxis1X*tmpM[6]+this.localAngAxis1Y*tmpM[7]+this.localAngAxis1Z*tmpM[8];tmpM=this.body2.rotation.elements;var x2=this.localAxis2X*tmpM[0]+this.localAxis2Y*tmpM[1]+this.localAxis2Z*tmpM[2];var y2=this.localAxis2X*tmpM[3]+this.localAxis2Y*tmpM[4]+this.localAxis2Z*tmpM[5];var z2=this.localAxis2X*tmpM[6]+this.localAxis2Y*tmpM[7]+this.localAxis2Z*tmpM[8];var angAxis2X=this.localAngAxis2X*tmpM[0]+this.localAngAxis2Y*tmpM[1]+this.localAngAxis2Z*tmpM[2];var angAxis2Y=this.localAngAxis2X*tmpM[3]+this.localAngAxis2Y*tmpM[4]+this.localAngAxis2Z*tmpM[5];var angAxis2Z=this.localAngAxis2X*tmpM[6]+this.localAngAxis2Y*tmpM[7]+this.localAngAxis2Z*tmpM[8];this.r3.limitMotor1.angle=x1*x2+y1*y2+z1*z2;if(x1*(angAxis1Y*z2-angAxis1Z*y2)+y1*(angAxis1Z*x2-angAxis1X*z2)+z1*(angAxis1X*y2-angAxis1Y*x2)<0){this.rotationalLimitMotor1.angle=-this.acosClamp(angAxis1X*x2+angAxis1Y*y2+angAxis1Z*z2)}else{this.rotationalLimitMotor1.angle=this.acosClamp(angAxis1X*x2+angAxis1Y*y2+angAxis1Z*z2)}if(x2*(angAxis2Y*z1-angAxis2Z*y1)+y2*(angAxis2Z*x1-angAxis2X*z1)+z2*(angAxis2X*y1-angAxis2Y*x1)<0){this.rotationalLimitMotor2.angle=this.acosClamp(angAxis2X*x1+angAxis2Y*y1+angAxis2Z*z1)}else{this.rotationalLimitMotor2.angle=-this.acosClamp(angAxis2X*x1+angAxis2Y*y1+angAxis2Z*z1)}var nx=y2*z1-z2*y1;var ny=z2*x1-x2*z1;var nz=x2*y1-y2*x1;tmp1X=OIMO.sqrt(nx*nx+ny*ny+nz*nz);if(tmp1X>0)tmp1X=1/tmp1X;nx*=tmp1X;ny*=tmp1X;nz*=tmp1X;var tx=ny*z2-nz*y2;var ty=nz*x2-nx*z2;var tz=nx*y2-ny*x2;tmp1X=OIMO.sqrt(tx*tx+ty*ty+tz*tz);if(tmp1X>0)tmp1X=1/tmp1X;tx*=tmp1X;ty*=tmp1X;tz*=tmp1X;var bx=y1*nz-z1*ny;var by=z1*nx-x1*nz;var bz=x1*ny-y1*nx;tmp1X=OIMO.sqrt(bx*bx+by*by+bz*bz);if(tmp1X>0)tmp1X=1/tmp1X;bx*=tmp1X;by*=tmp1X;bz*=tmp1X;this.nor.init(nx,ny,nz);this.tan.init(tx,ty,tz);this.bin.init(bx,by,bz);this.r3.preSolve(timeStep,invTimeStep);this.t3.preSolve(timeStep,invTimeStep)};OIMO.WheelJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.WheelJoint.prototype.postSolve=function(){};OIMO.WheelJoint.prototype.acosClamp=function(cos){if(cos>1)return 0;else if(cos<-1)return OIMO.PI;else return OIMO.acos(cos)};OIMO.AngularConstraint=function(joint,targetOrientation){this.joint=joint;this.targetOrientation=(new OIMO.Quat).invert(targetOrientation);this.relativeOrientation=new OIMO.Quat;this.ii1=null;this.ii2=null;this.dd=null;this.vel=new OIMO.Vec3;this.imp=new OIMO.Vec3;this.rn0=new OIMO.Vec3;this.rn1=new OIMO.Vec3;this.rn2=new OIMO.Vec3;this.b1=joint.body1;this.b2=joint.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia};OIMO.AngularConstraint.prototype={constructor:OIMO.AngularConstraint,preSolve:function(timeStep,invTimeStep){var inv,len,v,vv;this.ii1=this.i1.clone();this.ii2=this.i2.clone();v=(new OIMO.Mat33).add(this.ii1,this.ii2).elements;inv=1/(v[0]*(v[4]*v[8]-v[7]*v[5])+v[3]*(v[7]*v[2]-v[1]*v[8])+v[6]*(v[1]*v[5]-v[4]*v[2]));this.dd=new OIMO.Mat33(v[4]*v[8]-v[5]*v[7],v[2]*v[7]-v[1]*v[8],v[1]*v[5]-v[2]*v[4],v[5]*v[6]-v[3]*v[8],v[0]*v[8]-v[2]*v[6],v[2]*v[3]-v[0]*v[5],v[3]*v[7]-v[4]*v[6],v[1]*v[6]-v[0]*v[7],v[0]*v[4]-v[1]*v[3]).multiply(inv);this.relativeOrientation.invert(this.b1.orientation);this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation);this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation);inv=this.relativeOrientation.s*2;this.vel.scale(this.relativeOrientation,inv);len=this.vel.length();if(len>.02){len=(.02-len)/len*invTimeStep*.05;this.vel.scaleEqual(len)}else{this.vel.init()}this.rn1.mulMat(this.ii1,this.imp);this.rn2.mulMat(this.ii2,this.imp);this.a1.addEqual(this.rn1);this.a2.subEqual(this.rn2)},solve:function(){var r=this.a2.clone().subEqual(this.a1).subEqual(this.vel);this.rn0.mulMat(this.dd,r);this.rn1.mulMat(this.ii1,this.rn0);this.rn2.mulMat(this.ii2,this.rn0);this.imp.addEqual(this.rn0);this.a1.addEqual(this.rn1);this.a2.subEqual(this.rn2)}};OIMO.LinearConstraint=function(joint){this.m1=NaN;this.m2=NaN;this.ii1=null;this.ii2=null;this.dd=null;this.r1x=NaN;this.r1y=NaN;this.r1z=NaN;this.r2x=NaN;this.r2y=NaN;this.r2z=NaN;this.ax1x=NaN;this.ax1y=NaN;this.ax1z=NaN;this.ay1x=NaN;this.ay1y=NaN;this.ay1z=NaN;this.az1x=NaN;this.az1y=NaN;this.az1z=NaN;this.ax2x=NaN;this.ax2y=NaN;this.ax2z=NaN;this.ay2x=NaN;this.ay2y=NaN;this.ay2z=NaN;this.az2x=NaN;this.az2y=NaN;this.az2z=NaN;this.vel=NaN;this.velx=NaN;this.vely=NaN;this.velz=NaN;this.joint=joint;this.r1=joint.relativeAnchorPoint1;this.r2=joint.relativeAnchorPoint2;this.p1=joint.anchorPoint1;this.p2=joint.anchorPoint2;this.b1=joint.body1;this.b2=joint.body2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.impx=0;this.impy=0;this.impz=0};OIMO.LinearConstraint.prototype={constructor:OIMO.LinearConstraint,preSolve:function(timeStep,invTimeStep){this.r1x=this.r1.x;this.r1y=this.r1.y;this.r1z=this.r1.z;this.r2x=this.r2.x;this.r2y=this.r2.y;this.r2z=this.r2.z;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;this.ii1=this.i1.clone();this.ii2=this.i2.clone();var ii1=this.ii1.elements;var ii2=this.ii2.elements;this.ax1x=this.r1z*ii1[1]+-this.r1y*ii1[2];this.ax1y=this.r1z*ii1[4]+-this.r1y*ii1[5];this.ax1z=this.r1z*ii1[7]+-this.r1y*ii1[8];this.ay1x=-this.r1z*ii1[0]+this.r1x*ii1[2];this.ay1y=-this.r1z*ii1[3]+this.r1x*ii1[5];this.ay1z=-this.r1z*ii1[6]+this.r1x*ii1[8];this.az1x=this.r1y*ii1[0]+-this.r1x*ii1[1];this.az1y=this.r1y*ii1[3]+-this.r1x*ii1[4];this.az1z=this.r1y*ii1[6]+-this.r1x*ii1[7];this.ax2x=this.r2z*ii2[1]+-this.r2y*ii2[2];this.ax2y=this.r2z*ii2[4]+-this.r2y*ii2[5];this.ax2z=this.r2z*ii2[7]+-this.r2y*ii2[8];this.ay2x=-this.r2z*ii2[0]+this.r2x*ii2[2];this.ay2y=-this.r2z*ii2[3]+this.r2x*ii2[5];this.ay2z=-this.r2z*ii2[6]+this.r2x*ii2[8];this.az2x=this.r2y*ii2[0]+-this.r2x*ii2[1];this.az2y=this.r2y*ii2[3]+-this.r2x*ii2[4];this.az2z=this.r2y*ii2[6]+-this.r2x*ii2[7];var rxx=this.m1+this.m2;var kk=new OIMO.Mat33(rxx,0,0,0,rxx,0,0,0,rxx);var k=kk.elements;k[0]+=ii1[4]*this.r1z*this.r1z-(ii1[7]+ii1[5])*this.r1y*this.r1z+ii1[8]*this.r1y*this.r1y;k[1]+=(ii1[6]*this.r1y+ii1[5]*this.r1x)*this.r1z-ii1[3]*this.r1z*this.r1z-ii1[8]*this.r1x*this.r1y;k[2]+=(ii1[3]*this.r1y-ii1[4]*this.r1x)*this.r1z-ii1[6]*this.r1y*this.r1y+ii1[7]*this.r1x*this.r1y;k[3]+=(ii1[2]*this.r1y+ii1[7]*this.r1x)*this.r1z-ii1[1]*this.r1z*this.r1z-ii1[8]*this.r1x*this.r1y;k[4]+=ii1[0]*this.r1z*this.r1z-(ii1[6]+ii1[2])*this.r1x*this.r1z+ii1[8]*this.r1x*this.r1x;k[5]+=(ii1[1]*this.r1x-ii1[0]*this.r1y)*this.r1z-ii1[7]*this.r1x*this.r1x+ii1[6]*this.r1x*this.r1y;k[6]+=(ii1[1]*this.r1y-ii1[4]*this.r1x)*this.r1z-ii1[2]*this.r1y*this.r1y+ii1[5]*this.r1x*this.r1y;k[7]+=(ii1[3]*this.r1x-ii1[0]*this.r1y)*this.r1z-ii1[5]*this.r1x*this.r1x+ii1[2]*this.r1x*this.r1y;k[8]+=ii1[0]*this.r1y*this.r1y-(ii1[3]+ii1[1])*this.r1x*this.r1y+ii1[4]*this.r1x*this.r1x;k[0]+=ii2[4]*this.r2z*this.r2z-(ii2[7]+ii2[5])*this.r2y*this.r2z+ii2[8]*this.r2y*this.r2y;k[1]+=(ii2[6]*this.r2y+ii2[5]*this.r2x)*this.r2z-ii2[3]*this.r2z*this.r2z-ii2[8]*this.r2x*this.r2y;k[2]+=(ii2[3]*this.r2y-ii2[4]*this.r2x)*this.r2z-ii2[6]*this.r2y*this.r2y+ii2[7]*this.r2x*this.r2y;k[3]+=(ii2[2]*this.r2y+ii2[7]*this.r2x)*this.r2z-ii2[1]*this.r2z*this.r2z-ii2[8]*this.r2x*this.r2y;k[4]+=ii2[0]*this.r2z*this.r2z-(ii2[6]+ii2[2])*this.r2x*this.r2z+ii2[8]*this.r2x*this.r2x;k[5]+=(ii2[1]*this.r2x-ii2[0]*this.r2y)*this.r2z-ii2[7]*this.r2x*this.r2x+ii2[6]*this.r2x*this.r2y;k[6]+=(ii2[1]*this.r2y-ii2[4]*this.r2x)*this.r2z-ii2[2]*this.r2y*this.r2y+ii2[5]*this.r2x*this.r2y;k[7]+=(ii2[3]*this.r2x-ii2[0]*this.r2y)*this.r2z-ii2[5]*this.r2x*this.r2x+ii2[2]*this.r2x*this.r2y;k[8]+=ii2[0]*this.r2y*this.r2y-(ii2[3]+ii2[1])*this.r2x*this.r2y+ii2[4]*this.r2x*this.r2x;var inv=1/(k[0]*(k[4]*k[8]-k[7]*k[5])+k[3]*(k[7]*k[2]-k[1]*k[8])+k[6]*(k[1]*k[5]-k[4]*k[2]));this.dd=new OIMO.Mat33(k[4]*k[8]-k[5]*k[7],k[2]*k[7]-k[1]*k[8],k[1]*k[5]-k[2]*k[4],k[5]*k[6]-k[3]*k[8],k[0]*k[8]-k[2]*k[6],k[2]*k[3]-k[0]*k[5],k[3]*k[7]-k[4]*k[6],k[1]*k[6]-k[0]*k[7],k[0]*k[4]-k[1]*k[3]).multiply(inv);this.velx=this.p2.x-this.p1.x;this.vely=this.p2.y-this.p1.y;this.velz=this.p2.z-this.p1.z;var len=OIMO.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);if(len>.005){len=(.005-len)/len*invTimeStep*.05;this.velx*=len;this.vely*=len;this.velz*=len}else{this.velx=0;this.vely=0;this.velz=0}this.impx*=.95;this.impy*=.95;this.impz*=.95;this.l1.x+=this.impx*this.m1;this.l1.y+=this.impy*this.m1;this.l1.z+=this.impz*this.m1;this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x;this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y;this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z;this.l2.x-=this.impx*this.m2;this.l2.y-=this.impy*this.m2;this.l2.z-=this.impz*this.m2;this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x;this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y;this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var d=this.dd.elements;var rvx=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx;var rvy=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely;var rvz=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz;var nimpx=rvx*d[0]+rvy*d[1]+rvz*d[2];var nimpy=rvx*d[3]+rvy*d[4]+rvz*d[5];var nimpz=rvx*d[6]+rvy*d[7]+rvz*d[8];this.impx+=nimpx;this.impy+=nimpy;this.impz+=nimpz;this.l1.x+=nimpx*this.m1;this.l1.y+=nimpy*this.m1;this.l1.z+=nimpz*this.m1;this.a1.x+=nimpx*this.ax1x+nimpy*this.ay1x+nimpz*this.az1x;this.a1.y+=nimpx*this.ax1y+nimpy*this.ay1y+nimpz*this.az1y;this.a1.z+=nimpx*this.ax1z+nimpy*this.ay1z+nimpz*this.az1z;this.l2.x-=nimpx*this.m2;this.l2.y-=nimpy*this.m2;this.l2.z-=nimpz*this.m2;this.a2.x-=nimpx*this.ax2x+nimpy*this.ay2x+nimpz*this.az2x;this.a2.y-=nimpx*this.ax2y+nimpy*this.ay2y+nimpz*this.az2y;this.a2.z-=nimpx*this.ax2z+nimpy*this.ay2z+nimpz*this.az2z}};OIMO.Rotational3Constraint=function(joint,limitMotor1,limitMotor2,limitMotor3){this.cfm1=NaN;this.cfm2=NaN;this.cfm3=NaN;this.i1e00=NaN;this.i1e01=NaN;this.i1e02=NaN;this.i1e10=NaN;this.i1e11=NaN;this.i1e12=NaN;this.i1e20=NaN;this.i1e21=NaN;this.i1e22=NaN;this.i2e00=NaN;this.i2e01=NaN;this.i2e02=NaN;this.i2e10=NaN;this.i2e11=NaN;this.i2e12=NaN;this.i2e20=NaN;this.i2e21=NaN;this.i2e22=NaN;this.ax1=NaN;this.ay1=NaN;this.az1=NaN;this.ax2=NaN;this.ay2=NaN;this.az2=NaN;this.ax3=NaN;this.ay3=NaN;this.az3=NaN;this.a1x1=NaN;this.a1y1=NaN;this.a1z1=NaN;this.a2x1=NaN;this.a2y1=NaN;this.a2z1=NaN;this.a1x2=NaN;this.a1y2=NaN;this.a1z2=NaN;this.a2x2=NaN;this.a2y2=NaN;this.a2z2=NaN;this.a1x3=NaN;this.a1y3=NaN;this.a1z3=NaN;this.a2x3=NaN;this.a2y3=NaN;this.a2z3=NaN;this.lowerLimit1=NaN;this.upperLimit1=NaN;this.limitVelocity1=NaN;this.limitState1=0;this.enableMotor1=false;this.motorSpeed1=NaN;this.maxMotorForce1=NaN;this.maxMotorImpulse1=NaN;this.lowerLimit2=NaN;this.upperLimit2=NaN;this.limitVelocity2=NaN;this.limitState2=0;this.enableMotor2=false;this.motorSpeed2=NaN;this.maxMotorForce2=NaN;this.maxMotorImpulse2=NaN;this.lowerLimit3=NaN;this.upperLimit3=NaN;this.limitVelocity3=NaN;this.limitState3=0;this.enableMotor3=false;this.motorSpeed3=NaN;this.maxMotorForce3=NaN;this.maxMotorImpulse3=NaN;this.k00=NaN;this.k01=NaN;this.k02=NaN;this.k10=NaN;this.k11=NaN;this.k12=NaN;this.k20=NaN;this.k21=NaN;this.k22=NaN;this.kv00=NaN;this.kv11=NaN;this.kv22=NaN;this.dv00=NaN;this.dv11=NaN;this.dv22=NaN;this.d00=NaN;this.d01=NaN;this.d02=NaN;this.d10=NaN;this.d11=NaN;this.d12=NaN;this.d20=NaN;this.d21=NaN;this.d22=NaN;this.limitMotor1=limitMotor1;this.limitMotor2=limitMotor2;this.limitMotor3=limitMotor3;this.b1=joint.body1;this.b2=joint.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.limitImpulse1=0;this.motorImpulse1=0;this.limitImpulse2=0;this.motorImpulse2=0;this.limitImpulse3=0;this.motorImpulse3=0};OIMO.Rotational3Constraint.prototype={constructor:OIMO.Rotational3Constraint,preSolve:function(timeStep,invTimeStep){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=this.maxMotorForce1>0;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=this.maxMotorForce2>0;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;this.enableMotor3=this.maxMotorForce3>0;var ti1=this.i1.elements;var ti2=this.i2.elements;this.i1e00=ti1[0];this.i1e01=ti1[1];this.i1e02=ti1[2];this.i1e10=ti1[3];this.i1e11=ti1[4];this.i1e12=ti1[5];this.i1e20=ti1[6];this.i1e21=ti1[7];this.i1e22=ti1[8];this.i2e00=ti2[0];this.i2e01=ti2[1];this.i2e02=ti2[2];this.i2e10=ti2[3];this.i2e11=ti2[4];this.i2e12=ti2[5];this.i2e20=ti2[6];this.i2e21=ti2[7];this.i2e22=ti2[8];var frequency1=this.limitMotor1.frequency;var frequency2=this.limitMotor2.frequency;var frequency3=this.limitMotor3.frequency;var enableSpring1=frequency1>0;var enableSpring2=frequency2>0;var enableSpring3=frequency3>0;var enableLimit1=this.lowerLimit1<=this.upperLimit1;var enableLimit2=this.lowerLimit2<=this.upperLimit2;var enableLimit3=this.lowerLimit3<=this.upperLimit3;var angle1=this.limitMotor1.angle;if(enableLimit1){if(this.lowerLimit1==this.upperLimit1){if(this.limitState1!=0){this.limitState1=0;this.limitImpulse1=0}this.limitVelocity1=this.lowerLimit1-angle1}else if(angle1<this.lowerLimit1){if(this.limitState1!=-1){this.limitState1=-1;this.limitImpulse1=0}this.limitVelocity1=this.lowerLimit1-angle1}else if(angle1>this.upperLimit1){if(this.limitState1!=1){this.limitState1=1;this.limitImpulse1=0}this.limitVelocity1=this.upperLimit1-angle1}else{this.limitState1=2;this.limitImpulse1=0;this.limitVelocity1=0}if(!enableSpring1){if(this.limitVelocity1>.02)this.limitVelocity1-=.02;else if(this.limitVelocity1<-.02)this.limitVelocity1+=.02;else this.limitVelocity1=0}}else{this.limitState1=2;this.limitImpulse1=0}var angle2=this.limitMotor2.angle;if(enableLimit2){if(this.lowerLimit2==this.upperLimit2){if(this.limitState2!=0){this.limitState2=0;this.limitImpulse2=0}this.limitVelocity2=this.lowerLimit2-angle2}else if(angle2<this.lowerLimit2){if(this.limitState2!=-1){this.limitState2=-1;this.limitImpulse2=0}this.limitVelocity2=this.lowerLimit2-angle2}else if(angle2>this.upperLimit2){if(this.limitState2!=1){this.limitState2=1;this.limitImpulse2=0}this.limitVelocity2=this.upperLimit2-angle2}else{this.limitState2=2;this.limitImpulse2=0;this.limitVelocity2=0}if(!enableSpring2){if(this.limitVelocity2>.02)this.limitVelocity2-=.02;else if(this.limitVelocity2<-.02)this.limitVelocity2+=.02;else this.limitVelocity2=0}}else{this.limitState2=2;this.limitImpulse2=0}var angle3=this.limitMotor3.angle;if(enableLimit3){if(this.lowerLimit3==this.upperLimit3){if(this.limitState3!=0){this.limitState3=0;this.limitImpulse3=0}this.limitVelocity3=this.lowerLimit3-angle3}else if(angle3<this.lowerLimit3){if(this.limitState3!=-1){this.limitState3=-1;this.limitImpulse3=0}this.limitVelocity3=this.lowerLimit3-angle3}else if(angle3>this.upperLimit3){if(this.limitState3!=1){this.limitState3=1;this.limitImpulse3=0}this.limitVelocity3=this.upperLimit3-angle3}else{this.limitState3=2;this.limitImpulse3=0;this.limitVelocity3=0}if(!enableSpring3){if(this.limitVelocity3>.02)this.limitVelocity3-=.02;else if(this.limitVelocity3<-.02)this.limitVelocity3+=.02;else this.limitVelocity3=0}}else{this.limitState3=2;this.limitImpulse3=0}if(this.enableMotor1&&(this.limitState1!=0||enableSpring1)){this.maxMotorImpulse1=this.maxMotorForce1*timeStep}else{this.motorImpulse1=0;this.maxMotorImpulse1=0}if(this.enableMotor2&&(this.limitState2!=0||enableSpring2)){this.maxMotorImpulse2=this.maxMotorForce2*timeStep}else{this.motorImpulse2=0;this.maxMotorImpulse2=0}if(this.enableMotor3&&(this.limitState3!=0||enableSpring3)){this.maxMotorImpulse3=this.maxMotorForce3*timeStep}else{this.motorImpulse3=0;this.maxMotorImpulse3=0}this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02;this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12;this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22;this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02;this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12;this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22;this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02;this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12;this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22;this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02;this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12;this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22;this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02;this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12;this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22;this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02;this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12;this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22;this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1);this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2);this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3);this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1);this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2);this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3);this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1);this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2);this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3);this.kv00=this.k00;this.kv11=this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;if(enableSpring1&&this.limitState1!=2){var omega=6.2831853*frequency1;var k=omega*omega*timeStep;var dmp=invTimeStep/(k+2*this.limitMotor1.dampingRatio*omega);this.cfm1=this.kv00*dmp;this.limitVelocity1*=k*dmp}else{this.cfm1=0;this.limitVelocity1*=invTimeStep*.05}if(enableSpring2&&this.limitState2!=2){omega=6.2831853*frequency2;k=omega*omega*timeStep;dmp=invTimeStep/(k+2*this.limitMotor2.dampingRatio*omega);this.cfm2=this.kv11*dmp;this.limitVelocity2*=k*dmp}else{this.cfm2=0;this.limitVelocity2*=invTimeStep*.05}if(enableSpring3&&this.limitState3!=2){omega=6.2831853*frequency3;k=omega*omega*timeStep;dmp=invTimeStep/(k+2*this.limitMotor3.dampingRatio*omega);this.cfm3=this.kv22*dmp;this.limitVelocity3*=k*dmp}else{this.cfm3=0;this.limitVelocity3*=invTimeStep*.05}this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;var inv=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*inv;this.d01=(this.k02*this.k21-this.k01*this.k22)*inv;this.d02=(this.k01*this.k12-this.k02*this.k11)*inv;this.d10=(this.k12*this.k20-this.k10*this.k22)*inv;this.d11=(this.k00*this.k22-this.k02*this.k20)*inv;this.d12=(this.k02*this.k10-this.k00*this.k12)*inv;this.d20=(this.k10*this.k21-this.k11*this.k20)*inv;this.d21=(this.k01*this.k20-this.k00*this.k21)*inv;this.d22=(this.k00*this.k11-this.k01*this.k10)*inv;this.limitImpulse1*=.95;this.motorImpulse1*=.95;this.limitImpulse2*=.95;this.motorImpulse2*=.95;this.limitImpulse3*=.95;this.motorImpulse3*=.95;var totalImpulse1=this.limitImpulse1+this.motorImpulse1;var totalImpulse2=this.limitImpulse2+this.motorImpulse2;var totalImpulse3=this.limitImpulse3+this.motorImpulse3;this.a1.x+=totalImpulse1*this.a1x1+totalImpulse2*this.a1x2+totalImpulse3*this.a1x3;this.a1.y+=totalImpulse1*this.a1y1+totalImpulse2*this.a1y2+totalImpulse3*this.a1y3;this.a1.z+=totalImpulse1*this.a1z1+totalImpulse2*this.a1z2+totalImpulse3*this.a1z3;this.a2.x-=totalImpulse1*this.a2x1+totalImpulse2*this.a2x2+totalImpulse3*this.a2x3;this.a2.y-=totalImpulse1*this.a2y1+totalImpulse2*this.a2y2+totalImpulse3*this.a2y3;this.a2.z-=totalImpulse1*this.a2z1+totalImpulse2*this.a2z2+totalImpulse3*this.a2z3},solve_:function(){var rvx=this.a2.x-this.a1.x;var rvy=this.a2.y-this.a1.y;var rvz=this.a2.z-this.a1.z;this.limitVelocity3=30;var rvn1=rvx*this.ax1+rvy*this.ay1+rvz*this.az1-this.limitVelocity1;var rvn2=rvx*this.ax2+rvy*this.ay2+rvz*this.az2-this.limitVelocity2;var rvn3=rvx*this.ax3+rvy*this.ay3+rvz*this.az3-this.limitVelocity3;var dLimitImpulse1=rvn1*this.d00+rvn2*this.d01+rvn3*this.d02;var dLimitImpulse2=rvn1*this.d10+rvn2*this.d11+rvn3*this.d12;var dLimitImpulse3=rvn1*this.d20+rvn2*this.d21+rvn3*this.d22;this.limitImpulse1+=dLimitImpulse1;this.limitImpulse2+=dLimitImpulse2;this.limitImpulse3+=dLimitImpulse3;this.a1.x+=dLimitImpulse1*this.a1x1+dLimitImpulse2*this.a1x2+dLimitImpulse3*this.a1x3;this.a1.y+=dLimitImpulse1*this.a1y1+dLimitImpulse2*this.a1y2+dLimitImpulse3*this.a1y3;this.a1.z+=dLimitImpulse1*this.a1z1+dLimitImpulse2*this.a1z2+dLimitImpulse3*this.a1z3;this.a2.x-=dLimitImpulse1*this.a2x1+dLimitImpulse2*this.a2x2+dLimitImpulse3*this.a2x3;this.a2.y-=dLimitImpulse1*this.a2y1+dLimitImpulse2*this.a2y2+dLimitImpulse3*this.a2y3;this.a2.z-=dLimitImpulse1*this.a2z1+dLimitImpulse2*this.a2z2+dLimitImpulse3*this.a2z3},solve:function(){var rvx=this.a2.x-this.a1.x;var rvy=this.a2.y-this.a1.y;var rvz=this.a2.z-this.a1.z;var rvn1=rvx*this.ax1+rvy*this.ay1+rvz*this.az1;var rvn2=rvx*this.ax2+rvy*this.ay2+rvz*this.az2;var rvn3=rvx*this.ax3+rvy*this.ay3+rvz*this.az3;var oldMotorImpulse1=this.motorImpulse1;var oldMotorImpulse2=this.motorImpulse2;var oldMotorImpulse3=this.motorImpulse3;var dMotorImpulse1=0;var dMotorImpulse2=0;var dMotorImpulse3=0;if(this.enableMotor1){dMotorImpulse1=(rvn1-this.motorSpeed1)*this.dv00;this.motorImpulse1+=dMotorImpulse1;if(this.motorImpulse1>this.maxMotorImpulse1){this.motorImpulse1=this.maxMotorImpulse1}else if(this.motorImpulse1<-this.maxMotorImpulse1){this.motorImpulse1=-this.maxMotorImpulse1}dMotorImpulse1=this.motorImpulse1-oldMotorImpulse1}if(this.enableMotor2){dMotorImpulse2=(rvn2-this.motorSpeed2)*this.dv11;this.motorImpulse2+=dMotorImpulse2;if(this.motorImpulse2>this.maxMotorImpulse2){this.motorImpulse2=this.maxMotorImpulse2}else if(this.motorImpulse2<-this.maxMotorImpulse2){this.motorImpulse2=-this.maxMotorImpulse2}dMotorImpulse2=this.motorImpulse2-oldMotorImpulse2}if(this.enableMotor3){dMotorImpulse3=(rvn3-this.motorSpeed3)*this.dv22;this.motorImpulse3+=dMotorImpulse3;if(this.motorImpulse3>this.maxMotorImpulse3){this.motorImpulse3=this.maxMotorImpulse3}else if(this.motorImpulse3<-this.maxMotorImpulse3){this.motorImpulse3=-this.maxMotorImpulse3}dMotorImpulse3=this.motorImpulse3-oldMotorImpulse3}rvn1+=dMotorImpulse1*this.kv00+dMotorImpulse2*this.k01+dMotorImpulse3*this.k02;rvn2+=dMotorImpulse1*this.k10+dMotorImpulse2*this.kv11+dMotorImpulse3*this.k12;rvn3+=dMotorImpulse1*this.k20+dMotorImpulse2*this.k21+dMotorImpulse3*this.kv22;rvn1-=this.limitVelocity1+this.limitImpulse1*this.cfm1;rvn2-=this.limitVelocity2+this.limitImpulse2*this.cfm2;rvn3-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var oldLimitImpulse1=this.limitImpulse1;var oldLimitImpulse2=this.limitImpulse2;var oldLimitImpulse3=this.limitImpulse3;var dLimitImpulse1=rvn1*this.d00+rvn2*this.d01+rvn3*this.d02;var dLimitImpulse2=rvn1*this.d10+rvn2*this.d11+rvn3*this.d12;var dLimitImpulse3=rvn1*this.d20+rvn2*this.d21+rvn3*this.d22;this.limitImpulse1+=dLimitImpulse1;this.limitImpulse2+=dLimitImpulse2;this.limitImpulse3+=dLimitImpulse3;var clampState=0;if(this.limitState1==2||this.limitImpulse1*this.limitState1<0){dLimitImpulse1=-oldLimitImpulse1;rvn2+=dLimitImpulse1*this.k10;rvn3+=dLimitImpulse1*this.k20;clampState|=1}if(this.limitState2==2||this.limitImpulse2*this.limitState2<0){dLimitImpulse2=-oldLimitImpulse2;rvn1+=dLimitImpulse2*this.k01;rvn3+=dLimitImpulse2*this.k21;clampState|=2}if(this.limitState3==2||this.limitImpulse3*this.limitState3<0){dLimitImpulse3=-oldLimitImpulse3;rvn1+=dLimitImpulse3*this.k02;rvn2+=dLimitImpulse3*this.k12;clampState|=4}var det;switch(clampState){case 1:det=1/(this.k11*this.k22-this.k12*this.k21);dLimitImpulse2=(this.k22*rvn2+-this.k12*rvn3)*det;dLimitImpulse3=(-this.k21*rvn2+this.k11*rvn3)*det;break;case 2:det=1/(this.k00*this.k22-this.k02*this.k20);dLimitImpulse1=(this.k22*rvn1+-this.k02*rvn3)*det;dLimitImpulse3=(-this.k20*rvn1+this.k00*rvn3)*det;break;case 3:dLimitImpulse3=rvn3/this.k22;break;case 4:det=1/(this.k00*this.k11-this.k01*this.k10);dLimitImpulse1=(this.k11*rvn1+-this.k01*rvn2)*det;dLimitImpulse2=(-this.k10*rvn1+this.k00*rvn2)*det;break;case 5:dLimitImpulse2=rvn2/this.k11;break;case 6:dLimitImpulse1=rvn1/this.k00;break}this.limitImpulse1=dLimitImpulse1+oldLimitImpulse1;this.limitImpulse2=dLimitImpulse2+oldLimitImpulse2;this.limitImpulse3=dLimitImpulse3+oldLimitImpulse3;var dImpulse1=dMotorImpulse1+dLimitImpulse1;var dImpulse2=dMotorImpulse2+dLimitImpulse2;var dImpulse3=dMotorImpulse3+dLimitImpulse3;this.a1.x+=dImpulse1*this.a1x1+dImpulse2*this.a1x2+dImpulse3*this.a1x3;this.a1.y+=dImpulse1*this.a1y1+dImpulse2*this.a1y2+dImpulse3*this.a1y3;this.a1.z+=dImpulse1*this.a1z1+dImpulse2*this.a1z2+dImpulse3*this.a1z3;this.a2.x-=dImpulse1*this.a2x1+dImpulse2*this.a2x2+dImpulse3*this.a2x3;this.a2.y-=dImpulse1*this.a2y1+dImpulse2*this.a2y2+dImpulse3*this.a2y3;this.a2.z-=dImpulse1*this.a2z1+dImpulse2*this.a2z2+dImpulse3*this.a2z3;rvx=this.a2.x-this.a1.x;rvy=this.a2.y-this.a1.y;rvz=this.a2.z-this.a1.z;rvn2=rvx*this.ax2+rvy*this.ay2+rvz*this.az2}};OIMO.RotationalConstraint=function(joint,limitMotor){this.cfm=NaN;this.i1e00=NaN;this.i1e01=NaN;this.i1e02=NaN;this.i1e10=NaN;this.i1e11=NaN;this.i1e12=NaN;this.i1e20=NaN;this.i1e21=NaN;this.i1e22=NaN;this.i2e00=NaN;this.i2e01=NaN;this.i2e02=NaN;this.i2e10=NaN;this.i2e11=NaN;this.i2e12=NaN;this.i2e20=NaN;this.i2e21=NaN;this.i2e22=NaN;this.motorDenom=NaN;this.invMotorDenom=NaN;this.invDenom=NaN;this.ax=NaN;this.ay=NaN;this.az=NaN;this.a1x=NaN;this.a1y=NaN;this.a1z=NaN;this.a2x=NaN;this.a2y=NaN;this.a2z=NaN;this.enableLimit=false;this.lowerLimit=NaN;this.upperLimit=NaN;this.limitVelocity=NaN;this.limitState=0;this.enableMotor=false;this.motorSpeed=NaN;this.maxMotorForce=NaN;this.maxMotorImpulse=NaN;this.limitMotor=limitMotor;this.b1=joint.body1;this.b2=joint.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.limitImpulse=0;this.motorImpulse=0};OIMO.RotationalConstraint.prototype={constructor:OIMO.RotationalConstraint,preSolve:function(timeStep,invTimeStep){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=this.maxMotorForce>0;var ti1=this.i1.elements;var ti2=this.i2.elements;this.i1e00=ti1[0];this.i1e01=ti1[1];this.i1e02=ti1[2];this.i1e10=ti1[3];this.i1e11=ti1[4];this.i1e12=ti1[5];this.i1e20=ti1[6];this.i1e21=ti1[7];this.i1e22=ti1[8];this.i2e00=ti2[0];this.i2e01=ti2[1];this.i2e02=ti2[2];this.i2e10=ti2[3];this.i2e11=ti2[4];this.i2e12=ti2[5];this.i2e20=ti2[6];this.i2e21=ti2[7];this.i2e22=ti2[8];var frequency=this.limitMotor.frequency;var enableSpring=frequency>0;var enableLimit=this.lowerLimit<=this.upperLimit;var angle=this.limitMotor.angle;if(enableLimit){if(this.lowerLimit==this.upperLimit){if(this.limitState!=0){this.limitState=0;this.limitImpulse=0}this.limitVelocity=this.lowerLimit-angle}else if(angle<this.lowerLimit){if(this.limitState!=-1){this.limitState=-1;this.limitImpulse=0}this.limitVelocity=this.lowerLimit-angle}else if(angle>this.upperLimit){if(this.limitState!=1){this.limitState=1;this.limitImpulse=0}this.limitVelocity=this.upperLimit-angle}else{this.limitState=2;this.limitImpulse=0;this.limitVelocity=0}if(!enableSpring){if(this.limitVelocity>.02)this.limitVelocity-=.02;else if(this.limitVelocity<-.02)this.limitVelocity+=.02;else this.limitVelocity=0}}else{this.limitState=2;this.limitImpulse=0}if(this.enableMotor&&(this.limitState!=0||enableSpring)){this.maxMotorImpulse=this.maxMotorForce*timeStep}else{this.motorImpulse=0;this.maxMotorImpulse=0}this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02;this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12;this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22;this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02;this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12;this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22;this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z);this.invMotorDenom=1/this.motorDenom;if(enableSpring&&this.limitState!=2){var omega=6.2831853*frequency;var k=omega*omega*timeStep;var dmp=invTimeStep/(k+2*this.limitMotor.dampingRatio*omega);this.cfm=this.motorDenom*dmp;this.limitVelocity*=k*dmp}else{this.cfm=0;this.limitVelocity*=invTimeStep*.05}this.invDenom=1/(this.motorDenom+this.cfm);this.limitImpulse*=.95;this.motorImpulse*=.95;var totalImpulse=this.limitImpulse+this.motorImpulse;this.a1.x+=totalImpulse*this.a1x;this.a1.y+=totalImpulse*this.a1y;this.a1.z+=totalImpulse*this.a1z;this.a2.x-=totalImpulse*this.a2x;this.a2.y-=totalImpulse*this.a2y;this.a2.z-=totalImpulse*this.a2z},solve:function(){var rvn=this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z);var newMotorImpulse;if(this.enableMotor){newMotorImpulse=(rvn-this.motorSpeed)*this.invMotorDenom;var oldMotorImpulse=this.motorImpulse;this.motorImpulse+=newMotorImpulse;if(this.motorImpulse>this.maxMotorImpulse)this.motorImpulse=this.maxMotorImpulse;else if(this.motorImpulse<-this.maxMotorImpulse)this.motorImpulse=-this.maxMotorImpulse;newMotorImpulse=this.motorImpulse-oldMotorImpulse;rvn-=newMotorImpulse*this.motorDenom}else newMotorImpulse=0;var newLimitImpulse;if(this.limitState!=2){newLimitImpulse=(rvn-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var oldLimitImpulse=this.limitImpulse;this.limitImpulse+=newLimitImpulse;if(this.limitImpulse*this.limitState<0)this.limitImpulse=0;newLimitImpulse=this.limitImpulse-oldLimitImpulse}else newLimitImpulse=0;var totalImpulse=newLimitImpulse+newMotorImpulse;this.a1.x+=totalImpulse*this.a1x;this.a1.y+=totalImpulse*this.a1y;this.a1.z+=totalImpulse*this.a1z;this.a2.x-=totalImpulse*this.a2x;this.a2.y-=totalImpulse*this.a2y;this.a2.z-=totalImpulse*this.a2z}};OIMO.Translational3Constraint=function(joint,limitMotor1,limitMotor2,limitMotor3){this.m1=NaN;this.m2=NaN;this.i1e00=NaN;this.i1e01=NaN;this.i1e02=NaN;this.i1e10=NaN;this.i1e11=NaN;this.i1e12=NaN;this.i1e20=NaN;this.i1e21=NaN;this.i1e22=NaN;this.i2e00=NaN;this.i2e01=NaN;this.i2e02=NaN;this.i2e10=NaN;this.i2e11=NaN;this.i2e12=NaN;this.i2e20=NaN;this.i2e21=NaN;this.i2e22=NaN;this.ax1=NaN;this.ay1=NaN;this.az1=NaN;this.ax2=NaN;this.ay2=NaN;this.az2=NaN;this.ax3=NaN;this.ay3=NaN;this.az3=NaN;this.r1x=NaN;this.r1y=NaN;this.r1z=NaN;this.r2x=NaN;this.r2y=NaN;this.r2z=NaN;this.t1x1=NaN;this.t1y1=NaN;this.t1z1=NaN;this.t2x1=NaN;this.t2y1=NaN;this.t2z1=NaN;this.l1x1=NaN;this.l1y1=NaN;this.l1z1=NaN;this.l2x1=NaN;this.l2y1=NaN;this.l2z1=NaN;this.a1x1=NaN;this.a1y1=NaN;this.a1z1=NaN;this.a2x1=NaN;this.a2y1=NaN;this.a2z1=NaN;this.t1x2=NaN;this.t1y2=NaN;this.t1z2=NaN;this.t2x2=NaN;this.t2y2=NaN;this.t2z2=NaN;this.l1x2=NaN;this.l1y2=NaN;this.l1z2=NaN;this.l2x2=NaN;this.l2y2=NaN;this.l2z2=NaN;this.a1x2=NaN;this.a1y2=NaN;this.a1z2=NaN;this.a2x2=NaN;this.a2y2=NaN;this.a2z2=NaN;this.t1x3=NaN;this.t1y3=NaN;this.t1z3=NaN;this.t2x3=NaN;this.t2y3=NaN;this.t2z3=NaN;this.l1x3=NaN;this.l1y3=NaN;this.l1z3=NaN;this.l2x3=NaN;this.l2y3=NaN;this.l2z3=NaN;this.a1x3=NaN;this.a1y3=NaN;this.a1z3=NaN;this.a2x3=NaN;this.a2y3=NaN;this.a2z3=NaN;this.lowerLimit1=NaN;this.upperLimit1=NaN;this.limitVelocity1=NaN;this.limitState1=0;this.enableMotor1=false;this.motorSpeed1=NaN;this.maxMotorForce1=NaN;this.maxMotorImpulse1=NaN;this.lowerLimit2=NaN;this.upperLimit2=NaN;this.limitVelocity2=NaN;this.limitState2=0;this.enableMotor2=false;this.motorSpeed2=NaN;this.maxMotorForce2=NaN;this.maxMotorImpulse2=NaN;this.lowerLimit3=NaN;this.upperLimit3=NaN;this.limitVelocity3=NaN;this.limitState3=0;this.enableMotor3=false;this.motorSpeed3=NaN;this.maxMotorForce3=NaN;this.maxMotorImpulse3=NaN;this.k00=NaN;this.k01=NaN;this.k02=NaN;this.k10=NaN;this.k11=NaN;this.k12=NaN;this.k20=NaN;this.k21=NaN;this.k22=NaN;this.kv00=NaN;this.kv11=NaN;this.kv22=NaN;this.dv00=NaN;this.dv11=NaN;this.dv22=NaN;this.d00=NaN;this.d01=NaN;this.d02=NaN;this.d10=NaN;this.d11=NaN;this.d12=NaN;this.d20=NaN;this.d21=NaN;this.d22=NaN;this.limitMotor1=limitMotor1;this.limitMotor2=limitMotor2;this.limitMotor3=limitMotor3;this.b1=joint.body1;this.b2=joint.body2;this.p1=joint.anchorPoint1;this.p2=joint.anchorPoint2;this.r1=joint.relativeAnchorPoint1;this.r2=joint.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.limitImpulse1=0;this.motorImpulse1=0;this.limitImpulse2=0;this.motorImpulse2=0;this.limitImpulse3=0;this.motorImpulse3=0;this.cfm1=0;this.cfm2=0;this.cfm3=0;this.weight=-1};OIMO.Translational3Constraint.prototype={constructor:OIMO.Translational3Constraint,preSolve:function(timeStep,invTimeStep){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=this.maxMotorForce1>0;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=this.maxMotorForce2>0;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;this.enableMotor3=this.maxMotorForce3>0;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var ti1=this.i1.elements;var ti2=this.i2.elements;this.i1e00=ti1[0];this.i1e01=ti1[1];this.i1e02=ti1[2];this.i1e10=ti1[3];this.i1e11=ti1[4];this.i1e12=ti1[5];this.i1e20=ti1[6];this.i1e21=ti1[7];this.i1e22=ti1[8];this.i2e00=ti2[0];this.i2e01=ti2[1];this.i2e02=ti2[2];this.i2e10=ti2[3];this.i2e11=ti2[4];this.i2e12=ti2[5];this.i2e20=ti2[6];this.i2e21=ti2[7];this.i2e22=ti2[8];var dx=this.p2.x-this.p1.x;var dy=this.p2.y-this.p1.y;var dz=this.p2.z-this.p1.z;var d1=dx*this.ax1+dy*this.ay1+dz*this.az1;var d2=dx*this.ax2+dy*this.ay2+dz*this.az2;var d3=dx*this.ax3+dy*this.ay3+dz*this.az3;var frequency1=this.limitMotor1.frequency;var frequency2=this.limitMotor2.frequency;var frequency3=this.limitMotor3.frequency;var enableSpring1=frequency1>0;var enableSpring2=frequency2>0;var enableSpring3=frequency3>0;var enableLimit1=this.lowerLimit1<=this.upperLimit1;var enableLimit2=this.lowerLimit2<=this.upperLimit2;var enableLimit3=this.lowerLimit3<=this.upperLimit3;if(enableSpring1&&d1>20||d1<-20){enableSpring1=false}if(enableSpring2&&d2>20||d2<-20){enableSpring2=false}if(enableSpring3&&d3>20||d3<-20){enableSpring3=false}if(enableLimit1){if(this.lowerLimit1==this.upperLimit1){if(this.limitState1!=0){this.limitState1=0;this.limitImpulse1=0}this.limitVelocity1=this.lowerLimit1-d1;if(!enableSpring1)d1=this.lowerLimit1}else if(d1<this.lowerLimit1){if(this.limitState1!=-1){this.limitState1=-1;this.limitImpulse1=0}this.limitVelocity1=this.lowerLimit1-d1;if(!enableSpring1)d1=this.lowerLimit1}else if(d1>this.upperLimit1){if(this.limitState1!=1){this.limitState1=1;this.limitImpulse1=0}this.limitVelocity1=this.upperLimit1-d1;if(!enableSpring1)d1=this.upperLimit1}else{this.limitState1=2;this.limitImpulse1=0;this.limitVelocity1=0}if(!enableSpring1){if(this.limitVelocity1>.005)this.limitVelocity1-=.005;else if(this.limitVelocity1<-.005)this.limitVelocity1+=.005;else this.limitVelocity1=0}}else{this.limitState1=2;this.limitImpulse1=0}if(enableLimit2){if(this.lowerLimit2==this.upperLimit2){if(this.limitState2!=0){this.limitState2=0;this.limitImpulse2=0}this.limitVelocity2=this.lowerLimit2-d2;if(!enableSpring2)d2=this.lowerLimit2}else if(d2<this.lowerLimit2){if(this.limitState2!=-1){this.limitState2=-1;this.limitImpulse2=0}this.limitVelocity2=this.lowerLimit2-d2;if(!enableSpring2)d2=this.lowerLimit2}else if(d2>this.upperLimit2){if(this.limitState2!=1){this.limitState2=1;this.limitImpulse2=0}this.limitVelocity2=this.upperLimit2-d2;if(!enableSpring2)d2=this.upperLimit2}else{this.limitState2=2;this.limitImpulse2=0;this.limitVelocity2=0}if(!enableSpring2){if(this.limitVelocity2>.005)this.limitVelocity2-=.005;else if(this.limitVelocity2<-.005)this.limitVelocity2+=.005;else this.limitVelocity2=0}}else{this.limitState2=2;this.limitImpulse2=0}if(enableLimit3){if(this.lowerLimit3==this.upperLimit3){if(this.limitState3!=0){this.limitState3=0;this.limitImpulse3=0}this.limitVelocity3=this.lowerLimit3-d3;if(!enableSpring3)d3=this.lowerLimit3}else if(d3<this.lowerLimit3){if(this.limitState3!=-1){this.limitState3=-1;this.limitImpulse3=0}this.limitVelocity3=this.lowerLimit3-d3;if(!enableSpring3)d3=this.lowerLimit3}else if(d3>this.upperLimit3){if(this.limitState3!=1){this.limitState3=1;this.limitImpulse3=0}this.limitVelocity3=this.upperLimit3-d3;if(!enableSpring3)d3=this.upperLimit3}else{this.limitState3=2;this.limitImpulse3=0;this.limitVelocity3=0}if(!enableSpring3){if(this.limitVelocity3>.005)this.limitVelocity3-=.005;else if(this.limitVelocity3<-.005)this.limitVelocity3+=.005;else this.limitVelocity3=0}}else{this.limitState3=2;this.limitImpulse3=0}if(this.enableMotor1&&(this.limitState1!=0||enableSpring1)){this.maxMotorImpulse1=this.maxMotorForce1*timeStep}else{this.motorImpulse1=0;this.maxMotorImpulse1=0}if(this.enableMotor2&&(this.limitState2!=0||enableSpring2)){this.maxMotorImpulse2=this.maxMotorForce2*timeStep}else{this.motorImpulse2=0;this.maxMotorImpulse2=0}if(this.enableMotor3&&(this.limitState3!=0||enableSpring3)){this.maxMotorImpulse3=this.maxMotorForce3*timeStep}else{this.motorImpulse3=0;this.maxMotorImpulse3=0}var rdx=d1*this.ax1+d2*this.ax2+d3*this.ax2;var rdy=d1*this.ay1+d2*this.ay2+d3*this.ay2;var rdz=d1*this.az1+d2*this.az2+d3*this.az2;var w1=this.m2/(this.m1+this.m2);if(this.weight>=0)w1=this.weight;var w2=1-w1;this.r1x=this.r1.x+rdx*w1;this.r1y=this.r1.y+rdy*w1;this.r1z=this.r1.z+rdz*w1;this.r2x=this.r2.x-rdx*w2;this.r2y=this.r2.y-rdy*w2;this.r2z=this.r2.z-rdz*w2;this.t1x1=this.r1y*this.az1-this.r1z*this.ay1;this.t1y1=this.r1z*this.ax1-this.r1x*this.az1;this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1;this.t2x1=this.r2y*this.az1-this.r2z*this.ay1;this.t2y1=this.r2z*this.ax1-this.r2x*this.az1;this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1;this.l1x1=this.ax1*this.m1;this.l1y1=this.ay1*this.m1;this.l1z1=this.az1*this.m1;this.l2x1=this.ax1*this.m2;this.l2y1=this.ay1*this.m2;this.l2z1=this.az1*this.m2;this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02;this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12;this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22;this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02;this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12;this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22;this.t1x2=this.r1y*this.az2-this.r1z*this.ay2;this.t1y2=this.r1z*this.ax2-this.r1x*this.az2;this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2;this.t2x2=this.r2y*this.az2-this.r2z*this.ay2;this.t2y2=this.r2z*this.ax2-this.r2x*this.az2;this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2;this.l1x2=this.ax2*this.m1;this.l1y2=this.ay2*this.m1;this.l1z2=this.az2*this.m1;this.l2x2=this.ax2*this.m2;this.l2y2=this.ay2*this.m2;this.l2z2=this.az2*this.m2;this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02;this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12;this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22;this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02;this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12;this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22;this.t1x3=this.r1y*this.az3-this.r1z*this.ay3;this.t1y3=this.r1z*this.ax3-this.r1x*this.az3;this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3;this.t2x3=this.r2y*this.az3-this.r2z*this.ay3;this.t2y3=this.r2z*this.ax3-this.r2x*this.az3;this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3;this.l1x3=this.ax3*this.m1;this.l1y3=this.ay3*this.m1;this.l1z3=this.az3*this.m1;this.l2x3=this.ax3*this.m2;this.l2y3=this.ay3*this.m2;this.l2z3=this.az3*this.m2;this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02;this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12;this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22;this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02;this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12;this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var m12=this.m1+this.m2;this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*m12;this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*m12;this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*m12;this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*m12;this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*m12;this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*m12;this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*m12;this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*m12;this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*m12;this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1;this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2;this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3;this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1;this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2;this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3;this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1;this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2;this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3;this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1;this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2;this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3;this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1;this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2;this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3;this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1;this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2;this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3;this.kv00=this.k00;this.kv11=this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;if(enableSpring1&&this.limitState1!=2){var omega=6.2831853*frequency1;var k=omega*omega*timeStep;var dmp=invTimeStep/(k+2*this.limitMotor1.dampingRatio*omega);this.cfm1=this.kv00*dmp;this.limitVelocity1*=k*dmp}else{this.cfm1=0;this.limitVelocity1*=invTimeStep*.05}if(enableSpring2&&this.limitState2!=2){omega=6.2831853*frequency2;k=omega*omega*timeStep;dmp=invTimeStep/(k+2*this.limitMotor2.dampingRatio*omega);this.cfm2=this.kv11*dmp;this.limitVelocity2*=k*dmp}else{this.cfm2=0;this.limitVelocity2*=invTimeStep*.05}if(enableSpring3&&this.limitState3!=2){omega=6.2831853*frequency3;k=omega*omega*timeStep;dmp=invTimeStep/(k+2*this.limitMotor3.dampingRatio*omega);this.cfm3=this.kv22*dmp;this.limitVelocity3*=k*dmp}else{this.cfm3=0;this.limitVelocity3*=invTimeStep*.05}this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;var inv=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*inv;this.d01=(this.k02*this.k21-this.k01*this.k22)*inv;this.d02=(this.k01*this.k12-this.k02*this.k11)*inv;this.d10=(this.k12*this.k20-this.k10*this.k22)*inv;this.d11=(this.k00*this.k22-this.k02*this.k20)*inv;this.d12=(this.k02*this.k10-this.k00*this.k12)*inv;this.d20=(this.k10*this.k21-this.k11*this.k20)*inv;this.d21=(this.k01*this.k20-this.k00*this.k21)*inv;this.d22=(this.k00*this.k11-this.k01*this.k10)*inv;var totalImpulse1=this.limitImpulse1+this.motorImpulse1;var totalImpulse2=this.limitImpulse2+this.motorImpulse2;var totalImpulse3=this.limitImpulse3+this.motorImpulse3;this.l1.x+=totalImpulse1*this.l1x1+totalImpulse2*this.l1x2+totalImpulse3*this.l1x3;this.l1.y+=totalImpulse1*this.l1y1+totalImpulse2*this.l1y2+totalImpulse3*this.l1y3;this.l1.z+=totalImpulse1*this.l1z1+totalImpulse2*this.l1z2+totalImpulse3*this.l1z3;this.a1.x+=totalImpulse1*this.a1x1+totalImpulse2*this.a1x2+totalImpulse3*this.a1x3;this.a1.y+=totalImpulse1*this.a1y1+totalImpulse2*this.a1y2+totalImpulse3*this.a1y3;this.a1.z+=totalImpulse1*this.a1z1+totalImpulse2*this.a1z2+totalImpulse3*this.a1z3;this.l2.x-=totalImpulse1*this.l2x1+totalImpulse2*this.l2x2+totalImpulse3*this.l2x3;this.l2.y-=totalImpulse1*this.l2y1+totalImpulse2*this.l2y2+totalImpulse3*this.l2y3;this.l2.z-=totalImpulse1*this.l2z1+totalImpulse2*this.l2z2+totalImpulse3*this.l2z3;this.a2.x-=totalImpulse1*this.a2x1+totalImpulse2*this.a2x2+totalImpulse3*this.a2x3;this.a2.y-=totalImpulse1*this.a2y1+totalImpulse2*this.a2y2+totalImpulse3*this.a2y3;this.a2.z-=totalImpulse1*this.a2z1+totalImpulse2*this.a2z2+totalImpulse3*this.a2z3},solve:function(){var rvx=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y;var rvy=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z;var rvz=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x;var rvn1=rvx*this.ax1+rvy*this.ay1+rvz*this.az1;var rvn2=rvx*this.ax2+rvy*this.ay2+rvz*this.az2;var rvn3=rvx*this.ax3+rvy*this.ay3+rvz*this.az3;var oldMotorImpulse1=this.motorImpulse1;var oldMotorImpulse2=this.motorImpulse2;var oldMotorImpulse3=this.motorImpulse3;var dMotorImpulse1=0;var dMotorImpulse2=0;var dMotorImpulse3=0;if(this.enableMotor1){dMotorImpulse1=(rvn1-this.motorSpeed1)*this.dv00;this.motorImpulse1+=dMotorImpulse1;if(this.motorImpulse1>this.maxMotorImpulse1){this.motorImpulse1=this.maxMotorImpulse1}else if(this.motorImpulse1<-this.maxMotorImpulse1){this.motorImpulse1=-this.maxMotorImpulse1}dMotorImpulse1=this.motorImpulse1-oldMotorImpulse1}if(this.enableMotor2){dMotorImpulse2=(rvn2-this.motorSpeed2)*this.dv11;this.motorImpulse2+=dMotorImpulse2;if(this.motorImpulse2>this.maxMotorImpulse2){this.motorImpulse2=this.maxMotorImpulse2}else if(this.motorImpulse2<-this.maxMotorImpulse2){this.motorImpulse2=-this.maxMotorImpulse2}dMotorImpulse2=this.motorImpulse2-oldMotorImpulse2}if(this.enableMotor3){dMotorImpulse3=(rvn3-this.motorSpeed3)*this.dv22;this.motorImpulse3+=dMotorImpulse3;if(this.motorImpulse3>this.maxMotorImpulse3){this.motorImpulse3=this.maxMotorImpulse3}else if(this.motorImpulse3<-this.maxMotorImpulse3){this.motorImpulse3=-this.maxMotorImpulse3}dMotorImpulse3=this.motorImpulse3-oldMotorImpulse3}rvn1+=dMotorImpulse1*this.kv00+dMotorImpulse2*this.k01+dMotorImpulse3*this.k02;rvn2+=dMotorImpulse1*this.k10+dMotorImpulse2*this.kv11+dMotorImpulse3*this.k12;rvn3+=dMotorImpulse1*this.k20+dMotorImpulse2*this.k21+dMotorImpulse3*this.kv22;rvn1-=this.limitVelocity1+this.limitImpulse1*this.cfm1;rvn2-=this.limitVelocity2+this.limitImpulse2*this.cfm2;rvn3-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var oldLimitImpulse1=this.limitImpulse1;var oldLimitImpulse2=this.limitImpulse2;var oldLimitImpulse3=this.limitImpulse3;var dLimitImpulse1=rvn1*this.d00+rvn2*this.d01+rvn3*this.d02;var dLimitImpulse2=rvn1*this.d10+rvn2*this.d11+rvn3*this.d12;var dLimitImpulse3=rvn1*this.d20+rvn2*this.d21+rvn3*this.d22;this.limitImpulse1+=dLimitImpulse1;this.limitImpulse2+=dLimitImpulse2;this.limitImpulse3+=dLimitImpulse3;var clampState=0;if(this.limitState1==2||this.limitImpulse1*this.limitState1<0){dLimitImpulse1=-oldLimitImpulse1;rvn2+=dLimitImpulse1*this.k10;rvn3+=dLimitImpulse1*this.k20;clampState|=1}if(this.limitState2==2||this.limitImpulse2*this.limitState2<0){dLimitImpulse2=-oldLimitImpulse2;rvn1+=dLimitImpulse2*this.k01;rvn3+=dLimitImpulse2*this.k21;clampState|=2}if(this.limitState3==2||this.limitImpulse3*this.limitState3<0){dLimitImpulse3=-oldLimitImpulse3;rvn1+=dLimitImpulse3*this.k02;rvn2+=dLimitImpulse3*this.k12;clampState|=4}var det;switch(clampState){case 1:det=1/(this.k11*this.k22-this.k12*this.k21);dLimitImpulse2=(this.k22*rvn2+-this.k12*rvn3)*det;dLimitImpulse3=(-this.k21*rvn2+this.k11*rvn3)*det;break;case 2:det=1/(this.k00*this.k22-this.k02*this.k20);dLimitImpulse1=(this.k22*rvn1+-this.k02*rvn3)*det;dLimitImpulse3=(-this.k20*rvn1+this.k00*rvn3)*det;break;case 3:dLimitImpulse3=rvn3/this.k22;break;case 4:det=1/(this.k00*this.k11-this.k01*this.k10);dLimitImpulse1=(this.k11*rvn1+-this.k01*rvn2)*det;dLimitImpulse2=(-this.k10*rvn1+this.k00*rvn2)*det;break;case 5:dLimitImpulse2=rvn2/this.k11;break;case 6:dLimitImpulse1=rvn1/this.k00;break}this.limitImpulse1=oldLimitImpulse1+dLimitImpulse1;this.limitImpulse2=oldLimitImpulse2+dLimitImpulse2;this.limitImpulse3=oldLimitImpulse3+dLimitImpulse3;var dImpulse1=dMotorImpulse1+dLimitImpulse1;var dImpulse2=dMotorImpulse2+dLimitImpulse2;var dImpulse3=dMotorImpulse3+dLimitImpulse3;this.l1.x+=dImpulse1*this.l1x1+dImpulse2*this.l1x2+dImpulse3*this.l1x3;this.l1.y+=dImpulse1*this.l1y1+dImpulse2*this.l1y2+dImpulse3*this.l1y3;this.l1.z+=dImpulse1*this.l1z1+dImpulse2*this.l1z2+dImpulse3*this.l1z3;this.a1.x+=dImpulse1*this.a1x1+dImpulse2*this.a1x2+dImpulse3*this.a1x3;this.a1.y+=dImpulse1*this.a1y1+dImpulse2*this.a1y2+dImpulse3*this.a1y3;this.a1.z+=dImpulse1*this.a1z1+dImpulse2*this.a1z2+dImpulse3*this.a1z3;this.l2.x-=dImpulse1*this.l2x1+dImpulse2*this.l2x2+dImpulse3*this.l2x3;this.l2.y-=dImpulse1*this.l2y1+dImpulse2*this.l2y2+dImpulse3*this.l2y3;this.l2.z-=dImpulse1*this.l2z1+dImpulse2*this.l2z2+dImpulse3*this.l2z3;this.a2.x-=dImpulse1*this.a2x1+dImpulse2*this.a2x2+dImpulse3*this.a2x3;this.a2.y-=dImpulse1*this.a2y1+dImpulse2*this.a2y2+dImpulse3*this.a2y3;this.a2.z-=dImpulse1*this.a2z1+dImpulse2*this.a2z2+dImpulse3*this.a2z3}};OIMO.TranslationalConstraint=function(joint,limitMotor){this.cfm=NaN;this.m1=NaN;this.m2=NaN;this.i1e00=NaN;this.i1e01=NaN;this.i1e02=NaN;this.i1e10=NaN;this.i1e11=NaN;this.i1e12=NaN;this.i1e20=NaN;this.i1e21=NaN;this.i1e22=NaN;this.i2e00=NaN;this.i2e01=NaN;this.i2e02=NaN;this.i2e10=NaN;this.i2e11=NaN;this.i2e12=NaN;this.i2e20=NaN;this.i2e21=NaN;this.i2e22=NaN;this.motorDenom=NaN;this.invMotorDenom=NaN;this.invDenom=NaN;this.ax=NaN;this.ay=NaN;this.az=NaN;this.r1x=NaN;this.r1y=NaN;this.r1z=NaN;this.r2x=NaN;this.r2y=NaN;this.r2z=NaN;this.t1x=NaN;this.t1y=NaN;this.t1z=NaN;this.t2x=NaN;this.t2y=NaN;this.t2z=NaN;this.l1x=NaN;this.l1y=NaN;this.l1z=NaN;this.l2x=NaN;this.l2y=NaN;this.l2z=NaN;this.a1x=NaN;this.a1y=NaN;this.a1z=NaN;this.a2x=NaN;this.a2y=NaN;this.a2z=NaN;this.lowerLimit=NaN;this.upperLimit=NaN;this.limitVelocity=NaN;this.limitState=0;this.enableMotor=false;this.motorSpeed=NaN;this.maxMotorForce=NaN;this.maxMotorImpulse=NaN;this.limitMotor=limitMotor;this.b1=joint.body1;this.b2=joint.body2;this.p1=joint.anchorPoint1;this.p2=joint.anchorPoint2;this.r1=joint.relativeAnchorPoint1;this.r2=joint.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.limitImpulse=0;this.motorImpulse=0};OIMO.TranslationalConstraint.prototype={constructor:OIMO.TranslationalConstraint,preSolve:function(timeStep,invTimeStep){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=this.maxMotorForce>0;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var ti1=this.i1.elements;var ti2=this.i2.elements;this.i1e00=ti1[0];this.i1e01=ti1[1];this.i1e02=ti1[2];this.i1e10=ti1[3];this.i1e11=ti1[4];this.i1e12=ti1[5];this.i1e20=ti1[6];this.i1e21=ti1[7];this.i1e22=ti1[8];this.i2e00=ti2[0];this.i2e01=ti2[1];this.i2e02=ti2[2];this.i2e10=ti2[3];this.i2e11=ti2[4];this.i2e12=ti2[5];this.i2e20=ti2[6];this.i2e21=ti2[7];this.i2e22=ti2[8];var dx=this.p2.x-this.p1.x;var dy=this.p2.y-this.p1.y;var dz=this.p2.z-this.p1.z;var d=dx*this.ax+dy*this.ay+dz*this.az;var frequency=this.limitMotor.frequency;var enableSpring=frequency>0;var enableLimit=this.lowerLimit<=this.upperLimit;if(enableSpring&&d>20||d<-20){enableSpring=false}if(enableLimit){if(this.lowerLimit==this.upperLimit){if(this.limitState!=0){this.limitState=0;this.limitImpulse=0}this.limitVelocity=this.lowerLimit-d;if(!enableSpring)d=this.lowerLimit}else if(d<this.lowerLimit){if(this.limitState!=-1){this.limitState=-1;this.limitImpulse=0}this.limitVelocity=this.lowerLimit-d;if(!enableSpring)d=this.lowerLimit}else if(d>this.upperLimit){if(this.limitState!=1){this.limitState=1;this.limitImpulse=0}this.limitVelocity=this.upperLimit-d;if(!enableSpring)d=this.upperLimit}else{this.limitState=2;this.limitImpulse=0;this.limitVelocity=0}if(!enableSpring){if(this.limitVelocity>.005)this.limitVelocity-=.005;else if(this.limitVelocity<-.005)this.limitVelocity+=.005;else this.limitVelocity=0}}else{this.limitState=2;this.limitImpulse=0}if(this.enableMotor&&(this.limitState!=0||enableSpring)){this.maxMotorImpulse=this.maxMotorForce*timeStep}else{this.motorImpulse=0;this.maxMotorImpulse=0}var rdx=d*this.ax;var rdy=d*this.ay;var rdz=d*this.az;var w1=this.m1/(this.m1+this.m2);var w2=1-w1;this.r1x=this.r1.x+rdx*w1;this.r1y=this.r1.y+rdy*w1;this.r1z=this.r1.z+rdz*w1;this.r2x=this.r2.x-rdx*w2;this.r2y=this.r2.y-rdy*w2;this.r2z=this.r2.z-rdz*w2;this.t1x=this.r1y*this.az-this.r1z*this.ay;this.t1y=this.r1z*this.ax-this.r1x*this.az;this.t1z=this.r1x*this.ay-this.r1y*this.ax;this.t2x=this.r2y*this.az-this.r2z*this.ay;this.t2y=this.r2z*this.ax-this.r2x*this.az;this.t2z=this.r2x*this.ay-this.r2y*this.ax;this.l1x=this.ax*this.m1;this.l1y=this.ay*this.m1;this.l1z=this.az*this.m1;this.l2x=this.ax*this.m2;this.l2y=this.ay*this.m2;this.l2z=this.az*this.m2;this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02;this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12;this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22;this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02;this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12;this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22;this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x);this.invMotorDenom=1/this.motorDenom;if(enableSpring&&this.limitState!=2){var omega=6.2831853*frequency;var k=omega*omega*timeStep;var dmp=invTimeStep/(k+2*this.limitMotor.dampingRatio*omega);this.cfm=this.motorDenom*dmp;this.limitVelocity*=k*dmp}else{this.cfm=0;this.limitVelocity*=invTimeStep*.05}this.invDenom=1/(this.motorDenom+this.cfm);var totalImpulse=this.limitImpulse+this.motorImpulse;this.l1.x+=totalImpulse*this.l1x;this.l1.y+=totalImpulse*this.l1y;this.l1.z+=totalImpulse*this.l1z;this.a1.x+=totalImpulse*this.a1x;this.a1.y+=totalImpulse*this.a1y;this.a1.z+=totalImpulse*this.a1z;this.l2.x-=totalImpulse*this.l2x;this.l2.y-=totalImpulse*this.l2y;this.l2.z-=totalImpulse*this.l2z;this.a2.x-=totalImpulse*this.a2x;this.a2.y-=totalImpulse*this.a2y;this.a2.z-=totalImpulse*this.a2z},solve:function(){var rvn=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;var newMotorImpulse;if(this.enableMotor){newMotorImpulse=(rvn-this.motorSpeed)*this.invMotorDenom;var oldMotorImpulse=this.motorImpulse;this.motorImpulse+=newMotorImpulse;if(this.motorImpulse>this.maxMotorImpulse)this.motorImpulse=this.maxMotorImpulse;else if(this.motorImpulse<-this.maxMotorImpulse)this.motorImpulse=-this.maxMotorImpulse;newMotorImpulse=this.motorImpulse-oldMotorImpulse;rvn-=newMotorImpulse*this.motorDenom}else newMotorImpulse=0;var newLimitImpulse;if(this.limitState!=2){newLimitImpulse=(rvn-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var oldLimitImpulse=this.limitImpulse;this.limitImpulse+=newLimitImpulse;if(this.limitImpulse*this.limitState<0)this.limitImpulse=0;newLimitImpulse=this.limitImpulse-oldLimitImpulse}else newLimitImpulse=0;var totalImpulse=newLimitImpulse+newMotorImpulse;this.l1.x+=totalImpulse*this.l1x;this.l1.y+=totalImpulse*this.l1y;this.l1.z+=totalImpulse*this.l1z;this.a1.x+=totalImpulse*this.a1x;this.a1.y+=totalImpulse*this.a1y;this.a1.z+=totalImpulse*this.a1z;this.l2.x-=totalImpulse*this.l2x;this.l2.y-=totalImpulse*this.l2y;this.l2.z-=totalImpulse*this.l2z;this.a2.x-=totalImpulse*this.a2x;this.a2.y-=totalImpulse*this.a2y;this.a2.z-=totalImpulse*this.a2z}};OIMO.Contact=function(){this.shape1=null;this.shape2=null;this.body1=null;this.body2=null;this.prev=null;this.next=null;this.persisting=false;this.sleeping=false;this.detector=null;this.constraint=null;this.touching=false;this.b1Link=new OIMO.ContactLink(this);this.b2Link=new OIMO.ContactLink(this);this.s1Link=new OIMO.ContactLink(this);this.s2Link=new OIMO.ContactLink(this);this.manifold=new OIMO.ContactManifold;this.buffer=[];this.buffer.length=4;this.buffer[0]=new OIMO.ImpulseDataBuffer;this.buffer[1]=new OIMO.ImpulseDataBuffer;this.buffer[2]=new OIMO.ImpulseDataBuffer;this.buffer[3]=new OIMO.ImpulseDataBuffer;this.points=this.manifold.points;this.constraint=new OIMO.ContactConstraint(this.manifold)};OIMO.Contact.prototype={constructor:OIMO.Contact,mixRestitution:function(restitution1,restitution2){return OIMO.sqrt(restitution1*restitution2)},mixFriction:function(friction1,friction2){return OIMO.sqrt(friction1*friction2)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution);this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);var numBuffers=this.manifold.numPoints;var i=numBuffers;while(i--){var b=this.buffer[i];var p=this.points[i];b.lp1X=p.localPoint1.x;b.lp1Y=p.localPoint1.y;b.lp1Z=p.localPoint1.z;b.lp2X=p.localPoint2.x;b.lp2Y=p.localPoint2.y;b.lp2Z=p.localPoint2.z;b.impulse=p.normalImpulse}this.manifold.numPoints=0;this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var num=this.manifold.numPoints;if(num==0){this.touching=false;return}this.touching=true;i=num;while(i--){p=this.points[i];var lp1x=p.localPoint1.x;var lp1y=p.localPoint1.y;var lp1z=p.localPoint1.z;var lp2x=p.localPoint2.x;var lp2y=p.localPoint2.y;var lp2z=p.localPoint2.z;var index=-1;var minDistance=4e-4;var j=numBuffers;while(j--){b=this.buffer[j];var dx=b.lp1X-lp1x;var dy=b.lp1Y-lp1y;var dz=b.lp1Z-lp1z;var distance1=dx*dx+dy*dy+dz*dz;dx=b.lp2X-lp2x;dy=b.lp2Y-lp2y;dz=b.lp2Z-lp2z;var distance2=dx*dx+dy*dy+dz*dz;if(distance1<distance2){if(distance1<minDistance){minDistance=distance1;index=j}}else{if(distance2<minDistance){minDistance=distance2;index=j}}}if(index!=-1){var tmp=this.buffer[index];this.buffer[index]=this.buffer[--numBuffers];this.buffer[numBuffers]=tmp;p.normalImpulse=tmp.impulse;p.warmStarted=true}else{p.normalImpulse=0;p.warmStarted=false}}},attach:function(shape1,shape2){this.shape1=shape1;this.shape2=shape2;this.body1=shape1.parent;this.body2=shape2.parent;this.manifold.body1=this.body1;this.manifold.body2=this.body2;this.constraint.body1=this.body1;this.constraint.body2=this.body2;this.constraint.attach();this.s1Link.shape=shape2;this.s1Link.body=this.body2;this.s2Link.shape=shape1;this.s2Link.body=this.body1;if(shape1.contactLink!=null)(this.s1Link.next=shape1.contactLink).prev=this.s1Link;else this.s1Link.next=null;shape1.contactLink=this.s1Link;shape1.numContacts++;if(shape2.contactLink!=null)(this.s2Link.next=shape2.contactLink).prev=this.s2Link;else this.s2Link.next=null;shape2.contactLink=this.s2Link;shape2.numContacts++;this.b1Link.shape=shape2;this.b1Link.body=this.body2;this.b2Link.shape=shape1;this.b2Link.body=this.body1;if(this.body1.contactLink!=null)(this.b1Link.next=this.body1.contactLink).prev=this.b1Link;else this.b1Link.next=null;this.body1.contactLink=this.b1Link;this.body1.numContacts++;if(this.body2.contactLink!=null)(this.b2Link.next=this.body2.contactLink).prev=this.b2Link;else this.b2Link.next=null;this.body2.contactLink=this.b2Link;this.body2.numContacts++;this.prev=null;this.next=null;this.persisting=true;this.sleeping=this.body1.sleeping&&this.body2.sleeping;this.manifold.numPoints=0},detach:function(){var prev=this.s1Link.prev;var next=this.s1Link.next;if(prev!==null)prev.next=next;if(next!==null)next.prev=prev;if(this.shape1.contactLink==this.s1Link)this.shape1.contactLink=next;this.s1Link.prev=null;this.s1Link.next=null;this.s1Link.shape=null;this.s1Link.body=null;this.shape1.numContacts--;prev=this.s2Link.prev;next=this.s2Link.next;if(prev!==null)prev.next=next;if(next!==null)next.prev=prev;if(this.shape2.contactLink==this.s2Link)this.shape2.contactLink=next;this.s2Link.prev=null;this.s2Link.next=null;this.s2Link.shape=null;this.s2Link.body=null;this.shape2.numContacts--;prev=this.b1Link.prev;next=this.b1Link.next;if(prev!==null)prev.next=next;if(next!==null)next.prev=prev;if(this.body1.contactLink==this.b1Link)this.body1.contactLink=next;this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.shape=null;this.b1Link.body=null;this.body1.numContacts--;prev=this.b2Link.prev;next=this.b2Link.next;if(prev!==null)prev.next=next;if(next!==null)next.prev=prev;if(this.body2.contactLink==this.b2Link)this.body2.contactLink=next;this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.shape=null;this.b2Link.body=null;this.body2.numContacts--;this.manifold.body1=null;this.manifold.body2=null;this.constraint.body1=null;this.constraint.body2=null;this.constraint.detach();this.shape1=null;this.shape2=null;this.body1=null;this.body2=null}};OIMO.ContactConstraint=function(manifold){OIMO.Constraint.call(this);this.manifold=manifold;this.restitution=NaN;this.friction=NaN;this.p1=null;this.p2=null;this.lv1=null;this.lv2=null;this.av1=null;this.av2=null;this.i1=null;this.i2=null;this.ii1=null;this.ii2=null;this.m1=NaN;this.m2=NaN;this.num=0;this.ps=manifold.points;this.cs=new OIMO.ContactPointDataBuffer;this.cs.next=new OIMO.ContactPointDataBuffer;this.cs.next.next=new OIMO.ContactPointDataBuffer;this.cs.next.next.next=new OIMO.ContactPointDataBuffer};OIMO.ContactConstraint.prototype=Object.create(OIMO.Constraint.prototype);OIMO.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position;this.p2=this.body2.position;this.lv1=this.body1.linearVelocity;this.av1=this.body1.angularVelocity;this.lv2=this.body2.linearVelocity;this.av2=this.body2.angularVelocity;this.i1=this.body1.inverseInertia;this.i2=this.body2.inverseInertia};OIMO.ContactConstraint.prototype.detach=function(){this.p1=null;this.p2=null;this.lv1=null;this.lv2=null;this.av1=null;this.av2=null;this.i1=null;this.i2=null};OIMO.ContactConstraint.prototype.preSolve=function(timeStep,invTimeStep){this.m1=this.body1.inverseMass;this.m2=this.body2.inverseMass;this.ii1=this.i1.clone();this.ii2=this.i2.clone();var ii1=this.ii1.elements;var ii2=this.ii2.elements;var p1x=this.p1.x;var p1y=this.p1.y;var p1z=this.p1.z;var p2x=this.p2.x;var p2y=this.p2.y;var p2z=this.p2.z;var m1m2=this.m1+this.m2;this.num=this.manifold.numPoints;var c=this.cs;for(var i=0;i<this.num;i++){var p=this.ps[i];var tmp1X;var tmp1Y;var tmp1Z;var tmp2X;var tmp2Y;var tmp2Z;tmp1X=p.position.x;tmp1Y=p.position.y;tmp1Z=p.position.z;var rp1X=tmp1X-p1x;var rp1Y=tmp1Y-p1y;var rp1Z=tmp1Z-p1z;var rp2X=tmp1X-p2x;var rp2Y=tmp1Y-p2y;var rp2Z=tmp1Z-p2z;c.rp1X=rp1X;c.rp1Y=rp1Y;c.rp1Z=rp1Z;c.rp2X=rp2X;c.rp2Y=rp2Y;c.rp2Z=rp2Z;c.norImp=p.normalImpulse;c.tanImp=p.tangentImpulse;c.binImp=p.binormalImpulse;var norX=p.normal.x;var norY=p.normal.y;var norZ=p.normal.z;var rvX=this.lv2.x+this.av2.y*rp2Z-this.av2.z*rp2Y-(this.lv1.x+this.av1.y*rp1Z-this.av1.z*rp1Y);var rvY=this.lv2.y+this.av2.z*rp2X-this.av2.x*rp2Z-(this.lv1.y+this.av1.z*rp1X-this.av1.x*rp1Z);var rvZ=this.lv2.z+this.av2.x*rp2Y-this.av2.y*rp2X-(this.lv1.z+this.av1.x*rp1Y-this.av1.y*rp1X);var rvn=norX*rvX+norY*rvY+norZ*rvZ;var tanX=rvX-rvn*norX;var tanY=rvY-rvn*norY;var tanZ=rvZ-rvn*norZ;var len=tanX*tanX+tanY*tanY+tanZ*tanZ;if(len>.04){len=1/OIMO.sqrt(len)}else{tanX=norY*norX-norZ*norZ;tanY=-norZ*norY-norX*norX;tanZ=norX*norZ+norY*norY;len=1/OIMO.sqrt(tanX*tanX+tanY*tanY+tanZ*tanZ)}tanX*=len;tanY*=len;tanZ*=len;var binX=norY*tanZ-norZ*tanY;var binY=norZ*tanX-norX*tanZ;var binZ=norX*tanY-norY*tanX;c.norX=norX;c.norY=norY;c.norZ=norZ;c.tanX=tanX;c.tanY=tanY;c.tanZ=tanZ;c.binX=binX;c.binY=binY;c.binZ=binZ;c.norU1X=norX*this.m1;c.norU1Y=norY*this.m1;c.norU1Z=norZ*this.m1;c.norU2X=norX*this.m2;c.norU2Y=norY*this.m2;c.norU2Z=norZ*this.m2;c.tanU1X=tanX*this.m1;c.tanU1Y=tanY*this.m1;c.tanU1Z=tanZ*this.m1;c.tanU2X=tanX*this.m2;c.tanU2Y=tanY*this.m2;c.tanU2Z=tanZ*this.m2;c.binU1X=binX*this.m1;c.binU1Y=binY*this.m1;c.binU1Z=binZ*this.m1;c.binU2X=binX*this.m2;c.binU2Y=binY*this.m2;c.binU2Z=binZ*this.m2;var norT1X=rp1Y*norZ-rp1Z*norY;var norT1Y=rp1Z*norX-rp1X*norZ;var norT1Z=rp1X*norY-rp1Y*norX;var norT2X=rp2Y*norZ-rp2Z*norY;var norT2Y=rp2Z*norX-rp2X*norZ;var norT2Z=rp2X*norY-rp2Y*norX;var tanT1X=rp1Y*tanZ-rp1Z*tanY;var tanT1Y=rp1Z*tanX-rp1X*tanZ;var tanT1Z=rp1X*tanY-rp1Y*tanX;var tanT2X=rp2Y*tanZ-rp2Z*tanY;var tanT2Y=rp2Z*tanX-rp2X*tanZ;var tanT2Z=rp2X*tanY-rp2Y*tanX;var binT1X=rp1Y*binZ-rp1Z*binY;var binT1Y=rp1Z*binX-rp1X*binZ;var binT1Z=rp1X*binY-rp1Y*binX;var binT2X=rp2Y*binZ-rp2Z*binY;var binT2Y=rp2Z*binX-rp2X*binZ;var binT2Z=rp2X*binY-rp2Y*binX;var norTU1X=norT1X*ii1[0]+norT1Y*ii1[1]+norT1Z*ii1[2];var norTU1Y=norT1X*ii1[3]+norT1Y*ii1[4]+norT1Z*ii1[5];var norTU1Z=norT1X*ii1[6]+norT1Y*ii1[7]+norT1Z*ii1[8];var norTU2X=norT2X*ii2[0]+norT2Y*ii2[1]+norT2Z*ii2[2];var norTU2Y=norT2X*ii2[3]+norT2Y*ii2[4]+norT2Z*ii2[5];var norTU2Z=norT2X*ii2[6]+norT2Y*ii2[7]+norT2Z*ii2[8];var tanTU1X=tanT1X*ii1[0]+tanT1Y*ii1[1]+tanT1Z*ii1[2];var tanTU1Y=tanT1X*ii1[3]+tanT1Y*ii1[4]+tanT1Z*ii1[5];var tanTU1Z=tanT1X*ii1[6]+tanT1Y*ii1[7]+tanT1Z*ii1[8];var tanTU2X=tanT2X*ii2[0]+tanT2Y*ii2[1]+tanT2Z*ii2[2];var tanTU2Y=tanT2X*ii2[3]+tanT2Y*ii2[4]+tanT2Z*ii2[5];var tanTU2Z=tanT2X*ii2[6]+tanT2Y*ii2[7]+tanT2Z*ii2[8];var binTU1X=binT1X*ii1[0]+binT1Y*ii1[1]+binT1Z*ii1[2];var binTU1Y=binT1X*ii1[3]+binT1Y*ii1[4]+binT1Z*ii1[5];var binTU1Z=binT1X*ii1[6]+binT1Y*ii1[7]+binT1Z*ii1[8];var binTU2X=binT2X*ii2[0]+binT2Y*ii2[1]+binT2Z*ii2[2];var binTU2Y=binT2X*ii2[3]+binT2Y*ii2[4]+binT2Z*ii2[5];var binTU2Z=binT2X*ii2[6]+binT2Y*ii2[7]+binT2Z*ii2[8];c.norT1X=norT1X;c.norT1Y=norT1Y;c.norT1Z=norT1Z;c.tanT1X=tanT1X;c.tanT1Y=tanT1Y;c.tanT1Z=tanT1Z;c.binT1X=binT1X;c.binT1Y=binT1Y;c.binT1Z=binT1Z;c.norT2X=norT2X;c.norT2Y=norT2Y;c.norT2Z=norT2Z;c.tanT2X=tanT2X;c.tanT2Y=tanT2Y;c.tanT2Z=tanT2Z;c.binT2X=binT2X;c.binT2Y=binT2Y;c.binT2Z=binT2Z;c.norTU1X=norTU1X;c.norTU1Y=norTU1Y;c.norTU1Z=norTU1Z;c.tanTU1X=tanTU1X;c.tanTU1Y=tanTU1Y;c.tanTU1Z=tanTU1Z;c.binTU1X=binTU1X;c.binTU1Y=binTU1Y;c.binTU1Z=binTU1Z;c.norTU2X=norTU2X;c.norTU2Y=norTU2Y;c.norTU2Z=norTU2Z;c.tanTU2X=tanTU2X;c.tanTU2Y=tanTU2Y;c.tanTU2Z=tanTU2Z;c.binTU2X=binTU2X;c.binTU2Y=binTU2Y;c.binTU2Z=binTU2Z;tmp1X=norT1X*ii1[0]+norT1Y*ii1[1]+norT1Z*ii1[2];tmp1Y=norT1X*ii1[3]+norT1Y*ii1[4]+norT1Z*ii1[5];tmp1Z=norT1X*ii1[6]+norT1Y*ii1[7]+norT1Z*ii1[8];tmp2X=tmp1Y*rp1Z-tmp1Z*rp1Y;tmp2Y=tmp1Z*rp1X-tmp1X*rp1Z;tmp2Z=tmp1X*rp1Y-tmp1Y*rp1X;tmp1X=norT2X*ii2[0]+norT2Y*ii2[1]+norT2Z*ii2[2];tmp1Y=norT2X*ii2[3]+norT2Y*ii2[4]+norT2Z*ii2[5];tmp1Z=norT2X*ii2[6]+norT2Y*ii2[7]+norT2Z*ii2[8];tmp2X+=tmp1Y*rp2Z-tmp1Z*rp2Y;tmp2Y+=tmp1Z*rp2X-tmp1X*rp2Z;tmp2Z+=tmp1X*rp2Y-tmp1Y*rp2X;var norDen=1/(m1m2+norX*tmp2X+norY*tmp2Y+norZ*tmp2Z);tmp1X=tanT1X*ii1[0]+tanT1Y*ii1[1]+tanT1Z*ii1[2];tmp1Y=tanT1X*ii1[3]+tanT1Y*ii1[4]+tanT1Z*ii1[5];tmp1Z=tanT1X*ii1[6]+tanT1Y*ii1[7]+tanT1Z*ii1[8];tmp2X=tmp1Y*rp1Z-tmp1Z*rp1Y;tmp2Y=tmp1Z*rp1X-tmp1X*rp1Z;tmp2Z=tmp1X*rp1Y-tmp1Y*rp1X;tmp1X=tanT2X*ii2[0]+tanT2Y*ii2[1]+tanT2Z*ii2[2];tmp1Y=tanT2X*ii2[3]+tanT2Y*ii2[4]+tanT2Z*ii2[5];tmp1Z=tanT2X*ii2[6]+tanT2Y*ii2[7]+tanT2Z*ii2[8];tmp2X+=tmp1Y*rp2Z-tmp1Z*rp2Y;tmp2Y+=tmp1Z*rp2X-tmp1X*rp2Z;tmp2Z+=tmp1X*rp2Y-tmp1Y*rp2X;var tanDen=1/(m1m2+tanX*tmp2X+tanY*tmp2Y+tanZ*tmp2Z);tmp1X=binT1X*ii1[0]+binT1Y*ii1[1]+binT1Z*ii1[2];tmp1Y=binT1X*ii1[3]+binT1Y*ii1[4]+binT1Z*ii1[5];tmp1Z=binT1X*ii1[6]+binT1Y*ii1[7]+binT1Z*ii1[8];tmp2X=tmp1Y*rp1Z-tmp1Z*rp1Y;tmp2Y=tmp1Z*rp1X-tmp1X*rp1Z;tmp2Z=tmp1X*rp1Y-tmp1Y*rp1X;tmp1X=binT2X*ii2[0]+binT2Y*ii2[1]+binT2Z*ii2[2];tmp1Y=binT2X*ii2[3]+binT2Y*ii2[4]+binT2Z*ii2[5];tmp1Z=binT2X*ii2[6]+binT2Y*ii2[7]+binT2Z*ii2[8];tmp2X+=tmp1Y*rp2Z-tmp1Z*rp2Y;tmp2Y+=tmp1Z*rp2X-tmp1X*rp2Z;tmp2Z+=tmp1X*rp2Y-tmp1Y*rp2X;var binDen=1/(m1m2+binX*tmp2X+binY*tmp2Y+binZ*tmp2Z);c.norDen=norDen;c.tanDen=tanDen;c.binDen=binDen;if(p.warmStarted){var norImp=p.normalImpulse;this.lv1.x+=c.norU1X*norImp;this.lv1.y+=c.norU1Y*norImp;this.lv1.z+=c.norU1Z*norImp;this.av1.x+=norTU1X*norImp;this.av1.y+=norTU1Y*norImp;this.av1.z+=norTU1Z*norImp;this.lv2.x-=c.norU2X*norImp;this.lv2.y-=c.norU2Y*norImp;this.lv2.z-=c.norU2Z*norImp;this.av2.x-=norTU2X*norImp;this.av2.y-=norTU2Y*norImp;this.av2.z-=norTU2Z*norImp;c.norImp=norImp;c.tanImp=0;c.binImp=0;rvn=0}else{c.norImp=0;c.tanImp=0;c.binImp=0}if(rvn>-1){rvn=0}var norTar=this.restitution*-rvn;var sepV=-(p.penetration+.005)*invTimeStep*.05;if(norTar<sepV)norTar=sepV;c.norTar=norTar;c.last=i==this.num-1;c=c.next}};OIMO.ContactConstraint.prototype.solve=function(){var lv1x=this.lv1.x;var lv1y=this.lv1.y;var lv1z=this.lv1.z;var lv2x=this.lv2.x;var lv2y=this.lv2.y;var lv2z=this.lv2.z;var av1x=this.av1.x;var av1y=this.av1.y;var av1z=this.av1.z;var av2x=this.av2.x;var av2y=this.av2.y;var av2z=this.av2.z;var c=this.cs;while(true){var oldImp1;var newImp1;var oldImp2;var newImp2;var rvn;var norImp=c.norImp;var tanImp=c.tanImp;var binImp=c.binImp;var max=-norImp*this.friction;var rvX=lv2x-lv1x;var rvY=lv2y-lv1y;var rvZ=lv2z-lv1z;rvn=rvX*c.tanX+rvY*c.tanY+rvZ*c.tanZ+av2x*c.tanT2X+av2y*c.tanT2Y+av2z*c.tanT2Z-av1x*c.tanT1X-av1y*c.tanT1Y-av1z*c.tanT1Z;oldImp1=tanImp;newImp1=rvn*c.tanDen;tanImp+=newImp1;rvn=rvX*c.binX+rvY*c.binY+rvZ*c.binZ+av2x*c.binT2X+av2y*c.binT2Y+av2z*c.binT2Z-av1x*c.binT1X-av1y*c.binT1Y-av1z*c.binT1Z;oldImp2=binImp;newImp2=rvn*c.binDen;binImp+=newImp2;var len=tanImp*tanImp+binImp*binImp;if(len>max*max){len=max/OIMO.sqrt(len);tanImp*=len;binImp*=len}newImp1=tanImp-oldImp1;newImp2=binImp-oldImp2;lv1x+=c.tanU1X*newImp1+c.binU1X*newImp2;lv1y+=c.tanU1Y*newImp1+c.binU1Y*newImp2;lv1z+=c.tanU1Z*newImp1+c.binU1Z*newImp2;av1x+=c.tanTU1X*newImp1+c.binTU1X*newImp2;av1y+=c.tanTU1Y*newImp1+c.binTU1Y*newImp2;av1z+=c.tanTU1Z*newImp1+c.binTU1Z*newImp2;lv2x-=c.tanU2X*newImp1+c.binU2X*newImp2;lv2y-=c.tanU2Y*newImp1+c.binU2Y*newImp2;lv2z-=c.tanU2Z*newImp1+c.binU2Z*newImp2;av2x-=c.tanTU2X*newImp1+c.binTU2X*newImp2;av2y-=c.tanTU2Y*newImp1+c.binTU2Y*newImp2;av2z-=c.tanTU2Z*newImp1+c.binTU2Z*newImp2;rvn=(lv2x-lv1x)*c.norX+(lv2y-lv1y)*c.norY+(lv2z-lv1z)*c.norZ+av2x*c.norT2X+av2y*c.norT2Y+av2z*c.norT2Z-av1x*c.norT1X-av1y*c.norT1Y-av1z*c.norT1Z;oldImp1=norImp;newImp1=(rvn-c.norTar)*c.norDen;norImp+=newImp1;if(norImp>0)norImp=0;newImp1=norImp-oldImp1;lv1x+=c.norU1X*newImp1;lv1y+=c.norU1Y*newImp1;lv1z+=c.norU1Z*newImp1;av1x+=c.norTU1X*newImp1;av1y+=c.norTU1Y*newImp1;av1z+=c.norTU1Z*newImp1;lv2x-=c.norU2X*newImp1;lv2y-=c.norU2Y*newImp1;lv2z-=c.norU2Z*newImp1;av2x-=c.norTU2X*newImp1;av2y-=c.norTU2Y*newImp1;av2z-=c.norTU2Z*newImp1;c.norImp=norImp;c.tanImp=tanImp;c.binImp=binImp;if(c.last)break;c=c.next}this.lv1.x=lv1x;this.lv1.y=lv1y;this.lv1.z=lv1z;this.lv2.x=lv2x;this.lv2.y=lv2y;this.lv2.z=lv2z;this.av1.x=av1x;this.av1.y=av1y;this.av1.z=av1z;this.av2.x=av2x;this.av2.y=av2y;this.av2.z=av2z};OIMO.ContactConstraint.prototype.postSolve=function(){var c=this.cs;var i=this.num;while(i--){var p=this.ps[i];p.normal.x=c.norX;p.normal.y=c.norY;p.normal.z=c.norZ;p.tangent.x=c.tanX;p.tangent.y=c.tanY;p.tangent.z=c.tanZ;p.binormal.x=c.binX;p.binormal.y=c.binY;p.binormal.z=c.binZ;p.normalImpulse=c.norImp;p.tangentImpulse=c.tanImp;p.binormalImpulse=c.binImp;p.normalDenominator=c.norDen;p.tangentDenominator=c.tanDen;p.binormalDenominator=c.binDen;c=c.next}};OIMO.ContactLink=function(contact){this.prev=null;this.next=null;this.shape=null;this.body=null;this.contact=contact};OIMO.ContactManifold=function(){this.body1=null;this.body2=null;this.numPoints=0;this.points=[];this.points.length=4;this.points[0]=new OIMO.ManifoldPoint;this.points[1]=new OIMO.ManifoldPoint;this.points[2]=new OIMO.ManifoldPoint;this.points[3]=new OIMO.ManifoldPoint};OIMO.ContactManifold.prototype={constructor:OIMO.ContactManifold,reset:function(shape1,shape2){this.body1=shape1.parent;this.body2=shape2.parent;this.numPoints=0},addPoint:function(x,y,z,normalX,normalY,normalZ,penetration,flip){var p=this.points[this.numPoints++];p.position.x=x;p.position.y=y;p.position.z=z;var r=this.body1.rotation;var rx=x-this.body1.position.x;var ry=y-this.body1.position.y;var rz=z-this.body1.position.z;var tr=r.elements;p.localPoint1.x=rx*tr[0]+ry*tr[3]+rz*tr[6];p.localPoint1.y=rx*tr[1]+ry*tr[4]+rz*tr[7];p.localPoint1.z=rx*tr[2]+ry*tr[5]+rz*tr[8];r=this.body2.rotation;rx=x-this.body2.position.x;ry=y-this.body2.position.y;rz=z-this.body2.position.z;p.localPoint2.x=rx*tr[0]+ry*tr[3]+rz*tr[6];p.localPoint2.y=rx*tr[1]+ry*tr[4]+rz*tr[7];p.localPoint2.z=rx*tr[2]+ry*tr[5]+rz*tr[8];p.normalImpulse=0;if(flip){p.normal.x=-normalX;p.normal.y=-normalY;p.normal.z=-normalZ}else{p.normal.x=normalX;p.normal.y=normalY;p.normal.z=normalZ}p.penetration=penetration;p.warmStarted=false}};OIMO.ContactPointDataBuffer=function(){this.norX=NaN;this.norY=NaN;this.norZ=NaN;this.tanX=NaN;this.tanY=NaN;this.tanZ=NaN;this.binX=NaN;this.binY=NaN;this.binZ=NaN;this.rp1X=NaN;this.rp1Y=NaN;this.rp1Z=NaN;this.rp2X=NaN;this.rp2Y=NaN;this.rp2Z=NaN;this.norU1X=NaN;this.norU1Y=NaN;this.norU1Z=NaN;this.norU2X=NaN;this.norU2Y=NaN;this.norU2Z=NaN;this.tanU1X=NaN;this.tanU1Y=NaN;this.tanU1Z=NaN;this.tanU2X=NaN;this.tanU2Y=NaN;this.tanU2Z=NaN;this.binU1X=NaN;this.binU1Y=NaN;this.binU1Z=NaN;this.binU2X=NaN;this.binU2Y=NaN;this.binU2Z=NaN;this.norT1X=NaN;this.norT1Y=NaN;this.norT1Z=NaN;this.norT2X=NaN;this.norT2Y=NaN;this.norT2Z=NaN;this.tanT1X=NaN;this.tanT1Y=NaN;this.tanT1Z=NaN;this.tanT2X=NaN;this.tanT2Y=NaN;this.tanT2Z=NaN;this.binT1X=NaN;this.binT1Y=NaN;this.binT1Z=NaN;this.binT2X=NaN;this.binT2Y=NaN;this.binT2Z=NaN;this.norTU1X=NaN;this.norTU1Y=NaN;this.norTU1Z=NaN;this.norTU2X=NaN;this.norTU2Y=NaN;this.norTU2Z=NaN;this.tanTU1X=NaN;this.tanTU1Y=NaN;this.tanTU1Z=NaN;this.tanTU2X=NaN;this.tanTU2Y=NaN;this.tanTU2Z=NaN;this.binTU1X=NaN;this.binTU1Y=NaN;this.binTU1Z=NaN;this.binTU2X=NaN;this.binTU2Y=NaN;this.binTU2Z=NaN;this.norImp=NaN;this.tanImp=NaN;this.binImp=NaN;this.norDen=NaN;this.tanDen=NaN;this.binDen=NaN;this.norTar=NaN;this.next=null;this.last=false};OIMO.ImpulseDataBuffer=function(){this.lp1X=NaN;this.lp1Y=NaN;this.lp1Z=NaN;this.lp2X=NaN;this.lp2Y=NaN;this.lp2Z=NaN;this.impulse=NaN};OIMO.ManifoldPoint=function(){this.warmStarted=false;this.position=new OIMO.Vec3;this.localPoint1=new OIMO.Vec3;this.localPoint2=new OIMO.Vec3;this.normal=new OIMO.Vec3;this.tangent=new OIMO.Vec3;this.binormal=new OIMO.Vec3;this.normalImpulse=0;this.tangentImpulse=0;this.binormalImpulse=0;this.normalDenominator=0;this.tangentDenominator=0;this.binormalDenominator=0;this.penetration=0};OIMO.MassInfo=function(){this.mass=0;this.inertia=new OIMO.Mat33};OIMO.Shape=function(config){this.type=OIMO.SHAPE_NULL;this.id=OIMO.nextID++;this.prev=null;this.next=null;this.proxy=null;this.parent=null;this.contactLink=null;this.numContacts=0;this.position=new OIMO.Vec3;this.rotation=new OIMO.Mat33;this.relativePosition=(new OIMO.Vec3).copy(config.relativePosition);this.relativeRotation=(new OIMO.Mat33).copy(config.relativeRotation);this.aabb=new OIMO.AABB;this.density=config.density;this.friction=config.friction;this.restitution=config.restitution;this.belongsTo=config.belongsTo;this.collidesWith=config.collidesWith};OIMO.Shape.prototype={constructor:OIMO.Shape,calculateMassInfo:function(out){OIMO.Error("Shape","Inheritance error.")},updateProxy:function(){OIMO.Error("Shape","Inheritance error.")}};OIMO.ShapeConfig=function(){this.relativePosition=new OIMO.Vec3;this.relativeRotation=new OIMO.Mat33;this.friction=.4;this.restitution=.2;this.density=1;this.belongsTo=1;this.collidesWith=4294967295};OIMO.BoxShape=function(config,Width,Height,Depth){OIMO.Shape.call(this,config);this.type=OIMO.SHAPE_BOX;this.width=Width;this.height=Height;this.depth=Depth;this.halfWidth=Width*.5;this.halfHeight=Height*.5;this.halfDepth=Depth*.5;this.dimentions=new OIMO_ARRAY_TYPE(18);this.elements=new OIMO_ARRAY_TYPE(24)};OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.BoxShape.prototype.constructor=OIMO.BoxShape;OIMO.BoxShape.prototype.calculateMassInfo=function(out){var mass=this.width*this.height*this.depth*this.density;var divid=1/12;out.mass=mass;out.inertia.set(mass*(this.height*this.height+this.depth*this.depth)*divid,0,0,0,mass*(this.width*this.width+this.depth*this.depth)*divid,0,0,0,mass*(this.width*this.width+this.height*this.height)*divid)};OIMO.BoxShape.prototype.updateProxy=function(){var te=this.rotation.elements;var di=this.dimentions;di[0]=te[0];di[1]=te[3];di[2]=te[6];di[3]=te[1];di[4]=te[4];di[5]=te[7];di[6]=te[2];di[7]=te[5];di[8]=te[8];di[9]=te[0]*this.halfWidth;di[10]=te[3]*this.halfWidth;di[11]=te[6]*this.halfWidth;di[12]=te[1]*this.halfHeight;di[13]=te[4]*this.halfHeight;di[14]=te[7]*this.halfHeight;di[15]=te[2]*this.halfDepth;di[16]=te[5]*this.halfDepth;di[17]=te[8]*this.halfDepth;var wx=di[9];var wy=di[10];var wz=di[11];var hx=di[12];var hy=di[13];var hz=di[14];var dx=di[15];var dy=di[16];var dz=di[17];var x=this.position.x;var y=this.position.y;var z=this.position.z;var v=this.elements;v[0]=x+wx+hx+dx;v[1]=y+wy+hy+dy;v[2]=z+wz+hz+dz;v[3]=x+wx+hx-dx;v[4]=y+wy+hy-dy;v[5]=z+wz+hz-dz;v[6]=x+wx-hx+dx;v[7]=y+wy-hy+dy;v[8]=z+wz-hz+dz;v[9]=x+wx-hx-dx;v[10]=y+wy-hy-dy;v[11]=z+wz-hz-dz;v[12]=x-wx+hx+dx;v[13]=y-wy+hy+dy;v[14]=z-wz+hz+dz;v[15]=x-wx+hx-dx;v[16]=y-wy+hy-dy;v[17]=z-wz+hz-dz;v[18]=x-wx-hx+dx;v[19]=y-wy-hy+dy;v[20]=z-wz-hz+dz;v[21]=x-wx-hx-dx;v[22]=y-wy-hy-dy;v[23]=z-wz-hz-dz;var w=di[9]<0?-di[9]:di[9];var h=di[10]<0?-di[10]:di[10];var d=di[11]<0?-di[11]:di[11];w=di[12]<0?w-di[12]:w+di[12];h=di[13]<0?h-di[13]:h+di[13];d=di[14]<0?d-di[14]:d+di[14];w=di[15]<0?w-di[15]:w+di[15];h=di[16]<0?h-di[16]:h+di[16];d=di[17]<0?d-di[17]:d+di[17];var p=OIMO.AABB_PROX;this.aabb.set(this.position.x-w-p,this.position.x+w+p,this.position.y-h-p,this.position.y+h+p,this.position.z-d-p,this.position.z+d+p);if(this.proxy!=null)this.proxy.update()};OIMO.SphereShape=function(config,radius){OIMO.Shape.call(this,config);this.type=OIMO.SHAPE_SPHERE;this.radius=radius};OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.SphereShape.prototype.constructor=OIMO.SphereShape;OIMO.SphereShape.prototype.calculateMassInfo=function(out){var mass=1.333*OIMO.PI*this.radius*this.radius*this.radius*this.density;out.mass=mass;var inertia=mass*this.radius*this.radius*.4;out.inertia.set(inertia,0,0,0,inertia,0,0,0,inertia)};OIMO.SphereShape.prototype.updateProxy=function(){var p=OIMO.AABB_PROX;this.aabb.set(this.position.x-this.radius-p,this.position.x+this.radius+p,this.position.y-this.radius-p,this.position.y+this.radius+p,this.position.z-this.radius-p,this.position.z+this.radius+p);if(this.proxy!=null)this.proxy.update()};OIMO.CylinderShape=function(config,radius,height){OIMO.Shape.call(this,config);this.type=OIMO.SHAPE_CYLINDER;this.radius=radius;this.height=height;this.halfHeight=height*.5;this.normalDirection=new OIMO.Vec3;this.halfDirection=new OIMO.Vec3};OIMO.CylinderShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.CylinderShape.prototype.constructor=OIMO.CylinderShape;OIMO.CylinderShape.prototype.calculateMassInfo=function(out){var rsq=this.radius*this.radius;var mass=OIMO.PI*rsq*this.height*this.density;var inertiaXZ=(.25*rsq+.0833*this.height*this.height)*mass;var inertiaY=.5*rsq;out.mass=mass;out.inertia.set(inertiaXZ,0,0,0,inertiaY,0,0,0,inertiaXZ)};OIMO.CylinderShape.prototype.updateProxy=function(){var te=this.rotation.elements;var len,wx,hy,dz,xx,yy,zz,w,h,d,p;xx=te[1]*te[1];yy=te[4]*te[4];zz=te[7]*te[7];this.normalDirection.set(te[1],te[4],te[7]);this.halfDirection.scale(this.normalDirection,this.halfHeight);wx=1-xx;len=OIMO.sqrt(wx*wx+xx*yy+xx*zz);if(len>0)len=this.radius/len;wx*=len;hy=1-yy;len=OIMO.sqrt(yy*xx+hy*hy+yy*zz);if(len>0)len=this.radius/len;hy*=len;dz=1-zz;len=OIMO.sqrt(zz*xx+zz*yy+dz*dz);if(len>0)len=this.radius/len;dz*=len;w=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x;h=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y;d=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z;w=wx<0?w-wx:w+wx;h=hy<0?h-hy:h+hy;d=dz<0?d-dz:d+dz;p=OIMO.AABB_PROX;this.aabb.set(this.position.x-w-p,this.position.x+w+p,this.position.y-h-p,this.position.y+h+p,this.position.z-d-p,this.position.z+d+p);if(this.proxy!=null)this.proxy.update()};OIMO.TetraShape=function(config,p1,p2,p3,p4){OIMO.Shape.call(this,config);this.type=OIMO.SHAPE_TETRA;this.verts=[p1,p2,p3,p4];this.faces=[mtri(0,1,2),mtri(1,2,3),mtri(2,3,4),mtri(4,0,1)]};OIMO.TetraShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.TetraShape.prototype.constructor=OIMO.TetraShape;OIMO.TetraShape.prototype.calculateMassInfo=function(){};OIMO.TetraShape.prototype.updateProxy=function(){this.aabb.setFromPoints(this.verts);if(this.proxy!==null)this.proxy.update()};function mtri(a,b,c){return{a:a,b:b,c:c}}OIMO.CollisionDetector=function(){this.flip=false};OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(shape1,shape2,manifold){OIMO.Error("CollisionDetector","Inheritance error.")}};OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this);this.clipVertices1=new OIMO_ARRAY_TYPE(24);this.clipVertices2=new OIMO_ARRAY_TYPE(24);this.used=new OIMO_ARRAY_TYPE(8);this.INF=1/0};OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.BoxBoxCollisionDetector.prototype.constructor=OIMO.BoxBoxCollisionDetector;OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(shape1,shape2,manifold){var b1;var b2;if(shape1.id<shape2.id){b1=shape1;b2=shape2}else{b1=shape2;b2=shape1}var V1=b1.elements;var V2=b2.elements;var D1=b1.dimentions;var D2=b2.dimentions;var p1=b1.position;var p2=b2.position;var p1x=p1.x;var p1y=p1.y;var p1z=p1.z;var p2x=p2.x;var p2y=p2.y;var p2z=p2.z;var dx=p2x-p1x;var dy=p2y-p1y;var dz=p2z-p1z;var w1=b1.halfWidth;var h1=b1.halfHeight;var d1=b1.halfDepth;var w2=b2.halfWidth;var h2=b2.halfHeight;var d2=b2.halfDepth;var a1x=D1[0];var a1y=D1[1];var a1z=D1[2];var a2x=D1[3];var a2y=D1[4];var a2z=D1[5];var a3x=D1[6];var a3y=D1[7];var a3z=D1[8];var d1x=D1[9];var d1y=D1[10];var d1z=D1[11];var d2x=D1[12];var d2y=D1[13];var d2z=D1[14];var d3x=D1[15];var d3y=D1[16];var d3z=D1[17];var a4x=D2[0];var a4y=D2[1];var a4z=D2[2];var a5x=D2[3];var a5y=D2[4];var a5z=D2[5];var a6x=D2[6];var a6y=D2[7];var a6z=D2[8];var d4x=D2[9];var d4y=D2[10];var d4z=D2[11];var d5x=D2[12];var d5y=D2[13];var d5z=D2[14];var d6x=D2[15];var d6y=D2[16];var d6z=D2[17];var a7x=a1y*a4z-a1z*a4y;var a7y=a1z*a4x-a1x*a4z;var a7z=a1x*a4y-a1y*a4x;var a8x=a1y*a5z-a1z*a5y;var a8y=a1z*a5x-a1x*a5z;var a8z=a1x*a5y-a1y*a5x;var a9x=a1y*a6z-a1z*a6y;var a9y=a1z*a6x-a1x*a6z;var a9z=a1x*a6y-a1y*a6x;var aax=a2y*a4z-a2z*a4y;var aay=a2z*a4x-a2x*a4z;var aaz=a2x*a4y-a2y*a4x;var abx=a2y*a5z-a2z*a5y;var aby=a2z*a5x-a2x*a5z;var abz=a2x*a5y-a2y*a5x;var acx=a2y*a6z-a2z*a6y;var acy=a2z*a6x-a2x*a6z;var acz=a2x*a6y-a2y*a6x;var adx=a3y*a4z-a3z*a4y;var ady=a3z*a4x-a3x*a4z;var adz=a3x*a4y-a3y*a4x;var aex=a3y*a5z-a3z*a5y;var aey=a3z*a5x-a3x*a5z;var aez=a3x*a5y-a3y*a5x;var afx=a3y*a6z-a3z*a6y;var afy=a3z*a6x-a3x*a6z;var afz=a3x*a6y-a3y*a6x;var right1;var right2;var right3;var right4;var right5;var right6;var right7;var right8;var right9;var righta;var rightb;var rightc;var rightd;var righte;var rightf;var overlap1;var overlap2;var overlap3;var overlap4;var overlap5;var overlap6;var overlap7;var overlap8;var overlap9;var overlapa;var overlapb;var overlapc;var overlapd;var overlape;var overlapf;var invalid7=false;var invalid8=false;var invalid9=false;var invalida=false;var invalidb=false;var invalidc=false;var invalidd=false;var invalide=false;var invalidf=false;var len;var len1;var len2;var dot1;var dot2;var dot3;len=a1x*dx+a1y*dy+a1z*dz;right1=len>0;if(!right1)len=-len;len1=w1;dot1=a1x*a4x+a1y*a4y+a1z*a4z;dot2=a1x*a5x+a1y*a5y+a1z*a5z;dot3=a1x*a6x+a1y*a6y+a1z*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;if(dot3<0)dot3=-dot3;len2=dot1*w2+dot2*h2+dot3*d2;overlap1=len-len1-len2;if(overlap1>0)return;len=a2x*dx+a2y*dy+a2z*dz;right2=len>0;if(!right2)len=-len;len1=h1;dot1=a2x*a4x+a2y*a4y+a2z*a4z;dot2=a2x*a5x+a2y*a5y+a2z*a5z;dot3=a2x*a6x+a2y*a6y+a2z*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;if(dot3<0)dot3=-dot3;len2=dot1*w2+dot2*h2+dot3*d2;overlap2=len-len1-len2;if(overlap2>0)return;len=a3x*dx+a3y*dy+a3z*dz;right3=len>0;if(!right3)len=-len;len1=d1;dot1=a3x*a4x+a3y*a4y+a3z*a4z;dot2=a3x*a5x+a3y*a5y+a3z*a5z;dot3=a3x*a6x+a3y*a6y+a3z*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;if(dot3<0)dot3=-dot3;len2=dot1*w2+dot2*h2+dot3*d2;overlap3=len-len1-len2;if(overlap3>0)return;len=a4x*dx+a4y*dy+a4z*dz;right4=len>0;if(!right4)len=-len;dot1=a4x*a1x+a4y*a1y+a4z*a1z;dot2=a4x*a2x+a4y*a2y+a4z*a2z;dot3=a4x*a3x+a4y*a3y+a4z*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;if(dot3<0)dot3=-dot3;len1=dot1*w1+dot2*h1+dot3*d1;len2=w2;overlap4=(len-len1-len2)*1;if(overlap4>0)return;len=a5x*dx+a5y*dy+a5z*dz;right5=len>0;if(!right5)len=-len;dot1=a5x*a1x+a5y*a1y+a5z*a1z;dot2=a5x*a2x+a5y*a2y+a5z*a2z;dot3=a5x*a3x+a5y*a3y+a5z*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;if(dot3<0)dot3=-dot3;len1=dot1*w1+dot2*h1+dot3*d1;len2=h2;overlap5=(len-len1-len2)*1;if(overlap5>0)return;len=a6x*dx+a6y*dy+a6z*dz;right6=len>0;if(!right6)len=-len;dot1=a6x*a1x+a6y*a1y+a6z*a1z;dot2=a6x*a2x+a6y*a2y+a6z*a2z;dot3=a6x*a3x+a6y*a3y+a6z*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;if(dot3<0)dot3=-dot3;len1=dot1*w1+dot2*h1+dot3*d1;len2=d2;overlap6=(len-len1-len2)*1;if(overlap6>0)return;len=a7x*a7x+a7y*a7y+a7z*a7z;if(len>1e-5){len=1/OIMO.sqrt(len);a7x*=len;a7y*=len;a7z*=len;len=a7x*dx+a7y*dy+a7z*dz;right7=len>0;if(!right7)len=-len;dot1=a7x*a2x+a7y*a2y+a7z*a2z;dot2=a7x*a3x+a7y*a3y+a7z*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*h1+dot2*d1;dot1=a7x*a5x+a7y*a5y+a7z*a5z;dot2=a7x*a6x+a7y*a6y+a7z*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*h2+dot2*d2;overlap7=len-len1-len2;if(overlap7>0)return}else{right7=false;overlap7=0;invalid7=true}len=a8x*a8x+a8y*a8y+a8z*a8z;if(len>1e-5){len=1/OIMO.sqrt(len);a8x*=len;a8y*=len;a8z*=len;len=a8x*dx+a8y*dy+a8z*dz;right8=len>0;if(!right8)len=-len;dot1=a8x*a2x+a8y*a2y+a8z*a2z;dot2=a8x*a3x+a8y*a3y+a8z*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*h1+dot2*d1;dot1=a8x*a4x+a8y*a4y+a8z*a4z;dot2=a8x*a6x+a8y*a6y+a8z*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*w2+dot2*d2;overlap8=len-len1-len2;if(overlap8>0)return}else{right8=false;overlap8=0;invalid8=true}len=a9x*a9x+a9y*a9y+a9z*a9z;if(len>1e-5){len=1/OIMO.sqrt(len);a9x*=len;a9y*=len;a9z*=len;len=a9x*dx+a9y*dy+a9z*dz;right9=len>0;if(!right9)len=-len;dot1=a9x*a2x+a9y*a2y+a9z*a2z;dot2=a9x*a3x+a9y*a3y+a9z*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*h1+dot2*d1;dot1=a9x*a4x+a9y*a4y+a9z*a4z;dot2=a9x*a5x+a9y*a5y+a9z*a5z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*w2+dot2*h2;overlap9=len-len1-len2;if(overlap9>0)return}else{right9=false;overlap9=0;invalid9=true}len=aax*aax+aay*aay+aaz*aaz;if(len>1e-5){len=1/OIMO.sqrt(len);aax*=len;aay*=len;aaz*=len;len=aax*dx+aay*dy+aaz*dz;righta=len>0;if(!righta)len=-len;dot1=aax*a1x+aay*a1y+aaz*a1z;dot2=aax*a3x+aay*a3y+aaz*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*w1+dot2*d1;dot1=aax*a5x+aay*a5y+aaz*a5z;dot2=aax*a6x+aay*a6y+aaz*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*h2+dot2*d2;overlapa=len-len1-len2;if(overlapa>0)return}else{righta=false;overlapa=0;invalida=true}len=abx*abx+aby*aby+abz*abz;if(len>1e-5){len=1/OIMO.sqrt(len);abx*=len;aby*=len;abz*=len;len=abx*dx+aby*dy+abz*dz;rightb=len>0;if(!rightb)len=-len;dot1=abx*a1x+aby*a1y+abz*a1z;dot2=abx*a3x+aby*a3y+abz*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*w1+dot2*d1;dot1=abx*a4x+aby*a4y+abz*a4z;dot2=abx*a6x+aby*a6y+abz*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*w2+dot2*d2;overlapb=len-len1-len2;if(overlapb>0)return}else{rightb=false;overlapb=0;invalidb=true}len=acx*acx+acy*acy+acz*acz;if(len>1e-5){len=1/OIMO.sqrt(len);acx*=len;acy*=len;acz*=len;len=acx*dx+acy*dy+acz*dz;rightc=len>0;if(!rightc)len=-len;dot1=acx*a1x+acy*a1y+acz*a1z;dot2=acx*a3x+acy*a3y+acz*a3z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*w1+dot2*d1;dot1=acx*a4x+acy*a4y+acz*a4z;dot2=acx*a5x+acy*a5y+acz*a5z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*w2+dot2*h2;overlapc=len-len1-len2;if(overlapc>0)return}else{rightc=false;overlapc=0;invalidc=true}len=adx*adx+ady*ady+adz*adz;if(len>1e-5){len=1/OIMO.sqrt(len);adx*=len;ady*=len;adz*=len;len=adx*dx+ady*dy+adz*dz;rightd=len>0;if(!rightd)len=-len;dot1=adx*a1x+ady*a1y+adz*a1z;dot2=adx*a2x+ady*a2y+adz*a2z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*w1+dot2*h1;dot1=adx*a5x+ady*a5y+adz*a5z;dot2=adx*a6x+ady*a6y+adz*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*h2+dot2*d2;overlapd=len-len1-len2;if(overlapd>0)return}else{rightd=false;overlapd=0;invalidd=true}len=aex*aex+aey*aey+aez*aez;if(len>1e-5){len=1/OIMO.sqrt(len);aex*=len;aey*=len;aez*=len;len=aex*dx+aey*dy+aez*dz;righte=len>0;if(!righte)len=-len;dot1=aex*a1x+aey*a1y+aez*a1z;dot2=aex*a2x+aey*a2y+aez*a2z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*w1+dot2*h1;dot1=aex*a4x+aey*a4y+aez*a4z;dot2=aex*a6x+aey*a6y+aez*a6z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*w2+dot2*d2;overlape=len-len1-len2;if(overlape>0)return}else{righte=false;overlape=0;invalide=true}len=afx*afx+afy*afy+afz*afz;if(len>1e-5){len=1/OIMO.sqrt(len);afx*=len;afy*=len;afz*=len;len=afx*dx+afy*dy+afz*dz;rightf=len>0;if(!rightf)len=-len;dot1=afx*a1x+afy*a1y+afz*a1z;dot2=afx*a2x+afy*a2y+afz*a2z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len1=dot1*w1+dot2*h1;dot1=afx*a4x+afy*a4y+afz*a4z;dot2=afx*a5x+afy*a5y+afz*a5z;if(dot1<0)dot1=-dot1;if(dot2<0)dot2=-dot2;len2=dot1*w2+dot2*h2;overlapf=len-len1-len2;if(overlapf>0)return}else{rightf=false;overlapf=0;invalidf=true}var depth=overlap1;var depth2=overlap1;var minIndex=0;var right=right1;if(overlap2>depth2){depth=overlap2;depth2=overlap2;minIndex=1;right=right2}if(overlap3>depth2){depth=overlap3;depth2=overlap3;minIndex=2;right=right3}if(overlap4>depth2){depth=overlap4;depth2=overlap4;minIndex=3;right=right4}if(overlap5>depth2){depth=overlap5;depth2=overlap5;minIndex=4;right=right5}if(overlap6>depth2){depth=overlap6;depth2=overlap6;minIndex=5;right=right6}if(overlap7-.01>depth2&&!invalid7){depth=overlap7;depth2=overlap7-.01;minIndex=6;right=right7}if(overlap8-.01>depth2&&!invalid8){depth=overlap8;depth2=overlap8-.01;minIndex=7;right=right8}if(overlap9-.01>depth2&&!invalid9){depth=overlap9;depth2=overlap9-.01;minIndex=8;right=right9}if(overlapa-.01>depth2&&!invalida){depth=overlapa;depth2=overlapa-.01;minIndex=9;right=righta}if(overlapb-.01>depth2&&!invalidb){depth=overlapb;depth2=overlapb-.01;minIndex=10;right=rightb}if(overlapc-.01>depth2&&!invalidc){depth=overlapc;depth2=overlapc-.01;minIndex=11;right=rightc}if(overlapd-.01>depth2&&!invalidd){depth=overlapd;depth2=overlapd-.01;minIndex=12;right=rightd}if(overlape-.01>depth2&&!invalide){depth=overlape;depth2=overlape-.01;minIndex=13;right=righte}if(overlapf-.01>depth2&&!invalidf){depth=overlapf;minIndex=14;right=rightf}var nx=0;var ny=0;var nz=0;var n1x=0;var n1y=0;var n1z=0;var n2x=0;var n2y=0;var n2z=0;var cx=0;var cy=0;var cz=0;var s1x=0;var s1y=0;var s1z=0;var s2x=0;var s2y=0;var s2z=0;var swap=false;if(minIndex==0){if(right){cx=p1x+d1x;cy=p1y+d1y;cz=p1z+d1z;nx=a1x;ny=a1y;nz=a1z}else{cx=p1x-d1x;cy=p1y-d1y;cz=p1z-d1z;nx=-a1x;ny=-a1y;nz=-a1z}s1x=d2x;s1y=d2y;s1z=d2z;n1x=-a2x;n1y=-a2y;n1z=-a2z;s2x=d3x;s2y=d3y;s2z=d3z;n2x=-a3x;n2y=-a3y;n2z=-a3z}else if(minIndex==1){if(right){cx=p1x+d2x;cy=p1y+d2y;cz=p1z+d2z;nx=a2x;ny=a2y;nz=a2z}else{cx=p1x-d2x;cy=p1y-d2y;cz=p1z-d2z;nx=-a2x;ny=-a2y;nz=-a2z}s1x=d1x;s1y=d1y;s1z=d1z;n1x=-a1x;n1y=-a1y;n1z=-a1z;s2x=d3x;s2y=d3y;s2z=d3z;n2x=-a3x;n2y=-a3y;n2z=-a3z}else if(minIndex==2){if(right){cx=p1x+d3x;cy=p1y+d3y;cz=p1z+d3z;nx=a3x;ny=a3y;nz=a3z}else{cx=p1x-d3x;cy=p1y-d3y;cz=p1z-d3z;nx=-a3x;ny=-a3y;nz=-a3z}s1x=d1x;s1y=d1y;s1z=d1z;n1x=-a1x;n1y=-a1y;n1z=-a1z;s2x=d2x;s2y=d2y;s2z=d2z;n2x=-a2x;n2y=-a2y;n2z=-a2z}else if(minIndex==3){swap=true;if(!right){cx=p2x+d4x;cy=p2y+d4y;cz=p2z+d4z;nx=a4x;ny=a4y;nz=a4z}else{cx=p2x-d4x;cy=p2y-d4y;cz=p2z-d4z;nx=-a4x;ny=-a4y;nz=-a4z}s1x=d5x;s1y=d5y;s1z=d5z;n1x=-a5x;n1y=-a5y;n1z=-a5z;s2x=d6x;s2y=d6y;s2z=d6z;n2x=-a6x;n2y=-a6y;n2z=-a6z}else if(minIndex==4){swap=true;if(!right){cx=p2x+d5x;cy=p2y+d5y;cz=p2z+d5z;nx=a5x;ny=a5y;nz=a5z}else{cx=p2x-d5x;cy=p2y-d5y;cz=p2z-d5z;nx=-a5x;ny=-a5y;nz=-a5z}s1x=d4x;s1y=d4y;s1z=d4z;n1x=-a4x;n1y=-a4y;n1z=-a4z;s2x=d6x;s2y=d6y;s2z=d6z;n2x=-a6x;n2y=-a6y;n2z=-a6z}else if(minIndex==5){swap=true;if(!right){cx=p2x+d6x;cy=p2y+d6y;cz=p2z+d6z;nx=a6x;ny=a6y;nz=a6z}else{cx=p2x-d6x;cy=p2y-d6y;cz=p2z-d6z;nx=-a6x;ny=-a6y;nz=-a6z}s1x=d4x;s1y=d4y;s1z=d4z;n1x=-a4x;n1y=-a4y;n1z=-a4z;s2x=d5x;s2y=d5y;s2z=d5z;n2x=-a5x;n2y=-a5y;n2z=-a5z}else if(minIndex==6){nx=a7x;ny=a7y;nz=a7z;n1x=a1x;n1y=a1y;n1z=a1z;n2x=a4x;n2y=a4y;n2z=a4z}else if(minIndex==7){nx=a8x;ny=a8y;nz=a8z;n1x=a1x;n1y=a1y;n1z=a1z;n2x=a5x;n2y=a5y;n2z=a5z}else if(minIndex==8){nx=a9x;ny=a9y;nz=a9z;n1x=a1x;n1y=a1y;n1z=a1z;n2x=a6x;n2y=a6y;n2z=a6z}else if(minIndex==9){nx=aax;ny=aay;nz=aaz;n1x=a2x;n1y=a2y;n1z=a2z;n2x=a4x;n2y=a4y;n2z=a4z}else if(minIndex==10){nx=abx;ny=aby;nz=abz;n1x=a2x;n1y=a2y;n1z=a2z;n2x=a5x;n2y=a5y;n2z=a5z}else if(minIndex==11){nx=acx;ny=acy;nz=acz;n1x=a2x;n1y=a2y;n1z=a2z;n2x=a6x;n2y=a6y;n2z=a6z}else if(minIndex==12){nx=adx;ny=ady;nz=adz;n1x=a3x;n1y=a3y;n1z=a3z;n2x=a4x;n2y=a4y;n2z=a4z}else if(minIndex==13){nx=aex;ny=aey;nz=aez;n1x=a3x;n1y=a3y;n1z=a3z;n2x=a5x;n2y=a5y;n2z=a5z}else if(minIndex==14){nx=afx;ny=afy;nz=afz;n1x=a3x;n1y=a3y;n1z=a3z;n2x=a6x;n2y=a6y;n2z=a6z}var v;if(minIndex>5){if(!right){nx=-nx;ny=-ny;nz=-nz}var distance;var maxDistance;var vx;var vy;var vz;var v1x;var v1y;var v1z;var v2x;var v2y;var v2z;v1x=V1[0];v1y=V1[1];v1z=V1[2];maxDistance=nx*v1x+ny*v1y+nz*v1z;vx=V1[3];vy=V1[4];vz=V1[5];distance=nx*vx+ny*vy+nz*vz;if(distance>maxDistance){maxDistance=distance;v1x=vx;v1y=vy;v1z=vz}vx=V1[6];vy=V1[7];vz=V1[8];distance=nx*vx+ny*vy+nz*vz;if(distance>maxDistance){maxDistance=distance;v1x=vx;v1y=vy;v1z=vz}vx=V1[9];vy=V1[10];vz=V1[11];distance=nx*vx+ny*vy+nz*vz;if(distance>maxDistance){maxDistance=distance;v1x=vx;v1y=vy;v1z=vz}vx=V1[12];vy=V1[13];vz=V1[14];distance=nx*vx+ny*vy+nz*vz;if(distance>maxDistance){maxDistance=distance;v1x=vx;v1y=vy;v1z=vz}vx=V1[15];vy=V1[16];vz=V1[17];distance=nx*vx+ny*vy+nz*vz;if(distance>maxDistance){maxDistance=distance;v1x=vx;v1y=vy;v1z=vz}vx=V1[18];vy=V1[19];vz=V1[20];distance=nx*vx+ny*vy+nz*vz;if(distance>maxDistance){maxDistance=distance;v1x=vx;v1y=vy;v1z=vz}vx=V1[21];vy=V1[22];vz=V1[23];distance=nx*vx+ny*vy+nz*vz;if(distance>maxDistance){maxDistance=distance;v1x=vx;v1y=vy;v1z=vz}v2x=V2[0];v2y=V2[1];v2z=V2[2];maxDistance=nx*v2x+ny*v2y+nz*v2z;vx=V2[3];vy=V2[4];vz=V2[5];distance=nx*vx+ny*vy+nz*vz;if(distance<maxDistance){maxDistance=distance;v2x=vx;v2y=vy;v2z=vz}vx=V2[6];vy=V2[7];vz=V2[8];distance=nx*vx+ny*vy+nz*vz;if(distance<maxDistance){maxDistance=distance;v2x=vx;v2y=vy;v2z=vz}vx=V2[9];vy=V2[10];vz=V2[11];distance=nx*vx+ny*vy+nz*vz;if(distance<maxDistance){maxDistance=distance;v2x=vx;v2y=vy;v2z=vz}vx=V2[12];vy=V2[13];vz=V2[14];distance=nx*vx+ny*vy+nz*vz;if(distance<maxDistance){maxDistance=distance;v2x=vx;v2y=vy;v2z=vz}vx=V2[15];vy=V2[16];vz=V2[17];distance=nx*vx+ny*vy+nz*vz;if(distance<maxDistance){maxDistance=distance;v2x=vx;v2y=vy;v2z=vz}vx=V2[18];vy=V2[19];vz=V2[20];distance=nx*vx+ny*vy+nz*vz;if(distance<maxDistance){maxDistance=distance;v2x=vx;v2y=vy;v2z=vz}vx=V2[21];vy=V2[22];vz=V2[23];distance=nx*vx+ny*vy+nz*vz;if(distance<maxDistance){maxDistance=distance;v2x=vx;v2y=vy;v2z=vz}vx=v2x-v1x;vy=v2y-v1y;vz=v2z-v1z;dot1=n1x*n2x+n1y*n2y+n1z*n2z;var t=(vx*(n1x-n2x*dot1)+vy*(n1y-n2y*dot1)+vz*(n1z-n2z*dot1))/(1-dot1*dot1);manifold.addPoint(v1x+n1x*t+nx*depth*.5,v1y+n1y*t+ny*depth*.5,v1z+n1z*t+nz*depth*.5,nx,ny,nz,depth,false);return}var q1x;var q1y;var q1z;var q2x;var q2y;var q2z;var q3x;var q3y;var q3z;var q4x;var q4y;var q4z;var minDot=1;var dot=0;var minDotIndex=0;if(swap){dot=a1x*nx+a1y*ny+a1z*nz;if(dot<minDot){minDot=dot;minDotIndex=0}if(-dot<minDot){minDot=-dot;minDotIndex=1}dot=a2x*nx+a2y*ny+a2z*nz;if(dot<minDot){minDot=dot;minDotIndex=2}if(-dot<minDot){minDot=-dot;minDotIndex=3}dot=a3x*nx+a3y*ny+a3z*nz;if(dot<minDot){minDot=dot;minDotIndex=4}if(-dot<minDot){minDot=-dot;minDotIndex=5}if(minDotIndex==0){q1x=V1[0];q1y=V1[1];q1z=V1[2];q2x=V1[6];q2y=V1[7];q2z=V1[8];q3x=V1[9];q3y=V1[10];q3z=V1[11];q4x=V1[3];q4y=V1[4];q4z=V1[5]}else if(minDotIndex==1){q1x=V1[15];q1y=V1[16];q1z=V1[17];q2x=V1[21];q2y=V1[22];q2z=V1[23];q3x=V1[18];q3y=V1[19];q3z=V1[20];q4x=V1[12];q4y=V1[13];q4z=V1[14]}else if(minDotIndex==2){q1x=V1[12];q1y=V1[13];q1z=V1[14];q2x=V1[0];q2y=V1[1];q2z=V1[2];q3x=V1[3];q3y=V1[4];q3z=V1[5];q4x=V1[15];q4y=V1[16];q4z=V1[17]}else if(minDotIndex==3){q1x=V1[21];q1y=V1[22];q1z=V1[23];q2x=V1[9];q2y=V1[10];q2z=V1[11];q3x=V1[6];q3y=V1[7];q3z=V1[8];q4x=V1[18];q4y=V1[19];q4z=V1[20]}else if(minDotIndex==4){q1x=V1[12];q1y=V1[13];q1z=V1[14];q2x=V1[18];q2y=V1[19];q2z=V1[20];q3x=V1[6];q3y=V1[7];q3z=V1[8];q4x=V1[0];q4y=V1[1];q4z=V1[2]}else if(minDotIndex==5){q1x=V1[3];q1y=V1[4];q1z=V1[5];q2x=V1[6];q2y=V1[7];q2z=V1[8];q3x=V1[21];q3y=V1[22];q3z=V1[23];q4x=V1[15];q4y=V1[16];q4z=V1[17]}}else{dot=a4x*nx+a4y*ny+a4z*nz;if(dot<minDot){minDot=dot;minDotIndex=0}if(-dot<minDot){minDot=-dot;minDotIndex=1}dot=a5x*nx+a5y*ny+a5z*nz;if(dot<minDot){minDot=dot;minDotIndex=2}if(-dot<minDot){minDot=-dot;minDotIndex=3}dot=a6x*nx+a6y*ny+a6z*nz;if(dot<minDot){minDot=dot;minDotIndex=4}if(-dot<minDot){minDot=-dot;minDotIndex=5}if(minDotIndex==0){q1x=V2[0];q1y=V2[1];q1z=V2[2];q2x=V2[6];q2y=V2[7];q2z=V2[8];q3x=V2[9];q3y=V2[10];q3z=V2[11];q4x=V2[3];q4y=V2[4];q4z=V2[5]}else if(minDotIndex==1){q1x=V2[15];q1y=V2[16];q1z=V2[17];q2x=V2[21];q2y=V2[22];q2z=V2[23];q3x=V2[18];q3y=V2[19];q3z=V2[20];q4x=V2[12];q4y=V2[13];q4z=V2[14]}else if(minDotIndex==2){q1x=V2[12];q1y=V2[13];q1z=V2[14];q2x=V2[0];q2y=V2[1];q2z=V2[2];q3x=V2[3];q3y=V2[4];q3z=V2[5];q4x=V2[15];q4y=V2[16];q4z=V2[17]}else if(minDotIndex==3){q1x=V2[21];q1y=V2[22];q1z=V2[23];q2x=V2[9];q2y=V2[10];q2z=V2[11];q3x=V2[6];q3y=V2[7];q3z=V2[8];q4x=V2[18];q4y=V2[19];q4z=V2[20]}else if(minDotIndex==4){q1x=V2[12];q1y=V2[13];q1z=V2[14];q2x=V2[18];q2y=V2[19];q2z=V2[20];q3x=V2[6];q3y=V2[7];q3z=V2[8];q4x=V2[0];q4y=V2[1];q4z=V2[2]}else if(minDotIndex==5){q1x=V2[3];q1y=V2[4];q1z=V2[5];q2x=V2[9];q2y=V2[10];q2z=V2[11];q3x=V2[21];q3y=V2[22];q3z=V2[23];q4x=V2[15];q4y=V2[16];q4z=V2[17]}}var numClipVertices;var numAddedClipVertices;var index;var x1;var y1;var z1;var x2;var y2;var z2;this.clipVertices1[0]=q1x;this.clipVertices1[1]=q1y;this.clipVertices1[2]=q1z;this.clipVertices1[3]=q2x;this.clipVertices1[4]=q2y;this.clipVertices1[5]=q2z;this.clipVertices1[6]=q3x;this.clipVertices1[7]=q3y;this.clipVertices1[8]=q3z;this.clipVertices1[9]=q4x;this.clipVertices1[10]=q4y;this.clipVertices1[11]=q4z;numAddedClipVertices=0;x1=this.clipVertices1[9];y1=this.clipVertices1[10];z1=this.clipVertices1[11];dot1=(x1-cx-s1x)*n1x+(y1-cy-s1y)*n1y+(z1-cz-s1z)*n1z;for(var i=0;i<4;i++){index=i*3;x2=this.clipVertices1[index];y2=this.clipVertices1[index+1];z2=this.clipVertices1[index+2];dot2=(x2-cx-s1x)*n1x+(y2-cy-s1y)*n1y+(z2-cz-s1z)*n1z;if(dot1>0){if(dot2>0){index=numAddedClipVertices*3;numAddedClipVertices++;this.clipVertices2[index]=x2;this.clipVertices2[index+1]=y2;this.clipVertices2[index+2]=z2}else{index=numAddedClipVertices*3;numAddedClipVertices++;t=dot1/(dot1-dot2);this.clipVertices2[index]=x1+(x2-x1)*t;this.clipVertices2[index+1]=y1+(y2-y1)*t;this.clipVertices2[index+2]=z1+(z2-z1)*t}}else{if(dot2>0){index=numAddedClipVertices*3;numAddedClipVertices++;t=dot1/(dot1-dot2);this.clipVertices2[index]=x1+(x2-x1)*t;this.clipVertices2[index+1]=y1+(y2-y1)*t;this.clipVertices2[index+2]=z1+(z2-z1)*t;index=numAddedClipVertices*3;numAddedClipVertices++;this.clipVertices2[index]=x2;this.clipVertices2[index+1]=y2;this.clipVertices2[index+2]=z2}}x1=x2;y1=y2;z1=z2;dot1=dot2}numClipVertices=numAddedClipVertices;if(numClipVertices==0)return;numAddedClipVertices=0;index=(numClipVertices-1)*3;x1=this.clipVertices2[index];y1=this.clipVertices2[index+1];z1=this.clipVertices2[index+2];dot1=(x1-cx-s2x)*n2x+(y1-cy-s2y)*n2y+(z1-cz-s2z)*n2z;for(i=0;i<numClipVertices;i++){index=i*3;x2=this.clipVertices2[index];y2=this.clipVertices2[index+1];z2=this.clipVertices2[index+2];dot2=(x2-cx-s2x)*n2x+(y2-cy-s2y)*n2y+(z2-cz-s2z)*n2z;if(dot1>0){if(dot2>0){index=numAddedClipVertices*3;numAddedClipVertices++;this.clipVertices1[index]=x2;this.clipVertices1[index+1]=y2;this.clipVertices1[index+2]=z2}else{index=numAddedClipVertices*3;numAddedClipVertices++;t=dot1/(dot1-dot2);this.clipVertices1[index]=x1+(x2-x1)*t;this.clipVertices1[index+1]=y1+(y2-y1)*t;this.clipVertices1[index+2]=z1+(z2-z1)*t}}else{if(dot2>0){index=numAddedClipVertices*3;numAddedClipVertices++;t=dot1/(dot1-dot2);this.clipVertices1[index]=x1+(x2-x1)*t;this.clipVertices1[index+1]=y1+(y2-y1)*t;this.clipVertices1[index+2]=z1+(z2-z1)*t;index=numAddedClipVertices*3;numAddedClipVertices++;this.clipVertices1[index]=x2;this.clipVertices1[index+1]=y2;this.clipVertices1[index+2]=z2}}x1=x2;y1=y2;z1=z2;dot1=dot2}numClipVertices=numAddedClipVertices;if(numClipVertices==0)return;numAddedClipVertices=0;index=(numClipVertices-1)*3;x1=this.clipVertices1[index];y1=this.clipVertices1[index+1];z1=this.clipVertices1[index+2];dot1=(x1-cx+s1x)*-n1x+(y1-cy+s1y)*-n1y+(z1-cz+s1z)*-n1z;for(i=0;i<numClipVertices;i++){index=i*3;x2=this.clipVertices1[index];y2=this.clipVertices1[index+1];z2=this.clipVertices1[index+2];dot2=(x2-cx+s1x)*-n1x+(y2-cy+s1y)*-n1y+(z2-cz+s1z)*-n1z;if(dot1>0){if(dot2>0){index=numAddedClipVertices*3;numAddedClipVertices++;this.clipVertices2[index]=x2;this.clipVertices2[index+1]=y2;this.clipVertices2[index+2]=z2}else{index=numAddedClipVertices*3;numAddedClipVertices++;t=dot1/(dot1-dot2);this.clipVertices2[index]=x1+(x2-x1)*t;this.clipVertices2[index+1]=y1+(y2-y1)*t;this.clipVertices2[index+2]=z1+(z2-z1)*t}}else{if(dot2>0){index=numAddedClipVertices*3;numAddedClipVertices++;t=dot1/(dot1-dot2);this.clipVertices2[index]=x1+(x2-x1)*t;this.clipVertices2[index+1]=y1+(y2-y1)*t;this.clipVertices2[index+2]=z1+(z2-z1)*t;index=numAddedClipVertices*3;numAddedClipVertices++;this.clipVertices2[index]=x2;this.clipVertices2[index+1]=y2;this.clipVertices2[index+2]=z2}}x1=x2;y1=y2;z1=z2;dot1=dot2}numClipVertices=numAddedClipVertices;if(numClipVertices==0)return;numAddedClipVertices=0;index=(numClipVertices-1)*3;x1=this.clipVertices2[index];y1=this.clipVertices2[index+1];z1=this.clipVertices2[index+2];dot1=(x1-cx+s2x)*-n2x+(y1-cy+s2y)*-n2y+(z1-cz+s2z)*-n2z;for(i=0;i<numClipVertices;i++){index=i*3;x2=this.clipVertices2[index];y2=this.clipVertices2[index+1];z2=this.clipVertices2[index+2];dot2=(x2-cx+s2x)*-n2x+(y2-cy+s2y)*-n2y+(z2-cz+s2z)*-n2z;if(dot1>0){if(dot2>0){index=numAddedClipVertices*3;numAddedClipVertices++;this.clipVertices1[index]=x2;this.clipVertices1[index+1]=y2;this.clipVertices1[index+2]=z2}else{index=numAddedClipVertices*3;numAddedClipVertices++;t=dot1/(dot1-dot2);this.clipVertices1[index]=x1+(x2-x1)*t;this.clipVertices1[index+1]=y1+(y2-y1)*t;this.clipVertices1[index+2]=z1+(z2-z1)*t}}else{if(dot2>0){index=numAddedClipVertices*3;numAddedClipVertices++;t=dot1/(dot1-dot2);this.clipVertices1[index]=x1+(x2-x1)*t;this.clipVertices1[index+1]=y1+(y2-y1)*t;this.clipVertices1[index+2]=z1+(z2-z1)*t;index=numAddedClipVertices*3;numAddedClipVertices++;this.clipVertices1[index]=x2;this.clipVertices1[index+1]=y2;this.clipVertices1[index+2]=z2}}x1=x2;y1=y2;z1=z2;dot1=dot2}numClipVertices=numAddedClipVertices;if(swap){var tb=b1;b1=b2;b2=tb}if(numClipVertices==0)return;var flipped=b1!=shape1;if(numClipVertices>4){x1=(q1x+q2x+q3x+q4x)*.25;y1=(q1y+q2y+q3y+q4y)*.25;z1=(q1z+q2z+q3z+q4z)*.25;n1x=q1x-x1;n1y=q1y-y1;n1z=q1z-z1;n2x=q2x-x1;n2y=q2y-y1;n2z=q2z-z1;var index1=0;var index2=0;var index3=0;var index4=0;var maxDot=-this.INF;minDot=this.INF;for(i=0;i<numClipVertices;i++){this.used[i]=false;index=i*3;x1=this.clipVertices1[index];y1=this.clipVertices1[index+1];z1=this.clipVertices1[index+2];dot=x1*n1x+y1*n1y+z1*n1z;if(dot<minDot){minDot=dot;index1=i}if(dot>maxDot){maxDot=dot;index3=i}}this.used[index1]=true;this.used[index3]=true;maxDot=-this.INF;minDot=this.INF;for(i=0;i<numClipVertices;i++){if(this.used[i])continue;index=i*3;x1=this.clipVertices1[index];y1=this.clipVertices1[index+1];z1=this.clipVertices1[index+2];dot=x1*n2x+y1*n2y+z1*n2z;if(dot<minDot){minDot=dot;index2=i}if(dot>maxDot){maxDot=dot;index4=i}}index=index1*3;x1=this.clipVertices1[index];y1=this.clipVertices1[index+1];z1=this.clipVertices1[index+2];dot=(x1-cx)*nx+(y1-cy)*ny+(z1-cz)*nz;if(dot<0)manifold.addPoint(x1,y1,z1,nx,ny,nz,dot,flipped);index=index2*3;x1=this.clipVertices1[index];y1=this.clipVertices1[index+1];z1=this.clipVertices1[index+2];dot=(x1-cx)*nx+(y1-cy)*ny+(z1-cz)*nz;if(dot<0)manifold.addPoint(x1,y1,z1,nx,ny,nz,dot,flipped);index=index3*3;x1=this.clipVertices1[index];y1=this.clipVertices1[index+1];z1=this.clipVertices1[index+2];dot=(x1-cx)*nx+(y1-cy)*ny+(z1-cz)*nz;if(dot<0)manifold.addPoint(x1,y1,z1,nx,ny,nz,dot,flipped);index=index4*3;x1=this.clipVertices1[index];y1=this.clipVertices1[index+1];z1=this.clipVertices1[index+2];dot=(x1-cx)*nx+(y1-cy)*ny+(z1-cz)*nz;if(dot<0)manifold.addPoint(x1,y1,z1,nx,ny,nz,dot,flipped)}else{for(i=0;i<numClipVertices;i++){index=i*3;x1=this.clipVertices1[index];y1=this.clipVertices1[index+1];z1=this.clipVertices1[index+2];dot=(x1-cx)*nx+(y1-cy)*ny+(z1-cz)*nz;if(dot<0)manifold.addPoint(x1,y1,z1,nx,ny,nz,dot,flipped)}}};OIMO.SphereBoxCollisionDetector=function(flip){OIMO.CollisionDetector.call(this);this.flip=flip};OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereBoxCollisionDetector.prototype.constructor=OIMO.SphereBoxCollisionDetector;OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(shape1,shape2,manifold){var s;var b;if(this.flip){s=shape2;b=shape1}else{s=shape1;b=shape2}var D=b.dimentions;var ps=s.position;var psx=ps.x;var psy=ps.y;var psz=ps.z;var pb=b.position;var pbx=pb.x;var pby=pb.y;var pbz=pb.z;var rad=s.radius;var hw=b.halfWidth;var hh=b.halfHeight;var hd=b.halfDepth;var dx=psx-pbx;var dy=psy-pby;var dz=psz-pbz;var sx=D[0]*dx+D[1]*dy+D[2]*dz;var sy=D[3]*dx+D[4]*dy+D[5]*dz;var sz=D[6]*dx+D[7]*dy+D[8]*dz;var cx;var cy;var cz;var len;var invLen;var overlap=0;if(sx>hw){sx=hw}else if(sx<-hw){sx=-hw}else{overlap=1}if(sy>hh){sy=hh}else if(sy<-hh){sy=-hh}else{overlap|=2}if(sz>hd){sz=hd}else if(sz<-hd){sz=-hd}else{overlap|=4}if(overlap==7){if(sx<0){dx=hw+sx}else{dx=hw-sx}if(sy<0){dy=hh+sy}else{dy=hh-sy}if(sz<0){dz=hd+sz}else{dz=hd-sz}if(dx<dy){if(dx<dz){len=dx-hw;if(sx<0){sx=-hw;dx=D[0];dy=D[1];dz=D[2]}else{sx=hw;dx=-D[0];dy=-D[1];dz=-D[2]}}else{len=dz-hd;if(sz<0){sz=-hd;dx=D[6];dy=D[7];dz=D[8]}else{sz=hd;dx=-D[6];dy=-D[7];dz=-D[8]}}}else{if(dy<dz){len=dy-hh;if(sy<0){sy=-hh;dx=D[3];dy=D[4];dz=D[5]}else{sy=hh;dx=-D[3];dy=-D[4];dz=-D[5]}}else{len=dz-hd;if(sz<0){sz=-hd;dx=D[6];dy=D[7];dz=D[8]}else{sz=hd;dx=-D[6];dy=-D[7];dz=-D[8]}}}cx=pbx+sx*D[0]+sy*D[3]+sz*D[6];cy=pby+sx*D[1]+sy*D[4]+sz*D[7];cz=pbz+sx*D[2]+sy*D[5]+sz*D[8];manifold.addPoint(psx+rad*dx,psy+rad*dy,psz+rad*dz,dx,dy,dz,len-rad,this.flip)}else{cx=pbx+sx*D[0]+sy*D[3]+sz*D[6];cy=pby+sx*D[1]+sy*D[4]+sz*D[7];cz=pbz+sx*D[2]+sy*D[5]+sz*D[8];dx=cx-ps.x;dy=cy-ps.y;dz=cz-ps.z;len=dx*dx+dy*dy+dz*dz;if(len>0&&len<rad*rad){len=OIMO.sqrt(len);invLen=1/len;dx*=invLen;dy*=invLen;dz*=invLen;manifold.addPoint(psx+rad*dx,psy+rad*dy,psz+rad*dz,dx,dy,dz,len-rad,this.flip)}}};OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereSphereCollisionDetector.prototype.constructor=OIMO.SphereSphereCollisionDetector;OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(shape1,shape2,manifold){var s1=shape1;var s2=shape2;var p1=s1.position;var p2=s2.position;var dx=p2.x-p1.x;var dy=p2.y-p1.y;var dz=p2.z-p1.z;var len=dx*dx+dy*dy+dz*dz;var r1=s1.radius;var r2=s2.radius;var rad=r1+r2;if(len>0&&len<rad*rad){len=OIMO.sqrt(len);var invLen=1/len;dx*=invLen;dy*=invLen;dz*=invLen;manifold.addPoint(p1.x+dx*r1,p1.y+dy*r1,p1.z+dz*r1,dx,dy,dz,len-rad,false)}};OIMO.BoxCylinderCollisionDetector=function(flip){OIMO.CollisionDetector.call(this);this.flip=flip};OIMO.BoxCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.BoxCylinderCollisionDetector.prototype.constructor=OIMO.BoxCylinderCollisionDetector;OIMO.BoxCylinderCollisionDetector.prototype.getSep=function(c1,c2,sep,pos,dep){var t1x;var t1y;var t1z;var t2x;var t2y;var t2z;var sup=new OIMO.Vec3;var len;var p1x;var p1y;var p1z;var p2x;var p2y;var p2z;var v01x=c1.position.x;var v01y=c1.position.y;var v01z=c1.position.z;var v02x=c2.position.x;var v02y=c2.position.y;var v02z=c2.position.z;var v0x=v02x-v01x;var v0y=v02y-v01y;var v0z=v02z-v01z;if(v0x*v0x+v0y*v0y+v0z*v0z==0)v0y=.001;var nx=-v0x;var ny=-v0y;var nz=-v0z;this.supportPointB(c1,-nx,-ny,-nz,sup);var v11x=sup.x;var v11y=sup.y;var v11z=sup.z;this.supportPointC(c2,nx,ny,nz,sup);var v12x=sup.x;var v12y=sup.y;var v12z=sup.z;var v1x=v12x-v11x;var v1y=v12y-v11y;var v1z=v12z-v11z;if(v1x*nx+v1y*ny+v1z*nz<=0){return false}nx=v1y*v0z-v1z*v0y;ny=v1z*v0x-v1x*v0z;nz=v1x*v0y-v1y*v0x;if(nx*nx+ny*ny+nz*nz==0){sep.init(v1x-v0x,v1y-v0y,v1z-v0z);sep.normalize(sep);pos.init((v11x+v12x)*.5,(v11y+v12y)*.5,(v11z+v12z)*.5);return true}this.supportPointB(c1,-nx,-ny,-nz,sup);var v21x=sup.x;var v21y=sup.y;var v21z=sup.z;this.supportPointC(c2,nx,ny,nz,sup);var v22x=sup.x;var v22y=sup.y;var v22z=sup.z;var v2x=v22x-v21x;var v2y=v22y-v21y;var v2z=v22z-v21z;if(v2x*nx+v2y*ny+v2z*nz<=0){return false}t1x=v1x-v0x;t1y=v1y-v0y;t1z=v1z-v0z;t2x=v2x-v0x;t2y=v2y-v0y;t2z=v2z-v0z;nx=t1y*t2z-t1z*t2y;ny=t1z*t2x-t1x*t2z;nz=t1x*t2y-t1y*t2x;if(nx*v0x+ny*v0y+nz*v0z>0){t1x=v1x;t1y=v1y;t1z=v1z;v1x=v2x;v1y=v2y;v1z=v2z;v2x=t1x;v2y=t1y;v2z=t1z;t1x=v11x;t1y=v11y;t1z=v11z;v11x=v21x;v11y=v21y;v11z=v21z;v21x=t1x;v21y=t1y;v21z=t1z;t1x=v12x;t1y=v12y;t1z=v12z;v12x=v22x;v12y=v22y;v12z=v22z;v22x=t1x;v22y=t1y;v22z=t1z;nx=-nx;ny=-ny;nz=-nz}var iterations=0;while(true){if(++iterations>100){return false}this.supportPointB(c1,-nx,-ny,-nz,sup);var v31x=sup.x;var v31y=sup.y;var v31z=sup.z;this.supportPointC(c2,nx,ny,nz,sup);var v32x=sup.x;var v32y=sup.y;var v32z=sup.z;var v3x=v32x-v31x;var v3y=v32y-v31y;var v3z=v32z-v31z;if(v3x*nx+v3y*ny+v3z*nz<=0){return false}if((v1y*v3z-v1z*v3y)*v0x+(v1z*v3x-v1x*v3z)*v0y+(v1x*v3y-v1y*v3x)*v0z<0){v2x=v3x;v2y=v3y;v2z=v3z;v21x=v31x;v21y=v31y;v21z=v31z;v22x=v32x;v22y=v32y;v22z=v32z;t1x=v1x-v0x;t1y=v1y-v0y;t1z=v1z-v0z;t2x=v3x-v0x;t2y=v3y-v0y;t2z=v3z-v0z;nx=t1y*t2z-t1z*t2y;ny=t1z*t2x-t1x*t2z;nz=t1x*t2y-t1y*t2x;continue}if((v3y*v2z-v3z*v2y)*v0x+(v3z*v2x-v3x*v2z)*v0y+(v3x*v2y-v3y*v2x)*v0z<0){v1x=v3x;v1y=v3y;v1z=v3z;v11x=v31x;v11y=v31y;v11z=v31z;v12x=v32x;v12y=v32y;v12z=v32z;t1x=v3x-v0x;t1y=v3y-v0y;t1z=v3z-v0z;t2x=v2x-v0x;t2y=v2y-v0y;t2z=v2z-v0z;nx=t1y*t2z-t1z*t2y;ny=t1z*t2x-t1x*t2z;nz=t1x*t2y-t1y*t2x;continue}var hit=false;while(true){t1x=v2x-v1x;t1y=v2y-v1y;t1z=v2z-v1z;t2x=v3x-v1x;t2y=v3y-v1y;t2z=v3z-v1z;nx=t1y*t2z-t1z*t2y;ny=t1z*t2x-t1x*t2z;nz=t1x*t2y-t1y*t2x;len=1/OIMO.sqrt(nx*nx+ny*ny+nz*nz);nx*=len;ny*=len;nz*=len;if(nx*v1x+ny*v1y+nz*v1z>=0&&!hit){var b0=(v1y*v2z-v1z*v2y)*v3x+(v1z*v2x-v1x*v2z)*v3y+(v1x*v2y-v1y*v2x)*v3z;var b1=(v3y*v2z-v3z*v2y)*v0x+(v3z*v2x-v3x*v2z)*v0y+(v3x*v2y-v3y*v2x)*v0z;var b2=(v0y*v1z-v0z*v1y)*v3x+(v0z*v1x-v0x*v1z)*v3y+(v0x*v1y-v0y*v1x)*v3z;var b3=(v2y*v1z-v2z*v1y)*v0x+(v2z*v1x-v2x*v1z)*v0y+(v2x*v1y-v2y*v1x)*v0z;var sum=b0+b1+b2+b3;if(sum<=0){b0=0;b1=(v2y*v3z-v2z*v3y)*nx+(v2z*v3x-v2x*v3z)*ny+(v2x*v3y-v2y*v3x)*nz;b2=(v3y*v2z-v3z*v2y)*nx+(v3z*v2x-v3x*v2z)*ny+(v3x*v2y-v3y*v2x)*nz;b3=(v1y*v2z-v1z*v2y)*nx+(v1z*v2x-v1x*v2z)*ny+(v1x*v2y-v1y*v2x)*nz;sum=b1+b2+b3}var inv=1/sum;p1x=(v01x*b0+v11x*b1+v21x*b2+v31x*b3)*inv;p1y=(v01y*b0+v11y*b1+v21y*b2+v31y*b3)*inv;p1z=(v01z*b0+v11z*b1+v21z*b2+v31z*b3)*inv;p2x=(v02x*b0+v12x*b1+v22x*b2+v32x*b3)*inv;p2y=(v02y*b0+v12y*b1+v22y*b2+v32y*b3)*inv;p2z=(v02z*b0+v12z*b1+v22z*b2+v32z*b3)*inv;hit=true}this.supportPointB(c1,-nx,-ny,-nz,sup);var v41x=sup.x;var v41y=sup.y;var v41z=sup.z;this.supportPointC(c2,nx,ny,nz,sup);var v42x=sup.x;var v42y=sup.y;var v42z=sup.z;var v4x=v42x-v41x;var v4y=v42y-v41y;var v4z=v42z-v41z;var separation=-(v4x*nx+v4y*ny+v4z*nz);if((v4x-v3x)*nx+(v4y-v3y)*ny+(v4z-v3z)*nz<=.01||separation>=0){if(hit){sep.init(-nx,-ny,-nz);pos.init((p1x+p2x)*.5,(p1y+p2y)*.5,(p1z+p2z)*.5);dep.x=separation;return true}return false}if((v4y*v1z-v4z*v1y)*v0x+(v4z*v1x-v4x*v1z)*v0y+(v4x*v1y-v4y*v1x)*v0z<0){if((v4y*v2z-v4z*v2y)*v0x+(v4z*v2x-v4x*v2z)*v0y+(v4x*v2y-v4y*v2x)*v0z<0){v1x=v4x;v1y=v4y;v1z=v4z;v11x=v41x;v11y=v41y;v11z=v41z;v12x=v42x;v12y=v42y;v12z=v42z}else{v3x=v4x;v3y=v4y;v3z=v4z;v31x=v41x;v31y=v41y;v31z=v41z;v32x=v42x;v32y=v42y;v32z=v42z}}else{if((v4y*v3z-v4z*v3y)*v0x+(v4z*v3x-v4x*v3z)*v0y+(v4x*v3y-v4y*v3x)*v0z<0){v2x=v4x;v2y=v4y;v2z=v4z;v21x=v41x;v21y=v41y;v21z=v41z;v22x=v42x;v22y=v42y;v22z=v42z}else{v1x=v4x;v1y=v4y;v1z=v4z;v11x=v41x;v11y=v41y;v11z=v41z;v12x=v42x;v12y=v42y;v12z=v42z}}}}};OIMO.BoxCylinderCollisionDetector.prototype.supportPointB=function(c,dx,dy,dz,out){var rot=c.rotation.elements;var ldx=rot[0]*dx+rot[3]*dy+rot[6]*dz;var ldy=rot[1]*dx+rot[4]*dy+rot[7]*dz;var ldz=rot[2]*dx+rot[5]*dy+rot[8]*dz;var w=c.halfWidth;var h=c.halfHeight;var d=c.halfDepth;var ox;var oy;var oz;if(ldx<0)ox=-w;else ox=w;if(ldy<0)oy=-h;else oy=h;if(ldz<0)oz=-d;else oz=d;ldx=rot[0]*ox+rot[1]*oy+rot[2]*oz+c.position.x;ldy=rot[3]*ox+rot[4]*oy+rot[5]*oz+c.position.y;ldz=rot[6]*ox+rot[7]*oy+rot[8]*oz+c.position.z;out.init(ldx,ldy,ldz)};OIMO.BoxCylinderCollisionDetector.prototype.supportPointC=function(c,dx,dy,dz,out){var rot=c.rotation.elements;var ldx=rot[0]*dx+rot[3]*dy+rot[6]*dz;var ldy=rot[1]*dx+rot[4]*dy+rot[7]*dz;var ldz=rot[2]*dx+rot[5]*dy+rot[8]*dz;var radx=ldx;var radz=ldz;var len=radx*radx+radz*radz;var rad=c.radius;var hh=c.halfHeight;var ox;var oy;var oz;if(len==0){if(ldy<0){ox=rad;oy=-hh;oz=0}else{ox=rad;oy=hh;oz=0}}else{len=c.radius/OIMO.sqrt(len);if(ldy<0){ox=radx*len;oy=-hh;oz=radz*len}else{ox=radx*len;oy=hh;oz=radz*len}}ldx=rot[0]*ox+rot[1]*oy+rot[2]*oz+c.position.x;ldy=rot[3]*ox+rot[4]*oy+rot[5]*oz+c.position.y;ldz=rot[6]*ox+rot[7]*oy+rot[8]*oz+c.position.z;out.init(ldx,ldy,ldz)};OIMO.BoxCylinderCollisionDetector.prototype.detectCollision=function(shape1,shape2,manifold){var b;var c;if(this.flip){b=shape2;c=shape1}else{b=shape1;c=shape2}var sep=new OIMO.Vec3;var pos=new OIMO.Vec3;var dep=new OIMO.Vec3;var co;if(!this.getSep(b,c,sep,pos,dep))return;var pbx=b.position.x;var pby=b.position.y;var pbz=b.position.z;var pcx=c.position.x;var pcy=c.position.y;var pcz=c.position.z;var bw=b.halfWidth;var bh=b.halfHeight;var bd=b.halfDepth;var ch=c.halfHeight;var r=c.radius;var D=b.dimentions;var nwx=D[0];var nwy=D[1];var nwz=D[2];var nhx=D[3];var nhy=D[4];var nhz=D[5];var ndx=D[6];var ndy=D[7];var ndz=D[8];var dwx=D[9];var dwy=D[10];var dwz=D[11];var dhx=D[12];var dhy=D[13];var dhz=D[14];var ddx=D[15];var ddy=D[16];var ddz=D[17];var ncx=c.normalDirection.x;var ncy=c.normalDirection.y;var ncz=c.normalDirection.z;var dcx=c.halfDirection.x;var dcy=c.halfDirection.y;var dcz=c.halfDirection.z;var nx=sep.x;var ny=sep.y;var nz=sep.z;var dotw=nx*nwx+ny*nwy+nz*nwz;var doth=nx*nhx+ny*nhy+nz*nhz;var dotd=nx*ndx+ny*ndy+nz*ndz;var dotc=nx*ncx+ny*ncy+nz*ncz;var right1=dotw>0;var right2=doth>0;var right3=dotd>0;var right4=dotc>0;if(!right1)dotw=-dotw;if(!right2)doth=-doth;if(!right3)dotd=-dotd;if(!right4)dotc=-dotc;var state=0;if(dotc>.999){if(dotw>.999){if(dotw>dotc)state=1;else state=4}else if(doth>.999){if(doth>dotc)state=2;else state=4}else if(dotd>.999){if(dotd>dotc)state=3;else state=4}else state=4}else{if(dotw>.999)state=1;else if(doth>.999)state=2;else if(dotd>.999)state=3}var cbx;var cby;var cbz;var ccx;var ccy;var ccz;var r00;var r01;var r02;var r10;var r11;var r12;var r20;var r21;var r22;var px;var py;var pz;var pd;var dot;var len;var tx;var ty;var tz;var td;var dx;var dy;var dz;var d1x;var d1y;var d1z;var d2x;var d2y;var d2z;var sx;var sy;var sz;var sd;var ex;var ey;var ez;var ed;var dot1;var dot2;var t1;var t2;var dir1x;var dir1y;var dir1z;var dir2x;var dir2y;var dir2z;var dir1l;var dir2l;if(state==0){manifold.addPoint(pos.x,pos.y,pos.z,nx,ny,nz,dep.x,this.flip)}else if(state==4){if(right4){ccx=pcx-dcx;ccy=pcy-dcy;ccz=pcz-dcz;nx=-ncx;ny=-ncy;nz=-ncz}else{ccx=pcx+dcx;ccy=pcy+dcy;ccz=pcz+dcz;nx=ncx;ny=ncy;nz=ncz}var v1x;var v1y;var v1z;var v2x;var v2y;var v2z;var v3x;var v3y;var v3z;var v4x;var v4y;var v4z;dot=1;state=0;dot1=nwx*nx+nwy*ny+nwz*nz;if(dot1<dot){dot=dot1;state=0}if(-dot1<dot){dot=-dot1;state=1}dot1=nhx*nx+nhy*ny+nhz*nz;if(dot1<dot){dot=dot1;state=2}if(-dot1<dot){dot=-dot1;state=3}dot1=ndx*nx+ndy*ny+ndz*nz;if(dot1<dot){dot=dot1;state=4}if(-dot1<dot){dot=-dot1;state=5}var v=b.elements;switch(state){case 0:v1x=v[0];v1y=v[1];v1z=v[2];v2x=v[6];v2y=v[7];v2z=v[8];v3x=v[9];v3y=v[10];v3z=v[11];v4x=v[3];v4y=v[4];v4z=v[5];break;case 1:v1x=v[15];v1y=v[16];v1z=v[17];v2x=v[21];v2y=v[22];v2z=v[23];v3x=v[18];v3y=v[19];v3z=v[20];v4x=v[12];v4y=v[13];v4z=v[14];break;case 2:v1x=v[12];v1y=v[13];v1z=v[14];v2x=v[0];v2y=v[1];v2z=v[2];v3x=v[3];v3y=v[4];v3z=v[5];v4x=v[15];v4y=v[16];v4z=v[17];break;case 3:v1x=v[21];v1y=v[22];v1z=v[23];v2x=v[9];v2y=v[10];v2z=v[11];v3x=v[6];v3y=v[7];v3z=v[8];v4x=v[18];v4y=v[19];v4z=v[20];break;case 4:v1x=v[12];v1y=v[13];v1z=v[14];v2x=v[18];v2y=v[19];v2z=v[20];v3x=v[6];v3y=v[7];v3z=v[8];v4x=v[0];v4y=v[1];v4z=v[2];break;case 5:v1x=v[3];v1y=v[4];v1z=v[5];v2x=v[9];v2y=v[10];v2z=v[11];v3x=v[21];v3y=v[22];v3z=v[23];v4x=v[15];v4y=v[16];v4z=v[17];break}pd=nx*(v1x-ccx)+ny*(v1y-ccy)+nz*(v1z-ccz);if(pd<=0)manifold.addPoint(v1x,v1y,v1z,-nx,-ny,-nz,pd,this.flip);pd=nx*(v2x-ccx)+ny*(v2y-ccy)+nz*(v2z-ccz);if(pd<=0)manifold.addPoint(v2x,v2y,v2z,-nx,-ny,-nz,pd,this.flip);pd=nx*(v3x-ccx)+ny*(v3y-ccy)+nz*(v3z-ccz);if(pd<=0)manifold.addPoint(v3x,v3y,v3z,-nx,-ny,-nz,pd,this.flip);pd=nx*(v4x-ccx)+ny*(v4y-ccy)+nz*(v4z-ccz);if(pd<=0)manifold.addPoint(v4x,v4y,v4z,-nx,-ny,-nz,pd,this.flip)}else{switch(state){case 1:if(right1){cbx=pbx+dwx;cby=pby+dwy;cbz=pbz+dwz;nx=nwx;ny=nwy;nz=nwz}else{cbx=pbx-dwx;cby=pby-dwy;cbz=pbz-dwz;nx=-nwx;ny=-nwy;nz=-nwz}dir1x=nhx;dir1y=nhy;dir1z=nhz;dir1l=bh;dir2x=ndx;dir2y=ndy;dir2z=ndz;dir2l=bd;break;case 2:if(right2){cbx=pbx+dhx;cby=pby+dhy;cbz=pbz+dhz;nx=nhx;ny=nhy;nz=nhz}else{cbx=pbx-dhx;cby=pby-dhy;cbz=pbz-dhz;nx=-nhx;ny=-nhy;nz=-nhz}dir1x=nwx;dir1y=nwy;dir1z=nwz;dir1l=bw;dir2x=ndx;dir2y=ndy;dir2z=ndz;dir2l=bd;break;case 3:if(right3){cbx=pbx+ddx;cby=pby+ddy;cbz=pbz+ddz;nx=ndx;ny=ndy;nz=ndz}else{cbx=pbx-ddx;cby=pby-ddy;cbz=pbz-ddz;nx=-ndx;ny=-ndy;nz=-ndz}dir1x=nwx;dir1y=nwy;dir1z=nwz;dir1l=bw;dir2x=nhx;dir2y=nhy;dir2z=nhz;dir2l=bh;break}dot=nx*ncx+ny*ncy+nz*ncz;if(dot<0)len=ch;else len=-ch;ccx=pcx+len*ncx;ccy=pcy+len*ncy;ccz=pcz+len*ncz;if(dotc>=.999999){tx=-ny;ty=nz;tz=nx}else{tx=nx;ty=ny;tz=nz}len=tx*ncx+ty*ncy+tz*ncz;dx=len*ncx-tx;dy=len*ncy-ty;dz=len*ncz-tz;len=OIMO.sqrt(dx*dx+dy*dy+dz*dz);if(len==0)return;len=r/len;dx*=len;dy*=len;dz*=len;tx=ccx+dx;ty=ccy+dy;tz=ccz+dz;if(dot<-.96||dot>.96){r00=ncx*ncx*1.5-.5;r01=ncx*ncy*1.5-ncz*.866025403;r02=ncx*ncz*1.5+ncy*.866025403;r10=ncy*ncx*1.5+ncz*.866025403;r11=ncy*ncy*1.5-.5;r12=ncy*ncz*1.5-ncx*.866025403;r20=ncz*ncx*1.5-ncy*.866025403;r21=ncz*ncy*1.5+ncx*.866025403;r22=ncz*ncz*1.5-.5;px=tx;py=ty;pz=tz;pd=nx*(px-cbx)+ny*(py-cby)+nz*(pz-cbz);tx=px-pd*nx-cbx;ty=py-pd*ny-cby;tz=pz-pd*nz-cbz;sd=dir1x*tx+dir1y*ty+dir1z*tz;ed=dir2x*tx+dir2y*ty+dir2z*tz;if(sd<-dir1l)sd=-dir1l;else if(sd>dir1l)sd=dir1l;if(ed<-dir2l)ed=-dir2l;else if(ed>dir2l)ed=dir2l;tx=sd*dir1x+ed*dir2x;ty=sd*dir1y+ed*dir2y;tz=sd*dir1z+ed*dir2z;px=cbx+tx;py=cby+ty;pz=cbz+tz;manifold.addPoint(px,py,pz,nx,ny,nz,pd,this.flip);px=dx*r00+dy*r01+dz*r02;py=dx*r10+dy*r11+dz*r12;pz=dx*r20+dy*r21+dz*r22;px=(dx=px)+ccx;py=(dy=py)+ccy;pz=(dz=pz)+ccz;pd=nx*(px-cbx)+ny*(py-cby)+nz*(pz-cbz);if(pd<=0){tx=px-pd*nx-cbx;ty=py-pd*ny-cby;tz=pz-pd*nz-cbz;sd=dir1x*tx+dir1y*ty+dir1z*tz;ed=dir2x*tx+dir2y*ty+dir2z*tz;if(sd<-dir1l)sd=-dir1l;else if(sd>dir1l)sd=dir1l;if(ed<-dir2l)ed=-dir2l;else if(ed>dir2l)ed=dir2l;tx=sd*dir1x+ed*dir2x;ty=sd*dir1y+ed*dir2y;tz=sd*dir1z+ed*dir2z;px=cbx+tx;py=cby+ty;pz=cbz+tz;manifold.addPoint(px,py,pz,nx,ny,nz,pd,this.flip)}px=dx*r00+dy*r01+dz*r02;py=dx*r10+dy*r11+dz*r12;pz=dx*r20+dy*r21+dz*r22;px=(dx=px)+ccx;py=(dy=py)+ccy;pz=(dz=pz)+ccz;pd=nx*(px-cbx)+ny*(py-cby)+nz*(pz-cbz);if(pd<=0){tx=px-pd*nx-cbx;ty=py-pd*ny-cby;tz=pz-pd*nz-cbz;sd=dir1x*tx+dir1y*ty+dir1z*tz;ed=dir2x*tx+dir2y*ty+dir2z*tz;if(sd<-dir1l)sd=-dir1l;else if(sd>dir1l)sd=dir1l;if(ed<-dir2l)ed=-dir2l;else if(ed>dir2l)ed=dir2l;tx=sd*dir1x+ed*dir2x;ty=sd*dir1y+ed*dir2y;tz=sd*dir1z+ed*dir2z;px=cbx+tx;py=cby+ty;pz=cbz+tz;manifold.addPoint(px,py,pz,nx,ny,nz,pd,this.flip)}}else{sx=tx;sy=ty;sz=tz;sd=nx*(sx-cbx)+ny*(sy-cby)+nz*(sz-cbz);sx-=sd*nx;sy-=sd*ny;sz-=sd*nz;if(dot>0){ex=tx+dcx*2;ey=ty+dcy*2;ez=tz+dcz*2}else{ex=tx-dcx*2;ey=ty-dcy*2;ez=tz-dcz*2}ed=nx*(ex-cbx)+ny*(ey-cby)+nz*(ez-cbz);ex-=ed*nx;ey-=ed*ny;ez-=ed*nz;d1x=sx-cbx;d1y=sy-cby;d1z=sz-cbz;d2x=ex-cbx;d2y=ey-cby;d2z=ez-cbz;tx=ex-sx;ty=ey-sy;tz=ez-sz;td=ed-sd;dotw=d1x*dir1x+d1y*dir1y+d1z*dir1z;doth=d2x*dir1x+d2y*dir1y+d2z*dir1z;dot1=dotw-dir1l;dot2=doth-dir1l;if(dot1>0){if(dot2>0)return;t1=dot1/(dot1-dot2);sx=sx+tx*t1;sy=sy+ty*t1;sz=sz+tz*t1;sd=sd+td*t1;d1x=sx-cbx;d1y=sy-cby;d1z=sz-cbz;dotw=d1x*dir1x+d1y*dir1y+d1z*dir1z;tx=ex-sx;ty=ey-sy;tz=ez-sz;td=ed-sd}else if(dot2>0){t1=dot1/(dot1-dot2);ex=sx+tx*t1;ey=sy+ty*t1;ez=sz+tz*t1;ed=sd+td*t1;d2x=ex-cbx;d2y=ey-cby;d2z=ez-cbz;doth=d2x*dir1x+d2y*dir1y+d2z*dir1z;tx=ex-sx;ty=ey-sy;tz=ez-sz;td=ed-sd}dot1=dotw+dir1l;dot2=doth+dir1l;if(dot1<0){if(dot2<0)return;t1=dot1/(dot1-dot2);sx=sx+tx*t1;sy=sy+ty*t1;sz=sz+tz*t1;sd=sd+td*t1;d1x=sx-cbx;d1y=sy-cby;d1z=sz-cbz;tx=ex-sx;ty=ey-sy;tz=ez-sz;td=ed-sd}else if(dot2<0){t1=dot1/(dot1-dot2);ex=sx+tx*t1;ey=sy+ty*t1;ez=sz+tz*t1;ed=sd+td*t1;d2x=ex-cbx;d2y=ey-cby;d2z=ez-cbz;tx=ex-sx;ty=ey-sy;tz=ez-sz;td=ed-sd}dotw=d1x*dir2x+d1y*dir2y+d1z*dir2z;doth=d2x*dir2x+d2y*dir2y+d2z*dir2z;dot1=dotw-dir2l;dot2=doth-dir2l;if(dot1>0){if(dot2>0)return;t1=dot1/(dot1-dot2);sx=sx+tx*t1;sy=sy+ty*t1;sz=sz+tz*t1;sd=sd+td*t1;d1x=sx-cbx;d1y=sy-cby;d1z=sz-cbz;dotw=d1x*dir2x+d1y*dir2y+d1z*dir2z;tx=ex-sx;ty=ey-sy;tz=ez-sz;td=ed-sd}else if(dot2>0){t1=dot1/(dot1-dot2);ex=sx+tx*t1;ey=sy+ty*t1;ez=sz+tz*t1;ed=sd+td*t1;d2x=ex-cbx;d2y=ey-cby;d2z=ez-cbz;doth=d2x*dir2x+d2y*dir2y+d2z*dir2z;tx=ex-sx;ty=ey-sy;tz=ez-sz;td=ed-sd}dot1=dotw+dir2l;dot2=doth+dir2l;if(dot1<0){if(dot2<0)return;t1=dot1/(dot1-dot2);sx=sx+tx*t1;sy=sy+ty*t1;sz=sz+tz*t1;sd=sd+td*t1}else if(dot2<0){t1=dot1/(dot1-dot2);ex=sx+tx*t1;ey=sy+ty*t1;ez=sz+tz*t1;ed=sd+td*t1}if(sd<0){manifold.addPoint(sx,sy,sz,nx,ny,nz,sd,this.flip)}if(ed<0){manifold.addPoint(ex,ey,ez,nx,ny,nz,ed,this.flip)}}}};OIMO.CylinderCylinderCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.CylinderCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.CylinderCylinderCollisionDetector.prototype.constructor=OIMO.CylinderCylinderCollisionDetector;OIMO.CylinderCylinderCollisionDetector.prototype.getSep=function(c1,c2,sep,pos,dep){var t1x;var t1y;var t1z;var t2x;var t2y;var t2z;var sup=new OIMO.Vec3;var len;var p1x;var p1y;var p1z;var p2x;var p2y;var p2z;var v01x=c1.position.x;var v01y=c1.position.y;var v01z=c1.position.z;var v02x=c2.position.x;var v02y=c2.position.y;var v02z=c2.position.z;var v0x=v02x-v01x;var v0y=v02y-v01y;var v0z=v02z-v01z;if(v0x*v0x+v0y*v0y+v0z*v0z==0)v0y=.001;var nx=-v0x;var ny=-v0y;var nz=-v0z;this.supportPoint(c1,-nx,-ny,-nz,sup);var v11x=sup.x;var v11y=sup.y;var v11z=sup.z;this.supportPoint(c2,nx,ny,nz,sup);var v12x=sup.x;var v12y=sup.y;var v12z=sup.z;var v1x=v12x-v11x;var v1y=v12y-v11y;var v1z=v12z-v11z;if(v1x*nx+v1y*ny+v1z*nz<=0){return false}nx=v1y*v0z-v1z*v0y;ny=v1z*v0x-v1x*v0z;nz=v1x*v0y-v1y*v0x;if(nx*nx+ny*ny+nz*nz==0){sep.init(v1x-v0x,v1y-v0y,v1z-v0z);sep.normalize(sep);pos.init((v11x+v12x)*.5,(v11y+v12y)*.5,(v11z+v12z)*.5);return true}this.supportPoint(c1,-nx,-ny,-nz,sup);var v21x=sup.x;var v21y=sup.y;var v21z=sup.z;this.supportPoint(c2,nx,ny,nz,sup);var v22x=sup.x;var v22y=sup.y;var v22z=sup.z;var v2x=v22x-v21x;var v2y=v22y-v21y;var v2z=v22z-v21z;if(v2x*nx+v2y*ny+v2z*nz<=0){return false}t1x=v1x-v0x;t1y=v1y-v0y;t1z=v1z-v0z;t2x=v2x-v0x;t2y=v2y-v0y;t2z=v2z-v0z;nx=t1y*t2z-t1z*t2y;ny=t1z*t2x-t1x*t2z;nz=t1x*t2y-t1y*t2x;if(nx*v0x+ny*v0y+nz*v0z>0){t1x=v1x;t1y=v1y;t1z=v1z;v1x=v2x;v1y=v2y;v1z=v2z;v2x=t1x;v2y=t1y;v2z=t1z;t1x=v11x;t1y=v11y;t1z=v11z;v11x=v21x;v11y=v21y;v11z=v21z;v21x=t1x;v21y=t1y;v21z=t1z;t1x=v12x;t1y=v12y;t1z=v12z;v12x=v22x;v12y=v22y;v12z=v22z;v22x=t1x;v22y=t1y;v22z=t1z;nx=-nx;ny=-ny;nz=-nz}var iterations=0;while(true){if(++iterations>100){return false}this.supportPoint(c1,-nx,-ny,-nz,sup);var v31x=sup.x;var v31y=sup.y;var v31z=sup.z;this.supportPoint(c2,nx,ny,nz,sup);var v32x=sup.x;var v32y=sup.y;var v32z=sup.z;var v3x=v32x-v31x;var v3y=v32y-v31y;var v3z=v32z-v31z;if(v3x*nx+v3y*ny+v3z*nz<=0){return false}if((v1y*v3z-v1z*v3y)*v0x+(v1z*v3x-v1x*v3z)*v0y+(v1x*v3y-v1y*v3x)*v0z<0){v2x=v3x;v2y=v3y;v2z=v3z;v21x=v31x;v21y=v31y;v21z=v31z;v22x=v32x;v22y=v32y;v22z=v32z;t1x=v1x-v0x;t1y=v1y-v0y;t1z=v1z-v0z;t2x=v3x-v0x;t2y=v3y-v0y;t2z=v3z-v0z;nx=t1y*t2z-t1z*t2y;ny=t1z*t2x-t1x*t2z;nz=t1x*t2y-t1y*t2x;continue}if((v3y*v2z-v3z*v2y)*v0x+(v3z*v2x-v3x*v2z)*v0y+(v3x*v2y-v3y*v2x)*v0z<0){v1x=v3x;v1y=v3y;v1z=v3z;v11x=v31x;v11y=v31y;v11z=v31z;v12x=v32x;v12y=v32y;v12z=v32z;t1x=v3x-v0x;t1y=v3y-v0y;t1z=v3z-v0z;t2x=v2x-v0x;t2y=v2y-v0y;t2z=v2z-v0z;nx=t1y*t2z-t1z*t2y;ny=t1z*t2x-t1x*t2z;nz=t1x*t2y-t1y*t2x;continue}var hit=false;while(true){t1x=v2x-v1x;t1y=v2y-v1y;t1z=v2z-v1z;t2x=v3x-v1x;t2y=v3y-v1y;t2z=v3z-v1z;nx=t1y*t2z-t1z*t2y;ny=t1z*t2x-t1x*t2z;nz=t1x*t2y-t1y*t2x;len=1/OIMO.sqrt(nx*nx+ny*ny+nz*nz);nx*=len;ny*=len;nz*=len;if(nx*v1x+ny*v1y+nz*v1z>=0&&!hit){var b0=(v1y*v2z-v1z*v2y)*v3x+(v1z*v2x-v1x*v2z)*v3y+(v1x*v2y-v1y*v2x)*v3z;var b1=(v3y*v2z-v3z*v2y)*v0x+(v3z*v2x-v3x*v2z)*v0y+(v3x*v2y-v3y*v2x)*v0z;var b2=(v0y*v1z-v0z*v1y)*v3x+(v0z*v1x-v0x*v1z)*v3y+(v0x*v1y-v0y*v1x)*v3z;var b3=(v2y*v1z-v2z*v1y)*v0x+(v2z*v1x-v2x*v1z)*v0y+(v2x*v1y-v2y*v1x)*v0z;var sum=b0+b1+b2+b3;if(sum<=0){b0=0;b1=(v2y*v3z-v2z*v3y)*nx+(v2z*v3x-v2x*v3z)*ny+(v2x*v3y-v2y*v3x)*nz;b2=(v3y*v2z-v3z*v2y)*nx+(v3z*v2x-v3x*v2z)*ny+(v3x*v2y-v3y*v2x)*nz;b3=(v1y*v2z-v1z*v2y)*nx+(v1z*v2x-v1x*v2z)*ny+(v1x*v2y-v1y*v2x)*nz;sum=b1+b2+b3}var inv=1/sum;p1x=(v01x*b0+v11x*b1+v21x*b2+v31x*b3)*inv;p1y=(v01y*b0+v11y*b1+v21y*b2+v31y*b3)*inv;p1z=(v01z*b0+v11z*b1+v21z*b2+v31z*b3)*inv;p2x=(v02x*b0+v12x*b1+v22x*b2+v32x*b3)*inv;p2y=(v02y*b0+v12y*b1+v22y*b2+v32y*b3)*inv;p2z=(v02z*b0+v12z*b1+v22z*b2+v32z*b3)*inv;hit=true}this.supportPoint(c1,-nx,-ny,-nz,sup);var v41x=sup.x;var v41y=sup.y;var v41z=sup.z;this.supportPoint(c2,nx,ny,nz,sup);var v42x=sup.x;var v42y=sup.y;var v42z=sup.z;var v4x=v42x-v41x;var v4y=v42y-v41y;var v4z=v42z-v41z;var separation=-(v4x*nx+v4y*ny+v4z*nz);if((v4x-v3x)*nx+(v4y-v3y)*ny+(v4z-v3z)*nz<=.01||separation>=0){if(hit){sep.init(-nx,-ny,-nz);pos.init((p1x+p2x)*.5,(p1y+p2y)*.5,(p1z+p2z)*.5);dep.x=separation;return true}return false}if((v4y*v1z-v4z*v1y)*v0x+(v4z*v1x-v4x*v1z)*v0y+(v4x*v1y-v4y*v1x)*v0z<0){if((v4y*v2z-v4z*v2y)*v0x+(v4z*v2x-v4x*v2z)*v0y+(v4x*v2y-v4y*v2x)*v0z<0){v1x=v4x;v1y=v4y;v1z=v4z;v11x=v41x;v11y=v41y;v11z=v41z;v12x=v42x;v12y=v42y;v12z=v42z}else{v3x=v4x;v3y=v4y;v3z=v4z;v31x=v41x;v31y=v41y;v31z=v41z;v32x=v42x;v32y=v42y;v32z=v42z}}else{if((v4y*v3z-v4z*v3y)*v0x+(v4z*v3x-v4x*v3z)*v0y+(v4x*v3y-v4y*v3x)*v0z<0){v2x=v4x;v2y=v4y;v2z=v4z;v21x=v41x;v21y=v41y;v21z=v41z;v22x=v42x;v22y=v42y;v22z=v42z}else{v1x=v4x;v1y=v4y;v1z=v4z;v11x=v41x;v11y=v41y;v11z=v41z;v12x=v42x;v12y=v42y;v12z=v42z}}}}};OIMO.CylinderCylinderCollisionDetector.prototype.supportPoint=function(c,dx,dy,dz,out){var rot=c.rotation.elements;var ldx=rot[0]*dx+rot[3]*dy+rot[6]*dz;var ldy=rot[1]*dx+rot[4]*dy+rot[7]*dz;var ldz=rot[2]*dx+rot[5]*dy+rot[8]*dz;var radx=ldx;var radz=ldz;var len=radx*radx+radz*radz;var rad=c.radius;var hh=c.halfHeight;var ox;var oy;var oz;if(len==0){if(ldy<0){ox=rad;oy=-hh;oz=0}else{ox=rad;oy=hh;oz=0}}else{len=c.radius/OIMO.sqrt(len);if(ldy<0){ox=radx*len;oy=-hh;oz=radz*len}else{ox=radx*len;oy=hh;oz=radz*len}}ldx=rot[0]*ox+rot[1]*oy+rot[2]*oz+c.position.x;ldy=rot[3]*ox+rot[4]*oy+rot[5]*oz+c.position.y;ldz=rot[6]*ox+rot[7]*oy+rot[8]*oz+c.position.z;out.init(ldx,ldy,ldz)};OIMO.CylinderCylinderCollisionDetector.prototype.detectCollision=function(shape1,shape2,manifold){var c1;var c2;if(shape1.id<shape2.id){c1=shape1;c2=shape2}else{c1=shape2;c2=shape1}var p1=c1.position;var p2=c2.position;var p1x=p1.x;var p1y=p1.y;var p1z=p1.z;var p2x=p2.x;var p2y=p2.y;var p2z=p2.z;var h1=c1.halfHeight;var h2=c2.halfHeight;var n1=c1.normalDirection;var n2=c2.normalDirection;var d1=c1.halfDirection;var d2=c2.halfDirection;var r1=c1.radius;var r2=c2.radius;var n1x=n1.x;var n1y=n1.y;var n1z=n1.z;var n2x=n2.x;var n2y=n2.y;var n2z=n2.z;var d1x=d1.x;var d1y=d1.y;var d1z=d1.z;var d2x=d2.x;var d2y=d2.y;var d2z=d2.z;var dx=p1x-p2x;var dy=p1y-p2y;var dz=p1z-p2z;var len;var len1;var len2;var c;var c1x;var c1y;var c1z;var c2x;var c2y;var c2z;var tx;var ty;var tz;var sx;var sy;var sz;var ex;var ey;var ez;var depth1;var depth2;var dot;var t1;var t2;var sep=new OIMO.Vec3;var pos=new OIMO.Vec3;var dep=new OIMO.Vec3;if(!this.getSep(c1,c2,sep,pos,dep))return;var dot1=sep.x*n1x+sep.y*n1y+sep.z*n1z;var dot2=sep.x*n2x+sep.y*n2y+sep.z*n2z;var right1=dot1>0;var right2=dot2>0;if(!right1)dot1=-dot1;if(!right2)dot2=-dot2;var state=0;if(dot1>.999||dot2>.999){if(dot1>dot2)state=1;else state=2}var nx;var ny;var nz;var depth=dep.x;var r00;var r01;var r02;var r10;var r11;var r12;var r20;var r21;var r22;var px;var py;var pz;var pd;var a;var b;var e;var f;nx=sep.x;ny=sep.y;nz=sep.z;switch(state){case 0:manifold.addPoint(pos.x,pos.y,pos.z,nx,ny,nz,depth,false);break;case 1:if(right1){c1x=p1x+d1x;c1y=p1y+d1y;c1z=p1z+d1z;nx=n1x;ny=n1y;nz=n1z}else{c1x=p1x-d1x;c1y=p1y-d1y;c1z=p1z-d1z;nx=-n1x;ny=-n1y;nz=-n1z}dot=nx*n2x+ny*n2y+nz*n2z;if(dot<0)len=h2;else len=-h2;c2x=p2x+len*n2x;c2y=p2y+len*n2y;c2z=p2z+len*n2z;if(dot2>=.999999){tx=-ny;ty=nz;tz=nx}else{tx=nx;ty=ny;tz=nz}len=tx*n2x+ty*n2y+tz*n2z;dx=len*n2x-tx;dy=len*n2y-ty;dz=len*n2z-tz;len=OIMO.sqrt(dx*dx+dy*dy+dz*dz);if(len==0)break;len=r2/len;dx*=len;dy*=len;dz*=len;tx=c2x+dx;ty=c2y+dy;tz=c2z+dz;if(dot<-.96||dot>.96){r00=n2x*n2x*1.5-.5;r01=n2x*n2y*1.5-n2z*.866025403;r02=n2x*n2z*1.5+n2y*.866025403;r10=n2y*n2x*1.5+n2z*.866025403;r11=n2y*n2y*1.5-.5;r12=n2y*n2z*1.5-n2x*.866025403;r20=n2z*n2x*1.5-n2y*.866025403;r21=n2z*n2y*1.5+n2x*.866025403;r22=n2z*n2z*1.5-.5;px=tx;py=ty;pz=tz;pd=nx*(px-c1x)+ny*(py-c1y)+nz*(pz-c1z);tx=px-pd*nx-c1x;ty=py-pd*ny-c1y;tz=pz-pd*nz-c1z;len=tx*tx+ty*ty+tz*tz;if(len>r1*r1){len=r1/OIMO.sqrt(len);tx*=len;ty*=len;tz*=len}px=c1x+tx;py=c1y+ty;pz=c1z+tz;manifold.addPoint(px,py,pz,nx,ny,nz,pd,false);px=dx*r00+dy*r01+dz*r02;py=dx*r10+dy*r11+dz*r12;pz=dx*r20+dy*r21+dz*r22;px=(dx=px)+c2x;py=(dy=py)+c2y;pz=(dz=pz)+c2z;pd=nx*(px-c1x)+ny*(py-c1y)+nz*(pz-c1z);if(pd<=0){tx=px-pd*nx-c1x;ty=py-pd*ny-c1y;tz=pz-pd*nz-c1z;len=tx*tx+ty*ty+tz*tz;if(len>r1*r1){len=r1/OIMO.sqrt(len);tx*=len;ty*=len;tz*=len}px=c1x+tx;py=c1y+ty;pz=c1z+tz;manifold.addPoint(px,py,pz,nx,ny,nz,pd,false)}px=dx*r00+dy*r01+dz*r02;py=dx*r10+dy*r11+dz*r12;pz=dx*r20+dy*r21+dz*r22;px=(dx=px)+c2x;py=(dy=py)+c2y;pz=(dz=pz)+c2z;pd=nx*(px-c1x)+ny*(py-c1y)+nz*(pz-c1z);if(pd<=0){tx=px-pd*nx-c1x;ty=py-pd*ny-c1y;tz=pz-pd*nz-c1z;len=tx*tx+ty*ty+tz*tz;if(len>r1*r1){len=r1/OIMO.sqrt(len);tx*=len;ty*=len;tz*=len}px=c1x+tx;py=c1y+ty;pz=c1z+tz;manifold.addPoint(px,py,pz,nx,ny,nz,pd,false)}}else{sx=tx;sy=ty;sz=tz;depth1=nx*(sx-c1x)+ny*(sy-c1y)+nz*(sz-c1z);sx-=depth1*nx;sy-=depth1*ny;sz-=depth1*nz;if(dot>0){ex=tx+n2x*h2*2;ey=ty+n2y*h2*2;ez=tz+n2z*h2*2}else{ex=tx-n2x*h2*2;ey=ty-n2y*h2*2;ez=tz-n2z*h2*2}depth2=nx*(ex-c1x)+ny*(ey-c1y)+nz*(ez-c1z);ex-=depth2*nx;ey-=depth2*ny;ez-=depth2*nz;dx=c1x-sx;dy=c1y-sy;dz=c1z-sz;tx=ex-sx;ty=ey-sy;tz=ez-sz;a=dx*dx+dy*dy+dz*dz;b=dx*tx+dy*ty+dz*tz;e=tx*tx+ty*ty+tz*tz;f=b*b-e*(a-r1*r1);if(f<0)break;f=OIMO.sqrt(f);t1=(b+f)/e;t2=(b-f)/e;if(t2<t1){len=t1;t1=t2;t2=len}if(t2>1)t2=1;if(t1<0)t1=0;tx=sx+(ex-sx)*t1;ty=sy+(ey-sy)*t1;tz=sz+(ez-sz)*t1;ex=sx+(ex-sx)*t2;ey=sy+(ey-sy)*t2;ez=sz+(ez-sz)*t2;sx=tx;sy=ty;sz=tz;len=depth1+(depth2-depth1)*t1;depth2=depth1+(depth2-depth1)*t2;depth1=len;if(depth1<0)manifold.addPoint(sx,sy,sz,nx,ny,nz,pd,false);if(depth2<0)manifold.addPoint(ex,ey,ez,nx,ny,nz,pd,false)}break;case 2:if(right2){c2x=p2x-d2x;c2y=p2y-d2y;c2z=p2z-d2z;nx=-n2x;ny=-n2y;nz=-n2z}else{c2x=p2x+d2x;c2y=p2y+d2y;c2z=p2z+d2z;nx=n2x;ny=n2y;nz=n2z}dot=nx*n1x+ny*n1y+nz*n1z;if(dot<0)len=h1;else len=-h1;c1x=p1x+len*n1x;c1y=p1y+len*n1y;c1z=p1z+len*n1z;if(dot1>=.999999){tx=-ny;ty=nz;tz=nx}else{tx=nx;ty=ny;tz=nz}len=tx*n1x+ty*n1y+tz*n1z;dx=len*n1x-tx;dy=len*n1y-ty;dz=len*n1z-tz;len=OIMO.sqrt(dx*dx+dy*dy+dz*dz);if(len==0)break;len=r1/len;dx*=len;dy*=len;dz*=len;tx=c1x+dx;ty=c1y+dy;tz=c1z+dz;if(dot<-.96||dot>.96){r00=n1x*n1x*1.5-.5;r01=n1x*n1y*1.5-n1z*.866025403;r02=n1x*n1z*1.5+n1y*.866025403;r10=n1y*n1x*1.5+n1z*.866025403;r11=n1y*n1y*1.5-.5;r12=n1y*n1z*1.5-n1x*.866025403;r20=n1z*n1x*1.5-n1y*.866025403;r21=n1z*n1y*1.5+n1x*.866025403;r22=n1z*n1z*1.5-.5;px=tx;py=ty;pz=tz;pd=nx*(px-c2x)+ny*(py-c2y)+nz*(pz-c2z);tx=px-pd*nx-c2x;ty=py-pd*ny-c2y;tz=pz-pd*nz-c2z;len=tx*tx+ty*ty+tz*tz;if(len>r2*r2){len=r2/OIMO.sqrt(len);tx*=len;ty*=len;tz*=len}px=c2x+tx;py=c2y+ty;pz=c2z+tz;manifold.addPoint(px,py,pz,-nx,-ny,-nz,pd,false);px=dx*r00+dy*r01+dz*r02;py=dx*r10+dy*r11+dz*r12;pz=dx*r20+dy*r21+dz*r22;px=(dx=px)+c1x;py=(dy=py)+c1y;pz=(dz=pz)+c1z;pd=nx*(px-c2x)+ny*(py-c2y)+nz*(pz-c2z);if(pd<=0){tx=px-pd*nx-c2x;ty=py-pd*ny-c2y;tz=pz-pd*nz-c2z;len=tx*tx+ty*ty+tz*tz;if(len>r2*r2){len=r2/OIMO.sqrt(len);tx*=len;ty*=len;tz*=len}px=c2x+tx;py=c2y+ty;pz=c2z+tz;manifold.addPoint(px,py,pz,-nx,-ny,-nz,pd,false)}px=dx*r00+dy*r01+dz*r02;py=dx*r10+dy*r11+dz*r12;pz=dx*r20+dy*r21+dz*r22;px=(dx=px)+c1x;py=(dy=py)+c1y;pz=(dz=pz)+c1z;pd=nx*(px-c2x)+ny*(py-c2y)+nz*(pz-c2z);if(pd<=0){tx=px-pd*nx-c2x;ty=py-pd*ny-c2y;tz=pz-pd*nz-c2z;len=tx*tx+ty*ty+tz*tz;if(len>r2*r2){len=r2/OIMO.sqrt(len);tx*=len;ty*=len;tz*=len}px=c2x+tx;py=c2y+ty;pz=c2z+tz;manifold.addPoint(px,py,pz,-nx,-ny,-nz,pd,false)}}else{sx=tx;sy=ty;sz=tz;depth1=nx*(sx-c2x)+ny*(sy-c2y)+nz*(sz-c2z);sx-=depth1*nx;sy-=depth1*ny;sz-=depth1*nz;if(dot>0){ex=tx+n1x*h1*2;ey=ty+n1y*h1*2;ez=tz+n1z*h1*2}else{ex=tx-n1x*h1*2;ey=ty-n1y*h1*2;ez=tz-n1z*h1*2}depth2=nx*(ex-c2x)+ny*(ey-c2y)+nz*(ez-c2z);ex-=depth2*nx;ey-=depth2*ny;ez-=depth2*nz;dx=c2x-sx;dy=c2y-sy;dz=c2z-sz;tx=ex-sx;ty=ey-sy;tz=ez-sz;a=dx*dx+dy*dy+dz*dz;b=dx*tx+dy*ty+dz*tz;e=tx*tx+ty*ty+tz*tz;f=b*b-e*(a-r2*r2);if(f<0)break;f=OIMO.sqrt(f);t1=(b+f)/e;t2=(b-f)/e;if(t2<t1){len=t1;t1=t2;t2=len}if(t2>1)t2=1;if(t1<0)t1=0;tx=sx+(ex-sx)*t1;ty=sy+(ey-sy)*t1;tz=sz+(ez-sz)*t1;ex=sx+(ex-sx)*t2;ey=sy+(ey-sy)*t2;ez=sz+(ez-sz)*t2;sx=tx;sy=ty;sz=tz;len=depth1+(depth2-depth1)*t1;depth2=depth1+(depth2-depth1)*t2;depth1=len;if(depth1<0){manifold.addPoint(sx,sy,sz,-nx,-ny,-nz,depth1,false)}if(depth2<0){manifold.addPoint(ex,ey,ez,-nx,-ny,-nz,depth2,false)}}break}};OIMO.SphereCylinderCollisionDetector=function(flip){OIMO.CollisionDetector.call(this);this.flip=flip};OIMO.SphereCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereCylinderCollisionDetector.prototype.constructor=OIMO.SphereCylinderCollisionDetector;OIMO.SphereCylinderCollisionDetector.prototype.detectCollision=function(shape1,shape2,manifold){var s;var c;if(this.flip){s=shape2;c=shape1}else{s=shape1;c=shape2}var ps=s.position;var psx=ps.x;var psy=ps.y;var psz=ps.z;var pc=c.position;var pcx=pc.x;var pcy=pc.y;var pcz=pc.z;var dirx=c.normalDirection.x;var diry=c.normalDirection.y;var dirz=c.normalDirection.z;var rads=s.radius;var radc=c.radius;var rad2=rads+radc;var halfh=c.halfHeight;var dx=psx-pcx;var dy=psy-pcy;var dz=psz-pcz;var dot=dx*dirx+dy*diry+dz*dirz;if(dot<-halfh-rads||dot>halfh+rads)return;var cx=pcx+dot*dirx;var cy=pcy+dot*diry;var cz=pcz+dot*dirz;var d2x=psx-cx;var d2y=psy-cy;var d2z=psz-cz;var len=d2x*d2x+d2y*d2y+d2z*d2z;if(len>rad2*rad2)return;if(len>radc*radc){len=radc/OIMO.sqrt(len);d2x*=len;d2y*=len;d2z*=len}if(dot<-halfh)dot=-halfh;else if(dot>halfh)dot=halfh;cx=pcx+dot*dirx+d2x;cy=pcy+dot*diry+d2y;cz=pcz+dot*dirz+d2z;dx=cx-psx;dy=cy-psy;dz=cz-psz;len=dx*dx+dy*dy+dz*dz;var invLen;if(len>0&&len<rads*rads){len=OIMO.sqrt(len);invLen=1/len;dx*=invLen;dy*=invLen;dz*=invLen;manifold.addPoint(psx+dx*rads,psy+dy*rads,psz+dz*rads,dx,dy,dz,len-rads,this.flip)}};OIMO.TetraTetraCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.TetraTetraCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.TetraTetraCollisionDetector.prototype.constructor=OIMO.TetraTetraCollisionDetector;OIMO.TetraTetraCollisionDetector.prototype.detectCollision=function(tet1,tet2,manifold){var i,j,vec,fs1=tet1.faces,vs1=tet1.verts,fs2=tet2.faces,vs2=tet2.verts;var j1,j2,j3,ts=0;var fs=fs1;for(i=0;i<4;i++){vec=vs1[i];for(j=0;j<4;j++){j1=vs2[fs[i].a];j2=vs2[fs[i].b];j3=vs2[fs[i].c];if(tricheck(pt(vec.x,vec.y),pt(j1.x,j1.y),pt(j2.x,j2.y),pt(j3.x,j3.y))&&tricheck(pt(vec.x,vec.z),pt(j1.x,j1.z),pt(j2.x,j2.z),pt(j3.x,j3.z))&&tricheck(pt(vec.z,vec.y),pt(j1.z,j1.y),pt(j2.z,j2.y),pt(j3.z,j3.y)))ts++;if(ts===4)manifold.addPoint(vec)}}};function tricheck(p,p0,p1,p2){var A=.5*(-p1.y*p2.x+p0.y*(-p1.x+p2.x)+p0.x*(p1.y-p2.y)+p1.x*p2.y);var sg=A<0?-1:1;var s=(p0.y*p2.x-p0.x*p2.y+(p2.y-p0.y)*p.x+(p0.x-p2.x)*p.y)*sg;var t=(p0.x*p1.y-p0.y*p1.x+(p0.y-p1.y)*p.x+(p1.x-p0.x)*p.y)*sg;return s>0&&t>0&&s+t<2*A*sg}function pt(x,y){return{x:x,y:y}}OIMO.AABB=function(minX,maxX,minY,maxY,minZ,maxZ){this.elements=new OIMO_ARRAY_TYPE(6);var te=this.elements;te[0]=minX||0;te[1]=minY||0;te[2]=minZ||0;te[3]=maxX||0;te[4]=maxY||0;te[5]=maxZ||0};OIMO.AABB.prototype={constructor:OIMO.AABB,set:function(minX,maxX,minY,maxY,minZ,maxZ){var te=this.elements;te[0]=minX;te[3]=maxX;te[1]=minY;te[4]=maxY;te[2]=minZ;te[5]=maxZ;return this},intersectTest:function(aabb){var te=this.elements;var ue=aabb.elements;return te[0]>ue[3]||te[1]>ue[4]||te[2]>ue[5]||te[3]<ue[0]||te[4]<ue[1]||te[5]<ue[2]},intersectTestTwo:function(aabb){var te=this.elements;var ue=aabb.elements;return te[0]<ue[0]||te[1]<ue[1]||te[2]<ue[2]||te[3]>ue[3]||te[4]>ue[4]||te[5]>ue[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(aabb,margin){var m=margin||0;var me=aabb.elements;this.set(me[0]-m,me[3]+m,me[1]-m,me[4]+m,me[2]-m,me[5]+m);return this},fromArray:function(array){this.elements.set(array);return this},combine:function(aabb1,aabb2){var a=aabb1.elements;var b=aabb2.elements;var te=this.elements;te[0]=a[0]<b[0]?a[0]:b[0];te[1]=a[1]<b[1]?a[1]:b[1];te[2]=a[2]<b[2]?a[2]:b[2];te[3]=a[3]>b[3]?a[3]:b[3];te[4]=a[4]>b[4]?a[4]:b[4];te[5]=a[5]>b[5]?a[5]:b[5];return this},surfaceArea:function(){var te=this.elements;var a=te[3]-te[0];var h=te[4]-te[1];var d=te[5]-te[2];return 2*(a*(h+d)+h*d)},intersectsWithPoint:function(x,y,z){var te=this.elements;return x>=te[0]&&x<=te[3]&&y>=te[1]&&y<=te[4]&&z>=te[2]&&z<=te[5]},setFromPoints:function(arr){this.makeEmpty();for(var i=0;i<arr.length;i++){this.expandByPoint(arr[i])}},makeEmpty:function(){this.set(-Infinity,-Infinity,-Infinity,Infinity,Infinity,Infinity)},expandByPoint:function(pt){var te=this.elements;this.set(OIMO.min(te[0],pt.x),OIMO.min(te[1],pt.y),OIMO.min(te[2],pt.z),OIMO.max(te[3],pt.x),OIMO.max(te[4],pt.y),OIMO.max(te[5],pt.z))}};OIMO.Proxy=function(shape){this.shape=shape;this.aabb=shape.aabb};OIMO.Proxy.prototype={constructor:OIMO.Proxy,update:function(){OIMO.Error("Proxy","Inheritance error.")}};OIMO.BasicProxy=function(shape){OIMO.Proxy.call(this,shape);this.id=OIMO.proxyID++};OIMO.BasicProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.BasicProxy.prototype.constructor=OIMO.BasicProxy;OIMO.BasicProxy.prototype.update=function(){};OIMO.BroadPhase=function(){this.types=OIMO.BR_NULL;this.numPairChecks=0;this.numPairs=0;this.pairs=[]};OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(shape){OIMO.Error("BroadPhase","Inheritance error.")},addProxy:function(proxy){OIMO.Error("BroadPhase","Inheritance error.")},removeProxy:function(proxy){OIMO.Error("BroadPhase","Inheritance error.")},isAvailablePair:function(s1,s2){var b1=s1.parent;var b2=s2.parent;if(b1==b2||!b1.isDynamic&&!b2.isDynamic||(s1.belongsTo&s2.collidesWith)==0||(s2.belongsTo&s1.collidesWith)==0){return false}var js;if(b1.numJoints<b2.numJoints)js=b1.jointLink;else js=b2.jointLink;while(js!==null){var joint=js.joint;if(!joint.allowCollision&&(joint.body1==b1&&joint.body2==b2||joint.body1==b2&&joint.body2==b1)){return false}js=js.next}return true},detectPairs:function(){this.pairs=[];this.numPairs=0;this.numPairChecks=0;this.collectPairs()},collectPairs:function(){OIMO.Error("BroadPhase","Inheritance error.")},addPair:function(s1,s2){var pair=new OIMO.Pair(s1,s2);this.pairs.push(pair);this.numPairs++}};OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=OIMO.BR_BRUTE_FORCE;this.proxies=[]};OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.BruteForceBroadPhase.prototype.constructor=OIMO.BruteForceBroadPhase;OIMO.BruteForceBroadPhase.prototype.createProxy=function(shape){return new OIMO.BasicProxy(shape)};OIMO.BruteForceBroadPhase.prototype.addProxy=function(proxy){this.proxies.push(proxy)};OIMO.BruteForceBroadPhase.prototype.removeProxy=function(proxy){var n=this.proxies.indexOf(proxy);if(n>-1){this.proxies.splice(n,1)}};OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){var i=0,j,p1,p2;var px=this.proxies;var l=px.length;this.numPairChecks=l*(l-1)>>1;while(i<l){p1=px[i++];j=i+1;while(j<l){p2=px[j++];if(p1.aabb.intersectTest(p2.aabb)||!this.isAvailablePair(p1.shape,p2.shape))continue;this.addPair(p1.shape,p2.shape)}}};OIMO.Pair=function(s1,s2){this.shape1=s1||null;this.shape2=s2||null};OIMO.SAPAxis=function(){this.numElements=0;this.bufferSize=256;this.elements=[];this.elements.length=this.bufferSize;this.stack=new OIMO_ARRAY_TYPE(64)};OIMO.SAPAxis.prototype={constructor:OIMO.SAPAxis,addElements:function(min,max){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;var newElements=[];var i=this.numElements;while(i--){newElements[i]=this.elements[i]}}this.elements[this.numElements++]=min;this.elements[this.numElements++]=max},removeElements:function(min,max){var minIndex=-1;var maxIndex=-1;for(var i=0,l=this.numElements;i<l;i++){var e=this.elements[i];if(e==min||e==max){if(minIndex==-1){minIndex=i}else{maxIndex=i;break}}}for(i=minIndex+1,l=maxIndex;i<l;i++){this.elements[i-1]=this.elements[i]}for(i=maxIndex+1,l=this.numElements;i<l;i++){this.elements[i-2]=this.elements[i]}this.elements[--this.numElements]=null;this.elements[--this.numElements]=null},sort:function(){var count=0;var threshold=1;while(this.numElements>>threshold!=0)threshold++;threshold=threshold*this.numElements>>2;count=0;var giveup=false;var elements=this.elements;for(var i=1,l=this.numElements;i<l;i++){var tmp=elements[i];var pivot=tmp.value;var tmp2=elements[i-1];if(tmp2.value>pivot){var j=i;do{elements[j]=tmp2;if(--j==0)break;tmp2=elements[j-1]}while(tmp2.value>pivot);elements[j]=tmp;count+=i-j;if(count>threshold){giveup=true;break}}}if(!giveup)return;count=2;var stack=this.stack;stack[0]=0;stack[1]=this.numElements-1;while(count>0){var right=stack[--count];var left=stack[--count];var diff=right-left;if(diff>16){var mid=left+OIMO.floor(diff*.5);tmp=elements[mid];elements[mid]=elements[right];elements[right]=tmp;pivot=tmp.value;i=left-1;j=right;while(true){var ei;var ej;do{ei=elements[++i]}while(ei.value<pivot);do{ej=elements[--j]}while(pivot<ej.value&&j!=left);if(i>=j)break;elements[i]=ej;elements[j]=ei}elements[right]=elements[i];elements[i]=tmp;if(i-left>right-i){stack[count++]=left;stack[count++]=i-1;stack[count++]=i+1;stack[count++]=right}else{stack[count++]=i+1;stack[count++]=right;stack[count++]=left;stack[count++]=i-1}}else{for(i=left+1;i<=right;i++){tmp=elements[i];pivot=tmp.value;tmp2=elements[i-1];if(tmp2.value>pivot){j=i;do{elements[j]=tmp2;if(--j==0)break;tmp2=elements[j-1]}while(tmp2.value>pivot);elements[j]=tmp}}}}},calculateTestCount:function(){var num=1;var sum=0;for(var i=1,l=this.numElements;i<l;i++){if(this.elements[i].max){num--}else{sum+=num;num++}}return sum}};OIMO.SAPBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=OIMO.BR_SWEEP_AND_PRUNE;this.numElementsD=0;this.numElementsS=0;this.axesD=[new OIMO.SAPAxis,new OIMO.SAPAxis,new OIMO.SAPAxis];this.axesS=[new OIMO.SAPAxis,new OIMO.SAPAxis,new OIMO.SAPAxis];this.index1=0;this.index2=1};OIMO.SAPBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.SAPBroadPhase.prototype.constructor=OIMO.SAPBroadPhase;OIMO.SAPBroadPhase.prototype.createProxy=function(shape){return new OIMO.SAPProxy(this,shape)};OIMO.SAPBroadPhase.prototype.addProxy=function(proxy){var p=proxy;if(p.isDynamic()){this.axesD[0].addElements(p.min[0],p.max[0]);this.axesD[1].addElements(p.min[1],p.max[1]);this.axesD[2].addElements(p.min[2],p.max[2]);p.belongsTo=1;this.numElementsD+=2}else{this.axesS[0].addElements(p.min[0],p.max[0]);this.axesS[1].addElements(p.min[1],p.max[1]);this.axesS[2].addElements(p.min[2],p.max[2]);p.belongsTo=2;this.numElementsS+=2}};OIMO.SAPBroadPhase.prototype.removeProxy=function(proxy){var p=proxy;if(p.belongsTo==0)return;switch(p.belongsTo){case 1:this.axesD[0].removeElements(p.min[0],p.max[0]);this.axesD[1].removeElements(p.min[1],p.max[1]);this.axesD[2].removeElements(p.min[2],p.max[2]);this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(p.min[0],p.max[0]);this.axesS[1].removeElements(p.min[1],p.max[1]);this.axesS[2].removeElements(p.min[2],p.max[2]);this.numElementsS-=2;break}p.belongsTo=0};OIMO.SAPBroadPhase.prototype.collectPairs=function(){if(this.numElementsD==0)return;var axis1=this.axesD[this.index1];var axis2=this.axesD[this.index2];axis1.sort();axis2.sort();var count1=axis1.calculateTestCount();var count2=axis2.calculateTestCount();var elementsD;var elementsS;if(count1<=count2){axis2=this.axesS[this.index1];axis2.sort();elementsD=axis1.elements;elementsS=axis2.elements}else{axis1=this.axesS[this.index2];axis1.sort();elementsD=axis2.elements;elementsS=axis1.elements;this.index1^=this.index2;this.index2^=this.index1;this.index1^=this.index2}var activeD;var activeS;var p=0;var q=0;while(p<this.numElementsD){var e1;var dyn;if(q==this.numElementsS){e1=elementsD[p];dyn=true;p++}else{var d=elementsD[p];var s=elementsS[q];if(d.value<s.value){e1=d;dyn=true;p++}else{e1=s;dyn=false;q++}}if(!e1.max){var s1=e1.proxy.shape;var min1=e1.min1.value;var max1=e1.max1.value;var min2=e1.min2.value;var max2=e1.max2.value;for(var e2=activeD;e2!=null;e2=e2.pair){var s2=e2.proxy.shape;this.numPairChecks++;if(min1>e2.max1.value||max1<e2.min1.value||min2>e2.max2.value||max2<e2.min2.value||!this.isAvailablePair(s1,s2))continue;this.addPair(s1,s2)}if(dyn){for(e2=activeS;e2!=null;e2=e2.pair){s2=e2.proxy.shape;this.numPairChecks++;if(min1>e2.max1.value||max1<e2.min1.value||min2>e2.max2.value||max2<e2.min2.value||!this.isAvailablePair(s1,s2))continue;this.addPair(s1,s2)}e1.pair=activeD;activeD=e1}else{e1.pair=activeS;activeS=e1}}else{var min=e1.pair;if(dyn){if(min==activeD){activeD=activeD.pair;continue}else{e1=activeD}}else{if(min==activeS){activeS=activeS.pair;continue}else{e1=activeS}}do{e2=e1.pair;if(e2==min){e1.pair=e2.pair;break}e1=e2}while(e1!=null)}}this.index2=(this.index1|this.index2)^3};OIMO.SAPElement=function(proxy,max){this.proxy=proxy;this.pair=null;this.min1=null;this.max1=null;this.min2=null;this.max2=null;this.max=max;this.value=0};OIMO.SAPProxy=function(sap,shape){OIMO.Proxy.call(this,shape);this.belongsTo=0;this.max=[];this.min=[];this.sap=sap;this.min[0]=new OIMO.SAPElement(this,false);this.max[0]=new OIMO.SAPElement(this,true);this.min[1]=new OIMO.SAPElement(this,false);this.max[1]=new OIMO.SAPElement(this,true);this.min[2]=new OIMO.SAPElement(this,false);this.max[2]=new OIMO.SAPElement(this,true);this.max[0].pair=this.min[0];this.max[1].pair=this.min[1];this.max[2].pair=this.min[2];this.min[0].min1=this.min[1];this.min[0].max1=this.max[1];this.min[0].min2=this.min[2];this.min[0].max2=this.max[2];this.min[1].min1=this.min[0];this.min[1].max1=this.max[0];this.min[1].min2=this.min[2];this.min[1].max2=this.max[2];this.min[2].min1=this.min[0];this.min[2].max1=this.max[0];this.min[2].min2=this.min[1];this.min[2].max2=this.max[1]};OIMO.SAPProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.SAPProxy.prototype.constructor=OIMO.SAPProxy;OIMO.SAPProxy.prototype.isDynamic=function(){var body=this.shape.parent;return body.isDynamic&&!body.sleeping};OIMO.SAPProxy.prototype.update=function(){var te=this.aabb.elements;this.min[0].value=te[0];this.min[1].value=te[1];this.min[2].value=te[2];this.max[0].value=te[3];this.max[1].value=te[4];this.max[2].value=te[5];if(this.belongsTo==1&&!this.isDynamic()||this.belongsTo==2&&this.isDynamic()){this.sap.removeProxy(this);this.sap.addProxy(this)}};OIMO.DBVT=function(){this.root=null;this.freeNodes=[];this.freeNodes.length=16384;this.numFreeNodes=0;this.aabb=new OIMO.AABB};OIMO.DBVT.prototype={constructor:OIMO.DBVT,moveLeaf:function(leaf){this.deleteLeaf(leaf);this.insertLeaf(leaf)},insertLeaf:function(leaf){if(this.root==null){this.root=leaf;return}var lb=leaf.aabb;var sibling=this.root;var oldArea;var newArea;while(sibling.proxy==null){var c1=sibling.child1;var c2=sibling.child2;var b=sibling.aabb;var c1b=c1.aabb;var c2b=c2.aabb;oldArea=b.surfaceArea();this.aabb.combine(lb,b);newArea=this.aabb.surfaceArea();var creatingCost=newArea*2;var incrementalCost=(newArea-oldArea)*2;var discendingCost1=incrementalCost;this.aabb.combine(lb,c1b);if(c1.proxy!=null){discendingCost1+=this.aabb.surfaceArea()}else{discendingCost1+=this.aabb.surfaceArea()-c1b.surfaceArea()}var discendingCost2=incrementalCost;this.aabb.combine(lb,c2b);if(c2.proxy!=null){discendingCost2+=this.aabb.surfaceArea()}else{discendingCost2+=this.aabb.surfaceArea()-c2b.surfaceArea()}if(discendingCost1<discendingCost2){if(creatingCost<discendingCost1){break}else{sibling=c1}}else{if(creatingCost<discendingCost2){break}else{sibling=c2}}}var oldParent=sibling.parent;var newParent;if(this.numFreeNodes>0){newParent=this.freeNodes[--this.numFreeNodes]}else{newParent=new OIMO.DBVTNode}newParent.parent=oldParent;newParent.child1=leaf;newParent.child2=sibling;newParent.aabb.combine(leaf.aabb,sibling.aabb);newParent.height=sibling.height+1;sibling.parent=newParent;leaf.parent=newParent;if(sibling==this.root){this.root=newParent}else{if(oldParent.child1==sibling){oldParent.child1=newParent}else{oldParent.child2=newParent}}do{newParent=this.balance(newParent);this.fix(newParent);newParent=newParent.parent}while(newParent!=null)},getBalance:function(node){if(node.proxy!=null)return 0;return node.child1.height-node.child2.height},deleteLeaf:function(leaf){if(leaf==this.root){this.root=null;return}var parent=leaf.parent;var sibling;if(parent.child1==leaf){sibling=parent.child2}else{sibling=parent.child1}if(parent==this.root){this.root=sibling;sibling.parent=null;return}var grandParent=parent.parent;sibling.parent=grandParent;if(grandParent.child1==parent){grandParent.child1=sibling}else{grandParent.child2=sibling}if(this.numFreeNodes<16384){this.freeNodes[this.numFreeNodes++]=parent}do{grandParent=this.balance(grandParent);this.fix(grandParent);grandParent=grandParent.parent}while(grandParent!=null)},balance:function(node){var nh=node.height;if(nh<2){return node}var p=node.parent;var l=node.child1;var r=node.child2;var lh=l.height;var rh=r.height;var balance=lh-rh;var t;if(balance>1){var ll=l.child1;var lr=l.child2;var llh=ll.height;var lrh=lr.height;if(llh>lrh){l.child2=node;node.parent=l;node.child1=lr;lr.parent=node;node.aabb.combine(lr.aabb,r.aabb);t=lrh-rh;node.height=lrh-(t&t>>31)+1;l.aabb.combine(ll.aabb,node.aabb);t=llh-nh;l.height=llh-(t&t>>31)+1}else{l.child1=node;node.parent=l;node.child1=ll;ll.parent=node;node.aabb.combine(ll.aabb,r.aabb);t=llh-rh;node.height=llh-(t&t>>31)+1;l.aabb.combine(node.aabb,lr.aabb);t=nh-lrh;l.height=nh-(t&t>>31)+1}if(p!=null){if(p.child1==node){p.child1=l}else{p.child2=l}}else{this.root=l}l.parent=p;return l}else if(balance<-1){var rl=r.child1;var rr=r.child2;var rlh=rl.height;var rrh=rr.height;if(rlh>rrh){r.child2=node;node.parent=r;node.child2=rr;rr.parent=node;node.aabb.combine(l.aabb,rr.aabb);t=lh-rrh;node.height=lh-(t&t>>31)+1;r.aabb.combine(rl.aabb,node.aabb);t=rlh-nh;r.height=rlh-(t&t>>31)+1}else{r.child1=node;node.parent=r;node.child2=rl;rl.parent=node;node.aabb.combine(l.aabb,rl.aabb);t=lh-rlh;node.height=lh-(t&t>>31)+1;r.aabb.combine(node.aabb,rr.aabb);t=nh-rrh;r.height=nh-(t&t>>31)+1}if(p!=null){if(p.child1==node){p.child1=r}else{p.child2=r}}else{this.root=r}r.parent=p;return r}return node},fix:function(node){var c1=node.child1;var c2=node.child2;node.aabb.combine(c1.aabb,c2.aabb);node.height=c1.height<c2.height?c2.height+1:c1.height+1}};OIMO.DBVTBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=OIMO.BR_BOUNDING_VOLUME_TREE;this.tree=new OIMO.DBVT;this.stack=[];this.leaves=[];this.numLeaves=0};OIMO.DBVTBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.DBVTBroadPhase.prototype.constructor=OIMO.DBVTBroadPhase;OIMO.DBVTBroadPhase.prototype.createProxy=function(shape){return new OIMO.DBVTProxy(shape)};OIMO.DBVTBroadPhase.prototype.addProxy=function(proxy){this.tree.insertLeaf(proxy.leaf);this.leaves.push(proxy.leaf);this.numLeaves++};OIMO.DBVTBroadPhase.prototype.removeProxy=function(proxy){this.tree.deleteLeaf(proxy.leaf);var n=this.leaves.indexOf(proxy.leaf);if(n>-1){this.leaves.splice(n,1);this.numLeaves--}};OIMO.DBVTBroadPhase.prototype.collectPairs=function(){if(this.numLeaves<2)return;var leaf,margin=.1,i=this.numLeaves;while(i--){leaf=this.leaves[i];if(leaf.proxy.aabb.intersectTestTwo(leaf.aabb)){leaf.aabb.copy(leaf.proxy.aabb,margin);this.tree.deleteLeaf(leaf);this.tree.insertLeaf(leaf);this.collide(leaf,this.tree.root)}}};OIMO.DBVTBroadPhase.prototype.collide=function(node1,node2){var stackCount=2;var s1,s2,n1,n2,l1,l2;this.stack[0]=node1;this.stack[1]=node2;while(stackCount>0){n1=this.stack[--stackCount];n2=this.stack[--stackCount];l1=n1.proxy!=null;l2=n2.proxy!=null;this.numPairChecks++;if(l1&&l2){s1=n1.proxy.shape;s2=n2.proxy.shape;if(s1==s2||s1.aabb.intersectTest(s2.aabb)||!this.isAvailablePair(s1,s2))continue;this.addPair(s1,s2)}else{if(n1.aabb.intersectTest(n2.aabb))continue;if(l2||!l1&&n1.aabb.surfaceArea()>n2.aabb.surfaceArea()){this.stack[stackCount++]=n1.child1;this.stack[stackCount++]=n2;this.stack[stackCount++]=n1.child2;this.stack[stackCount++]=n2}else{this.stack[stackCount++]=n1;this.stack[stackCount++]=n2.child1;this.stack[stackCount++]=n1;this.stack[stackCount++]=n2.child2}}}};OIMO.DBVTNode=function(){this.child1=null;this.child2=null;this.parent=null;this.proxy=null;this.height=0;this.aabb=new OIMO.AABB};OIMO.DBVTProxy=function(shape){OIMO.Proxy.call(this,shape);this.leaf=new OIMO.DBVTNode;this.leaf.proxy=this};OIMO.DBVTProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.DBVTProxy.prototype.constructor=OIMO.DBVTProxy;OIMO.DBVTProxy.prototype.update=function(){};OIMO.World.prototype.add=function(obj){obj=obj||{};var type=obj.type||"box";if(typeof type==="string")type=[type];if(type[0].substring(0,5)=="joint"){if(type[0]==="joint")type[0]="jointHinge";var axe1=obj.axe1||[1,0,0];var axe2=obj.axe2||[1,0,0];var pos1=obj.pos1||[0,0,0];var pos2=obj.pos2||[0,0,0];pos1=pos1.map(function(x){return x*OIMO.INV_SCALE});pos2=pos2.map(function(x){return x*OIMO.INV_SCALE});var min,max;if(type[0]==="jointDistance"){min=obj.min||0;max=obj.max||10;min=min*OIMO.INV_SCALE;max=max*OIMO.INV_SCALE}else{min=obj.min||57.29578;max=obj.max||0;min=min*OIMO.degtorad;max=max*OIMO.degtorad}var limit=obj.limit||null;var spring=obj.spring||null;var motor=obj.motor||null;var jc=new OIMO.JointConfig;jc.allowCollision=obj.collision||false;jc.localAxis1.init(axe1[0],axe1[1],axe1[2]);jc.localAxis2.init(axe2[0],axe2[1],axe2[2]);jc.localAnchorPoint1.init(pos1[0],pos1[1],pos1[2]);jc.localAnchorPoint2.init(pos2[0],pos2[1],pos2[2]);if(typeof obj.body1=="string"||obj.body1 instanceof String)obj.body1=this.getByName(obj.body1);if(typeof obj.body2=="string"||obj.body2 instanceof String)obj.body2=this.getByName(obj.body2);jc.body1=obj.body1;jc.body2=obj.body2;var joint;switch(type[0]){case"jointDistance":joint=new OIMO.DistanceJoint(jc,min,max);if(spring!==null)joint.limitMotor.setSpring(spring[0],spring[1]);if(motor!==null)joint.limitMotor.setSpring(motor[0],motor[1]);break;case"jointHinge":joint=new OIMO.HingeJoint(jc,min,max);if(spring!==null)joint.limitMotor.setSpring(spring[0],spring[1]);if(motor!==null)joint.limitMotor.setSpring(motor[0],motor[1]);break;case"jointPrisme":joint=new OIMO.PrismaticJoint(jc,min,max);break;case"jointSlide":joint=new OIMO.SliderJoint(jc,min,max);break;case"jointBall":joint=new OIMO.BallAndSocketJoint(jc);break;case"jointWheel":joint=new OIMO.WheelJoint(jc);if(limit!==null)joint.rotationalLimitMotor1.setLimit(limit[0],limit[1]);if(spring!==null)joint.rotationalLimitMotor1.setSpring(spring[0],spring[1]);if(motor!==null)joint.rotationalLimitMotor1.setSpring(motor[0],motor[1]);break}joint.name=obj.name||"";this.addJoint(joint);return joint}else{var move=obj.move||false;var noSleep=obj.noSleep||false;var p=obj.pos||[0,0,0];p=p.map(function(x){return x*OIMO.INV_SCALE});var s=obj.size||[1,1,1];s=s.map(function(x){return x*OIMO.INV_SCALE});var rot=obj.rot||[0,0,0];rot=rot.map(function(x){return x*OIMO.degtorad});var r=[];for(var i=0;i<rot.length/3;i++){var tmp=OIMO.EulerToAxis(rot[i+0],rot[i+1],rot[i+2]);r.push(tmp[0]);r.push(tmp[1]);r.push(tmp[2]);r.push(tmp[3])}var sc=new OIMO.ShapeConfig;if(obj.sc!==undefined)sc=obj.sc;if(obj.config){sc.density=obj.config[0]===undefined?1:obj.config[0];sc.friction=obj.config[1]===undefined?.4:obj.config[1];sc.restitution=obj.config[2]===undefined?.2:obj.config[2];sc.belongsTo=obj.config[3]||1;sc.collidesWith=obj.config[4]||4294967295}if(obj.density!==undefined)sc.density=obj.density;if(obj.friction!==undefined)sc.friction=obj.friction;if(obj.restitution!==undefined)sc.restitution=obj.restitution;if(obj.belongsTo!==undefined)sc.belongsTo=obj.belongsTo;if(obj.collidesWith!==undefined)sc.collidesWith=obj.collidesWith;if(obj.massPos){obj.massPos=obj.massPos.map(function(x){return x*OIMO.INV_SCALE});sc.relativePosition.init(obj.massPos[0],obj.massPos[1],obj.massPos[2])}if(obj.massRot){obj.massRot=obj.massRot.map(function(x){return x*OIMO.degtorad});sc.relativeRotation=OIMO.EulerToMatrix(obj.massRot[0],obj.massRot[1],obj.massRot[2])}var body=new OIMO.RigidBody(p[0],p[1],p[2],r[0],r[1],r[2],r[3]);var shapes=[];var n,n2;for(var i=0;i<type.length;i++){n=i*3;n2=i*4;switch(type[i]){case"sphere":shapes[i]=new OIMO.SphereShape(sc,s[n]);break;case"cylinder":shapes[i]=new OIMO.CylinderShape(sc,s[n],s[n+1]);break;case"box":shapes[i]=new OIMO.BoxShape(sc,s[n],s[n+1],s[n+2]);break}body.addShape(shapes[i]);if(i>0){shapes[i].relativePosition=new OIMO.Vec3(p[n],p[n+1],p[n+2]);if(r[n2+0])shapes[i].relativeRotation=[r[n2],r[n2+1],r[n2+2],r[n2+3]]}}if(move){if(obj.massPos||obj.massRot)body.setupMass(1,false);else body.setupMass(1,true);if(noSleep)body.allowSleep=false;else body.allowSleep=true}else{body.setupMass(2)}body.name=obj.name||" ";this.addRigidBody(body);return body}};var root=this;if(!root["OIMO"]){if(typeof exports==="object"&&typeof module==="object")module.exports=OIMO;else if(typeof define==="function"&&define.amd)define([],function(){return OIMO});else if(typeof exports==="object")exports["OIMO"]=OIMO;else{root["OIMO"]=OIMO}}},{}],2:[function(require,module,exports){var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var BABYLON;(function(BABYLON){var KeyboardEventTypes=function(){function KeyboardEventTypes(){}Object.defineProperty(KeyboardEventTypes,"KEYDOWN",{get:function(){return KeyboardEventTypes._KEYDOWN},enumerable:true,configurable:true});Object.defineProperty(KeyboardEventTypes,"KEYUP",{get:function(){return KeyboardEventTypes._KEYUP},enumerable:true,configurable:true});KeyboardEventTypes._KEYDOWN=1;KeyboardEventTypes._KEYUP=2;return KeyboardEventTypes}();BABYLON.KeyboardEventTypes=KeyboardEventTypes;var KeyboardInfo=function(){function KeyboardInfo(type,event){this.type=type;this.event=event}return KeyboardInfo}();BABYLON.KeyboardInfo=KeyboardInfo;var KeyboardInfoPre=function(_super){__extends(KeyboardInfoPre,_super);function KeyboardInfoPre(type,event){var _this=_super.call(this,type,event)||this;_this.skipOnPointerObservable=false;return _this}return KeyboardInfoPre}(KeyboardInfo);BABYLON.KeyboardInfoPre=KeyboardInfoPre})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PointerEventTypes=function(){function PointerEventTypes(){}Object.defineProperty(PointerEventTypes,"POINTERDOWN",{get:function(){return PointerEventTypes._POINTERDOWN},enumerable:true,configurable:true});Object.defineProperty(PointerEventTypes,"POINTERUP",{get:function(){return PointerEventTypes._POINTERUP},enumerable:true,configurable:true});Object.defineProperty(PointerEventTypes,"POINTERMOVE",{get:function(){return PointerEventTypes._POINTERMOVE},enumerable:true,configurable:true});Object.defineProperty(PointerEventTypes,"POINTERWHEEL",{get:function(){return PointerEventTypes._POINTERWHEEL},enumerable:true,configurable:true});Object.defineProperty(PointerEventTypes,"POINTERPICK",{get:function(){return PointerEventTypes._POINTERPICK},enumerable:true,configurable:true});Object.defineProperty(PointerEventTypes,"POINTERTAP",{get:function(){return PointerEventTypes._POINTERTAP},enumerable:true,configurable:true});Object.defineProperty(PointerEventTypes,"POINTERDOUBLETAP",{get:function(){return PointerEventTypes._POINTERDOUBLETAP},enumerable:true,configurable:true});PointerEventTypes._POINTERDOWN=1;PointerEventTypes._POINTERUP=2;PointerEventTypes._POINTERMOVE=4;PointerEventTypes._POINTERWHEEL=8;PointerEventTypes._POINTERPICK=16;PointerEventTypes._POINTERTAP=32;PointerEventTypes._POINTERDOUBLETAP=64;return PointerEventTypes}();BABYLON.PointerEventTypes=PointerEventTypes;var PointerInfoBase=function(){function PointerInfoBase(type,event){this.type=type;this.event=event}return PointerInfoBase}();BABYLON.PointerInfoBase=PointerInfoBase;var PointerInfoPre=function(_super){__extends(PointerInfoPre,_super);function PointerInfoPre(type,event,localX,localY){var _this=_super.call(this,type,event)||this;_this.skipOnPointerObservable=false;_this.localPosition=new BABYLON.Vector2(localX,localY);return _this}return PointerInfoPre}(PointerInfoBase);BABYLON.PointerInfoPre=PointerInfoPre;var PointerInfo=function(_super){__extends(PointerInfo,_super);function PointerInfo(type,event,pickInfo){var _this=_super.call(this,type,event)||this;_this.pickInfo=pickInfo;return _this}return PointerInfo}(PointerInfoBase);BABYLON.PointerInfo=PointerInfo})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){BABYLON.ToGammaSpace=1/2.2;BABYLON.ToLinearSpace=2.2;BABYLON.Epsilon=.001;var Color3=function(){function Color3(r,g,b){if(r===void 0){r=0}if(g===void 0){g=0}if(b===void 0){b=0}this.r=r;this.g=g;this.b=b}Color3.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"};Color3.prototype.getClassName=function(){return"Color3"};Color3.prototype.getHashCode=function(){var hash=this.r||0;hash=hash*397^(this.g||0);hash=hash*397^(this.b||0);return hash};Color3.prototype.toArray=function(array,index){if(index===undefined){index=0}array[index]=this.r;array[index+1]=this.g;array[index+2]=this.b;return this};Color3.prototype.toColor4=function(alpha){if(alpha===void 0){alpha=1}return new Color4(this.r,this.g,this.b,alpha)};Color3.prototype.asArray=function(){var result=new Array;this.toArray(result,0);return result};Color3.prototype.toLuminance=function(){return this.r*.3+this.g*.59+this.b*.11};Color3.prototype.multiply=function(otherColor){return new Color3(this.r*otherColor.r,this.g*otherColor.g,this.b*otherColor.b)};Color3.prototype.multiplyToRef=function(otherColor,result){result.r=this.r*otherColor.r;result.g=this.g*otherColor.g;result.b=this.b*otherColor.b;return this};Color3.prototype.equals=function(otherColor){return otherColor&&this.r===otherColor.r&&this.g===otherColor.g&&this.b===otherColor.b};Color3.prototype.equalsFloats=function(r,g,b){return this.r===r&&this.g===g&&this.b===b};Color3.prototype.scale=function(scale){return new Color3(this.r*scale,this.g*scale,this.b*scale)};Color3.prototype.scaleToRef=function(scale,result){result.r=this.r*scale;result.g=this.g*scale;result.b=this.b*scale;return this};Color3.prototype.add=function(otherColor){return new Color3(this.r+otherColor.r,this.g+otherColor.g,this.b+otherColor.b)};Color3.prototype.addToRef=function(otherColor,result){result.r=this.r+otherColor.r;result.g=this.g+otherColor.g;result.b=this.b+otherColor.b;return this};Color3.prototype.subtract=function(otherColor){return new Color3(this.r-otherColor.r,this.g-otherColor.g,this.b-otherColor.b)};Color3.prototype.subtractToRef=function(otherColor,result){result.r=this.r-otherColor.r;result.g=this.g-otherColor.g;result.b=this.b-otherColor.b;return this};Color3.prototype.clone=function(){return new Color3(this.r,this.g,this.b)};Color3.prototype.copyFrom=function(source){this.r=source.r;this.g=source.g;this.b=source.b;return this};Color3.prototype.copyFromFloats=function(r,g,b){this.r=r;this.g=g;this.b=b;return this};Color3.prototype.set=function(r,g,b){return this.copyFromFloats(r,g,b)};Color3.prototype.toHexString=function(){var intR=this.r*255|0;var intG=this.g*255|0;var intB=this.b*255|0;return"#"+BABYLON.Scalar.ToHex(intR)+BABYLON.Scalar.ToHex(intG)+BABYLON.Scalar.ToHex(intB)};Color3.prototype.toLinearSpace=function(){var convertedColor=new Color3;this.toLinearSpaceToRef(convertedColor);return convertedColor};Color3.prototype.toLinearSpaceToRef=function(convertedColor){convertedColor.r=Math.pow(this.r,BABYLON.ToLinearSpace);convertedColor.g=Math.pow(this.g,BABYLON.ToLinearSpace);convertedColor.b=Math.pow(this.b,BABYLON.ToLinearSpace);return this};Color3.prototype.toGammaSpace=function(){var convertedColor=new Color3;this.toGammaSpaceToRef(convertedColor);return convertedColor};Color3.prototype.toGammaSpaceToRef=function(convertedColor){convertedColor.r=Math.pow(this.r,BABYLON.ToGammaSpace);convertedColor.g=Math.pow(this.g,BABYLON.ToGammaSpace);convertedColor.b=Math.pow(this.b,BABYLON.ToGammaSpace);return this};Color3.FromHexString=function(hex){if(hex.substring(0,1)!=="#"||hex.length!==7){return new Color3(0,0,0)}var r=parseInt(hex.substring(1,3),16);var g=parseInt(hex.substring(3,5),16);var b=parseInt(hex.substring(5,7),16);return Color3.FromInts(r,g,b)};Color3.FromArray=function(array,offset){if(offset===void 0){offset=0}return new Color3(array[offset],array[offset+1],array[offset+2])};Color3.FromInts=function(r,g,b){return new Color3(r/255,g/255,b/255)};Color3.Lerp=function(start,end,amount){var r=start.r+(end.r-start.r)*amount;var g=start.g+(end.g-start.g)*amount;var b=start.b+(end.b-start.b)*amount;return new Color3(r,g,b)};Color3.Red=function(){return new Color3(1,0,0)};Color3.Green=function(){return new Color3(0,1,0)};Color3.Blue=function(){return new Color3(0,0,1)};Color3.Black=function(){return new Color3(0,0,0)};Color3.White=function(){return new Color3(1,1,1)};Color3.Purple=function(){return new Color3(.5,0,.5)};Color3.Magenta=function(){return new Color3(1,0,1)};Color3.Yellow=function(){return new Color3(1,1,0)};Color3.Gray=function(){return new Color3(.5,.5,.5)};Color3.Teal=function(){return new Color3(0,1,1)};Color3.Random=function(){return new Color3(Math.random(),Math.random(),Math.random())};return Color3}();BABYLON.Color3=Color3;var Color4=function(){function Color4(r,g,b,a){if(r===void 0){r=0}if(g===void 0){g=0}if(b===void 0){b=0}if(a===void 0){a=1}this.r=r;this.g=g;this.b=b;this.a=a}Color4.prototype.addInPlace=function(right){this.r+=right.r;this.g+=right.g;this.b+=right.b;this.a+=right.a;return this};Color4.prototype.asArray=function(){var result=new Array;this.toArray(result,0);return result};Color4.prototype.toArray=function(array,index){if(index===undefined){index=0}array[index]=this.r;array[index+1]=this.g;array[index+2]=this.b;array[index+3]=this.a;return this};Color4.prototype.add=function(right){return new Color4(this.r+right.r,this.g+right.g,this.b+right.b,this.a+right.a)};Color4.prototype.subtract=function(right){return new Color4(this.r-right.r,this.g-right.g,this.b-right.b,this.a-right.a)};Color4.prototype.subtractToRef=function(right,result){result.r=this.r-right.r;result.g=this.g-right.g;result.b=this.b-right.b;result.a=this.a-right.a;return this};Color4.prototype.scale=function(scale){return new Color4(this.r*scale,this.g*scale,this.b*scale,this.a*scale)};Color4.prototype.scaleToRef=function(scale,result){result.r=this.r*scale;result.g=this.g*scale;result.b=this.b*scale;result.a=this.a*scale;return this};Color4.prototype.multiply=function(color){return new Color4(this.r*color.r,this.g*color.g,this.b*color.b,this.a*color.a)};Color4.prototype.multiplyToRef=function(color,result){result.r=this.r*color.r;result.g=this.g*color.g;result.b=this.b*color.b;result.a=this.a*color.a;return result};Color4.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"};Color4.prototype.getClassName=function(){return"Color4"};Color4.prototype.getHashCode=function(){var hash=this.r||0;hash=hash*397^(this.g||0);hash=hash*397^(this.b||0);hash=hash*397^(this.a||0);return hash};Color4.prototype.clone=function(){return new Color4(this.r,this.g,this.b,this.a)};Color4.prototype.copyFrom=function(source){this.r=source.r;this.g=source.g;this.b=source.b;this.a=source.a;return this};Color4.prototype.copyFromFloats=function(r,g,b,a){this.r=r;this.g=g;this.b=b;this.a=a;return this};Color4.prototype.set=function(r,g,b,a){return this.copyFromFloats(r,g,b,a)};Color4.prototype.toHexString=function(){var intR=this.r*255|0;var intG=this.g*255|0;var intB=this.b*255|0;var intA=this.a*255|0;return"#"+BABYLON.Scalar.ToHex(intR)+BABYLON.Scalar.ToHex(intG)+BABYLON.Scalar.ToHex(intB)+BABYLON.Scalar.ToHex(intA)};Color4.prototype.toLinearSpace=function(){var convertedColor=new Color4;this.toLinearSpaceToRef(convertedColor);return convertedColor};Color4.prototype.toLinearSpaceToRef=function(convertedColor){convertedColor.r=Math.pow(this.r,BABYLON.ToLinearSpace);convertedColor.g=Math.pow(this.g,BABYLON.ToLinearSpace);convertedColor.b=Math.pow(this.b,BABYLON.ToLinearSpace);convertedColor.a=this.a;return this};Color4.prototype.toGammaSpace=function(){var convertedColor=new Color4;this.toGammaSpaceToRef(convertedColor);return convertedColor};Color4.prototype.toGammaSpaceToRef=function(convertedColor){convertedColor.r=Math.pow(this.r,BABYLON.ToGammaSpace);convertedColor.g=Math.pow(this.g,BABYLON.ToGammaSpace);convertedColor.b=Math.pow(this.b,BABYLON.ToGammaSpace);convertedColor.a=this.a;return this};Color4.FromHexString=function(hex){if(hex.substring(0,1)!=="#"||hex.length!==9){return new Color4(0,0,0,0)}var r=parseInt(hex.substring(1,3),16);var g=parseInt(hex.substring(3,5),16);var b=parseInt(hex.substring(5,7),16);var a=parseInt(hex.substring(7,9),16);return Color4.FromInts(r,g,b,a)};Color4.Lerp=function(left,right,amount){var result=new Color4(0,0,0,0);Color4.LerpToRef(left,right,amount,result);return result};Color4.LerpToRef=function(left,right,amount,result){result.r=left.r+(right.r-left.r)*amount;result.g=left.g+(right.g-left.g)*amount;result.b=left.b+(right.b-left.b)*amount;result.a=left.a+(right.a-left.a)*amount};Color4.FromArray=function(array,offset){if(offset===void 0){offset=0}return new Color4(array[offset],array[offset+1],array[offset+2],array[offset+3])};Color4.FromInts=function(r,g,b,a){return new Color4(r/255,g/255,b/255,a/255)};Color4.CheckColors4=function(colors,count){if(colors.length===count*3){var colors4=[];for(var index=0;index<colors.length;index+=3){var newIndex=index/3*4;colors4[newIndex]=colors[index];colors4[newIndex+1]=colors[index+1];colors4[newIndex+2]=colors[index+2];colors4[newIndex+3]=1}return colors4}return colors};return Color4}();BABYLON.Color4=Color4;var Vector2=function(){function Vector2(x,y){this.x=x;this.y=y}Vector2.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"};Vector2.prototype.getClassName=function(){return"Vector2"};Vector2.prototype.getHashCode=function(){var hash=this.x||0;hash=hash*397^(this.y||0);return hash};Vector2.prototype.toArray=function(array,index){if(index===void 0){index=0}array[index]=this.x;array[index+1]=this.y;return this};Vector2.prototype.asArray=function(){var result=new Array;this.toArray(result,0);return result};Vector2.prototype.copyFrom=function(source){this.x=source.x;this.y=source.y;return this};Vector2.prototype.copyFromFloats=function(x,y){this.x=x;this.y=y;return this};Vector2.prototype.set=function(x,y){return this.copyFromFloats(x,y)};Vector2.prototype.add=function(otherVector){return new Vector2(this.x+otherVector.x,this.y+otherVector.y)};Vector2.prototype.addToRef=function(otherVector,result){result.x=this.x+otherVector.x;result.y=this.y+otherVector.y;return this};Vector2.prototype.addInPlace=function(otherVector){this.x+=otherVector.x;this.y+=otherVector.y;return this};Vector2.prototype.addVector3=function(otherVector){return new Vector2(this.x+otherVector.x,this.y+otherVector.y)};Vector2.prototype.subtract=function(otherVector){return new Vector2(this.x-otherVector.x,this.y-otherVector.y)};Vector2.prototype.subtractToRef=function(otherVector,result){result.x=this.x-otherVector.x;result.y=this.y-otherVector.y;return this};Vector2.prototype.subtractInPlace=function(otherVector){this.x-=otherVector.x;this.y-=otherVector.y;return this};Vector2.prototype.multiplyInPlace=function(otherVector){this.x*=otherVector.x;this.y*=otherVector.y;return this};Vector2.prototype.multiply=function(otherVector){return new Vector2(this.x*otherVector.x,this.y*otherVector.y)};Vector2.prototype.multiplyToRef=function(otherVector,result){result.x=this.x*otherVector.x;result.y=this.y*otherVector.y;return this};Vector2.prototype.multiplyByFloats=function(x,y){return new Vector2(this.x*x,this.y*y)};Vector2.prototype.divide=function(otherVector){return new Vector2(this.x/otherVector.x,this.y/otherVector.y)};Vector2.prototype.divideToRef=function(otherVector,result){result.x=this.x/otherVector.x;result.y=this.y/otherVector.y;return this};Vector2.prototype.negate=function(){return new Vector2(-this.x,-this.y)};Vector2.prototype.scaleInPlace=function(scale){this.x*=scale;this.y*=scale;return this};Vector2.prototype.scale=function(scale){return new Vector2(this.x*scale,this.y*scale)};Vector2.prototype.equals=function(otherVector){return otherVector&&this.x===otherVector.x&&this.y===otherVector.y};Vector2.prototype.equalsWithEpsilon=function(otherVector,epsilon){if(epsilon===void 0){epsilon=BABYLON.Epsilon}return otherVector&&BABYLON.Scalar.WithinEpsilon(this.x,otherVector.x,epsilon)&&BABYLON.Scalar.WithinEpsilon(this.y,otherVector.y,epsilon)};Vector2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector2.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y};Vector2.prototype.normalize=function(){var len=this.length();if(len===0)return this;var num=1/len;this.x*=num;this.y*=num;return this};Vector2.prototype.clone=function(){return new Vector2(this.x,this.y)};Vector2.Zero=function(){return new Vector2(0,0)};Vector2.One=function(){return new Vector2(1,1)};Vector2.FromArray=function(array,offset){if(offset===void 0){offset=0}return new Vector2(array[offset],array[offset+1])};Vector2.FromArrayToRef=function(array,offset,result){result.x=array[offset];result.y=array[offset+1]};Vector2.CatmullRom=function(value1,value2,value3,value4,amount){var squared=amount*amount;var cubed=amount*squared;var x=.5*(2*value2.x+(-value1.x+value3.x)*amount+(2*value1.x-5*value2.x+4*value3.x-value4.x)*squared+(-value1.x+3*value2.x-3*value3.x+value4.x)*cubed);var y=.5*(2*value2.y+(-value1.y+value3.y)*amount+(2*value1.y-5*value2.y+4*value3.y-value4.y)*squared+(-value1.y+3*value2.y-3*value3.y+value4.y)*cubed);return new Vector2(x,y)};Vector2.Clamp=function(value,min,max){var x=value.x;x=x>max.x?max.x:x;x=x<min.x?min.x:x;var y=value.y;y=y>max.y?max.y:y;y=y<min.y?min.y:y;return new Vector2(x,y)};Vector2.Hermite=function(value1,tangent1,value2,tangent2,amount){var squared=amount*amount;var cubed=amount*squared;var part1=2*cubed-3*squared+1;var part2=-2*cubed+3*squared;var part3=cubed-2*squared+amount;var part4=cubed-squared;var x=value1.x*part1+value2.x*part2+tangent1.x*part3+tangent2.x*part4;var y=value1.y*part1+value2.y*part2+tangent1.y*part3+tangent2.y*part4;return new Vector2(x,y)};Vector2.Lerp=function(start,end,amount){var x=start.x+(end.x-start.x)*amount;var y=start.y+(end.y-start.y)*amount;return new Vector2(x,y)};Vector2.Dot=function(left,right){return left.x*right.x+left.y*right.y};Vector2.Normalize=function(vector){var newVector=vector.clone();newVector.normalize();return newVector};Vector2.Minimize=function(left,right){var x=left.x<right.x?left.x:right.x;var y=left.y<right.y?left.y:right.y;return new Vector2(x,y)};Vector2.Maximize=function(left,right){var x=left.x>right.x?left.x:right.x;var y=left.y>right.y?left.y:right.y;return new Vector2(x,y)};Vector2.Transform=function(vector,transformation){var r=Vector2.Zero();Vector2.TransformToRef(vector,transformation,r);return r};Vector2.TransformToRef=function(vector,transformation,result){var x=vector.x*transformation.m[0]+vector.y*transformation.m[4]+transformation.m[12];var y=vector.x*transformation.m[1]+vector.y*transformation.m[5]+transformation.m[13];result.x=x;result.y=y};Vector2.PointInTriangle=function(p,p0,p1,p2){var a=1/2*(-p1.y*p2.x+p0.y*(-p1.x+p2.x)+p0.x*(p1.y-p2.y)+p1.x*p2.y);var sign=a<0?-1:1;var s=(p0.y*p2.x-p0.x*p2.y+(p2.y-p0.y)*p.x+(p0.x-p2.x)*p.y)*sign;var t=(p0.x*p1.y-p0.y*p1.x+(p0.y-p1.y)*p.x+(p1.x-p0.x)*p.y)*sign;return s>0&&t>0&&s+t<2*a*sign};Vector2.Distance=function(value1,value2){return Math.sqrt(Vector2.DistanceSquared(value1,value2))};Vector2.DistanceSquared=function(value1,value2){var x=value1.x-value2.x;var y=value1.y-value2.y;return x*x+y*y};Vector2.Center=function(value1,value2){var center=value1.add(value2);center.scaleInPlace(.5);return center};Vector2.DistanceOfPointFromSegment=function(p,segA,segB){var l2=Vector2.DistanceSquared(segA,segB);if(l2===0){return Vector2.Distance(p,segA)}var v=segB.subtract(segA);var t=Math.max(0,Math.min(1,Vector2.Dot(p.subtract(segA),v)/l2));var proj=segA.add(v.multiplyByFloats(t,t));return Vector2.Distance(p,proj)};return Vector2}();BABYLON.Vector2=Vector2;var Vector3=function(){function Vector3(x,y,z){this.x=x;this.y=y;this.z=z}Vector3.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"};Vector3.prototype.getClassName=function(){return"Vector3"};Vector3.prototype.getHashCode=function(){var hash=this.x||0;hash=hash*397^(this.y||0);hash=hash*397^(this.z||0);return hash};Vector3.prototype.asArray=function(){var result=[];this.toArray(result,0);return result};Vector3.prototype.toArray=function(array,index){if(index===void 0){index=0}array[index]=this.x;array[index+1]=this.y;array[index+2]=this.z;return this};Vector3.prototype.toQuaternion=function(){var result=new Quaternion(0,0,0,1);var cosxPlusz=Math.cos((this.x+this.z)*.5);var sinxPlusz=Math.sin((this.x+this.z)*.5);var coszMinusx=Math.cos((this.z-this.x)*.5);var sinzMinusx=Math.sin((this.z-this.x)*.5);var cosy=Math.cos(this.y*.5);var siny=Math.sin(this.y*.5);result.x=coszMinusx*siny;result.y=-sinzMinusx*siny;result.z=sinxPlusz*cosy;result.w=cosxPlusz*cosy;return result};Vector3.prototype.addInPlace=function(otherVector){this.x+=otherVector.x;this.y+=otherVector.y;this.z+=otherVector.z;return this};Vector3.prototype.add=function(otherVector){return new Vector3(this.x+otherVector.x,this.y+otherVector.y,this.z+otherVector.z)};Vector3.prototype.addToRef=function(otherVector,result){result.x=this.x+otherVector.x;result.y=this.y+otherVector.y;result.z=this.z+otherVector.z;return this};Vector3.prototype.subtractInPlace=function(otherVector){this.x-=otherVector.x;this.y-=otherVector.y;this.z-=otherVector.z;return this};Vector3.prototype.subtract=function(otherVector){return new Vector3(this.x-otherVector.x,this.y-otherVector.y,this.z-otherVector.z)};Vector3.prototype.subtractToRef=function(otherVector,result){result.x=this.x-otherVector.x;result.y=this.y-otherVector.y;result.z=this.z-otherVector.z;return this};Vector3.prototype.subtractFromFloats=function(x,y,z){return new Vector3(this.x-x,this.y-y,this.z-z)};Vector3.prototype.subtractFromFloatsToRef=function(x,y,z,result){result.x=this.x-x;result.y=this.y-y;result.z=this.z-z;return this};Vector3.prototype.negate=function(){return new Vector3(-this.x,-this.y,-this.z)};Vector3.prototype.scaleInPlace=function(scale){this.x*=scale;this.y*=scale;this.z*=scale;return this};Vector3.prototype.scale=function(scale){return new Vector3(this.x*scale,this.y*scale,this.z*scale)};Vector3.prototype.scaleToRef=function(scale,result){result.x=this.x*scale;result.y=this.y*scale;result.z=this.z*scale;return this};Vector3.prototype.equals=function(otherVector){return otherVector&&this.x===otherVector.x&&this.y===otherVector.y&&this.z===otherVector.z};Vector3.prototype.equalsWithEpsilon=function(otherVector,epsilon){if(epsilon===void 0){epsilon=BABYLON.Epsilon}return otherVector&&BABYLON.Scalar.WithinEpsilon(this.x,otherVector.x,epsilon)&&BABYLON.Scalar.WithinEpsilon(this.y,otherVector.y,epsilon)&&BABYLON.Scalar.WithinEpsilon(this.z,otherVector.z,epsilon)};Vector3.prototype.equalsToFloats=function(x,y,z){return this.x===x&&this.y===y&&this.z===z};Vector3.prototype.multiplyInPlace=function(otherVector){this.x*=otherVector.x;this.y*=otherVector.y;this.z*=otherVector.z;return this};Vector3.prototype.multiply=function(otherVector){return new Vector3(this.x*otherVector.x,this.y*otherVector.y,this.z*otherVector.z)};Vector3.prototype.multiplyToRef=function(otherVector,result){result.x=this.x*otherVector.x;result.y=this.y*otherVector.y;result.z=this.z*otherVector.z;return this};Vector3.prototype.multiplyByFloats=function(x,y,z){return new Vector3(this.x*x,this.y*y,this.z*z)};Vector3.prototype.divide=function(otherVector){return new Vector3(this.x/otherVector.x,this.y/otherVector.y,this.z/otherVector.z)};Vector3.prototype.divideToRef=function(otherVector,result){result.x=this.x/otherVector.x;result.y=this.y/otherVector.y;result.z=this.z/otherVector.z;return this};Vector3.prototype.MinimizeInPlace=function(other){if(other.x<this.x)this.x=other.x;if(other.y<this.y)this.y=other.y;if(other.z<this.z)this.z=other.z;return this};Vector3.prototype.MaximizeInPlace=function(other){if(other.x>this.x)this.x=other.x;if(other.y>this.y)this.y=other.y;if(other.z>this.z)this.z=other.z;return this};Vector3.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};Vector3.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z};Vector3.prototype.normalize=function(){var len=this.length();if(len===0||len===1)return this;var num=1/len;this.x*=num;this.y*=num;this.z*=num;return this};Vector3.prototype.clone=function(){return new Vector3(this.x,this.y,this.z)};Vector3.prototype.copyFrom=function(source){this.x=source.x;this.y=source.y;this.z=source.z;return this};Vector3.prototype.copyFromFloats=function(x,y,z){this.x=x;this.y=y;this.z=z;return this};Vector3.prototype.set=function(x,y,z){return this.copyFromFloats(x,y,z)};Vector3.GetClipFactor=function(vector0,vector1,axis,size){var d0=Vector3.Dot(vector0,axis)-size;var d1=Vector3.Dot(vector1,axis)-size;var s=d0/(d0-d1);return s};Vector3.FromArray=function(array,offset){if(!offset){offset=0}return new Vector3(array[offset],array[offset+1],array[offset+2])};Vector3.FromFloatArray=function(array,offset){return Vector3.FromArray(array,offset)};Vector3.FromArrayToRef=function(array,offset,result){result.x=array[offset];result.y=array[offset+1];result.z=array[offset+2]};Vector3.FromFloatArrayToRef=function(array,offset,result){return Vector3.FromArrayToRef(array,offset,result)};Vector3.FromFloatsToRef=function(x,y,z,result){result.x=x;result.y=y;result.z=z};Vector3.Zero=function(){return new Vector3(0,0,0)};Vector3.One=function(){return new Vector3(1,1,1)};Vector3.Up=function(){return new Vector3(0,1,0)};Vector3.Forward=function(){return new Vector3(0,0,1)};Vector3.Right=function(){return new Vector3(1,0,0)};Vector3.Left=function(){return new Vector3(-1,0,0)};Vector3.TransformCoordinates=function(vector,transformation){var result=Vector3.Zero();Vector3.TransformCoordinatesToRef(vector,transformation,result);return result};Vector3.TransformCoordinatesToRef=function(vector,transformation,result){var x=vector.x*transformation.m[0]+vector.y*transformation.m[4]+vector.z*transformation.m[8]+transformation.m[12];var y=vector.x*transformation.m[1]+vector.y*transformation.m[5]+vector.z*transformation.m[9]+transformation.m[13];var z=vector.x*transformation.m[2]+vector.y*transformation.m[6]+vector.z*transformation.m[10]+transformation.m[14];var w=vector.x*transformation.m[3]+vector.y*transformation.m[7]+vector.z*transformation.m[11]+transformation.m[15];result.x=x/w;result.y=y/w;result.z=z/w};Vector3.TransformCoordinatesFromFloatsToRef=function(x,y,z,transformation,result){var rx=x*transformation.m[0]+y*transformation.m[4]+z*transformation.m[8]+transformation.m[12];var ry=x*transformation.m[1]+y*transformation.m[5]+z*transformation.m[9]+transformation.m[13];var rz=x*transformation.m[2]+y*transformation.m[6]+z*transformation.m[10]+transformation.m[14];var rw=x*transformation.m[3]+y*transformation.m[7]+z*transformation.m[11]+transformation.m[15];result.x=rx/rw;result.y=ry/rw;result.z=rz/rw};Vector3.TransformNormal=function(vector,transformation){var result=Vector3.Zero();Vector3.TransformNormalToRef(vector,transformation,result);return result};Vector3.TransformNormalToRef=function(vector,transformation,result){var x=vector.x*transformation.m[0]+vector.y*transformation.m[4]+vector.z*transformation.m[8];var y=vector.x*transformation.m[1]+vector.y*transformation.m[5]+vector.z*transformation.m[9];var z=vector.x*transformation.m[2]+vector.y*transformation.m[6]+vector.z*transformation.m[10];result.x=x;result.y=y;result.z=z};Vector3.TransformNormalFromFloatsToRef=function(x,y,z,transformation,result){result.x=x*transformation.m[0]+y*transformation.m[4]+z*transformation.m[8];result.y=x*transformation.m[1]+y*transformation.m[5]+z*transformation.m[9];result.z=x*transformation.m[2]+y*transformation.m[6]+z*transformation.m[10]};Vector3.CatmullRom=function(value1,value2,value3,value4,amount){var squared=amount*amount;var cubed=amount*squared;var x=.5*(2*value2.x+(-value1.x+value3.x)*amount+(2*value1.x-5*value2.x+4*value3.x-value4.x)*squared+(-value1.x+3*value2.x-3*value3.x+value4.x)*cubed);var y=.5*(2*value2.y+(-value1.y+value3.y)*amount+(2*value1.y-5*value2.y+4*value3.y-value4.y)*squared+(-value1.y+3*value2.y-3*value3.y+value4.y)*cubed);var z=.5*(2*value2.z+(-value1.z+value3.z)*amount+(2*value1.z-5*value2.z+4*value3.z-value4.z)*squared+(-value1.z+3*value2.z-3*value3.z+value4.z)*cubed);return new Vector3(x,y,z)};Vector3.Clamp=function(value,min,max){var x=value.x;x=x>max.x?max.x:x;x=x<min.x?min.x:x;var y=value.y;y=y>max.y?max.y:y;y=y<min.y?min.y:y;var z=value.z;z=z>max.z?max.z:z;z=z<min.z?min.z:z;return new Vector3(x,y,z)};Vector3.Hermite=function(value1,tangent1,value2,tangent2,amount){var squared=amount*amount;var cubed=amount*squared;var part1=2*cubed-3*squared+1;var part2=-2*cubed+3*squared;var part3=cubed-2*squared+amount;var part4=cubed-squared;var x=value1.x*part1+value2.x*part2+tangent1.x*part3+tangent2.x*part4;var y=value1.y*part1+value2.y*part2+tangent1.y*part3+tangent2.y*part4;var z=value1.z*part1+value2.z*part2+tangent1.z*part3+tangent2.z*part4;return new Vector3(x,y,z)};Vector3.Lerp=function(start,end,amount){var result=new Vector3(0,0,0);Vector3.LerpToRef(start,end,amount,result);return result};Vector3.LerpToRef=function(start,end,amount,result){result.x=start.x+(end.x-start.x)*amount;result.y=start.y+(end.y-start.y)*amount;result.z=start.z+(end.z-start.z)*amount};Vector3.Dot=function(left,right){return left.x*right.x+left.y*right.y+left.z*right.z};Vector3.Cross=function(left,right){var result=Vector3.Zero();Vector3.CrossToRef(left,right,result);return result};Vector3.CrossToRef=function(left,right,result){MathTmp.Vector3[0].x=left.y*right.z-left.z*right.y;MathTmp.Vector3[0].y=left.z*right.x-left.x*right.z;MathTmp.Vector3[0].z=left.x*right.y-left.y*right.x;result.copyFrom(MathTmp.Vector3[0])};Vector3.Normalize=function(vector){var result=Vector3.Zero();Vector3.NormalizeToRef(vector,result);return result};Vector3.NormalizeToRef=function(vector,result){result.copyFrom(vector);result.normalize()};Vector3.Project=function(vector,world,transform,viewport){var cw=viewport.width;var ch=viewport.height;var cx=viewport.x;var cy=viewport.y;var viewportMatrix=Vector3._viewportMatrixCache?Vector3._viewportMatrixCache:Vector3._viewportMatrixCache=new Matrix;Matrix.FromValuesToRef(cw/2,0,0,0,0,-ch/2,0,0,0,0,.5,0,cx+cw/2,ch/2+cy,.5,1,viewportMatrix);var matrix=MathTmp.Matrix[0];world.multiplyToRef(transform,matrix);matrix.multiplyToRef(viewportMatrix,matrix);return Vector3.TransformCoordinates(vector,matrix)};Vector3.UnprojectFromTransform=function(source,viewportWidth,viewportHeight,world,transform){var matrix=MathTmp.Matrix[0];world.multiplyToRef(transform,matrix);matrix.invert();source.x=source.x/viewportWidth*2-1;source.y=-(source.y/viewportHeight*2-1);var vector=Vector3.TransformCoordinates(source,matrix);var num=source.x*matrix.m[3]+source.y*matrix.m[7]+source.z*matrix.m[11]+matrix.m[15];if(BABYLON.Scalar.WithinEpsilon(num,1)){vector=vector.scale(1/num)}return vector};Vector3.Unproject=function(source,viewportWidth,viewportHeight,world,view,projection){var matrix=MathTmp.Matrix[0];world.multiplyToRef(view,matrix);matrix.multiplyToRef(projection,matrix);matrix.invert();var screenSource=new Vector3(source.x/viewportWidth*2-1,-(source.y/viewportHeight*2-1),2*source.z-1);var vector=Vector3.TransformCoordinates(screenSource,matrix);var num=screenSource.x*matrix.m[3]+screenSource.y*matrix.m[7]+screenSource.z*matrix.m[11]+matrix.m[15];if(BABYLON.Scalar.WithinEpsilon(num,1)){vector=vector.scale(1/num)}return vector};Vector3.Minimize=function(left,right){var min=left.clone();min.MinimizeInPlace(right);return min};Vector3.Maximize=function(left,right){var max=left.clone();max.MaximizeInPlace(right);return max};Vector3.Distance=function(value1,value2){return Math.sqrt(Vector3.DistanceSquared(value1,value2))};Vector3.DistanceSquared=function(value1,value2){var x=value1.x-value2.x;var y=value1.y-value2.y;var z=value1.z-value2.z;return x*x+y*y+z*z};Vector3.Center=function(value1,value2){var center=value1.add(value2);center.scaleInPlace(.5);return center};Vector3.RotationFromAxis=function(axis1,axis2,axis3){var rotation=Vector3.Zero();Vector3.RotationFromAxisToRef(axis1,axis2,axis3,rotation);return rotation};Vector3.RotationFromAxisToRef=function(axis1,axis2,axis3,ref){var quat=MathTmp.Quaternion[0];Quaternion.RotationQuaternionFromAxisToRef(axis1,axis2,axis3,quat);quat.toEulerAnglesToRef(ref)};return Vector3}();BABYLON.Vector3=Vector3;var Vector4=function(){function Vector4(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w}Vector4.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"};Vector4.prototype.getClassName=function(){return"Vector4"};Vector4.prototype.getHashCode=function(){var hash=this.x||0;hash=hash*397^(this.y||0);hash=hash*397^(this.z||0);hash=hash*397^(this.w||0);return hash};Vector4.prototype.asArray=function(){var result=new Array;this.toArray(result,0);return result};Vector4.prototype.toArray=function(array,index){if(index===undefined){index=0}array[index]=this.x;array[index+1]=this.y;array[index+2]=this.z;array[index+3]=this.w;return this};Vector4.prototype.addInPlace=function(otherVector){this.x+=otherVector.x;this.y+=otherVector.y;this.z+=otherVector.z;this.w+=otherVector.w;return this};Vector4.prototype.add=function(otherVector){return new Vector4(this.x+otherVector.x,this.y+otherVector.y,this.z+otherVector.z,this.w+otherVector.w)};Vector4.prototype.addToRef=function(otherVector,result){result.x=this.x+otherVector.x;result.y=this.y+otherVector.y;result.z=this.z+otherVector.z;result.w=this.w+otherVector.w;return this};Vector4.prototype.subtractInPlace=function(otherVector){this.x-=otherVector.x;this.y-=otherVector.y;this.z-=otherVector.z;this.w-=otherVector.w;return this};Vector4.prototype.subtract=function(otherVector){return new Vector4(this.x-otherVector.x,this.y-otherVector.y,this.z-otherVector.z,this.w-otherVector.w)};Vector4.prototype.subtractToRef=function(otherVector,result){result.x=this.x-otherVector.x;result.y=this.y-otherVector.y;result.z=this.z-otherVector.z;result.w=this.w-otherVector.w;return this};Vector4.prototype.subtractFromFloats=function(x,y,z,w){return new Vector4(this.x-x,this.y-y,this.z-z,this.w-w)};Vector4.prototype.subtractFromFloatsToRef=function(x,y,z,w,result){result.x=this.x-x;result.y=this.y-y;result.z=this.z-z;result.w=this.w-w;return this};Vector4.prototype.negate=function(){return new Vector4(-this.x,-this.y,-this.z,-this.w)};Vector4.prototype.scaleInPlace=function(scale){this.x*=scale;this.y*=scale;this.z*=scale;this.w*=scale;return this};Vector4.prototype.scale=function(scale){return new Vector4(this.x*scale,this.y*scale,this.z*scale,this.w*scale)};Vector4.prototype.scaleToRef=function(scale,result){result.x=this.x*scale;result.y=this.y*scale;result.z=this.z*scale;result.w=this.w*scale;return this};Vector4.prototype.equals=function(otherVector){return otherVector&&this.x===otherVector.x&&this.y===otherVector.y&&this.z===otherVector.z&&this.w===otherVector.w};Vector4.prototype.equalsWithEpsilon=function(otherVector,epsilon){if(epsilon===void 0){epsilon=BABYLON.Epsilon}return otherVector&&BABYLON.Scalar.WithinEpsilon(this.x,otherVector.x,epsilon)&&BABYLON.Scalar.WithinEpsilon(this.y,otherVector.y,epsilon)&&BABYLON.Scalar.WithinEpsilon(this.z,otherVector.z,epsilon)&&BABYLON.Scalar.WithinEpsilon(this.w,otherVector.w,epsilon)};Vector4.prototype.equalsToFloats=function(x,y,z,w){return this.x===x&&this.y===y&&this.z===z&&this.w===w};Vector4.prototype.multiplyInPlace=function(otherVector){this.x*=otherVector.x;this.y*=otherVector.y;this.z*=otherVector.z;this.w*=otherVector.w;return this};Vector4.prototype.multiply=function(otherVector){return new Vector4(this.x*otherVector.x,this.y*otherVector.y,this.z*otherVector.z,this.w*otherVector.w)};Vector4.prototype.multiplyToRef=function(otherVector,result){result.x=this.x*otherVector.x;result.y=this.y*otherVector.y;result.z=this.z*otherVector.z;result.w=this.w*otherVector.w;return this};Vector4.prototype.multiplyByFloats=function(x,y,z,w){return new Vector4(this.x*x,this.y*y,this.z*z,this.w*w)};Vector4.prototype.divide=function(otherVector){return new Vector4(this.x/otherVector.x,this.y/otherVector.y,this.z/otherVector.z,this.w/otherVector.w)};Vector4.prototype.divideToRef=function(otherVector,result){result.x=this.x/otherVector.x;result.y=this.y/otherVector.y;result.z=this.z/otherVector.z;result.w=this.w/otherVector.w;return this};Vector4.prototype.MinimizeInPlace=function(other){if(other.x<this.x)this.x=other.x;if(other.y<this.y)this.y=other.y;if(other.z<this.z)this.z=other.z;if(other.w<this.w)this.w=other.w;return this};Vector4.prototype.MaximizeInPlace=function(other){if(other.x>this.x)this.x=other.x;if(other.y>this.y)this.y=other.y;if(other.z>this.z)this.z=other.z;if(other.w>this.w)this.w=other.w;return this};Vector4.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};Vector4.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w};Vector4.prototype.normalize=function(){var len=this.length();if(len===0)return this;var num=1/len;this.x*=num;this.y*=num;this.z*=num;this.w*=num;return this};Vector4.prototype.toVector3=function(){return new Vector3(this.x,this.y,this.z)};Vector4.prototype.clone=function(){return new Vector4(this.x,this.y,this.z,this.w)};Vector4.prototype.copyFrom=function(source){this.x=source.x;this.y=source.y;this.z=source.z;this.w=source.w;return this};Vector4.prototype.copyFromFloats=function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w;return this};Vector4.prototype.set=function(x,y,z,w){return this.copyFromFloats(x,y,z,w)};Vector4.FromArray=function(array,offset){if(!offset){offset=0}return new Vector4(array[offset],array[offset+1],array[offset+2],array[offset+3])};Vector4.FromArrayToRef=function(array,offset,result){result.x=array[offset];result.y=array[offset+1];result.z=array[offset+2];result.w=array[offset+3]};Vector4.FromFloatArrayToRef=function(array,offset,result){Vector4.FromArrayToRef(array,offset,result)};Vector4.FromFloatsToRef=function(x,y,z,w,result){result.x=x;result.y=y;result.z=z;result.w=w};Vector4.Zero=function(){return new Vector4(0,0,0,0)};Vector4.One=function(){return new Vector4(1,1,1,1)};Vector4.Normalize=function(vector){var result=Vector4.Zero();Vector4.NormalizeToRef(vector,result);return result};Vector4.NormalizeToRef=function(vector,result){result.copyFrom(vector);result.normalize()};Vector4.Minimize=function(left,right){var min=left.clone();min.MinimizeInPlace(right);return min};Vector4.Maximize=function(left,right){var max=left.clone();max.MaximizeInPlace(right);return max};Vector4.Distance=function(value1,value2){return Math.sqrt(Vector4.DistanceSquared(value1,value2))};Vector4.DistanceSquared=function(value1,value2){var x=value1.x-value2.x;var y=value1.y-value2.y;var z=value1.z-value2.z;var w=value1.w-value2.w;return x*x+y*y+z*z+w*w};Vector4.Center=function(value1,value2){var center=value1.add(value2);center.scaleInPlace(.5);return center};Vector4.TransformNormal=function(vector,transformation){var result=Vector4.Zero();Vector4.TransformNormalToRef(vector,transformation,result);return result};Vector4.TransformNormalToRef=function(vector,transformation,result){var x=vector.x*transformation.m[0]+vector.y*transformation.m[4]+vector.z*transformation.m[8];var y=vector.x*transformation.m[1]+vector.y*transformation.m[5]+vector.z*transformation.m[9];var z=vector.x*transformation.m[2]+vector.y*transformation.m[6]+vector.z*transformation.m[10];result.x=x;result.y=y;result.z=z;result.w=vector.w};Vector4.TransformNormalFromFloatsToRef=function(x,y,z,w,transformation,result){result.x=x*transformation.m[0]+y*transformation.m[4]+z*transformation.m[8];result.y=x*transformation.m[1]+y*transformation.m[5]+z*transformation.m[9];result.z=x*transformation.m[2]+y*transformation.m[6]+z*transformation.m[10];result.w=w};return Vector4}();BABYLON.Vector4=Vector4;var Size=function(){function Size(width,height){this.width=width;this.height=height}Size.prototype.toString=function(){return"{W: "+this.width+", H: "+this.height+"}"};Size.prototype.getClassName=function(){return"Size"};Size.prototype.getHashCode=function(){var hash=this.width||0;hash=hash*397^(this.height||0);return hash};Size.prototype.copyFrom=function(src){this.width=src.width;this.height=src.height};Size.prototype.copyFromFloats=function(width,height){this.width=width;this.height=height;return this};Size.prototype.set=function(width,height){return this.copyFromFloats(width,height)};Size.prototype.multiplyByFloats=function(w,h){return new Size(this.width*w,this.height*h)};Size.prototype.clone=function(){return new Size(this.width,this.height)};Size.prototype.equals=function(other){if(!other){return false}return this.width===other.width&&this.height===other.height};Object.defineProperty(Size.prototype,"surface",{get:function(){return this.width*this.height},enumerable:true,configurable:true});Size.Zero=function(){return new Size(0,0)};Size.prototype.add=function(otherSize){var r=new Size(this.width+otherSize.width,this.height+otherSize.height);return r};Size.prototype.subtract=function(otherSize){var r=new Size(this.width-otherSize.width,this.height-otherSize.height);return r};Size.Lerp=function(start,end,amount){var w=start.width+(end.width-start.width)*amount;var h=start.height+(end.height-start.height)*amount;return new Size(w,h)};return Size}();BABYLON.Size=Size;var Quaternion=function(){function Quaternion(x,y,z,w){if(x===void 0){x=0}if(y===void 0){y=0}if(z===void 0){z=0}if(w===void 0){w=1}this.x=x;this.y=y;this.z=z;this.w=w}Quaternion.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"};Quaternion.prototype.getClassName=function(){return"Quaternion"};Quaternion.prototype.getHashCode=function(){var hash=this.x||0;hash=hash*397^(this.y||0);hash=hash*397^(this.z||0);hash=hash*397^(this.w||0);return hash};Quaternion.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]};Quaternion.prototype.equals=function(otherQuaternion){return otherQuaternion&&this.x===otherQuaternion.x&&this.y===otherQuaternion.y&&this.z===otherQuaternion.z&&this.w===otherQuaternion.w};Quaternion.prototype.clone=function(){return new Quaternion(this.x,this.y,this.z,this.w)};Quaternion.prototype.copyFrom=function(other){this.x=other.x;this.y=other.y;this.z=other.z;this.w=other.w;return this};Quaternion.prototype.copyFromFloats=function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w;return this};Quaternion.prototype.set=function(x,y,z,w){return this.copyFromFloats(x,y,z,w)};Quaternion.prototype.add=function(other){return new Quaternion(this.x+other.x,this.y+other.y,this.z+other.z,this.w+other.w)};Quaternion.prototype.subtract=function(other){return new Quaternion(this.x-other.x,this.y-other.y,this.z-other.z,this.w-other.w)};Quaternion.prototype.scale=function(value){return new Quaternion(this.x*value,this.y*value,this.z*value,this.w*value)};Quaternion.prototype.multiply=function(q1){var result=new Quaternion(0,0,0,1);this.multiplyToRef(q1,result);return result};Quaternion.prototype.multiplyToRef=function(q1,result){var x=this.x*q1.w+this.y*q1.z-this.z*q1.y+this.w*q1.x;var y=-this.x*q1.z+this.y*q1.w+this.z*q1.x+this.w*q1.y;var z=this.x*q1.y-this.y*q1.x+this.z*q1.w+this.w*q1.z;var w=-this.x*q1.x-this.y*q1.y-this.z*q1.z+this.w*q1.w;result.copyFromFloats(x,y,z,w);return this};Quaternion.prototype.multiplyInPlace=function(q1){this.multiplyToRef(q1,this);return this};Quaternion.prototype.conjugateToRef=function(ref){ref.copyFromFloats(-this.x,-this.y,-this.z,this.w);return this};Quaternion.prototype.conjugateInPlace=function(){this.x*=-1;this.y*=-1;this.z*=-1;return this};Quaternion.prototype.conjugate=function(){var result=new Quaternion(-this.x,-this.y,-this.z,this.w);return result};Quaternion.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};Quaternion.prototype.normalize=function(){var length=1/this.length();this.x*=length;this.y*=length;this.z*=length;this.w*=length;return this};Quaternion.prototype.toEulerAngles=function(order){if(order===void 0){order="YZX"}var result=Vector3.Zero();this.toEulerAnglesToRef(result,order);return result};Quaternion.prototype.toEulerAnglesToRef=function(result,order){if(order===void 0){order="YZX"}var qz=this.z;var qx=this.x;var qy=this.y;var qw=this.w;var sqw=qw*qw;var sqz=qz*qz;var sqx=qx*qx;var sqy=qy*qy;var zAxisY=qy*qz-qx*qw;var limit=.4999999;if(zAxisY<-limit){result.y=2*Math.atan2(qy,qw);result.x=Math.PI/2;result.z=0}else if(zAxisY>limit){result.y=2*Math.atan2(qy,qw);result.x=-Math.PI/2;result.z=0}else{result.z=Math.atan2(2*(qx*qy+qz*qw),-sqz-sqx+sqy+sqw);result.x=Math.asin(-2*(qz*qy-qx*qw));result.y=Math.atan2(2*(qz*qx+qy*qw),sqz-sqx-sqy+sqw)}return this};Quaternion.prototype.toRotationMatrix=function(result){var xx=this.x*this.x;var yy=this.y*this.y;var zz=this.z*this.z;var xy=this.x*this.y;var zw=this.z*this.w;var zx=this.z*this.x;var yw=this.y*this.w;var yz=this.y*this.z;var xw=this.x*this.w;result.m[0]=1-2*(yy+zz);result.m[1]=2*(xy+zw);result.m[2]=2*(zx-yw);result.m[3]=0;result.m[4]=2*(xy-zw);result.m[5]=1-2*(zz+xx);result.m[6]=2*(yz+xw);result.m[7]=0;result.m[8]=2*(zx+yw);result.m[9]=2*(yz-xw);result.m[10]=1-2*(yy+xx);result.m[11]=0;result.m[12]=0;result.m[13]=0;result.m[14]=0;result.m[15]=1;result._markAsUpdated();return this};Quaternion.prototype.fromRotationMatrix=function(matrix){Quaternion.FromRotationMatrixToRef(matrix,this);return this};Quaternion.FromRotationMatrix=function(matrix){var result=new Quaternion;Quaternion.FromRotationMatrixToRef(matrix,result);return result};Quaternion.FromRotationMatrixToRef=function(matrix,result){var data=matrix.m;var m11=data[0],m12=data[4],m13=data[8];var m21=data[1],m22=data[5],m23=data[9];var m31=data[2],m32=data[6],m33=data[10];var trace=m11+m22+m33;var s;if(trace>0){s=.5/Math.sqrt(trace+1);result.w=.25/s;result.x=(m32-m23)*s;result.y=(m13-m31)*s;result.z=(m21-m12)*s}else if(m11>m22&&m11>m33){s=2*Math.sqrt(1+m11-m22-m33);result.w=(m32-m23)/s;result.x=.25*s;result.y=(m12+m21)/s;result.z=(m13+m31)/s}else if(m22>m33){s=2*Math.sqrt(1+m22-m11-m33);result.w=(m13-m31)/s;result.x=(m12+m21)/s;result.y=.25*s;result.z=(m23+m32)/s}else{s=2*Math.sqrt(1+m33-m11-m22);result.w=(m21-m12)/s;result.x=(m13+m31)/s;result.y=(m23+m32)/s;result.z=.25*s}};Quaternion.Zero=function(){return new Quaternion(0,0,0,0)};Quaternion.Inverse=function(q){return new Quaternion(-q.x,-q.y,-q.z,q.w)};Quaternion.Identity=function(){return new Quaternion(0,0,0,1)};Quaternion.IsIdentity=function(quaternion){return quaternion&&quaternion.x===0&&quaternion.y===0&&quaternion.z===0&&quaternion.w===1};Quaternion.RotationAxis=function(axis,angle){return Quaternion.RotationAxisToRef(axis,angle,new Quaternion)};Quaternion.RotationAxisToRef=function(axis,angle,result){var sin=Math.sin(angle/2);axis.normalize();result.w=Math.cos(angle/2);result.x=axis.x*sin;result.y=axis.y*sin;result.z=axis.z*sin;return result};Quaternion.FromArray=function(array,offset){if(!offset){offset=0}return new Quaternion(array[offset],array[offset+1],array[offset+2],array[offset+3])};Quaternion.RotationYawPitchRoll=function(yaw,pitch,roll){var q=new Quaternion;Quaternion.RotationYawPitchRollToRef(yaw,pitch,roll,q);return q};Quaternion.RotationYawPitchRollToRef=function(yaw,pitch,roll,result){var halfRoll=roll*.5;var halfPitch=pitch*.5;var halfYaw=yaw*.5;var sinRoll=Math.sin(halfRoll);var cosRoll=Math.cos(halfRoll);var sinPitch=Math.sin(halfPitch);var cosPitch=Math.cos(halfPitch);var sinYaw=Math.sin(halfYaw);var cosYaw=Math.cos(halfYaw);result.x=cosYaw*sinPitch*cosRoll+sinYaw*cosPitch*sinRoll;result.y=sinYaw*cosPitch*cosRoll-cosYaw*sinPitch*sinRoll;result.z=cosYaw*cosPitch*sinRoll-sinYaw*sinPitch*cosRoll;result.w=cosYaw*cosPitch*cosRoll+sinYaw*sinPitch*sinRoll};Quaternion.RotationAlphaBetaGamma=function(alpha,beta,gamma){var result=new Quaternion;Quaternion.RotationAlphaBetaGammaToRef(alpha,beta,gamma,result);return result};Quaternion.RotationAlphaBetaGammaToRef=function(alpha,beta,gamma,result){var halfGammaPlusAlpha=(gamma+alpha)*.5;var halfGammaMinusAlpha=(gamma-alpha)*.5;var halfBeta=beta*.5;result.x=Math.cos(halfGammaMinusAlpha)*Math.sin(halfBeta);result.y=Math.sin(halfGammaMinusAlpha)*Math.sin(halfBeta);result.z=Math.sin(halfGammaPlusAlpha)*Math.cos(halfBeta);result.w=Math.cos(halfGammaPlusAlpha)*Math.cos(halfBeta)};Quaternion.RotationQuaternionFromAxis=function(axis1,axis2,axis3,ref){var quat=new Quaternion(0,0,0,0);Quaternion.RotationQuaternionFromAxisToRef(axis1,axis2,axis3,quat);return quat};Quaternion.RotationQuaternionFromAxisToRef=function(axis1,axis2,axis3,ref){var rotMat=MathTmp.Matrix[0];BABYLON.Matrix.FromXYZAxesToRef(axis1.normalize(),axis2.normalize(),axis3.normalize(),rotMat);BABYLON.Quaternion.FromRotationMatrixToRef(rotMat,ref)};Quaternion.Slerp=function(left,right,amount){var result=Quaternion.Identity();Quaternion.SlerpToRef(left,right,amount,result);return result};Quaternion.SlerpToRef=function(left,right,amount,result){var num2;var num3;var num=amount;var num4=left.x*right.x+left.y*right.y+left.z*right.z+left.w*right.w;var flag=false;if(num4<0){flag=true;num4=-num4}if(num4>.999999){num3=1-num;num2=flag?-num:num}else{var num5=Math.acos(num4);var num6=1/Math.sin(num5);num3=Math.sin((1-num)*num5)*num6;num2=flag?-Math.sin(num*num5)*num6:Math.sin(num*num5)*num6}result.x=num3*left.x+num2*right.x;result.y=num3*left.y+num2*right.y;result.z=num3*left.z+num2*right.z;result.w=num3*left.w+num2*right.w};Quaternion.Hermite=function(value1,tangent1,value2,tangent2,amount){var squared=amount*amount;var cubed=amount*squared;var part1=2*cubed-3*squared+1;var part2=-2*cubed+3*squared;var part3=cubed-2*squared+amount;var part4=cubed-squared;var x=value1.x*part1+value2.x*part2+tangent1.x*part3+tangent2.x*part4;var y=value1.y*part1+value2.y*part2+tangent1.y*part3+tangent2.y*part4;var z=value1.z*part1+value2.z*part2+tangent1.z*part3+tangent2.z*part4;var w=value1.w*part1+value2.w*part2+tangent1.w*part3+tangent2.w*part4;return new Quaternion(x,y,z,w)};return Quaternion}();BABYLON.Quaternion=Quaternion;var Matrix=function(){function Matrix(){this._isIdentity=false;this._isIdentityDirty=true;this.m=new Float32Array(16);this._markAsUpdated()}Matrix.prototype._markAsUpdated=function(){this.updateFlag=Matrix._updateFlagSeed++;this._isIdentityDirty=true};Matrix.prototype.isIdentity=function(considerAsTextureMatrix){if(considerAsTextureMatrix===void 0){considerAsTextureMatrix=false}if(this._isIdentityDirty){this._isIdentityDirty=false;if(this.m[0]!==1||this.m[5]!==1||this.m[15]!==1){this._isIdentity=false}else if(this.m[1]!==0||this.m[2]!==0||this.m[3]!==0||this.m[4]!==0||this.m[6]!==0||this.m[7]!==0||this.m[8]!==0||this.m[9]!==0||this.m[11]!==0||this.m[12]!==0||this.m[13]!==0||this.m[14]!==0){this._isIdentity=false}else{this._isIdentity=true}if(!considerAsTextureMatrix&&this.m[10]!==1){this._isIdentity=false}}return this._isIdentity};Matrix.prototype.determinant=function(){var temp1=this.m[10]*this.m[15]-this.m[11]*this.m[14];var temp2=this.m[9]*this.m[15]-this.m[11]*this.m[13];var temp3=this.m[9]*this.m[14]-this.m[10]*this.m[13];var temp4=this.m[8]*this.m[15]-this.m[11]*this.m[12];var temp5=this.m[8]*this.m[14]-this.m[10]*this.m[12];var temp6=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*temp1-this.m[6]*temp2+this.m[7]*temp3)-this.m[1]*(this.m[4]*temp1-this.m[6]*temp4+this.m[7]*temp5)+this.m[2]*(this.m[4]*temp2-this.m[5]*temp4+this.m[7]*temp6)-this.m[3]*(this.m[4]*temp3-this.m[5]*temp5+this.m[6]*temp6)};Matrix.prototype.toArray=function(){return this.m};Matrix.prototype.asArray=function(){return this.toArray()};Matrix.prototype.invert=function(){this.invertToRef(this);return this};Matrix.prototype.reset=function(){for(var index=0;index<16;index++){this.m[index]=0}this._markAsUpdated();return this};Matrix.prototype.add=function(other){var result=new Matrix;this.addToRef(other,result);return result};Matrix.prototype.addToRef=function(other,result){for(var index=0;index<16;index++){result.m[index]=this.m[index]+other.m[index]}result._markAsUpdated();return this};Matrix.prototype.addToSelf=function(other){for(var index=0;index<16;index++){this.m[index]+=other.m[index]}this._markAsUpdated();return this};Matrix.prototype.invertToRef=function(other){var l1=this.m[0];var l2=this.m[1];var l3=this.m[2];var l4=this.m[3];var l5=this.m[4];var l6=this.m[5];var l7=this.m[6];var l8=this.m[7];var l9=this.m[8];var l10=this.m[9];var l11=this.m[10];var l12=this.m[11];var l13=this.m[12];var l14=this.m[13];var l15=this.m[14];var l16=this.m[15];var l17=l11*l16-l12*l15;var l18=l10*l16-l12*l14;var l19=l10*l15-l11*l14;var l20=l9*l16-l12*l13;var l21=l9*l15-l11*l13;var l22=l9*l14-l10*l13;var l23=l6*l17-l7*l18+l8*l19;var l24=-(l5*l17-l7*l20+l8*l21);var l25=l5*l18-l6*l20+l8*l22;var l26=-(l5*l19-l6*l21+l7*l22);var l27=1/(l1*l23+l2*l24+l3*l25+l4*l26);var l28=l7*l16-l8*l15;var l29=l6*l16-l8*l14;var l30=l6*l15-l7*l14;var l31=l5*l16-l8*l13;var l32=l5*l15-l7*l13;var l33=l5*l14-l6*l13;var l34=l7*l12-l8*l11;var l35=l6*l12-l8*l10;var l36=l6*l11-l7*l10;var l37=l5*l12-l8*l9;var l38=l5*l11-l7*l9;var l39=l5*l10-l6*l9;other.m[0]=l23*l27;other.m[4]=l24*l27;other.m[8]=l25*l27;other.m[12]=l26*l27;other.m[1]=-(l2*l17-l3*l18+l4*l19)*l27;other.m[5]=(l1*l17-l3*l20+l4*l21)*l27;other.m[9]=-(l1*l18-l2*l20+l4*l22)*l27;other.m[13]=(l1*l19-l2*l21+l3*l22)*l27;other.m[2]=(l2*l28-l3*l29+l4*l30)*l27;other.m[6]=-(l1*l28-l3*l31+l4*l32)*l27;other.m[10]=(l1*l29-l2*l31+l4*l33)*l27;other.m[14]=-(l1*l30-l2*l32+l3*l33)*l27;other.m[3]=-(l2*l34-l3*l35+l4*l36)*l27;other.m[7]=(l1*l34-l3*l37+l4*l38)*l27;other.m[11]=-(l1*l35-l2*l37+l4*l39)*l27;other.m[15]=(l1*l36-l2*l38+l3*l39)*l27;other._markAsUpdated();return this};Matrix.prototype.setTranslationFromFloats=function(x,y,z){this.m[12]=x;this.m[13]=y;this.m[14]=z;this._markAsUpdated();return this};Matrix.prototype.setTranslation=function(vector3){this.m[12]=vector3.x;this.m[13]=vector3.y;this.m[14]=vector3.z;this._markAsUpdated();return this};Matrix.prototype.getTranslation=function(){return new Vector3(this.m[12],this.m[13],this.m[14])};Matrix.prototype.getTranslationToRef=function(result){result.x=this.m[12];result.y=this.m[13];result.z=this.m[14];return this};Matrix.prototype.removeRotationAndScaling=function(){this.setRowFromFloats(0,1,0,0,0);this.setRowFromFloats(1,0,1,0,0);this.setRowFromFloats(2,0,0,1,0);return this};Matrix.prototype.multiply=function(other){var result=new Matrix;this.multiplyToRef(other,result);return result};Matrix.prototype.copyFrom=function(other){for(var index=0;index<16;index++){this.m[index]=other.m[index]}this._markAsUpdated();return this};Matrix.prototype.copyToArray=function(array,offset){if(offset===void 0){offset=0}for(var index=0;index<16;index++){array[offset+index]=this.m[index]}return this};Matrix.prototype.multiplyToRef=function(other,result){this.multiplyToArray(other,result.m,0);result._markAsUpdated();return this};Matrix.prototype.multiplyToArray=function(other,result,offset){var tm0=this.m[0];var tm1=this.m[1];var tm2=this.m[2];var tm3=this.m[3];var tm4=this.m[4];var tm5=this.m[5];var tm6=this.m[6];var tm7=this.m[7];var tm8=this.m[8];var tm9=this.m[9];var tm10=this.m[10];var tm11=this.m[11];var tm12=this.m[12];var tm13=this.m[13];var tm14=this.m[14];var tm15=this.m[15];var om0=other.m[0];var om1=other.m[1];var om2=other.m[2];var om3=other.m[3];var om4=other.m[4];var om5=other.m[5];var om6=other.m[6];var om7=other.m[7];var om8=other.m[8];var om9=other.m[9];var om10=other.m[10];var om11=other.m[11];var om12=other.m[12];var om13=other.m[13];var om14=other.m[14];var om15=other.m[15];result[offset]=tm0*om0+tm1*om4+tm2*om8+tm3*om12;result[offset+1]=tm0*om1+tm1*om5+tm2*om9+tm3*om13;result[offset+2]=tm0*om2+tm1*om6+tm2*om10+tm3*om14;result[offset+3]=tm0*om3+tm1*om7+tm2*om11+tm3*om15;result[offset+4]=tm4*om0+tm5*om4+tm6*om8+tm7*om12;result[offset+5]=tm4*om1+tm5*om5+tm6*om9+tm7*om13;result[offset+6]=tm4*om2+tm5*om6+tm6*om10+tm7*om14;result[offset+7]=tm4*om3+tm5*om7+tm6*om11+tm7*om15;result[offset+8]=tm8*om0+tm9*om4+tm10*om8+tm11*om12;result[offset+9]=tm8*om1+tm9*om5+tm10*om9+tm11*om13;result[offset+10]=tm8*om2+tm9*om6+tm10*om10+tm11*om14;result[offset+11]=tm8*om3+tm9*om7+tm10*om11+tm11*om15;result[offset+12]=tm12*om0+tm13*om4+tm14*om8+tm15*om12;result[offset+13]=tm12*om1+tm13*om5+tm14*om9+tm15*om13;result[offset+14]=tm12*om2+tm13*om6+tm14*om10+tm15*om14;result[offset+15]=tm12*om3+tm13*om7+tm14*om11+tm15*om15;return this};Matrix.prototype.equals=function(value){return value&&(this.m[0]===value.m[0]&&this.m[1]===value.m[1]&&this.m[2]===value.m[2]&&this.m[3]===value.m[3]&&this.m[4]===value.m[4]&&this.m[5]===value.m[5]&&this.m[6]===value.m[6]&&this.m[7]===value.m[7]&&this.m[8]===value.m[8]&&this.m[9]===value.m[9]&&this.m[10]===value.m[10]&&this.m[11]===value.m[11]&&this.m[12]===value.m[12]&&this.m[13]===value.m[13]&&this.m[14]===value.m[14]&&this.m[15]===value.m[15])};Matrix.prototype.clone=function(){return Matrix.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])};Matrix.prototype.getClassName=function(){return"Matrix"};Matrix.prototype.getHashCode=function(){var hash=this.m[0]||0;for(var i=1;i<16;i++){hash=hash*397^(this.m[i]||0)}return hash};Matrix.prototype.decompose=function(scale,rotation,translation){translation.x=this.m[12];translation.y=this.m[13];translation.z=this.m[14];scale.x=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]+this.m[2]*this.m[2]);scale.y=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]+this.m[6]*this.m[6]);scale.z=Math.sqrt(this.m[8]*this.m[8]+this.m[9]*this.m[9]+this.m[10]*this.m[10]);if(this.determinant()<=0){scale.y*=-1}if(scale.x===0||scale.y===0||scale.z===0){rotation.x=0;rotation.y=0;rotation.z=0;rotation.w=1;return false}Matrix.FromValuesToRef(this.m[0]/scale.x,this.m[1]/scale.x,this.m[2]/scale.x,0,this.m[4]/scale.y,this.m[5]/scale.y,this.m[6]/scale.y,0,this.m[8]/scale.z,this.m[9]/scale.z,this.m[10]/scale.z,0,0,0,0,1,MathTmp.Matrix[0]);Quaternion.FromRotationMatrixToRef(MathTmp.Matrix[0],rotation);return true};Matrix.prototype.getRotationMatrix=function(){var result=Matrix.Identity();this.getRotationMatrixToRef(result);return result};Matrix.prototype.getRotationMatrixToRef=function(result){var m=this.m;var xs=m[0]*m[1]*m[2]*m[3]<0?-1:1;var ys=m[4]*m[5]*m[6]*m[7]<0?-1:1;var zs=m[8]*m[9]*m[10]*m[11]<0?-1:1;var sx=xs*Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]);var sy=ys*Math.sqrt(m[4]*m[4]+m[5]*m[5]+m[6]*m[6]);var sz=zs*Math.sqrt(m[8]*m[8]+m[9]*m[9]+m[10]*m[10]);Matrix.FromValuesToRef(m[0]/sx,m[1]/sx,m[2]/sx,0,m[4]/sy,m[5]/sy,m[6]/sy,0,m[8]/sz,m[9]/sz,m[10]/sz,0,0,0,0,1,result);return this};Matrix.FromArray=function(array,offset){var result=new Matrix;if(!offset){offset=0}Matrix.FromArrayToRef(array,offset,result);return result};Matrix.FromArrayToRef=function(array,offset,result){for(var index=0;index<16;index++){result.m[index]=array[index+offset]}result._markAsUpdated()};Matrix.FromFloat32ArrayToRefScaled=function(array,offset,scale,result){for(var index=0;index<16;index++){result.m[index]=array[index+offset]*scale}result._markAsUpdated()};Matrix.FromValuesToRef=function(initialM11,initialM12,initialM13,initialM14,initialM21,initialM22,initialM23,initialM24,initialM31,initialM32,initialM33,initialM34,initialM41,initialM42,initialM43,initialM44,result){result.m[0]=initialM11;result.m[1]=initialM12;result.m[2]=initialM13;result.m[3]=initialM14;result.m[4]=initialM21;result.m[5]=initialM22;result.m[6]=initialM23;result.m[7]=initialM24;result.m[8]=initialM31;result.m[9]=initialM32;result.m[10]=initialM33;result.m[11]=initialM34;result.m[12]=initialM41;result.m[13]=initialM42;result.m[14]=initialM43;result.m[15]=initialM44;result._markAsUpdated()};Matrix.prototype.getRow=function(index){if(index<0||index>3){return null}var i=index*4;return new Vector4(this.m[i+0],this.m[i+1],this.m[i+2],this.m[i+3])};Matrix.prototype.setRow=function(index,row){if(index<0||index>3){return this}var i=index*4;this.m[i+0]=row.x;this.m[i+1]=row.y;this.m[i+2]=row.z;this.m[i+3]=row.w;this._markAsUpdated();return this};Matrix.prototype.setRowFromFloats=function(index,x,y,z,w){if(index<0||index>3){return this}var i=index*4;this.m[i+0]=x;this.m[i+1]=y;this.m[i+2]=z;this.m[i+3]=w;this._markAsUpdated();return this};Matrix.FromValues=function(initialM11,initialM12,initialM13,initialM14,initialM21,initialM22,initialM23,initialM24,initialM31,initialM32,initialM33,initialM34,initialM41,initialM42,initialM43,initialM44){var result=new Matrix;result.m[0]=initialM11;result.m[1]=initialM12;result.m[2]=initialM13;result.m[3]=initialM14;result.m[4]=initialM21;result.m[5]=initialM22;result.m[6]=initialM23;result.m[7]=initialM24;result.m[8]=initialM31;result.m[9]=initialM32;result.m[10]=initialM33;result.m[11]=initialM34;result.m[12]=initialM41;result.m[13]=initialM42;result.m[14]=initialM43;result.m[15]=initialM44;return result};Matrix.Compose=function(scale,rotation,translation){var result=Matrix.Identity();Matrix.ComposeToRef(scale,rotation,translation,result);return result};Matrix.ComposeToRef=function(scale,rotation,translation,result){Matrix.FromValuesToRef(scale.x,0,0,0,0,scale.y,0,0,0,0,scale.z,0,0,0,0,1,MathTmp.Matrix[1]);rotation.toRotationMatrix(MathTmp.Matrix[0]);MathTmp.Matrix[1].multiplyToRef(MathTmp.Matrix[0],result);result.setTranslation(translation)};Matrix.Identity=function(){return Matrix.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};Matrix.IdentityToRef=function(result){Matrix.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,result)};Matrix.Zero=function(){return Matrix.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)};Matrix.RotationX=function(angle){var result=new Matrix;Matrix.RotationXToRef(angle,result);return result};Matrix.Invert=function(source){var result=new Matrix;source.invertToRef(result);return result};Matrix.RotationXToRef=function(angle,result){var s=Math.sin(angle);var c=Math.cos(angle);result.m[0]=1;result.m[15]=1;result.m[5]=c;result.m[10]=c;result.m[9]=-s;result.m[6]=s;result.m[1]=0;result.m[2]=0;result.m[3]=0;result.m[4]=0;result.m[7]=0;result.m[8]=0;result.m[11]=0;result.m[12]=0;result.m[13]=0;result.m[14]=0;result._markAsUpdated()};Matrix.RotationY=function(angle){var result=new Matrix;Matrix.RotationYToRef(angle,result);return result};Matrix.RotationYToRef=function(angle,result){var s=Math.sin(angle);var c=Math.cos(angle);result.m[5]=1;result.m[15]=1;result.m[0]=c;result.m[2]=-s;result.m[8]=s;result.m[10]=c;result.m[1]=0;result.m[3]=0;result.m[4]=0;result.m[6]=0;result.m[7]=0;result.m[9]=0;result.m[11]=0;result.m[12]=0;result.m[13]=0;result.m[14]=0;result._markAsUpdated()};Matrix.RotationZ=function(angle){var result=new Matrix;Matrix.RotationZToRef(angle,result);return result};Matrix.RotationZToRef=function(angle,result){var s=Math.sin(angle);var c=Math.cos(angle);result.m[10]=1;result.m[15]=1;result.m[0]=c;result.m[1]=s;result.m[4]=-s;result.m[5]=c;result.m[2]=0;result.m[3]=0;result.m[6]=0;result.m[7]=0;result.m[8]=0;result.m[9]=0;result.m[11]=0;result.m[12]=0;result.m[13]=0;result.m[14]=0;result._markAsUpdated()};Matrix.RotationAxis=function(axis,angle){var result=Matrix.Zero();Matrix.RotationAxisToRef(axis,angle,result);return result};Matrix.RotationAxisToRef=function(axis,angle,result){var s=Math.sin(-angle);var c=Math.cos(-angle);var c1=1-c;axis.normalize();result.m[0]=axis.x*axis.x*c1+c;result.m[1]=axis.x*axis.y*c1-axis.z*s;result.m[2]=axis.x*axis.z*c1+axis.y*s;result.m[3]=0;result.m[4]=axis.y*axis.x*c1+axis.z*s;result.m[5]=axis.y*axis.y*c1+c;result.m[6]=axis.y*axis.z*c1-axis.x*s;result.m[7]=0;result.m[8]=axis.z*axis.x*c1-axis.y*s;result.m[9]=axis.z*axis.y*c1+axis.x*s;result.m[10]=axis.z*axis.z*c1+c;result.m[11]=0;result.m[15]=1;result._markAsUpdated()};Matrix.RotationYawPitchRoll=function(yaw,pitch,roll){var result=new Matrix;Matrix.RotationYawPitchRollToRef(yaw,pitch,roll,result);return result};Matrix.RotationYawPitchRollToRef=function(yaw,pitch,roll,result){Quaternion.RotationYawPitchRollToRef(yaw,pitch,roll,this._tempQuaternion);this._tempQuaternion.toRotationMatrix(result)};Matrix.Scaling=function(x,y,z){var result=Matrix.Zero();Matrix.ScalingToRef(x,y,z,result);return result};Matrix.ScalingToRef=function(x,y,z,result){result.m[0]=x;result.m[1]=0;result.m[2]=0;result.m[3]=0;result.m[4]=0;result.m[5]=y;result.m[6]=0;result.m[7]=0;result.m[8]=0;result.m[9]=0;result.m[10]=z;result.m[11]=0;result.m[12]=0;result.m[13]=0;result.m[14]=0;result.m[15]=1;result._markAsUpdated()};Matrix.Translation=function(x,y,z){var result=Matrix.Identity();Matrix.TranslationToRef(x,y,z,result);return result};Matrix.TranslationToRef=function(x,y,z,result){Matrix.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,x,y,z,1,result)};Matrix.Lerp=function(startValue,endValue,gradient){var result=Matrix.Zero();for(var index=0;index<16;index++){result.m[index]=startValue.m[index]*(1-gradient)+endValue.m[index]*gradient}result._markAsUpdated();return result};Matrix.DecomposeLerp=function(startValue,endValue,gradient){var startScale=new Vector3(0,0,0);var startRotation=new Quaternion;var startTranslation=new Vector3(0,0,0);startValue.decompose(startScale,startRotation,startTranslation);var endScale=new Vector3(0,0,0);var endRotation=new Quaternion;var endTranslation=new Vector3(0,0,0);endValue.decompose(endScale,endRotation,endTranslation);var resultScale=Vector3.Lerp(startScale,endScale,gradient);var resultRotation=Quaternion.Slerp(startRotation,endRotation,gradient);var resultTranslation=Vector3.Lerp(startTranslation,endTranslation,gradient);return Matrix.Compose(resultScale,resultRotation,resultTranslation)};Matrix.LookAtLH=function(eye,target,up){var result=Matrix.Zero();Matrix.LookAtLHToRef(eye,target,up,result);return result};Matrix.LookAtLHToRef=function(eye,target,up,result){target.subtractToRef(eye,this._zAxis);this._zAxis.normalize();Vector3.CrossToRef(up,this._zAxis,this._xAxis);if(this._xAxis.lengthSquared()===0){this._xAxis.x=1}else{this._xAxis.normalize()}Vector3.CrossToRef(this._zAxis,this._xAxis,this._yAxis);this._yAxis.normalize();var ex=-Vector3.Dot(this._xAxis,eye);var ey=-Vector3.Dot(this._yAxis,eye);var ez=-Vector3.Dot(this._zAxis,eye);return Matrix.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,ex,ey,ez,1,result)};Matrix.LookAtRH=function(eye,target,up){var result=Matrix.Zero();Matrix.LookAtRHToRef(eye,target,up,result);return result};Matrix.LookAtRHToRef=function(eye,target,up,result){eye.subtractToRef(target,this._zAxis);this._zAxis.normalize();Vector3.CrossToRef(up,this._zAxis,this._xAxis);if(this._xAxis.lengthSquared()===0){this._xAxis.x=1}else{this._xAxis.normalize()}Vector3.CrossToRef(this._zAxis,this._xAxis,this._yAxis);this._yAxis.normalize();var ex=-Vector3.Dot(this._xAxis,eye);var ey=-Vector3.Dot(this._yAxis,eye);var ez=-Vector3.Dot(this._zAxis,eye);return Matrix.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,ex,ey,ez,1,result)};Matrix.OrthoLH=function(width,height,znear,zfar){var matrix=Matrix.Zero();Matrix.OrthoLHToRef(width,height,znear,zfar,matrix);return matrix};Matrix.OrthoLHToRef=function(width,height,znear,zfar,result){var n=znear;var f=zfar;var a=2/width;var b=2/height;var c=2/(f-n);var d=-(f+n)/(f-n);BABYLON.Matrix.FromValuesToRef(a,0,0,0,0,b,0,0,0,0,c,0,0,0,d,1,result)};Matrix.OrthoOffCenterLH=function(left,right,bottom,top,znear,zfar){var matrix=Matrix.Zero();Matrix.OrthoOffCenterLHToRef(left,right,bottom,top,znear,zfar,matrix);return matrix};Matrix.OrthoOffCenterLHToRef=function(left,right,bottom,top,znear,zfar,result){var n=znear;var f=zfar;var a=2/(right-left);var b=2/(top-bottom);var c=2/(f-n);var d=-(f+n)/(f-n);var i0=(left+right)/(left-right);var i1=(top+bottom)/(bottom-top);BABYLON.Matrix.FromValuesToRef(a,0,0,0,0,b,0,0,0,0,c,0,i0,i1,d,1,result)};Matrix.OrthoOffCenterRH=function(left,right,bottom,top,znear,zfar){var matrix=Matrix.Zero();Matrix.OrthoOffCenterRHToRef(left,right,bottom,top,znear,zfar,matrix);return matrix};Matrix.OrthoOffCenterRHToRef=function(left,right,bottom,top,znear,zfar,result){Matrix.OrthoOffCenterLHToRef(left,right,bottom,top,znear,zfar,result);result.m[10]*=-1};Matrix.PerspectiveLH=function(width,height,znear,zfar){var matrix=Matrix.Zero();var n=znear;var f=zfar;var a=2*n/width;var b=2*n/height;var c=(f+n)/(f-n);var d=-2*f*n/(f-n);BABYLON.Matrix.FromValuesToRef(a,0,0,0,0,b,0,0,0,0,c,1,0,0,d,0,matrix);return matrix};Matrix.PerspectiveFovLH=function(fov,aspect,znear,zfar){var matrix=Matrix.Zero();Matrix.PerspectiveFovLHToRef(fov,aspect,znear,zfar,matrix);return matrix};Matrix.PerspectiveFovLHToRef=function(fov,aspect,znear,zfar,result,isVerticalFovFixed){if(isVerticalFovFixed===void 0){isVerticalFovFixed=true}var n=znear;var f=zfar;var t=1/Math.tan(fov*.5);var a=isVerticalFovFixed?t/aspect:t;var b=isVerticalFovFixed?t:t*aspect;var c=(f+n)/(f-n);var d=-2*f*n/(f-n);BABYLON.Matrix.FromValuesToRef(a,0,0,0,0,b,0,0,0,0,c,1,0,0,d,0,result)};Matrix.PerspectiveFovRH=function(fov,aspect,znear,zfar){var matrix=Matrix.Zero();Matrix.PerspectiveFovRHToRef(fov,aspect,znear,zfar,matrix);return matrix};Matrix.PerspectiveFovRHToRef=function(fov,aspect,znear,zfar,result,isVerticalFovFixed){if(isVerticalFovFixed===void 0){isVerticalFovFixed=true}var n=znear;var f=zfar;var t=1/Math.tan(fov*.5);var a=isVerticalFovFixed?t/aspect:t;var b=isVerticalFovFixed?t:t*aspect;var c=-(f+n)/(f-n);var d=-2*f*n/(f-n);BABYLON.Matrix.FromValuesToRef(a,0,0,0,0,b,0,0,0,0,c,-1,0,0,d,0,result)};Matrix.PerspectiveFovWebVRToRef=function(fov,znear,zfar,result,rightHanded){if(rightHanded===void 0){rightHanded=false}var rightHandedFactor=rightHanded?-1:1;var upTan=Math.tan(fov.upDegrees*Math.PI/180);var downTan=Math.tan(fov.downDegrees*Math.PI/180);var leftTan=Math.tan(fov.leftDegrees*Math.PI/180);var rightTan=Math.tan(fov.rightDegrees*Math.PI/180);var xScale=2/(leftTan+rightTan);var yScale=2/(upTan+downTan);result.m[0]=xScale;result.m[1]=result.m[2]=result.m[3]=result.m[4]=0;result.m[5]=yScale;result.m[6]=result.m[7]=0;result.m[8]=(leftTan-rightTan)*xScale*.5;result.m[9]=-((upTan-downTan)*yScale*.5);result.m[10]=-zfar/(znear-zfar);result.m[11]=1*rightHandedFactor;result.m[12]=result.m[13]=result.m[15]=0;result.m[14]=-(2*zfar*znear)/(zfar-znear);result._markAsUpdated()};Matrix.GetFinalMatrix=function(viewport,world,view,projection,zmin,zmax){var cw=viewport.width;var ch=viewport.height;var cx=viewport.x;var cy=viewport.y;var viewportMatrix=Matrix.FromValues(cw/2,0,0,0,0,-ch/2,0,0,0,0,zmax-zmin,0,cx+cw/2,ch/2+cy,zmin,1);return world.multiply(view).multiply(projection).multiply(viewportMatrix)};Matrix.GetAsMatrix2x2=function(matrix){return new Float32Array([matrix.m[0],matrix.m[1],matrix.m[4],matrix.m[5]])};Matrix.GetAsMatrix3x3=function(matrix){return new Float32Array([matrix.m[0],matrix.m[1],matrix.m[2],matrix.m[4],matrix.m[5],matrix.m[6],matrix.m[8],matrix.m[9],matrix.m[10]])};Matrix.Transpose=function(matrix){var result=new Matrix;result.m[0]=matrix.m[0];result.m[1]=matrix.m[4];result.m[2]=matrix.m[8];result.m[3]=matrix.m[12];result.m[4]=matrix.m[1];result.m[5]=matrix.m[5];result.m[6]=matrix.m[9];result.m[7]=matrix.m[13];result.m[8]=matrix.m[2];result.m[9]=matrix.m[6];result.m[10]=matrix.m[10];result.m[11]=matrix.m[14];result.m[12]=matrix.m[3];result.m[13]=matrix.m[7];result.m[14]=matrix.m[11];result.m[15]=matrix.m[15];return result};Matrix.Reflection=function(plane){var matrix=new Matrix;Matrix.ReflectionToRef(plane,matrix);return matrix};Matrix.ReflectionToRef=function(plane,result){plane.normalize();var x=plane.normal.x;var y=plane.normal.y;var z=plane.normal.z;var temp=-2*x;var temp2=-2*y;var temp3=-2*z;result.m[0]=temp*x+1;result.m[1]=temp2*x;result.m[2]=temp3*x;result.m[3]=0;result.m[4]=temp*y;result.m[5]=temp2*y+1;result.m[6]=temp3*y;result.m[7]=0;result.m[8]=temp*z;result.m[9]=temp2*z;result.m[10]=temp3*z+1;result.m[11]=0;result.m[12]=temp*plane.d;result.m[13]=temp2*plane.d;result.m[14]=temp3*plane.d;result.m[15]=1;result._markAsUpdated()};Matrix.FromXYZAxesToRef=function(xaxis,yaxis,zaxis,result){result.m[0]=xaxis.x;result.m[1]=xaxis.y;result.m[2]=xaxis.z;result.m[3]=0;result.m[4]=yaxis.x;result.m[5]=yaxis.y;result.m[6]=yaxis.z;result.m[7]=0;result.m[8]=zaxis.x;result.m[9]=zaxis.y;result.m[10]=zaxis.z;result.m[11]=0;result.m[12]=0;result.m[13]=0;result.m[14]=0;result.m[15]=1;result._markAsUpdated()};Matrix.FromQuaternionToRef=function(quat,result){var xx=quat.x*quat.x;var yy=quat.y*quat.y;var zz=quat.z*quat.z;var xy=quat.x*quat.y;var zw=quat.z*quat.w;var zx=quat.z*quat.x;var yw=quat.y*quat.w;var yz=quat.y*quat.z;var xw=quat.x*quat.w;result.m[0]=1-2*(yy+zz);result.m[1]=2*(xy+zw);result.m[2]=2*(zx-yw);result.m[3]=0;result.m[4]=2*(xy-zw);result.m[5]=1-2*(zz+xx);result.m[6]=2*(yz+xw);result.m[7]=0;result.m[8]=2*(zx+yw);result.m[9]=2*(yz-xw);result.m[10]=1-2*(yy+xx);result.m[11]=0;result.m[12]=0;result.m[13]=0;result.m[14]=0;result.m[15]=1;result._markAsUpdated()};Matrix._tempQuaternion=new Quaternion;Matrix._xAxis=Vector3.Zero();Matrix._yAxis=Vector3.Zero();Matrix._zAxis=Vector3.Zero();Matrix._updateFlagSeed=0;return Matrix}();BABYLON.Matrix=Matrix;var Plane=function(){function Plane(a,b,c,d){this.normal=new Vector3(a,b,c);this.d=d}Plane.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]};Plane.prototype.clone=function(){return new Plane(this.normal.x,this.normal.y,this.normal.z,this.d)};Plane.prototype.getClassName=function(){return"Plane"};Plane.prototype.getHashCode=function(){var hash=this.normal.getHashCode();hash=hash*397^(this.d||0);return hash};Plane.prototype.normalize=function(){var norm=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);var magnitude=0;if(norm!==0){magnitude=1/norm}this.normal.x*=magnitude;this.normal.y*=magnitude;this.normal.z*=magnitude;this.d*=magnitude;return this};Plane.prototype.transform=function(transformation){var transposedMatrix=Matrix.Transpose(transformation);var x=this.normal.x;var y=this.normal.y;var z=this.normal.z;var d=this.d;var normalX=x*transposedMatrix.m[0]+y*transposedMatrix.m[1]+z*transposedMatrix.m[2]+d*transposedMatrix.m[3];var normalY=x*transposedMatrix.m[4]+y*transposedMatrix.m[5]+z*transposedMatrix.m[6]+d*transposedMatrix.m[7];var normalZ=x*transposedMatrix.m[8]+y*transposedMatrix.m[9]+z*transposedMatrix.m[10]+d*transposedMatrix.m[11];var finalD=x*transposedMatrix.m[12]+y*transposedMatrix.m[13]+z*transposedMatrix.m[14]+d*transposedMatrix.m[15];return new Plane(normalX,normalY,normalZ,finalD)};Plane.prototype.dotCoordinate=function(point){return this.normal.x*point.x+this.normal.y*point.y+this.normal.z*point.z+this.d};Plane.prototype.copyFromPoints=function(point1,point2,point3){var x1=point2.x-point1.x;var y1=point2.y-point1.y;var z1=point2.z-point1.z;var x2=point3.x-point1.x;var y2=point3.y-point1.y;var z2=point3.z-point1.z;var yz=y1*z2-z1*y2;var xz=z1*x2-x1*z2;var xy=x1*y2-y1*x2;var pyth=Math.sqrt(yz*yz+xz*xz+xy*xy);var invPyth;if(pyth!==0){invPyth=1/pyth}else{invPyth=0}this.normal.x=yz*invPyth;this.normal.y=xz*invPyth;this.normal.z=xy*invPyth;this.d=-(this.normal.x*point1.x+this.normal.y*point1.y+this.normal.z*point1.z);return this};Plane.prototype.isFrontFacingTo=function(direction,epsilon){var dot=Vector3.Dot(this.normal,direction);return dot<=epsilon};Plane.prototype.signedDistanceTo=function(point){return Vector3.Dot(point,this.normal)+this.d};Plane.FromArray=function(array){return new Plane(array[0],array[1],array[2],array[3])};Plane.FromPoints=function(point1,point2,point3){var result=new Plane(0,0,0,0);result.copyFromPoints(point1,point2,point3);return result};Plane.FromPositionAndNormal=function(origin,normal){var result=new Plane(0,0,0,0);normal.normalize();result.normal=normal;result.d=-(normal.x*origin.x+normal.y*origin.y+normal.z*origin.z);return result};Plane.SignedDistanceToPlaneFromPositionAndNormal=function(origin,normal,point){var d=-(normal.x*origin.x+normal.y*origin.y+normal.z*origin.z);return Vector3.Dot(point,normal)+d};return Plane}();BABYLON.Plane=Plane;var Viewport=function(){function Viewport(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height}Viewport.prototype.toGlobal=function(renderWidthOrEngine,renderHeight){if(renderWidthOrEngine.getRenderWidth){var engine=renderWidthOrEngine;return this.toGlobal(engine.getRenderWidth(),engine.getRenderHeight())}var renderWidth=renderWidthOrEngine;return new Viewport(this.x*renderWidth,this.y*renderHeight,this.width*renderWidth,this.height*renderHeight)};Viewport.prototype.clone=function(){return new Viewport(this.x,this.y,this.width,this.height)};return Viewport}();BABYLON.Viewport=Viewport;var Frustum=function(){function Frustum(){}Frustum.GetPlanes=function(transform){var frustumPlanes=[];for(var index=0;index<6;index++){frustumPlanes.push(new Plane(0,0,0,0))}Frustum.GetPlanesToRef(transform,frustumPlanes);return frustumPlanes};Frustum.GetNearPlaneToRef=function(transform,frustumPlane){frustumPlane.normal.x=transform.m[3]+transform.m[2];frustumPlane.normal.y=transform.m[7]+transform.m[6];frustumPlane.normal.z=transform.m[11]+transform.m[10];frustumPlane.d=transform.m[15]+transform.m[14];frustumPlane.normalize()};Frustum.GetFarPlaneToRef=function(transform,frustumPlane){frustumPlane.normal.x=transform.m[3]-transform.m[2];frustumPlane.normal.y=transform.m[7]-transform.m[6];frustumPlane.normal.z=transform.m[11]-transform.m[10];frustumPlane.d=transform.m[15]-transform.m[14];frustumPlane.normalize()};Frustum.GetLeftPlaneToRef=function(transform,frustumPlane){frustumPlane.normal.x=transform.m[3]+transform.m[0];frustumPlane.normal.y=transform.m[7]+transform.m[4];frustumPlane.normal.z=transform.m[11]+transform.m[8];frustumPlane.d=transform.m[15]+transform.m[12];frustumPlane.normalize()};Frustum.GetRightPlaneToRef=function(transform,frustumPlane){frustumPlane.normal.x=transform.m[3]-transform.m[0];frustumPlane.normal.y=transform.m[7]-transform.m[4];frustumPlane.normal.z=transform.m[11]-transform.m[8];frustumPlane.d=transform.m[15]-transform.m[12];frustumPlane.normalize()};Frustum.GetTopPlaneToRef=function(transform,frustumPlane){frustumPlane.normal.x=transform.m[3]-transform.m[1];frustumPlane.normal.y=transform.m[7]-transform.m[5];frustumPlane.normal.z=transform.m[11]-transform.m[9];frustumPlane.d=transform.m[15]-transform.m[13];frustumPlane.normalize()};Frustum.GetBottomPlaneToRef=function(transform,frustumPlane){frustumPlane.normal.x=transform.m[3]+transform.m[1];frustumPlane.normal.y=transform.m[7]+transform.m[5];frustumPlane.normal.z=transform.m[11]+transform.m[9];frustumPlane.d=transform.m[15]+transform.m[13];frustumPlane.normalize()};Frustum.GetPlanesToRef=function(transform,frustumPlanes){Frustum.GetNearPlaneToRef(transform,frustumPlanes[0]);Frustum.GetFarPlaneToRef(transform,frustumPlanes[1]);Frustum.GetLeftPlaneToRef(transform,frustumPlanes[2]);Frustum.GetRightPlaneToRef(transform,frustumPlanes[3]);Frustum.GetTopPlaneToRef(transform,frustumPlanes[4]);Frustum.GetBottomPlaneToRef(transform,frustumPlanes[5])};return Frustum}();BABYLON.Frustum=Frustum;var Space;(function(Space){Space[Space["LOCAL"]=0]="LOCAL";Space[Space["WORLD"]=1]="WORLD";Space[Space["BONE"]=2]="BONE"})(Space=BABYLON.Space||(BABYLON.Space={}));var Axis=function(){function Axis(){}Axis.X=new Vector3(1,0,0);Axis.Y=new Vector3(0,1,0);Axis.Z=new Vector3(0,0,1);return Axis}();BABYLON.Axis=Axis;var BezierCurve=function(){function BezierCurve(){}BezierCurve.interpolate=function(t,x1,y1,x2,y2){var f0=1-3*x2+3*x1;var f1=3*x2-6*x1;var f2=3*x1;var refinedT=t;for(var i=0;i<5;i++){var refinedT2=refinedT*refinedT;var refinedT3=refinedT2*refinedT;var x=f0*refinedT3+f1*refinedT2+f2*refinedT;var slope=1/(3*f0*refinedT2+2*f1*refinedT+f2);refinedT-=(x-t)*slope;refinedT=Math.min(1,Math.max(0,refinedT))}return 3*Math.pow(1-refinedT,2)*refinedT*y1+3*(1-refinedT)*Math.pow(refinedT,2)*y2+Math.pow(refinedT,3)};return BezierCurve}();BABYLON.BezierCurve=BezierCurve;var Orientation;(function(Orientation){Orientation[Orientation["CW"]=0]="CW";Orientation[Orientation["CCW"]=1]="CCW"})(Orientation=BABYLON.Orientation||(BABYLON.Orientation={}));var Angle=function(){function Angle(radians){var _this=this;this.degrees=function(){return _this._radians*180/Math.PI};this.radians=function(){return _this._radians};this._radians=radians;if(this._radians<0)this._radians+=2*Math.PI}Angle.BetweenTwoPoints=function(a,b){var delta=b.subtract(a);var theta=Math.atan2(delta.y,delta.x);return new Angle(theta)};Angle.FromRadians=function(radians){return new Angle(radians)};Angle.FromDegrees=function(degrees){return new Angle(degrees*Math.PI/180)};return Angle}();BABYLON.Angle=Angle;var Arc2=function(){function Arc2(startPoint,midPoint,endPoint){this.startPoint=startPoint;this.midPoint=midPoint;this.endPoint=endPoint;var temp=Math.pow(midPoint.x,2)+Math.pow(midPoint.y,2);var startToMid=(Math.pow(startPoint.x,2)+Math.pow(startPoint.y,2)-temp)/2;var midToEnd=(temp-Math.pow(endPoint.x,2)-Math.pow(endPoint.y,2))/2;var det=(startPoint.x-midPoint.x)*(midPoint.y-endPoint.y)-(midPoint.x-endPoint.x)*(startPoint.y-midPoint.y);this.centerPoint=new Vector2((startToMid*(midPoint.y-endPoint.y)-midToEnd*(startPoint.y-midPoint.y))/det,((startPoint.x-midPoint.x)*midToEnd-(midPoint.x-endPoint.x)*startToMid)/det);this.radius=this.centerPoint.subtract(this.startPoint).length();this.startAngle=Angle.BetweenTwoPoints(this.centerPoint,this.startPoint);var a1=this.startAngle.degrees();var a2=Angle.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees();var a3=Angle.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();if(a2-a1>+180)a2-=360;if(a2-a1<-180)a2+=360;if(a3-a2>+180)a3-=360;if(a3-a2<-180)a3+=360;this.orientation=a2-a1<0?Orientation.CW:Orientation.CCW;this.angle=Angle.FromDegrees(this.orientation===Orientation.CW?a1-a3:a3-a1)}return Arc2}();BABYLON.Arc2=Arc2;var Path2=function(){function Path2(x,y){this._points=new Array;this._length=0;this.closed=false;this._points.push(new Vector2(x,y))}Path2.prototype.addLineTo=function(x,y){if(closed){return this}var newPoint=new Vector2(x,y);var previousPoint=this._points[this._points.length-1];this._points.push(newPoint);this._length+=newPoint.subtract(previousPoint).length();return this};Path2.prototype.addArcTo=function(midX,midY,endX,endY,numberOfSegments){if(numberOfSegments===void 0){numberOfSegments=36}if(closed){return this}var startPoint=this._points[this._points.length-1];var midPoint=new Vector2(midX,midY);var endPoint=new Vector2(endX,endY);var arc=new Arc2(startPoint,midPoint,endPoint);var increment=arc.angle.radians()/numberOfSegments;if(arc.orientation===Orientation.CW)increment*=-1;var currentAngle=arc.startAngle.radians()+increment;for(var i=0;i<numberOfSegments;i++){var x=Math.cos(currentAngle)*arc.radius+arc.centerPoint.x;var y=Math.sin(currentAngle)*arc.radius+arc.centerPoint.y;this.addLineTo(x,y);currentAngle+=increment}return this};Path2.prototype.close=function(){this.closed=true;return this};Path2.prototype.length=function(){var result=this._length;if(!this.closed){var lastPoint=this._points[this._points.length-1];var firstPoint=this._points[0];result+=firstPoint.subtract(lastPoint).length()}return result};Path2.prototype.getPoints=function(){return this._points};Path2.prototype.getPointAtLengthPosition=function(normalizedLengthPosition){if(normalizedLengthPosition<0||normalizedLengthPosition>1){return Vector2.Zero()}var lengthPosition=normalizedLengthPosition*this.length();var previousOffset=0;for(var i=0;i<this._points.length;i++){var j=(i+1)%this._points.length;var a=this._points[i];var b=this._points[j];var bToA=b.subtract(a);var nextOffset=bToA.length()+previousOffset;if(lengthPosition>=previousOffset&&lengthPosition<=nextOffset){var dir=bToA.normalize();var localOffset=lengthPosition-previousOffset;return new Vector2(a.x+dir.x*localOffset,a.y+dir.y*localOffset)}previousOffset=nextOffset}return Vector2.Zero()};Path2.StartingAt=function(x,y){return new Path2(x,y)};return Path2}();BABYLON.Path2=Path2;var Path3D=function(){function Path3D(path,firstNormal,raw){this.path=path;this._curve=new Array;this._distances=new Array;this._tangents=new Array;this._normals=new Array;this._binormals=new Array;for(var p=0;p<path.length;p++){this._curve[p]=path[p].clone()}this._raw=raw||false;this._compute(firstNormal)}Path3D.prototype.getCurve=function(){return this._curve};Path3D.prototype.getTangents=function(){return this._tangents};Path3D.prototype.getNormals=function(){return this._normals};Path3D.prototype.getBinormals=function(){return this._binormals};Path3D.prototype.getDistances=function(){return this._distances};Path3D.prototype.update=function(path,firstNormal){for(var p=0;p<path.length;p++){this._curve[p].x=path[p].x;this._curve[p].y=path[p].y;this._curve[p].z=path[p].z}this._compute(firstNormal);return this};Path3D.prototype._compute=function(firstNormal){var l=this._curve.length;this._tangents[0]=this._getFirstNonNullVector(0);if(!this._raw){this._tangents[0].normalize()}this._tangents[l-1]=this._curve[l-1].subtract(this._curve[l-2]);if(!this._raw){this._tangents[l-1].normalize()}var tg0=this._tangents[0];var pp0=this._normalVector(this._curve[0],tg0,firstNormal);this._normals[0]=pp0;if(!this._raw){this._normals[0].normalize()}this._binormals[0]=Vector3.Cross(tg0,this._normals[0]);if(!this._raw){this._binormals[0].normalize()}this._distances[0]=0;var prev;var cur;var curTang;var prevBinor;for(var i=1;i<l;i++){prev=this._getLastNonNullVector(i);if(i<l-1){cur=this._getFirstNonNullVector(i);this._tangents[i]=prev.add(cur);this._tangents[i].normalize()}this._distances[i]=this._distances[i-1]+prev.length();curTang=this._tangents[i];prevBinor=this._binormals[i-1];this._normals[i]=Vector3.Cross(prevBinor,curTang);if(!this._raw){this._normals[i].normalize()}this._binormals[i]=Vector3.Cross(curTang,this._normals[i]);if(!this._raw){this._binormals[i].normalize()}}};Path3D.prototype._getFirstNonNullVector=function(index){var i=1;var nNVector=this._curve[index+i].subtract(this._curve[index]);while(nNVector.length()===0&&index+i+1<this._curve.length){i++;nNVector=this._curve[index+i].subtract(this._curve[index])}return nNVector};Path3D.prototype._getLastNonNullVector=function(index){var i=1;var nLVector=this._curve[index].subtract(this._curve[index-i]);while(nLVector.length()===0&&index>i+1){i++;nLVector=this._curve[index].subtract(this._curve[index-i])}return nLVector};Path3D.prototype._normalVector=function(v0,vt,va){var normal0;var tgl=vt.length();if(tgl===0){tgl=1}if(va===undefined||va===null){var point;if(!BABYLON.Scalar.WithinEpsilon(Math.abs(vt.y)/tgl,1,BABYLON.Epsilon)){point=new Vector3(0,-1,0)}else if(!BABYLON.Scalar.WithinEpsilon(Math.abs(vt.x)/tgl,1,BABYLON.Epsilon)){point=new Vector3(1,0,0)}else if(!BABYLON.Scalar.WithinEpsilon(Math.abs(vt.z)/tgl,1,BABYLON.Epsilon)){point=new Vector3(0,0,1)}normal0=Vector3.Cross(vt,point)}else{normal0=Vector3.Cross(vt,va);Vector3.CrossToRef(normal0,vt,normal0)}normal0.normalize();return normal0};return Path3D}();BABYLON.Path3D=Path3D;var Curve3=function(){function Curve3(points){this._length=0;this._points=points;this._length=this._computeLength(points)}Curve3.CreateQuadraticBezier=function(v0,v1,v2,nbPoints){nbPoints=nbPoints>2?nbPoints:3;var bez=new Array;var equation=function(t,val0,val1,val2){var res=(1-t)*(1-t)*val0+2*t*(1-t)*val1+t*t*val2;return res};for(var i=0;i<=nbPoints;i++){bez.push(new Vector3(equation(i/nbPoints,v0.x,v1.x,v2.x),equation(i/nbPoints,v0.y,v1.y,v2.y),equation(i/nbPoints,v0.z,v1.z,v2.z)))}return new Curve3(bez)};Curve3.CreateCubicBezier=function(v0,v1,v2,v3,nbPoints){nbPoints=nbPoints>3?nbPoints:4;var bez=new Array;var equation=function(t,val0,val1,val2,val3){var res=(1-t)*(1-t)*(1-t)*val0+3*t*(1-t)*(1-t)*val1+3*t*t*(1-t)*val2+t*t*t*val3;return res};for(var i=0;i<=nbPoints;i++){bez.push(new Vector3(equation(i/nbPoints,v0.x,v1.x,v2.x,v3.x),equation(i/nbPoints,v0.y,v1.y,v2.y,v3.y),equation(i/nbPoints,v0.z,v1.z,v2.z,v3.z)))}return new Curve3(bez)};Curve3.CreateHermiteSpline=function(p1,t1,p2,t2,nbPoints){var hermite=new Array;var step=1/nbPoints;for(var i=0;i<=nbPoints;i++){hermite.push(Vector3.Hermite(p1,t1,p2,t2,i*step))}return new Curve3(hermite)};Curve3.CreateCatmullRomSpline=function(points,nbPoints){var totalPoints=new Array;totalPoints.push(points[0].clone());Array.prototype.push.apply(totalPoints,points);totalPoints.push(points[points.length-1].clone());var catmullRom=new Array;var step=1/nbPoints;for(var i=0;i<totalPoints.length-3;i++){var amount=0;for(var c=0;c<nbPoints;c++){catmullRom.push(Vector3.CatmullRom(totalPoints[i],totalPoints[i+1],totalPoints[i+2],totalPoints[i+3],amount));amount+=step}}i--;catmullRom.push(Vector3.CatmullRom(totalPoints[i],totalPoints[i+1],totalPoints[i+2],totalPoints[i+3],amount));return new Curve3(catmullRom)};Curve3.prototype.getPoints=function(){return this._points};Curve3.prototype.length=function(){return this._length};Curve3.prototype.continue=function(curve){var lastPoint=this._points[this._points.length-1];var continuedPoints=this._points.slice();var curvePoints=curve.getPoints();for(var i=1;i<curvePoints.length;i++){continuedPoints.push(curvePoints[i].subtract(curvePoints[0]).add(lastPoint))}var continuedCurve=new Curve3(continuedPoints);return continuedCurve};Curve3.prototype._computeLength=function(path){var l=0;for(var i=1;i<path.length;i++){l+=path[i].subtract(path[i-1]).length()}return l};return Curve3}();BABYLON.Curve3=Curve3;var PositionNormalVertex=function(){function PositionNormalVertex(position,normal){if(position===void 0){position=Vector3.Zero()}if(normal===void 0){normal=Vector3.Up()}this.position=position;this.normal=normal}PositionNormalVertex.prototype.clone=function(){return new PositionNormalVertex(this.position.clone(),this.normal.clone())};return PositionNormalVertex}();BABYLON.PositionNormalVertex=PositionNormalVertex;var PositionNormalTextureVertex=function(){function PositionNormalTextureVertex(position,normal,uv){if(position===void 0){position=Vector3.Zero()}if(normal===void 0){normal=Vector3.Up()}if(uv===void 0){uv=Vector2.Zero()}this.position=position;this.normal=normal;this.uv=uv}PositionNormalTextureVertex.prototype.clone=function(){return new PositionNormalTextureVertex(this.position.clone(),this.normal.clone(),this.uv.clone())};return PositionNormalTextureVertex}();BABYLON.PositionNormalTextureVertex=PositionNormalTextureVertex;var Tmp=function(){function Tmp(){}Tmp.Color3=[Color3.Black(),Color3.Black(),Color3.Black()];Tmp.Vector2=[Vector2.Zero(),Vector2.Zero(),Vector2.Zero()];Tmp.Vector3=[Vector3.Zero(),Vector3.Zero(),Vector3.Zero(),Vector3.Zero(),Vector3.Zero(),Vector3.Zero(),Vector3.Zero(),Vector3.Zero(),Vector3.Zero()];Tmp.Vector4=[Vector4.Zero(),Vector4.Zero(),Vector4.Zero()];Tmp.Quaternion=[Quaternion.Zero(),Quaternion.Zero()];Tmp.Matrix=[Matrix.Zero(),Matrix.Zero(),Matrix.Zero(),Matrix.Zero(),Matrix.Zero(),Matrix.Zero(),Matrix.Zero(),Matrix.Zero()];return Tmp}();BABYLON.Tmp=Tmp;var MathTmp=function(){function MathTmp(){}MathTmp.Vector3=[Vector3.Zero()];MathTmp.Matrix=[Matrix.Zero(),Matrix.Zero()];MathTmp.Quaternion=[Quaternion.Zero()];return MathTmp}()})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Scalar=function(){function Scalar(){}Scalar.WithinEpsilon=function(a,b,epsilon){if(epsilon===void 0){epsilon=1.401298e-45}var num=a-b;return-epsilon<=num&&num<=epsilon};Scalar.ToHex=function(i){var str=i.toString(16);if(i<=15){return("0"+str).toUpperCase()}return str.toUpperCase()};Scalar.Sign=function(value){value=+value;if(value===0||isNaN(value))return value;return value>0?1:-1};Scalar.Clamp=function(value,min,max){if(min===void 0){min=0}if(max===void 0){max=1}return Math.min(max,Math.max(min,value))};Scalar.Log2=function(value){return Math.log(value)*Math.LOG2E};Scalar.Repeat=function(value,length){return value-Math.floor(value/length)*length};Scalar.Normalize=function(value,min,max){return(value-min)/(max-min)};Scalar.Denormalize=function(normalized,min,max){return normalized*(max-min)+min};Scalar.DeltaAngle=function(current,target){var num=Scalar.Repeat(target-current,360);if(num>180){num-=360}return num};Scalar.PingPong=function(tx,length){var t=Scalar.Repeat(tx,length*2);return length-Math.abs(t-length)};Scalar.SmoothStep=function(from,to,tx){var t=Scalar.Clamp(tx);t=-2*t*t*t+3*t*t;return to*t+from*(1-t)};Scalar.MoveTowards=function(current,target,maxDelta){var result=0;if(Math.abs(target-current)<=maxDelta){result=target}else{result=current+Scalar.Sign(target-current)*maxDelta}return result};Scalar.MoveTowardsAngle=function(current,target,maxDelta){var num=Scalar.DeltaAngle(current,target);var result=0;if(-maxDelta<num&&num<maxDelta){result=target}else{target=current+num;result=Scalar.MoveTowards(current,target,maxDelta)}return result};Scalar.Lerp=function(start,end,amount){return start+(end-start)*amount};Scalar.LerpAngle=function(start,end,amount){var num=Scalar.Repeat(end-start,360);if(num>180){num-=360}return start+num*Scalar.Clamp(amount)};Scalar.InverseLerp=function(a,b,value){var result=0;if(a!=b){result=Scalar.Clamp((value-a)/(b-a))}else{result=0}return result};Scalar.Hermite=function(value1,tangent1,value2,tangent2,amount){var squared=amount*amount;var cubed=amount*squared;var part1=2*cubed-3*squared+1;var part2=-2*cubed+3*squared;var part3=cubed-2*squared+amount;var part4=cubed-squared;return value1*part1+value2*part2+tangent1*part3+tangent2*part4};Scalar.RandomRange=function(min,max){if(min===max)return min;return Math.random()*(max-min)+min};Scalar.RangeToPercent=function(number,min,max){return(number-min)/(max-min)};Scalar.PercentToRange=function(percent,min,max){return(max-min)*percent+min};return Scalar}();BABYLON.Scalar=Scalar})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var __decoratorInitialStore={};var __mergedStore={};var _copySource=function(creationFunction,source,instanciate){var destination=creationFunction();if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(destination,source.tags)}var classStore=getMergedStore(destination);for(var property in classStore){var propertyDescriptor=classStore[property];var sourceProperty=source[property];var propertyType=propertyDescriptor.type;if(sourceProperty!==undefined&&sourceProperty!==null){switch(propertyType){case 0:case 6:destination[property]=sourceProperty;break;case 1:destination[property]=instanciate||sourceProperty.isRenderTarget?sourceProperty:sourceProperty.clone();break;case 2:case 3:case 4:case 5:case 7:destination[property]=instanciate?sourceProperty:sourceProperty.clone();break}}}return destination};function getDirectStore(target){var classKey=target.getClassName();if(!__decoratorInitialStore[classKey]){__decoratorInitialStore[classKey]={}}return __decoratorInitialStore[classKey]}function getMergedStore(target){var classKey=target.getClassName();if(__mergedStore[classKey]){return __mergedStore[classKey]}__mergedStore[classKey]={};var store=__mergedStore[classKey];var currentTarget=target;var currentKey=classKey;while(currentKey){var initialStore=__decoratorInitialStore[currentKey];for(var property in initialStore){store[property]=initialStore[property]}var parent_1=void 0;var done=false;do{parent_1=Object.getPrototypeOf(currentTarget);if(!parent_1.getClassName){done=true;break}if(parent_1.getClassName()!==currentKey){break}currentTarget=parent_1}while(parent_1);if(done){break}currentKey=parent_1.getClassName();currentTarget=parent_1}return store}function generateSerializableMember(type,sourceName){return function(target,propertyKey){var classStore=getDirectStore(target);if(!classStore[propertyKey]){classStore[propertyKey]={type:type,sourceName:sourceName}}}}function generateExpandMember(setCallback,targetKey){return function(target,propertyKey){var key=targetKey||"_"+propertyKey;Object.defineProperty(target,propertyKey,{get:function(){return this[key]},set:function(value){if(this[key]===value){return}this[key]=value;target[setCallback].apply(this)},enumerable:true,configurable:true})}}function expandToProperty(callback,targetKey){return generateExpandMember(callback,targetKey)}BABYLON.expandToProperty=expandToProperty;function serialize(sourceName){return generateSerializableMember(0,sourceName)}BABYLON.serialize=serialize;function serializeAsTexture(sourceName){return generateSerializableMember(1,sourceName)}BABYLON.serializeAsTexture=serializeAsTexture;function serializeAsColor3(sourceName){return generateSerializableMember(2,sourceName)}BABYLON.serializeAsColor3=serializeAsColor3;function serializeAsFresnelParameters(sourceName){return generateSerializableMember(3,sourceName)}BABYLON.serializeAsFresnelParameters=serializeAsFresnelParameters;function serializeAsVector2(sourceName){return generateSerializableMember(4,sourceName)}BABYLON.serializeAsVector2=serializeAsVector2;function serializeAsVector3(sourceName){return generateSerializableMember(5,sourceName)}BABYLON.serializeAsVector3=serializeAsVector3;function serializeAsMeshReference(sourceName){return generateSerializableMember(6,sourceName)}BABYLON.serializeAsMeshReference=serializeAsMeshReference;function serializeAsColorCurves(sourceName){return generateSerializableMember(7,sourceName)}BABYLON.serializeAsColorCurves=serializeAsColorCurves;function serializeAsColor4(sourceName){return generateSerializableMember(8,sourceName)}BABYLON.serializeAsColor4=serializeAsColor4;function serializeAsImageProcessingConfiguration(sourceName){return generateSerializableMember(9,sourceName)}BABYLON.serializeAsImageProcessingConfiguration=serializeAsImageProcessingConfiguration;var SerializationHelper=function(){function SerializationHelper(){}SerializationHelper.Serialize=function(entity,serializationObject){if(!serializationObject){serializationObject={}}if(BABYLON.Tags){serializationObject.tags=BABYLON.Tags.GetTags(entity)}var serializedProperties=getMergedStore(entity);for(var property in serializedProperties){var propertyDescriptor=serializedProperties[property];var targetPropertyName=propertyDescriptor.sourceName||property;var propertyType=propertyDescriptor.type;var sourceProperty=entity[property];if(sourceProperty!==undefined&&sourceProperty!==null){switch(propertyType){case 0:serializationObject[targetPropertyName]=sourceProperty;break;case 1:serializationObject[targetPropertyName]=sourceProperty.serialize();break;case 2:serializationObject[targetPropertyName]=sourceProperty.asArray();break;case 3:serializationObject[targetPropertyName]=sourceProperty.serialize();break;case 4:serializationObject[targetPropertyName]=sourceProperty.asArray();break;case 5:serializationObject[targetPropertyName]=sourceProperty.asArray();break;case 6:serializationObject[targetPropertyName]=sourceProperty.id;break;case 7:serializationObject[targetPropertyName]=sourceProperty.serialize();break;case 8:serializationObject[targetPropertyName]=sourceProperty.asArray();break;case 9:serializationObject[targetPropertyName]=sourceProperty.serialize();break}}}return serializationObject};SerializationHelper.Parse=function(creationFunction,source,scene,rootUrl){var destination=creationFunction();if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(destination,source.tags)}var classStore=getMergedStore(destination);for(var property in classStore){var propertyDescriptor=classStore[property];var sourceProperty=source[propertyDescriptor.sourceName||property];var propertyType=propertyDescriptor.type;if(sourceProperty!==undefined&&sourceProperty!==null){var dest=destination;switch(propertyType){case 0:dest[property]=sourceProperty;break;case 1:dest[property]=BABYLON.Texture.Parse(sourceProperty,scene,rootUrl);break;case 2:dest[property]=BABYLON.Color3.FromArray(sourceProperty);break;case 3:dest[property]=BABYLON.FresnelParameters.Parse(sourceProperty);break;case 4:dest[property]=BABYLON.Vector2.FromArray(sourceProperty);break;case 5:dest[property]=BABYLON.Vector3.FromArray(sourceProperty);break;case 6:dest[property]=scene.getLastMeshByID(sourceProperty);break;case 7:dest[property]=BABYLON.ColorCurves.Parse(sourceProperty);break;case 8:dest[property]=BABYLON.Color4.FromArray(sourceProperty);break;case 9:dest[property]=BABYLON.ImageProcessingConfiguration.Parse(sourceProperty);break}}}return destination};SerializationHelper.Clone=function(creationFunction,source){return _copySource(creationFunction,source,false)};SerializationHelper.Instanciate=function(creationFunction,source){return _copySource(creationFunction,source,true)};return SerializationHelper}();BABYLON.SerializationHelper=SerializationHelper})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var EventState=function(){function EventState(mask,skipNextObservers,target,currentTarget){if(skipNextObservers===void 0){skipNextObservers=false}this.initalize(mask,skipNextObservers,target,currentTarget)}EventState.prototype.initalize=function(mask,skipNextObservers,target,currentTarget){if(skipNextObservers===void 0){skipNextObservers=false}this.mask=mask;this.skipNextObservers=skipNextObservers;this.target=target;this.currentTarget=currentTarget;return this};return EventState}();BABYLON.EventState=EventState;var Observer=function(){function Observer(callback,mask,scope){if(scope===void 0){scope=null}this.callback=callback;this.mask=mask;this.scope=scope}return Observer}();BABYLON.Observer=Observer;var MultiObserver=function(){function MultiObserver(){}MultiObserver.prototype.dispose=function(){for(var index=0;index<this._observers.length;index++){this._observables[index].remove(this._observers[index])}this._observers=null;this._observables=null};MultiObserver.Watch=function(observables,callback,mask,scope){if(mask===void 0){mask=-1}if(scope===void 0){scope=null}var result=new MultiObserver;result._observers=new Array;result._observables=observables;for(var _i=0,observables_1=observables;_i<observables_1.length;_i++){var observable=observables_1[_i];result._observers.push(observable.add(callback,mask,false,scope))}return result};return MultiObserver}();BABYLON.MultiObserver=MultiObserver;var Observable=function(){function Observable(onObserverAdded){this._observers=new Array;this._eventState=new EventState(0);this._onObserverAdded=onObserverAdded}Observable.prototype.add=function(callback,mask,insertFirst,scope){if(mask===void 0){mask=-1}if(insertFirst===void 0){insertFirst=false}if(scope===void 0){scope=null}if(!callback){return null}var observer=new Observer(callback,mask,scope);if(insertFirst){this._observers.unshift(observer)}else{this._observers.push(observer)}if(this._onObserverAdded){this._onObserverAdded(observer)}return observer};Observable.prototype.remove=function(observer){var index=this._observers.indexOf(observer);if(index!==-1){this._observers.splice(index,1);return true}return false};Observable.prototype.removeCallback=function(callback){for(var index=0;index<this._observers.length;index++){if(this._observers[index].callback===callback){this._observers.splice(index,1);return true}}return false};Observable.prototype.notifyObservers=function(eventData,mask,target,currentTarget){if(mask===void 0){mask=-1}var state=this._eventState;state.mask=mask;state.target=target;state.currentTarget=currentTarget;state.skipNextObservers=false;for(var _i=0,_a=this._observers;_i<_a.length;_i++){var obs=_a[_i];if(obs.mask&mask){if(obs.scope){obs.callback.apply(obs.scope,[eventData,state])}else{obs.callback(eventData,state)}}if(state.skipNextObservers){return false}}return true};Observable.prototype.notifyObserver=function(observer,eventData,mask){if(mask===void 0){mask=-1}var state=this._eventState;state.mask=mask;state.skipNextObservers=false;observer.callback(eventData,state)};Observable.prototype.hasObservers=function(){return this._observers.length>0};Observable.prototype.clear=function(){this._observers=new Array;this._onObserverAdded=null};Observable.prototype.clone=function(){var result=new Observable;result._observers=this._observers.slice(0);return result};Observable.prototype.hasSpecificMask=function(mask){if(mask===void 0){mask=-1}for(var _i=0,_a=this._observers;_i<_a.length;_i++){var obs=_a[_i];if(obs.mask&mask||obs.mask===mask){return true}}return false};return Observable}();BABYLON.Observable=Observable})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SmartArray=function(){function SmartArray(capacity){this.length=0;this._duplicateId=0;this.data=new Array(capacity);this._id=SmartArray._GlobalId++}SmartArray.prototype.push=function(value){this.data[this.length++]=value;if(this.length>this.data.length){this.data.length*=2}if(!value.__smartArrayFlags){value.__smartArrayFlags={}}value.__smartArrayFlags[this._id]=this._duplicateId};SmartArray.prototype.forEach=function(func){for(var index=0;index<this.length;index++){func(this.data[index])}};SmartArray.prototype.pushNoDuplicate=function(value){if(value.__smartArrayFlags&&value.__smartArrayFlags[this._id]===this._duplicateId){return false}this.push(value);return true};SmartArray.prototype.sort=function(compareFn){this.data.sort(compareFn)};SmartArray.prototype.reset=function(){this.length=0;this._duplicateId++};SmartArray.prototype.dispose=function(){this.reset();if(this.data){this.data.length=0;this.data=null}};SmartArray.prototype.concat=function(array){if(array.length===0){return}if(this.length+array.length>this.data.length){this.data.length=(this.length+array.length)*2}for(var index=0;index<array.length;index++){this.data[this.length++]=(array.data||array)[index]}};SmartArray.prototype.concatWithNoDuplicate=function(array){if(array.length===0){return}if(this.length+array.length>this.data.length){this.data.length=(this.length+array.length)*2}for(var index=0;index<array.length;index++){var item=(array.data||array)[index];this.pushNoDuplicate(item)}};SmartArray.prototype.indexOf=function(value){var position=this.data.indexOf(value);if(position>=this.length){return-1}return position};SmartArray.prototype.contains=function(value){return this.data.indexOf(value)!==-1};SmartArray._GlobalId=0;return SmartArray}();BABYLON.SmartArray=SmartArray})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var screenshotCanvas;var cloneValue=function(source,destinationObject){if(!source)return null;if(source instanceof BABYLON.Mesh){return null}if(source instanceof BABYLON.SubMesh){return source.clone(destinationObject)}else if(source.clone){return source.clone()}return null};var Tools=function(){function Tools(){}Tools.Mix=function(a,b,alpha){return a*(1-alpha)+b*alpha};Tools.Instantiate=function(className){if(Tools.RegisteredExternalClasses&&Tools.RegisteredExternalClasses[className]){return Tools.RegisteredExternalClasses[className]}var arr=className.split(".");var fn=window||this;for(var i=0,len=arr.length;i<len;i++){fn=fn[arr[i]]}if(typeof fn!=="function"){return null}return fn};Tools.SetImmediate=function(action){if(window.setImmediate){window.setImmediate(action)}else{setTimeout(action,1)}};Tools.IsExponentOfTwo=function(value){var count=1;do{count*=2}while(count<value);return count===value};Tools.CeilingPOT=function(x){x--;x|=x>>1;x|=x>>2;x|=x>>4;x|=x>>8;x|=x>>16;x++;return x};Tools.FloorPOT=function(x){x=x|x>>1;x=x|x>>2;x=x|x>>4;x=x|x>>8;x=x|x>>16;return x-(x>>1)};Tools.NearestPOT=function(x){var c=Tools.CeilingPOT(x);var f=Tools.FloorPOT(x);return c-x>x-f?f:c};Tools.GetExponentOfTwo=function(value,max,mode){if(mode===void 0){mode=BABYLON.Engine.SCALEMODE_NEAREST}var pot;switch(mode){case BABYLON.Engine.SCALEMODE_FLOOR:pot=Tools.FloorPOT(value);break;case BABYLON.Engine.SCALEMODE_NEAREST:pot=Tools.NearestPOT(value);break;case BABYLON.Engine.SCALEMODE_CEILING:pot=Tools.CeilingPOT(value);break}return Math.min(pot,max)};Tools.GetFilename=function(path){var index=path.lastIndexOf("/");if(index<0)return path;return path.substring(index+1)};Tools.GetDOMTextContent=function(element){var result="";var child=element.firstChild;while(child){if(child.nodeType===3){result+=child.textContent}child=child.nextSibling}return result};Tools.ToDegrees=function(angle){return angle*180/Math.PI};Tools.ToRadians=function(angle){return angle*Math.PI/180};Tools.EncodeArrayBufferTobase64=function(buffer){var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;var bytes=new Uint8Array(buffer);while(i<bytes.length){chr1=bytes[i++];chr2=i<bytes.length?bytes[i++]:Number.NaN;chr3=i<bytes.length?bytes[i++]:Number.NaN;enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output+=keyStr.charAt(enc1)+keyStr.charAt(enc2)+keyStr.charAt(enc3)+keyStr.charAt(enc4)}return"data:image/png;base64,"+output};Tools.ExtractMinAndMaxIndexed=function(positions,indices,indexStart,indexCount,bias){if(bias===void 0){bias=null}var minimum=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);var maximum=new BABYLON.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var index=indexStart;index<indexStart+indexCount;index++){var current=new BABYLON.Vector3(positions[indices[index]*3],positions[indices[index]*3+1],positions[indices[index]*3+2]);minimum=BABYLON.Vector3.Minimize(current,minimum);maximum=BABYLON.Vector3.Maximize(current,maximum)}if(bias){minimum.x-=minimum.x*bias.x+bias.y;minimum.y-=minimum.y*bias.x+bias.y;minimum.z-=minimum.z*bias.x+bias.y;maximum.x+=maximum.x*bias.x+bias.y;maximum.y+=maximum.y*bias.x+bias.y;maximum.z+=maximum.z*bias.x+bias.y}return{minimum:minimum,maximum:maximum}};Tools.ExtractMinAndMax=function(positions,start,count,bias,stride){if(bias===void 0){bias=null}var minimum=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);var maximum=new BABYLON.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(!stride){stride=3}for(var index=start;index<start+count;index++){var current=new BABYLON.Vector3(positions[index*stride],positions[index*stride+1],positions[index*stride+2]);minimum=BABYLON.Vector3.Minimize(current,minimum);maximum=BABYLON.Vector3.Maximize(current,maximum)}if(bias){minimum.x-=minimum.x*bias.x+bias.y;minimum.y-=minimum.y*bias.x+bias.y;minimum.z-=minimum.z*bias.x+bias.y;maximum.x+=maximum.x*bias.x+bias.y;maximum.y+=maximum.y*bias.x+bias.y;maximum.z+=maximum.z*bias.x+bias.y}return{minimum:minimum,maximum:maximum}};Tools.Vector2ArrayFeeder=function(array){return function(index){var isFloatArray=array.BYTES_PER_ELEMENT!==undefined;var length=isFloatArray?array.length/2:array.length;if(index>=length){return null}if(isFloatArray){var fa=array;return new BABYLON.Vector2(fa[index*2+0],fa[index*2+1])}var a=array;return a[index]}};Tools.ExtractMinAndMaxVector2=function(feeder,bias){if(bias===void 0){bias=null}var minimum=new BABYLON.Vector2(Number.MAX_VALUE,Number.MAX_VALUE);var maximum=new BABYLON.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE);var i=0;var cur=feeder(i++);while(cur){minimum=BABYLON.Vector2.Minimize(cur,minimum);maximum=BABYLON.Vector2.Maximize(cur,maximum);cur=feeder(i++)}if(bias){minimum.x-=minimum.x*bias.x+bias.y;minimum.y-=minimum.y*bias.x+bias.y;maximum.x+=maximum.x*bias.x+bias.y;maximum.y+=maximum.y*bias.x+bias.y}return{minimum:minimum,maximum:maximum}};Tools.MakeArray=function(obj,allowsNullUndefined){if(allowsNullUndefined!==true&&(obj===undefined||obj==null))return undefined;return Array.isArray(obj)?obj:[obj]};Tools.GetPointerPrefix=function(){var eventPrefix="pointer";if(Tools.IsWindowObjectExist()&&!window.PointerEvent&&!navigator.pointerEnabled){eventPrefix="mouse"}return eventPrefix};Tools.QueueNewFrame=function(func,requester){if(!Tools.IsWindowObjectExist()){return setTimeout(func,16)}if(!requester){requester=window}if(requester.requestAnimationFrame){return requester.requestAnimationFrame(func)}else if(requester.msRequestAnimationFrame){return requester.msRequestAnimationFrame(func)}else if(requester.webkitRequestAnimationFrame){return requester.webkitRequestAnimationFrame(func)}else if(requester.mozRequestAnimationFrame){return requester.mozRequestAnimationFrame(func)}else if(requester.oRequestAnimationFrame){return requester.oRequestAnimationFrame(func)}else{return window.setTimeout(func,16)}};Tools.RequestFullscreen=function(element){var requestFunction=element.requestFullscreen||element.msRequestFullscreen||element.webkitRequestFullscreen||element.mozRequestFullScreen;if(!requestFunction)return;requestFunction.call(element)};Tools.ExitFullscreen=function(){if(document.exitFullscreen){document.exitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else if(document.msCancelFullScreen){document.msCancelFullScreen()}};Tools.SetCorsBehavior=function(url,img){if(Tools.CorsBehavior){switch(typeof Tools.CorsBehavior){case"function":var result=Tools.CorsBehavior(url);if(result){img.crossOrigin=result}break;case"string":default:img.crossOrigin=Tools.CorsBehavior;break}}};Tools.CleanUrl=function(url){url=url.replace(/#/gm,"%23");return url};Tools.LoadImage=function(url,onLoad,onError,database){if(url instanceof ArrayBuffer){url=Tools.EncodeArrayBufferTobase64(url)}url=Tools.CleanUrl(url);url=Tools.PreprocessUrl(url);var img=new Image;if(url.substr(0,5)!=="data:"){Tools.SetCorsBehavior(url,img)}img.onload=function(){onLoad(img)};img.onerror=function(err){Tools.Error("Error while trying to load image: "+url);if(Tools.UseFallbackTexture){img.src=Tools.fallbackTexture;onLoad(img)}else{onError("Error while trying to load image: "+url,err)}};var noIndexedDB=function(){img.src=url};var loadFromIndexedDB=function(){database.loadImageFromDB(url,img)};if(url.substr(0,5)!=="data:"&&database&&database.enableTexturesOffline&&BABYLON.Database.IsUASupportingBlobStorage){database.openAsync(loadFromIndexedDB,noIndexedDB)}else{if(url.indexOf("file:")!==0){noIndexedDB()}else{var textureName=decodeURIComponent(url.substring(5).toLowerCase());if(BABYLON.FilesInput.FilesToLoad[textureName]){try{var blobURL;try{blobURL=URL.createObjectURL(BABYLON.FilesInput.FilesToLoad[textureName],{oneTimeOnly:true})}catch(ex){blobURL=URL.createObjectURL(BABYLON.FilesInput.FilesToLoad[textureName])}img.src=blobURL}catch(e){img.src=null}}else{Tools.Error("Image: "+textureName+" not found. Did you forget to provide it?");img.src=Tools.fallbackTexture}}}return img};Tools.LoadFile=function(url,callback,progressCallBack,database,useArrayBuffer,onError){url=Tools.CleanUrl(url);url=Tools.PreprocessUrl(url);var noIndexedDB=function(){var request=new XMLHttpRequest;var loadUrl=Tools.BaseUrl+url;request.open("GET",loadUrl,true);if(useArrayBuffer){request.responseType="arraybuffer"}request.onprogress=progressCallBack;request.onreadystatechange=function(){if(request.readyState===(XMLHttpRequest.DONE||4)){request.onreadystatechange=null;if(request.status>=200&&request.status<300||!Tools.IsWindowObjectExist()&&request.status===0){callback(!useArrayBuffer?request.responseText:request.response)}else{var e=new Error("Error status: "+request.status+" - Unable to load "+loadUrl);if(onError){onError(request,e)}else{throw e}}}};request.send(null)};var loadFromIndexedDB=function(){database.loadFileFromDB(url,callback,progressCallBack,noIndexedDB,useArrayBuffer)};if(url.indexOf("file:")!==-1){var fileName=decodeURIComponent(url.substring(5).toLowerCase());if(BABYLON.FilesInput.FilesToLoad[fileName]){Tools.ReadFile(BABYLON.FilesInput.FilesToLoad[fileName],callback,progressCallBack,useArrayBuffer)}else{var errorMessage="File: "+fileName+" not found. Did you forget to provide it?";if(onError){var e=new Error(errorMessage);onError(undefined,e)}else{Tools.Error(errorMessage)}}}else{if(database&&database.enableSceneOffline){database.openAsync(loadFromIndexedDB,noIndexedDB)}else{noIndexedDB()}}};Tools.LoadScript=function(scriptUrl,onSuccess,onError){var head=document.getElementsByTagName("head")[0];var script=document.createElement("script");script.type="text/javascript";script.src=scriptUrl;script.onload=function(){if(onSuccess){onSuccess()}};script.onerror=function(e){if(onError){onError("Unable to load script",e)}};head.appendChild(script)};Tools.ReadFileAsDataURL=function(fileToLoad,callback,progressCallback){var reader=new FileReader;reader.onload=function(e){callback(e.target["result"])};reader.onprogress=progressCallback;reader.readAsDataURL(fileToLoad)};Tools.ReadFile=function(fileToLoad,callback,progressCallBack,useArrayBuffer){var reader=new FileReader;reader.onerror=function(e){Tools.Log("Error while reading file: "+fileToLoad.name);callback(JSON.stringify({autoClear:true,clearColor:[1,0,0],ambientColor:[0,0,0],gravity:[0,-9.807,0],meshes:[],cameras:[],lights:[]}))};reader.onload=function(e){callback(e.target["result"])};reader.onprogress=progressCallBack;if(!useArrayBuffer){reader.readAsText(fileToLoad)}else{reader.readAsArrayBuffer(fileToLoad)}};Tools.FileAsURL=function(content){var fileBlob=new Blob([content]);var url=window.URL||window.webkitURL;var link=url.createObjectURL(fileBlob);return link};Tools.Format=function(value,decimals){if(decimals===void 0){decimals=2}return value.toFixed(decimals)};Tools.CheckExtends=function(v,min,max){if(v.x<min.x)min.x=v.x;if(v.y<min.y)min.y=v.y;if(v.z<min.z)min.z=v.z;if(v.x>max.x)max.x=v.x;if(v.y>max.y)max.y=v.y;if(v.z>max.z)max.z=v.z};Tools.DeepCopy=function(source,destination,doNotCopyList,mustCopyList){for(var prop in source){if(prop[0]==="_"&&(!mustCopyList||mustCopyList.indexOf(prop)===-1)){continue}if(doNotCopyList&&doNotCopyList.indexOf(prop)!==-1){continue}var sourceValue=source[prop];var typeOfSourceValue=typeof sourceValue;if(typeOfSourceValue==="function"){continue}if(typeOfSourceValue==="object"){if(sourceValue instanceof Array){destination[prop]=[];if(sourceValue.length>0){if(typeof sourceValue[0]=="object"){for(var index=0;index<sourceValue.length;index++){var clonedValue=cloneValue(sourceValue[index],destination);if(destination[prop].indexOf(clonedValue)===-1){destination[prop].push(clonedValue)}}}else{destination[prop]=sourceValue.slice(0)}}}else{destination[prop]=cloneValue(sourceValue,destination)}}else{destination[prop]=sourceValue}}};Tools.IsEmpty=function(obj){for(var i in obj){if(obj.hasOwnProperty(i)){return false}}return true};Tools.RegisterTopRootEvents=function(events){for(var index=0;index<events.length;index++){var event=events[index];window.addEventListener(event.name,event.handler,false);try{if(window.parent){window.parent.addEventListener(event.name,event.handler,false)}}catch(e){}}};Tools.UnregisterTopRootEvents=function(events){for(var index=0;index<events.length;index++){var event=events[index];window.removeEventListener(event.name,event.handler);try{if(window.parent){window.parent.removeEventListener(event.name,event.handler)}}catch(e){}}};Tools.DumpFramebuffer=function(width,height,engine,successCallback,mimeType){if(mimeType===void 0){mimeType="image/png"}var numberOfChannelsByLine=width*4;var halfHeight=height/2;var data=engine.readPixels(0,0,width,height);for(var i=0;i<halfHeight;i++){for(var j=0;j<numberOfChannelsByLine;j++){var currentCell=j+i*numberOfChannelsByLine;var targetLine=height-i-1;var targetCell=j+targetLine*numberOfChannelsByLine;var temp=data[currentCell];data[currentCell]=data[targetCell];data[targetCell]=temp}}if(!screenshotCanvas){screenshotCanvas=document.createElement("canvas")}screenshotCanvas.width=width;screenshotCanvas.height=height;var context=screenshotCanvas.getContext("2d");var imageData=context.createImageData(width,height);var castData=imageData.data;castData.set(data);context.putImageData(imageData,0,0);Tools.EncodeScreenshotCanvasData(successCallback,mimeType)};Tools.EncodeScreenshotCanvasData=function(successCallback,mimeType){if(mimeType===void 0){mimeType="image/png"}var base64Image=screenshotCanvas.toDataURL(mimeType);if(successCallback){successCallback(base64Image)}else{if("download"in document.createElement("a")){var a=window.document.createElement("a");a.href=base64Image;var date=new Date;var stringDate=(date.getFullYear()+"-"+(date.getMonth()+1)).slice(-2)+"-"+date.getDate()+"_"+date.getHours()+"-"+("0"+date.getMinutes()).slice(-2);a.setAttribute("download","screenshot_"+stringDate+".png");window.document.body.appendChild(a);a.addEventListener("click",function(){a.parentElement.removeChild(a)});a.click()}else{var newWindow=window.open("");var img=newWindow.document.createElement("img");img.src=base64Image;newWindow.document.body.appendChild(img)}}};Tools.CreateScreenshot=function(engine,camera,size,successCallback,mimeType){if(mimeType===void 0){mimeType="image/png"}var width;var height;if(size.precision){width=Math.round(engine.getRenderWidth()*size.precision);height=Math.round(width/engine.getAspectRatio(camera))}else if(size.width&&size.height){width=size.width;height=size.height}else if(size.width&&!size.height){width=size.width;height=Math.round(width/engine.getAspectRatio(camera))}else if(size.height&&!size.width){height=size.height;width=Math.round(height*engine.getAspectRatio(camera))}else if(!isNaN(size)){height=size;width=size}else{Tools.Error("Invalid 'size' parameter !");return}if(!screenshotCanvas){screenshotCanvas=document.createElement("canvas")}screenshotCanvas.width=width;screenshotCanvas.height=height;var renderContext=screenshotCanvas.getContext("2d");var ratio=engine.getRenderWidth()/engine.getRenderHeight();var newWidth=width;var newHeight=newWidth/ratio;if(newHeight>height){newHeight=height;newWidth=newHeight*ratio}var offsetX=Math.max(0,width-newWidth)/2;var offsetY=Math.max(0,height-newHeight)/2;renderContext.drawImage(engine.getRenderingCanvas(),offsetX,offsetY,newWidth,newHeight);Tools.EncodeScreenshotCanvasData(successCallback,mimeType)};Tools.CreateScreenshotUsingRenderTarget=function(engine,camera,size,successCallback,mimeType,samples){if(mimeType===void 0){mimeType="image/png"}if(samples===void 0){samples=1}var width;var height;if(size.precision){width=Math.round(engine.getRenderWidth()*size.precision);height=Math.round(width/engine.getAspectRatio(camera));size={width:width,height:height}}else if(size.width&&size.height){width=size.width;height=size.height}else if(size.width&&!size.height){width=size.width;height=Math.round(width/engine.getAspectRatio(camera));size={width:width,height:height}}else if(size.height&&!size.width){height=size.height;width=Math.round(height*engine.getAspectRatio(camera));size={width:width,height:height}}else if(!isNaN(size)){height=size;width=size}else{Tools.Error("Invalid 'size' parameter !");return}var scene=camera.getScene();var previousCamera=null;if(scene.activeCamera!==camera){previousCamera=scene.activeCamera;scene.activeCamera=camera}var texture=new BABYLON.RenderTargetTexture("screenShot",size,scene,false,false,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT,false,BABYLON.Texture.NEAREST_SAMPLINGMODE);texture.renderList=null;texture.samples=samples;texture.onAfterRenderObservable.add(function(){Tools.DumpFramebuffer(width,height,engine,successCallback,mimeType)});scene.incrementRenderId();scene.resetCachedMaterial();texture.render(true);texture.dispose();if(previousCamera){scene.activeCamera=previousCamera}camera.getProjectionMatrix(true)};Tools.ValidateXHRData=function(xhr,dataType){if(dataType===void 0){dataType=7}try{if(dataType&1){if(xhr.responseText&&xhr.responseText.length>0){return true}else if(dataType===1){return false}}if(dataType&2){var tgaHeader=BABYLON.Internals.TGATools.GetTGAHeader(xhr.response);if(tgaHeader.width&&tgaHeader.height&&tgaHeader.width>0&&tgaHeader.height>0){return true}else if(dataType===2){return false}}if(dataType&4){var ddsHeader=new Uint8Array(xhr.response,0,3);if(ddsHeader[0]===68&&ddsHeader[1]===68&&ddsHeader[2]===83){return true}else{return false}}}catch(e){}return false};Tools.RandomId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==="x"?r:r&3|8;return v.toString(16)})};Object.defineProperty(Tools,"NoneLogLevel",{get:function(){return Tools._NoneLogLevel},enumerable:true,configurable:true});Object.defineProperty(Tools,"MessageLogLevel",{get:function(){return Tools._MessageLogLevel},enumerable:true,configurable:true});Object.defineProperty(Tools,"WarningLogLevel",{get:function(){return Tools._WarningLogLevel},enumerable:true,configurable:true});Object.defineProperty(Tools,"ErrorLogLevel",{get:function(){return Tools._ErrorLogLevel},enumerable:true,configurable:true});Object.defineProperty(Tools,"AllLogLevel",{get:function(){return Tools._MessageLogLevel|Tools._WarningLogLevel|Tools._ErrorLogLevel},enumerable:true,configurable:true});Tools._AddLogEntry=function(entry){Tools._LogCache=entry+Tools._LogCache;if(Tools.OnNewCacheEntry){Tools.OnNewCacheEntry(entry)}};Tools._FormatMessage=function(message){var padStr=function(i){return i<10?"0"+i:""+i};var date=new Date;return"["+padStr(date.getHours())+":"+padStr(date.getMinutes())+":"+padStr(date.getSeconds())+"]: "+message};Tools._LogDisabled=function(message){};Tools._LogEnabled=function(message){var formattedMessage=Tools._FormatMessage(message);console.log("BJS - "+formattedMessage);var entry="<div style='color:white'>"+formattedMessage+"</div><br>";Tools._AddLogEntry(entry)};Tools._WarnDisabled=function(message){};Tools._WarnEnabled=function(message){var formattedMessage=Tools._FormatMessage(message);console.warn("BJS - "+formattedMessage);var entry="<div style='color:orange'>"+formattedMessage+"</div><br>";Tools._AddLogEntry(entry)};Tools._ErrorDisabled=function(message){};Tools._ErrorEnabled=function(message){Tools.errorsCount++;var formattedMessage=Tools._FormatMessage(message);console.error("BJS - "+formattedMessage);var entry="<div style='color:red'>"+formattedMessage+"</div><br>";Tools._AddLogEntry(entry)};Object.defineProperty(Tools,"LogCache",{get:function(){return Tools._LogCache},enumerable:true,configurable:true});Tools.ClearLogCache=function(){Tools._LogCache="";Tools.errorsCount=0};Object.defineProperty(Tools,"LogLevels",{set:function(level){if((level&Tools.MessageLogLevel)===Tools.MessageLogLevel){Tools.Log=Tools._LogEnabled}else{Tools.Log=Tools._LogDisabled}if((level&Tools.WarningLogLevel)===Tools.WarningLogLevel){Tools.Warn=Tools._WarnEnabled}else{Tools.Warn=Tools._WarnDisabled}if((level&Tools.ErrorLogLevel)===Tools.ErrorLogLevel){Tools.Error=Tools._ErrorEnabled}else{Tools.Error=Tools._ErrorDisabled}},enumerable:true,configurable:true});Tools.IsWindowObjectExist=function(){return typeof window!=="undefined"};Object.defineProperty(Tools,"PerformanceNoneLogLevel",{get:function(){return Tools._PerformanceNoneLogLevel},enumerable:true,configurable:true});Object.defineProperty(Tools,"PerformanceUserMarkLogLevel",{get:function(){return Tools._PerformanceUserMarkLogLevel},enumerable:true,configurable:true});Object.defineProperty(Tools,"PerformanceConsoleLogLevel",{get:function(){return Tools._PerformanceConsoleLogLevel},enumerable:true,configurable:true});Object.defineProperty(Tools,"PerformanceLogLevel",{set:function(level){if((level&Tools.PerformanceUserMarkLogLevel)===Tools.PerformanceUserMarkLogLevel){Tools.StartPerformanceCounter=Tools._StartUserMark;Tools.EndPerformanceCounter=Tools._EndUserMark;return}if((level&Tools.PerformanceConsoleLogLevel)===Tools.PerformanceConsoleLogLevel){Tools.StartPerformanceCounter=Tools._StartPerformanceConsole;Tools.EndPerformanceCounter=Tools._EndPerformanceConsole;return}Tools.StartPerformanceCounter=Tools._StartPerformanceCounterDisabled;Tools.EndPerformanceCounter=Tools._EndPerformanceCounterDisabled},enumerable:true,configurable:true});Tools._StartPerformanceCounterDisabled=function(counterName,condition){};Tools._EndPerformanceCounterDisabled=function(counterName,condition){};Tools._StartUserMark=function(counterName,condition){if(condition===void 0){condition=true}if(!Tools._performance){if(!Tools.IsWindowObjectExist()){return}Tools._performance=window.performance}if(!condition||!Tools._performance.mark){return}Tools._performance.mark(counterName+"-Begin")};Tools._EndUserMark=function(counterName,condition){if(condition===void 0){condition=true}if(!condition||!Tools._performance.mark){return}Tools._performance.mark(counterName+"-End");Tools._performance.measure(counterName,counterName+"-Begin",counterName+"-End")};Tools._StartPerformanceConsole=function(counterName,condition){if(condition===void 0){condition=true}if(!condition){return}Tools._StartUserMark(counterName,condition);if(console.time){console.time(counterName)}};Tools._EndPerformanceConsole=function(counterName,condition){if(condition===void 0){condition=true}if(!condition){return}Tools._EndUserMark(counterName,condition);if(console.time){console.timeEnd(counterName)}};Object.defineProperty(Tools,"Now",{get:function(){if(Tools.IsWindowObjectExist()&&window.performance&&window.performance.now){return window.performance.now()}return(new Date).getTime()},enumerable:true,configurable:true});Tools.GetClassName=function(object,isType){if(isType===void 0){isType=false}var name=null;if(!isType&&object.getClassName){name=object.getClassName()}else{if(object instanceof Object){var classObj=isType?object:Object.getPrototypeOf(object);name=classObj.constructor["__bjsclassName__"]}if(!name){name=typeof object}}return name};Tools.First=function(array,predicate){for(var _i=0,array_1=array;_i<array_1.length;_i++){var el=array_1[_i];if(predicate(el)){return el}}return null};Tools.getFullClassName=function(object,isType){if(isType===void 0){isType=false}var className=null;var moduleName=null;if(!isType&&object.getClassName){className=object.getClassName()}else{if(object instanceof Object){var classObj=isType?object:Object.getPrototypeOf(object);className=classObj.constructor["__bjsclassName__"];moduleName=classObj.constructor["__bjsmoduleName__"]}if(!className){className=typeof object}}if(!className){return null}return(moduleName!=null?moduleName+".":"")+className};Tools.arrayOrStringFeeder=function(array){return function(index){if(index>=array.length){return null}var val=array.charCodeAt?array.charCodeAt(index):array[index];if(val&&val.getHashCode){val=val.getHashCode()}if(typeof val==="string"){return Tools.hashCodeFromStream(Tools.arrayOrStringFeeder(val))}return val}};Tools.hashCodeFromStream=function(feeder){var hash=0;var index=0;var chr=feeder(index++);while(chr!=null){hash=(hash<<5)-hash+chr;hash|=0;chr=feeder(index++)}return hash};Tools.BaseUrl="";Tools.CorsBehavior="anonymous";Tools.UseFallbackTexture=true;Tools.RegisteredExternalClasses={};Tools.fallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";Tools.PreprocessUrl=function(url){return url};Tools._NoneLogLevel=0;Tools._MessageLogLevel=1;Tools._WarningLogLevel=2;Tools._ErrorLogLevel=4;Tools._LogCache="";Tools.errorsCount=0;Tools.Log=Tools._LogEnabled;Tools.Warn=Tools._WarnEnabled;Tools.Error=Tools._ErrorEnabled;Tools._PerformanceNoneLogLevel=0;Tools._PerformanceUserMarkLogLevel=1;Tools._PerformanceConsoleLogLevel=2;Tools.StartPerformanceCounter=Tools._StartPerformanceCounterDisabled;Tools.EndPerformanceCounter=Tools._EndPerformanceCounterDisabled;return Tools}();BABYLON.Tools=Tools;var PerfCounter=function(){function PerfCounter(){this._startMonitoringTime=0;this._min=0;this._max=0;this._average=0;this._lastSecAverage=0;this._current=0;this._totalValueCount=0;this._totalAccumulated=0;this._lastSecAccumulated=0;this._lastSecTime=0;this._lastSecValueCount=0}Object.defineProperty(PerfCounter.prototype,"min",{get:function(){return this._min},enumerable:true,configurable:true});Object.defineProperty(PerfCounter.prototype,"max",{get:function(){return this._max},enumerable:true,configurable:true});Object.defineProperty(PerfCounter.prototype,"average",{get:function(){return this._average},enumerable:true,configurable:true});Object.defineProperty(PerfCounter.prototype,"lastSecAverage",{get:function(){return this._lastSecAverage},enumerable:true,configurable:true});Object.defineProperty(PerfCounter.prototype,"current",{get:function(){return this._current},enumerable:true,configurable:true});Object.defineProperty(PerfCounter.prototype,"total",{get:function(){return this._totalAccumulated},enumerable:true,configurable:true});PerfCounter.prototype.fetchNewFrame=function(){this._totalValueCount++;this._current=0;this._lastSecValueCount++};PerfCounter.prototype.addCount=function(newCount,fetchResult){if(!PerfCounter.Enabled){return}this._current+=newCount;if(fetchResult){this._fetchResult()}};PerfCounter.prototype.beginMonitoring=function(){if(!PerfCounter.Enabled){return}this._startMonitoringTime=Tools.Now};PerfCounter.prototype.endMonitoring=function(newFrame){if(newFrame===void 0){newFrame=true}if(!PerfCounter.Enabled){return}if(newFrame){this.fetchNewFrame()}var currentTime=Tools.Now;this._current=currentTime-this._startMonitoringTime;if(newFrame){this._fetchResult()}};PerfCounter.prototype._fetchResult=function(){this._totalAccumulated+=this._current;this._lastSecAccumulated+=this._current;this._min=Math.min(this._min,this._current);this._max=Math.max(this._max,this._current);this._average=this._totalAccumulated/this._totalValueCount;var now=Tools.Now;if(now-this._lastSecTime>1e3){this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount;this._lastSecTime=now;this._lastSecAccumulated=0;this._lastSecValueCount=0}};PerfCounter.Enabled=true;return PerfCounter}();BABYLON.PerfCounter=PerfCounter;function className(name,module){return function(target){target["__bjsclassName__"]=name;target["__bjsmoduleName__"]=module!=null?module:null}}BABYLON.className=className;var AsyncLoop=function(){function AsyncLoop(iterations,_fn,_successCallback,offset){if(offset===void 0){offset=0}this.iterations=iterations;this._fn=_fn;this._successCallback=_successCallback;this.index=offset-1;this._done=false}AsyncLoop.prototype.executeNext=function(){if(!this._done){if(this.index+1<this.iterations){++this.index;this._fn(this)}else{this.breakLoop()}}};AsyncLoop.prototype.breakLoop=function(){this._done=true;this._successCallback()};AsyncLoop.Run=function(iterations,_fn,_successCallback,offset){if(offset===void 0){offset=0}var loop=new AsyncLoop(iterations,_fn,_successCallback,offset);loop.executeNext();return loop};AsyncLoop.SyncAsyncForLoop=function(iterations,syncedIterations,fn,callback,breakFunction,timeout){if(timeout===void 0){timeout=0}AsyncLoop.Run(Math.ceil(iterations/syncedIterations),function(loop){if(breakFunction&&breakFunction())loop.breakLoop();else{setTimeout(function(){for(var i=0;i<syncedIterations;++i){var iteration=loop.index*syncedIterations+i;if(iteration>=iterations)break;fn(iteration);if(breakFunction&&breakFunction()){loop.breakLoop();break}}loop.executeNext()},timeout)}},callback)};return AsyncLoop}();BABYLON.AsyncLoop=AsyncLoop})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var _AlphaState=function(){function _AlphaState(){this._isAlphaBlendDirty=false;this._isBlendFunctionParametersDirty=false;this._isBlendEquationParametersDirty=false;this._isBlendConstantsDirty=false;this._alphaBlend=false;this._blendFunctionParameters=new Array(4);this._blendEquationParameters=new Array(2);this._blendConstants=new Array(4);this.reset()}Object.defineProperty(_AlphaState.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty},enumerable:true,configurable:true});Object.defineProperty(_AlphaState.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(value){if(this._alphaBlend===value){return}this._alphaBlend=value;this._isAlphaBlendDirty=true},enumerable:true,configurable:true});_AlphaState.prototype.setAlphaBlendConstants=function(r,g,b,a){if(this._blendConstants[0]===r&&this._blendConstants[1]===g&&this._blendConstants[2]===b&&this._blendConstants[3]===a){return}this._blendConstants[0]=r;this._blendConstants[1]=g;this._blendConstants[2]=b;this._blendConstants[3]=a;this._isBlendConstantsDirty=true};_AlphaState.prototype.setAlphaBlendFunctionParameters=function(value0,value1,value2,value3){if(this._blendFunctionParameters[0]===value0&&this._blendFunctionParameters[1]===value1&&this._blendFunctionParameters[2]===value2&&this._blendFunctionParameters[3]===value3){return}this._blendFunctionParameters[0]=value0;this._blendFunctionParameters[1]=value1;this._blendFunctionParameters[2]=value2;this._blendFunctionParameters[3]=value3;this._isBlendFunctionParametersDirty=true};_AlphaState.prototype.setAlphaEquationParameters=function(rgb,alpha){if(this._blendEquationParameters[0]===rgb&&this._blendEquationParameters[1]===alpha){return}this._blendEquationParameters[0]=rgb;this._blendEquationParameters[1]=alpha;this._isBlendEquationParametersDirty=true};_AlphaState.prototype.reset=function(){this._alphaBlend=false;this._blendFunctionParameters[0]=null;this._blendFunctionParameters[1]=null;this._blendFunctionParameters[2]=null;this._blendFunctionParameters[3]=null;this._blendEquationParameters[0]=null;this._blendEquationParameters[1]=null;this._blendConstants[0]=null;this._blendConstants[1]=null;this._blendConstants[2]=null;this._blendConstants[3]=null;this._isAlphaBlendDirty=true;this._isBlendFunctionParametersDirty=false;this._isBlendEquationParametersDirty=false;this._isBlendConstantsDirty=false};_AlphaState.prototype.apply=function(gl){if(!this.isDirty){return}if(this._isAlphaBlendDirty){if(this._alphaBlend){gl.enable(gl.BLEND)}else{gl.disable(gl.BLEND)}this._isAlphaBlendDirty=false}if(this._isBlendFunctionParametersDirty){gl.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]);this._isBlendFunctionParametersDirty=false}if(this._isBlendEquationParametersDirty){gl.blendEquationSeparate(this._isBlendEquationParametersDirty[0],this._isBlendEquationParametersDirty[1]);this._isBlendEquationParametersDirty=false}if(this._isBlendConstantsDirty){gl.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]);this._isBlendConstantsDirty=false}};return _AlphaState}();Internals._AlphaState=_AlphaState})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var _DepthCullingState=function(){function _DepthCullingState(){this._isDepthTestDirty=false;this._isDepthMaskDirty=false;this._isDepthFuncDirty=false;this._isCullFaceDirty=false;this._isCullDirty=false;this._isZOffsetDirty=false;this.reset()}Object.defineProperty(_DepthCullingState.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty},enumerable:true,configurable:true});Object.defineProperty(_DepthCullingState.prototype,"zOffset",{get:function(){return this._zOffset},set:function(value){if(this._zOffset===value){return}this._zOffset=value;this._isZOffsetDirty=true},enumerable:true,configurable:true});Object.defineProperty(_DepthCullingState.prototype,"cullFace",{get:function(){return this._cullFace},set:function(value){if(this._cullFace===value){return}this._cullFace=value;this._isCullFaceDirty=true},enumerable:true,configurable:true});Object.defineProperty(_DepthCullingState.prototype,"cull",{get:function(){return this._cull},set:function(value){if(this._cull===value){return}this._cull=value;this._isCullDirty=true},enumerable:true,configurable:true});Object.defineProperty(_DepthCullingState.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(value){if(this._depthFunc===value){return}this._depthFunc=value;this._isDepthFuncDirty=true},enumerable:true,configurable:true});Object.defineProperty(_DepthCullingState.prototype,"depthMask",{get:function(){return this._depthMask},set:function(value){if(this._depthMask===value){return}this._depthMask=value;this._isDepthMaskDirty=true},enumerable:true,configurable:true});Object.defineProperty(_DepthCullingState.prototype,"depthTest",{get:function(){return this._depthTest},set:function(value){if(this._depthTest===value){return}this._depthTest=value;this._isDepthTestDirty=true},enumerable:true,configurable:true});_DepthCullingState.prototype.reset=function(){this._depthMask=true;this._depthTest=true;this._depthFunc=null;this._cullFace=null;this._cull=null;this._zOffset=0;this._isDepthTestDirty=true;this._isDepthMaskDirty=true;this._isDepthFuncDirty=false;this._isCullFaceDirty=false;this._isCullDirty=false;this._isZOffsetDirty=false};_DepthCullingState.prototype.apply=function(gl){if(!this.isDirty){return}if(this._isCullDirty){if(this.cull){gl.enable(gl.CULL_FACE)}else{gl.disable(gl.CULL_FACE)}this._isCullDirty=false}if(this._isCullFaceDirty){gl.cullFace(this.cullFace);this._isCullFaceDirty=false}if(this._isDepthMaskDirty){gl.depthMask(this.depthMask);this._isDepthMaskDirty=false}if(this._isDepthTestDirty){if(this.depthTest){gl.enable(gl.DEPTH_TEST)}else{gl.disable(gl.DEPTH_TEST)}this._isDepthTestDirty=false}if(this._isDepthFuncDirty){gl.depthFunc(this.depthFunc);this._isDepthFuncDirty=false}if(this._isZOffsetDirty){if(this.zOffset){gl.enable(gl.POLYGON_OFFSET_FILL);gl.polygonOffset(this.zOffset,0)}else{gl.disable(gl.POLYGON_OFFSET_FILL)}this._isZOffsetDirty=false}};return _DepthCullingState}();Internals._DepthCullingState=_DepthCullingState})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var _StencilState=function(){function _StencilState(){this._isStencilTestDirty=false;this._isStencilMaskDirty=false;this._isStencilFuncDirty=false;this._isStencilOpDirty=false;this.reset()}Object.defineProperty(_StencilState.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:true,configurable:true});Object.defineProperty(_StencilState.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(value){if(this._stencilFunc===value){return}this._stencilFunc=value;this._isStencilFuncDirty=true},enumerable:true,configurable:true});Object.defineProperty(_StencilState.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(value){if(this._stencilFuncRef===value){return}this._stencilFuncRef=value;this._isStencilFuncDirty=true},enumerable:true,configurable:true});Object.defineProperty(_StencilState.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(value){if(this._stencilFuncMask===value){return}this._stencilFuncMask=value;this._isStencilFuncDirty=true},enumerable:true,configurable:true});Object.defineProperty(_StencilState.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(value){if(this._stencilOpStencilFail===value){return}this._stencilOpStencilFail=value;this._isStencilOpDirty=true},enumerable:true,configurable:true});Object.defineProperty(_StencilState.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(value){if(this._stencilOpDepthFail===value){return}this._stencilOpDepthFail=value;this._isStencilOpDirty=true},enumerable:true,configurable:true});Object.defineProperty(_StencilState.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(value){if(this._stencilOpStencilDepthPass===value){return}this._stencilOpStencilDepthPass=value;this._isStencilOpDirty=true},enumerable:true,configurable:true});Object.defineProperty(_StencilState.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(value){if(this._stencilMask===value){return}this._stencilMask=value;this._isStencilMaskDirty=true},enumerable:true,configurable:true});Object.defineProperty(_StencilState.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(value){if(this._stencilTest===value){return}this._stencilTest=value;this._isStencilTestDirty=true},enumerable:true,configurable:true});_StencilState.prototype.reset=function(){this._stencilTest=false;this._stencilMask=255;this._stencilFunc=BABYLON.Engine.ALWAYS;this._stencilFuncRef=1;this._stencilFuncMask=255;this._stencilOpStencilFail=BABYLON.Engine.KEEP;this._stencilOpDepthFail=BABYLON.Engine.KEEP;this._stencilOpStencilDepthPass=BABYLON.Engine.REPLACE;this._isStencilTestDirty=true;this._isStencilMaskDirty=true;this._isStencilFuncDirty=true;this._isStencilOpDirty=true};_StencilState.prototype.apply=function(gl){if(!this.isDirty){return}if(this._isStencilTestDirty){if(this.stencilTest){gl.enable(gl.STENCIL_TEST)}else{gl.disable(gl.STENCIL_TEST)}this._isStencilTestDirty=false}if(this._isStencilMaskDirty){gl.stencilMask(this.stencilMask);this._isStencilMaskDirty=false}if(this._isStencilFuncDirty){gl.stencilFunc(this.stencilFunc,this.stencilFuncRef,this.stencilFuncMask);this._isStencilFuncDirty=false}if(this._isStencilOpDirty){gl.stencilOp(this.stencilOpStencilFail,this.stencilOpDepthFail,this.stencilOpStencilDepthPass);this._isStencilOpDirty=false}};return _StencilState}();Internals._StencilState=_StencilState})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var compileShader=function(gl,source,type,defines,shaderVersion){return compileRawShader(gl,shaderVersion+(defines?defines+"\n":"")+source,type)};var compileRawShader=function(gl,source,type){var shader=gl.createShader(type==="vertex"?gl.VERTEX_SHADER:gl.FRAGMENT_SHADER);gl.shaderSource(shader,source);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){throw new Error(gl.getShaderInfoLog(shader))}return shader};var getSamplingParameters=function(samplingMode,generateMipMaps,gl){var magFilter=gl.NEAREST;var minFilter=gl.NEAREST;switch(samplingMode){case BABYLON.Texture.BILINEAR_SAMPLINGMODE:magFilter=gl.LINEAR;if(generateMipMaps){minFilter=gl.LINEAR_MIPMAP_NEAREST}else{minFilter=gl.LINEAR}break;case BABYLON.Texture.TRILINEAR_SAMPLINGMODE:magFilter=gl.LINEAR;if(generateMipMaps){minFilter=gl.LINEAR_MIPMAP_LINEAR}else{minFilter=gl.LINEAR}break;case BABYLON.Texture.NEAREST_SAMPLINGMODE:magFilter=gl.NEAREST;if(generateMipMaps){minFilter=gl.NEAREST_MIPMAP_LINEAR}else{minFilter=gl.NEAREST}break;case BABYLON.Texture.NEAREST_NEAREST_MIPNEAREST:magFilter=gl.NEAREST;if(generateMipMaps){minFilter=gl.NEAREST_MIPMAP_NEAREST}else{minFilter=gl.NEAREST}break;case BABYLON.Texture.NEAREST_LINEAR_MIPNEAREST:magFilter=gl.NEAREST;if(generateMipMaps){minFilter=gl.LINEAR_MIPMAP_NEAREST}else{minFilter=gl.LINEAR}break;case BABYLON.Texture.NEAREST_LINEAR_MIPLINEAR:magFilter=gl.NEAREST;if(generateMipMaps){minFilter=gl.LINEAR_MIPMAP_LINEAR}else{minFilter=gl.LINEAR}break;case BABYLON.Texture.NEAREST_LINEAR:magFilter=gl.NEAREST;minFilter=gl.LINEAR;break;case BABYLON.Texture.NEAREST_NEAREST:magFilter=gl.NEAREST;minFilter=gl.NEAREST;break;case BABYLON.Texture.LINEAR_NEAREST_MIPNEAREST:magFilter=gl.LINEAR;if(generateMipMaps){minFilter=gl.NEAREST_MIPMAP_NEAREST}else{minFilter=gl.NEAREST}break;case BABYLON.Texture.LINEAR_NEAREST_MIPLINEAR:magFilter=gl.LINEAR;if(generateMipMaps){minFilter=gl.NEAREST_MIPMAP_LINEAR}else{minFilter=gl.NEAREST}break;case BABYLON.Texture.LINEAR_LINEAR:magFilter=gl.LINEAR;minFilter=gl.LINEAR;break;case BABYLON.Texture.LINEAR_NEAREST:magFilter=gl.LINEAR;minFilter=gl.NEAREST;break}return{min:minFilter,mag:magFilter}};var partialLoad=function(url,index,loadedImages,scene,onfinish,onErrorCallBack){if(onErrorCallBack===void 0){onErrorCallBack=null}var img;var onload=function(){loadedImages[index]=img;loadedImages._internalCount++;if(scene){scene._removePendingData(img)}if(loadedImages._internalCount===6){onfinish(loadedImages)}};var onerror=function(message,exception){if(scene){scene._removePendingData(img)}if(onErrorCallBack){onErrorCallBack(message,exception)}};img=BABYLON.Tools.LoadImage(url,onload,onerror,scene?scene.database:null);if(scene){scene._addPendingData(img)}};var cascadeLoad=function(rootUrl,scene,onfinish,files,onError){if(onError===void 0){onError=null}var loadedImages=[];loadedImages._internalCount=0;for(var index=0;index<6;index++){partialLoad(files[index],index,loadedImages,scene,onfinish,onError)}};var BufferPointer=function(){function BufferPointer(){}return BufferPointer}();var InstancingAttributeInfo=function(){function InstancingAttributeInfo(){}return InstancingAttributeInfo}();BABYLON.InstancingAttributeInfo=InstancingAttributeInfo;var RenderTargetCreationOptions=function(){function RenderTargetCreationOptions(){}return RenderTargetCreationOptions}();BABYLON.RenderTargetCreationOptions=RenderTargetCreationOptions;var EngineCapabilities=function(){function EngineCapabilities(){}return EngineCapabilities}();BABYLON.EngineCapabilities=EngineCapabilities;var Engine=function(){function Engine(canvasOrContext,antialias,options,adaptToDeviceRatio){if(adaptToDeviceRatio===void 0){adaptToDeviceRatio=false}var _this=this;this.forcePOTTextures=false;this.isFullscreen=false;this.isPointerLock=false;this.cullBackFaces=true;this.renderEvenInBackground=true;this.preventCacheWipeBetweenFrames=false;this.enableOfflineSupport=false;this.scenes=new Array;this.postProcesses=new Array;this.onResizeObservable=new BABYLON.Observable;this.onCanvasBlurObservable=new BABYLON.Observable;this.onCanvasFocusObservable=new BABYLON.Observable;this.onCanvasPointerOutObservable=new BABYLON.Observable;this.onBeforeTextureInitObservable=new BABYLON.Observable;this._vrDisplay=undefined;this._vrSupported=false;this._vrExclusivePointerMode=false;this.disableUniformBuffers=false;this._uniformBuffers=new Array;this._windowIsBackground=false;this._webGLVersion=1;this._badOS=false;this._badDesktopOS=false;this.onVRDisplayChangedObservable=new BABYLON.Observable;this.onVRRequestPresentComplete=new BABYLON.Observable;this.onVRRequestPresentStart=new BABYLON.Observable;this._colorWrite=true;this._drawCalls=new BABYLON.PerfCounter;this._renderingQueueLaunched=false;this._activeRenderLoops=new Array;this._deterministicLockstep=false;this._lockstepMaxSteps=4;this.onContextLostObservable=new BABYLON.Observable;this.onContextRestoredObservable=new BABYLON.Observable;this._contextWasLost=false;this._doNotHandleContextLost=false;this._performanceMonitor=new BABYLON.PerformanceMonitor;this._fps=60;this._deltaTime=0;this.disablePerformanceMonitorInBackground=false;this._depthCullingState=new BABYLON.Internals._DepthCullingState;this._stencilState=new BABYLON.Internals._StencilState;this._alphaState=new BABYLON.Internals._AlphaState;this._alphaMode=Engine.ALPHA_DISABLE;this._internalTexturesCache=new Array;this._activeTexturesCache={};this._compiledEffects={};this._vertexAttribArraysEnabled=[];this._uintIndicesCurrentlySet=false;this._currentBoundBuffer=new Array;this._currentBufferPointers=new Array;this._currentInstanceLocations=new Array;this._currentInstanceBuffers=new Array;this._vaoRecordInProgress=false;this._mustWipeVertexAttributes=false;this._texturesSupported=new Array;this._onVRFullScreenTriggered=function(){if(_this._vrDisplay&&_this._vrDisplay.isPresenting){_this._oldSize=new BABYLON.Size(_this.getRenderWidth(),_this.getRenderHeight());_this._oldHardwareScaleFactor=_this.getHardwareScalingLevel();var leftEye=_this._vrDisplay.getEyeParameters("left");_this.setHardwareScalingLevel(1);_this.setSize(leftEye.renderWidth*2,leftEye.renderHeight)}else{_this.setHardwareScalingLevel(_this._oldHardwareScaleFactor);_this.setSize(_this._oldSize.width,_this._oldSize.height)}};var canvas;Engine.Instances.push(this);if(!canvasOrContext){return}options=options||{};if(canvasOrContext.getContext){canvas=canvasOrContext;this._renderingCanvas=canvas;if(antialias!=null){options.antialias=antialias}if(options.deterministicLockstep===undefined){options.deterministicLockstep=false}if(options.lockstepMaxSteps===undefined){options.lockstepMaxSteps=4}if(options.preserveDrawingBuffer===undefined){options.preserveDrawingBuffer=false}if(options.audioEngine===undefined){options.audioEngine=true}if(options.stencil===undefined){options.stencil=true}this._deterministicLockstep=options.deterministicLockstep;this._lockstepMaxSteps=options.lockstepMaxSteps;this._doNotHandleContextLost=options.doNotHandleContextLost;if(!options.disableWebGL2Support){try{this._gl=canvas.getContext("webgl2",options)||canvas.getContext("experimental-webgl2",options);if(this._gl){this._webGLVersion=2}}catch(e){}}if(!this._gl){if(!canvas){throw new Error("The provided canvas is null or undefined.")}try{this._gl=canvas.getContext("webgl",options)||canvas.getContext("experimental-webgl",options)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl){throw new Error("WebGL not supported")}this._onCanvasFocus=function(){_this.onCanvasFocusObservable.notifyObservers(_this)};this._onCanvasBlur=function(){_this.onCanvasBlurObservable.notifyObservers(_this)};canvas.addEventListener("focus",this._onCanvasFocus);canvas.addEventListener("blur",this._onCanvasBlur);this._onBlur=function(){if(_this.disablePerformanceMonitorInBackground){_this._performanceMonitor.disable()}_this._windowIsBackground=true};this._onFocus=function(){if(_this.disablePerformanceMonitorInBackground){_this._performanceMonitor.enable()}_this._windowIsBackground=false};this._onCanvasPointerOut=function(){_this.onCanvasPointerOutObservable.notifyObservers(_this)};window.addEventListener("blur",this._onBlur);window.addEventListener("focus",this._onFocus);canvas.addEventListener("pointerout",this._onCanvasPointerOut);if(!this._doNotHandleContextLost){this._onContextLost=function(evt){evt.preventDefault();_this._contextWasLost=true;BABYLON.Tools.Warn("WebGL context lost.");_this.onContextLostObservable.notifyObservers(_this)};this._onContextRestored=function(evt){setTimeout(function(){_this._initGLContext();_this._rebuildEffects();_this._rebuildInternalTextures();_this._rebuildBuffers();_this.wipeCaches(true);BABYLON.Tools.Warn("WebGL context successfully restored.");_this.onContextRestoredObservable.notifyObservers(_this);_this._contextWasLost=false},0)};canvas.addEventListener("webglcontextlost",this._onContextLost,false);canvas.addEventListener("webglcontextrestored",this._onContextRestored,false)}}else{this._gl=canvasOrContext;this._renderingCanvas=this._gl.canvas;if(this._gl.renderbufferStorageMultisample){this._webGLVersion=2}options.stencil=this._gl.getContextAttributes().stencil}var limitDeviceRatio=options.limitDeviceRatio||window.devicePixelRatio||1;this._hardwareScalingLevel=adaptToDeviceRatio?1/Math.min(limitDeviceRatio,window.devicePixelRatio||1):1;this.resize();this._isStencilEnable=options.stencil;this._initGLContext();if(canvas){this._onFullscreenChange=function(){if(document.fullscreen!==undefined){_this.isFullscreen=document.fullscreen}else if(document.mozFullScreen!==undefined){_this.isFullscreen=document.mozFullScreen}else if(document.webkitIsFullScreen!==undefined){_this.isFullscreen=document.webkitIsFullScreen}else if(document.msIsFullScreen!==undefined){_this.isFullscreen=document.msIsFullScreen}if(_this.isFullscreen&&_this._pointerLockRequested){canvas.requestPointerLock=canvas.requestPointerLock||canvas.msRequestPointerLock||canvas.mozRequestPointerLock||canvas.webkitRequestPointerLock;if(canvas.requestPointerLock){canvas.requestPointerLock()}}};document.addEventListener("fullscreenchange",this._onFullscreenChange,false);document.addEventListener("mozfullscreenchange",this._onFullscreenChange,false);document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,false);document.addEventListener("msfullscreenchange",this._onFullscreenChange,false);this._onPointerLockChange=function(){_this.isPointerLock=document.mozPointerLockElement===canvas||document.webkitPointerLockElement===canvas||document.msPointerLockElement===canvas||document.pointerLockElement===canvas};document.addEventListener("pointerlockchange",this._onPointerLockChange,false);document.addEventListener("mspointerlockchange",this._onPointerLockChange,false);document.addEventListener("mozpointerlockchange",this._onPointerLockChange,false);document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,false);this._onVRDisplayPointerRestricted=function(){canvas.requestPointerLock()};this._onVRDisplayPointerUnrestricted=function(){document.exitPointerLock()};window.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,false);window.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,false)}if(options.audioEngine&&BABYLON.AudioEngine&&!Engine.audioEngine){Engine.audioEngine=new BABYLON.AudioEngine}for(var i=0;i<this._caps.maxVertexAttribs;i++){this._currentBufferPointers[i]=new BufferPointer}if(options.autoEnableWebVR){this.initWebVR()}this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);BABYLON.Tools.Log("Babylon.js engine (v"+Engine.Version+") launched");this.enableOfflineSupport=BABYLON.Database!==undefined}Object.defineProperty(Engine,"LastCreatedEngine",{get:function(){if(Engine.Instances.length===0){return null}return Engine.Instances[Engine.Instances.length-1]},enumerable:true,configurable:true});Object.defineProperty(Engine,"LastCreatedScene",{get:function(){var lastCreatedEngine=Engine.LastCreatedEngine;if(!lastCreatedEngine){return null}if(lastCreatedEngine.scenes.length===0){return null}return lastCreatedEngine.scenes[lastCreatedEngine.scenes.length-1]},enumerable:true,configurable:true});Engine.MarkAllMaterialsAsDirty=function(flag,predicate){for(var engineIndex=0;engineIndex<Engine.Instances.length;engineIndex++){var engine=Engine.Instances[engineIndex];for(var sceneIndex=0;sceneIndex<engine.scenes.length;sceneIndex++){engine.scenes[sceneIndex].markAllMaterialsAsDirty(flag,predicate)}}};Object.defineProperty(Engine,"NEVER",{get:function(){return Engine._NEVER},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALWAYS",{get:function(){return Engine._ALWAYS},enumerable:true,configurable:true});Object.defineProperty(Engine,"LESS",{get:function(){return Engine._LESS},enumerable:true,configurable:true});Object.defineProperty(Engine,"EQUAL",{get:function(){return Engine._EQUAL},enumerable:true,configurable:true});Object.defineProperty(Engine,"LEQUAL",{get:function(){return Engine._LEQUAL},enumerable:true,configurable:true});Object.defineProperty(Engine,"GREATER",{get:function(){return Engine._GREATER},enumerable:true,configurable:true});Object.defineProperty(Engine,"GEQUAL",{get:function(){return Engine._GEQUAL},enumerable:true,configurable:true});Object.defineProperty(Engine,"NOTEQUAL",{get:function(){return Engine._NOTEQUAL},enumerable:true,configurable:true});Object.defineProperty(Engine,"KEEP",{get:function(){return Engine._KEEP},enumerable:true,configurable:true});Object.defineProperty(Engine,"REPLACE",{get:function(){return Engine._REPLACE},enumerable:true,configurable:true});Object.defineProperty(Engine,"INCR",{get:function(){return Engine._INCR},enumerable:true,configurable:true});Object.defineProperty(Engine,"DECR",{get:function(){return Engine._DECR},enumerable:true,configurable:true});Object.defineProperty(Engine,"INVERT",{get:function(){return Engine._INVERT},enumerable:true,configurable:true});Object.defineProperty(Engine,"INCR_WRAP",{get:function(){return Engine._INCR_WRAP},enumerable:true,configurable:true});Object.defineProperty(Engine,"DECR_WRAP",{get:function(){return Engine._DECR_WRAP},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_DISABLE",{get:function(){return Engine._ALPHA_DISABLE},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_ONEONE",{get:function(){return Engine._ALPHA_ONEONE},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_ADD",{get:function(){return Engine._ALPHA_ADD},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_COMBINE",{get:function(){return Engine._ALPHA_COMBINE},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_SUBTRACT",{get:function(){return Engine._ALPHA_SUBTRACT},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_MULTIPLY",{get:function(){return Engine._ALPHA_MULTIPLY},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_MAXIMIZED",{get:function(){return Engine._ALPHA_MAXIMIZED},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_PREMULTIPLIED",{get:function(){return Engine._ALPHA_PREMULTIPLIED},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_PREMULTIPLIED_PORTERDUFF",{get:function(){return Engine._ALPHA_PREMULTIPLIED_PORTERDUFF},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_INTERPOLATE",{get:function(){return Engine._ALPHA_INTERPOLATE},enumerable:true,configurable:true});Object.defineProperty(Engine,"ALPHA_SCREENMODE",{get:function(){return Engine._ALPHA_SCREENMODE},enumerable:true,configurable:true});Object.defineProperty(Engine,"DELAYLOADSTATE_NONE",{get:function(){return Engine._DELAYLOADSTATE_NONE},enumerable:true,configurable:true});Object.defineProperty(Engine,"DELAYLOADSTATE_LOADED",{get:function(){return Engine._DELAYLOADSTATE_LOADED},enumerable:true,configurable:true});Object.defineProperty(Engine,"DELAYLOADSTATE_LOADING",{get:function(){return Engine._DELAYLOADSTATE_LOADING},enumerable:true,configurable:true});Object.defineProperty(Engine,"DELAYLOADSTATE_NOTLOADED",{get:function(){return Engine._DELAYLOADSTATE_NOTLOADED},enumerable:true,configurable:true});Object.defineProperty(Engine,"TEXTUREFORMAT_ALPHA",{get:function(){return Engine._TEXTUREFORMAT_ALPHA},enumerable:true,configurable:true});Object.defineProperty(Engine,"TEXTUREFORMAT_LUMINANCE",{get:function(){return Engine._TEXTUREFORMAT_LUMINANCE},enumerable:true,configurable:true});Object.defineProperty(Engine,"TEXTUREFORMAT_LUMINANCE_ALPHA",{get:function(){return Engine._TEXTUREFORMAT_LUMINANCE_ALPHA},enumerable:true,configurable:true});Object.defineProperty(Engine,"TEXTUREFORMAT_RGB",{get:function(){return Engine._TEXTUREFORMAT_RGB},enumerable:true,configurable:true});Object.defineProperty(Engine,"TEXTUREFORMAT_RGBA",{get:function(){return Engine._TEXTUREFORMAT_RGBA},enumerable:true,configurable:true});Object.defineProperty(Engine,"TEXTURETYPE_UNSIGNED_INT",{get:function(){return Engine._TEXTURETYPE_UNSIGNED_INT},enumerable:true,configurable:true});Object.defineProperty(Engine,"TEXTURETYPE_FLOAT",{get:function(){return Engine._TEXTURETYPE_FLOAT},enumerable:true,configurable:true});Object.defineProperty(Engine,"TEXTURETYPE_HALF_FLOAT",{get:function(){return Engine._TEXTURETYPE_HALF_FLOAT},enumerable:true,configurable:true});Object.defineProperty(Engine,"SCALEMODE_FLOOR",{get:function(){return Engine._SCALEMODE_FLOOR},enumerable:true,configurable:true});Object.defineProperty(Engine,"SCALEMODE_NEAREST",{get:function(){return Engine._SCALEMODE_NEAREST},enumerable:true,configurable:true});Object.defineProperty(Engine,"SCALEMODE_CEILING",{get:function(){return Engine._SCALEMODE_CEILING},enumerable:true,configurable:true});Object.defineProperty(Engine,"Version",{get:function(){return"3.1-alpha"},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"supportsUniformBuffers",{get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"badOS",{get:function(){return this._badOS},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"badDesktopOS",{get:function(){return this._badDesktopOS},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"performanceMonitor",{get:function(){return this._performanceMonitor},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"texturesSupported",{get:function(){return this._texturesSupported},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"emptyTexture",{get:function(){if(!this._emptyTexture){this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,BABYLON.Engine.TEXTUREFORMAT_RGBA,false,false,BABYLON.Texture.NEAREST_SAMPLINGMODE)}return this._emptyTexture},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"emptyCubeTexture",{get:function(){if(!this._emptyCubeTexture){var faceData=new Uint8Array(4);var cubeData=[faceData,faceData,faceData,faceData,faceData,faceData];this._emptyCubeTexture=this.createRawCubeTexture(cubeData,1,BABYLON.Engine.TEXTUREFORMAT_RGBA,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT,false,false,BABYLON.Texture.NEAREST_SAMPLINGMODE)}return this._emptyCubeTexture},enumerable:true,configurable:true});Engine.prototype._rebuildInternalTextures=function(){var currentState=this._internalTexturesCache.slice();for(var _i=0,currentState_1=currentState;_i<currentState_1.length;_i++){var internalTexture=currentState_1[_i];internalTexture._rebuild()}};Engine.prototype._rebuildEffects=function(){for(var key in this._compiledEffects){var effect=this._compiledEffects[key];effect._prepareEffect()}BABYLON.Effect.ResetCache()};Engine.prototype._rebuildBuffers=function(){for(var _i=0,_a=this.scenes;_i<_a.length;_i++){var scene=_a[_i];scene.resetCachedMaterial();scene._rebuildGeometries();scene._rebuildTextures()}for(var _b=0,_c=this._uniformBuffers;_b<_c.length;_b++){var uniformBuffer=_c[_b];uniformBuffer._rebuild()}};Engine.prototype._initGLContext=function(){this._caps=new EngineCapabilities;this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxVertexTextureImageUnits=this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE);this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE);this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE);this._caps.maxVertexAttribs=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS);this._caps.maxVaryingVectors=this._gl.getParameter(this._gl.MAX_VARYING_VECTORS);this._caps.maxFragmentUniformVectors=this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxVertexUniformVectors=this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS);this._glVersion=this._gl.getParameter(this._gl.VERSION);var rendererInfo=this._gl.getExtension("WEBGL_debug_renderer_info");if(rendererInfo!=null){this._glRenderer=this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);this._glVendor=this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL)}if(!this._glVendor){this._glVendor="Unknown vendor"}if(!this._glRenderer){this._glRenderer="Unknown renderer"}this._gl.HALF_FLOAT_OES=36193;this._gl.RGBA16F=34842;this._gl.RGBA32F=34836;this._gl.DEPTH24_STENCIL8=35056;this._caps.standardDerivatives=this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null;this._caps.astc=this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc");this._caps.s3tc=this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");this._caps.pvrtc=this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");this._caps.etc1=this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1");this._caps.etc2=this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0");this._caps.textureAnisotropicFilterExtension=this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic");this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0;this._caps.uintIndices=this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null;this._caps.fragmentDepthSupported=this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null;this._caps.highPrecisionShaderSupported=true;this._caps.colorBufferFloat=this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float");this._caps.textureFloat=this._webGLVersion>1||this._gl.getExtension("OES_texture_float");this._caps.textureFloatLinearFiltering=this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear");this._caps.textureFloatRender=this._caps.textureFloat&&this._canRenderToFloatFramebuffer();this._caps.textureHalfFloat=this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float");this._caps.textureHalfFloatLinearFiltering=this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear");if(this._webGLVersion>1){this._gl.HALF_FLOAT_OES=5131}this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer();this._caps.textureLOD=this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod");if(this._webGLVersion>1){this._caps.drawBuffersExtension=true}else{var drawBuffersExtension=this._gl.getExtension("WEBGL_draw_buffers");if(drawBuffersExtension!==null){this._caps.drawBuffersExtension=true;this._gl.drawBuffers=drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var i=0;i<16;i++){this._gl["COLOR_ATTACHMENT"+i+"_WEBGL"]=drawBuffersExtension["COLOR_ATTACHMENT"+i+"_WEBGL"]}}else{this._caps.drawBuffersExtension=false}}if(this._webGLVersion>1){this._caps.depthTextureExtension=true}else{var depthTextureExtension=this._gl.getExtension("WEBGL_depth_texture");if(depthTextureExtension!=null){this._caps.depthTextureExtension=true}}if(this._webGLVersion>1){this._caps.vertexArrayObject=true}else{var vertexArrayObjectExtension=this._gl.getExtension("OES_vertex_array_object");if(vertexArrayObjectExtension!=null){this._caps.vertexArrayObject=true;this._gl.createVertexArray=vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);this._gl.bindVertexArray=vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);this._gl.deleteVertexArray=vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension)}else{this._caps.vertexArrayObject=false}}if(this._webGLVersion>1){this._caps.instancedArrays=true}else{var instanceExtension=this._gl.getExtension("ANGLE_instanced_arrays");if(instanceExtension!=null){this._caps.instancedArrays=true;this._gl.drawArraysInstanced=instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);this._gl.drawElementsInstanced=instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);this._gl.vertexAttribDivisor=instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension)}else{this._caps.instancedArrays=false}}if(this._caps.astc)this.texturesSupported.push("-astc.ktx");if(this._caps.s3tc)this.texturesSupported.push("-dxt.ktx");if(this._caps.pvrtc)this.texturesSupported.push("-pvrtc.ktx");if(this._caps.etc2)this.texturesSupported.push("-etc2.ktx");if(this._caps.etc1)this.texturesSupported.push("-etc1.ktx");if(this._gl.getShaderPrecisionFormat){var highp=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);this._caps.highPrecisionShaderSupported=highp.precision!==0}this.setDepthBuffer(true);this.setDepthFunctionToLessOrEqual();this.setDepthWrite(true)};Object.defineProperty(Engine.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:true,configurable:true});Engine.prototype._prepareWorkingCanvas=function(){if(this._workingCanvas){return}this._workingCanvas=document.createElement("canvas");this._workingContext=this._workingCanvas.getContext("2d")};Engine.prototype.resetTextureCache=function(){for(var key in this._activeTexturesCache){this._activeTexturesCache[key]=null}};Engine.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep};Engine.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps};Engine.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}};Engine.prototype.getAspectRatio=function(camera,useScreen){if(useScreen===void 0){useScreen=false}var viewport=camera.viewport;return this.getRenderWidth(useScreen)*viewport.width/(this.getRenderHeight(useScreen)*viewport.height)};Engine.prototype.getRenderWidth=function(useScreen){if(useScreen===void 0){useScreen=false}if(!useScreen&&this._currentRenderTarget){return this._currentRenderTarget.width}return this._gl.drawingBufferWidth};Engine.prototype.getRenderHeight=function(useScreen){if(useScreen===void 0){useScreen=false}if(!useScreen&&this._currentRenderTarget){return this._currentRenderTarget.height}return this._gl.drawingBufferHeight};Engine.prototype.getRenderingCanvas=function(){return this._renderingCanvas};Engine.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas.getBoundingClientRect()};Engine.prototype.setHardwareScalingLevel=function(level){this._hardwareScalingLevel=level;this.resize()};Engine.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel};Engine.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache};Engine.prototype.getCaps=function(){return this._caps};Object.defineProperty(Engine.prototype,"drawCalls",{get:function(){return this._drawCalls.current},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"drawCallsPerfCounter",{get:function(){return this._drawCalls},enumerable:true,configurable:true});Engine.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc};Engine.prototype.setDepthFunction=function(depthFunc){this._depthCullingState.depthFunc=depthFunc};Engine.prototype.setDepthFunctionToGreater=function(){this._depthCullingState.depthFunc=this._gl.GREATER};Engine.prototype.setDepthFunctionToGreaterOrEqual=function(){this._depthCullingState.depthFunc=this._gl.GEQUAL};Engine.prototype.setDepthFunctionToLess=function(){this._depthCullingState.depthFunc=this._gl.LESS};Engine.prototype.setDepthFunctionToLessOrEqual=function(){this._depthCullingState.depthFunc=this._gl.LEQUAL};Engine.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest};Engine.prototype.setStencilBuffer=function(enable){this._stencilState.stencilTest=enable};Engine.prototype.getStencilMask=function(){return this._stencilState.stencilMask};Engine.prototype.setStencilMask=function(mask){this._stencilState.stencilMask=mask};Engine.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc};Engine.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef};Engine.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask};Engine.prototype.setStencilFunction=function(stencilFunc){this._stencilState.stencilFunc=stencilFunc};Engine.prototype.setStencilFunctionReference=function(reference){this._stencilState.stencilFuncRef=reference};Engine.prototype.setStencilFunctionMask=function(mask){this._stencilState.stencilFuncMask=mask};Engine.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail};Engine.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail};Engine.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass};Engine.prototype.setStencilOperationFail=function(operation){this._stencilState.stencilOpStencilFail=operation};Engine.prototype.setStencilOperationDepthFail=function(operation){this._stencilState.stencilOpDepthFail=operation};Engine.prototype.setStencilOperationPass=function(operation){this._stencilState.stencilOpStencilDepthPass=operation};Engine.prototype.setDitheringState=function(value){if(value){this._gl.enable(this._gl.DITHER)}else{this._gl.disable(this._gl.DITHER)}};Engine.prototype.stopRenderLoop=function(renderFunction){if(!renderFunction){this._activeRenderLoops=[];return}var index=this._activeRenderLoops.indexOf(renderFunction);if(index>=0){this._activeRenderLoops.splice(index,1)}};Engine.prototype._renderLoop=function(){if(!this._contextWasLost){var shouldRender=true;if(!this.renderEvenInBackground&&this._windowIsBackground){shouldRender=false}if(shouldRender){this.beginFrame();for(var index=0;index<this._activeRenderLoops.length;index++){var renderFunction=this._activeRenderLoops[index];renderFunction()}this.endFrame()}}if(this._activeRenderLoops.length>0){var requester=null;if(this._vrDisplay&&this._vrDisplay.isPresenting)requester=this._vrDisplay;this._frameHandler=BABYLON.Tools.QueueNewFrame(this._bindedRenderFunction,requester)}else{this._renderingQueueLaunched=false}};Engine.prototype.runRenderLoop=function(renderFunction){if(this._activeRenderLoops.indexOf(renderFunction)!==-1){return}this._activeRenderLoops.push(renderFunction);if(!this._renderingQueueLaunched){this._renderingQueueLaunched=true;this._bindedRenderFunction=this._renderLoop.bind(this);this._frameHandler=BABYLON.Tools.QueueNewFrame(this._bindedRenderFunction)}};Engine.prototype.switchFullscreen=function(requestPointerLock){if(this.isFullscreen){BABYLON.Tools.ExitFullscreen()}else{this._pointerLockRequested=requestPointerLock;BABYLON.Tools.RequestFullscreen(this._renderingCanvas)}};Engine.prototype.clear=function(color,backBuffer,depth,stencil){if(stencil===void 0){stencil=false}this.applyStates();var mode=0;if(backBuffer&&color){this._gl.clearColor(color.r,color.g,color.b,color.a!==undefined?color.a:1);mode|=this._gl.COLOR_BUFFER_BIT}if(depth){this._gl.clearDepth(1);mode|=this._gl.DEPTH_BUFFER_BIT}if(stencil){this._gl.clearStencil(0);mode|=this._gl.STENCIL_BUFFER_BIT}this._gl.clear(mode)};Engine.prototype.scissorClear=function(x,y,width,height,clearColor){var gl=this._gl;var curScissor=gl.getParameter(gl.SCISSOR_TEST);var curScissorBox=gl.getParameter(gl.SCISSOR_BOX);gl.enable(gl.SCISSOR_TEST);gl.scissor(x,y,width,height);this.clear(clearColor,true,true,true);gl.scissor(curScissorBox[0],curScissorBox[1],curScissorBox[2],curScissorBox[3]);if(curScissor===true){gl.enable(gl.SCISSOR_TEST)}else{gl.disable(gl.SCISSOR_TEST)}};Engine.prototype.setViewport=function(viewport,requiredWidth,requiredHeight){var width=requiredWidth||this.getRenderWidth();var height=requiredHeight||this.getRenderHeight();var x=viewport.x||0;var y=viewport.y||0;this._cachedViewport=viewport;this._gl.viewport(x*width,y*height,width*viewport.width,height*viewport.height)};Engine.prototype.setDirectViewport=function(x,y,width,height){var currentViewport=this._cachedViewport;this._cachedViewport=null;this._gl.viewport(x,y,width,height);return currentViewport};Engine.prototype.beginFrame=function(){this._measureFps()};Engine.prototype.endFrame=function(){if(this._badOS){this.flushFramebuffer()}if(this._vrDisplay&&this._vrDisplay.isPresenting){this._vrDisplay.submitFrame()}};Engine.prototype.resize=function(){if(!(this._vrDisplay&&this._vrDisplay.isPresenting)){var width=navigator.isCocoonJS?window.innerWidth:this._renderingCanvas.clientWidth;var height=navigator.isCocoonJS?window.innerHeight:this._renderingCanvas.clientHeight;this.setSize(width/this._hardwareScalingLevel,height/this._hardwareScalingLevel)}};Engine.prototype.setSize=function(width,height){if(this._renderingCanvas.width===width&&this._renderingCanvas.height===height){return}this._renderingCanvas.width=width;this._renderingCanvas.height=height;for(var index=0;index<this.scenes.length;index++){var scene=this.scenes[index];for(var camIndex=0;camIndex<scene.cameras.length;camIndex++){var cam=scene.cameras[camIndex];cam._currentRenderId=0}}if(this.onResizeObservable.hasObservers){this.onResizeObservable.notifyObservers(this)}};Engine.prototype.isVRDevicePresent=function(){return!!this._vrDisplay};Engine.prototype.getVRDevice=function(){return this._vrDisplay};Engine.prototype.initWebVR=function(){var _this=this;var notifyObservers=function(){var eventArgs={vrDisplay:_this._vrDisplay,vrSupported:_this._vrSupported};_this.onVRDisplayChangedObservable.notifyObservers(eventArgs)};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=function(event){_this._vrDisplay=event.display;notifyObservers()};this._onVrDisplayDisconnect=function(){_this._vrDisplay.cancelAnimationFrame(_this._frameHandler);_this._vrDisplay=undefined;_this._frameHandler=BABYLON.Tools.QueueNewFrame(_this._bindedRenderFunction);notifyObservers()};this._onVrDisplayPresentChange=function(){_this._vrExclusivePointerMode=_this._vrDisplay&&_this._vrDisplay.isPresenting};window.addEventListener("vrdisplayconnect",this._onVrDisplayConnect);window.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect);window.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange)}this._getVRDisplays(notifyObservers);return this.onVRDisplayChangedObservable};Engine.prototype.enableVR=function(){var _this=this;if(this._vrDisplay&&!this._vrDisplay.isPresenting){var onResolved=function(){_this.onVRRequestPresentComplete.notifyObservers(true);_this._onVRFullScreenTriggered()};var onRejected=function(){_this.onVRRequestPresentComplete.notifyObservers(false)};this.onVRRequestPresentStart.notifyObservers(this);this._vrDisplay.requestPresent([{source:this.getRenderingCanvas()}]).then(onResolved).catch(onRejected)}};Engine.prototype.disableVR=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._vrDisplay.exitPresent().then(this._onVRFullScreenTriggered).catch(this._onVRFullScreenTriggered)}};Engine.prototype._getVRDisplays=function(callback){var _this=this;var getWebVRDevices=function(devices){_this._vrSupported=true;return _this._vrDisplay=devices[0]};if(navigator.getVRDisplays){navigator.getVRDisplays().then(getWebVRDevices).then(callback).catch(function(error){_this._vrSupported=false;callback()})}else{this._vrDisplay=undefined;this._vrSupported=false;callback()}};Engine.prototype.bindFramebuffer=function(texture,faceIndex,requiredWidth,requiredHeight,forceFullscreenViewport){if(this._currentRenderTarget){this.unBindFramebuffer(this._currentRenderTarget)}this._currentRenderTarget=texture;this.bindUnboundFramebuffer(texture._MSAAFramebuffer?texture._MSAAFramebuffer:texture._framebuffer);var gl=this._gl;if(texture.isCube){gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_CUBE_MAP_POSITIVE_X+faceIndex,texture._webGLTexture,0)}if(this._cachedViewport&&!forceFullscreenViewport){this.setViewport(this._cachedViewport,requiredWidth,requiredHeight)}else{gl.viewport(0,0,requiredWidth||texture.width,requiredHeight||texture.height)}this.wipeCaches()};Engine.prototype.bindUnboundFramebuffer=function(framebuffer){if(this._currentFramebuffer!==framebuffer){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,framebuffer);this._currentFramebuffer=framebuffer}};Engine.prototype.unBindFramebuffer=function(texture,disableGenerateMipMaps,onBeforeUnbind){if(disableGenerateMipMaps===void 0){disableGenerateMipMaps=false}this._currentRenderTarget=null;var gl=this._gl;if(texture._MSAAFramebuffer){gl.bindFramebuffer(gl.READ_FRAMEBUFFER,texture._MSAAFramebuffer);gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,texture._framebuffer);gl.blitFramebuffer(0,0,texture.width,texture.height,0,0,texture.width,texture.height,gl.COLOR_BUFFER_BIT,gl.NEAREST)}if(texture.generateMipMaps&&!disableGenerateMipMaps&&!texture.isCube){this._bindTextureDirectly(gl.TEXTURE_2D,texture);gl.generateMipmap(gl.TEXTURE_2D);this._bindTextureDirectly(gl.TEXTURE_2D,null)}if(onBeforeUnbind){if(texture._MSAAFramebuffer){this.bindUnboundFramebuffer(texture._framebuffer)}onBeforeUnbind()}this.bindUnboundFramebuffer(null)};Engine.prototype.generateMipMapsForCubemap=function(texture){if(texture.generateMipMaps){var gl=this._gl;this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,texture);gl.generateMipmap(gl.TEXTURE_CUBE_MAP);this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,null)}};Engine.prototype.flushFramebuffer=function(){this._gl.flush()};Engine.prototype.restoreDefaultFramebuffer=function(){if(this._currentRenderTarget){this.unBindFramebuffer(this._currentRenderTarget)}else{this.bindUnboundFramebuffer(null)}if(this._cachedViewport){this.setViewport(this._cachedViewport)}this.wipeCaches()};Engine.prototype.createUniformBuffer=function(elements){var ubo=this._gl.createBuffer();this.bindUniformBuffer(ubo);if(elements instanceof Float32Array){this._gl.bufferData(this._gl.UNIFORM_BUFFER,elements,this._gl.STATIC_DRAW)}else{this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(elements),this._gl.STATIC_DRAW)}this.bindUniformBuffer(null);ubo.references=1;return ubo};Engine.prototype.createDynamicUniformBuffer=function(elements){var ubo=this._gl.createBuffer();this.bindUniformBuffer(ubo);if(elements instanceof Float32Array){this._gl.bufferData(this._gl.UNIFORM_BUFFER,elements,this._gl.DYNAMIC_DRAW)}else{this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(elements),this._gl.DYNAMIC_DRAW)}this.bindUniformBuffer(null);ubo.references=1;return ubo};Engine.prototype.updateUniformBuffer=function(uniformBuffer,elements,offset,count){this.bindUniformBuffer(uniformBuffer);if(offset===undefined){offset=0}if(count===undefined){if(elements instanceof Float32Array){this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,offset,elements)}else{this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,offset,new Float32Array(elements))}}else{if(elements instanceof Float32Array){this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,elements.subarray(offset,offset+count))}else{this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(elements).subarray(offset,offset+count))}}this.bindUniformBuffer(null)};Engine.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null);this._cachedVertexBuffers=null};Engine.prototype.createVertexBuffer=function(vertices){var vbo=this._gl.createBuffer();this.bindArrayBuffer(vbo);if(vertices instanceof Float32Array){this._gl.bufferData(this._gl.ARRAY_BUFFER,vertices,this._gl.STATIC_DRAW)}else{this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(vertices),this._gl.STATIC_DRAW)}this._resetVertexBufferBinding();vbo.references=1;return vbo};Engine.prototype.createDynamicVertexBuffer=function(vertices){var vbo=this._gl.createBuffer();this.bindArrayBuffer(vbo);if(vertices instanceof Float32Array){this._gl.bufferData(this._gl.ARRAY_BUFFER,vertices,this._gl.DYNAMIC_DRAW)}else{this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(vertices),this._gl.DYNAMIC_DRAW)}this._resetVertexBufferBinding();vbo.references=1;return vbo};Engine.prototype.updateDynamicIndexBuffer=function(indexBuffer,indices,offset){if(offset===void 0){offset=0}this.bindIndexBuffer(indexBuffer);var arrayBuffer;if(indices instanceof Uint16Array||indices instanceof Uint32Array){arrayBuffer=indices}else{arrayBuffer=indexBuffer.is32Bits?new Uint32Array(indices):new Uint16Array(indices)}this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,arrayBuffer,this._gl.DYNAMIC_DRAW);this._resetIndexBufferBinding()};Engine.prototype.updateDynamicVertexBuffer=function(vertexBuffer,vertices,offset,count){this.bindArrayBuffer(vertexBuffer);if(offset===undefined){offset=0}if(count===undefined){if(vertices instanceof Float32Array){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,offset,vertices)}else{this._gl.bufferSubData(this._gl.ARRAY_BUFFER,offset,new Float32Array(vertices))}}else{if(vertices instanceof Float32Array){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,vertices.subarray(offset,offset+count))}else{this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(vertices).subarray(offset,offset+count))}}this._resetVertexBufferBinding()};Engine.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null);this._cachedIndexBuffer=null};Engine.prototype.createIndexBuffer=function(indices,updatable){var vbo=this._gl.createBuffer();this.bindIndexBuffer(vbo);var arrayBuffer;var need32Bits=false;if(indices instanceof Uint16Array){arrayBuffer=indices}else{if(this._caps.uintIndices){if(indices instanceof Uint32Array){arrayBuffer=indices;need32Bits=true}else{for(var index=0;index<indices.length;index++){if(indices[index]>65535){need32Bits=true;break}}arrayBuffer=need32Bits?new Uint32Array(indices):new Uint16Array(indices)}}else{arrayBuffer=new Uint16Array(indices)}}this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,arrayBuffer,updatable?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW);this._resetIndexBufferBinding();vbo.references=1;vbo.is32Bits=need32Bits;return vbo};Engine.prototype.bindArrayBuffer=function(buffer){if(!this._vaoRecordInProgress){this._unbindVertexArrayObject()}this.bindBuffer(buffer,this._gl.ARRAY_BUFFER)};Engine.prototype.bindUniformBuffer=function(buffer){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,buffer)};Engine.prototype.bindUniformBufferBase=function(buffer,location){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,location,buffer)};Engine.prototype.bindUniformBlock=function(shaderProgram,blockName,index){var uniformLocation=this._gl.getUniformBlockIndex(shaderProgram,blockName);this._gl.uniformBlockBinding(shaderProgram,uniformLocation,index)};Engine.prototype.bindIndexBuffer=function(buffer){if(!this._vaoRecordInProgress){this._unbindVertexArrayObject()}this.bindBuffer(buffer,this._gl.ELEMENT_ARRAY_BUFFER)};Engine.prototype.bindBuffer=function(buffer,target){if(this._vaoRecordInProgress||this._currentBoundBuffer[target]!==buffer){this._gl.bindBuffer(target,buffer);this._currentBoundBuffer[target]=buffer}};Engine.prototype.updateArrayBuffer=function(data){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,data)};Engine.prototype.vertexAttribPointer=function(buffer,indx,size,type,normalized,stride,offset){var pointer=this._currentBufferPointers[indx];var changed=false;if(!pointer.active){changed=true;pointer.active=true;pointer.index=indx;pointer.size=size;pointer.type=type;pointer.normalized=normalized;pointer.stride=stride;pointer.offset=offset;pointer.buffer=buffer}else{if(pointer.buffer!==buffer){pointer.buffer=buffer;changed=true}if(pointer.size!==size){pointer.size=size;changed=true}if(pointer.type!==type){pointer.type=type;changed=true}if(pointer.normalized!==normalized){pointer.normalized=normalized;changed=true}if(pointer.stride!==stride){pointer.stride=stride;changed=true}if(pointer.offset!==offset){pointer.offset=offset;changed=true}}if(changed||this._vaoRecordInProgress){this.bindArrayBuffer(buffer);this._gl.vertexAttribPointer(indx,size,type,normalized,stride,offset)}};Engine.prototype._bindIndexBufferWithCache=function(indexBuffer){if(indexBuffer==null){return}if(this._cachedIndexBuffer!==indexBuffer){this._cachedIndexBuffer=indexBuffer;this.bindIndexBuffer(indexBuffer);this._uintIndicesCurrentlySet=indexBuffer.is32Bits}};Engine.prototype._bindVertexBuffersAttributes=function(vertexBuffers,effect){var attributes=effect.getAttributesNames();if(!this._vaoRecordInProgress){this._unbindVertexArrayObject()}this.unbindAllAttributes();for(var index=0;index<attributes.length;index++){var order=effect.getAttributeLocation(index);if(order>=0){var vertexBuffer=vertexBuffers[attributes[index]];if(!vertexBuffer){continue}this._gl.enableVertexAttribArray(order);if(!this._vaoRecordInProgress){this._vertexAttribArraysEnabled[order]=true}var buffer=vertexBuffer.getBuffer();this.vertexAttribPointer(buffer,order,vertexBuffer.getSize(),this._gl.FLOAT,false,vertexBuffer.getStrideSize()*4,vertexBuffer.getOffset()*4);if(vertexBuffer.getIsInstanced()){this._gl.vertexAttribDivisor(order,vertexBuffer.getInstanceDivisor());if(!this._vaoRecordInProgress){this._currentInstanceLocations.push(order);this._currentInstanceBuffers.push(buffer)}}}}};Engine.prototype.recordVertexArrayObject=function(vertexBuffers,indexBuffer,effect){var vao=this._gl.createVertexArray();this._vaoRecordInProgress=true;this._gl.bindVertexArray(vao);this._mustWipeVertexAttributes=true;this._bindVertexBuffersAttributes(vertexBuffers,effect);this.bindIndexBuffer(indexBuffer);this._vaoRecordInProgress=false;this._gl.bindVertexArray(null);return vao};Engine.prototype.bindVertexArrayObject=function(vertexArrayObject,indexBuffer){if(this._cachedVertexArrayObject!==vertexArrayObject){this._cachedVertexArrayObject=vertexArrayObject;this._gl.bindVertexArray(vertexArrayObject);this._cachedVertexBuffers=null;this._cachedIndexBuffer=null;this._uintIndicesCurrentlySet=indexBuffer!=null&&indexBuffer.is32Bits;this._mustWipeVertexAttributes=true}};Engine.prototype.bindBuffersDirectly=function(vertexBuffer,indexBuffer,vertexDeclaration,vertexStrideSize,effect){if(this._cachedVertexBuffers!==vertexBuffer||this._cachedEffectForVertexBuffers!==effect){this._cachedVertexBuffers=vertexBuffer;this._cachedEffectForVertexBuffers=effect;var attributesCount=effect.getAttributesCount();this._unbindVertexArrayObject();this.unbindAllAttributes();var offset=0;for(var index=0;index<attributesCount;index++){if(index<vertexDeclaration.length){var order=effect.getAttributeLocation(index);if(order>=0){this._gl.enableVertexAttribArray(order);this._vertexAttribArraysEnabled[order]=true;this.vertexAttribPointer(vertexBuffer,order,vertexDeclaration[index],this._gl.FLOAT,false,vertexStrideSize,offset)}offset+=vertexDeclaration[index]*4}}}this._bindIndexBufferWithCache(indexBuffer)};Engine.prototype._unbindVertexArrayObject=function(){if(!this._cachedVertexArrayObject){return}this._cachedVertexArrayObject=null;this._gl.bindVertexArray(null)};Engine.prototype.bindBuffers=function(vertexBuffers,indexBuffer,effect){if(this._cachedVertexBuffers!==vertexBuffers||this._cachedEffectForVertexBuffers!==effect){this._cachedVertexBuffers=vertexBuffers;this._cachedEffectForVertexBuffers=effect;this._bindVertexBuffersAttributes(vertexBuffers,effect)}this._bindIndexBufferWithCache(indexBuffer)};Engine.prototype.unbindInstanceAttributes=function(){var boundBuffer;for(var i=0,ul=this._currentInstanceLocations.length;i<ul;i++){var instancesBuffer=this._currentInstanceBuffers[i];if(boundBuffer!=instancesBuffer&&instancesBuffer.references){boundBuffer=instancesBuffer;this.bindArrayBuffer(instancesBuffer)}var offsetLocation=this._currentInstanceLocations[i];this._gl.vertexAttribDivisor(offsetLocation,0)}this._currentInstanceBuffers.length=0;this._currentInstanceLocations.length=0};Engine.prototype.releaseVertexArrayObject=function(vao){this._gl.deleteVertexArray(vao)};Engine.prototype._releaseBuffer=function(buffer){buffer.references--;if(buffer.references===0){this._gl.deleteBuffer(buffer);return true}return false};Engine.prototype.createInstancesBuffer=function(capacity){var buffer=this._gl.createBuffer();buffer.capacity=capacity;this.bindArrayBuffer(buffer);this._gl.bufferData(this._gl.ARRAY_BUFFER,capacity,this._gl.DYNAMIC_DRAW);return buffer};Engine.prototype.deleteInstancesBuffer=function(buffer){this._gl.deleteBuffer(buffer)};Engine.prototype.updateAndBindInstancesBuffer=function(instancesBuffer,data,offsetLocations){this.bindArrayBuffer(instancesBuffer);if(data){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,data)}if(offsetLocations[0].index!==undefined){var stride=0;for(var i=0;i<offsetLocations.length;i++){var ai=offsetLocations[i];stride+=ai.attributeSize*4}for(var i=0;i<offsetLocations.length;i++){var ai=offsetLocations[i];if(!this._vertexAttribArraysEnabled[ai.index]){this._gl.enableVertexAttribArray(ai.index);this._vertexAttribArraysEnabled[ai.index]=true}this.vertexAttribPointer(instancesBuffer,ai.index,ai.attributeSize,ai.attribyteType||this._gl.FLOAT,ai.normalized||false,stride,ai.offset);this._gl.vertexAttribDivisor(ai.index,1);this._currentInstanceLocations.push(ai.index);this._currentInstanceBuffers.push(instancesBuffer)}}else{for(var index=0;index<4;index++){var offsetLocation=offsetLocations[index];if(!this._vertexAttribArraysEnabled[offsetLocation]){this._gl.enableVertexAttribArray(offsetLocation);this._vertexAttribArraysEnabled[offsetLocation]=true}this.vertexAttribPointer(instancesBuffer,offsetLocation,4,this._gl.FLOAT,false,64,index*16);this._gl.vertexAttribDivisor(offsetLocation,1);this._currentInstanceLocations.push(offsetLocation);this._currentInstanceBuffers.push(instancesBuffer)}}};Engine.prototype.applyStates=function(){this._depthCullingState.apply(this._gl);this._stencilState.apply(this._gl);this._alphaState.apply(this._gl)};Engine.prototype.draw=function(useTriangles,indexStart,indexCount,instancesCount){this.applyStates();this._drawCalls.addCount(1,false);var indexFormat=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT;var mult=this._uintIndicesCurrentlySet?4:2;if(instancesCount){this._gl.drawElementsInstanced(useTriangles?this._gl.TRIANGLES:this._gl.LINES,indexCount,indexFormat,indexStart*mult,instancesCount);return}this._gl.drawElements(useTriangles?this._gl.TRIANGLES:this._gl.LINES,indexCount,indexFormat,indexStart*mult)};Engine.prototype.drawPointClouds=function(verticesStart,verticesCount,instancesCount){this.applyStates();this._drawCalls.addCount(1,false);if(instancesCount){this._gl.drawArraysInstanced(this._gl.POINTS,verticesStart,verticesCount,instancesCount);return}this._gl.drawArrays(this._gl.POINTS,verticesStart,verticesCount)};Engine.prototype.drawUnIndexed=function(useTriangles,verticesStart,verticesCount,instancesCount){this.applyStates();this._drawCalls.addCount(1,false);if(instancesCount){this._gl.drawArraysInstanced(useTriangles?this._gl.TRIANGLES:this._gl.LINES,verticesStart,verticesCount,instancesCount);return}this._gl.drawArrays(useTriangles?this._gl.TRIANGLES:this._gl.LINES,verticesStart,verticesCount)};Engine.prototype._releaseEffect=function(effect){if(this._compiledEffects[effect._key]){delete this._compiledEffects[effect._key];this._deleteProgram(effect.getProgram())}};Engine.prototype._deleteProgram=function(program){if(program){program.__SPECTOR_rebuildProgram=null;this._gl.deleteProgram(program)}};Engine.prototype.createEffect=function(baseName,attributesNamesOrOptions,uniformsNamesOrEngine,samplers,defines,fallbacks,onCompiled,onError,indexParameters){var vertex=baseName.vertexElement||baseName.vertex||baseName;var fragment=baseName.fragmentElement||baseName.fragment||baseName;var name=vertex+"+"+fragment+"@"+(defines?defines:attributesNamesOrOptions.defines);if(this._compiledEffects[name]){var compiledEffect=this._compiledEffects[name];if(onCompiled&&compiledEffect.isReady()){onCompiled(compiledEffect)}return compiledEffect}var effect=new BABYLON.Effect(baseName,attributesNamesOrOptions,uniformsNamesOrEngine,samplers,this,defines,fallbacks,onCompiled,onError,indexParameters);effect._key=name;this._compiledEffects[name]=effect;return effect};Engine.prototype.createEffectForParticles=function(fragmentName,uniformsNames,samplers,defines,fallbacks,onCompiled,onError){if(uniformsNames===void 0){uniformsNames=[]}if(samplers===void 0){samplers=[]}if(defines===void 0){defines=""}return this.createEffect({vertex:"particles",fragmentElement:fragmentName},["position","color","options"],["view","projection"].concat(uniformsNames),["diffuseSampler"].concat(samplers),defines,fallbacks,onCompiled,onError)};Engine.prototype.createRawShaderProgram=function(vertexCode,fragmentCode,context){context=context||this._gl;var vertexShader=compileRawShader(context,vertexCode,"vertex");var fragmentShader=compileRawShader(context,fragmentCode,"fragment");return this._createShaderProgram(vertexShader,fragmentShader,context)};Engine.prototype.createShaderProgram=function(vertexCode,fragmentCode,defines,context){context=context||this._gl;var shaderVersion=this._webGLVersion>1?"#version 300 es\n":"";var vertexShader=compileShader(context,vertexCode,"vertex",defines,shaderVersion);var fragmentShader=compileShader(context,fragmentCode,"fragment",defines,shaderVersion);return this._createShaderProgram(vertexShader,fragmentShader,context)};Engine.prototype._createShaderProgram=function(vertexShader,fragmentShader,context){var shaderProgram=context.createProgram();context.attachShader(shaderProgram,vertexShader);context.attachShader(shaderProgram,fragmentShader);context.linkProgram(shaderProgram);var linked=context.getProgramParameter(shaderProgram,context.LINK_STATUS);if(!linked){context.validateProgram(shaderProgram);var error=context.getProgramInfoLog(shaderProgram);if(error){throw new Error(error)}}context.deleteShader(vertexShader);context.deleteShader(fragmentShader);return shaderProgram};Engine.prototype.getUniforms=function(shaderProgram,uniformsNames){var results=[];for(var index=0;index<uniformsNames.length;index++){results.push(this._gl.getUniformLocation(shaderProgram,uniformsNames[index]))}return results};Engine.prototype.getAttributes=function(shaderProgram,attributesNames){var results=[];for(var index=0;index<attributesNames.length;index++){try{results.push(this._gl.getAttribLocation(shaderProgram,attributesNames[index]))}catch(e){results.push(-1)}}return results};Engine.prototype.enableEffect=function(effect){this.setProgram(effect.getProgram());this._currentEffect=effect;if(effect.onBind){effect.onBind(effect)}effect.onBindObservable.notifyObservers(effect)};Engine.prototype.setIntArray=function(uniform,array){if(!uniform)return;this._gl.uniform1iv(uniform,array)};Engine.prototype.setIntArray2=function(uniform,array){if(!uniform||array.length%2!==0)return;this._gl.uniform2iv(uniform,array)};Engine.prototype.setIntArray3=function(uniform,array){if(!uniform||array.length%3!==0)return;this._gl.uniform3iv(uniform,array)};Engine.prototype.setIntArray4=function(uniform,array){if(!uniform||array.length%4!==0)return;this._gl.uniform4iv(uniform,array)};Engine.prototype.setFloatArray=function(uniform,array){if(!uniform)return;this._gl.uniform1fv(uniform,array)};Engine.prototype.setFloatArray2=function(uniform,array){if(!uniform||array.length%2!==0)return;this._gl.uniform2fv(uniform,array)};Engine.prototype.setFloatArray3=function(uniform,array){if(!uniform||array.length%3!==0)return;this._gl.uniform3fv(uniform,array)};Engine.prototype.setFloatArray4=function(uniform,array){if(!uniform||array.length%4!==0)return;this._gl.uniform4fv(uniform,array)};Engine.prototype.setArray=function(uniform,array){if(!uniform)return;this._gl.uniform1fv(uniform,array)};Engine.prototype.setArray2=function(uniform,array){if(!uniform||array.length%2!==0)return;this._gl.uniform2fv(uniform,array)};Engine.prototype.setArray3=function(uniform,array){if(!uniform||array.length%3!==0)return;this._gl.uniform3fv(uniform,array)};Engine.prototype.setArray4=function(uniform,array){if(!uniform||array.length%4!==0)return;this._gl.uniform4fv(uniform,array)};Engine.prototype.setMatrices=function(uniform,matrices){if(!uniform)return;this._gl.uniformMatrix4fv(uniform,false,matrices)};Engine.prototype.setMatrix=function(uniform,matrix){if(!uniform)return;this._gl.uniformMatrix4fv(uniform,false,matrix.toArray())};Engine.prototype.setMatrix3x3=function(uniform,matrix){if(!uniform)return;this._gl.uniformMatrix3fv(uniform,false,matrix)};Engine.prototype.setMatrix2x2=function(uniform,matrix){if(!uniform)return;this._gl.uniformMatrix2fv(uniform,false,matrix)};Engine.prototype.setFloat=function(uniform,value){if(!uniform)return;this._gl.uniform1f(uniform,value)};Engine.prototype.setFloat2=function(uniform,x,y){if(!uniform)return;this._gl.uniform2f(uniform,x,y)};Engine.prototype.setFloat3=function(uniform,x,y,z){if(!uniform)return;this._gl.uniform3f(uniform,x,y,z)};Engine.prototype.setBool=function(uniform,bool){if(!uniform)return;this._gl.uniform1i(uniform,bool)};Engine.prototype.setFloat4=function(uniform,x,y,z,w){if(!uniform)return;this._gl.uniform4f(uniform,x,y,z,w)};Engine.prototype.setColor3=function(uniform,color3){if(!uniform)return;this._gl.uniform3f(uniform,color3.r,color3.g,color3.b)};Engine.prototype.setColor4=function(uniform,color3,alpha){if(!uniform)return;this._gl.uniform4f(uniform,color3.r,color3.g,color3.b,alpha)};Engine.prototype.setState=function(culling,zOffset,force,reverseSide){if(zOffset===void 0){zOffset=0}if(reverseSide===void 0){reverseSide=false}var showSide=reverseSide?this._gl.FRONT:this._gl.BACK;var hideSide=reverseSide?this._gl.BACK:this._gl.FRONT;var cullFace=this.cullBackFaces?showSide:hideSide;if(this._depthCullingState.cull!==culling||force||this._depthCullingState.cullFace!==cullFace){if(culling){this._depthCullingState.cullFace=cullFace;this._depthCullingState.cull=true}else{this._depthCullingState.cull=false}}this.setZOffset(zOffset)};Engine.prototype.setZOffset=function(value){this._depthCullingState.zOffset=value};Engine.prototype.getZOffset=function(){return this._depthCullingState.zOffset};Engine.prototype.setDepthBuffer=function(enable){this._depthCullingState.depthTest=enable};Engine.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask};Engine.prototype.setDepthWrite=function(enable){this._depthCullingState.depthMask=enable};Engine.prototype.setColorWrite=function(enable){this._gl.colorMask(enable,enable,enable,enable);this._colorWrite=enable};Engine.prototype.getColorWrite=function(){return this._colorWrite};Engine.prototype.setAlphaConstants=function(r,g,b,a){this._alphaState.setAlphaBlendConstants(r,g,b,a)};Engine.prototype.setAlphaMode=function(mode,noDepthWriteChange){if(noDepthWriteChange===void 0){noDepthWriteChange=false}if(this._alphaMode===mode){return}switch(mode){case Engine.ALPHA_DISABLE:this._alphaState.alphaBlend=false;break;case Engine.ALPHA_PREMULTIPLIED:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_PREMULTIPLIED_PORTERDUFF:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_COMBINE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_ONEONE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_ADD:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_SUBTRACT:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_MULTIPLY:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_MAXIMIZED:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_INTERPOLATE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA);this._alphaState.alphaBlend=true;break;case Engine.ALPHA_SCREENMODE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA);this._alphaState.alphaBlend=true;break}if(!noDepthWriteChange){this.setDepthWrite(mode===Engine.ALPHA_DISABLE)}this._alphaMode=mode};Engine.prototype.getAlphaMode=function(){return this._alphaMode};Engine.prototype.setAlphaTesting=function(enable){this._alphaTest=enable};Engine.prototype.getAlphaTesting=function(){return!!this._alphaTest};Engine.prototype.wipeCaches=function(bruteForce){if(this.preventCacheWipeBetweenFrames){return}this.resetTextureCache();this._currentEffect=null;if(bruteForce){this._currentProgram=null;this._stencilState.reset();this._depthCullingState.reset();this.setDepthFunctionToLessOrEqual();this._alphaState.reset()}this._cachedVertexBuffers=null;this._cachedIndexBuffer=null;this._cachedEffectForVertexBuffers=null;this._unbindVertexArrayObject();this.bindIndexBuffer(null);this.bindArrayBuffer(null)};Engine.prototype.setTextureFormatToUse=function(formatsAvailable){for(var i=0,len1=this.texturesSupported.length;i<len1;i++){for(var j=0,len2=formatsAvailable.length;j<len2;j++){if(this._texturesSupported[i]===formatsAvailable[j].toLowerCase()){return this._textureFormatInUse=this._texturesSupported[i]}}}return this._textureFormatInUse=null};Engine.prototype._createTexture=function(){return this._gl.createTexture()};Engine.prototype.createTexture=function(urlArg,noMipmap,invertY,scene,samplingMode,onLoad,onError,buffer,fallBack,format){var _this=this;if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}if(buffer===void 0){buffer=null}var url=String(urlArg);var fromData=url.substr(0,5)==="data:";var fromBlob=url.substr(0,5)==="blob:";var isBase64=fromData&&url.indexOf("base64")!==-1;var texture=fallBack?fallBack:new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_URL);var lastDot=url.lastIndexOf(".");var extension=lastDot>0?url.substring(lastDot).toLowerCase():"";var isDDS=this.getCaps().s3tc&&extension===".dds";var isTGA=extension===".tga";var isKTX=false;if(this._textureFormatInUse&&!isBase64&&!fallBack){url=url.substring(0,lastDot)+this._textureFormatInUse;isKTX=true}if(scene){scene._addPendingData(texture)}texture.url=url;texture.generateMipMaps=!noMipmap;texture.samplingMode=samplingMode;texture.invertY=invertY;if(!this._doNotHandleContextLost){texture._buffer=buffer}if(onLoad){texture.onLoadedObservable.add(onLoad)}if(!fallBack)this._internalTexturesCache.push(texture);var onerror=function(){if(scene){scene._removePendingData(texture)}if(isKTX){_this.createTexture(urlArg,noMipmap,invertY,scene,samplingMode,null,onError,buffer,texture)}else if(onError){onError()}};var callback;if(isKTX||isTGA||isDDS){if(isKTX){callback=function(data){var ktx=new BABYLON.Internals.KhronosTextureContainer(data,1);_this._prepareWebGLTexture(texture,scene,ktx.pixelWidth,ktx.pixelHeight,invertY,false,true,function(){ktx.uploadLevels(_this._gl,!noMipmap);return false},samplingMode)}}else if(isTGA){callback=function(arrayBuffer){var data=new Uint8Array(arrayBuffer);var header=BABYLON.Internals.TGATools.GetTGAHeader(data);_this._prepareWebGLTexture(texture,scene,header.width,header.height,invertY,noMipmap,false,function(){BABYLON.Internals.TGATools.UploadContent(_this._gl,data);return false},samplingMode)}}else if(isDDS){callback=function(data){var info=BABYLON.Internals.DDSTools.GetDDSInfo(data);var loadMipmap=(info.isRGB||info.isLuminance||info.mipmapCount>1)&&!noMipmap&&info.width>>info.mipmapCount-1===1;_this._prepareWebGLTexture(texture,scene,info.width,info.height,invertY,!loadMipmap,info.isFourCC,function(){BABYLON.Internals.DDSTools.UploadDDSLevels(_this,_this._gl,data,info,loadMipmap,1);return false},samplingMode)}}if(!buffer){BABYLON.Tools.LoadFile(url,function(data){callback(data)},null,scene?scene.database:null,true,onerror)}else{callback(buffer)}}else{var onload=function(img){if(fromBlob&&!_this._doNotHandleContextLost){texture._buffer=img}_this._prepareWebGLTexture(texture,scene,img.width,img.height,invertY,noMipmap,false,function(potWidth,potHeight,continuationCallback){var gl=_this._gl;var isPot=img.width===potWidth&&img.height===potHeight;var internalFormat=format?_this._getInternalFormat(format):extension===".jpg"?gl.RGB:gl.RGBA;if(isPot){gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,internalFormat,gl.UNSIGNED_BYTE,img);return false}var source=new BABYLON.InternalTexture(_this,BABYLON.InternalTexture.DATASOURCE_TEMP);_this._bindTextureDirectly(gl.TEXTURE_2D,source);gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,internalFormat,gl.UNSIGNED_BYTE,img);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);_this._rescaleTexture(source,texture,scene,internalFormat,function(){_this._releaseTexture(source);_this._bindTextureDirectly(gl.TEXTURE_2D,texture);continuationCallback()});return true},samplingMode)};if(!fromData||isBase64)if(buffer instanceof HTMLImageElement){onload(buffer)}else{BABYLON.Tools.LoadImage(url,onload,onerror,scene?scene.database:null)}else if(buffer instanceof Array||typeof buffer==="string"||buffer instanceof ArrayBuffer)BABYLON.Tools.LoadImage(buffer,onload,onerror,scene?scene.database:null);else onload(buffer)}return texture};Engine.prototype._rescaleTexture=function(source,destination,scene,internalFormat,onComplete){var _this=this;var rtt=this.createRenderTargetTexture({width:destination.width,height:destination.height},{generateMipMaps:false,type:Engine.TEXTURETYPE_UNSIGNED_INT,samplingMode:BABYLON.Texture.BILINEAR_SAMPLINGMODE,generateDepthBuffer:false,generateStencilBuffer:false});if(!this._rescalePostProcess){this._rescalePostProcess=new BABYLON.PassPostProcess("rescale",1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this,false,Engine.TEXTURETYPE_UNSIGNED_INT)}this._rescalePostProcess.getEffect().executeWhenCompiled(function(){_this._rescalePostProcess.onApply=function(effect){effect._bindTexture("textureSampler",source)};var hostingScene=scene;if(!hostingScene){hostingScene=_this.scenes[_this.scenes.length-1]}hostingScene.postProcessManager.directRender([_this._rescalePostProcess],rtt);_this._bindTextureDirectly(_this._gl.TEXTURE_2D,destination);_this._gl.copyTexImage2D(_this._gl.TEXTURE_2D,0,internalFormat,0,0,destination.width,destination.height,0);_this.unBindFramebuffer(rtt);_this._releaseTexture(rtt);if(onComplete){onComplete()}})};Engine.prototype._getInternalFormat=function(format){var internalFormat=this._gl.RGBA;switch(format){case Engine.TEXTUREFORMAT_ALPHA:internalFormat=this._gl.ALPHA;break;case Engine.TEXTUREFORMAT_LUMINANCE:internalFormat=this._gl.LUMINANCE;break;case Engine.TEXTUREFORMAT_LUMINANCE_ALPHA:internalFormat=this._gl.LUMINANCE_ALPHA;break;case Engine.TEXTUREFORMAT_RGB:internalFormat=this._gl.RGB;break;case Engine.TEXTUREFORMAT_RGBA:internalFormat=this._gl.RGBA;break}return internalFormat};Engine.prototype.updateRawTexture=function(texture,data,format,invertY,compression){if(compression===void 0){compression=null}var internalFormat=this._getInternalFormat(format);this._bindTextureDirectly(this._gl.TEXTURE_2D,texture);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,invertY===undefined?1:invertY?1:0);if(!this._doNotHandleContextLost){texture._bufferView=data;texture.format=format;texture.invertY=invertY;texture._compression=compression}if(texture.width%4!==0){this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1)}if(compression){this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[compression],texture.width,texture.height,0,data)}else{this._gl.texImage2D(this._gl.TEXTURE_2D,0,internalFormat,texture.width,texture.height,0,internalFormat,this._gl.UNSIGNED_BYTE,data)}if(texture.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this.resetTextureCache();texture.isReady=true};Engine.prototype.createRawTexture=function(data,width,height,format,generateMipMaps,invertY,samplingMode,compression){if(compression===void 0){compression=null}var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_RAW);texture.baseWidth=width;texture.baseHeight=height;texture.width=width;texture.height=height;texture.format=format;texture.generateMipMaps=generateMipMaps;texture.samplingMode=samplingMode;texture.invertY=invertY;texture._compression=compression;if(!this._doNotHandleContextLost){texture._bufferView=data}this.updateRawTexture(texture,data,format,invertY,compression);this._bindTextureDirectly(this._gl.TEXTURE_2D,texture);var filters=getSamplingParameters(samplingMode,generateMipMaps,this._gl);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,filters.mag);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,filters.min);if(generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this._internalTexturesCache.push(texture);return texture};Engine.prototype.createDynamicTexture=function(width,height,generateMipMaps,samplingMode){var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_DYNAMIC);texture.baseWidth=width;texture.baseHeight=height;if(generateMipMaps){width=this.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(width,this._caps.maxTextureSize):width;height=this.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(height,this._caps.maxTextureSize):height}this.resetTextureCache();texture.width=width;texture.height=height;texture.isReady=false;texture.generateMipMaps=generateMipMaps;texture.samplingMode=samplingMode;this.updateTextureSamplingMode(samplingMode,texture);this._internalTexturesCache.push(texture);return texture};Engine.prototype.updateTextureSamplingMode=function(samplingMode,texture){var filters=getSamplingParameters(samplingMode,texture.generateMipMaps,this._gl);if(texture.isCube){this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,texture);this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MAG_FILTER,filters.mag);this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MIN_FILTER,filters.min);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}else{this._bindTextureDirectly(this._gl.TEXTURE_2D,texture);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,filters.mag);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,filters.min);this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}texture.samplingMode=samplingMode};Engine.prototype.updateDynamicTexture=function(texture,canvas,invertY,premulAlpha,format){if(premulAlpha===void 0){premulAlpha=false}this._bindTextureDirectly(this._gl.TEXTURE_2D,texture);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,invertY?1:0);if(premulAlpha){this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1)}var internalFormat=format?this._getInternalFormat(format):this._gl.RGBA;this._gl.texImage2D(this._gl.TEXTURE_2D,0,internalFormat,internalFormat,this._gl.UNSIGNED_BYTE,canvas);if(texture.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null);if(premulAlpha){this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0)}this.resetTextureCache();texture.isReady=true};Engine.prototype.updateVideoTexture=function(texture,video,invertY){if(texture._isDisabled){return}this._bindTextureDirectly(this._gl.TEXTURE_2D,texture);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,invertY?0:1);try{if(this._videoTextureSupported===undefined){this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,video);if(this._gl.getError()!==0){this._videoTextureSupported=false}else{this._videoTextureSupported=true}}if(!this._videoTextureSupported){if(!texture._workingCanvas){texture._workingCanvas=document.createElement("canvas");texture._workingContext=texture._workingCanvas.getContext("2d");texture._workingCanvas.width=texture.width;texture._workingCanvas.height=texture.height}texture._workingContext.drawImage(video,0,0,video.videoWidth,video.videoHeight,0,0,texture.width,texture.height);this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,texture._workingCanvas)}else{this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,video)}if(texture.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this.resetTextureCache();texture.isReady=true}catch(ex){texture._isDisabled=true}};Engine.prototype.createRenderTargetTexture=function(size,options){var fullOptions=new RenderTargetCreationOptions;if(options!==undefined&&typeof options==="object"){fullOptions.generateMipMaps=options.generateMipMaps;fullOptions.generateDepthBuffer=options.generateDepthBuffer===undefined?true:options.generateDepthBuffer;fullOptions.generateStencilBuffer=fullOptions.generateDepthBuffer&&options.generateStencilBuffer;fullOptions.type=options.type===undefined?Engine.TEXTURETYPE_UNSIGNED_INT:options.type;fullOptions.samplingMode=options.samplingMode===undefined?BABYLON.Texture.TRILINEAR_SAMPLINGMODE:options.samplingMode}else{fullOptions.generateMipMaps=options;fullOptions.generateDepthBuffer=true;fullOptions.generateStencilBuffer=false;fullOptions.type=Engine.TEXTURETYPE_UNSIGNED_INT;fullOptions.samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}if(fullOptions.type===Engine.TEXTURETYPE_FLOAT&&!this._caps.textureFloatLinearFiltering){fullOptions.samplingMode=BABYLON.Texture.NEAREST_SAMPLINGMODE}else if(fullOptions.type===Engine.TEXTURETYPE_HALF_FLOAT&&!this._caps.textureHalfFloatLinearFiltering){fullOptions.samplingMode=BABYLON.Texture.NEAREST_SAMPLINGMODE}var gl=this._gl;var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_RENDERTARGET);this._bindTextureDirectly(gl.TEXTURE_2D,texture);var width=size.width||size;var height=size.height||size;var filters=getSamplingParameters(fullOptions.samplingMode,fullOptions.generateMipMaps,gl);if(fullOptions.type===Engine.TEXTURETYPE_FLOAT&&!this._caps.textureFloat){fullOptions.type=Engine.TEXTURETYPE_UNSIGNED_INT;BABYLON.Tools.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,filters.mag);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,filters.min);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(fullOptions.type),width,height,0,gl.RGBA,this._getWebGLTextureType(fullOptions.type),null);var framebuffer=gl.createFramebuffer();this.bindUnboundFramebuffer(framebuffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture._webGLTexture,0);texture._depthStencilBuffer=this._setupFramebufferDepthAttachments(fullOptions.generateStencilBuffer,fullOptions.generateDepthBuffer,width,height);if(fullOptions.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);this.bindUnboundFramebuffer(null);texture._framebuffer=framebuffer;texture.baseWidth=width;texture.baseHeight=height;texture.width=width;texture.height=height;texture.isReady=true;texture.samples=1;texture.generateMipMaps=fullOptions.generateMipMaps;texture.samplingMode=fullOptions.samplingMode;texture.type=fullOptions.type;texture._generateDepthBuffer=fullOptions.generateDepthBuffer;texture._generateStencilBuffer=fullOptions.generateStencilBuffer;this.resetTextureCache();this._internalTexturesCache.push(texture);return texture};Engine.prototype.createMultipleRenderTarget=function(size,options){var generateMipMaps=false;var generateDepthBuffer=true;var generateStencilBuffer=false;var generateDepthTexture=false;var textureCount=1;var defaultType=Engine.TEXTURETYPE_UNSIGNED_INT;var defaultSamplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE;var types=[],samplingModes=[];if(options!==undefined){generateMipMaps=options.generateMipMaps;generateDepthBuffer=options.generateDepthBuffer===undefined?true:options.generateDepthBuffer;generateStencilBuffer=options.generateStencilBuffer;generateDepthTexture=options.generateDepthTexture;textureCount=options.textureCount||1;if(options.types){types=options.types}if(options.samplingModes){samplingModes=options.samplingModes}}var gl=this._gl;var framebuffer=gl.createFramebuffer();this.bindUnboundFramebuffer(framebuffer);var width=size.width||size;var height=size.height||size;var textures=[];var attachments=[];var depthStencilBuffer=this._setupFramebufferDepthAttachments(generateStencilBuffer,generateDepthBuffer,width,height);for(var i=0;i<textureCount;i++){var samplingMode=samplingModes[i]||defaultSamplingMode;var type=types[i]||defaultType;if(type===Engine.TEXTURETYPE_FLOAT&&!this._caps.textureFloatLinearFiltering){samplingMode=BABYLON.Texture.NEAREST_SAMPLINGMODE}else if(type===Engine.TEXTURETYPE_HALF_FLOAT&&!this._caps.textureHalfFloatLinearFiltering){samplingMode=BABYLON.Texture.NEAREST_SAMPLINGMODE}var filters=getSamplingParameters(samplingMode,generateMipMaps,gl);if(type===Engine.TEXTURETYPE_FLOAT&&!this._caps.textureFloat){type=Engine.TEXTURETYPE_UNSIGNED_INT;BABYLON.Tools.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")}var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_MULTIRENDERTARGET);var attachment=gl[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"];textures.push(texture);attachments.push(attachment);gl.activeTexture(gl["TEXTURE"+i]);gl.bindTexture(gl.TEXTURE_2D,texture._webGLTexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,filters.mag);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,filters.min);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(type),width,height,0,gl.RGBA,this._getWebGLTextureType(type),null);gl.framebufferTexture2D(gl.DRAW_FRAMEBUFFER,attachment,gl.TEXTURE_2D,texture._webGLTexture,0);if(generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(gl.TEXTURE_2D,null);texture._framebuffer=framebuffer;texture._depthStencilBuffer=depthStencilBuffer;texture.baseWidth=width;texture.baseHeight=height;texture.width=width;texture.height=height;texture.isReady=true;texture.samples=1;texture.generateMipMaps=generateMipMaps;texture.samplingMode=samplingMode;texture.type=type;texture._generateDepthBuffer=generateDepthBuffer;texture._generateStencilBuffer=generateStencilBuffer;this._internalTexturesCache.push(texture)}if(generateDepthTexture&&this._caps.depthTextureExtension){var depthTexture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_MULTIRENDERTARGET);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,depthTexture._webGLTexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,this.webGLVersion<2?gl.DEPTH_COMPONENT:gl.DEPTH_COMPONENT16,width,height,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_SHORT,null);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,depthTexture._webGLTexture,0);depthTexture._framebuffer=framebuffer;depthTexture.baseWidth=width;depthTexture.baseHeight=height;depthTexture.width=width;depthTexture.height=height;depthTexture.isReady=true;depthTexture.samples=1;depthTexture.generateMipMaps=generateMipMaps;depthTexture.samplingMode=gl.NEAREST;depthTexture._generateDepthBuffer=generateDepthBuffer;depthTexture._generateStencilBuffer=generateStencilBuffer;textures.push(depthTexture);this._internalTexturesCache.push(depthTexture)}gl.drawBuffers(attachments);gl.bindRenderbuffer(gl.RENDERBUFFER,null);this.bindUnboundFramebuffer(null);this.resetTextureCache();return textures};Engine.prototype._setupFramebufferDepthAttachments=function(generateStencilBuffer,generateDepthBuffer,width,height,samples){if(samples===void 0){samples=1}var depthStencilBuffer=null;var gl=this._gl;if(generateStencilBuffer){depthStencilBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,depthStencilBuffer);if(samples>1){gl.renderbufferStorageMultisample(gl.RENDERBUFFER,samples,gl.DEPTH24_STENCIL8,width,height)}else{gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,width,height)}gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,depthStencilBuffer)}else if(generateDepthBuffer){depthStencilBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,depthStencilBuffer);if(samples>1){gl.renderbufferStorageMultisample(gl.RENDERBUFFER,samples,gl.DEPTH_COMPONENT16,width,height)}else{gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,width,height)}gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,depthStencilBuffer)}return depthStencilBuffer};Engine.prototype.updateRenderTargetTextureSampleCount=function(texture,samples){if(this.webGLVersion<2){return 1}if(texture.samples===samples){return samples}var gl=this._gl;samples=Math.min(samples,gl.getParameter(gl.MAX_SAMPLES));if(texture._depthStencilBuffer){gl.deleteRenderbuffer(texture._depthStencilBuffer)}if(texture._MSAAFramebuffer){gl.deleteFramebuffer(texture._MSAAFramebuffer)}if(texture._MSAARenderBuffer){gl.deleteRenderbuffer(texture._MSAARenderBuffer)}if(samples>1){texture._MSAAFramebuffer=gl.createFramebuffer();this.bindUnboundFramebuffer(texture._MSAAFramebuffer);var colorRenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,colorRenderbuffer);gl.renderbufferStorageMultisample(gl.RENDERBUFFER,samples,gl.RGBA8,texture.width,texture.height);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,colorRenderbuffer);texture._MSAARenderBuffer=colorRenderbuffer}else{this.bindUnboundFramebuffer(texture._framebuffer)}texture.samples=samples;texture._depthStencilBuffer=this._setupFramebufferDepthAttachments(texture._generateStencilBuffer,texture._generateDepthBuffer,texture.width,texture.height,samples);gl.bindRenderbuffer(gl.RENDERBUFFER,null);this.bindUnboundFramebuffer(null);return samples};Engine.prototype._uploadDataToTexture=function(target,lod,internalFormat,width,height,format,type,data){this._gl.texImage2D(target,lod,internalFormat,width,height,0,format,type,data)};Engine.prototype._uploadCompressedDataToTexture=function(target,lod,internalFormat,width,height,data){this._gl.compressedTexImage2D(target,lod,internalFormat,width,height,0,data)};Engine.prototype.createRenderTargetCubeTexture=function(size,options){var gl=this._gl;var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_RENDERTARGET);var generateMipMaps=true;var generateDepthBuffer=true;var generateStencilBuffer=false;var samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE;if(options!==undefined){generateMipMaps=options.generateMipMaps===undefined?true:options.generateMipMaps;generateDepthBuffer=options.generateDepthBuffer===undefined?true:options.generateDepthBuffer;generateStencilBuffer=generateDepthBuffer&&options.generateStencilBuffer;if(options.samplingMode!==undefined){samplingMode=options.samplingMode}}texture.isCube=true;texture.generateMipMaps=generateMipMaps;texture.samples=1;texture.samplingMode=samplingMode;var filters=getSamplingParameters(samplingMode,generateMipMaps,gl);this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,texture);for(var face=0;face<6;face++){gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+face,0,gl.RGBA,size,size,0,gl.RGBA,gl.UNSIGNED_BYTE,null)}gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,filters.mag);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,filters.min);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);var framebuffer=gl.createFramebuffer();this.bindUnboundFramebuffer(framebuffer);texture._depthStencilBuffer=this._setupFramebufferDepthAttachments(generateStencilBuffer,generateDepthBuffer,size,size);if(texture.generateMipMaps){this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,texture);gl.generateMipmap(gl.TEXTURE_CUBE_MAP)}this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);this.bindUnboundFramebuffer(null);texture._framebuffer=framebuffer;texture.width=size;texture.height=size;texture.isReady=true;this.resetTextureCache();this._internalTexturesCache.push(texture);return texture};Engine.prototype.createPrefilteredCubeTexture=function(rootUrl,scene,scale,offset,onLoad,onError,format,forcedExtension){var _this=this;if(onError===void 0){onError=null}if(forcedExtension===void 0){forcedExtension=null}var callback=function(loadData){if(!loadData){if(onLoad){onLoad(null)}return}var texture=loadData.texture;texture._dataSource=BABYLON.InternalTexture.DATASOURCE_CUBEPREFILTERED;texture._lodGenerationScale=scale;texture._lodGenerationOffset=offset;if(_this._caps.textureLOD){if(onLoad){onLoad(texture)}return}var mipSlices=3;var gl=_this._gl;var width=loadData.width;if(!width){return}var textures=[];for(var i=0;i<mipSlices;i++){var smoothness=i/(mipSlices-1);var roughness=1-smoothness;var minLODIndex=offset;var maxLODIndex=BABYLON.Scalar.Log2(width)*scale+offset;var lodIndex=minLODIndex+(maxLODIndex-minLODIndex)*roughness;var mipmapIndex=Math.round(Math.min(Math.max(lodIndex,0),maxLODIndex));var glTextureFromLod=new BABYLON.InternalTexture(_this,BABYLON.InternalTexture.DATASOURCE_TEMP);glTextureFromLod.isCube=true;_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,glTextureFromLod);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);if(loadData.isDDS){var info=loadData.info;var data=loadData.data;gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,info.isCompressed?1:0);BABYLON.Internals.DDSTools.UploadDDSLevels(_this,_this._gl,data,info,true,6,mipmapIndex)}else{BABYLON.Tools.Warn("DDS is the only prefiltered cube map supported so far.")}_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,null);var lodTexture=new BABYLON.BaseTexture(scene);lodTexture.isCube=true;lodTexture._texture=glTextureFromLod;glTextureFromLod.isReady=true;textures.push(lodTexture)}texture._lodTextureHigh=textures[2];texture._lodTextureMid=textures[1];texture._lodTextureLow=textures[0];if(onLoad){onLoad(texture)}};return this.createCubeTexture(rootUrl,scene,null,false,callback,onError,format,forcedExtension)};Engine.prototype.createCubeTexture=function(rootUrl,scene,files,noMipmap,onLoad,onError,format,forcedExtension){var _this=this;if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}if(forcedExtension===void 0){forcedExtension=null}var gl=this._gl;var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_CUBE);texture.isCube=true;texture.url=rootUrl;texture.generateMipMaps=!noMipmap;if(!this._doNotHandleContextLost){texture._extension=forcedExtension;texture._files=files}var isKTX=false;var isDDS=false;var lastDot=rootUrl.lastIndexOf(".");if(lastDot>-1){var extension=forcedExtension?forcedExtension:rootUrl.substring(lastDot).toLowerCase();if(this._textureFormatInUse){extension=this._textureFormatInUse;rootUrl=rootUrl.substring(0,lastDot)+this._textureFormatInUse;isKTX=true}else{isDDS=extension===".dds"}}var onerror=function(request,exception){if(onError){onError(request.status+" "+request.statusText,exception)}};if(isKTX){BABYLON.Tools.LoadFile(rootUrl,function(data){var ktx=new BABYLON.Internals.KhronosTextureContainer(data,6);var loadMipmap=ktx.numberOfMipmapLevels>1&&!noMipmap;_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,1);ktx.uploadLevels(_this._gl,!noMipmap);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,loadMipmap?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,null);_this.resetTextureCache();texture.width=ktx.pixelWidth;texture.height=ktx.pixelHeight;texture.isReady=true},null,null,true,onerror)}else if(isDDS){BABYLON.Tools.LoadFile(rootUrl,function(data){var info=BABYLON.Internals.DDSTools.GetDDSInfo(data);var loadMipmap=(info.isRGB||info.isLuminance||info.mipmapCount>1)&&!noMipmap;_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,info.isCompressed?1:0);BABYLON.Internals.DDSTools.UploadDDSLevels(_this,_this._gl,data,info,loadMipmap,6);if(!noMipmap&&!info.isFourCC&&info.mipmapCount===1){gl.generateMipmap(gl.TEXTURE_CUBE_MAP)}gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,loadMipmap?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,null);_this.resetTextureCache();texture.width=info.width;texture.height=info.height;texture.isReady=true;texture.type=info.textureType;if(onLoad){onLoad({isDDS:true,width:info.width,info:info,data:data,texture:texture})}},null,null,true,onerror)}else{cascadeLoad(rootUrl,scene,function(imgs){var width=_this.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(imgs[0].width,_this._caps.maxCubemapTextureSize):imgs[0].width;var height=width;_this._prepareWorkingCanvas();_this._workingCanvas.width=width;_this._workingCanvas.height=height;var faces=[gl.TEXTURE_CUBE_MAP_POSITIVE_X,gl.TEXTURE_CUBE_MAP_POSITIVE_Y,gl.TEXTURE_CUBE_MAP_POSITIVE_Z,gl.TEXTURE_CUBE_MAP_NEGATIVE_X,gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,gl.TEXTURE_CUBE_MAP_NEGATIVE_Z];_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,0);var internalFormat=format?_this._getInternalFormat(format):_this._gl.RGBA;for(var index=0;index<faces.length;index++){_this._workingContext.drawImage(imgs[index],0,0,imgs[index].width,imgs[index].height,0,0,width,height);gl.texImage2D(faces[index],0,internalFormat,internalFormat,gl.UNSIGNED_BYTE,_this._workingCanvas)}if(!noMipmap){gl.generateMipmap(gl.TEXTURE_CUBE_MAP)}gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,noMipmap?gl.LINEAR:gl.LINEAR_MIPMAP_LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,null);_this.resetTextureCache();texture.width=width;texture.height=height;texture.isReady=true;texture.format=format;texture.onLoadedObservable.notifyObservers(texture);texture.onLoadedObservable.clear();if(onLoad){onLoad()}},files,onError)}this._internalTexturesCache.push(texture);return texture};Engine.prototype.updateRawCubeTexture=function(texture,data,format,type,invertY,compression,level){if(compression===void 0){compression=null}if(level===void 0){level=0}texture._bufferViewArray=data;texture.format=format;texture.type=type;texture.invertY=invertY;texture._compression=compression;var gl=this._gl;var textureType=this._getWebGLTextureType(type);var internalFormat=this._getInternalFormat(format);var internalSizedFomat=this._getRGBABufferInternalSizedFormat(type);var needConversion=false;if(internalFormat===gl.RGB){internalFormat=gl.RGBA;needConversion=true}this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,invertY===undefined?1:invertY?1:0);if(texture.width%4!==0){gl.pixelStorei(gl.UNPACK_ALIGNMENT,1)}for(var faceIndex=0;faceIndex<6;faceIndex++){var faceData=data[faceIndex];if(compression){gl.compressedTexImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+faceIndex,level,this.getCaps().s3tc[compression],texture.width,texture.height,0,faceData)}else{if(needConversion){faceData=this._convertRGBtoRGBATextureData(faceData,texture.width,texture.height,type)}gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+faceIndex,level,internalSizedFomat,texture.width,texture.height,0,internalFormat,textureType,faceData)}}var isPot=!this.needPOTTextures||BABYLON.Tools.IsExponentOfTwo(texture.width)&&BABYLON.Tools.IsExponentOfTwo(texture.height);if(isPot&&texture.generateMipMaps&&level===0){this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null);this.resetTextureCache();texture.isReady=true};Engine.prototype.createRawCubeTexture=function(data,size,format,type,generateMipMaps,invertY,samplingMode,compression){if(compression===void 0){compression=null}var gl=this._gl;var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_CUBERAW);texture.isCube=true;texture.generateMipMaps=generateMipMaps;texture.format=format;texture.type=type;if(!this._doNotHandleContextLost){texture._bufferViewArray=data}var textureType=this._getWebGLTextureType(type);var internalFormat=this._getInternalFormat(format);var needConversion=false;if(internalFormat===gl.RGB){internalFormat=gl.RGBA;needConversion=true}var width=size;var height=width;texture.width=width;texture.height=height;var isPot=!this.needPOTTextures||BABYLON.Tools.IsExponentOfTwo(texture.width)&&BABYLON.Tools.IsExponentOfTwo(texture.height);if(!isPot){generateMipMaps=false}if(data){this.updateRawCubeTexture(texture,data,format,type,invertY,compression)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,texture);if(data&&generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP)}if(textureType===gl.FLOAT&&!this._caps.textureFloatLinearFiltering){gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,gl.NEAREST)}else if(textureType===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering){gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,gl.NEAREST)}else{var filters=getSamplingParameters(samplingMode,generateMipMaps,gl);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,filters.mag);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,filters.min)}gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,null);return texture};Engine.prototype.createRawCubeTextureFromUrl=function(url,scene,size,format,type,noMipmap,callback,mipmmapGenerator,onLoad,onError,samplingMode,invertY){var _this=this;if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}if(invertY===void 0){invertY=false}var gl=this._gl;var texture=this.createRawCubeTexture(null,size,format,type,!noMipmap,invertY,samplingMode);scene._addPendingData(texture);texture.url=url;this._internalTexturesCache.push(texture);var onerror=function(request,exception){scene._removePendingData(texture);if(onError){onError(request.status+" "+request.statusText,exception)}};var internalCallback=function(data){var width=texture.width;var faceDataArrays=callback(data);if(mipmmapGenerator){var textureType=_this._getWebGLTextureType(type);var internalFormat=_this._getInternalFormat(format);var internalSizedFomat=_this._getRGBABufferInternalSizedFormat(type);var needConversion=false;if(internalFormat===gl.RGB){internalFormat=gl.RGBA;needConversion=true}_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,0);var mipData=mipmmapGenerator(faceDataArrays);for(var level=0;level<mipData.length;level++){var mipSize=width>>level;for(var faceIndex=0;faceIndex<6;faceIndex++){var mipFaceData=mipData[level][faceIndex];if(needConversion){mipFaceData=_this._convertRGBtoRGBATextureData(mipFaceData,mipSize,mipSize,type)}gl.texImage2D(faceIndex,level,internalSizedFomat,mipSize,mipSize,0,internalFormat,textureType,mipFaceData)}}_this._bindTextureDirectly(gl.TEXTURE_CUBE_MAP,null)}else{texture.generateMipMaps=!noMipmap;_this.updateRawCubeTexture(texture,faceDataArrays,format,type,invertY)}texture.isReady=true;_this.resetTextureCache();scene._removePendingData(texture);if(onLoad){onLoad()}};BABYLON.Tools.LoadFile(url,function(data){internalCallback(data)},undefined,scene.database,true,onerror);return texture};Engine.prototype._prepareWebGLTextureContinuation=function(texture,scene,noMipmap,isCompressed,samplingMode){var gl=this._gl;if(!gl){return}var filters=getSamplingParameters(samplingMode,!noMipmap,gl);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,filters.mag);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,filters.min);if(!noMipmap&&!isCompressed){gl.generateMipmap(gl.TEXTURE_2D)}this._bindTextureDirectly(gl.TEXTURE_2D,null);this.resetTextureCache();if(scene){scene._removePendingData(texture)}texture.onLoadedObservable.notifyObservers(texture);texture.onLoadedObservable.clear()};Engine.prototype._prepareWebGLTexture=function(texture,scene,width,height,invertY,noMipmap,isCompressed,processFunction,samplingMode){var _this=this;if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}var potWidth=this.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(width,this.getCaps().maxTextureSize):width;var potHeight=this.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(height,this.getCaps().maxTextureSize):height;var gl=this._gl;if(!gl){return}this._bindTextureDirectly(gl.TEXTURE_2D,texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,invertY===undefined?1:invertY?1:0);texture.baseWidth=width;texture.baseHeight=height;texture.width=potWidth;texture.height=potHeight;texture.isReady=true;if(processFunction(potWidth,potHeight,function(){_this._prepareWebGLTextureContinuation(texture,scene,noMipmap,isCompressed,samplingMode)})){return}this._prepareWebGLTextureContinuation(texture,scene,noMipmap,isCompressed,samplingMode)};Engine.prototype._convertRGBtoRGBATextureData=function(rgbData,width,height,textureType){var rgbaData;if(textureType===Engine.TEXTURETYPE_FLOAT){rgbaData=new Float32Array(width*height*4)}else{rgbaData=new Uint32Array(width*height*4)}for(var x=0;x<width;x++){for(var y=0;y<height;y++){var index=(y*width+x)*3;var newIndex=(y*width+x)*4;rgbaData[newIndex+0]=rgbData[index+0];rgbaData[newIndex+1]=rgbData[index+1];rgbaData[newIndex+2]=rgbData[index+2];rgbaData[newIndex+3]=1}}return rgbaData};Engine.prototype._releaseFramebufferObjects=function(texture){var gl=this._gl;if(texture._framebuffer){gl.deleteFramebuffer(texture._framebuffer);texture._framebuffer=null}if(texture._depthStencilBuffer){gl.deleteRenderbuffer(texture._depthStencilBuffer);texture._depthStencilBuffer=null}if(texture._MSAAFramebuffer){gl.deleteFramebuffer(texture._MSAAFramebuffer);texture._MSAAFramebuffer=null}if(texture._MSAARenderBuffer){gl.deleteRenderbuffer(texture._MSAARenderBuffer);texture._MSAARenderBuffer=null}};Engine.prototype._releaseTexture=function(texture){var gl=this._gl;this._releaseFramebufferObjects(texture);gl.deleteTexture(texture._webGLTexture);this.unbindAllTextures();var index=this._internalTexturesCache.indexOf(texture);if(index!==-1){this._internalTexturesCache.splice(index,1)}if(texture._lodTextureHigh){texture._lodTextureHigh.dispose()}if(texture._lodTextureMid){texture._lodTextureMid.dispose()}if(texture._lodTextureLow){texture._lodTextureLow.dispose()}};Engine.prototype.setProgram=function(program){if(this._currentProgram!==program){this._gl.useProgram(program);this._currentProgram=program}};Engine.prototype.bindSamplers=function(effect){this.setProgram(effect.getProgram());var samplers=effect.getSamplers();for(var index=0;index<samplers.length;index++){var uniform=effect.getUniform(samplers[index]);this._gl.uniform1i(uniform,index)}this._currentEffect=null};Engine.prototype.activateTexture=function(texture){if(this._activeTexture!==texture){this._gl.activeTexture(texture);this._activeTexture=texture}};Engine.prototype._bindTextureDirectly=function(target,texture){if(this._activeTexturesCache[this._activeTexture]!==texture){this._gl.bindTexture(target,texture?texture._webGLTexture:null);this._activeTexturesCache[this._activeTexture]=texture}};Engine.prototype._bindTexture=function(channel,texture){if(channel<0){return}this.activateTexture(this._gl.TEXTURE0+channel);this._bindTextureDirectly(this._gl.TEXTURE_2D,texture)};Engine.prototype.setTextureFromPostProcess=function(channel,postProcess){this._bindTexture(channel,postProcess._textures.data[postProcess._currentRenderTextureInd])};Engine.prototype.unbindAllTextures=function(){for(var channel=0;channel<this._caps.maxTexturesImageUnits;channel++){this.activateTexture(this._gl["TEXTURE"+channel]);this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}};Engine.prototype.setTexture=function(channel,uniform,texture){if(channel<0){return}this._gl.uniform1i(uniform,channel);this._setTexture(channel,texture)};Engine.prototype._setTexture=function(channel,texture){if(!texture){if(this._activeTexturesCache[channel]!=null){this.activateTexture(this._gl["TEXTURE"+channel]);this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}return}var alreadyActivated=false;if(texture.video){this.activateTexture(this._gl["TEXTURE"+channel]);alreadyActivated=true;texture.update()}else if(texture.delayLoadState===Engine.DELAYLOADSTATE_NOTLOADED){texture.delayLoad();return}var internalTexture=texture.isReady()?texture.getInternalTexture():texture.isCube?this.emptyCubeTexture:this.emptyTexture;if(this._activeTexturesCache[channel]===internalTexture){return}if(!alreadyActivated){this.activateTexture(this._gl["TEXTURE"+channel])}if(internalTexture.isCube){this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,internalTexture);if(internalTexture._cachedCoordinatesMode!==texture.coordinatesMode){internalTexture._cachedCoordinatesMode=texture.coordinatesMode;var textureWrapMode=texture.coordinatesMode!==BABYLON.Texture.CUBIC_MODE&&texture.coordinatesMode!==BABYLON.Texture.SKYBOX_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE;this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,textureWrapMode);this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,textureWrapMode)}this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,texture)}else{this._bindTextureDirectly(this._gl.TEXTURE_2D,internalTexture);if(internalTexture._cachedWrapU!==texture.wrapU){internalTexture._cachedWrapU=texture.wrapU;switch(texture.wrapU){case BABYLON.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.REPEAT);break;case BABYLON.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);break;case BABYLON.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.MIRRORED_REPEAT);break}}if(internalTexture._cachedWrapV!==texture.wrapV){internalTexture._cachedWrapV=texture.wrapV;switch(texture.wrapV){case BABYLON.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.REPEAT);break;case BABYLON.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);break;case BABYLON.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.MIRRORED_REPEAT);break}}this._setAnisotropicLevel(this._gl.TEXTURE_2D,texture)}};Engine.prototype.setTextureArray=function(channel,uniform,textures){if(channel<0){return}if(!this._textureUnits||this._textureUnits.length!==textures.length){this._textureUnits=new Int32Array(textures.length)}for(var i=0;i<textures.length;i++){this._textureUnits[i]=channel+i}this._gl.uniform1iv(uniform,this._textureUnits);for(var index=0;index<textures.length;index++){this._setTexture(channel+index,textures[index])}};Engine.prototype._setAnisotropicLevel=function(key,texture){var internalTexture=texture.getInternalTexture();if(!internalTexture){return}var anisotropicFilterExtension=this._caps.textureAnisotropicFilterExtension;var value=texture.anisotropicFilteringLevel;if(internalTexture.samplingMode!==BABYLON.Texture.LINEAR_LINEAR_MIPNEAREST&&internalTexture.samplingMode!==BABYLON.Texture.LINEAR_LINEAR_MIPLINEAR&&internalTexture.samplingMode!==BABYLON.Texture.LINEAR_LINEAR){value=1}if(anisotropicFilterExtension&&internalTexture._cachedAnisotropicFilteringLevel!==value){this._gl.texParameterf(key,anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(value,this._caps.maxAnisotropy));internalTexture._cachedAnisotropicFilteringLevel=value}};Engine.prototype.readPixels=function(x,y,width,height){var data=new Uint8Array(height*width*4);this._gl.readPixels(x,y,width,height,this._gl.RGBA,this._gl.UNSIGNED_BYTE,data);return data};Engine.prototype.addExternalData=function(key,data){if(!this._externalData){this._externalData=new BABYLON.StringDictionary}return this._externalData.add(key,data)};Engine.prototype.getExternalData=function(key){if(!this._externalData){this._externalData=new BABYLON.StringDictionary}return this._externalData.get(key)};Engine.prototype.getOrAddExternalDataWithFactory=function(key,factory){if(!this._externalData){this._externalData=new BABYLON.StringDictionary}return this._externalData.getOrAddWithFactory(key,factory)};Engine.prototype.removeExternalData=function(key){if(!this._externalData){this._externalData=new BABYLON.StringDictionary}return this._externalData.remove(key)};Engine.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=false;for(var i=0;i<this._caps.maxVertexAttribs;i++){this._gl.disableVertexAttribArray(i);this._vertexAttribArraysEnabled[i]=false;this._currentBufferPointers[i].active=false}return}for(var i=0,ul=this._vertexAttribArraysEnabled.length;i<ul;i++){if(i>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[i]){continue}this._gl.disableVertexAttribArray(i);this._vertexAttribArraysEnabled[i]=false;this._currentBufferPointers[i].active=false}};Engine.prototype.releaseEffects=function(){for(var name in this._compiledEffects){this._deleteProgram(this._compiledEffects[name]._program)}this._compiledEffects={}};Engine.prototype.dispose=function(){this.hideLoadingUI();this.stopRenderLoop();while(this.postProcesses.length){this.postProcesses[0].dispose()}if(this._emptyTexture){this._releaseTexture(this._emptyTexture);this._emptyTexture=null}if(this._emptyCubeTexture){this._releaseTexture(this._emptyCubeTexture);this._emptyCubeTexture=null}if(this._rescalePostProcess){this._rescalePostProcess.dispose()}while(this.scenes.length){this.scenes[0].dispose()}if(Engine.audioEngine){Engine.audioEngine.dispose()}this.releaseEffects();this.unbindAllAttributes();if(this._dummyFramebuffer){this._gl.deleteFramebuffer(this._dummyFramebuffer)}this._gl=null;this.disableVR();window.removeEventListener("blur",this._onBlur);window.removeEventListener("focus",this._onFocus);window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted);window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted);this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus);this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur);this._renderingCanvas.removeEventListener("pointerout",this._onCanvasBlur);if(!this._doNotHandleContextLost){this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost);this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)}document.removeEventListener("fullscreenchange",this._onFullscreenChange);document.removeEventListener("mozfullscreenchange",this._onFullscreenChange);document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange);document.removeEventListener("msfullscreenchange",this._onFullscreenChange);document.removeEventListener("pointerlockchange",this._onPointerLockChange);document.removeEventListener("mspointerlockchange",this._onPointerLockChange);document.removeEventListener("mozpointerlockchange",this._onPointerLockChange);document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange);if(this._onVrDisplayConnect){window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect);window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect);window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange);this._onVrDisplayConnect=undefined;this._onVrDisplayDisconnect=undefined}var index=Engine.Instances.indexOf(this);if(index>=0){Engine.Instances.splice(index,1)}this._workingCanvas=null;this._workingContext=null;this._currentBufferPointers=null;this._renderingCanvas=null;this._currentProgram=null;this.onResizeObservable.clear();this.onCanvasBlurObservable.clear();this.onCanvasFocusObservable.clear();this.onCanvasPointerOutObservable.clear();BABYLON.Effect.ResetCache()};Engine.prototype.displayLoadingUI=function(){if(!BABYLON.Tools.IsWindowObjectExist()){return}var loadingScreen=this.loadingScreen;if(loadingScreen){loadingScreen.displayLoadingUI()}};Engine.prototype.hideLoadingUI=function(){if(!BABYLON.Tools.IsWindowObjectExist()){return}var loadingScreen=this.loadingScreen;if(loadingScreen){loadingScreen.hideLoadingUI()}};Object.defineProperty(Engine.prototype,"loadingScreen",{get:function(){if(!this._loadingScreen&&BABYLON.DefaultLoadingScreen)this._loadingScreen=new BABYLON.DefaultLoadingScreen(this._renderingCanvas);return this._loadingScreen},set:function(loadingScreen){this._loadingScreen=loadingScreen},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"loadingUIText",{set:function(text){this.loadingScreen.loadingUIText=text},enumerable:true,configurable:true});Object.defineProperty(Engine.prototype,"loadingUIBackgroundColor",{set:function(color){this.loadingScreen.loadingUIBackgroundColor=color},enumerable:true,configurable:true});Engine.prototype.attachContextLostEvent=function(callback){this._renderingCanvas.addEventListener("webglcontextlost",callback,false)};Engine.prototype.attachContextRestoredEvent=function(callback){this._renderingCanvas.addEventListener("webglcontextrestored",callback,false)};Engine.prototype.getVertexShaderSource=function(program){var shaders=this._gl.getAttachedShaders(program);return this._gl.getShaderSource(shaders[0])};Engine.prototype.getFragmentShaderSource=function(program){var shaders=this._gl.getAttachedShaders(program);return this._gl.getShaderSource(shaders[1])};Engine.prototype.getError=function(){return this._gl.getError()};Engine.prototype.getFps=function(){return this._fps};Engine.prototype.getDeltaTime=function(){return this._deltaTime};Engine.prototype._measureFps=function(){this._performanceMonitor.sampleFrame();this._fps=this._performanceMonitor.averageFPS;this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0};Engine.prototype._readTexturePixels=function(texture,width,height,faceIndex){if(faceIndex===void 0){faceIndex=-1}var gl=this._gl;if(!this._dummyFramebuffer){this._dummyFramebuffer=gl.createFramebuffer()}gl.bindFramebuffer(gl.FRAMEBUFFER,this._dummyFramebuffer);if(faceIndex>-1){gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_CUBE_MAP_POSITIVE_X+faceIndex,texture._webGLTexture,0)}else{gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture._webGLTexture,0)}var readType=texture.type!==undefined?this._getWebGLTextureType(texture.type):gl.UNSIGNED_BYTE;var buffer;switch(readType){case gl.UNSIGNED_BYTE:buffer=new Uint8Array(4*width*height);readType=gl.UNSIGNED_BYTE;break;default:buffer=new Float32Array(4*width*height);readType=gl.FLOAT;break}gl.readPixels(0,0,width,height,gl.RGBA,readType,buffer);gl.bindFramebuffer(gl.FRAMEBUFFER,this._currentFramebuffer);return buffer};Engine.prototype._canRenderToFloatFramebuffer=function(){if(this._webGLVersion>1){return this._caps.colorBufferFloat}return this._canRenderToFramebuffer(BABYLON.Engine.TEXTURETYPE_FLOAT)};Engine.prototype._canRenderToHalfFloatFramebuffer=function(){if(this._webGLVersion>1){return this._caps.colorBufferFloat}return this._canRenderToFramebuffer(BABYLON.Engine.TEXTURETYPE_HALF_FLOAT)};Engine.prototype._canRenderToFramebuffer=function(type){var gl=this._gl;while(gl.getError()!==gl.NO_ERROR){}var successful=true;var texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(type),1,1,0,gl.RGBA,this._getWebGLTextureType(type),null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);var fb=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,fb);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);successful=successful&&status===gl.FRAMEBUFFER_COMPLETE;successful=successful&&gl.getError()===gl.NO_ERROR;if(successful){gl.clear(gl.COLOR_BUFFER_BIT);successful=successful&&gl.getError()===gl.NO_ERROR}if(successful){gl.bindFramebuffer(gl.FRAMEBUFFER,null);var readFormat=gl.RGBA;var readType=gl.UNSIGNED_BYTE;var buffer=new Uint8Array(4);gl.readPixels(0,0,1,1,readFormat,readType,buffer);successful=successful&&gl.getError()===gl.NO_ERROR}gl.deleteTexture(texture);gl.deleteFramebuffer(fb);gl.bindFramebuffer(gl.FRAMEBUFFER,null);while(!successful&&gl.getError()!==gl.NO_ERROR){}return successful};Engine.prototype._getWebGLTextureType=function(type){if(type===Engine.TEXTURETYPE_FLOAT){return this._gl.FLOAT}else if(type===Engine.TEXTURETYPE_HALF_FLOAT){return this._gl.HALF_FLOAT_OES}return this._gl.UNSIGNED_BYTE};Engine.prototype._getRGBABufferInternalSizedFormat=function(type){if(this._webGLVersion===1){return this._gl.RGBA}if(type===Engine.TEXTURETYPE_FLOAT){return this._gl.RGBA32F}else if(type===Engine.TEXTURETYPE_HALF_FLOAT){return this._gl.RGBA16F}return this._gl.RGBA};Engine.prototype.createQuery=function(){return this._gl.createQuery()};Engine.prototype.deleteQuery=function(query){this._gl.deleteQuery(query);return this};Engine.prototype.isQueryResultAvailable=function(query){return this._gl.getQueryParameter(query,this._gl.QUERY_RESULT_AVAILABLE)};Engine.prototype.getQueryResult=function(query){return this._gl.getQueryParameter(query,this._gl.QUERY_RESULT)};Engine.prototype.beginQuery=function(algorithmType,query){var glAlgorithm=this.getGlAlgorithmType(algorithmType);this._gl.beginQuery(glAlgorithm,query)};Engine.prototype.endQuery=function(algorithmType){var glAlgorithm=this.getGlAlgorithmType(algorithmType);this._gl.endQuery(glAlgorithm);return this};Engine.prototype.getGlAlgorithmType=function(algorithmType){return algorithmType===BABYLON.AbstractMesh.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};Engine.isSupported=function(){try{if(navigator.isCocoonJS){return true}var tempcanvas=document.createElement("canvas");var gl=tempcanvas.getContext("webgl")||tempcanvas.getContext("experimental-webgl");return gl!=null&&!!window.WebGLRenderingContext}catch(e){return false}};Engine.Instances=new Array;Engine._ALPHA_DISABLE=0;Engine._ALPHA_ADD=1;Engine._ALPHA_COMBINE=2;Engine._ALPHA_SUBTRACT=3;Engine._ALPHA_MULTIPLY=4;Engine._ALPHA_MAXIMIZED=5;Engine._ALPHA_ONEONE=6;Engine._ALPHA_PREMULTIPLIED=7;Engine._ALPHA_PREMULTIPLIED_PORTERDUFF=8;Engine._ALPHA_INTERPOLATE=9;Engine._ALPHA_SCREENMODE=10;Engine._DELAYLOADSTATE_NONE=0;Engine._DELAYLOADSTATE_LOADED=1;Engine._DELAYLOADSTATE_LOADING=2;Engine._DELAYLOADSTATE_NOTLOADED=4;Engine._TEXTUREFORMAT_ALPHA=0;Engine._TEXTUREFORMAT_LUMINANCE=1;Engine._TEXTUREFORMAT_LUMINANCE_ALPHA=2;Engine._TEXTUREFORMAT_RGB=4;Engine._TEXTUREFORMAT_RGBA=5;Engine._TEXTURETYPE_UNSIGNED_INT=0;Engine._TEXTURETYPE_FLOAT=1;Engine._TEXTURETYPE_HALF_FLOAT=2;Engine._NEVER=512;Engine._ALWAYS=519;Engine._LESS=513;Engine._EQUAL=514;Engine._LEQUAL=515;Engine._GREATER=516;Engine._GEQUAL=518;Engine._NOTEQUAL=517;Engine._KEEP=7680;Engine._REPLACE=7681;Engine._INCR=7682;Engine._DECR=7683;Engine._INVERT=5386;Engine._INCR_WRAP=34055;Engine._DECR_WRAP=34056;Engine._SCALEMODE_FLOOR=1;Engine._SCALEMODE_NEAREST=2;Engine._SCALEMODE_CEILING=3;Engine.CollisionsEpsilon=.001;Engine.CodeRepository="src/";Engine.ShadersRepository="src/Shaders/";return Engine}();BABYLON.Engine=Engine})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Node=function(){function Node(name,scene){this.state="";this.metadata=null;this.doNotSerialize=false;this.animations=new Array;this._ranges={};this._isEnabled=true;this._isReady=true;this._currentRenderId=-1;this._parentRenderId=-1;this.onDisposeObservable=new BABYLON.Observable;this._behaviors=new Array;this.name=name;this.id=name;this._scene=scene||BABYLON.Engine.LastCreatedScene;this.uniqueId=this._scene.getUniqueId();this._initCache()}Object.defineProperty(Node.prototype,"parent",{get:function(){return this._parentNode},set:function(parent){if(this._parentNode===parent){return}if(this._parentNode){var index=this._parentNode._children.indexOf(this);if(index!==-1){this._parentNode._children.splice(index,1)}}this._parentNode=parent;if(this._parentNode){if(!this._parentNode._children){this._parentNode._children=new Array}this._parentNode._children.push(this)}},enumerable:true,configurable:true});Node.prototype.getClassName=function(){return"Node"};Object.defineProperty(Node.prototype,"onDispose",{set:function(callback){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(callback)},enumerable:true,configurable:true});Node.prototype.getScene=function(){return this._scene};Node.prototype.getEngine=function(){return this._scene.getEngine()};Node.prototype.addBehavior=function(behavior){var index=this._behaviors.indexOf(behavior);if(index!==-1){return this}behavior.attach(this);this._behaviors.push(behavior);return this};Node.prototype.removeBehavior=function(behavior){var index=this._behaviors.indexOf(behavior);if(index===-1){return this}this._behaviors[index].detach();this._behaviors.splice(index,1);return this};Object.defineProperty(Node.prototype,"behaviors",{get:function(){return this._behaviors},enumerable:true,configurable:true});Node.prototype.getBehaviorByName=function(name){for(var _i=0,_a=this._behaviors;_i<_a.length;_i++){var behavior=_a[_i];if(behavior.name===name){return behavior}}return null};Node.prototype.getWorldMatrix=function(){return BABYLON.Matrix.Identity()};Node.prototype._initCache=function(){this._cache={};this._cache.parent=undefined};Node.prototype.updateCache=function(force){if(!force&&this.isSynchronized())return;this._cache.parent=this.parent;this._updateCache()};Node.prototype._updateCache=function(ignoreParentClass){};Node.prototype._isSynchronized=function(){return true};Node.prototype._markSyncedWithParent=function(){this._parentRenderId=this.parent._currentRenderId};Node.prototype.isSynchronizedWithParent=function(){if(!this.parent){return true}if(this._parentRenderId!==this.parent._currentRenderId){return false}return this.parent.isSynchronized()};Node.prototype.isSynchronized=function(updateCache){var check=this.hasNewParent();check=check||!this.isSynchronizedWithParent();check=check||!this._isSynchronized();if(updateCache)this.updateCache(true);return!check};Node.prototype.hasNewParent=function(update){if(this._cache.parent===this.parent)return false;if(update)this._cache.parent=this.parent;return true};Node.prototype.isReady=function(){return this._isReady};Node.prototype.isEnabled=function(){if(!this._isEnabled){return false}if(this.parent){return this.parent.isEnabled()}return true};Node.prototype.setEnabled=function(value){this._isEnabled=value};Node.prototype.isDescendantOf=function(ancestor){if(this.parent){if(this.parent===ancestor){return true}return this.parent.isDescendantOf(ancestor)}return false};Node.prototype._getDescendants=function(results,directDescendantsOnly,predicate){if(directDescendantsOnly===void 0){directDescendantsOnly=false}if(!this._children){return}for(var index=0;index<this._children.length;index++){var item=this._children[index];if(!predicate||predicate(item)){results.push(item)}if(!directDescendantsOnly){item._getDescendants(results,false,predicate)}}};Node.prototype.getDescendants=function(directDescendantsOnly,predicate){var results=new Array;this._getDescendants(results,directDescendantsOnly,predicate);return results};Node.prototype.getChildMeshes=function(directDecendantsOnly,predicate){var results=[];this._getDescendants(results,directDecendantsOnly,function(node){return(!predicate||predicate(node))&&node instanceof BABYLON.AbstractMesh});return results};Node.prototype.getChildren=function(predicate){return this.getDescendants(true,predicate)};Node.prototype._setReady=function(state){if(state===this._isReady){return}if(!state){this._isReady=false;return}this._isReady=true;if(this.onReady){this.onReady(this)}};Node.prototype.getAnimationByName=function(name){for(var i=0;i<this.animations.length;i++){var animation=this.animations[i];if(animation.name===name){return animation}}return null};Node.prototype.createAnimationRange=function(name,from,to){if(!this._ranges[name]){this._ranges[name]=new BABYLON.AnimationRange(name,from,to);for(var i=0,nAnimations=this.animations.length;i<nAnimations;i++){if(this.animations[i]){this.animations[i].createRange(name,from,to)}}}};Node.prototype.deleteAnimationRange=function(name,deleteFrames){if(deleteFrames===void 0){deleteFrames=true}for(var i=0,nAnimations=this.animations.length;i<nAnimations;i++){if(this.animations[i]){this.animations[i].deleteRange(name,deleteFrames)}}this._ranges[name]=undefined};Node.prototype.getAnimationRange=function(name){return this._ranges[name]};Node.prototype.beginAnimation=function(name,loop,speedRatio,onAnimationEnd){var range=this.getAnimationRange(name);if(!range){return null}this._scene.beginAnimation(this,range.from,range.to,loop,speedRatio,onAnimationEnd)};Node.prototype.serializeAnimationRanges=function(){var serializationRanges=[];for(var name in this._ranges){var range={};range.name=name;range.from=this._ranges[name].from;range.to=this._ranges[name].to;serializationRanges.push(range)}return serializationRanges};Node.prototype.dispose=function(){this.parent=null;this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();for(var _i=0,_a=this._behaviors;_i<_a.length;_i++){var behavior=_a[_i];behavior.detach()}this._behaviors=[]};Node.ParseAnimationRanges=function(node,parsedNode,scene){if(parsedNode.ranges){for(var index=0;index<parsedNode.ranges.length;index++){var data=parsedNode.ranges[index];node.createAnimationRange(data.name,data.from,data.to)}}};__decorate([BABYLON.serialize()],Node.prototype,"name",void 0);__decorate([BABYLON.serialize()],Node.prototype,"id",void 0);__decorate([BABYLON.serialize()],Node.prototype,"uniqueId",void 0);__decorate([BABYLON.serialize()],Node.prototype,"state",void 0);__decorate([BABYLON.serialize()],Node.prototype,"metadata",void 0);return Node}();BABYLON.Node=Node})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BoundingSphere=function(){function BoundingSphere(minimum,maximum){this.minimum=minimum;this.maximum=maximum;this._tempRadiusVector=BABYLON.Vector3.Zero();var distance=BABYLON.Vector3.Distance(minimum,maximum);this.center=BABYLON.Vector3.Lerp(minimum,maximum,.5);this.radius=distance*.5;this.centerWorld=BABYLON.Vector3.Zero();this._update(BABYLON.Matrix.Identity())}BoundingSphere.prototype._update=function(world){BABYLON.Vector3.TransformCoordinatesToRef(this.center,world,this.centerWorld);BABYLON.Vector3.TransformNormalFromFloatsToRef(1,1,1,world,this._tempRadiusVector);this.radiusWorld=Math.max(Math.abs(this._tempRadiusVector.x),Math.abs(this._tempRadiusVector.y),Math.abs(this._tempRadiusVector.z))*this.radius};BoundingSphere.prototype.isInFrustum=function(frustumPlanes){for(var i=0;i<6;i++){if(frustumPlanes[i].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return false}return true};BoundingSphere.prototype.intersectsPoint=function(point){var x=this.centerWorld.x-point.x;var y=this.centerWorld.y-point.y;var z=this.centerWorld.z-point.z;var distance=Math.sqrt(x*x+y*y+z*z);if(Math.abs(this.radiusWorld-distance)<BABYLON.Epsilon)return false;return true};BoundingSphere.Intersects=function(sphere0,sphere1){var x=sphere0.centerWorld.x-sphere1.centerWorld.x;var y=sphere0.centerWorld.y-sphere1.centerWorld.y;var z=sphere0.centerWorld.z-sphere1.centerWorld.z;var distance=Math.sqrt(x*x+y*y+z*z);if(sphere0.radiusWorld+sphere1.radiusWorld<distance)return false;return true};return BoundingSphere}();BABYLON.BoundingSphere=BoundingSphere})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BoundingBox=function(){function BoundingBox(minimum,maximum){this.minimum=minimum;this.maximum=maximum;this.vectors=new Array;this.vectorsWorld=new Array;this.vectors.push(this.minimum.clone());this.vectors.push(this.maximum.clone());this.vectors.push(this.minimum.clone());this.vectors[2].x=this.maximum.x;this.vectors.push(this.minimum.clone());this.vectors[3].y=this.maximum.y;this.vectors.push(this.minimum.clone());this.vectors[4].z=this.maximum.z;this.vectors.push(this.maximum.clone());this.vectors[5].z=this.minimum.z;this.vectors.push(this.maximum.clone());this.vectors[6].x=this.minimum.x;this.vectors.push(this.maximum.clone());this.vectors[7].y=this.minimum.y;this.center=this.maximum.add(this.minimum).scale(.5);this.extendSize=this.maximum.subtract(this.minimum).scale(.5);this.directions=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];for(var index=0;index<this.vectors.length;index++){this.vectorsWorld[index]=BABYLON.Vector3.Zero()}this.minimumWorld=BABYLON.Vector3.Zero();this.maximumWorld=BABYLON.Vector3.Zero();this.centerWorld=BABYLON.Vector3.Zero();this.extendSizeWorld=BABYLON.Vector3.Zero();this._update(BABYLON.Matrix.Identity())}BoundingBox.prototype.getWorldMatrix=function(){return this._worldMatrix};BoundingBox.prototype.setWorldMatrix=function(matrix){this._worldMatrix.copyFrom(matrix);return this};BoundingBox.prototype._update=function(world){BABYLON.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld);BABYLON.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximumWorld);for(var index=0;index<this.vectors.length;index++){var v=this.vectorsWorld[index];BABYLON.Vector3.TransformCoordinatesToRef(this.vectors[index],world,v);if(v.x<this.minimumWorld.x)this.minimumWorld.x=v.x;if(v.y<this.minimumWorld.y)this.minimumWorld.y=v.y;if(v.z<this.minimumWorld.z)this.minimumWorld.z=v.z;if(v.x>this.maximumWorld.x)this.maximumWorld.x=v.x;if(v.y>this.maximumWorld.y)this.maximumWorld.y=v.y;if(v.z>this.maximumWorld.z)this.maximumWorld.z=v.z}this.maximumWorld.subtractToRef(this.minimumWorld,this.extendSizeWorld);this.extendSizeWorld.scaleInPlace(.5);this.maximumWorld.addToRef(this.minimumWorld,this.centerWorld);this.centerWorld.scaleInPlace(.5);BABYLON.Vector3.FromFloatArrayToRef(world.m,0,this.directions[0]);BABYLON.Vector3.FromFloatArrayToRef(world.m,4,this.directions[1]);BABYLON.Vector3.FromFloatArrayToRef(world.m,8,this.directions[2]);this._worldMatrix=world};BoundingBox.prototype.isInFrustum=function(frustumPlanes){return BoundingBox.IsInFrustum(this.vectorsWorld,frustumPlanes)};BoundingBox.prototype.isCompletelyInFrustum=function(frustumPlanes){return BoundingBox.IsCompletelyInFrustum(this.vectorsWorld,frustumPlanes)};BoundingBox.prototype.intersectsPoint=function(point){var delta=-BABYLON.Epsilon;if(this.maximumWorld.x-point.x<delta||delta>point.x-this.minimumWorld.x)return false;if(this.maximumWorld.y-point.y<delta||delta>point.y-this.minimumWorld.y)return false;if(this.maximumWorld.z-point.z<delta||delta>point.z-this.minimumWorld.z)return false;return true};BoundingBox.prototype.intersectsSphere=function(sphere){return BoundingBox.IntersectsSphere(this.minimumWorld,this.maximumWorld,sphere.centerWorld,sphere.radiusWorld)};BoundingBox.prototype.intersectsMinMax=function(min,max){if(this.maximumWorld.x<min.x||this.minimumWorld.x>max.x)return false;if(this.maximumWorld.y<min.y||this.minimumWorld.y>max.y)return false;if(this.maximumWorld.z<min.z||this.minimumWorld.z>max.z)return false;return true};BoundingBox.Intersects=function(box0,box1){if(box0.maximumWorld.x<box1.minimumWorld.x||box0.minimumWorld.x>box1.maximumWorld.x)return false;if(box0.maximumWorld.y<box1.minimumWorld.y||box0.minimumWorld.y>box1.maximumWorld.y)return false;if(box0.maximumWorld.z<box1.minimumWorld.z||box0.minimumWorld.z>box1.maximumWorld.z)return false;return true};BoundingBox.IntersectsSphere=function(minPoint,maxPoint,sphereCenter,sphereRadius){var vector=BABYLON.Vector3.Clamp(sphereCenter,minPoint,maxPoint);var num=BABYLON.Vector3.DistanceSquared(sphereCenter,vector);return num<=sphereRadius*sphereRadius};BoundingBox.IsCompletelyInFrustum=function(boundingVectors,frustumPlanes){for(var p=0;p<6;p++){for(var i=0;i<8;i++){if(frustumPlanes[p].dotCoordinate(boundingVectors[i])<0){return false}}}return true};BoundingBox.IsInFrustum=function(boundingVectors,frustumPlanes){for(var p=0;p<6;p++){var inCount=8;for(var i=0;i<8;i++){if(frustumPlanes[p].dotCoordinate(boundingVectors[i])<0){--inCount}else{break}}if(inCount===0)return false}return true};return BoundingBox}();BABYLON.BoundingBox=BoundingBox})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var computeBoxExtents=function(axis,box){var p=BABYLON.Vector3.Dot(box.centerWorld,axis);var r0=Math.abs(BABYLON.Vector3.Dot(box.directions[0],axis))*box.extendSize.x;var r1=Math.abs(BABYLON.Vector3.Dot(box.directions[1],axis))*box.extendSize.y;var r2=Math.abs(BABYLON.Vector3.Dot(box.directions[2],axis))*box.extendSize.z;var r=r0+r1+r2;return{min:p-r,max:p+r}};var extentsOverlap=function(min0,max0,min1,max1){return!(min0>max1||min1>max0)};var axisOverlap=function(axis,box0,box1){var result0=computeBoxExtents(axis,box0);var result1=computeBoxExtents(axis,box1);return extentsOverlap(result0.min,result0.max,result1.min,result1.max)};var BoundingInfo=function(){function BoundingInfo(minimum,maximum){this.minimum=minimum;this.maximum=maximum;this._isLocked=false;this.boundingBox=new BABYLON.BoundingBox(minimum,maximum);this.boundingSphere=new BABYLON.BoundingSphere(minimum,maximum)}Object.defineProperty(BoundingInfo.prototype,"isLocked",{get:function(){return this._isLocked},set:function(value){this._isLocked=value},enumerable:true,configurable:true});BoundingInfo.prototype.update=function(world){if(this._isLocked){return}this.boundingBox._update(world);this.boundingSphere._update(world)};BoundingInfo.prototype.isInFrustum=function(frustumPlanes){if(!this.boundingSphere.isInFrustum(frustumPlanes))return false;return this.boundingBox.isInFrustum(frustumPlanes)};Object.defineProperty(BoundingInfo.prototype,"diagonalLength",{get:function(){var boundingBox=this.boundingBox;var size=boundingBox.maximumWorld.subtract(boundingBox.minimumWorld);return size.length()},enumerable:true,configurable:true});BoundingInfo.prototype.isCompletelyInFrustum=function(frustumPlanes){return this.boundingBox.isCompletelyInFrustum(frustumPlanes)};BoundingInfo.prototype._checkCollision=function(collider){return collider._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)};BoundingInfo.prototype.intersectsPoint=function(point){if(!this.boundingSphere.centerWorld){return false}if(!this.boundingSphere.intersectsPoint(point)){return false}if(!this.boundingBox.intersectsPoint(point)){return false}return true};BoundingInfo.prototype.intersects=function(boundingInfo,precise){if(!this.boundingSphere.centerWorld||!boundingInfo.boundingSphere.centerWorld){return false}if(!BABYLON.BoundingSphere.Intersects(this.boundingSphere,boundingInfo.boundingSphere)){return false}if(!BABYLON.BoundingBox.Intersects(this.boundingBox,boundingInfo.boundingBox)){return false}if(!precise){return true}var box0=this.boundingBox;var box1=boundingInfo.boundingBox;if(!axisOverlap(box0.directions[0],box0,box1))return false;if(!axisOverlap(box0.directions[1],box0,box1))return false;if(!axisOverlap(box0.directions[2],box0,box1))return false;if(!axisOverlap(box1.directions[0],box0,box1))return false;if(!axisOverlap(box1.directions[1],box0,box1))return false;if(!axisOverlap(box1.directions[2],box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[0],box1.directions[0]),box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[0],box1.directions[1]),box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[0],box1.directions[2]),box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[1],box1.directions[0]),box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[1],box1.directions[1]),box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[1],box1.directions[2]),box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[2],box1.directions[0]),box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[2],box1.directions[1]),box0,box1))return false;if(!axisOverlap(BABYLON.Vector3.Cross(box0.directions[2],box1.directions[2]),box0,box1))return false;return true};return BoundingInfo}();BABYLON.BoundingInfo=BoundingInfo})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var AbstractMesh=function(_super){__extends(AbstractMesh,_super);function AbstractMesh(name,scene){var _this=_super.call(this,name,scene)||this;_this._facetNb=0;_this._partitioningSubdivisions=10;_this._partitioningBBoxRatio=1.01;_this._facetDataEnabled=false;_this._facetParameters={};_this._bbSize=BABYLON.Vector3.Zero();_this._subDiv={max:1,X:1,Y:1,Z:1};_this.onCollideObservable=new BABYLON.Observable;_this.onCollisionPositionChangeObservable=new BABYLON.Observable;_this.onAfterWorldMatrixUpdateObservable=new BABYLON.Observable;_this.onMaterialChangedObservable=new BABYLON.Observable;_this.definedFacingForward=true;_this.position=BABYLON.Vector3.Zero();_this.occlusionQueryAlgorithmType=AbstractMesh.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE;_this.occlusionType=AbstractMesh.OCCLUSION_TYPE_NONE;_this.occlusionRetryCount=-1;_this._occlusionInternalRetryCounter=0;_this._isOccluded=false;_this._isOcclusionQueryInProgress=false;_this._rotation=BABYLON.Vector3.Zero();_this._scaling=BABYLON.Vector3.One();_this.billboardMode=AbstractMesh.BILLBOARDMODE_NONE;_this.visibility=1;_this.alphaIndex=Number.MAX_VALUE;_this.infiniteDistance=false;_this.isVisible=true;_this.isPickable=true;_this.showBoundingBox=false;_this.showSubMeshesBoundingBox=false;_this.isBlocker=false;_this.enablePointerMoveEvents=false;_this.renderingGroupId=0;_this._receiveShadows=false;_this.renderOutline=false;_this.outlineColor=BABYLON.Color3.Red();_this.outlineWidth=.02;_this.renderOverlay=false;_this.overlayColor=BABYLON.Color3.Red();_this.overlayAlpha=.5;_this._hasVertexAlpha=false;_this._useVertexColors=true;_this._computeBonesUsingShaders=true;_this._numBoneInfluencers=4;_this._applyFog=true;_this.scalingDeterminant=1;_this.useOctreeForRenderingSelection=true;_this.useOctreeForPicking=true;_this.useOctreeForCollisions=true;_this._layerMask=268435455;_this.alwaysSelectAsActiveMesh=false;_this._checkCollisions=false;_this._collisionMask=-1;_this._collisionGroup=-1;_this.ellipsoid=new BABYLON.Vector3(.5,1,.5);_this.ellipsoidOffset=new BABYLON.Vector3(0,0,0);_this._oldPositionForCollisions=new BABYLON.Vector3(0,0,0);_this._diffPositionForCollisions=new BABYLON.Vector3(0,0,0);_this.edgesWidth=1;_this.edgesColor=new BABYLON.Color4(1,0,0,1);_this._localWorld=BABYLON.Matrix.Zero();_this._worldMatrix=BABYLON.Matrix.Zero();_this._absolutePosition=BABYLON.Vector3.Zero();_this._collisionsTransformMatrix=BABYLON.Matrix.Zero();_this._collisionsScalingMatrix=BABYLON.Matrix.Zero();_this._isDirty=false;_this._pivotMatrix=BABYLON.Matrix.Identity();_this._postMultiplyPivotMatrix=false;_this._isDisposed=false;_this._renderId=0;_this._intersectionsInProgress=new Array;_this._isWorldMatrixFrozen=false;_this._unIndexed=false;_this._lightSources=new Array;_this._onCollisionPositionChange=function(collisionId,newPosition,collidedMesh){if(collidedMesh===void 0){collidedMesh=null}if(_this.getScene().workerCollisions)newPosition.multiplyInPlace(_this._collider.radius);newPosition.subtractToRef(_this._oldPositionForCollisions,_this._diffPositionForCollisions);if(_this._diffPositionForCollisions.length()>BABYLON.Engine.CollisionsEpsilon){_this.position.addInPlace(_this._diffPositionForCollisions)}if(collidedMesh){_this.onCollideObservable.notifyObservers(collidedMesh)}_this.onCollisionPositionChangeObservable.notifyObservers(_this.position)};_this.getScene().addMesh(_this);_this._resyncLightSources();return _this}Object.defineProperty(AbstractMesh,"BILLBOARDMODE_NONE",{get:function(){return AbstractMesh._BILLBOARDMODE_NONE},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh,"BILLBOARDMODE_X",{get:function(){return AbstractMesh._BILLBOARDMODE_X},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh,"BILLBOARDMODE_Y",{get:function(){return AbstractMesh._BILLBOARDMODE_Y},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh,"BILLBOARDMODE_Z",{get:function(){return AbstractMesh._BILLBOARDMODE_Z},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh,"BILLBOARDMODE_ALL",{get:function(){return AbstractMesh._BILLBOARDMODE_ALL},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"facetNb",{get:function(){return this._facetNb},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"partitioningSubdivisions",{get:function(){return this._partitioningSubdivisions},set:function(nb){this._partitioningSubdivisions=nb},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"partitioningBBoxRatio",{get:function(){return this._partitioningBBoxRatio},set:function(ratio){this._partitioningBBoxRatio=ratio},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"isFacetDataEnabled",{get:function(){return this._facetDataEnabled},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"onCollide",{set:function(callback){if(this._onCollideObserver){this.onCollideObservable.remove(this._onCollideObserver)}this._onCollideObserver=this.onCollideObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"onCollisionPositionChange",{set:function(callback){if(this._onCollisionPositionChangeObserver){this.onCollisionPositionChangeObservable.remove(this._onCollisionPositionChangeObserver)}this._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"isOccluded",{get:function(){return this._isOccluded},set:function(value){this._isOccluded=value},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"isOcclusionQueryInProgress",{get:function(){return this._isOcclusionQueryInProgress},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"material",{get:function(){return this._material},set:function(value){if(this._material===value){return}this._material=value;if(this.onMaterialChangedObservable.hasObservers){this.onMaterialChangedObservable.notifyObservers(this)}if(!this.subMeshes){return}for(var _i=0,_a=this.subMeshes;_i<_a.length;_i++){var subMesh=_a[_i];subMesh.setEffect(null)}},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(value){if(this._receiveShadows===value){return}this._receiveShadows=value;this._markSubMeshesAsLightDirty()},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"hasVertexAlpha",{get:function(){return this._hasVertexAlpha},set:function(value){if(this._hasVertexAlpha===value){return}this._hasVertexAlpha=value;this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"useVertexColors",{get:function(){return this._useVertexColors},set:function(value){if(this._useVertexColors===value){return}this._useVertexColors=value;this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"computeBonesUsingShaders",{get:function(){return this._computeBonesUsingShaders},set:function(value){if(this._computeBonesUsingShaders===value){return}this._computeBonesUsingShaders=value;this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"numBoneInfluencers",{get:function(){return this._numBoneInfluencers},set:function(value){if(this._numBoneInfluencers===value){return}this._numBoneInfluencers=value;this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"applyFog",{get:function(){return this._applyFog},set:function(value){if(this._applyFog===value){return}this._applyFog=value;this._markSubMeshesAsMiscDirty()},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"layerMask",{get:function(){return this._layerMask},set:function(value){if(value===this._layerMask){return}this._layerMask=value;this._resyncLightSources()},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(mask){this._collisionMask=!isNaN(mask)?mask:-1},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"collisionGroup",{get:function(){return this._collisionGroup},set:function(mask){this._collisionGroup=!isNaN(mask)?mask:-1},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"_positions",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"skeleton",{get:function(){return this._skeleton},set:function(value){if(this._skeleton&&this._skeleton.needInitialSkinMatrix){this._skeleton._unregisterMeshWithPoseMatrix(this)}if(value&&value.needInitialSkinMatrix){value._registerMeshWithPoseMatrix(this)}this._skeleton=value;if(!this._skeleton){this._bonesTransformMatrices=null}this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});AbstractMesh.prototype.isDisposed=function(){return this._isDisposed};AbstractMesh.prototype.getClassName=function(){return"AbstractMesh"};AbstractMesh.prototype.toString=function(fullDetails){var ret="Name: "+this.name+", isInstance: "+(this instanceof BABYLON.InstancedMesh?"YES":"NO");ret+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);if(this._skeleton){ret+=", skeleton: "+this._skeleton.name}if(fullDetails){ret+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode];ret+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingFreezeWorldMatrix?"YES":"NO")}return ret};AbstractMesh.prototype._rebuild=function(){if(this._occlusionQuery){this._occlusionQuery=null}if(this._edgesRenderer){this._edgesRenderer._rebuild()}if(!this.subMeshes){return}for(var _i=0,_a=this.subMeshes;_i<_a.length;_i++){var subMesh=_a[_i];subMesh._rebuild()}};AbstractMesh.prototype._resyncLightSources=function(){this._lightSources.length=0;for(var _i=0,_a=this.getScene().lights;_i<_a.length;_i++){var light=_a[_i];if(!light.isEnabled()){continue}if(light.canAffectMesh(this)){this._lightSources.push(light)}}this._markSubMeshesAsLightDirty()};AbstractMesh.prototype._resyncLighSource=function(light){var isIn=light.isEnabled()&&light.canAffectMesh(this);var index=this._lightSources.indexOf(light);if(index===-1){if(!isIn){return}this._lightSources.push(light)}else{if(isIn){return}this._lightSources.splice(index,1)}this._markSubMeshesAsLightDirty()};AbstractMesh.prototype._removeLightSource=function(light){var index=this._lightSources.indexOf(light);if(index===-1){return}this._lightSources.splice(index,1)};AbstractMesh.prototype._markSubMeshesAsDirty=function(func){if(!this.subMeshes){return}for(var _i=0,_a=this.subMeshes;_i<_a.length;_i++){var subMesh=_a[_i];if(subMesh._materialDefines){func(subMesh._materialDefines)}}};AbstractMesh.prototype._markSubMeshesAsLightDirty=function(){this._markSubMeshesAsDirty(function(defines){return defines.markAsLightDirty()})};AbstractMesh.prototype._markSubMeshesAsAttributesDirty=function(){this._markSubMeshesAsDirty(function(defines){return defines.markAsAttributesDirty()})};AbstractMesh.prototype._markSubMeshesAsMiscDirty=function(){if(!this.subMeshes){return}for(var _i=0,_a=this.subMeshes;_i<_a.length;_i++){var subMesh=_a[_i];var material=subMesh.getMaterial();if(material){material.markAsDirty(BABYLON.Material.MiscDirtyFlag)}}};Object.defineProperty(AbstractMesh.prototype,"rotation",{get:function(){return this._rotation},set:function(newRotation){this._rotation=newRotation},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"scaling",{get:function(){return this._scaling},set:function(newScaling){this._scaling=newScaling;if(this.physicsImpostor){this.physicsImpostor.forceUpdate()}},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"rotationQuaternion",{get:function(){return this._rotationQuaternion},set:function(quaternion){this._rotationQuaternion=quaternion;if(quaternion&&this.rotation.length()){this.rotation.copyFromFloats(0,0,0)}},enumerable:true,configurable:true});AbstractMesh.prototype.updatePoseMatrix=function(matrix){this._poseMatrix.copyFrom(matrix);return this};AbstractMesh.prototype.getPoseMatrix=function(){return this._poseMatrix};AbstractMesh.prototype.disableEdgesRendering=function(){if(this._edgesRenderer!==undefined){this._edgesRenderer.dispose();this._edgesRenderer=undefined}return this};AbstractMesh.prototype.enableEdgesRendering=function(epsilon,checkVerticesInsteadOfIndices){if(epsilon===void 0){epsilon=.95}if(checkVerticesInsteadOfIndices===void 0){checkVerticesInsteadOfIndices=false}this.disableEdgesRendering();this._edgesRenderer=new BABYLON.EdgesRenderer(this,epsilon,checkVerticesInsteadOfIndices);return this};Object.defineProperty(AbstractMesh.prototype,"isBlocked",{get:function(){return false},enumerable:true,configurable:true});AbstractMesh.prototype.getLOD=function(camera){return this};AbstractMesh.prototype.getTotalVertices=function(){return 0};AbstractMesh.prototype.getIndices=function(){return null};AbstractMesh.prototype.getVerticesData=function(kind){return null};AbstractMesh.prototype.setVerticesData=function(kind,data,updatable,stride){return null};AbstractMesh.prototype.updateVerticesData=function(kind,data,updateExtends,makeItUnique){return null};AbstractMesh.prototype.setIndices=function(indices,totalVertices){return null};AbstractMesh.prototype.isVerticesDataPresent=function(kind){return false};AbstractMesh.prototype.getBoundingInfo=function(){if(this._masterMesh){return this._masterMesh.getBoundingInfo()}if(!this._boundingInfo){this._updateBoundingInfo()}return this._boundingInfo};AbstractMesh.prototype.setBoundingInfo=function(boundingInfo){this._boundingInfo=boundingInfo;return this};Object.defineProperty(AbstractMesh.prototype,"useBones",{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)&&this.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)},enumerable:true,configurable:true});AbstractMesh.prototype._preActivate=function(){};AbstractMesh.prototype._preActivateForIntermediateRendering=function(renderId){};AbstractMesh.prototype._activate=function(renderId){this._renderId=renderId};AbstractMesh.prototype.getWorldMatrix=function(){if(this._masterMesh){return this._masterMesh.getWorldMatrix()}if(this._currentRenderId!==this.getScene().getRenderId()||!this.isSynchronized()){this.computeWorldMatrix()}return this._worldMatrix};Object.defineProperty(AbstractMesh.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:true,configurable:true});Object.defineProperty(AbstractMesh.prototype,"absolutePosition",{get:function(){return this._absolutePosition},enumerable:true,configurable:true});AbstractMesh.prototype.freezeWorldMatrix=function(){this._isWorldMatrixFrozen=false;this.computeWorldMatrix(true);this._isWorldMatrixFrozen=true;return this};AbstractMesh.prototype.unfreezeWorldMatrix=function(){this._isWorldMatrixFrozen=false;this.computeWorldMatrix(true);return this};Object.defineProperty(AbstractMesh.prototype,"isWorldMatrixFrozen",{get:function(){return this._isWorldMatrixFrozen},enumerable:true,configurable:true});AbstractMesh.prototype.rotate=function(axis,amount,space){axis.normalize();if(!this.rotationQuaternion){this.rotationQuaternion=BABYLON.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);this.rotation=BABYLON.Vector3.Zero()}var rotationQuaternion;if(!space||space===BABYLON.Space.LOCAL){rotationQuaternion=BABYLON.Quaternion.RotationAxisToRef(axis,amount,AbstractMesh._rotationAxisCache);this.rotationQuaternion.multiplyToRef(rotationQuaternion,this.rotationQuaternion)}else{if(this.parent){var invertParentWorldMatrix=this.parent.getWorldMatrix().clone();invertParentWorldMatrix.invert();axis=BABYLON.Vector3.TransformNormal(axis,invertParentWorldMatrix)}rotationQuaternion=BABYLON.Quaternion.RotationAxisToRef(axis,amount,AbstractMesh._rotationAxisCache);rotationQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this};AbstractMesh.prototype.rotateAround=function(point,axis,amount){axis.normalize();if(!this.rotationQuaternion){this.rotationQuaternion=BABYLON.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);this.rotation.copyFromFloats(0,0,0)}point.subtractToRef(this.position,BABYLON.Tmp.Vector3[0]);BABYLON.Matrix.TranslationToRef(BABYLON.Tmp.Vector3[0].x,BABYLON.Tmp.Vector3[0].y,BABYLON.Tmp.Vector3[0].z,BABYLON.Tmp.Matrix[0]);BABYLON.Tmp.Matrix[0].invertToRef(BABYLON.Tmp.Matrix[2]);BABYLON.Matrix.RotationAxisToRef(axis,amount,BABYLON.Tmp.Matrix[1]);BABYLON.Tmp.Matrix[2].multiplyToRef(BABYLON.Tmp.Matrix[1],BABYLON.Tmp.Matrix[2]);BABYLON.Tmp.Matrix[2].multiplyToRef(BABYLON.Tmp.Matrix[0],BABYLON.Tmp.Matrix[2]);BABYLON.Tmp.Matrix[2].decompose(BABYLON.Tmp.Vector3[0],BABYLON.Tmp.Quaternion[0],BABYLON.Tmp.Vector3[1]);this.position.addInPlace(BABYLON.Tmp.Vector3[1]);BABYLON.Tmp.Quaternion[0].multiplyToRef(this.rotationQuaternion,this.rotationQuaternion);return this};AbstractMesh.prototype.translate=function(axis,distance,space){var displacementVector=axis.scale(distance);if(!space||space===BABYLON.Space.LOCAL){var tempV3=this.getPositionExpressedInLocalSpace().add(displacementVector);this.setPositionWithLocalVector(tempV3)}else{this.setAbsolutePosition(this.getAbsolutePosition().add(displacementVector))}return this};AbstractMesh.prototype.addRotation=function(x,y,z){var rotationQuaternion;if(this.rotationQuaternion){rotationQuaternion=this.rotationQuaternion}else{rotationQuaternion=BABYLON.Tmp.Quaternion[1];BABYLON.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,rotationQuaternion)}var accumulation=BABYLON.Tmp.Quaternion[0];BABYLON.Quaternion.RotationYawPitchRollToRef(y,x,z,accumulation);rotationQuaternion.multiplyInPlace(accumulation);if(!this.rotationQuaternion){rotationQuaternion.toEulerAnglesToRef(this.rotation)}return this};AbstractMesh.prototype.getAbsolutePosition=function(){this.computeWorldMatrix();return this._absolutePosition};AbstractMesh.prototype.setAbsolutePosition=function(absolutePosition){if(!absolutePosition){return this}var absolutePositionX;var absolutePositionY;var absolutePositionZ;if(absolutePosition.x===undefined){if(arguments.length<3){return this}absolutePositionX=arguments[0];absolutePositionY=arguments[1];absolutePositionZ=arguments[2]}else{absolutePositionX=absolutePosition.x;absolutePositionY=absolutePosition.y;absolutePositionZ=absolutePosition.z}if(this.parent){var invertParentWorldMatrix=this.parent.getWorldMatrix().clone();invertParentWorldMatrix.invert();var worldPosition=new BABYLON.Vector3(absolutePositionX,absolutePositionY,absolutePositionZ);this.position=BABYLON.Vector3.TransformCoordinates(worldPosition,invertParentWorldMatrix)}else{this.position.x=absolutePositionX;this.position.y=absolutePositionY;this.position.z=absolutePositionZ}return this};AbstractMesh.prototype.movePOV=function(amountRight,amountUp,amountForward){this.position.addInPlace(this.calcMovePOV(amountRight,amountUp,amountForward));return this};AbstractMesh.prototype.calcMovePOV=function(amountRight,amountUp,amountForward){var rotMatrix=new BABYLON.Matrix;var rotQuaternion=this.rotationQuaternion?this.rotationQuaternion:BABYLON.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);rotQuaternion.toRotationMatrix(rotMatrix);var translationDelta=BABYLON.Vector3.Zero();var defForwardMult=this.definedFacingForward?-1:1;BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(amountRight*defForwardMult,amountUp,amountForward*defForwardMult,rotMatrix,translationDelta);return translationDelta};AbstractMesh.prototype.rotatePOV=function(flipBack,twirlClockwise,tiltRight){this.rotation.addInPlace(this.calcRotatePOV(flipBack,twirlClockwise,tiltRight));return this};AbstractMesh.prototype.calcRotatePOV=function(flipBack,twirlClockwise,tiltRight){var defForwardMult=this.definedFacingForward?1:-1;return new BABYLON.Vector3(flipBack*defForwardMult,twirlClockwise,tiltRight*defForwardMult)};AbstractMesh.prototype.setPivotMatrix=function(matrix,postMultiplyPivotMatrix){if(postMultiplyPivotMatrix===void 0){postMultiplyPivotMatrix=false}this._pivotMatrix=matrix.clone();this._cache.pivotMatrixUpdated=true;this._postMultiplyPivotMatrix=postMultiplyPivotMatrix;if(this._postMultiplyPivotMatrix){this._pivotMatrixInverse=BABYLON.Matrix.Invert(matrix)}return this};AbstractMesh.prototype.getPivotMatrix=function(){return this._pivotMatrix};AbstractMesh.prototype._isSynchronized=function(){if(this._isDirty){return false}if(this.billboardMode!==this._cache.billboardMode||this.billboardMode!==AbstractMesh.BILLBOARDMODE_NONE)return false;if(this._cache.pivotMatrixUpdated){return false}if(this.infiniteDistance){return false}if(!this._cache.position.equals(this.position))return false;if(this.rotationQuaternion){if(!this._cache.rotationQuaternion.equals(this.rotationQuaternion))return false}if(!this._cache.rotation.equals(this.rotation))return false;if(!this._cache.scaling.equals(this.scaling))return false;return true};AbstractMesh.prototype._initCache=function(){_super.prototype._initCache.call(this);this._cache.localMatrixUpdated=false;this._cache.position=BABYLON.Vector3.Zero();this._cache.scaling=BABYLON.Vector3.Zero();this._cache.rotation=BABYLON.Vector3.Zero();this._cache.rotationQuaternion=new BABYLON.Quaternion(0,0,0,0);this._cache.billboardMode=-1};AbstractMesh.prototype.markAsDirty=function(property){if(property==="rotation"){this.rotationQuaternion=null}this._currentRenderId=Number.MAX_VALUE;this._isDirty=true;return this};AbstractMesh.prototype.getHierarchyBoundingVectors=function(){this.computeWorldMatrix(true);var min;var max;if(!this.subMeshes){min=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);max=new BABYLON.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}else{min=this.getBoundingInfo().boundingBox.minimumWorld;max=this.getBoundingInfo().boundingBox.maximumWorld}var descendants=this.getDescendants(false);for(var _i=0,descendants_1=descendants;_i<descendants_1.length;_i++){var descendant=descendants_1[_i];var childMesh=descendant;childMesh.computeWorldMatrix(true);if(childMesh.getTotalVertices()===0){continue}var boundingBox=childMesh.getBoundingInfo().boundingBox;var minBox=boundingBox.minimumWorld;var maxBox=boundingBox.maximumWorld;BABYLON.Tools.CheckExtends(minBox,min,max);BABYLON.Tools.CheckExtends(maxBox,min,max)}return{min:min,max:max}};AbstractMesh.prototype._updateBoundingInfo=function(){this._boundingInfo=this._boundingInfo||new BABYLON.BoundingInfo(this.absolutePosition,this.absolutePosition);this._boundingInfo.update(this.worldMatrixFromCache);this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache);return this};AbstractMesh.prototype._updateSubMeshesBoundingInfo=function(matrix){if(!this.subMeshes){return this}for(var subIndex=0;subIndex<this.subMeshes.length;subIndex++){var subMesh=this.subMeshes[subIndex];if(!subMesh.IsGlobal){subMesh.updateBoundingInfo(matrix)}}return this};AbstractMesh.prototype.computeWorldMatrix=function(force){if(this._isWorldMatrixFrozen){return this._worldMatrix}if(!force&&this.isSynchronized(true)){this._currentRenderId=this.getScene().getRenderId();return this._worldMatrix}this._cache.position.copyFrom(this.position);this._cache.scaling.copyFrom(this.scaling);this._cache.pivotMatrixUpdated=false;this._cache.billboardMode=this.billboardMode;this._currentRenderId=this.getScene().getRenderId();this._isDirty=false;BABYLON.Matrix.ScalingToRef(this.scaling.x*this.scalingDeterminant,this.scaling.y*this.scalingDeterminant,this.scaling.z*this.scalingDeterminant,BABYLON.Tmp.Matrix[1]);if(this.rotationQuaternion){var len=this.rotation.length();if(len){this.rotationQuaternion.multiplyInPlace(BABYLON.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z));this.rotation.copyFromFloats(0,0,0)}}if(this.rotationQuaternion){this.rotationQuaternion.toRotationMatrix(BABYLON.Tmp.Matrix[0]);this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}else{BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,BABYLON.Tmp.Matrix[0]);this._cache.rotation.copyFrom(this.rotation)}if(this.infiniteDistance&&!this.parent){var camera=this.getScene().activeCamera;if(camera){var cameraWorldMatrix=camera.getWorldMatrix();var cameraGlobalPosition=new BABYLON.Vector3(cameraWorldMatrix.m[12],cameraWorldMatrix.m[13],cameraWorldMatrix.m[14]);BABYLON.Matrix.TranslationToRef(this.position.x+cameraGlobalPosition.x,this.position.y+cameraGlobalPosition.y,this.position.z+cameraGlobalPosition.z,BABYLON.Tmp.Matrix[2])}}else{BABYLON.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,BABYLON.Tmp.Matrix[2])}this._pivotMatrix.multiplyToRef(BABYLON.Tmp.Matrix[1],BABYLON.Tmp.Matrix[4]);BABYLON.Tmp.Matrix[4].multiplyToRef(BABYLON.Tmp.Matrix[0],BABYLON.Tmp.Matrix[5]);if(this.billboardMode!==AbstractMesh.BILLBOARDMODE_NONE&&this.getScene().activeCamera){if((this.billboardMode&AbstractMesh.BILLBOARDMODE_ALL)!==AbstractMesh.BILLBOARDMODE_ALL){var currentPosition=BABYLON.Tmp.Vector3[3];if(this.parent&&this.parent.getWorldMatrix){if(this._meshToBoneReferal){this.parent.getWorldMatrix().multiplyToRef(this._meshToBoneReferal.getWorldMatrix(),BABYLON.Tmp.Matrix[6]);BABYLON.Vector3.TransformCoordinatesToRef(this.position,BABYLON.Tmp.Matrix[6],currentPosition)}else{BABYLON.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),currentPosition)}}else{currentPosition.copyFrom(this.position)}currentPosition.subtractInPlace(this.getScene().activeCamera.globalPosition);var finalEuler=BABYLON.Tmp.Vector3[4].copyFromFloats(0,0,0);if((this.billboardMode&AbstractMesh.BILLBOARDMODE_X)===AbstractMesh.BILLBOARDMODE_X){finalEuler.x=Math.atan2(-currentPosition.y,currentPosition.z)}if((this.billboardMode&AbstractMesh.BILLBOARDMODE_Y)===AbstractMesh.BILLBOARDMODE_Y){finalEuler.y=Math.atan2(currentPosition.x,currentPosition.z)}if((this.billboardMode&AbstractMesh.BILLBOARDMODE_Z)===AbstractMesh.BILLBOARDMODE_Z){finalEuler.z=Math.atan2(currentPosition.y,currentPosition.x)}BABYLON.Matrix.RotationYawPitchRollToRef(finalEuler.y,finalEuler.x,finalEuler.z,BABYLON.Tmp.Matrix[0])}else{BABYLON.Tmp.Matrix[1].copyFrom(this.getScene().activeCamera.getViewMatrix());BABYLON.Tmp.Matrix[1].setTranslationFromFloats(0,0,0);BABYLON.Tmp.Matrix[1].invertToRef(BABYLON.Tmp.Matrix[0])}BABYLON.Tmp.Matrix[1].copyFrom(BABYLON.Tmp.Matrix[5]);BABYLON.Tmp.Matrix[1].multiplyToRef(BABYLON.Tmp.Matrix[0],BABYLON.Tmp.Matrix[5])}BABYLON.Tmp.Matrix[5].multiplyToRef(BABYLON.Tmp.Matrix[2],this._localWorld);if(this.parent&&this.parent.getWorldMatrix){if(this.billboardMode!==AbstractMesh.BILLBOARDMODE_NONE){if(this._meshToBoneReferal){this.parent.getWorldMatrix().multiplyToRef(this._meshToBoneReferal.getWorldMatrix(),BABYLON.Tmp.Matrix[6]);BABYLON.Tmp.Matrix[5].copyFrom(BABYLON.Tmp.Matrix[6])}else{BABYLON.Tmp.Matrix[5].copyFrom(this.parent.getWorldMatrix())}this._localWorld.getTranslationToRef(BABYLON.Tmp.Vector3[5]);BABYLON.Vector3.TransformCoordinatesToRef(BABYLON.Tmp.Vector3[5],BABYLON.Tmp.Matrix[5],BABYLON.Tmp.Vector3[5]);this._worldMatrix.copyFrom(this._localWorld);this._worldMatrix.setTranslation(BABYLON.Tmp.Vector3[5])}else{if(this._meshToBoneReferal){this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),BABYLON.Tmp.Matrix[6]);BABYLON.Tmp.Matrix[6].multiplyToRef(this._meshToBoneReferal.getWorldMatrix(),this._worldMatrix)}else{this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix)}}this._markSyncedWithParent()}else{this._worldMatrix.copyFrom(this._localWorld)}if(this._postMultiplyPivotMatrix){this._worldMatrix.multiplyToRef(this._pivotMatrixInverse,this._worldMatrix)}this._updateBoundingInfo();this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]);this.onAfterWorldMatrixUpdateObservable.notifyObservers(this);if(!this._poseMatrix){this._poseMatrix=BABYLON.Matrix.Invert(this._worldMatrix)}return this._worldMatrix};AbstractMesh.prototype.registerAfterWorldMatrixUpdate=function(func){this.onAfterWorldMatrixUpdateObservable.add(func);return this};AbstractMesh.prototype.unregisterAfterWorldMatrixUpdate=function(func){this.onAfterWorldMatrixUpdateObservable.removeCallback(func);return this};AbstractMesh.prototype.setPositionWithLocalVector=function(vector3){this.computeWorldMatrix();this.position=BABYLON.Vector3.TransformNormal(vector3,this._localWorld);return this};AbstractMesh.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var invLocalWorldMatrix=this._localWorld.clone();invLocalWorldMatrix.invert();return BABYLON.Vector3.TransformNormal(this.position,invLocalWorldMatrix)};AbstractMesh.prototype.locallyTranslate=function(vector3){this.computeWorldMatrix(true);this.position=BABYLON.Vector3.TransformCoordinates(vector3,this._localWorld);return this};AbstractMesh.prototype.lookAt=function(targetPoint,yawCor,pitchCor,rollCor,space){if(yawCor===void 0){yawCor=0}if(pitchCor===void 0){pitchCor=0}if(rollCor===void 0){rollCor=0}if(space===void 0){space=BABYLON.Space.LOCAL}var dv=AbstractMesh._lookAtVectorCache;var pos=space===BABYLON.Space.LOCAL?this.position:this.getAbsolutePosition();targetPoint.subtractToRef(pos,dv);var yaw=-Math.atan2(dv.z,dv.x)-Math.PI/2;var len=Math.sqrt(dv.x*dv.x+dv.z*dv.z);var pitch=Math.atan2(dv.y,len);this.rotationQuaternion=this.rotationQuaternion||new BABYLON.Quaternion;BABYLON.Quaternion.RotationYawPitchRollToRef(yaw+yawCor,pitch+pitchCor,rollCor,this.rotationQuaternion);return this};AbstractMesh.prototype.attachToBone=function(bone,affectedMesh){this._meshToBoneReferal=affectedMesh;this.parent=bone;if(bone.getWorldMatrix().determinant()<0){this.scalingDeterminant*=-1}return this};AbstractMesh.prototype.detachFromBone=function(){if(this.parent.getWorldMatrix().determinant()<0){this.scalingDeterminant*=-1}this._meshToBoneReferal=null;this.parent=null;return this};AbstractMesh.prototype.isInFrustum=function(frustumPlanes){return this._boundingInfo.isInFrustum(frustumPlanes)};AbstractMesh.prototype.isCompletelyInFrustum=function(frustumPlanes){return this._boundingInfo.isCompletelyInFrustum(frustumPlanes)};AbstractMesh.prototype.intersectsMesh=function(mesh,precise,includeDescendants){if(!this._boundingInfo||!mesh._boundingInfo){return false}if(this._boundingInfo.intersects(mesh._boundingInfo,precise)){return true}if(includeDescendants){for(var _i=0,_a=this.getChildMeshes();_i<_a.length;_i++){var child=_a[_i];if(child.intersectsMesh(mesh,precise,true)){return true}}}return false};AbstractMesh.prototype.intersectsPoint=function(point){if(!this._boundingInfo){return false}return this._boundingInfo.intersectsPoint(point)};AbstractMesh.prototype.getPhysicsImpostor=function(){return this.physicsImpostor};AbstractMesh.prototype.getPositionInCameraSpace=function(camera){if(!camera){camera=this.getScene().activeCamera}return BABYLON.Vector3.TransformCoordinates(this.absolutePosition,camera.getViewMatrix())};AbstractMesh.prototype.getDistanceToCamera=function(camera){if(!camera){camera=this.getScene().activeCamera}return this.absolutePosition.subtract(camera.position).length()};AbstractMesh.prototype.applyImpulse=function(force,contactPoint){if(!this.physicsImpostor){return this}this.physicsImpostor.applyImpulse(force,contactPoint);return this};AbstractMesh.prototype.setPhysicsLinkWith=function(otherMesh,pivot1,pivot2,options){if(!this.physicsImpostor||!otherMesh.physicsImpostor){return this}this.physicsImpostor.createJoint(otherMesh.physicsImpostor,BABYLON.PhysicsJoint.HingeJoint,{mainPivot:pivot1,connectedPivot:pivot2,nativeParams:options});return this};Object.defineProperty(AbstractMesh.prototype,"checkCollisions",{get:function(){return this._checkCollisions},set:function(collisionEnabled){this._checkCollisions=collisionEnabled;if(this.getScene().workerCollisions){this.getScene().collisionCoordinator.onMeshUpdated(this)}},enumerable:true,configurable:true});AbstractMesh.prototype.moveWithCollisions=function(displacement){var globalPosition=this.getAbsolutePosition();globalPosition.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPositionForCollisions);this._oldPositionForCollisions.addInPlace(this.ellipsoidOffset);if(!this._collider){this._collider=new BABYLON.Collider}this._collider.radius=this.ellipsoid;this.getScene().collisionCoordinator.getNewPosition(this._oldPositionForCollisions,displacement,this._collider,3,this,this._onCollisionPositionChange,this.uniqueId);return this};AbstractMesh.prototype.createOrUpdateSubmeshesOctree=function(maxCapacity,maxDepth){if(maxCapacity===void 0){maxCapacity=64}if(maxDepth===void 0){maxDepth=2}if(!this._submeshesOctree){this._submeshesOctree=new BABYLON.Octree(BABYLON.Octree.CreationFuncForSubMeshes,maxCapacity,maxDepth)}this.computeWorldMatrix(true);var bbox=this.getBoundingInfo().boundingBox;this._submeshesOctree.update(bbox.minimumWorld,bbox.maximumWorld,this.subMeshes);return this._submeshesOctree};AbstractMesh.prototype._collideForSubMesh=function(subMesh,transformMatrix,collider){this._generatePointsArray();if(!subMesh._lastColliderWorldVertices||!subMesh._lastColliderTransformMatrix.equals(transformMatrix)){subMesh._lastColliderTransformMatrix=transformMatrix.clone();subMesh._lastColliderWorldVertices=[];subMesh._trianglePlanes=[];var start=subMesh.verticesStart;var end=subMesh.verticesStart+subMesh.verticesCount;for(var i=start;i<end;i++){subMesh._lastColliderWorldVertices.push(BABYLON.Vector3.TransformCoordinates(this._positions[i],transformMatrix))}}collider._collide(subMesh._trianglePlanes,subMesh._lastColliderWorldVertices,this.getIndices(),subMesh.indexStart,subMesh.indexStart+subMesh.indexCount,subMesh.verticesStart,!!subMesh.getMaterial());if(collider.collisionFound){collider.collidedMesh=this}return this};AbstractMesh.prototype._processCollisionsForSubMeshes=function(collider,transformMatrix){var subMeshes;var len;if(this._submeshesOctree&&this.useOctreeForCollisions){var radius=collider.velocityWorldLength+Math.max(collider.radius.x,collider.radius.y,collider.radius.z);var intersections=this._submeshesOctree.intersects(collider.basePointWorld,radius);len=intersections.length;subMeshes=intersections.data}else{subMeshes=this.subMeshes;len=subMeshes.length}for(var index=0;index<len;index++){var subMesh=subMeshes[index];if(len>1&&!subMesh._checkCollision(collider))continue;this._collideForSubMesh(subMesh,transformMatrix,collider)}return this};AbstractMesh.prototype._checkCollision=function(collider){if(!this._boundingInfo._checkCollision(collider))return this;BABYLON.Matrix.ScalingToRef(1/collider.radius.x,1/collider.radius.y,1/collider.radius.z,this._collisionsScalingMatrix);this.worldMatrixFromCache.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix);this._processCollisionsForSubMeshes(collider,this._collisionsTransformMatrix);return this};AbstractMesh.prototype._generatePointsArray=function(){return false};AbstractMesh.prototype.intersects=function(ray,fastCheck){var pickingInfo=new BABYLON.PickingInfo;if(!this.subMeshes||!this._boundingInfo||!ray.intersectsSphere(this._boundingInfo.boundingSphere)||!ray.intersectsBox(this._boundingInfo.boundingBox)){return pickingInfo}if(!this._generatePointsArray()){return pickingInfo}var intersectInfo=null;var subMeshes;var len;if(this._submeshesOctree&&this.useOctreeForPicking){var worldRay=BABYLON.Ray.Transform(ray,this.getWorldMatrix());var intersections=this._submeshesOctree.intersectsRay(worldRay);len=intersections.length;subMeshes=intersections.data}else{subMeshes=this.subMeshes;len=subMeshes.length}for(var index=0;index<len;index++){var subMesh=subMeshes[index];if(len>1&&!subMesh.canIntersects(ray))continue;var currentIntersectInfo=subMesh.intersects(ray,this._positions,this.getIndices(),fastCheck);if(currentIntersectInfo){if(fastCheck||!intersectInfo||currentIntersectInfo.distance<intersectInfo.distance){intersectInfo=currentIntersectInfo;intersectInfo.subMeshId=index;if(fastCheck){break}}}}if(intersectInfo){var world=this.getWorldMatrix();var worldOrigin=BABYLON.Vector3.TransformCoordinates(ray.origin,world);var direction=ray.direction.clone();direction=direction.scale(intersectInfo.distance);var worldDirection=BABYLON.Vector3.TransformNormal(direction,world);var pickedPoint=worldOrigin.add(worldDirection);pickingInfo.hit=true;pickingInfo.distance=BABYLON.Vector3.Distance(worldOrigin,pickedPoint);pickingInfo.pickedPoint=pickedPoint;pickingInfo.pickedMesh=this;pickingInfo.bu=intersectInfo.bu;pickingInfo.bv=intersectInfo.bv;pickingInfo.faceId=intersectInfo.faceId;pickingInfo.subMeshId=intersectInfo.subMeshId;return pickingInfo}return pickingInfo};AbstractMesh.prototype.clone=function(name,newParent,doNotCloneChildren){return null};AbstractMesh.prototype.releaseSubMeshes=function(){if(this.subMeshes){while(this.subMeshes.length){this.subMeshes[0].dispose()}}else{this.subMeshes=new Array}return this};AbstractMesh.prototype.dispose=function(doNotRecurse){var _this=this;var index;if(this.actionManager){this.actionManager.dispose();this.actionManager=null}this.skeleton=null;this.getScene().stopAnimation(this);if(this.physicsImpostor){this.physicsImpostor.dispose()}for(index=0;index<this._intersectionsInProgress.length;index++){var other=this._intersectionsInProgress[index];var pos=other._intersectionsInProgress.indexOf(this);other._intersectionsInProgress.splice(pos,1)}this._intersectionsInProgress=[];var lights=this.getScene().lights;lights.forEach(function(light){var meshIndex=light.includedOnlyMeshes.indexOf(_this);if(meshIndex!==-1){light.includedOnlyMeshes.splice(meshIndex,1)}meshIndex=light.excludedMeshes.indexOf(_this);if(meshIndex!==-1){light.excludedMeshes.splice(meshIndex,1)}var generator=light.getShadowGenerator();if(generator){var shadowMap=generator.getShadowMap();meshIndex=shadowMap.renderList.indexOf(_this);if(meshIndex!==-1){shadowMap.renderList.splice(meshIndex,1)}}});if(this._edgesRenderer){this._edgesRenderer.dispose();this._edgesRenderer=null}if(this.getClassName()!=="InstancedMesh"){this.releaseSubMeshes()}var sceneOctree=this.getScene().selectionOctree;if(sceneOctree){var index=sceneOctree.dynamicContent.indexOf(this);if(index!==-1){sceneOctree.dynamicContent.splice(index,1)}}var engine=this.getScene().getEngine();if(this._occlusionQuery){this._isOcclusionQueryInProgress=false;engine.deleteQuery(this._occlusionQuery);this._occlusionQuery=null}engine.wipeCaches();this.getScene().removeMesh(this);if(!doNotRecurse){for(index=0;index<this.getScene().particleSystems.length;index++){if(this.getScene().particleSystems[index].emitter===this){this.getScene().particleSystems[index].dispose();index--}}var objects=this.getDescendants(true);for(index=0;index<objects.length;index++){objects[index].dispose()}}else{var childMeshes=this.getChildMeshes(true);for(index=0;index<childMeshes.length;index++){var child=childMeshes[index];child.parent=null;child.computeWorldMatrix(true)}}if(this._facetDataEnabled){this.disableFacetData()}this.onAfterWorldMatrixUpdateObservable.clear();this.onCollideObservable.clear();this.onCollisionPositionChangeObservable.clear();this._isDisposed=true;_super.prototype.dispose.call(this)};AbstractMesh.prototype.getDirection=function(localAxis){var result=BABYLON.Vector3.Zero();this.getDirectionToRef(localAxis,result);return result};AbstractMesh.prototype.getDirectionToRef=function(localAxis,result){BABYLON.Vector3.TransformNormalToRef(localAxis,this.getWorldMatrix(),result);return this};AbstractMesh.prototype.setPivotPoint=function(point,space){if(space===void 0){space=BABYLON.Space.LOCAL}if(this.getScene().getRenderId()==0){this.computeWorldMatrix(true)}var wm=this.getWorldMatrix();if(space==BABYLON.Space.WORLD){var tmat=BABYLON.Tmp.Matrix[0];wm.invertToRef(tmat);point=BABYLON.Vector3.TransformCoordinates(point,tmat)}BABYLON.Vector3.TransformCoordinatesToRef(point,wm,this.position);this._pivotMatrix.m[12]=-point.x;this._pivotMatrix.m[13]=-point.y;this._pivotMatrix.m[14]=-point.z;this._cache.pivotMatrixUpdated=true;return this};AbstractMesh.prototype.getPivotPoint=function(){var point=BABYLON.Vector3.Zero();this.getPivotPointToRef(point);return point};AbstractMesh.prototype.getPivotPointToRef=function(result){result.x=-this._pivotMatrix.m[12];result.y=-this._pivotMatrix.m[13];result.z=-this._pivotMatrix.m[14];return this};AbstractMesh.prototype.getAbsolutePivotPoint=function(){var point=BABYLON.Vector3.Zero();this.getAbsolutePivotPointToRef(point);return point};AbstractMesh.prototype.setParent=function(mesh){var child=this;var parent=mesh;if(mesh==null){var rotation=BABYLON.Tmp.Quaternion[0];var position=BABYLON.Tmp.Vector3[0];var scale=BABYLON.Tmp.Vector3[1];child.getWorldMatrix().decompose(scale,rotation,position);if(child.rotationQuaternion){child.rotationQuaternion.copyFrom(rotation)}else{rotation.toEulerAnglesToRef(child.rotation)}child.position.x=position.x;child.position.y=position.y;child.position.z=position.z}else{var position=BABYLON.Tmp.Vector3[0];var m1=BABYLON.Tmp.Matrix[0];parent.getWorldMatrix().invertToRef(m1);BABYLON.Vector3.TransformCoordinatesToRef(child.position,m1,position);child.position.copyFrom(position)}child.parent=parent;return this};AbstractMesh.prototype.addChild=function(mesh){mesh.setParent(this);return this};AbstractMesh.prototype.removeChild=function(mesh){mesh.setParent(null);return this};AbstractMesh.prototype.getAbsolutePivotPointToRef=function(result){result.x=this._pivotMatrix.m[12];result.y=this._pivotMatrix.m[13];result.z=this._pivotMatrix.m[14];this.getPivotPointToRef(result);BABYLON.Vector3.TransformCoordinatesToRef(result,this.getWorldMatrix(),result);return this};AbstractMesh.prototype._initFacetData=function(){if(!this._facetNormals){this._facetNormals=new Array}if(!this._facetPositions){this._facetPositions=new Array}if(!this._facetPartitioning){this._facetPartitioning=new Array}this._facetNb=this.getIndices().length/3;this._partitioningSubdivisions=this._partitioningSubdivisions?this._partitioningSubdivisions:10;this._partitioningBBoxRatio=this._partitioningBBoxRatio?this._partitioningBBoxRatio:1.01;for(var f=0;f<this._facetNb;f++){this._facetNormals[f]=BABYLON.Vector3.Zero();this._facetPositions[f]=BABYLON.Vector3.Zero()}this._facetDataEnabled=true;return this};AbstractMesh.prototype.updateFacetData=function(){if(!this._facetDataEnabled){this._initFacetData()}var positions=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);var indices=this.getIndices();var normals=this.getVerticesData(BABYLON.VertexBuffer.NormalKind);var bInfo=this.getBoundingInfo();this._bbSize.x=bInfo.maximum.x-bInfo.minimum.x>BABYLON.Epsilon?bInfo.maximum.x-bInfo.minimum.x:BABYLON.Epsilon;this._bbSize.y=bInfo.maximum.y-bInfo.minimum.y>BABYLON.Epsilon?bInfo.maximum.y-bInfo.minimum.y:BABYLON.Epsilon;this._bbSize.z=bInfo.maximum.z-bInfo.minimum.z>BABYLON.Epsilon?bInfo.maximum.z-bInfo.minimum.z:BABYLON.Epsilon;var bbSizeMax=this._bbSize.x>this._bbSize.y?this._bbSize.x:this._bbSize.y;bbSizeMax=bbSizeMax>this._bbSize.z?bbSizeMax:this._bbSize.z;this._subDiv.max=this._partitioningSubdivisions;this._subDiv.X=Math.floor(this._subDiv.max*this._bbSize.x/bbSizeMax);this._subDiv.Y=Math.floor(this._subDiv.max*this._bbSize.y/bbSizeMax);this._subDiv.Z=Math.floor(this._subDiv.max*this._bbSize.z/bbSizeMax);this._subDiv.X=this._subDiv.X<1?1:this._subDiv.X;this._subDiv.Y=this._subDiv.Y<1?1:this._subDiv.Y;this._subDiv.Z=this._subDiv.Z<1?1:this._subDiv.Z;this._facetParameters.facetNormals=this.getFacetLocalNormals();this._facetParameters.facetPositions=this.getFacetLocalPositions();this._facetParameters.facetPartitioning=this.getFacetLocalPartitioning();this._facetParameters.bInfo=bInfo;this._facetParameters.bbSize=this._bbSize;this._facetParameters.subDiv=this._subDiv;this._facetParameters.ratio=this.partitioningBBoxRatio;BABYLON.VertexData.ComputeNormals(positions,indices,normals,this._facetParameters);return this};AbstractMesh.prototype.getFacetLocalNormals=function(){if(!this._facetNormals){this.updateFacetData()}return this._facetNormals};AbstractMesh.prototype.getFacetLocalPositions=function(){if(!this._facetPositions){this.updateFacetData()}return this._facetPositions};AbstractMesh.prototype.getFacetLocalPartitioning=function(){if(!this._facetPartitioning){this.updateFacetData()}return this._facetPartitioning};AbstractMesh.prototype.getFacetPosition=function(i){var pos=BABYLON.Vector3.Zero();this.getFacetPositionToRef(i,pos);return pos};AbstractMesh.prototype.getFacetPositionToRef=function(i,ref){var localPos=this.getFacetLocalPositions()[i];var world=this.getWorldMatrix();BABYLON.Vector3.TransformCoordinatesToRef(localPos,world,ref);return this};AbstractMesh.prototype.getFacetNormal=function(i){var norm=BABYLON.Vector3.Zero();this.getFacetNormalToRef(i,norm);return norm};AbstractMesh.prototype.getFacetNormalToRef=function(i,ref){var localNorm=this.getFacetLocalNormals()[i];BABYLON.Vector3.TransformNormalToRef(localNorm,this.getWorldMatrix(),ref);return this};AbstractMesh.prototype.getFacetsAtLocalCoordinates=function(x,y,z){var bInfo=this.getBoundingInfo();var ox=Math.floor((x-bInfo.minimum.x*this._partitioningBBoxRatio)*this._subDiv.X*this._partitioningBBoxRatio/this._bbSize.x);var oy=Math.floor((y-bInfo.minimum.y*this._partitioningBBoxRatio)*this._subDiv.Y*this._partitioningBBoxRatio/this._bbSize.y);var oz=Math.floor((z-bInfo.minimum.z*this._partitioningBBoxRatio)*this._subDiv.Z*this._partitioningBBoxRatio/this._bbSize.z);if(ox<0||ox>this._subDiv.max||oy<0||oy>this._subDiv.max||oz<0||oz>this._subDiv.max){return null}return this._facetPartitioning[ox+this._subDiv.max*oy+this._subDiv.max*this._subDiv.max*oz]};AbstractMesh.prototype.getClosestFacetAtCoordinates=function(x,y,z,projected,checkFace,facing){if(checkFace===void 0){checkFace=false}if(facing===void 0){facing=true}var world=this.getWorldMatrix();var invMat=BABYLON.Tmp.Matrix[5];world.invertToRef(invMat);var invVect=BABYLON.Tmp.Vector3[8];var closest=null;BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(x,y,z,invMat,invVect);closest=this.getClosestFacetAtLocalCoordinates(invVect.x,invVect.y,invVect.z,projected,checkFace,facing);if(projected){BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(projected.x,projected.y,projected.z,world,projected)}return closest};AbstractMesh.prototype.getClosestFacetAtLocalCoordinates=function(x,y,z,projected,checkFace,facing){if(checkFace===void 0){checkFace=false}if(facing===void 0){facing=true}var closest=null;var tmpx=0;var tmpy=0;var tmpz=0;var d=0;var t0=0;var projx=0;var projy=0;var projz=0;var facetPositions=this.getFacetLocalPositions();var facetNormals=this.getFacetLocalNormals();var facetsInBlock=this.getFacetsAtLocalCoordinates(x,y,z);if(!facetsInBlock){return null}var shortest=Number.MAX_VALUE;var tmpDistance=shortest;var fib;var norm;var p0;for(var idx=0;idx<facetsInBlock.length;idx++){fib=facetsInBlock[idx];norm=facetNormals[fib];p0=facetPositions[fib];d=(x-p0.x)*norm.x+(y-p0.y)*norm.y+(z-p0.z)*norm.z;if(!checkFace||checkFace&&facing&&d>=0||checkFace&&!facing&&d<=0){d=norm.x*p0.x+norm.y*p0.y+norm.z*p0.z;t0=-(norm.x*x+norm.y*y+norm.z*z-d)/(norm.x*norm.x+norm.y*norm.y+norm.z*norm.z);projx=x+norm.x*t0;projy=y+norm.y*t0;projz=z+norm.z*t0;tmpx=projx-x;tmpy=projy-y;tmpz=projz-z;tmpDistance=tmpx*tmpx+tmpy*tmpy+tmpz*tmpz;if(tmpDistance<shortest){shortest=tmpDistance;closest=fib;if(projected){projected.x=projx;projected.y=projy;projected.z=projz}}}}return closest};AbstractMesh.prototype.getFacetDataParameters=function(){return this._facetParameters};AbstractMesh.prototype.disableFacetData=function(){if(this._facetDataEnabled){this._facetDataEnabled=false;this._facetPositions=null;this._facetNormals=null;this._facetPartitioning=null;this._facetParameters=null}return this};AbstractMesh.prototype.createNormals=function(updatable){var positions=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);var indices=this.getIndices();var normals;if(this.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){normals=this.getVerticesData(BABYLON.VertexBuffer.NormalKind)}else{normals=[]}BABYLON.VertexData.ComputeNormals(positions,indices,normals,{useRightHandedSystem:this.getScene().useRightHandedSystem});this.setVerticesData(BABYLON.VertexBuffer.NormalKind,normals,updatable)};AbstractMesh.prototype.checkOcclusionQuery=function(){var engine=this.getEngine();if(engine.webGLVersion<2||this.occlusionType===AbstractMesh.OCCLUSION_TYPE_NONE){this._isOccluded=false;return}if(this.isOcclusionQueryInProgress){var isOcclusionQueryAvailable=engine.isQueryResultAvailable(this._occlusionQuery);if(isOcclusionQueryAvailable){var occlusionQueryResult=engine.getQueryResult(this._occlusionQuery);this._isOcclusionQueryInProgress=false;this._occlusionInternalRetryCounter=0;this._isOccluded=occlusionQueryResult===1?false:true}else{this._occlusionInternalRetryCounter++;if(this.occlusionRetryCount!==-1&&this._occlusionInternalRetryCounter>this.occlusionRetryCount){this._isOcclusionQueryInProgress=false;this._occlusionInternalRetryCounter=0;this._isOccluded=this.occlusionType===AbstractMesh.OCCLUSION_TYPE_OPTIMISTIC?false:this._isOccluded}else{return}}}var scene=this.getScene();var occlusionBoundingBoxRenderer=scene.getBoundingBoxRenderer();if(!this._occlusionQuery){this._occlusionQuery=engine.createQuery()}engine.beginQuery(this.occlusionQueryAlgorithmType,this._occlusionQuery);occlusionBoundingBoxRenderer.renderOcclusionBoundingBox(this);engine.endQuery(this.occlusionQueryAlgorithmType);this._isOcclusionQueryInProgress=true};AbstractMesh._BILLBOARDMODE_NONE=0;AbstractMesh._BILLBOARDMODE_X=1;AbstractMesh._BILLBOARDMODE_Y=2;AbstractMesh._BILLBOARDMODE_Z=4;AbstractMesh._BILLBOARDMODE_ALL=7;AbstractMesh.OCCLUSION_TYPE_NONE=0;AbstractMesh.OCCLUSION_TYPE_OPTIMISTIC=1;AbstractMesh.OCCLUSION_TYPE_STRICT=2;AbstractMesh.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;AbstractMesh.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;AbstractMesh._rotationAxisCache=new BABYLON.Quaternion;AbstractMesh._lookAtVectorCache=new BABYLON.Vector3(0,0,0);return AbstractMesh}(BABYLON.Node);BABYLON.AbstractMesh=AbstractMesh})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Light=function(_super){__extends(Light,_super);function Light(name,scene){var _this=_super.call(this,name,scene)||this;_this.diffuse=new BABYLON.Color3(1,1,1);_this.specular=new BABYLON.Color3(1,1,1);_this.intensity=1;_this.range=Number.MAX_VALUE;_this._photometricScale=1;_this._intensityMode=Light.INTENSITYMODE_AUTOMATIC;_this._radius=1e-5;_this.renderPriority=0;_this.shadowEnabled=true;_this._excludeWithLayerMask=0;_this._includeOnlyWithLayerMask=0;_this._lightmapMode=0;_this._excludedMeshesIds=new Array;_this._includedOnlyMeshesIds=new Array;_this.getScene().addLight(_this);_this._uniformBuffer=new BABYLON.UniformBuffer(_this.getScene().getEngine());_this._buildUniformLayout();_this.includedOnlyMeshes=new Array;_this.excludedMeshes=new Array;_this._resyncMeshes();return _this}Object.defineProperty(Light,"LIGHTMAP_DEFAULT",{get:function(){return Light._LIGHTMAP_DEFAULT},enumerable:true,configurable:true});Object.defineProperty(Light,"LIGHTMAP_SPECULAR",{get:function(){return Light._LIGHTMAP_SPECULAR},enumerable:true,configurable:true});Object.defineProperty(Light,"LIGHTMAP_SHADOWSONLY",{get:function(){return Light._LIGHTMAP_SHADOWSONLY},enumerable:true,configurable:true});Object.defineProperty(Light,"INTENSITYMODE_AUTOMATIC",{get:function(){return Light._INTENSITYMODE_AUTOMATIC},enumerable:true,configurable:true});Object.defineProperty(Light,"INTENSITYMODE_LUMINOUSPOWER",{get:function(){return Light._INTENSITYMODE_LUMINOUSPOWER},enumerable:true,configurable:true});Object.defineProperty(Light,"INTENSITYMODE_LUMINOUSINTENSITY",{get:function(){return Light._INTENSITYMODE_LUMINOUSINTENSITY},enumerable:true,configurable:true});Object.defineProperty(Light,"INTENSITYMODE_ILLUMINANCE",{get:function(){return Light._INTENSITYMODE_ILLUMINANCE},enumerable:true,configurable:true});Object.defineProperty(Light,"INTENSITYMODE_LUMINANCE",{get:function(){return Light._INTENSITYMODE_LUMINANCE},enumerable:true,configurable:true});Object.defineProperty(Light,"LIGHTTYPEID_POINTLIGHT",{get:function(){return Light._LIGHTTYPEID_POINTLIGHT},enumerable:true,configurable:true});Object.defineProperty(Light,"LIGHTTYPEID_DIRECTIONALLIGHT",{get:function(){return Light._LIGHTTYPEID_DIRECTIONALLIGHT},enumerable:true,configurable:true});Object.defineProperty(Light,"LIGHTTYPEID_SPOTLIGHT",{get:function(){return Light._LIGHTTYPEID_SPOTLIGHT},enumerable:true,configurable:true});Object.defineProperty(Light,"LIGHTTYPEID_HEMISPHERICLIGHT",{get:function(){return Light._LIGHTTYPEID_HEMISPHERICLIGHT},enumerable:true,configurable:true});Object.defineProperty(Light.prototype,"intensityMode",{get:function(){return this._intensityMode},set:function(value){this._intensityMode=value;this._computePhotometricScale()},enumerable:true,configurable:true});Object.defineProperty(Light.prototype,"radius",{get:function(){return this._radius},set:function(value){this._radius=value;this._computePhotometricScale()},enumerable:true,configurable:true});Object.defineProperty(Light.prototype,"includedOnlyMeshes",{get:function(){return this._includedOnlyMeshes},set:function(value){this._includedOnlyMeshes=value;this._hookArrayForIncludedOnly(value)},enumerable:true,configurable:true});Object.defineProperty(Light.prototype,"excludedMeshes",{get:function(){return this._excludedMeshes},set:function(value){this._excludedMeshes=value;this._hookArrayForExcluded(value)},enumerable:true,configurable:true});Object.defineProperty(Light.prototype,"excludeWithLayerMask",{get:function(){return this._excludeWithLayerMask},set:function(value){this._excludeWithLayerMask=value;this._resyncMeshes()},enumerable:true,configurable:true});Object.defineProperty(Light.prototype,"includeOnlyWithLayerMask",{get:function(){return this._includeOnlyWithLayerMask},set:function(value){this._includeOnlyWithLayerMask=value;this._resyncMeshes()},enumerable:true,configurable:true});Object.defineProperty(Light.prototype,"lightmapMode",{get:function(){return this._lightmapMode},set:function(value){if(this._lightmapMode===value){return}this._lightmapMode=value;this._markMeshesAsLightDirty()},enumerable:true,configurable:true});Light.prototype._buildUniformLayout=function(){};Light.prototype.getClassName=function(){return"Light"};Light.prototype.toString=function(fullDetails){var ret="Name: "+this.name;ret+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()];if(this.animations){for(var i=0;i<this.animations.length;i++){ret+=", animation[0]: "+this.animations[i].toString(fullDetails)}}if(fullDetails){}return ret};Light.prototype.setEnabled=function(value){_super.prototype.setEnabled.call(this,value);this._resyncMeshes()};Light.prototype.getShadowGenerator=function(){return this._shadowGenerator};Light.prototype.getAbsolutePosition=function(){return BABYLON.Vector3.Zero()};Light.prototype.transferToEffect=function(effect,lightIndex){};Light.prototype._getWorldMatrix=function(){return BABYLON.Matrix.Identity()};Light.prototype.canAffectMesh=function(mesh){if(!mesh){return true}if(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(mesh)===-1){return false}if(this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(mesh)!==-1){return false}if(this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&mesh.layerMask)===0){return false}if(this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&mesh.layerMask){return false}return true};Light.prototype.getWorldMatrix=function(){this._currentRenderId=this.getScene().getRenderId();var worldMatrix=this._getWorldMatrix();if(this.parent&&this.parent.getWorldMatrix){if(!this._parentedWorldMatrix){this._parentedWorldMatrix=BABYLON.Matrix.Identity()}worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix);this._markSyncedWithParent();return this._parentedWorldMatrix}return worldMatrix};Light.compareLightsPriority=function(a,b){if(a.shadowEnabled!==b.shadowEnabled){return(b.shadowEnabled?1:0)-(a.shadowEnabled?1:0)}return b.renderPriority-a.renderPriority};Light.prototype.dispose=function(){if(this._shadowGenerator){this._shadowGenerator.dispose();this._shadowGenerator=null}this.getScene().stopAnimation(this);for(var _i=0,_a=this.getScene().meshes;_i<_a.length;_i++){var mesh=_a[_i];mesh._removeLightSource(this)}this._uniformBuffer.dispose();this.getScene().removeLight(this);_super.prototype.dispose.call(this)};Light.prototype.getTypeID=function(){return 0};Light.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity};Light.prototype.clone=function(name){return BABYLON.SerializationHelper.Clone(Light.GetConstructorFromName(this.getTypeID(),name,this.getScene()),this)};Light.prototype.serialize=function(){var serializationObject=BABYLON.SerializationHelper.Serialize(this);serializationObject.type=this.getTypeID();if(this.parent){serializationObject.parentId=this.parent.id}if(this.excludedMeshes.length>0){serializationObject.excludedMeshesIds=[];this.excludedMeshes.forEach(function(mesh){serializationObject.excludedMeshesIds.push(mesh.id)})}if(this.includedOnlyMeshes.length>0){serializationObject.includedOnlyMeshesIds=[];this.includedOnlyMeshes.forEach(function(mesh){serializationObject.includedOnlyMeshesIds.push(mesh.id)})}BABYLON.Animation.AppendSerializedAnimations(this,serializationObject);serializationObject.ranges=this.serializeAnimationRanges();return serializationObject};Light.GetConstructorFromName=function(type,name,scene){switch(type){case 0:return function(){return new BABYLON.PointLight(name,BABYLON.Vector3.Zero(),scene)};case 1:return function(){return new BABYLON.DirectionalLight(name,BABYLON.Vector3.Zero(),scene)};case 2:return function(){return new BABYLON.SpotLight(name,BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),0,0,scene)};case 3:return function(){return new BABYLON.HemisphericLight(name,BABYLON.Vector3.Zero(),scene)}}return null};Light.Parse=function(parsedLight,scene){var light=BABYLON.SerializationHelper.Parse(Light.GetConstructorFromName(parsedLight.type,parsedLight.name,scene),parsedLight,scene);if(parsedLight.excludedMeshesIds){light._excludedMeshesIds=parsedLight.excludedMeshesIds}if(parsedLight.includedOnlyMeshesIds){light._includedOnlyMeshesIds=parsedLight.includedOnlyMeshesIds}if(parsedLight.parentId){light._waitingParentId=parsedLight.parentId}if(parsedLight.animations){for(var animationIndex=0;animationIndex<parsedLight.animations.length;animationIndex++){var parsedAnimation=parsedLight.animations[animationIndex];light.animations.push(BABYLON.Animation.Parse(parsedAnimation))}BABYLON.Node.ParseAnimationRanges(light,parsedLight,scene)}if(parsedLight.autoAnimate){scene.beginAnimation(light,parsedLight.autoAnimateFrom,parsedLight.autoAnimateTo,parsedLight.autoAnimateLoop,parsedLight.autoAnimateSpeed||1)}return light};Light.prototype._hookArrayForExcluded=function(array){var _this=this;var oldPush=array.push;array.push=function(){var items=[];for(var _i=0;_i<arguments.length;_i++){items[_i]=arguments[_i]}var result=oldPush.apply(array,items);for(var _a=0,items_1=items;_a<items_1.length;_a++){var item=items_1[_a];item._resyncLighSource(_this)}return result};var oldSplice=array.splice;array.splice=function(index,deleteCount){var deleted=oldSplice.apply(array,[index,deleteCount]);for(var _i=0,deleted_1=deleted;_i<deleted_1.length;_i++){var item=deleted_1[_i];item._resyncLighSource(_this)}return deleted};for(var _i=0,array_1=array;_i<array_1.length;_i++){var item=array_1[_i];item._resyncLighSource(this)}};Light.prototype._hookArrayForIncludedOnly=function(array){var _this=this;var oldPush=array.push;array.push=function(){var items=[];for(var _i=0;_i<arguments.length;_i++){items[_i]=arguments[_i]}var result=oldPush.apply(array,items);_this._resyncMeshes();return result};var oldSplice=array.splice;array.splice=function(index,deleteCount){var deleted=oldSplice.apply(array,[index,deleteCount]);_this._resyncMeshes();return deleted};this._resyncMeshes()};Light.prototype._resyncMeshes=function(){for(var _i=0,_a=this.getScene().meshes;_i<_a.length;_i++){var mesh=_a[_i];mesh._resyncLighSource(this)}};Light.prototype._markMeshesAsLightDirty=function(){for(var _i=0,_a=this.getScene().meshes;_i<_a.length;_i++){var mesh=_a[_i];if(mesh._lightSources.indexOf(this)!==-1){mesh._markSubMeshesAsLightDirty()}}};Light.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale();this.getScene().resetCachedMaterial()};Light.prototype._getPhotometricScale=function(){var photometricScale=0;var lightTypeID=this.getTypeID();var photometricMode=this.intensityMode;if(photometricMode===Light.INTENSITYMODE_AUTOMATIC){if(lightTypeID===Light.LIGHTTYPEID_DIRECTIONALLIGHT){photometricMode=Light.INTENSITYMODE_ILLUMINANCE}else{photometricMode=Light.INTENSITYMODE_LUMINOUSINTENSITY}}switch(lightTypeID){case Light.LIGHTTYPEID_POINTLIGHT:case Light.LIGHTTYPEID_SPOTLIGHT:switch(photometricMode){case Light.INTENSITYMODE_LUMINOUSPOWER:photometricScale=1/(4*Math.PI);break;case Light.INTENSITYMODE_LUMINOUSINTENSITY:photometricScale=1;break;case Light.INTENSITYMODE_LUMINANCE:photometricScale=this.radius*this.radius;break}break;case Light.LIGHTTYPEID_DIRECTIONALLIGHT:switch(photometricMode){case Light.INTENSITYMODE_ILLUMINANCE:photometricScale=1;break;case Light.INTENSITYMODE_LUMINANCE:var apexAngleRadians=this.radius;apexAngleRadians=Math.max(apexAngleRadians,.001);var solidAngle=2*Math.PI*(1-Math.cos(apexAngleRadians));photometricScale=solidAngle;break}break;case Light.LIGHTTYPEID_HEMISPHERICLIGHT:photometricScale=1;break}return photometricScale};Light.prototype._reorderLightsInScene=function(){var scene=this.getScene();if(this._renderPriority!=0){scene.requireLightSorting=true}this.getScene().sortLightsByPriority()};Light._LIGHTMAP_DEFAULT=0;Light._LIGHTMAP_SPECULAR=1;Light._LIGHTMAP_SHADOWSONLY=2;Light._INTENSITYMODE_AUTOMATIC=0;Light._INTENSITYMODE_LUMINOUSPOWER=1;Light._INTENSITYMODE_LUMINOUSINTENSITY=2;Light._INTENSITYMODE_ILLUMINANCE=3;Light._INTENSITYMODE_LUMINANCE=4;Light._LIGHTTYPEID_POINTLIGHT=0;Light._LIGHTTYPEID_DIRECTIONALLIGHT=1;Light._LIGHTTYPEID_SPOTLIGHT=2;Light._LIGHTTYPEID_HEMISPHERICLIGHT=3;__decorate([BABYLON.serializeAsColor3()],Light.prototype,"diffuse",void 0);__decorate([BABYLON.serializeAsColor3()],Light.prototype,"specular",void 0);__decorate([BABYLON.serialize()],Light.prototype,"intensity",void 0);__decorate([BABYLON.serialize()],Light.prototype,"range",void 0);__decorate([BABYLON.serialize()],Light.prototype,"intensityMode",null);__decorate([BABYLON.serialize()],Light.prototype,"radius",null);__decorate([BABYLON.serialize()],Light.prototype,"_renderPriority",void 0);__decorate([BABYLON.expandToProperty("_reorderLightsInScene")],Light.prototype,"renderPriority",void 0);__decorate([BABYLON.serialize()],Light.prototype,"shadowEnabled",void 0);__decorate([BABYLON.serialize("excludeWithLayerMask")],Light.prototype,"_excludeWithLayerMask",void 0);__decorate([BABYLON.serialize("includeOnlyWithLayerMask")],Light.prototype,"_includeOnlyWithLayerMask",void 0);__decorate([BABYLON.serialize("lightmapMode")],Light.prototype,"_lightmapMode",void 0);return Light}(BABYLON.Node);BABYLON.Light=Light})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Camera=function(_super){__extends(Camera,_super);function Camera(name,position,scene){var _this=_super.call(this,name,scene)||this;_this.upVector=BABYLON.Vector3.Up();_this.orthoLeft=null;_this.orthoRight=null;_this.orthoBottom=null;_this.orthoTop=null;_this.fov=.8;_this.minZ=1;_this.maxZ=1e4;_this.inertia=.9;_this.mode=Camera.PERSPECTIVE_CAMERA;_this.isIntermediate=false;_this.viewport=new BABYLON.Viewport(0,0,1,1);_this.layerMask=268435455;_this.fovMode=Camera.FOVMODE_VERTICAL_FIXED;_this.cameraRigMode=Camera.RIG_MODE_NONE;_this._rigCameras=new Array;_this._webvrViewMatrix=BABYLON.Matrix.Identity();_this._skipRendering=false;_this.customRenderTargets=new Array;_this.onViewMatrixChangedObservable=new BABYLON.Observable;_this.onProjectionMatrixChangedObservable=new BABYLON.Observable;_this.onAfterCheckInputsObservable=new BABYLON.Observable;_this.onRestoreStateObservable=new BABYLON.Observable;_this._computedViewMatrix=BABYLON.Matrix.Identity();_this._projectionMatrix=new BABYLON.Matrix;_this._doNotComputeProjectionMatrix=false;_this._postProcesses=new Array;_this._transformMatrix=BABYLON.Matrix.Zero();_this._activeMeshes=new BABYLON.SmartArray(256);_this._globalPosition=BABYLON.Vector3.Zero();_this._refreshFrustumPlanes=true;_this.getScene().addCamera(_this);if(!_this.getScene().activeCamera){_this.getScene().activeCamera=_this}_this.position=position;return _this}Object.defineProperty(Camera,"PERSPECTIVE_CAMERA",{get:function(){return Camera._PERSPECTIVE_CAMERA},enumerable:true,configurable:true});Object.defineProperty(Camera,"ORTHOGRAPHIC_CAMERA",{get:function(){return Camera._ORTHOGRAPHIC_CAMERA},enumerable:true,configurable:true});Object.defineProperty(Camera,"FOVMODE_VERTICAL_FIXED",{get:function(){return Camera._FOVMODE_VERTICAL_FIXED},enumerable:true,configurable:true});Object.defineProperty(Camera,"FOVMODE_HORIZONTAL_FIXED",{get:function(){return Camera._FOVMODE_HORIZONTAL_FIXED},enumerable:true,configurable:true});Object.defineProperty(Camera,"RIG_MODE_NONE",{get:function(){return Camera._RIG_MODE_NONE},enumerable:true,configurable:true});Object.defineProperty(Camera,"RIG_MODE_STEREOSCOPIC_ANAGLYPH",{get:function(){return Camera._RIG_MODE_STEREOSCOPIC_ANAGLYPH},enumerable:true,configurable:true});Object.defineProperty(Camera,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL",{get:function(){return Camera._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL},enumerable:true,configurable:true});Object.defineProperty(Camera,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED",{get:function(){return Camera._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED},enumerable:true,configurable:true});Object.defineProperty(Camera,"RIG_MODE_STEREOSCOPIC_OVERUNDER",{get:function(){return Camera._RIG_MODE_STEREOSCOPIC_OVERUNDER},enumerable:true,configurable:true});Object.defineProperty(Camera,"RIG_MODE_VR",{get:function(){return Camera._RIG_MODE_VR},enumerable:true,configurable:true});Object.defineProperty(Camera,"RIG_MODE_WEBVR",{get:function(){return Camera._RIG_MODE_WEBVR},enumerable:true,configurable:true});Camera.prototype.storeState=function(){this._stateStored=true;this._storedFov=this.fov;return this};Camera.prototype._restoreStateValues=function(){if(!this._stateStored){return false}this.fov=this._storedFov;return true};Camera.prototype.restoreState=function(){if(this._restoreStateValues()){this.onRestoreStateObservable.notifyObservers(this);return true}return false};Camera.prototype.getClassName=function(){return"Camera"};Camera.prototype.toString=function(fullDetails){var ret="Name: "+this.name;ret+=", type: "+this.getClassName();if(this.animations){for(var i=0;i<this.animations.length;i++){ret+=", animation[0]: "+this.animations[i].toString(fullDetails)}}if(fullDetails){}return ret};Object.defineProperty(Camera.prototype,"globalPosition",{get:function(){return this._globalPosition},enumerable:true,configurable:true});Camera.prototype.getActiveMeshes=function(){return this._activeMeshes};Camera.prototype.isActiveMesh=function(mesh){return this._activeMeshes.indexOf(mesh)!==-1};Camera.prototype._initCache=function(){_super.prototype._initCache.call(this);this._cache.position=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.upVector=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.mode=undefined;this._cache.minZ=undefined;this._cache.maxZ=undefined;this._cache.fov=undefined;this._cache.fovMode=undefined;this._cache.aspectRatio=undefined;this._cache.orthoLeft=undefined;this._cache.orthoRight=undefined;this._cache.orthoBottom=undefined;this._cache.orthoTop=undefined;this._cache.renderWidth=undefined;this._cache.renderHeight=undefined};Camera.prototype._updateCache=function(ignoreParentClass){if(!ignoreParentClass){_super.prototype._updateCache.call(this)}this._cache.position.copyFrom(this.position);this._cache.upVector.copyFrom(this.upVector)};Camera.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()};Camera.prototype._isSynchronizedViewMatrix=function(){if(!_super.prototype._isSynchronized.call(this))return false;return this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()};Camera.prototype._isSynchronizedProjectionMatrix=function(){var check=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!check){return false}var engine=this.getEngine();if(this.mode===Camera.PERSPECTIVE_CAMERA){check=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===engine.getAspectRatio(this)}else{check=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===engine.getRenderWidth()&&this._cache.renderHeight===engine.getRenderHeight()}return check};Camera.prototype.attachControl=function(element,noPreventDefault){};Camera.prototype.detachControl=function(element){};Camera.prototype.update=function(){this._checkInputs();if(this.cameraRigMode!==Camera.RIG_MODE_NONE){this._updateRigCameras()}};Camera.prototype._checkInputs=function(){this.onAfterCheckInputsObservable.notifyObservers(this)};Object.defineProperty(Camera.prototype,"rigCameras",{get:function(){return this._rigCameras},enumerable:true,configurable:true});Object.defineProperty(Camera.prototype,"rigPostProcess",{get:function(){return this._rigPostProcess},enumerable:true,configurable:true});Camera.prototype._cascadePostProcessesToRigCams=function(){if(this._postProcesses.length>0){this._postProcesses[0].markTextureDirty()}for(var i=0,len=this._rigCameras.length;i<len;i++){var cam=this._rigCameras[i];var rigPostProcess=cam._rigPostProcess;if(rigPostProcess){var isPass=rigPostProcess instanceof BABYLON.PassPostProcess;if(isPass){cam.isIntermediate=this._postProcesses.length===0}cam._postProcesses=this._postProcesses.slice(0).concat(rigPostProcess);rigPostProcess.markTextureDirty()}else{cam._postProcesses=this._postProcesses.slice(0)}}};Camera.prototype.attachPostProcess=function(postProcess,insertAt){if(insertAt===void 0){insertAt=null}if(!postProcess.isReusable()&&this._postProcesses.indexOf(postProcess)>-1){BABYLON.Tools.Error("You're trying to reuse a post process not defined as reusable.");return 0}if(insertAt==null||insertAt<0){this._postProcesses.push(postProcess)}else{this._postProcesses.splice(insertAt,0,postProcess)}this._cascadePostProcessesToRigCams();return this._postProcesses.indexOf(postProcess)};Camera.prototype.detachPostProcess=function(postProcess,atIndices){if(atIndices===void 0){atIndices=null}var result=[];var i;var index;if(!atIndices){var idx=this._postProcesses.indexOf(postProcess);if(idx!==-1){this._postProcesses.splice(idx,1)}}else{atIndices=atIndices instanceof Array?atIndices:[atIndices];for(i=atIndices.length-1;i>=0;i--){if(this._postProcesses[atIndices[i]]!==postProcess){result.push(i);continue}index=atIndices[i];this._postProcesses.splice(index,1)}}this._cascadePostProcessesToRigCams();return result};Camera.prototype.getWorldMatrix=function(){if(!this._worldMatrix){this._worldMatrix=BABYLON.Matrix.Identity()}var viewMatrix=this.getViewMatrix();viewMatrix.invertToRef(this._worldMatrix);return this._worldMatrix};Camera.prototype._getViewMatrix=function(){return BABYLON.Matrix.Identity()};Camera.prototype.getViewMatrix=function(force){if(!force&&this._isSynchronizedViewMatrix()){return this._computedViewMatrix}this.updateCache();this._computedViewMatrix=this._getViewMatrix();this._currentRenderId=this.getScene().getRenderId();this._refreshFrustumPlanes=true;if(!this.parent||!this.parent.getWorldMatrix){this._globalPosition.copyFrom(this.position)}else{if(!this._worldMatrix){this._worldMatrix=BABYLON.Matrix.Identity()}this._computedViewMatrix.invertToRef(this._worldMatrix);this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._computedViewMatrix);this._globalPosition.copyFromFloats(this._computedViewMatrix.m[12],this._computedViewMatrix.m[13],this._computedViewMatrix.m[14]);this._computedViewMatrix.invert();this._markSyncedWithParent()}if(this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix){this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix)}this.onViewMatrixChangedObservable.notifyObservers(this);return this._computedViewMatrix};Camera.prototype.freezeProjectionMatrix=function(projection){this._doNotComputeProjectionMatrix=true;if(projection!==undefined){this._projectionMatrix=projection}};Camera.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=false};Camera.prototype.getProjectionMatrix=function(force){if(this._doNotComputeProjectionMatrix||!force&&this._isSynchronizedProjectionMatrix()){return this._projectionMatrix}this._cache.mode=this.mode;this._cache.minZ=this.minZ;this._cache.maxZ=this.maxZ;this._refreshFrustumPlanes=true;var engine=this.getEngine();var scene=this.getScene();if(this.mode===Camera.PERSPECTIVE_CAMERA){this._cache.fov=this.fov;this._cache.fovMode=this.fovMode;this._cache.aspectRatio=engine.getAspectRatio(this);if(this.minZ<=0){this.minZ=.1}if(scene.useRightHandedSystem){BABYLON.Matrix.PerspectiveFovRHToRef(this.fov,engine.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===Camera.FOVMODE_VERTICAL_FIXED)}else{BABYLON.Matrix.PerspectiveFovLHToRef(this.fov,engine.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===Camera.FOVMODE_VERTICAL_FIXED)}}else{var halfWidth=engine.getRenderWidth()/2;var halfHeight=engine.getRenderHeight()/2;if(scene.useRightHandedSystem){BABYLON.Matrix.OrthoOffCenterRHToRef(this.orthoLeft||-halfWidth,this.orthoRight||halfWidth,this.orthoBottom||-halfHeight,this.orthoTop||halfHeight,this.minZ,this.maxZ,this._projectionMatrix)}else{BABYLON.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-halfWidth,this.orthoRight||halfWidth,this.orthoBottom||-halfHeight,this.orthoTop||halfHeight,this.minZ,this.maxZ,this._projectionMatrix)}this._cache.orthoLeft=this.orthoLeft;this._cache.orthoRight=this.orthoRight;this._cache.orthoBottom=this.orthoBottom;this._cache.orthoTop=this.orthoTop;this._cache.renderWidth=engine.getRenderWidth();this._cache.renderHeight=engine.getRenderHeight()}this.onProjectionMatrixChangedObservable.notifyObservers(this);return this._projectionMatrix};Camera.prototype.getTranformationMatrix=function(){this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix);return this._transformMatrix};Camera.prototype.updateFrustumPlanes=function(){if(!this._refreshFrustumPlanes){return}this.getTranformationMatrix();if(!this._frustumPlanes){this._frustumPlanes=BABYLON.Frustum.GetPlanes(this._transformMatrix)}else{BABYLON.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes)}this._refreshFrustumPlanes=false};Camera.prototype.isInFrustum=function(target){this.updateFrustumPlanes();return target.isInFrustum(this._frustumPlanes)};Camera.prototype.isCompletelyInFrustum=function(target){this.updateFrustumPlanes();return target.isCompletelyInFrustum(this._frustumPlanes)};Camera.prototype.getForwardRay=function(length,transform,origin){if(length===void 0){length=100}if(!transform){transform=this.getWorldMatrix()}if(!origin){origin=this.position}var forward=new BABYLON.Vector3(0,0,1);var forwardWorld=BABYLON.Vector3.TransformNormal(forward,transform);var direction=BABYLON.Vector3.Normalize(forwardWorld);return new BABYLON.Ray(origin,direction,length)};Camera.prototype.dispose=function(){this.onViewMatrixChangedObservable.clear();this.onProjectionMatrixChangedObservable.clear();this.onAfterCheckInputsObservable.clear();this.onRestoreStateObservable.clear();if(this.inputs){this.inputs.clear()}this.getScene().stopAnimation(this);this.getScene().removeCamera(this);while(this._rigCameras.length>0){this._rigCameras.pop().dispose()}if(this._rigPostProcess){this._rigPostProcess.dispose(this);this._rigPostProcess=null;this._postProcesses=[]}else if(this.cameraRigMode!==Camera.RIG_MODE_NONE){this._rigPostProcess=null;this._postProcesses=[]}else{var i=this._postProcesses.length;while(--i>=0){this._postProcesses[i].dispose(this)}}var i=this.customRenderTargets.length;while(--i>=0){this.customRenderTargets[i].dispose()}this.customRenderTargets=[];this._activeMeshes.dispose();_super.prototype.dispose.call(this)};Object.defineProperty(Camera.prototype,"leftCamera",{get:function(){if(this._rigCameras.length<1){return undefined}return this._rigCameras[0]},enumerable:true,configurable:true});Object.defineProperty(Camera.prototype,"rightCamera",{get:function(){if(this._rigCameras.length<2){return undefined}return this._rigCameras[1]},enumerable:true,configurable:true});Camera.prototype.getLeftTarget=function(){if(this._rigCameras.length<1){return undefined}return this._rigCameras[0].getTarget()};Camera.prototype.getRightTarget=function(){if(this._rigCameras.length<2){return undefined}return this._rigCameras[1].getTarget()};Camera.prototype.setCameraRigMode=function(mode,rigParams){if(this.cameraRigMode===mode){return}while(this._rigCameras.length>0){this._rigCameras.pop().dispose()}this.cameraRigMode=mode;this._cameraRigParams={};this._cameraRigParams.interaxialDistance=rigParams.interaxialDistance||.0637;this._cameraRigParams.stereoHalfAngle=BABYLON.Tools.ToRadians(this._cameraRigParams.interaxialDistance/.0637);if(this.cameraRigMode!==Camera.RIG_MODE_NONE){this._rigCameras.push(this.createRigCamera(this.name+"_L",0));this._rigCameras.push(this.createRigCamera(this.name+"_R",1))}switch(this.cameraRigMode){case Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:this._rigCameras[0]._rigPostProcess=new BABYLON.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]);this._rigCameras[1]._rigPostProcess=new BABYLON.AnaglyphPostProcess(this.name+"_anaglyph",1,this._rigCameras);break;case Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:var isStereoscopicHoriz=this.cameraRigMode===Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||this.cameraRigMode===Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;this._rigCameras[0]._rigPostProcess=new BABYLON.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]);this._rigCameras[1]._rigPostProcess=new BABYLON.StereoscopicInterlacePostProcess(this.name+"_stereoInterlace",this._rigCameras,isStereoscopicHoriz);break;case Camera.RIG_MODE_VR:var metrics=rigParams.vrCameraMetrics||BABYLON.VRCameraMetrics.GetDefault();this._rigCameras[0]._cameraRigParams.vrMetrics=metrics;this._rigCameras[0].viewport=new BABYLON.Viewport(0,0,.5,1);this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new BABYLON.Matrix;this._rigCameras[0]._cameraRigParams.vrHMatrix=metrics.leftHMatrix;this._rigCameras[0]._cameraRigParams.vrPreViewMatrix=metrics.leftPreViewMatrix;this._rigCameras[0].getProjectionMatrix=this._rigCameras[0]._getVRProjectionMatrix;this._rigCameras[1]._cameraRigParams.vrMetrics=metrics;this._rigCameras[1].viewport=new BABYLON.Viewport(.5,0,.5,1);this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new BABYLON.Matrix;this._rigCameras[1]._cameraRigParams.vrHMatrix=metrics.rightHMatrix;this._rigCameras[1]._cameraRigParams.vrPreViewMatrix=metrics.rightPreViewMatrix;this._rigCameras[1].getProjectionMatrix=this._rigCameras[1]._getVRProjectionMatrix;if(metrics.compensateDistortion){this._rigCameras[0]._rigPostProcess=new BABYLON.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Left",this._rigCameras[0],false,metrics);this._rigCameras[1]._rigPostProcess=new BABYLON.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Right",this._rigCameras[1],true,metrics)}break;case Camera.RIG_MODE_WEBVR:if(rigParams.vrDisplay){var leftEye=rigParams.vrDisplay.getEyeParameters("left");var rightEye=rigParams.vrDisplay.getEyeParameters("right");this._rigCameras[0].viewport=new BABYLON.Viewport(0,0,.5,1);this._rigCameras[0].setCameraRigParameter("left",true);this._rigCameras[0].setCameraRigParameter("specs",rigParams.specs);this._rigCameras[0].setCameraRigParameter("eyeParameters",leftEye);this._rigCameras[0].setCameraRigParameter("frameData",rigParams.frameData);this._rigCameras[0].setCameraRigParameter("parentCamera",rigParams.parentCamera);this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new BABYLON.Matrix;this._rigCameras[0].getProjectionMatrix=this._getWebVRProjectionMatrix;this._rigCameras[0].parent=this;this._rigCameras[0]._getViewMatrix=this._getWebVRViewMatrix;this._rigCameras[1].viewport=new BABYLON.Viewport(.5,0,.5,1);this._rigCameras[1].setCameraRigParameter("eyeParameters",rightEye);this._rigCameras[1].setCameraRigParameter("specs",rigParams.specs);this._rigCameras[1].setCameraRigParameter("frameData",rigParams.frameData);this._rigCameras[1].setCameraRigParameter("parentCamera",rigParams.parentCamera);this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new BABYLON.Matrix;this._rigCameras[1].getProjectionMatrix=this._getWebVRProjectionMatrix;this._rigCameras[1].parent=this;this._rigCameras[1]._getViewMatrix=this._getWebVRViewMatrix;if(Camera.UseAlternateWebVRRendering){this._rigCameras[1]._skipRendering=true;this._rigCameras[0]._alternateCamera=this._rigCameras[1]}}break}this._cascadePostProcessesToRigCams();this.update()};Camera.prototype._getVRProjectionMatrix=function(){BABYLON.Matrix.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix);this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix);return this._projectionMatrix};Camera.prototype._updateCameraRotationMatrix=function(){};Camera.prototype._updateWebVRCameraRotationMatrix=function(){};Camera.prototype._getWebVRProjectionMatrix=function(){return BABYLON.Matrix.Identity()};Camera.prototype._getWebVRViewMatrix=function(){return BABYLON.Matrix.Identity()};Camera.prototype.setCameraRigParameter=function(name,value){if(!this._cameraRigParams){this._cameraRigParams={}}this._cameraRigParams[name]=value;if(name==="interaxialDistance"){this._cameraRigParams.stereoHalfAngle=BABYLON.Tools.ToRadians(value/.0637)}};Camera.prototype.createRigCamera=function(name,cameraIndex){return null};Camera.prototype._updateRigCameras=function(){for(var i=0;i<this._rigCameras.length;i++){this._rigCameras[i].minZ=this.minZ;this._rigCameras[i].maxZ=this.maxZ;this._rigCameras[i].fov=this.fov}if(this.cameraRigMode===Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH){this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport}};Camera.prototype._setupInputs=function(){};Camera.prototype.serialize=function(){var serializationObject=BABYLON.SerializationHelper.Serialize(this);serializationObject.type=this.getClassName();if(this.parent){serializationObject.parentId=this.parent.id}if(this.inputs){this.inputs.serialize(serializationObject)}BABYLON.Animation.AppendSerializedAnimations(this,serializationObject);serializationObject.ranges=this.serializeAnimationRanges();return serializationObject};Camera.prototype.clone=function(name){return BABYLON.SerializationHelper.Clone(Camera.GetConstructorFromName(this.getClassName(),name,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this)};Camera.prototype.getDirection=function(localAxis){var result=BABYLON.Vector3.Zero();this.getDirectionToRef(localAxis,result);return result};Camera.prototype.getDirectionToRef=function(localAxis,result){BABYLON.Vector3.TransformNormalToRef(localAxis,this.getWorldMatrix(),result)};Camera.GetConstructorFromName=function(type,name,scene,interaxial_distance,isStereoscopicSideBySide){if(interaxial_distance===void 0){interaxial_distance=0}if(isStereoscopicSideBySide===void 0){isStereoscopicSideBySide=true}switch(type){case"ArcRotateCamera":return function(){return new BABYLON.ArcRotateCamera(name,0,0,1,BABYLON.Vector3.Zero(),scene)};case"DeviceOrientationCamera":return function(){return new BABYLON.DeviceOrientationCamera(name,BABYLON.Vector3.Zero(),scene)};case"FollowCamera":return function(){return new BABYLON.FollowCamera(name,BABYLON.Vector3.Zero(),scene)};case"ArcFollowCamera":return function(){return new BABYLON.ArcFollowCamera(name,0,0,1,null,scene)};case"GamepadCamera":return function(){return new BABYLON.GamepadCamera(name,BABYLON.Vector3.Zero(),scene)};case"TouchCamera":return function(){return new BABYLON.TouchCamera(name,BABYLON.Vector3.Zero(),scene)};case"VirtualJoysticksCamera":return function(){return new BABYLON.VirtualJoysticksCamera(name,BABYLON.Vector3.Zero(),scene)};case"WebVRFreeCamera":return function(){return new BABYLON.WebVRFreeCamera(name,BABYLON.Vector3.Zero(),scene)};case"WebVRGamepadCamera":return function(){return new BABYLON.WebVRFreeCamera(name,BABYLON.Vector3.Zero(),scene)};case"VRDeviceOrientationFreeCamera":return function(){return new BABYLON.VRDeviceOrientationFreeCamera(name,BABYLON.Vector3.Zero(),scene)};case"VRDeviceOrientationGamepadCamera":return function(){return new BABYLON.VRDeviceOrientationGamepadCamera(name,BABYLON.Vector3.Zero(),scene)};case"AnaglyphArcRotateCamera":return function(){return new BABYLON.AnaglyphArcRotateCamera(name,0,0,1,BABYLON.Vector3.Zero(),interaxial_distance,scene)};case"AnaglyphFreeCamera":return function(){return new BABYLON.AnaglyphFreeCamera(name,BABYLON.Vector3.Zero(),interaxial_distance,scene)};case"AnaglyphGamepadCamera":return function(){return new BABYLON.AnaglyphGamepadCamera(name,BABYLON.Vector3.Zero(),interaxial_distance,scene)};case"AnaglyphUniversalCamera":return function(){return new BABYLON.AnaglyphUniversalCamera(name,BABYLON.Vector3.Zero(),interaxial_distance,scene)};case"StereoscopicArcRotateCamera":return function(){return new BABYLON.StereoscopicArcRotateCamera(name,0,0,1,BABYLON.Vector3.Zero(),interaxial_distance,isStereoscopicSideBySide,scene)};case"StereoscopicFreeCamera":return function(){return new BABYLON.StereoscopicFreeCamera(name,BABYLON.Vector3.Zero(),interaxial_distance,isStereoscopicSideBySide,scene)};case"StereoscopicGamepadCamera":return function(){return new BABYLON.StereoscopicGamepadCamera(name,BABYLON.Vector3.Zero(),interaxial_distance,isStereoscopicSideBySide,scene)};case"StereoscopicUniversalCamera":return function(){return new BABYLON.StereoscopicUniversalCamera(name,BABYLON.Vector3.Zero(),interaxial_distance,isStereoscopicSideBySide,scene)};case"FreeCamera":return function(){return new BABYLON.UniversalCamera(name,BABYLON.Vector3.Zero(),scene)};default:return function(){return new BABYLON.UniversalCamera(name,BABYLON.Vector3.Zero(),scene)}}};Camera.Parse=function(parsedCamera,scene){var type=parsedCamera.type;var construct=Camera.GetConstructorFromName(type,parsedCamera.name,scene,parsedCamera.interaxial_distance,parsedCamera.isStereoscopicSideBySide);var camera=BABYLON.SerializationHelper.Parse(construct,parsedCamera,scene);if(parsedCamera.parentId){camera._waitingParentId=parsedCamera.parentId}if(camera.inputs){camera.inputs.parse(parsedCamera);camera._setupInputs()}if(camera.setPosition){camera.position.copyFromFloats(0,0,0);camera.setPosition(BABYLON.Vector3.FromArray(parsedCamera.position))}if(parsedCamera.target){if(camera.setTarget){camera.setTarget(BABYLON.Vector3.FromArray(parsedCamera.target))}}if(parsedCamera.cameraRigMode){var rigParams=parsedCamera.interaxial_distance?{interaxialDistance:parsedCamera.interaxial_distance}:{};camera.setCameraRigMode(parsedCamera.cameraRigMode,rigParams)}if(parsedCamera.animations){for(var animationIndex=0;animationIndex<parsedCamera.animations.length;animationIndex++){var parsedAnimation=parsedCamera.animations[animationIndex];camera.animations.push(BABYLON.Animation.Parse(parsedAnimation))}BABYLON.Node.ParseAnimationRanges(camera,parsedCamera,scene)}if(parsedCamera.autoAnimate){scene.beginAnimation(camera,parsedCamera.autoAnimateFrom,parsedCamera.autoAnimateTo,parsedCamera.autoAnimateLoop,parsedCamera.autoAnimateSpeed||1)}return camera};Camera._PERSPECTIVE_CAMERA=0;Camera._ORTHOGRAPHIC_CAMERA=1;Camera._FOVMODE_VERTICAL_FIXED=0;Camera._FOVMODE_HORIZONTAL_FIXED=1;Camera._RIG_MODE_NONE=0;Camera._RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;Camera._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;Camera._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;Camera._RIG_MODE_STEREOSCOPIC_OVERUNDER=13;Camera._RIG_MODE_VR=20;Camera._RIG_MODE_WEBVR=21;Camera.ForceAttachControlToAlwaysPreventDefault=false;Camera.UseAlternateWebVRRendering=false;__decorate([BABYLON.serializeAsVector3()],Camera.prototype,"position",void 0);__decorate([BABYLON.serializeAsVector3()],Camera.prototype,"upVector",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"orthoLeft",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"orthoRight",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"orthoBottom",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"orthoTop",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"fov",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"minZ",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"maxZ",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"inertia",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"mode",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"layerMask",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"fovMode",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"cameraRigMode",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"interaxialDistance",void 0);__decorate([BABYLON.serialize()],Camera.prototype,"isStereoscopicSideBySide",void 0);return Camera}(BABYLON.Node);BABYLON.Camera=Camera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var RenderingManager=function(){function RenderingManager(scene){this._renderingGroups=new Array;this._autoClearDepthStencil={};this._customOpaqueSortCompareFn={};this._customAlphaTestSortCompareFn={};this._customTransparentSortCompareFn={};this._renderinGroupInfo=null;this._scene=scene;for(var i=RenderingManager.MIN_RENDERINGGROUPS;i<RenderingManager.MAX_RENDERINGGROUPS;i++){this._autoClearDepthStencil[i]={autoClear:true,depth:true,stencil:true}}}RenderingManager.prototype._clearDepthStencilBuffer=function(depth,stencil){if(depth===void 0){depth=true}if(stencil===void 0){stencil=true}if(this._depthStencilBufferAlreadyCleaned){return}this._scene.getEngine().clear(null,false,depth,stencil);this._depthStencilBufferAlreadyCleaned=true};RenderingManager.prototype.render=function(customRenderFunction,activeMeshes,renderParticles,renderSprites){var observable=this._scene.onRenderingGroupObservable.hasObservers()?this._scene.onRenderingGroupObservable:null;var info=null;if(observable){if(!this._renderinGroupInfo){this._renderinGroupInfo=new BABYLON.RenderingGroupInfo}info=this._renderinGroupInfo;info.scene=this._scene;info.camera=this._scene.activeCamera}if(renderSprites){for(var index=0;index<this._scene.spriteManagers.length;index++){var manager=this._scene.spriteManagers[index];this.dispatchSprites(manager)}}for(var index=RenderingManager.MIN_RENDERINGGROUPS;index<RenderingManager.MAX_RENDERINGGROUPS;index++){this._depthStencilBufferAlreadyCleaned=index===RenderingManager.MIN_RENDERINGGROUPS;var renderingGroup=this._renderingGroups[index];if(!renderingGroup&&!observable)continue;this._currentIndex=index;var renderingGroupMask=0;if(observable){renderingGroupMask=Math.pow(2,index);info.renderStage=BABYLON.RenderingGroupInfo.STAGE_PRECLEAR;info.renderingGroupId=index;observable.notifyObservers(info,renderingGroupMask)}if(RenderingManager.AUTOCLEAR){var autoClear=this._autoClearDepthStencil[index];if(autoClear&&autoClear.autoClear){this._clearDepthStencilBuffer(autoClear.depth,autoClear.stencil)}}if(observable){info.renderStage=BABYLON.RenderingGroupInfo.STAGE_PREOPAQUE;observable.notifyObservers(info,renderingGroupMask);info.renderStage=BABYLON.RenderingGroupInfo.STAGE_PRETRANSPARENT;observable.notifyObservers(info,renderingGroupMask)}if(renderingGroup)renderingGroup.render(customRenderFunction,renderSprites,renderParticles,activeMeshes);if(observable){info.renderStage=BABYLON.RenderingGroupInfo.STAGE_POSTTRANSPARENT;observable.notifyObservers(info,renderingGroupMask)}}};RenderingManager.prototype.reset=function(){for(var index=RenderingManager.MIN_RENDERINGGROUPS;index<RenderingManager.MAX_RENDERINGGROUPS;index++){var renderingGroup=this._renderingGroups[index];if(renderingGroup){renderingGroup.prepare()}}};RenderingManager.prototype.dispose=function(){for(var index=RenderingManager.MIN_RENDERINGGROUPS;index<RenderingManager.MAX_RENDERINGGROUPS;index++){var renderingGroup=this._renderingGroups[index];if(renderingGroup){renderingGroup.dispose()}}this._renderingGroups.length=0};RenderingManager.prototype._prepareRenderingGroup=function(renderingGroupId){if(!this._renderingGroups[renderingGroupId]){this._renderingGroups[renderingGroupId]=new BABYLON.RenderingGroup(renderingGroupId,this._scene,this._customOpaqueSortCompareFn[renderingGroupId],this._customAlphaTestSortCompareFn[renderingGroupId],this._customTransparentSortCompareFn[renderingGroupId])}};RenderingManager.prototype.dispatchSprites=function(spriteManager){var renderingGroupId=spriteManager.renderingGroupId||0;this._prepareRenderingGroup(renderingGroupId);this._renderingGroups[renderingGroupId].dispatchSprites(spriteManager)};RenderingManager.prototype.dispatchParticles=function(particleSystem){var renderingGroupId=particleSystem.renderingGroupId||0;this._prepareRenderingGroup(renderingGroupId);this._renderingGroups[renderingGroupId].dispatchParticles(particleSystem)};RenderingManager.prototype.dispatch=function(subMesh){var mesh=subMesh.getMesh();var renderingGroupId=mesh.renderingGroupId||0;this._prepareRenderingGroup(renderingGroupId);this._renderingGroups[renderingGroupId].dispatch(subMesh)};RenderingManager.prototype.setRenderingOrder=function(renderingGroupId,opaqueSortCompareFn,alphaTestSortCompareFn,transparentSortCompareFn){if(opaqueSortCompareFn===void 0){opaqueSortCompareFn=null}if(alphaTestSortCompareFn===void 0){alphaTestSortCompareFn=null}if(transparentSortCompareFn===void 0){transparentSortCompareFn=null}this._customOpaqueSortCompareFn[renderingGroupId]=opaqueSortCompareFn;this._customAlphaTestSortCompareFn[renderingGroupId]=alphaTestSortCompareFn;this._customTransparentSortCompareFn[renderingGroupId]=transparentSortCompareFn;if(this._renderingGroups[renderingGroupId]){var group=this._renderingGroups[renderingGroupId];group.opaqueSortCompareFn=this._customOpaqueSortCompareFn[renderingGroupId];group.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[renderingGroupId];group.transparentSortCompareFn=this._customTransparentSortCompareFn[renderingGroupId]}};RenderingManager.prototype.setRenderingAutoClearDepthStencil=function(renderingGroupId,autoClearDepthStencil,depth,stencil){if(depth===void 0){depth=true}if(stencil===void 0){stencil=true}this._autoClearDepthStencil[renderingGroupId]={autoClear:autoClearDepthStencil,depth:depth,stencil:stencil}};RenderingManager.MAX_RENDERINGGROUPS=4;RenderingManager.MIN_RENDERINGGROUPS=0;RenderingManager.AUTOCLEAR=true;return RenderingManager}();BABYLON.RenderingManager=RenderingManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var RenderingGroup=function(){function RenderingGroup(index,scene,opaqueSortCompareFn,alphaTestSortCompareFn,transparentSortCompareFn){if(opaqueSortCompareFn===void 0){opaqueSortCompareFn=null}if(alphaTestSortCompareFn===void 0){alphaTestSortCompareFn=null}if(transparentSortCompareFn===void 0){transparentSortCompareFn=null}this.index=index;this._opaqueSubMeshes=new BABYLON.SmartArray(256);this._transparentSubMeshes=new BABYLON.SmartArray(256);this._alphaTestSubMeshes=new BABYLON.SmartArray(256);this._depthOnlySubMeshes=new BABYLON.SmartArray(256);this._particleSystems=new BABYLON.SmartArray(256);this._spriteManagers=new BABYLON.SmartArray(256);this._edgesRenderers=new BABYLON.SmartArray(16);this._scene=scene;this.opaqueSortCompareFn=opaqueSortCompareFn;this.alphaTestSortCompareFn=alphaTestSortCompareFn;this.transparentSortCompareFn=transparentSortCompareFn}Object.defineProperty(RenderingGroup.prototype,"opaqueSortCompareFn",{set:function(value){this._opaqueSortCompareFn=value;if(value){this._renderOpaque=this.renderOpaqueSorted}else{this._renderOpaque=RenderingGroup.renderUnsorted}},enumerable:true,configurable:true});Object.defineProperty(RenderingGroup.prototype,"alphaTestSortCompareFn",{set:function(value){this._alphaTestSortCompareFn=value;if(value){this._renderAlphaTest=this.renderAlphaTestSorted}else{this._renderAlphaTest=RenderingGroup.renderUnsorted}},enumerable:true,configurable:true});Object.defineProperty(RenderingGroup.prototype,"transparentSortCompareFn",{set:function(value){if(value){this._transparentSortCompareFn=value}else{this._transparentSortCompareFn=RenderingGroup.defaultTransparentSortCompare}this._renderTransparent=this.renderTransparentSorted},enumerable:true,configurable:true});RenderingGroup.prototype.render=function(customRenderFunction,renderSprites,renderParticles,activeMeshes){if(customRenderFunction){customRenderFunction(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}var engine=this._scene.getEngine();if(this._depthOnlySubMeshes.length!==0){engine.setAlphaTesting(true);engine.setColorWrite(false);this._renderAlphaTest(this._depthOnlySubMeshes);engine.setAlphaTesting(false);engine.setColorWrite(true)}if(this._opaqueSubMeshes.length!==0){this._renderOpaque(this._opaqueSubMeshes)}if(this._alphaTestSubMeshes.length!==0){engine.setAlphaTesting(true);this._renderAlphaTest(this._alphaTestSubMeshes);engine.setAlphaTesting(false)}var stencilState=engine.getStencilBuffer();engine.setStencilBuffer(false);if(renderSprites){this._renderSprites()}if(renderParticles){this._renderParticles(activeMeshes)}if(this.onBeforeTransparentRendering){this.onBeforeTransparentRendering()}if(this._transparentSubMeshes.length!==0){this._renderTransparent(this._transparentSubMeshes);engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE)}engine.setStencilBuffer(false);for(var edgesRendererIndex=0;edgesRendererIndex<this._edgesRenderers.length;edgesRendererIndex++){this._edgesRenderers.data[edgesRendererIndex].render()}engine.setStencilBuffer(stencilState)};RenderingGroup.prototype.renderOpaqueSorted=function(subMeshes){return RenderingGroup.renderSorted(subMeshes,this._opaqueSortCompareFn,this._scene.activeCamera.globalPosition,false)};RenderingGroup.prototype.renderAlphaTestSorted=function(subMeshes){return RenderingGroup.renderSorted(subMeshes,this._alphaTestSortCompareFn,this._scene.activeCamera.globalPosition,false)};RenderingGroup.prototype.renderTransparentSorted=function(subMeshes){return RenderingGroup.renderSorted(subMeshes,this._transparentSortCompareFn,this._scene.activeCamera.globalPosition,true)};RenderingGroup.renderSorted=function(subMeshes,sortCompareFn,cameraPosition,transparent){var subIndex=0;var subMesh;for(;subIndex<subMeshes.length;subIndex++){subMesh=subMeshes.data[subIndex];subMesh._alphaIndex=subMesh.getMesh().alphaIndex;subMesh._distanceToCamera=subMesh.getBoundingInfo().boundingSphere.centerWorld.subtract(cameraPosition).length()}var sortedArray=subMeshes.data.slice(0,subMeshes.length);sortedArray.sort(sortCompareFn);for(subIndex=0;subIndex<sortedArray.length;subIndex++){subMesh=sortedArray[subIndex];if(transparent){var material=subMesh.getMaterial();if(material.needDepthPrePass){var engine=material.getScene().getEngine();engine.setColorWrite(false);engine.setAlphaTesting(true);engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE);subMesh.render(false);engine.setAlphaTesting(false);engine.setColorWrite(true)}}subMesh.render(transparent)}};RenderingGroup.renderUnsorted=function(subMeshes){for(var subIndex=0;subIndex<subMeshes.length;subIndex++){var submesh=subMeshes.data[subIndex];submesh.render(false)}};RenderingGroup.defaultTransparentSortCompare=function(a,b){if(a._alphaIndex>b._alphaIndex){return 1}if(a._alphaIndex<b._alphaIndex){return-1}return RenderingGroup.backToFrontSortCompare(a,b)};RenderingGroup.backToFrontSortCompare=function(a,b){if(a._distanceToCamera<b._distanceToCamera){return 1}if(a._distanceToCamera>b._distanceToCamera){return-1}return 0};RenderingGroup.frontToBackSortCompare=function(a,b){if(a._distanceToCamera<b._distanceToCamera){return-1}if(a._distanceToCamera>b._distanceToCamera){return 1}return 0};RenderingGroup.prototype.prepare=function(){this._opaqueSubMeshes.reset();this._transparentSubMeshes.reset();this._alphaTestSubMeshes.reset();this._depthOnlySubMeshes.reset();this._particleSystems.reset();this._spriteManagers.reset();this._edgesRenderers.reset()};RenderingGroup.prototype.dispose=function(){this._opaqueSubMeshes.dispose();this._transparentSubMeshes.dispose();this._alphaTestSubMeshes.dispose();this._depthOnlySubMeshes.dispose();this._particleSystems.dispose();this._spriteManagers.dispose();this._edgesRenderers.dispose()};RenderingGroup.prototype.dispatch=function(subMesh){var material=subMesh.getMaterial();var mesh=subMesh.getMesh();if(material.needAlphaBlending()||mesh.visibility<1||mesh.hasVertexAlpha){this._transparentSubMeshes.push(subMesh)}else if(material.needAlphaTesting()){if(material.needDepthPrePass){this._depthOnlySubMeshes.push(subMesh)}this._alphaTestSubMeshes.push(subMesh)}else{if(material.needDepthPrePass){this._depthOnlySubMeshes.push(subMesh)}this._opaqueSubMeshes.push(subMesh)}if(mesh._edgesRenderer){this._edgesRenderers.push(mesh._edgesRenderer)}};RenderingGroup.prototype.dispatchSprites=function(spriteManager){this._spriteManagers.push(spriteManager)};RenderingGroup.prototype.dispatchParticles=function(particleSystem){this._particleSystems.push(particleSystem)};RenderingGroup.prototype._renderParticles=function(activeMeshes){if(this._particleSystems.length===0){return}var activeCamera=this._scene.activeCamera;this._scene._particlesDuration.beginMonitoring();for(var particleIndex=0;particleIndex<this._scene._activeParticleSystems.length;particleIndex++){var particleSystem=this._scene._activeParticleSystems.data[particleIndex];if((activeCamera.layerMask&particleSystem.layerMask)===0){continue}var emitter=particleSystem.emitter;if(!emitter.position||!activeMeshes||activeMeshes.indexOf(emitter)!==-1){this._scene._activeParticles.addCount(particleSystem.render(),false)}}this._scene._particlesDuration.endMonitoring(false)};RenderingGroup.prototype._renderSprites=function(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0){return}var activeCamera=this._scene.activeCamera;this._scene._spritesDuration.beginMonitoring();for(var id=0;id<this._spriteManagers.length;id++){var spriteManager=this._spriteManagers.data[id];if((activeCamera.layerMask&spriteManager.layerMask)!==0){spriteManager.render()}}this._scene._spritesDuration.endMonitoring(false)};return RenderingGroup}();BABYLON.RenderingGroup=RenderingGroup})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ClickInfo=function(){function ClickInfo(){this._singleClick=false;this._doubleClick=false;this._hasSwiped=false;this._ignore=false}Object.defineProperty(ClickInfo.prototype,"singleClick",{get:function(){return this._singleClick},set:function(b){this._singleClick=b},enumerable:true,configurable:true});Object.defineProperty(ClickInfo.prototype,"doubleClick",{get:function(){return this._doubleClick},set:function(b){this._doubleClick=b},enumerable:true,configurable:true});Object.defineProperty(ClickInfo.prototype,"hasSwiped",{get:function(){return this._hasSwiped},set:function(b){this._hasSwiped=b},enumerable:true,configurable:true});Object.defineProperty(ClickInfo.prototype,"ignore",{get:function(){return this._ignore},set:function(b){this._ignore=b},enumerable:true,configurable:true});return ClickInfo}();var RenderingGroupInfo=function(){function RenderingGroupInfo(){}RenderingGroupInfo.STAGE_PRECLEAR=1;RenderingGroupInfo.STAGE_PREOPAQUE=2;RenderingGroupInfo.STAGE_PRETRANSPARENT=3;RenderingGroupInfo.STAGE_POSTTRANSPARENT=4;return RenderingGroupInfo}();BABYLON.RenderingGroupInfo=RenderingGroupInfo;var Scene=function(){function Scene(engine){this.autoClear=true;this.autoClearDepthAndStencil=true;this.clearColor=new BABYLON.Color4(.2,.2,.3,1);this.ambientColor=new BABYLON.Color3(0,0,0);this.forceWireframe=false;this._forcePointsCloud=false;this.forceShowBoundingBoxes=false;this.animationsEnabled=true;this.constantlyUpdateMeshUnderPointer=false;this.hoverCursor="pointer";this.defaultCursor="";this.preventDefaultOnPointerDown=true;this.metadata=null;this.onDisposeObservable=new BABYLON.Observable;this.onBeforeRenderObservable=new BABYLON.Observable;this.onAfterRenderObservable=new BABYLON.Observable;this.onReadyObservable=new BABYLON.Observable;this.onBeforeCameraRenderObservable=new BABYLON.Observable;this.onAfterCameraRenderObservable=new BABYLON.Observable;this.onNewCameraAddedObservable=new BABYLON.Observable;this.onCameraRemovedObservable=new BABYLON.Observable;this.onNewLightAddedObservable=new BABYLON.Observable;this.onLightRemovedObservable=new BABYLON.Observable;this.onNewGeometryAddedObservable=new BABYLON.Observable;this.onGeometryRemovedObservable=new BABYLON.Observable;this.onNewMeshAddedObservable=new BABYLON.Observable;this.onMeshRemovedObservable=new BABYLON.Observable;this.onBeforeStepObservable=new BABYLON.Observable;this.onAfterStepObservable=new BABYLON.Observable;this.onRenderingGroupObservable=new BABYLON.Observable;this.animations=[];this.onPrePointerObservable=new BABYLON.Observable;this.onPointerObservable=new BABYLON.Observable;this._meshPickProceed=false;this._previousHasSwiped=false;this._currentPickResult=null;this._previousPickResult=null;this._totalPointersPressed=0;this._doubleClickOccured=false;this.cameraToUseForPointers=null;this._startingPointerPosition=new BABYLON.Vector2(0,0);this._previousStartingPointerPosition=new BABYLON.Vector2(0,0);this._startingPointerTime=0;this._previousStartingPointerTime=0;this._timeAccumulator=0;this._currentStepId=0;this._currentInternalStep=0;this.onPreKeyboardObservable=new BABYLON.Observable;this.onKeyboardObservable=new BABYLON.Observable;this._useRightHandedSystem=false;this._fogEnabled=true;this._fogMode=Scene.FOGMODE_NONE;this.fogColor=new BABYLON.Color3(.2,.2,.3);this.fogDensity=.1;this.fogStart=0;this.fogEnd=1e3;this._shadowsEnabled=true;this._lightsEnabled=true;this.lights=new Array;this.cameras=new Array;this.activeCameras=new Array;this.meshes=new Array;this._geometries=new Array;this.materials=new Array;this.multiMaterials=new Array;this._texturesEnabled=true;this.textures=new Array;this.particlesEnabled=true;this.particleSystems=new Array;this.spritesEnabled=true;this.spriteManagers=new Array;this.layers=new Array;this.highlightLayers=new Array;this._skeletonsEnabled=true;this.skeletons=new Array;this.morphTargetManagers=new Array;this.lensFlaresEnabled=true;this.lensFlareSystems=new Array;this.collisionsEnabled=true;this.gravity=new BABYLON.Vector3(0,-9.807,0);this.postProcesses=new Array;this.postProcessesEnabled=true;this.renderTargetsEnabled=true;this.dumpNextRenderTargets=false;this.customRenderTargets=new Array;this.importedMeshesFiles=new Array;this.probesEnabled=true;this.reflectionProbes=new Array;this._actionManagers=new Array;this._meshesForIntersections=new BABYLON.SmartArray(256);this.proceduralTexturesEnabled=true;this._proceduralTextures=new Array;this.soundTracks=new Array;this._audioEnabled=true;this._headphone=false;this._totalMeshesCounter=new BABYLON.PerfCounter;this._totalLightsCounter=new BABYLON.PerfCounter;this._totalMaterialsCounter=new BABYLON.PerfCounter;this._totalTexturesCounter=new BABYLON.PerfCounter;this._totalVertices=new BABYLON.PerfCounter;this._activeIndices=new BABYLON.PerfCounter;this._activeParticles=new BABYLON.PerfCounter;this._interFrameDuration=new BABYLON.PerfCounter;this._lastFrameDuration=new BABYLON.PerfCounter;this._evaluateActiveMeshesDuration=new BABYLON.PerfCounter;this._renderTargetsDuration=new BABYLON.PerfCounter;this._particlesDuration=new BABYLON.PerfCounter;this._renderDuration=new BABYLON.PerfCounter;this._spritesDuration=new BABYLON.PerfCounter;this._activeBones=new BABYLON.PerfCounter;this._animationTime=0;this.animationTimeScale=1;this._renderId=0;this._executeWhenReadyTimeoutId=-1;this._intermediateRendering=false;this._viewUpdateFlag=-1;this._projectionUpdateFlag=-1;this._alternateViewUpdateFlag=-1;this._alternateProjectionUpdateFlag=-1;this._toBeDisposed=new BABYLON.SmartArray(256);this._pendingData=new Array;this._activeMeshes=new BABYLON.SmartArray(256);this._processedMaterials=new BABYLON.SmartArray(256);this._renderTargets=new BABYLON.SmartArray(256);this._activeParticleSystems=new BABYLON.SmartArray(256);this._activeSkeletons=new BABYLON.SmartArray(32);this._softwareSkinnedMeshes=new BABYLON.SmartArray(32);this._activeAnimatables=new Array;this._transformMatrix=BABYLON.Matrix.Zero();this._useAlternateCameraConfiguration=false;this._alternateRendering=false;this.requireLightSorting=false;this._activeMeshesFrozen=false;this._engine=engine||BABYLON.Engine.LastCreatedEngine;this._engine.scenes.push(this);this._uid=null;this._renderingManager=new BABYLON.RenderingManager(this);this.postProcessManager=new BABYLON.PostProcessManager(this);if(BABYLON.OutlineRenderer){this._outlineRenderer=new BABYLON.OutlineRenderer(this)}if(BABYLON.Tools.IsWindowObjectExist()){this.attachControl()}if(BABYLON.SimplificationQueue){this.simplificationQueue=new BABYLON.SimplificationQueue}this.workerCollisions=false;this._createUbo();this._imageProcessingConfiguration=new BABYLON.ImageProcessingConfiguration}Object.defineProperty(Scene,"FOGMODE_NONE",{get:function(){return Scene._FOGMODE_NONE},enumerable:true,configurable:true});Object.defineProperty(Scene,"FOGMODE_EXP",{get:function(){return Scene._FOGMODE_EXP},enumerable:true,configurable:true});Object.defineProperty(Scene,"FOGMODE_EXP2",{get:function(){return Scene._FOGMODE_EXP2},enumerable:true,configurable:true});Object.defineProperty(Scene,"FOGMODE_LINEAR",{get:function(){return Scene._FOGMODE_LINEAR},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(value){this._environmentTexture=value;this.markAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"forcePointsCloud",{get:function(){return this._forcePointsCloud},set:function(value){if(this._forcePointsCloud===value){return}this._forcePointsCloud=value;this.markAllMaterialsAsDirty(BABYLON.Material.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"onDispose",{set:function(callback){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"beforeRender",{set:function(callback){if(this._onBeforeRenderObserver){this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver)}this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"afterRender",{set:function(callback){if(this._onAfterRenderObserver){this.onAfterRenderObservable.remove(this._onAfterRenderObserver)}this._onAfterRenderObserver=this.onAfterRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"beforeCameraRender",{set:function(callback){if(this._onBeforeCameraRenderObserver){this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver)}this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"afterCameraRender",{set:function(callback){if(this._onAfterCameraRenderObserver){this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver)}this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new BABYLON.GamepadManager}return this._gamepadManager},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"unTranslatedPointer",{get:function(){return new BABYLON.Vector2(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"useRightHandedSystem",{get:function(){return this._useRightHandedSystem},set:function(value){if(this._useRightHandedSystem===value){return}this._useRightHandedSystem=value;this.markAllMaterialsAsDirty(BABYLON.Material.MiscDirtyFlag)},enumerable:true,configurable:true});Scene.prototype.setStepId=function(newStepId){this._currentStepId=newStepId};Scene.prototype.getStepId=function(){return this._currentStepId};Scene.prototype.getInternalStep=function(){return this._currentInternalStep};Object.defineProperty(Scene.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(value){if(this._fogEnabled===value){return}this._fogEnabled=value;this.markAllMaterialsAsDirty(BABYLON.Material.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"fogMode",{get:function(){return this._fogMode},set:function(value){if(this._fogMode===value){return}this._fogMode=value;this.markAllMaterialsAsDirty(BABYLON.Material.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"shadowsEnabled",{get:function(){return this._shadowsEnabled},set:function(value){if(this._shadowsEnabled===value){return}this._shadowsEnabled=value;this.markAllMaterialsAsDirty(BABYLON.Material.LightDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"lightsEnabled",{get:function(){return this._lightsEnabled},set:function(value){if(this._lightsEnabled===value){return}this._lightsEnabled=value;this.markAllMaterialsAsDirty(BABYLON.Material.LightDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"defaultMaterial",{get:function(){if(!this._defaultMaterial){this._defaultMaterial=new BABYLON.StandardMaterial("default material",this)}return this._defaultMaterial},set:function(value){this._defaultMaterial=value},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"texturesEnabled",{get:function(){return this._texturesEnabled},set:function(value){if(this._texturesEnabled===value){return}this._texturesEnabled=value;this.markAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"skeletonsEnabled",{get:function(){return this._skeletonsEnabled},set:function(value){if(this._skeletonsEnabled===value){return}this._skeletonsEnabled=value;this.markAllMaterialsAsDirty(BABYLON.Material.AttributesDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){this._postProcessRenderPipelineManager=new BABYLON.PostProcessRenderPipelineManager}return this._postProcessRenderPipelineManager},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"mainSoundTrack",{get:function(){if(!this._mainSoundTrack){this._mainSoundTrack=new BABYLON.SoundTrack(this,{mainTrack:true})}return this._mainSoundTrack},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"_isAlternateRenderingEnabled",{get:function(){return this._alternateRendering},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"frustumPlanes",{get:function(){return this._frustumPlanes},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"debugLayer",{get:function(){if(!this._debugLayer){this._debugLayer=new BABYLON.DebugLayer(this)}return this._debugLayer},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"workerCollisions",{get:function(){return this._workerCollisions},set:function(enabled){if(!BABYLON.CollisionCoordinatorLegacy){return}enabled=enabled&&!!Worker;this._workerCollisions=enabled;if(this.collisionCoordinator){this.collisionCoordinator.destroy()}this.collisionCoordinator=enabled?new BABYLON.CollisionCoordinatorWorker:new BABYLON.CollisionCoordinatorLegacy;this.collisionCoordinator.init(this)},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"pointerX",{get:function(){return this._pointerX},enumerable:true,configurable:true});Object.defineProperty(Scene.prototype,"pointerY",{get:function(){return this._pointerY},enumerable:true,configurable:true});Scene.prototype.getCachedMaterial=function(){return this._cachedMaterial};Scene.prototype.getCachedEffect=function(){return this._cachedEffect};Scene.prototype.getCachedVisibility=function(){return this._cachedVisibility};Scene.prototype.isCachedMaterialInvalid=function(material,effect,visibility){if(visibility===void 0){visibility=1}return this._cachedEffect!==effect||this._cachedMaterial!==material||this._cachedVisibility!==visibility};Scene.prototype.getBoundingBoxRenderer=function(){if(!this._boundingBoxRenderer){this._boundingBoxRenderer=new BABYLON.BoundingBoxRenderer(this)}return this._boundingBoxRenderer};Scene.prototype.getOutlineRenderer=function(){return this._outlineRenderer};Scene.prototype.getEngine=function(){return this._engine};Scene.prototype.getTotalVertices=function(){return this._totalVertices.current};Object.defineProperty(Scene.prototype,"totalVerticesPerfCounter",{get:function(){return this._totalVertices},enumerable:true,configurable:true});Scene.prototype.getActiveIndices=function(){return this._activeIndices.current};Object.defineProperty(Scene.prototype,"totalActiveIndicesPerfCounter",{get:function(){return this._activeIndices},enumerable:true,configurable:true});Scene.prototype.getActiveParticles=function(){return this._activeParticles.current};Object.defineProperty(Scene.prototype,"activeParticlesPerfCounter",{get:function(){return this._activeParticles},enumerable:true,configurable:true});Scene.prototype.getActiveBones=function(){return this._activeBones.current};Object.defineProperty(Scene.prototype,"activeBonesPerfCounter",{get:function(){return this._activeBones},enumerable:true,configurable:true});Scene.prototype.getInterFramePerfCounter=function(){return this._interFrameDuration.current};Object.defineProperty(Scene.prototype,"interFramePerfCounter",{get:function(){return this._interFrameDuration},enumerable:true,configurable:true});Scene.prototype.getLastFrameDuration=function(){return this._lastFrameDuration.current};Object.defineProperty(Scene.prototype,"lastFramePerfCounter",{get:function(){return this._lastFrameDuration},enumerable:true,configurable:true});Scene.prototype.getEvaluateActiveMeshesDuration=function(){return this._evaluateActiveMeshesDuration.current};Object.defineProperty(Scene.prototype,"evaluateActiveMeshesDurationPerfCounter",{get:function(){return this._evaluateActiveMeshesDuration},enumerable:true,configurable:true});Scene.prototype.getActiveMeshes=function(){return this._activeMeshes};Scene.prototype.getRenderTargetsDuration=function(){return this._renderTargetsDuration.current};Scene.prototype.getRenderDuration=function(){return this._renderDuration.current};Object.defineProperty(Scene.prototype,"renderDurationPerfCounter",{get:function(){return this._renderDuration},enumerable:true,configurable:true});Scene.prototype.getParticlesDuration=function(){return this._particlesDuration.current};Object.defineProperty(Scene.prototype,"particlesDurationPerfCounter",{get:function(){return this._particlesDuration},enumerable:true,configurable:true});Scene.prototype.getSpritesDuration=function(){return this._spritesDuration.current};Object.defineProperty(Scene.prototype,"spriteDuractionPerfCounter",{get:function(){return this._spritesDuration},enumerable:true,configurable:true});Scene.prototype.getAnimationRatio=function(){return this._animationRatio};Scene.prototype.getRenderId=function(){return this._renderId};Scene.prototype.incrementRenderId=function(){this._renderId++};Scene.prototype._updatePointerPosition=function(evt){var canvasRect=this._engine.getRenderingCanvasClientRect();this._pointerX=evt.clientX-canvasRect.left;this._pointerY=evt.clientY-canvasRect.top;this._unTranslatedPointerX=this._pointerX;this._unTranslatedPointerY=this._pointerY};Scene.prototype._createUbo=function(){this._sceneUbo=new BABYLON.UniformBuffer(this._engine,null,true);this._sceneUbo.addUniform("viewProjection",16);this._sceneUbo.addUniform("view",16)};Scene.prototype._createAlternateUbo=function(){this._alternateSceneUbo=new BABYLON.UniformBuffer(this._engine,null,true);this._alternateSceneUbo.addUniform("viewProjection",16);this._alternateSceneUbo.addUniform("view",16)};Scene.prototype.simulatePointerMove=function(pickResult){var evt=new PointerEvent("pointermove");return this._processPointerMove(pickResult,evt)};Scene.prototype._processPointerMove=function(pickResult,evt){var canvas=this._engine.getRenderingCanvas();if(pickResult&&pickResult.hit&&pickResult.pickedMesh){this.setPointerOverSprite(null);this.setPointerOverMesh(pickResult.pickedMesh);if(this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.hasPointerTriggers){if(this._pointerOverMesh.actionManager.hoverCursor){canvas.style.cursor=this._pointerOverMesh.actionManager.hoverCursor}else{canvas.style.cursor=this.hoverCursor}}else{canvas.style.cursor=this.defaultCursor}}else{this.setPointerOverMesh(null);pickResult=this.pickSprite(this._unTranslatedPointerX,this._unTranslatedPointerY,this._spritePredicate,false,this.cameraToUseForPointers);if(pickResult&&pickResult.hit&&pickResult.pickedSprite){this.setPointerOverSprite(pickResult.pickedSprite);if(this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.hoverCursor){canvas.style.cursor=this._pointerOverSprite.actionManager.hoverCursor}else{canvas.style.cursor=this.hoverCursor}}else{this.setPointerOverSprite(null);canvas.style.cursor=this.defaultCursor}}if(this.onPointerMove){this.onPointerMove(evt,pickResult)}if(this.onPointerObservable.hasObservers()){var type=evt.type==="mousewheel"||evt.type==="DOMMouseScroll"?BABYLON.PointerEventTypes.POINTERWHEEL:BABYLON.PointerEventTypes.POINTERMOVE;var pi=new BABYLON.PointerInfo(type,evt,pickResult);this.onPointerObservable.notifyObservers(pi,type)}return this};Scene.prototype.simulatePointerDown=function(pickResult){var evt=new PointerEvent("pointerdown");return this._processPointerDown(pickResult,evt)};Scene.prototype._processPointerDown=function(pickResult,evt){var _this=this;if(pickResult&&pickResult.hit&&pickResult.pickedMesh){this._pickedDownMesh=pickResult.pickedMesh;var actionManager=pickResult.pickedMesh.actionManager;if(actionManager){if(actionManager.hasPickTriggers){actionManager.processTrigger(BABYLON.ActionManager.OnPickDownTrigger,BABYLON.ActionEvent.CreateNew(pickResult.pickedMesh,evt));switch(evt.button){case 0:actionManager.processTrigger(BABYLON.ActionManager.OnLeftPickTrigger,BABYLON.ActionEvent.CreateNew(pickResult.pickedMesh,evt));break;case 1:actionManager.processTrigger(BABYLON.ActionManager.OnCenterPickTrigger,BABYLON.ActionEvent.CreateNew(pickResult.pickedMesh,evt));break;case 2:actionManager.processTrigger(BABYLON.ActionManager.OnRightPickTrigger,BABYLON.ActionEvent.CreateNew(pickResult.pickedMesh,evt));break}}if(actionManager.hasSpecificTrigger(BABYLON.ActionManager.OnLongPressTrigger)){window.setTimeout(function(){var pickResult=_this.pick(_this._unTranslatedPointerX,_this._unTranslatedPointerY,function(mesh){return mesh.isPickable&&mesh.isVisible&&mesh.isReady()&&mesh.actionManager&&mesh.actionManager.hasSpecificTrigger(BABYLON.ActionManager.OnLongPressTrigger)&&mesh==_this._pickedDownMesh},false,_this.cameraToUseForPointers);if(pickResult&&pickResult.hit&&pickResult.pickedMesh){if(_this._totalPointersPressed!==0&&(new Date).getTime()-_this._startingPointerTime>Scene.LongPressDelay&&(Math.abs(_this._startingPointerPosition.x-_this._pointerX)<Scene.DragMovementThreshold&&Math.abs(_this._startingPointerPosition.y-_this._pointerY)<Scene.DragMovementThreshold)){_this._startingPointerTime=0;actionManager.processTrigger(BABYLON.ActionManager.OnLongPressTrigger,BABYLON.ActionEvent.CreateNew(pickResult.pickedMesh,evt))}}},Scene.LongPressDelay)}}}if(this.onPointerDown){this.onPointerDown(evt,pickResult)}if(this.onPointerObservable.hasObservers()){var type=BABYLON.PointerEventTypes.POINTERDOWN;var pi=new BABYLON.PointerInfo(type,evt,pickResult);this.onPointerObservable.notifyObservers(pi,type)}return this};Scene.prototype.simulatePointerUp=function(pickResult){var evt=new PointerEvent("pointerup");var clickInfo=new ClickInfo;clickInfo.singleClick=true;return this._processPointerUp(pickResult,evt,clickInfo)};Scene.prototype._processPointerUp=function(pickResult,evt,clickInfo){if(pickResult&&pickResult&&pickResult.pickedMesh){this._pickedUpMesh=pickResult.pickedMesh;if(this._pickedDownMesh===this._pickedUpMesh){if(this.onPointerPick){this.onPointerPick(evt,pickResult)}if(clickInfo.singleClick&&!clickInfo.ignore&&this.onPointerObservable.hasObservers()){var type=BABYLON.PointerEventTypes.POINTERPICK;var pi=new BABYLON.PointerInfo(type,evt,pickResult);this.onPointerObservable.notifyObservers(pi,type)}}if(pickResult.pickedMesh.actionManager){if(clickInfo.ignore){pickResult.pickedMesh.actionManager.processTrigger(BABYLON.ActionManager.OnPickUpTrigger,BABYLON.ActionEvent.CreateNew(pickResult.pickedMesh,evt))}if(!clickInfo.hasSwiped&&!clickInfo.ignore&&clickInfo.singleClick){pickResult.pickedMesh.actionManager.processTrigger(BABYLON.ActionManager.OnPickTrigger,BABYLON.ActionEvent.CreateNew(pickResult.pickedMesh,evt))}if(clickInfo.doubleClick&&!clickInfo.ignore&&pickResult.pickedMesh.actionManager.hasSpecificTrigger(BABYLON.ActionManager.OnDoublePickTrigger)){pickResult.pickedMesh.actionManager.processTrigger(BABYLON.ActionManager.OnDoublePickTrigger,BABYLON.ActionEvent.CreateNew(pickResult.pickedMesh,evt))}}}if(this._pickedDownMesh&&this._pickedDownMesh.actionManager&&this._pickedDownMesh.actionManager.hasSpecificTrigger(BABYLON.ActionManager.OnPickOutTrigger)&&this._pickedDownMesh!==this._pickedUpMesh){this._pickedDownMesh.actionManager.processTrigger(BABYLON.ActionManager.OnPickOutTrigger,BABYLON.ActionEvent.CreateNew(this._pickedDownMesh,evt))}if(this.onPointerUp){this.onPointerUp(evt,pickResult)}if(this.onPointerObservable.hasObservers()){if(!clickInfo.ignore){if(!clickInfo.hasSwiped){if(clickInfo.singleClick&&this.onPointerObservable.hasSpecificMask(BABYLON.PointerEventTypes.POINTERTAP)){var type=BABYLON.PointerEventTypes.POINTERTAP;var pi=new BABYLON.PointerInfo(type,evt,pickResult);this.onPointerObservable.notifyObservers(pi,type)}if(clickInfo.doubleClick&&this.onPointerObservable.hasSpecificMask(BABYLON.PointerEventTypes.POINTERDOUBLETAP)){var type=BABYLON.PointerEventTypes.POINTERDOUBLETAP;var pi=new BABYLON.PointerInfo(type,evt,pickResult);this.onPointerObservable.notifyObservers(pi,type)}}}else{var type=BABYLON.PointerEventTypes.POINTERUP;var pi=new BABYLON.PointerInfo(type,evt,pickResult);this.onPointerObservable.notifyObservers(pi,type)}}return this};Scene.prototype.attachControl=function(attachUp,attachDown,attachMove){var _this=this;if(attachUp===void 0){attachUp=true}if(attachDown===void 0){attachDown=true}if(attachMove===void 0){attachMove=true}this._initActionManager=function(act,clickInfo){if(!_this._meshPickProceed){var pickResult=_this.pick(_this._unTranslatedPointerX,_this._unTranslatedPointerY,_this.pointerDownPredicate,false,_this.cameraToUseForPointers);_this._currentPickResult=pickResult;if(pickResult){act=pickResult.hit&&pickResult.pickedMesh?pickResult.pickedMesh.actionManager:null}_this._meshPickProceed=true}return act};this._delayedSimpleClick=function(btn,clickInfo,cb){if((new Date).getTime()-_this._previousStartingPointerTime>Scene.DoubleClickDelay&&!_this._doubleClickOccured||btn!==_this._previousButtonPressed){_this._doubleClickOccured=false;clickInfo.singleClick=true;clickInfo.ignore=false;cb(clickInfo,_this._currentPickResult)}};this._initClickEvent=function(obs1,obs2,evt,cb){var clickInfo=new ClickInfo;_this._currentPickResult=null;var act;var checkPicking=obs1.hasSpecificMask(BABYLON.PointerEventTypes.POINTERPICK)||obs2.hasSpecificMask(BABYLON.PointerEventTypes.POINTERPICK)||obs1.hasSpecificMask(BABYLON.PointerEventTypes.POINTERTAP)||obs2.hasSpecificMask(BABYLON.PointerEventTypes.POINTERTAP)||obs1.hasSpecificMask(BABYLON.PointerEventTypes.POINTERDOUBLETAP)||obs2.hasSpecificMask(BABYLON.PointerEventTypes.POINTERDOUBLETAP);if(!checkPicking&&BABYLON.ActionManager&&BABYLON.ActionManager.HasPickTriggers){act=_this._initActionManager(act,clickInfo);if(act)checkPicking=act.hasPickTriggers}if(checkPicking){var btn=evt.button;clickInfo.hasSwiped=Math.abs(_this._startingPointerPosition.x-_this._pointerX)>Scene.DragMovementThreshold||Math.abs(_this._startingPointerPosition.y-_this._pointerY)>Scene.DragMovementThreshold;if(!clickInfo.hasSwiped){var checkSingleClickImmediately=!Scene.ExclusiveDoubleClickMode;if(!checkSingleClickImmediately){checkSingleClickImmediately=!obs1.hasSpecificMask(BABYLON.PointerEventTypes.POINTERDOUBLETAP)&&!obs2.hasSpecificMask(BABYLON.PointerEventTypes.POINTERDOUBLETAP);if(checkSingleClickImmediately&&!BABYLON.ActionManager.HasSpecificTrigger(BABYLON.ActionManager.OnDoublePickTrigger)){act=_this._initActionManager(act,clickInfo);if(act)checkSingleClickImmediately=!act.hasSpecificTrigger(BABYLON.ActionManager.OnDoublePickTrigger)}}if(checkSingleClickImmediately){if((new Date).getTime()-_this._previousStartingPointerTime>Scene.DoubleClickDelay||btn!==_this._previousButtonPressed){clickInfo.singleClick=true;cb(clickInfo,_this._currentPickResult)}}else{_this._previousDelayedSimpleClickTimeout=_this._delayedSimpleClickTimeout;_this._delayedSimpleClickTimeout=window.setTimeout(_this._delayedSimpleClick.bind(_this,btn,clickInfo,cb),Scene.DoubleClickDelay)}var checkDoubleClick=obs1.hasSpecificMask(BABYLON.PointerEventTypes.POINTERDOUBLETAP)||obs2.hasSpecificMask(BABYLON.PointerEventTypes.POINTERDOUBLETAP);if(!checkDoubleClick&&BABYLON.ActionManager.HasSpecificTrigger(BABYLON.ActionManager.OnDoublePickTrigger)){act=_this._initActionManager(act,clickInfo);if(act)checkDoubleClick=act.hasSpecificTrigger(BABYLON.ActionManager.OnDoublePickTrigger)}if(checkDoubleClick){if(btn===_this._previousButtonPressed&&(new Date).getTime()-_this._previousStartingPointerTime<Scene.DoubleClickDelay&&!_this._doubleClickOccured){if(!clickInfo.hasSwiped&&Math.abs(_this._previousStartingPointerPosition.x-_this._startingPointerPosition.x)<Scene.DragMovementThreshold&&Math.abs(_this._previousStartingPointerPosition.y-_this._startingPointerPosition.y)<Scene.DragMovementThreshold){_this._previousStartingPointerTime=0;_this._doubleClickOccured=true;clickInfo.doubleClick=true;clickInfo.ignore=false;if(Scene.ExclusiveDoubleClickMode&&_this._previousDelayedSimpleClickTimeout){clearTimeout(_this._previousDelayedSimpleClickTimeout)}_this._previousDelayedSimpleClickTimeout=_this._delayedSimpleClickTimeout;cb(clickInfo,_this._currentPickResult)}else{_this._doubleClickOccured=false;_this._previousStartingPointerTime=_this._startingPointerTime;_this._previousStartingPointerPosition.x=_this._startingPointerPosition.x;_this._previousStartingPointerPosition.y=_this._startingPointerPosition.y;_this._previousButtonPressed=btn;_this._previousHasSwiped=clickInfo.hasSwiped;if(Scene.ExclusiveDoubleClickMode){if(_this._previousDelayedSimpleClickTimeout){clearTimeout(_this._previousDelayedSimpleClickTimeout)}_this._previousDelayedSimpleClickTimeout=_this._delayedSimpleClickTimeout;cb(clickInfo,_this._previousPickResult)}else{cb(clickInfo,_this._currentPickResult)}}}else{_this._doubleClickOccured=false;_this._previousStartingPointerTime=_this._startingPointerTime;_this._previousStartingPointerPosition.x=_this._startingPointerPosition.x;_this._previousStartingPointerPosition.y=_this._startingPointerPosition.y;_this._previousButtonPressed=btn;_this._previousHasSwiped=clickInfo.hasSwiped}}}}clickInfo.ignore=true;cb(clickInfo,_this._currentPickResult)};this._spritePredicate=function(sprite){return sprite.isPickable&&sprite.actionManager&&sprite.actionManager.hasPointerTriggers};this._onPointerMove=function(evt){_this._updatePointerPosition(evt);if(_this.onPrePointerObservable.hasObservers()){var type=evt.type==="mousewheel"||evt.type==="DOMMouseScroll"?BABYLON.PointerEventTypes.POINTERWHEEL:BABYLON.PointerEventTypes.POINTERMOVE;var pi=new BABYLON.PointerInfoPre(type,evt,_this._unTranslatedPointerX,_this._unTranslatedPointerY);_this.onPrePointerObservable.notifyObservers(pi,type);if(pi.skipOnPointerObservable){return}}if(!_this.cameraToUseForPointers&&!_this.activeCamera){return}if(!_this.pointerMovePredicate){_this.pointerMovePredicate=function(mesh){return mesh.isPickable&&mesh.isVisible&&mesh.isReady()&&mesh.isEnabled()&&(mesh.enablePointerMoveEvents||_this.constantlyUpdateMeshUnderPointer||mesh.actionManager!==null&&mesh.actionManager!==undefined)}}var pickResult=_this.pick(_this._unTranslatedPointerX,_this._unTranslatedPointerY,_this.pointerMovePredicate,false,_this.cameraToUseForPointers);_this._processPointerMove(pickResult,evt)};this._onPointerDown=function(evt){_this._totalPointersPressed++;_this._pickedDownMesh=null;_this._meshPickProceed=false;_this._updatePointerPosition(evt);if(_this.preventDefaultOnPointerDown){evt.preventDefault();canvas.focus()}if(_this.onPrePointerObservable.hasObservers()){var type=BABYLON.PointerEventTypes.POINTERDOWN;var pi=new BABYLON.PointerInfoPre(type,evt,_this._unTranslatedPointerX,_this._unTranslatedPointerY);_this.onPrePointerObservable.notifyObservers(pi,type);if(pi.skipOnPointerObservable){return}}if(!_this.cameraToUseForPointers&&!_this.activeCamera){return}_this._startingPointerPosition.x=_this._pointerX;_this._startingPointerPosition.y=_this._pointerY;_this._startingPointerTime=(new Date).getTime();if(!_this.pointerDownPredicate){_this.pointerDownPredicate=function(mesh){return mesh.isPickable&&mesh.isVisible&&mesh.isReady()&&mesh.isEnabled()}}_this._pickedDownMesh=null;var pickResult=_this.pick(_this._unTranslatedPointerX,_this._unTranslatedPointerY,_this.pointerDownPredicate,false,_this.cameraToUseForPointers);_this._processPointerDown(pickResult,evt);_this._pickedDownSprite=null;if(_this.spriteManagers.length>0){pickResult=_this.pickSprite(_this._unTranslatedPointerX,_this._unTranslatedPointerY,_this._spritePredicate,false,_this.cameraToUseForPointers);if(pickResult&&pickResult.hit&&pickResult.pickedSprite){if(pickResult.pickedSprite.actionManager){_this._pickedDownSprite=pickResult.pickedSprite;switch(evt.button){case 0:pickResult.pickedSprite.actionManager.processTrigger(BABYLON.ActionManager.OnLeftPickTrigger,BABYLON.ActionEvent.CreateNewFromSprite(pickResult.pickedSprite,_this,evt));break;case 1:pickResult.pickedSprite.actionManager.processTrigger(BABYLON.ActionManager.OnCenterPickTrigger,BABYLON.ActionEvent.CreateNewFromSprite(pickResult.pickedSprite,_this,evt));break;case 2:pickResult.pickedSprite.actionManager.processTrigger(BABYLON.ActionManager.OnRightPickTrigger,BABYLON.ActionEvent.CreateNewFromSprite(pickResult.pickedSprite,_this,evt));break}if(pickResult.pickedSprite.actionManager){pickResult.pickedSprite.actionManager.processTrigger(BABYLON.ActionManager.OnPickDownTrigger,BABYLON.ActionEvent.CreateNewFromSprite(pickResult.pickedSprite,_this,evt))}}}}};this._onPointerUp=function(evt){if(_this._totalPointersPressed===0){return}_this._totalPointersPressed--;_this._pickedUpMesh=null;_this._meshPickProceed=false;_this._updatePointerPosition(evt);_this._initClickEvent(_this.onPrePointerObservable,_this.onPointerObservable,evt,function(clickInfo,pickResult){if(_this.onPrePointerObservable.hasObservers()){if(!clickInfo.ignore){if(!clickInfo.hasSwiped){if(clickInfo.singleClick&&_this.onPrePointerObservable.hasSpecificMask(BABYLON.PointerEventTypes.POINTERTAP)){var type=BABYLON.PointerEventTypes.POINTERTAP;var pi=new BABYLON.PointerInfoPre(type,evt,_this._unTranslatedPointerX,_this._unTranslatedPointerY);_this.onPrePointerObservable.notifyObservers(pi,type);if(pi.skipOnPointerObservable){return}}if(clickInfo.doubleClick&&_this.onPrePointerObservable.hasSpecificMask(BABYLON.PointerEventTypes.POINTERDOUBLETAP)){var type=BABYLON.PointerEventTypes.POINTERDOUBLETAP;var pi=new BABYLON.PointerInfoPre(type,evt,_this._unTranslatedPointerX,_this._unTranslatedPointerY);_this.onPrePointerObservable.notifyObservers(pi,type);if(pi.skipOnPointerObservable){return}}}}else{var type=BABYLON.PointerEventTypes.POINTERUP;var pi=new BABYLON.PointerInfoPre(type,evt,_this._unTranslatedPointerX,_this._unTranslatedPointerY);_this.onPrePointerObservable.notifyObservers(pi,type);if(pi.skipOnPointerObservable){return}}}if(!_this.cameraToUseForPointers&&!_this.activeCamera){return}if(!_this.pointerUpPredicate){_this.pointerUpPredicate=function(mesh){return mesh.isPickable&&mesh.isVisible&&mesh.isReady()&&mesh.isEnabled()}}if(!_this._meshPickProceed&&(BABYLON.ActionManager&&BABYLON.ActionManager.HasTriggers||_this.onPointerObservable.hasObservers())){_this._initActionManager(null,clickInfo)}if(!pickResult){pickResult=_this._currentPickResult}_this._processPointerUp(pickResult,evt,clickInfo);if(_this.spriteManagers.length>0){pickResult=_this.pickSprite(_this._unTranslatedPointerX,_this._unTranslatedPointerY,_this._spritePredicate,false,_this.cameraToUseForPointers);if(pickResult.hit&&pickResult.pickedSprite){if(pickResult.pickedSprite.actionManager){pickResult.pickedSprite.actionManager.processTrigger(BABYLON.ActionManager.OnPickUpTrigger,BABYLON.ActionEvent.CreateNewFromSprite(pickResult.pickedSprite,_this,evt));if(pickResult.pickedSprite.actionManager){if(Math.abs(_this._startingPointerPosition.x-_this._pointerX)<Scene.DragMovementThreshold&&Math.abs(_this._startingPointerPosition.y-_this._pointerY)<Scene.DragMovementThreshold){pickResult.pickedSprite.actionManager.processTrigger(BABYLON.ActionManager.OnPickTrigger,BABYLON.ActionEvent.CreateNewFromSprite(pickResult.pickedSprite,_this,evt))}}}}if(_this._pickedDownSprite&&_this._pickedDownSprite.actionManager&&_this._pickedDownSprite!==pickResult.pickedSprite){_this._pickedDownSprite.actionManager.processTrigger(BABYLON.ActionManager.OnPickOutTrigger,BABYLON.ActionEvent.CreateNewFromSprite(_this._pickedDownSprite,_this,evt))}}_this._previousPickResult=_this._currentPickResult})};this._onKeyDown=function(evt){var type=BABYLON.KeyboardEventTypes.KEYDOWN;if(_this.onPreKeyboardObservable.hasObservers()){var pi=new BABYLON.KeyboardInfoPre(type,evt);_this.onPreKeyboardObservable.notifyObservers(pi,type);if(pi.skipOnPointerObservable){return}}if(_this.onKeyboardObservable.hasObservers()){var pi=new BABYLON.KeyboardInfo(type,evt);_this.onKeyboardObservable.notifyObservers(pi,type)}if(_this.actionManager){_this.actionManager.processTrigger(BABYLON.ActionManager.OnKeyDownTrigger,BABYLON.ActionEvent.CreateNewFromScene(_this,evt))}};this._onKeyUp=function(evt){var type=BABYLON.KeyboardEventTypes.KEYUP;if(_this.onPreKeyboardObservable.hasObservers()){var pi=new BABYLON.KeyboardInfoPre(type,evt);_this.onPreKeyboardObservable.notifyObservers(pi,type);if(pi.skipOnPointerObservable){return}}if(_this.onKeyboardObservable.hasObservers()){var pi=new BABYLON.KeyboardInfo(type,evt);_this.onKeyboardObservable.notifyObservers(pi,type)}if(_this.actionManager){_this.actionManager.processTrigger(BABYLON.ActionManager.OnKeyUpTrigger,BABYLON.ActionEvent.CreateNewFromScene(_this,evt))}};var engine=this.getEngine();this._onCanvasFocusObserver=engine.onCanvasFocusObservable.add(function(){canvas.addEventListener("keydown",_this._onKeyDown,false);canvas.addEventListener("keyup",_this._onKeyUp,false)});this._onCanvasBlurObserver=engine.onCanvasBlurObservable.add(function(){canvas.removeEventListener("keydown",_this._onKeyDown);canvas.removeEventListener("keyup",_this._onKeyUp)});var eventPrefix=BABYLON.Tools.GetPointerPrefix();var canvas=this._engine.getRenderingCanvas();if(attachMove){canvas.addEventListener(eventPrefix+"move",this._onPointerMove,false);canvas.addEventListener("mousewheel",this._onPointerMove,false);canvas.addEventListener("DOMMouseScroll",this._onPointerMove,false)}if(attachDown){canvas.addEventListener(eventPrefix+"down",this._onPointerDown,false)}if(attachUp){window.addEventListener(eventPrefix+"up",this._onPointerUp,false)}canvas.tabIndex=1};Scene.prototype.detachControl=function(){var engine=this.getEngine();var eventPrefix=BABYLON.Tools.GetPointerPrefix();var canvas=engine.getRenderingCanvas();canvas.removeEventListener(eventPrefix+"move",this._onPointerMove);canvas.removeEventListener(eventPrefix+"down",this._onPointerDown);window.removeEventListener(eventPrefix+"up",this._onPointerUp);engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver);engine.onCanvasFocusObservable.remove(this._onCanvasFocusObserver);canvas.removeEventListener("mousewheel",this._onPointerMove);canvas.removeEventListener("DOMMouseScroll",this._onPointerMove);canvas.removeEventListener("keydown",this._onKeyDown);canvas.removeEventListener("keyup",this._onKeyUp);this.onKeyboardObservable.clear();this.onPreKeyboardObservable.clear();this.onPointerObservable.clear();this.onPrePointerObservable.clear()};Scene.prototype.isReady=function(){if(this._pendingData.length>0){return false}var index;for(index=0;index<this._geometries.length;index++){var geometry=this._geometries[index];if(geometry.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADING){return false}}for(index=0;index<this.meshes.length;index++){var mesh=this.meshes[index];if(!mesh.isEnabled()){continue}if(!mesh.subMeshes||mesh.subMeshes.length===0){continue}if(!mesh.isReady()){return false}var mat=mesh.material;if(mat){if(!mat.isReady(mesh)){return false}}}return true};Scene.prototype.resetCachedMaterial=function(){this._cachedMaterial=null;this._cachedEffect=null;this._cachedVisibility=null};Scene.prototype.registerBeforeRender=function(func){this.onBeforeRenderObservable.add(func)};Scene.prototype.unregisterBeforeRender=function(func){this.onBeforeRenderObservable.removeCallback(func)};Scene.prototype.registerAfterRender=function(func){this.onAfterRenderObservable.add(func)};Scene.prototype.unregisterAfterRender=function(func){this.onAfterRenderObservable.removeCallback(func)};Scene.prototype._addPendingData=function(data){this._pendingData.push(data)};Scene.prototype._removePendingData=function(data){var index=this._pendingData.indexOf(data);if(index!==-1){this._pendingData.splice(index,1)}};Scene.prototype.getWaitingItemsCount=function(){return this._pendingData.length};Scene.prototype.executeWhenReady=function(func){var _this=this;this.onReadyObservable.add(func);if(this._executeWhenReadyTimeoutId!==-1){return}this._executeWhenReadyTimeoutId=setTimeout(function(){_this._checkIsReady()},150)};Scene.prototype._checkIsReady=function(){var _this=this;if(this.isReady()){this.onReadyObservable.notifyObservers(this);this.onReadyObservable.clear();this._executeWhenReadyTimeoutId=-1;return}this._executeWhenReadyTimeoutId=setTimeout(function(){_this._checkIsReady()},150)};Scene.prototype.beginAnimation=function(target,from,to,loop,speedRatio,onAnimationEnd,animatable){if(speedRatio===void 0){speedRatio=1}if(from>to&&speedRatio>0){speedRatio*=-1}this.stopAnimation(target);if(!animatable){animatable=new BABYLON.Animatable(this,target,from,to,loop,speedRatio,onAnimationEnd)}if(target.animations){animatable.appendAnimations(target,target.animations)}if(target.getAnimatables){var animatables=target.getAnimatables();for(var index=0;index<animatables.length;index++){this.beginAnimation(animatables[index],from,to,loop,speedRatio,onAnimationEnd,animatable)}}animatable.reset();return animatable};Scene.prototype.beginDirectAnimation=function(target,animations,from,to,loop,speedRatio,onAnimationEnd){if(speedRatio===undefined){speedRatio=1}var animatable=new BABYLON.Animatable(this,target,from,to,loop,speedRatio,onAnimationEnd,animations);return animatable};Scene.prototype.getAnimatableByTarget=function(target){for(var index=0;index<this._activeAnimatables.length;index++){if(this._activeAnimatables[index].target===target){return this._activeAnimatables[index]}}return null};Object.defineProperty(Scene.prototype,"Animatables",{get:function(){return this._activeAnimatables},enumerable:true,configurable:true});Scene.prototype.stopAnimation=function(target,animationName){var animatable=this.getAnimatableByTarget(target);if(animatable){animatable.stop(animationName)}};Scene.prototype._animate=function(){if(!this.animationsEnabled||this._activeAnimatables.length===0){return}var now=BABYLON.Tools.Now;if(!this._animationTimeLast){if(this._pendingData.length>0){return}this._animationTimeLast=now}var deltaTime=(now-this._animationTimeLast)*this.animationTimeScale;this._animationTime+=deltaTime;this._animationTimeLast=now;for(var index=0;index<this._activeAnimatables.length;index++){this._activeAnimatables[index]._animate(this._animationTime)}};Scene.prototype._switchToAlternateCameraConfiguration=function(active){this._useAlternateCameraConfiguration=active};Scene.prototype.getViewMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateViewMatrix:this._viewMatrix};Scene.prototype.getProjectionMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateProjectionMatrix:this._projectionMatrix};Scene.prototype.getTransformMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateTransformMatrix:this._transformMatrix};Scene.prototype.setTransformMatrix=function(view,projection){if(this._viewUpdateFlag===view.updateFlag&&this._projectionUpdateFlag===projection.updateFlag){return}this._viewUpdateFlag=view.updateFlag;this._projectionUpdateFlag=projection.updateFlag;this._viewMatrix=view;this._projectionMatrix=projection;this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix);if(!this._frustumPlanes){this._frustumPlanes=BABYLON.Frustum.GetPlanes(this._transformMatrix)}else{BABYLON.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes)}if(this.activeCamera._alternateCamera){var otherCamera=this.activeCamera._alternateCamera;otherCamera.getViewMatrix().multiplyToRef(otherCamera.getProjectionMatrix(),BABYLON.Tmp.Matrix[0]);BABYLON.Frustum.GetRightPlaneToRef(BABYLON.Tmp.Matrix[0],this._frustumPlanes[3])}if(this._sceneUbo.useUbo){this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix);this._sceneUbo.updateMatrix("view",this._viewMatrix);this._sceneUbo.update()}};Scene.prototype._setAlternateTransformMatrix=function(view,projection){if(this._alternateViewUpdateFlag===view.updateFlag&&this._alternateProjectionUpdateFlag===projection.updateFlag){return}this._alternateViewUpdateFlag=view.updateFlag;this._alternateProjectionUpdateFlag=projection.updateFlag;this._alternateViewMatrix=view;this._alternateProjectionMatrix=projection;if(!this._alternateTransformMatrix){this._alternateTransformMatrix=BABYLON.Matrix.Zero()}this._alternateViewMatrix.multiplyToRef(this._alternateProjectionMatrix,this._alternateTransformMatrix);if(!this._alternateSceneUbo){this._createAlternateUbo()}if(this._alternateSceneUbo.useUbo){this._alternateSceneUbo.updateMatrix("viewProjection",this._alternateTransformMatrix);this._alternateSceneUbo.updateMatrix("view",this._alternateViewMatrix);this._alternateSceneUbo.update()}};Scene.prototype.getSceneUniformBuffer=function(){return this._useAlternateCameraConfiguration?this._alternateSceneUbo:this._sceneUbo};Scene.prototype.getUniqueId=function(){var result=Scene._uniqueIdCounter;Scene._uniqueIdCounter++;return result};Scene.prototype.addMesh=function(newMesh){this.meshes.push(newMesh);if(this.collisionCoordinator){this.collisionCoordinator.onMeshAdded(newMesh)}this.onNewMeshAddedObservable.notifyObservers(newMesh)};Scene.prototype.removeMesh=function(toRemove){var index=this.meshes.indexOf(toRemove);if(index!==-1){this.meshes.splice(index,1)}if(this.collisionCoordinator){this.collisionCoordinator.onMeshRemoved(toRemove)}this.onMeshRemovedObservable.notifyObservers(toRemove);return index};Scene.prototype.removeSkeleton=function(toRemove){var index=this.skeletons.indexOf(toRemove);if(index!==-1){this.skeletons.splice(index,1)}return index};Scene.prototype.removeMorphTargetManager=function(toRemove){var index=this.morphTargetManagers.indexOf(toRemove);if(index!==-1){this.morphTargetManagers.splice(index,1)}return index};Scene.prototype.removeLight=function(toRemove){var index=this.lights.indexOf(toRemove);if(index!==-1){this.lights.splice(index,1);this.sortLightsByPriority()}this.onLightRemovedObservable.notifyObservers(toRemove);return index};Scene.prototype.removeCamera=function(toRemove){var index=this.cameras.indexOf(toRemove);if(index!==-1){this.cameras.splice(index,1)}var index2=this.activeCameras.indexOf(toRemove);if(index2!==-1){this.activeCameras.splice(index2,1)}if(this.activeCamera===toRemove){if(this.cameras.length>0){this.activeCamera=this.cameras[0]}else{this.activeCamera=null}}this.onCameraRemovedObservable.notifyObservers(toRemove);return index};Scene.prototype.addLight=function(newLight){this.lights.push(newLight);this.sortLightsByPriority();this.onNewLightAddedObservable.notifyObservers(newLight)};Scene.prototype.sortLightsByPriority=function(){if(this.requireLightSorting){this.lights.sort(BABYLON.Light.compareLightsPriority)}};Scene.prototype.addCamera=function(newCamera){this.cameras.push(newCamera);this.onNewCameraAddedObservable.notifyObservers(newCamera)};Scene.prototype.switchActiveCamera=function(newCamera,attachControl){if(attachControl===void 0){attachControl=true}var canvas=this._engine.getRenderingCanvas();this.activeCamera.detachControl(canvas);this.activeCamera=newCamera;if(attachControl){newCamera.attachControl(canvas)}};Scene.prototype.setActiveCameraByID=function(id){var camera=this.getCameraByID(id);if(camera){this.activeCamera=camera;return camera}return null};Scene.prototype.setActiveCameraByName=function(name){var camera=this.getCameraByName(name);if(camera){this.activeCamera=camera;return camera}return null};Scene.prototype.getMaterialByID=function(id){for(var index=0;index<this.materials.length;index++){if(this.materials[index].id===id){return this.materials[index]}}return null};Scene.prototype.getMaterialByName=function(name){for(var index=0;index<this.materials.length;index++){if(this.materials[index].name===name){return this.materials[index]}}return null};Scene.prototype.getLensFlareSystemByName=function(name){for(var index=0;index<this.lensFlareSystems.length;index++){if(this.lensFlareSystems[index].name===name){return this.lensFlareSystems[index]}}return null};Scene.prototype.getLensFlareSystemByID=function(id){for(var index=0;index<this.lensFlareSystems.length;index++){if(this.lensFlareSystems[index].id===id){return this.lensFlareSystems[index]}}return null};Scene.prototype.getCameraByID=function(id){for(var index=0;index<this.cameras.length;index++){if(this.cameras[index].id===id){return this.cameras[index]}}return null};Scene.prototype.getCameraByUniqueID=function(uniqueId){for(var index=0;index<this.cameras.length;index++){if(this.cameras[index].uniqueId===uniqueId){return this.cameras[index]}}return null};Scene.prototype.getCameraByName=function(name){for(var index=0;index<this.cameras.length;index++){if(this.cameras[index].name===name){return this.cameras[index]}}return null};Scene.prototype.getBoneByID=function(id){for(var skeletonIndex=0;skeletonIndex<this.skeletons.length;skeletonIndex++){var skeleton=this.skeletons[skeletonIndex];for(var boneIndex=0;boneIndex<skeleton.bones.length;boneIndex++){if(skeleton.bones[boneIndex].id===id){return skeleton.bones[boneIndex]}}}return null};Scene.prototype.getBoneByName=function(name){for(var skeletonIndex=0;skeletonIndex<this.skeletons.length;skeletonIndex++){var skeleton=this.skeletons[skeletonIndex];for(var boneIndex=0;boneIndex<skeleton.bones.length;boneIndex++){if(skeleton.bones[boneIndex].name===name){return skeleton.bones[boneIndex]}}}return null};Scene.prototype.getLightByName=function(name){for(var index=0;index<this.lights.length;index++){if(this.lights[index].name===name){return this.lights[index]}}return null};Scene.prototype.getLightByID=function(id){for(var index=0;index<this.lights.length;index++){if(this.lights[index].id===id){return this.lights[index]}}return null};Scene.prototype.getLightByUniqueID=function(uniqueId){for(var index=0;index<this.lights.length;index++){if(this.lights[index].uniqueId===uniqueId){return this.lights[index]}}return null};Scene.prototype.getParticleSystemByID=function(id){for(var index=0;index<this.particleSystems.length;index++){if(this.particleSystems[index].id===id){return this.particleSystems[index]}}return null};Scene.prototype.getGeometryByID=function(id){for(var index=0;index<this._geometries.length;index++){if(this._geometries[index].id===id){return this._geometries[index]}}return null};Scene.prototype.pushGeometry=function(geometry,force){if(!force&&this.getGeometryByID(geometry.id)){return false}this._geometries.push(geometry);if(this.collisionCoordinator){this.collisionCoordinator.onGeometryAdded(geometry)}this.onNewGeometryAddedObservable.notifyObservers(geometry);return true};Scene.prototype.removeGeometry=function(geometry){var index=this._geometries.indexOf(geometry);if(index>-1){this._geometries.splice(index,1);if(this.collisionCoordinator){this.collisionCoordinator.onGeometryDeleted(geometry)}this.onGeometryRemovedObservable.notifyObservers(geometry);return true}return false};Scene.prototype.getGeometries=function(){return this._geometries};Scene.prototype.getMeshByID=function(id){for(var index=0;index<this.meshes.length;index++){if(this.meshes[index].id===id){return this.meshes[index]}}return null};Scene.prototype.getMeshesByID=function(id){return this.meshes.filter(function(m){return m.id===id})};Scene.prototype.getMeshByUniqueID=function(uniqueId){for(var index=0;index<this.meshes.length;index++){if(this.meshes[index].uniqueId===uniqueId){return this.meshes[index]}}return null};Scene.prototype.getLastMeshByID=function(id){for(var index=this.meshes.length-1;index>=0;index--){if(this.meshes[index].id===id){return this.meshes[index]}}return null};Scene.prototype.getLastEntryByID=function(id){var index;for(index=this.meshes.length-1;index>=0;index--){if(this.meshes[index].id===id){return this.meshes[index]}}for(index=this.cameras.length-1;index>=0;index--){if(this.cameras[index].id===id){return this.cameras[index]}}for(index=this.lights.length-1;index>=0;index--){if(this.lights[index].id===id){return this.lights[index]}}return null};Scene.prototype.getNodeByID=function(id){var mesh=this.getMeshByID(id);if(mesh){return mesh}var light=this.getLightByID(id);if(light){return light}var camera=this.getCameraByID(id);if(camera){return camera}var bone=this.getBoneByID(id);return bone};Scene.prototype.getNodeByName=function(name){var mesh=this.getMeshByName(name);if(mesh){return mesh}var light=this.getLightByName(name);if(light){return light}var camera=this.getCameraByName(name);if(camera){return camera}var bone=this.getBoneByName(name);return bone};Scene.prototype.getMeshByName=function(name){for(var index=0;index<this.meshes.length;index++){if(this.meshes[index].name===name){return this.meshes[index]}}return null};Scene.prototype.getSoundByName=function(name){var index;if(BABYLON.AudioEngine){for(index=0;index<this.mainSoundTrack.soundCollection.length;index++){if(this.mainSoundTrack.soundCollection[index].name===name){return this.mainSoundTrack.soundCollection[index]}}for(var sdIndex=0;sdIndex<this.soundTracks.length;sdIndex++){for(index=0;index<this.soundTracks[sdIndex].soundCollection.length;index++){if(this.soundTracks[sdIndex].soundCollection[index].name===name){return this.soundTracks[sdIndex].soundCollection[index]}}}}return null};Scene.prototype.getLastSkeletonByID=function(id){for(var index=this.skeletons.length-1;index>=0;index--){if(this.skeletons[index].id===id){return this.skeletons[index]}}return null};Scene.prototype.getSkeletonById=function(id){for(var index=0;index<this.skeletons.length;index++){if(this.skeletons[index].id===id){return this.skeletons[index]}}return null};Scene.prototype.getSkeletonByName=function(name){for(var index=0;index<this.skeletons.length;index++){if(this.skeletons[index].name===name){return this.skeletons[index]}}return null};Scene.prototype.getMorphTargetManagerById=function(id){for(var index=0;index<this.morphTargetManagers.length;index++){if(this.morphTargetManagers[index].uniqueId===id){return this.morphTargetManagers[index]}}return null};Scene.prototype.isActiveMesh=function(mesh){return this._activeMeshes.indexOf(mesh)!==-1};Scene.prototype.getHighlightLayerByName=function(name){for(var index=0;index<this.highlightLayers.length;index++){if(this.highlightLayers[index].name===name){return this.highlightLayers[index]}}return null};Object.defineProperty(Scene.prototype,"uid",{get:function(){if(!this._uid){this._uid=BABYLON.Tools.RandomId()}return this._uid},enumerable:true,configurable:true});Scene.prototype.addExternalData=function(key,data){if(!this._externalData){this._externalData=new BABYLON.StringDictionary}return this._externalData.add(key,data)};Scene.prototype.getExternalData=function(key){if(!this._externalData){return null}return this._externalData.get(key)};Scene.prototype.getOrAddExternalDataWithFactory=function(key,factory){if(!this._externalData){this._externalData=new BABYLON.StringDictionary}return this._externalData.getOrAddWithFactory(key,factory)};Scene.prototype.removeExternalData=function(key){return this._externalData.remove(key)};Scene.prototype._evaluateSubMesh=function(subMesh,mesh){if(mesh.alwaysSelectAsActiveMesh||mesh.subMeshes.length===1||subMesh.isInFrustum(this._frustumPlanes)){var material=subMesh.getMaterial();if(mesh.showSubMeshesBoundingBox){this.getBoundingBoxRenderer().renderList.push(subMesh.getBoundingInfo().boundingBox)}if(material){if(material.getRenderTargetTextures){if(this._processedMaterials.indexOf(material)===-1){this._processedMaterials.push(material);this._renderTargets.concatWithNoDuplicate(material.getRenderTargetTextures())}}this._activeIndices.addCount(subMesh.indexCount,false);this._renderingManager.dispatch(subMesh)}}};Scene.prototype._isInIntermediateRendering=function(){return this._intermediateRendering};Scene.prototype.freezeActiveMeshes=function(){this._evaluateActiveMeshes();this._activeMeshesFrozen=true;return this};Scene.prototype.unfreezeActiveMeshes=function(){this._activeMeshesFrozen=false;return this};Scene.prototype._evaluateActiveMeshes=function(){if(this._activeMeshesFrozen&&this._activeMeshes.length){return}this.activeCamera._activeMeshes.reset();this._activeMeshes.reset();this._renderingManager.reset();this._processedMaterials.reset();this._activeParticleSystems.reset();this._activeSkeletons.reset();this._softwareSkinnedMeshes.reset();if(this._boundingBoxRenderer){this._boundingBoxRenderer.reset()}var meshes;var len;if(this._selectionOctree){var selection=this._selectionOctree.select(this._frustumPlanes);meshes=selection.data;len=selection.length}else{len=this.meshes.length;meshes=this.meshes}for(var meshIndex=0;meshIndex<len;meshIndex++){var mesh=meshes[meshIndex];if(mesh.isBlocked){continue}this._totalVertices.addCount(mesh.getTotalVertices(),false);if(!mesh.isReady()||!mesh.isEnabled()){continue}mesh.computeWorldMatrix();if(mesh.actionManager&&mesh.actionManager.hasSpecificTriggers([BABYLON.ActionManager.OnIntersectionEnterTrigger,BABYLON.ActionManager.OnIntersectionExitTrigger])){this._meshesForIntersections.pushNoDuplicate(mesh)}var meshLOD=mesh.getLOD(this.activeCamera);if(!meshLOD){continue}mesh._preActivate();if(mesh.alwaysSelectAsActiveMesh||mesh.isVisible&&mesh.visibility>0&&(mesh.layerMask&this.activeCamera.layerMask)!==0&&mesh.isInFrustum(this._frustumPlanes)){this._activeMeshes.push(mesh);this.activeCamera._activeMeshes.push(mesh);mesh._activate(this._renderId);if(meshLOD!==mesh){meshLOD._activate(this._renderId)}this._activeMesh(mesh,meshLOD)}}this._particlesDuration.beginMonitoring();if(this.particlesEnabled){BABYLON.Tools.StartPerformanceCounter("Particles",this.particleSystems.length>0);for(var particleIndex=0;particleIndex<this.particleSystems.length;particleIndex++){var particleSystem=this.particleSystems[particleIndex];if(!particleSystem.isStarted()||!particleSystem.emitter){continue}var emitter=particleSystem.emitter;if(!emitter.position||emitter.isEnabled()){this._activeParticleSystems.push(particleSystem);particleSystem.animate();this._renderingManager.dispatchParticles(particleSystem)}}BABYLON.Tools.EndPerformanceCounter("Particles",this.particleSystems.length>0)}this._particlesDuration.endMonitoring(false)};Scene.prototype._activeMesh=function(sourceMesh,mesh){if(mesh.skeleton&&this.skeletonsEnabled){if(this._activeSkeletons.pushNoDuplicate(mesh.skeleton)){mesh.skeleton.prepare()}if(!mesh.computeBonesUsingShaders){this._softwareSkinnedMeshes.pushNoDuplicate(mesh)}}if(sourceMesh.showBoundingBox||this.forceShowBoundingBoxes){this.getBoundingBoxRenderer().renderList.push(sourceMesh.getBoundingInfo().boundingBox)}if(mesh&&mesh.subMeshes){var len;var subMeshes;if(mesh._submeshesOctree&&mesh.useOctreeForRenderingSelection){var intersections=mesh._submeshesOctree.select(this._frustumPlanes);len=intersections.length;subMeshes=intersections.data}else{subMeshes=mesh.subMeshes;len=subMeshes.length}for(var subIndex=0;subIndex<len;subIndex++){var subMesh=subMeshes[subIndex];this._evaluateSubMesh(subMesh,mesh)}}};Scene.prototype.updateTransformMatrix=function(force){this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(force))};Scene.prototype.updateAlternateTransformMatrix=function(alternateCamera){this._setAlternateTransformMatrix(alternateCamera.getViewMatrix(),alternateCamera.getProjectionMatrix())};Scene.prototype._renderForCamera=function(camera){if(camera&&camera._skipRendering){return}var engine=this._engine;this.activeCamera=camera;if(!this.activeCamera)throw new Error("Active camera not set");BABYLON.Tools.StartPerformanceCounter("Rendering camera "+this.activeCamera.name);engine.setViewport(this.activeCamera.viewport);this.resetCachedMaterial();this._renderId++;this.activeCamera.update();this.updateTransformMatrix();if(camera._alternateCamera){this.updateAlternateTransformMatrix(camera._alternateCamera);this._alternateRendering=true}this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera);this._evaluateActiveMeshesDuration.beginMonitoring();BABYLON.Tools.StartPerformanceCounter("Active meshes evaluation");this._evaluateActiveMeshes();this._evaluateActiveMeshesDuration.endMonitoring(false);BABYLON.Tools.EndPerformanceCounter("Active meshes evaluation");for(var softwareSkinnedMeshIndex=0;softwareSkinnedMeshIndex<this._softwareSkinnedMeshes.length;softwareSkinnedMeshIndex++){var mesh=this._softwareSkinnedMeshes.data[softwareSkinnedMeshIndex];mesh.applySkeleton(mesh.skeleton)}this._renderTargetsDuration.beginMonitoring();var needsRestoreFrameBuffer=false;if(camera.customRenderTargets&&camera.customRenderTargets.length>0){this._renderTargets.concatWithNoDuplicate(camera.customRenderTargets)}if(this.renderTargetsEnabled&&this._renderTargets.length>0){this._intermediateRendering=true;BABYLON.Tools.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(var renderIndex=0;renderIndex<this._renderTargets.length;renderIndex++){var renderTarget=this._renderTargets.data[renderIndex];if(renderTarget._shouldRender()){this._renderId++;var hasSpecialRenderTargetCamera=renderTarget.activeCamera&&renderTarget.activeCamera!==this.activeCamera;renderTarget.render(hasSpecialRenderTargetCamera,this.dumpNextRenderTargets)}}BABYLON.Tools.EndPerformanceCounter("Render targets",this._renderTargets.length>0);this._intermediateRendering=false;this._renderId++;needsRestoreFrameBuffer=true}var stencilState=this._engine.getStencilBuffer();var renderhighlights=false;if(this.renderTargetsEnabled&&this.highlightLayers&&this.highlightLayers.length>0){this._intermediateRendering=true;for(var i=0;i<this.highlightLayers.length;i++){var highlightLayer=this.highlightLayers[i];if(highlightLayer.shouldRender()&&(!highlightLayer.camera||highlightLayer.camera.cameraRigMode===BABYLON.Camera.RIG_MODE_NONE&&camera===highlightLayer.camera||highlightLayer.camera.cameraRigMode!==BABYLON.Camera.RIG_MODE_NONE&&highlightLayer.camera._rigCameras.indexOf(camera)>-1)){renderhighlights=true;var renderTarget=highlightLayer._mainTexture;if(renderTarget._shouldRender()){this._renderId++;renderTarget.render(false,false);needsRestoreFrameBuffer=true}}}this._intermediateRendering=false;this._renderId++}if(needsRestoreFrameBuffer){engine.restoreDefaultFramebuffer()}this._renderTargetsDuration.endMonitoring(false);this.postProcessManager._prepareFrame();this._renderDuration.beginMonitoring();var layerIndex;var layer;if(this.layers.length){engine.setDepthBuffer(false);for(layerIndex=0;layerIndex<this.layers.length;layerIndex++){layer=this.layers[layerIndex];if(layer.isBackground&&(layer.layerMask&this.activeCamera.layerMask)!==0){layer.render()}}engine.setDepthBuffer(true)}BABYLON.Tools.StartPerformanceCounter("Main render");if(renderhighlights){this._engine.setStencilBuffer(true)}this._renderingManager.render(null,null,true,true);if(renderhighlights){this._engine.setStencilBuffer(stencilState)}BABYLON.Tools.EndPerformanceCounter("Main render");if(this._boundingBoxRenderer){this._boundingBoxRenderer.render()}if(this.lensFlaresEnabled){BABYLON.Tools.StartPerformanceCounter("Lens flares",this.lensFlareSystems.length>0);for(var lensFlareSystemIndex=0;lensFlareSystemIndex<this.lensFlareSystems.length;lensFlareSystemIndex++){var lensFlareSystem=this.lensFlareSystems[lensFlareSystemIndex];if((camera.layerMask&lensFlareSystem.layerMask)!==0){lensFlareSystem.render()}}BABYLON.Tools.EndPerformanceCounter("Lens flares",this.lensFlareSystems.length>0)}if(this.layers.length){engine.setDepthBuffer(false);for(layerIndex=0;layerIndex<this.layers.length;layerIndex++){layer=this.layers[layerIndex];if(!layer.isBackground&&(layer.layerMask&this.activeCamera.layerMask)!==0){layer.render()}}engine.setDepthBuffer(true)}if(renderhighlights){engine.setDepthBuffer(false);for(var i=0;i<this.highlightLayers.length;i++){if(this.highlightLayers[i].shouldRender()){this.highlightLayers[i].render()}}engine.setDepthBuffer(true)}this._renderDuration.endMonitoring(false);this.postProcessManager._finalizeFrame(camera.isIntermediate);this._renderTargets.reset();this._alternateRendering=false;this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera);BABYLON.Tools.EndPerformanceCounter("Rendering camera "+this.activeCamera.name)};Scene.prototype._processSubCameras=function(camera){if(camera.cameraRigMode===BABYLON.Camera.RIG_MODE_NONE){this._renderForCamera(camera);return}this.activeCamera.update();for(var index=0;index<camera._rigCameras.length;index++){this._renderForCamera(camera._rigCameras[index])}this.activeCamera=camera;this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix())};Scene.prototype._checkIntersections=function(){for(var index=0;index<this._meshesForIntersections.length;index++){var sourceMesh=this._meshesForIntersections.data[index];for(var actionIndex=0;actionIndex<sourceMesh.actionManager.actions.length;actionIndex++){var action=sourceMesh.actionManager.actions[actionIndex];if(action.trigger===BABYLON.ActionManager.OnIntersectionEnterTrigger||action.trigger===BABYLON.ActionManager.OnIntersectionExitTrigger){var parameters=action.getTriggerParameter();var otherMesh=parameters instanceof BABYLON.AbstractMesh?parameters:parameters.mesh;var areIntersecting=otherMesh.intersectsMesh(sourceMesh,parameters.usePreciseIntersection);var currentIntersectionInProgress=sourceMesh._intersectionsInProgress.indexOf(otherMesh);if(areIntersecting&&currentIntersectionInProgress===-1){if(action.trigger===BABYLON.ActionManager.OnIntersectionEnterTrigger){action._executeCurrent(BABYLON.ActionEvent.CreateNew(sourceMesh,null,otherMesh));sourceMesh._intersectionsInProgress.push(otherMesh)}else if(action.trigger===BABYLON.ActionManager.OnIntersectionExitTrigger){sourceMesh._intersectionsInProgress.push(otherMesh)}}else if(!areIntersecting&&currentIntersectionInProgress>-1){if(action.trigger===BABYLON.ActionManager.OnIntersectionExitTrigger){action._executeCurrent(BABYLON.ActionEvent.CreateNew(sourceMesh,null,otherMesh))}if(!sourceMesh.actionManager.hasSpecificTrigger(BABYLON.ActionManager.OnIntersectionExitTrigger)||action.trigger===BABYLON.ActionManager.OnIntersectionExitTrigger){sourceMesh._intersectionsInProgress.splice(currentIntersectionInProgress,1)}}}}}};Scene.prototype.render=function(){if(this.isDisposed){return}this._interFrameDuration.endMonitoring();this._lastFrameDuration.beginMonitoring();this._particlesDuration.fetchNewFrame();this._spritesDuration.fetchNewFrame();this._activeParticles.fetchNewFrame();this._renderDuration.fetchNewFrame();this._renderTargetsDuration.fetchNewFrame();this._evaluateActiveMeshesDuration.fetchNewFrame();this._totalVertices.fetchNewFrame();this._activeIndices.fetchNewFrame();this._activeBones.fetchNewFrame();this.getEngine().drawCallsPerfCounter.fetchNewFrame();this._meshesForIntersections.reset();this.resetCachedMaterial();BABYLON.Tools.StartPerformanceCounter("Scene rendering");if(this.actionManager){this.actionManager.processTrigger(BABYLON.ActionManager.OnEveryFrameTrigger,null)}if(this.simplificationQueue&&!this.simplificationQueue.running){this.simplificationQueue.executeNext()}if(this._engine.isDeterministicLockStep()){var deltaTime=Math.max(Scene.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Scene.MaxDeltaTime))/1e3;var defaultTimeStep=60/1e3;if(this._physicsEngine){defaultTimeStep=this._physicsEngine.getTimeStep()}var maxSubSteps=this._engine.getLockstepMaxSteps();this._timeAccumulator+=deltaTime;var internalSteps=Math.floor(this._timeAccumulator/defaultTimeStep);internalSteps=Math.min(internalSteps,maxSubSteps);for(this._currentInternalStep=0;this._currentInternalStep<internalSteps;this._currentInternalStep++){this.onBeforeStepObservable.notifyObservers(this);this._animationRatio=defaultTimeStep*(60/1e3);this._animate();if(this._physicsEngine){BABYLON.Tools.StartPerformanceCounter("Physics");this._physicsEngine._step(defaultTimeStep);BABYLON.Tools.EndPerformanceCounter("Physics")}this._timeAccumulator-=defaultTimeStep;this.onAfterStepObservable.notifyObservers(this);this._currentStepId++;if(internalSteps>1&&this._currentInternalStep!=internalSteps-1){this._evaluateActiveMeshes()}}}else{var deltaTime=Math.max(Scene.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Scene.MaxDeltaTime));this._animationRatio=deltaTime*(60/1e3);this._animate();if(this._physicsEngine){BABYLON.Tools.StartPerformanceCounter("Physics");this._physicsEngine._step(deltaTime/1e3);BABYLON.Tools.EndPerformanceCounter("Physics")}}this.onBeforeRenderObservable.notifyObservers(this);this._renderTargetsDuration.beginMonitoring();var engine=this.getEngine();var currentActiveCamera=this.activeCamera;if(this.renderTargetsEnabled){BABYLON.Tools.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);this._intermediateRendering=true;for(var customIndex=0;customIndex<this.customRenderTargets.length;customIndex++){var renderTarget=this.customRenderTargets[customIndex];if(renderTarget._shouldRender()){this._renderId++;this.activeCamera=renderTarget.activeCamera||this.activeCamera;if(!this.activeCamera)throw new Error("Active camera not set");engine.setViewport(this.activeCamera.viewport);this.updateTransformMatrix();renderTarget.render(currentActiveCamera!==this.activeCamera,this.dumpNextRenderTargets)}}BABYLON.Tools.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);this._intermediateRendering=false;this._renderId++}if(this.customRenderTargets.length>0){engine.restoreDefaultFramebuffer()}this._renderTargetsDuration.endMonitoring();this.activeCamera=currentActiveCamera;if(this.proceduralTexturesEnabled){BABYLON.Tools.StartPerformanceCounter("Procedural textures",this._proceduralTextures.length>0);for(var proceduralIndex=0;proceduralIndex<this._proceduralTextures.length;proceduralIndex++){var proceduralTexture=this._proceduralTextures[proceduralIndex];if(proceduralTexture._shouldRender()){proceduralTexture.render()}}BABYLON.Tools.EndPerformanceCounter("Procedural textures",this._proceduralTextures.length>0)}if(this.autoClearDepthAndStencil||this.autoClear){this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}if(this.shadowsEnabled){for(var lightIndex=0;lightIndex<this.lights.length;lightIndex++){var light=this.lights[lightIndex];var shadowGenerator=light.getShadowGenerator();if(light.isEnabled()&&light.shadowEnabled&&shadowGenerator){var shadowMap=shadowGenerator.getShadowMap();if(shadowMap.getScene().textures.indexOf(shadowMap)!==-1){this._renderTargets.push(shadowMap)}}}}if(this._depthRenderer){this._renderTargets.push(this._depthRenderer.getDepthMap())}if(this._geometryBufferRenderer){this._renderTargets.push(this._geometryBufferRenderer.getGBuffer())}if(this._postProcessRenderPipelineManager){this._postProcessRenderPipelineManager.update()}if(this.activeCameras.length>0){for(var cameraIndex=0;cameraIndex<this.activeCameras.length;cameraIndex++){if(cameraIndex>0){this._engine.clear(null,false,true,true)}this._processSubCameras(this.activeCameras[cameraIndex])}}else{if(!this.activeCamera){throw new Error("No camera defined")}this._processSubCameras(this.activeCamera)}this._checkIntersections();if(BABYLON.AudioEngine){this._updateAudioParameters()}if(this.afterRender){this.afterRender()}this.onAfterRenderObservable.notifyObservers(this);for(var index=0;index<this._toBeDisposed.length;index++){this._toBeDisposed.data[index].dispose();this._toBeDisposed[index]=null}this._toBeDisposed.reset();if(this.dumpNextRenderTargets){this.dumpNextRenderTargets=false}BABYLON.Tools.EndPerformanceCounter("Scene rendering");this._interFrameDuration.beginMonitoring();this._lastFrameDuration.endMonitoring();this._totalMeshesCounter.addCount(this.meshes.length,true);this._totalLightsCounter.addCount(this.lights.length,true);this._totalMaterialsCounter.addCount(this.materials.length,true);this._totalTexturesCounter.addCount(this.textures.length,true);this._activeBones.addCount(0,true);this._activeIndices.addCount(0,true);this._activeParticles.addCount(0,true)};Scene.prototype._updateAudioParameters=function(){if(!this.audioEnabled||!this._mainSoundTrack||this._mainSoundTrack.soundCollection.length===0&&this.soundTracks.length===1){return}var listeningCamera;var audioEngine=BABYLON.Engine.audioEngine;if(this.activeCameras.length>0){listeningCamera=this.activeCameras[0]}else{listeningCamera=this.activeCamera}if(listeningCamera&&audioEngine.canUseWebAudio){audioEngine.audioContext.listener.setPosition(listeningCamera.position.x,listeningCamera.position.y,listeningCamera.position.z);if(listeningCamera.rigCameras&&listeningCamera.rigCameras.length>0){listeningCamera=listeningCamera.rigCameras[0]}var mat=BABYLON.Matrix.Invert(listeningCamera.getViewMatrix());var cameraDirection=BABYLON.Vector3.TransformNormal(new BABYLON.Vector3(0,0,-1),mat);cameraDirection.normalize();if(!isNaN(cameraDirection.x)&&!isNaN(cameraDirection.y)&&!isNaN(cameraDirection.z)){audioEngine.audioContext.listener.setOrientation(cameraDirection.x,cameraDirection.y,cameraDirection.z,0,1,0)}var i;for(i=0;i<this.mainSoundTrack.soundCollection.length;i++){var sound=this.mainSoundTrack.soundCollection[i];if(sound.useCustomAttenuation){sound.updateDistanceFromListener()}}for(i=0;i<this.soundTracks.length;i++){for(var j=0;j<this.soundTracks[i].soundCollection.length;j++){sound=this.soundTracks[i].soundCollection[j];if(sound.useCustomAttenuation){sound.updateDistanceFromListener()}}}}};Object.defineProperty(Scene.prototype,"audioEnabled",{get:function(){return this._audioEnabled},set:function(value){this._audioEnabled=value;if(BABYLON.AudioEngine){if(this._audioEnabled){this._enableAudio()}else{this._disableAudio()}}},enumerable:true,configurable:true});Scene.prototype._disableAudio=function(){var i;for(i=0;i<this.mainSoundTrack.soundCollection.length;i++){this.mainSoundTrack.soundCollection[i].pause()}for(i=0;i<this.soundTracks.length;i++){for(var j=0;j<this.soundTracks[i].soundCollection.length;j++){this.soundTracks[i].soundCollection[j].pause()}}};Scene.prototype._enableAudio=function(){var i;for(i=0;i<this.mainSoundTrack.soundCollection.length;i++){if(this.mainSoundTrack.soundCollection[i].isPaused){this.mainSoundTrack.soundCollection[i].play()}}for(i=0;i<this.soundTracks.length;i++){for(var j=0;j<this.soundTracks[i].soundCollection.length;j++){if(this.soundTracks[i].soundCollection[j].isPaused){this.soundTracks[i].soundCollection[j].play()}}}};Object.defineProperty(Scene.prototype,"headphone",{get:function(){return this._headphone},set:function(value){this._headphone=value;if(BABYLON.AudioEngine){if(this._headphone){this._switchAudioModeForHeadphones()}else{this._switchAudioModeForNormalSpeakers()}}},enumerable:true,configurable:true});Scene.prototype._switchAudioModeForHeadphones=function(){this.mainSoundTrack.switchPanningModelToHRTF();for(var i=0;i<this.soundTracks.length;i++){this.soundTracks[i].switchPanningModelToHRTF()}};Scene.prototype._switchAudioModeForNormalSpeakers=function(){this.mainSoundTrack.switchPanningModelToEqualPower();for(var i=0;i<this.soundTracks.length;i++){this.soundTracks[i].switchPanningModelToEqualPower()}};Scene.prototype.enableDepthRenderer=function(){if(this._depthRenderer){return this._depthRenderer}this._depthRenderer=new BABYLON.DepthRenderer(this);return this._depthRenderer};Scene.prototype.disableDepthRenderer=function(){if(!this._depthRenderer){return}this._depthRenderer.dispose();this._depthRenderer=null};Scene.prototype.enableGeometryBufferRenderer=function(ratio){if(ratio===void 0){ratio=1}if(this._geometryBufferRenderer){return this._geometryBufferRenderer}this._geometryBufferRenderer=new BABYLON.GeometryBufferRenderer(this,ratio);if(!this._geometryBufferRenderer.isSupported){this._geometryBufferRenderer=null}return this._geometryBufferRenderer};Scene.prototype.disableGeometryBufferRenderer=function(){if(!this._geometryBufferRenderer){return}this._geometryBufferRenderer.dispose();this._geometryBufferRenderer=null};Scene.prototype.freezeMaterials=function(){for(var i=0;i<this.materials.length;i++){this.materials[i].freeze()}};Scene.prototype.unfreezeMaterials=function(){for(var i=0;i<this.materials.length;i++){this.materials[i].unfreeze()}};Scene.prototype.dispose=function(){this.beforeRender=null;this.afterRender=null;this.skeletons=[];this.morphTargetManagers=[];this.importedMeshesFiles=new Array;this.resetCachedMaterial();if(this._depthRenderer){this._depthRenderer.dispose()}if(this._gamepadManager){this._gamepadManager.dispose();this._gamepadManager=null}if(this.activeCamera){this.activeCamera._activeMeshes.dispose();this.activeCamera=null}this._activeMeshes.dispose();this._renderingManager.dispose();this._processedMaterials.dispose();this._activeParticleSystems.dispose();this._activeSkeletons.dispose();this._softwareSkinnedMeshes.dispose();this._renderTargets.dispose();if(this._boundingBoxRenderer){this._boundingBoxRenderer.dispose()}this._meshesForIntersections.dispose();this._toBeDisposed.dispose();if(this._debugLayer){this._debugLayer.hide()}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBeforeRenderObservable.clear();this.onAfterRenderObservable.clear();this.detachControl();if(BABYLON.AudioEngine){this.disposeSounds()}if(this.VRHelper){this.VRHelper.dispose()}var canvas=this._engine.getRenderingCanvas();var index;for(index=0;index<this.cameras.length;index++){this.cameras[index].detachControl(canvas)}while(this.lights.length){this.lights[0].dispose()}while(this.meshes.length){this.meshes[0].dispose(true)}while(this.cameras.length){this.cameras[0].dispose()}if(this.defaultMaterial){this.defaultMaterial.dispose()}while(this.multiMaterials.length){this.multiMaterials[0].dispose()}while(this.materials.length){this.materials[0].dispose()}while(this.particleSystems.length){this.particleSystems[0].dispose()}while(this.spriteManagers.length){this.spriteManagers[0].dispose()}while(this.postProcesses.length){this.postProcesses[0].dispose()}while(this.layers.length){this.layers[0].dispose()}while(this.highlightLayers.length){this.highlightLayers[0].dispose()}while(this.textures.length){this.textures[0].dispose()}this._sceneUbo.dispose();if(this._alternateSceneUbo){this._alternateSceneUbo.dispose()}this.postProcessManager.dispose();if(this._postProcessRenderPipelineManager){this._postProcessRenderPipelineManager.dispose()}if(this._physicsEngine){this.disablePhysicsEngine()}index=this._engine.scenes.indexOf(this);if(index>-1){this._engine.scenes.splice(index,1)}this._engine.wipeCaches();this._engine=null;this.defaultMaterial=null;this.multiMaterials=null;this.materials=null};Object.defineProperty(Scene.prototype,"isDisposed",{get:function(){return!this._engine},enumerable:true,configurable:true});Scene.prototype.disposeSounds=function(){if(!this._mainSoundTrack){return}this.mainSoundTrack.dispose();for(var scIndex=0;scIndex<this.soundTracks.length;scIndex++){this.soundTracks[scIndex].dispose()}};Scene.prototype.getWorldExtends=function(){var min=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);var max=new BABYLON.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var index=0;index<this.meshes.length;index++){var mesh=this.meshes[index];if(!mesh.subMeshes||mesh.subMeshes.length===0){continue}mesh.computeWorldMatrix(true);var minBox=mesh.getBoundingInfo().boundingBox.minimumWorld;var maxBox=mesh.getBoundingInfo().boundingBox.maximumWorld;BABYLON.Tools.CheckExtends(minBox,min,max);BABYLON.Tools.CheckExtends(maxBox,min,max)}return{min:min,max:max}};Scene.prototype.createOrUpdateSelectionOctree=function(maxCapacity,maxDepth){if(maxCapacity===void 0){maxCapacity=64}if(maxDepth===void 0){maxDepth=2}if(!this._selectionOctree){this._selectionOctree=new BABYLON.Octree(BABYLON.Octree.CreationFuncForMeshes,maxCapacity,maxDepth)}var worldExtends=this.getWorldExtends();this._selectionOctree.update(worldExtends.min,worldExtends.max,this.meshes);return this._selectionOctree};Scene.prototype.createPickingRay=function(x,y,world,camera,cameraViewSpace){if(cameraViewSpace===void 0){cameraViewSpace=false}var engine=this._engine;if(!camera){if(!this.activeCamera)throw new Error("Active camera not set");camera=this.activeCamera}var cameraViewport=camera.viewport;var viewport=cameraViewport.toGlobal(engine.getRenderWidth(),engine.getRenderHeight());x=x/this._engine.getHardwareScalingLevel()-viewport.x;y=y/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-viewport.y-viewport.height);return BABYLON.Ray.CreateNew(x,y,viewport.width,viewport.height,world?world:BABYLON.Matrix.Identity(),cameraViewSpace?BABYLON.Matrix.Identity():camera.getViewMatrix(),camera.getProjectionMatrix())};Scene.prototype.createPickingRayInCameraSpace=function(x,y,camera){if(!BABYLON.PickingInfo){return null}var engine=this._engine;if(!camera){if(!this.activeCamera)throw new Error("Active camera not set");camera=this.activeCamera}var cameraViewport=camera.viewport;var viewport=cameraViewport.toGlobal(engine.getRenderWidth(),engine.getRenderHeight());var identity=BABYLON.Matrix.Identity();x=x/this._engine.getHardwareScalingLevel()-viewport.x;y=y/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-viewport.y-viewport.height);return BABYLON.Ray.CreateNew(x,y,viewport.width,viewport.height,identity,identity,camera.getProjectionMatrix())};Scene.prototype._internalPick=function(rayFunction,predicate,fastCheck){if(!BABYLON.PickingInfo){return null}var pickingInfo=null;for(var meshIndex=0;meshIndex<this.meshes.length;meshIndex++){var mesh=this.meshes[meshIndex];if(predicate){if(!predicate(mesh)){continue}}else if(!mesh.isEnabled()||!mesh.isVisible||!mesh.isPickable){continue}var world=mesh.getWorldMatrix();var ray=rayFunction(world);var result=mesh.intersects(ray,fastCheck);if(!result||!result.hit)continue;if(!fastCheck&&pickingInfo!=null&&result.distance>=pickingInfo.distance)continue;pickingInfo=result;if(fastCheck){break}}return pickingInfo||new BABYLON.PickingInfo};Scene.prototype._internalMultiPick=function(rayFunction,predicate){if(!BABYLON.PickingInfo){return null}var pickingInfos=new Array;for(var meshIndex=0;meshIndex<this.meshes.length;meshIndex++){var mesh=this.meshes[meshIndex];if(predicate){if(!predicate(mesh)){continue}}else if(!mesh.isEnabled()||!mesh.isVisible||!mesh.isPickable){continue}var world=mesh.getWorldMatrix();var ray=rayFunction(world);var result=mesh.intersects(ray,false);if(!result||!result.hit)continue;pickingInfos.push(result)}return pickingInfos};Scene.prototype._internalPickSprites=function(ray,predicate,fastCheck,camera){if(!BABYLON.PickingInfo){return null}var pickingInfo=null;camera=camera||this.activeCamera;if(this.spriteManagers.length>0){for(var spriteIndex=0;spriteIndex<this.spriteManagers.length;spriteIndex++){var spriteManager=this.spriteManagers[spriteIndex];if(!spriteManager.isPickable){continue}var result=spriteManager.intersects(ray,camera,predicate,fastCheck);if(!result||!result.hit)continue;if(!fastCheck&&pickingInfo!=null&&result.distance>=pickingInfo.distance)continue;pickingInfo=result;if(fastCheck){break}}}return pickingInfo||new BABYLON.PickingInfo};Scene.prototype.pick=function(x,y,predicate,fastCheck,camera){var _this=this;return this._internalPick(function(world){return _this.createPickingRay(x,y,world,camera)},predicate,fastCheck)};Scene.prototype.pickSprite=function(x,y,predicate,fastCheck,camera){return this._internalPickSprites(this.createPickingRayInCameraSpace(x,y,camera),predicate,fastCheck,camera)};Scene.prototype.pickWithRay=function(ray,predicate,fastCheck){var _this=this;return this._internalPick(function(world){if(!_this._pickWithRayInverseMatrix){_this._pickWithRayInverseMatrix=BABYLON.Matrix.Identity()}world.invertToRef(_this._pickWithRayInverseMatrix);return BABYLON.Ray.Transform(ray,_this._pickWithRayInverseMatrix)},predicate,fastCheck)};Scene.prototype.multiPick=function(x,y,predicate,camera){var _this=this;return this._internalMultiPick(function(world){return _this.createPickingRay(x,y,world,camera)},predicate)};Scene.prototype.multiPickWithRay=function(ray,predicate){var _this=this;return this._internalMultiPick(function(world){if(!_this._pickWithRayInverseMatrix){_this._pickWithRayInverseMatrix=BABYLON.Matrix.Identity()}world.invertToRef(_this._pickWithRayInverseMatrix);return BABYLON.Ray.Transform(ray,_this._pickWithRayInverseMatrix)},predicate)};Scene.prototype.setPointerOverMesh=function(mesh){if(this._pointerOverMesh===mesh){return}if(this._pointerOverMesh&&this._pointerOverMesh.actionManager){this._pointerOverMesh.actionManager.processTrigger(BABYLON.ActionManager.OnPointerOutTrigger,BABYLON.ActionEvent.CreateNew(this._pointerOverMesh))}this._pointerOverMesh=mesh;if(this._pointerOverMesh&&this._pointerOverMesh.actionManager){this._pointerOverMesh.actionManager.processTrigger(BABYLON.ActionManager.OnPointerOverTrigger,BABYLON.ActionEvent.CreateNew(this._pointerOverMesh))}};Scene.prototype.getPointerOverMesh=function(){return this._pointerOverMesh};Scene.prototype.setPointerOverSprite=function(sprite){if(this._pointerOverSprite===sprite){return}if(this._pointerOverSprite&&this._pointerOverSprite.actionManager){this._pointerOverSprite.actionManager.processTrigger(BABYLON.ActionManager.OnPointerOutTrigger,BABYLON.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this))}this._pointerOverSprite=sprite;if(this._pointerOverSprite&&this._pointerOverSprite.actionManager){this._pointerOverSprite.actionManager.processTrigger(BABYLON.ActionManager.OnPointerOverTrigger,BABYLON.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this))}};Scene.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};Scene.prototype.getPhysicsEngine=function(){return this._physicsEngine};Scene.prototype.enablePhysics=function(gravity,plugin){if(this._physicsEngine){return true}try{this._physicsEngine=new BABYLON.PhysicsEngine(gravity,plugin);return true}catch(e){BABYLON.Tools.Error(e.message);return false}};Scene.prototype.disablePhysicsEngine=function(){if(!this._physicsEngine){return}this._physicsEngine.dispose();this._physicsEngine=undefined};Scene.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==undefined};Scene.prototype.deleteCompoundImpostor=function(compound){var mesh=compound.parts[0].mesh;mesh.physicsImpostor.dispose();mesh.physicsImpostor=null};Scene.prototype._rebuildGeometries=function(){for(var _i=0,_a=this._geometries;_i<_a.length;_i++){var geometry=_a[_i];geometry._rebuild()}for(var _b=0,_c=this.meshes;_b<_c.length;_b++){var mesh=_c[_b];mesh._rebuild()}if(this.postProcessManager){this.postProcessManager._rebuild()}for(var _d=0,_e=this.layers;_d<_e.length;_d++){var layer=_e[_d];layer._rebuild()}for(var _f=0,_g=this.highlightLayers;_f<_g.length;_f++){var highlightLayer=_g[_f];highlightLayer._rebuild()}if(this._boundingBoxRenderer){this._boundingBoxRenderer._rebuild()}for(var _h=0,_j=this.particleSystems;_h<_j.length;_h++){var system=_j[_h];system.rebuild()}if(this._postProcessRenderPipelineManager){this._postProcessRenderPipelineManager._rebuild()}};Scene.prototype._rebuildTextures=function(){for(var _i=0,_a=this.textures;_i<_a.length;_i++){var texture=_a[_i];texture._rebuild()}this.markAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)};Scene.prototype.createDefaultCameraOrLight=function(createArcRotateCamera,replace,attachCameraControls){if(createArcRotateCamera===void 0){createArcRotateCamera=false}if(replace===void 0){replace=false}if(attachCameraControls===void 0){attachCameraControls=false}if(replace){if(this.activeCamera){this.activeCamera.dispose();this.activeCamera=null}if(this.lights){for(var i=0;i<this.lights.length;i++){this.lights[i].dispose()}}}if(this.lights.length===0){new BABYLON.HemisphericLight("default light",BABYLON.Vector3.Up(),this)}if(!this.activeCamera){var worldExtends=this.getWorldExtends();var worldSize=worldExtends.max.subtract(worldExtends.min);var worldCenter=worldExtends.min.add(worldSize.scale(.5));var camera;var radius=worldSize.length()*1.5;if(createArcRotateCamera){var arcRotateCamera=new BABYLON.ArcRotateCamera("default camera",-(Math.PI/2),Math.PI/2,radius,worldCenter,this);arcRotateCamera.lowerRadiusLimit=radius*.01;arcRotateCamera.wheelPrecision=100/radius;camera=arcRotateCamera}else{var freeCamera=new BABYLON.FreeCamera("default camera",new BABYLON.Vector3(worldCenter.x,worldCenter.y,-radius),this);freeCamera.setTarget(worldCenter);camera=freeCamera}camera.minZ=radius*.01;camera.maxZ=radius*100;camera.speed=radius*.2;this.activeCamera=camera;if(attachCameraControls){camera.attachControl(this.getEngine().getRenderingCanvas())}}};Scene.prototype.createDefaultSkybox=function(environmentTexture,pbr,scale,blur){if(pbr===void 0){pbr=false}if(scale===void 0){scale=1e3}if(blur===void 0){blur=0}if(environmentTexture){this.environmentTexture=environmentTexture}if(!this.environmentTexture){BABYLON.Tools.Warn("Can not create default skybox without environment texture.");return null}var hdrSkybox=BABYLON.Mesh.CreateBox("hdrSkyBox",scale,this);if(pbr){var hdrSkyboxMaterial=new BABYLON.PBRMaterial("skyBox",this);hdrSkyboxMaterial.backFaceCulling=false;hdrSkyboxMaterial.reflectionTexture=this.environmentTexture.clone();hdrSkyboxMaterial.reflectionTexture.coordinatesMode=BABYLON.Texture.SKYBOX_MODE;hdrSkyboxMaterial.microSurface=1-blur;hdrSkyboxMaterial.disableLighting=true;hdrSkyboxMaterial.twoSidedLighting=true;hdrSkybox.infiniteDistance=true;hdrSkybox.material=hdrSkyboxMaterial}else{var skyboxMaterial=new BABYLON.StandardMaterial("skyBox",this);skyboxMaterial.backFaceCulling=false;skyboxMaterial.reflectionTexture=this.environmentTexture.clone();skyboxMaterial.reflectionTexture.coordinatesMode=BABYLON.Texture.SKYBOX_MODE;skyboxMaterial.disableLighting=true;hdrSkybox.infiniteDistance=true;hdrSkybox.material=skyboxMaterial}return hdrSkybox};Scene.prototype.createDefaultVRExperience=function(webVROptions){if(webVROptions===void 0){webVROptions={}}this.VRHelper=new BABYLON.VRExperienceHelper(this,webVROptions)};Scene.prototype._getByTags=function(list,tagsQuery,forEach){if(tagsQuery===undefined){return list}var listByTags=[];forEach=forEach||function(item){return};for(var i in list){var item=list[i];if(BABYLON.Tags.MatchesQuery(item,tagsQuery)){listByTags.push(item);forEach(item)}}return listByTags};Scene.prototype.getMeshesByTags=function(tagsQuery,forEach){return this._getByTags(this.meshes,tagsQuery,forEach)};Scene.prototype.getCamerasByTags=function(tagsQuery,forEach){return this._getByTags(this.cameras,tagsQuery,forEach)};Scene.prototype.getLightsByTags=function(tagsQuery,forEach){return this._getByTags(this.lights,tagsQuery,forEach)};Scene.prototype.getMaterialByTags=function(tagsQuery,forEach){return this._getByTags(this.materials,tagsQuery,forEach).concat(this._getByTags(this.multiMaterials,tagsQuery,forEach))};Scene.prototype.setRenderingOrder=function(renderingGroupId,opaqueSortCompareFn,alphaTestSortCompareFn,transparentSortCompareFn){if(opaqueSortCompareFn===void 0){opaqueSortCompareFn=null}if(alphaTestSortCompareFn===void 0){alphaTestSortCompareFn=null}if(transparentSortCompareFn===void 0){transparentSortCompareFn=null}this._renderingManager.setRenderingOrder(renderingGroupId,opaqueSortCompareFn,alphaTestSortCompareFn,transparentSortCompareFn)};Scene.prototype.setRenderingAutoClearDepthStencil=function(renderingGroupId,autoClearDepthStencil,depth,stencil){if(depth===void 0){depth=true}if(stencil===void 0){stencil=true}this._renderingManager.setRenderingAutoClearDepthStencil(renderingGroupId,autoClearDepthStencil,depth,stencil)};Scene.prototype.markAllMaterialsAsDirty=function(flag,predicate){for(var _i=0,_a=this.materials;_i<_a.length;_i++){var material=_a[_i];if(predicate&&!predicate(material)){continue}material.markAsDirty(flag)}};Scene._FOGMODE_NONE=0;Scene._FOGMODE_EXP=1;Scene._FOGMODE_EXP2=2;Scene._FOGMODE_LINEAR=3;Scene._uniqueIdCounter=0;Scene.MinDeltaTime=1;Scene.MaxDeltaTime=1e3;Scene.DragMovementThreshold=10;Scene.LongPressDelay=500;Scene.DoubleClickDelay=300;Scene.ExclusiveDoubleClickMode=false;return Scene}();BABYLON.Scene=Scene})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Buffer=function(){function Buffer(engine,data,updatable,stride,postponeInternalCreation,instanced){if(engine instanceof BABYLON.Mesh){this._engine=engine.getScene().getEngine()}else{this._engine=engine}this._updatable=updatable;this._data=data;this._strideSize=stride;if(!postponeInternalCreation){this.create()}this._instanced=instanced;this._instanceDivisor=instanced?1:0}Buffer.prototype.createVertexBuffer=function(kind,offset,size,stride){return new BABYLON.VertexBuffer(this._engine,this,kind,this._updatable,true,stride?stride:this._strideSize,this._instanced,offset,size)};Buffer.prototype.isUpdatable=function(){return this._updatable};Buffer.prototype.getData=function(){return this._data};Buffer.prototype.getBuffer=function(){return this._buffer};Buffer.prototype.getStrideSize=function(){return this._strideSize};Buffer.prototype.getIsInstanced=function(){return this._instanced};Object.defineProperty(Buffer.prototype,"instanceDivisor",{get:function(){return this._instanceDivisor},set:function(value){this._instanceDivisor=value;if(value==0){this._instanced=false}else{this._instanced=true}},enumerable:true,configurable:true});Buffer.prototype.create=function(data){if(!data&&this._buffer){return}data=data||this._data;if(!this._buffer){if(this._updatable){this._buffer=this._engine.createDynamicVertexBuffer(data);this._data=data}else{this._buffer=this._engine.createVertexBuffer(data)}}else if(this._updatable){this._engine.updateDynamicVertexBuffer(this._buffer,data);this._data=data}};Buffer.prototype._rebuild=function(){this._buffer=null;this.create(this._data)};Buffer.prototype.update=function(data){this.create(data)};Buffer.prototype.updateDirectly=function(data,offset,vertexCount){if(!this._buffer){return}if(this._updatable){this._engine.updateDynamicVertexBuffer(this._buffer,data,offset,vertexCount?vertexCount*this.getStrideSize():undefined);this._data=null}};Buffer.prototype.dispose=function(){if(!this._buffer){return}if(this._engine._releaseBuffer(this._buffer)){this._buffer=null}};return Buffer}();BABYLON.Buffer=Buffer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VertexBuffer=function(){function VertexBuffer(engine,data,kind,updatable,postponeInternalCreation,stride,instanced,offset,size){if(!stride){switch(kind){case VertexBuffer.PositionKind:stride=3;break;case VertexBuffer.NormalKind:stride=3;break;case VertexBuffer.UVKind:case VertexBuffer.UV2Kind:case VertexBuffer.UV3Kind:case VertexBuffer.UV4Kind:case VertexBuffer.UV5Kind:case VertexBuffer.UV6Kind:stride=2;break;case VertexBuffer.TangentKind:case VertexBuffer.ColorKind:stride=4;break;case VertexBuffer.MatricesIndicesKind:case VertexBuffer.MatricesIndicesExtraKind:stride=4;break;case VertexBuffer.MatricesWeightsKind:case VertexBuffer.MatricesWeightsExtraKind:stride=4;break}}if(data instanceof BABYLON.Buffer){if(!stride){stride=data.getStrideSize()}this._buffer=data;this._ownsBuffer=false}else{this._buffer=new BABYLON.Buffer(engine,data,updatable,stride,postponeInternalCreation,instanced);this._ownsBuffer=true}this._stride=stride;this._offset=offset?offset:0;this._size=size?size:stride;this._kind=kind}VertexBuffer.prototype._rebuild=function(){if(!this._buffer){return}this._buffer._rebuild()};VertexBuffer.prototype.getKind=function(){return this._kind};VertexBuffer.prototype.isUpdatable=function(){return this._buffer.isUpdatable()};VertexBuffer.prototype.getData=function(){return this._buffer.getData()};VertexBuffer.prototype.getBuffer=function(){return this._buffer.getBuffer()};VertexBuffer.prototype.getStrideSize=function(){return this._stride};VertexBuffer.prototype.getOffset=function(){return this._offset};VertexBuffer.prototype.getSize=function(){return this._size};VertexBuffer.prototype.getIsInstanced=function(){return this._buffer.getIsInstanced()};VertexBuffer.prototype.getInstanceDivisor=function(){return this._buffer.instanceDivisor};VertexBuffer.prototype.create=function(data){return this._buffer.create(data)};VertexBuffer.prototype.update=function(data){return this._buffer.update(data)};VertexBuffer.prototype.updateDirectly=function(data,offset){return this._buffer.updateDirectly(data,offset)};VertexBuffer.prototype.dispose=function(){if(this._ownsBuffer){this._buffer.dispose()}};Object.defineProperty(VertexBuffer,"PositionKind",{get:function(){return VertexBuffer._PositionKind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"NormalKind",{get:function(){return VertexBuffer._NormalKind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"TangentKind",{get:function(){return VertexBuffer._TangentKind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"UVKind",{get:function(){return VertexBuffer._UVKind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"UV2Kind",{get:function(){return VertexBuffer._UV2Kind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"UV3Kind",{get:function(){return VertexBuffer._UV3Kind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"UV4Kind",{get:function(){return VertexBuffer._UV4Kind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"UV5Kind",{get:function(){return VertexBuffer._UV5Kind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"UV6Kind",{get:function(){return VertexBuffer._UV6Kind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"ColorKind",{get:function(){return VertexBuffer._ColorKind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"MatricesIndicesKind",{get:function(){return VertexBuffer._MatricesIndicesKind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"MatricesWeightsKind",{get:function(){return VertexBuffer._MatricesWeightsKind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"MatricesIndicesExtraKind",{get:function(){return VertexBuffer._MatricesIndicesExtraKind},enumerable:true,configurable:true});Object.defineProperty(VertexBuffer,"MatricesWeightsExtraKind",{get:function(){return VertexBuffer._MatricesWeightsExtraKind},enumerable:true,configurable:true});VertexBuffer._PositionKind="position";VertexBuffer._NormalKind="normal";VertexBuffer._TangentKind="tangent";VertexBuffer._UVKind="uv";VertexBuffer._UV2Kind="uv2";VertexBuffer._UV3Kind="uv3";VertexBuffer._UV4Kind="uv4";VertexBuffer._UV5Kind="uv5";VertexBuffer._UV6Kind="uv6";VertexBuffer._ColorKind="color";VertexBuffer._MatricesIndicesKind="matricesIndices";VertexBuffer._MatricesWeightsKind="matricesWeights";VertexBuffer._MatricesIndicesExtraKind="matricesIndicesExtra";VertexBuffer._MatricesWeightsExtraKind="matricesWeightsExtra";return VertexBuffer}();BABYLON.VertexBuffer=VertexBuffer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var InternalTexture=function(){function InternalTexture(engine,dataSource){this.onLoadedObservable=new BABYLON.Observable;this._dataSource=InternalTexture.DATASOURCE_UNKNOWN;this._references=1;this._engine=engine;this._dataSource=dataSource;this._webGLTexture=engine._createTexture()}Object.defineProperty(InternalTexture.prototype,"dataSource",{get:function(){return this._dataSource},enumerable:true,configurable:true});InternalTexture.prototype.incrementReferences=function(){this._references++};InternalTexture.prototype.updateSize=function(width,height){this.width=width;this.height=height;this._size=width*height;this.baseWidth=width;this.baseHeight=height};InternalTexture.prototype._rebuild=function(){var _this=this;var proxy;this.isReady=false;this._cachedCoordinatesMode=null;this._cachedWrapU=null;this._cachedWrapV=null;this._cachedAnisotropicFilteringLevel=null;switch(this._dataSource){case InternalTexture.DATASOURCE_TEMP:return;case InternalTexture.DATASOURCE_URL:proxy=this._engine.createTexture(this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,function(){_this.isReady=true},null,this._buffer,null,this.format);proxy._swapAndDie(this);return;case InternalTexture.DATASOURCE_RAW:proxy=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression);proxy._swapAndDie(this);this.isReady=true;return;case InternalTexture.DATASOURCE_DYNAMIC:proxy=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode);proxy._swapAndDie(this);return;case InternalTexture.DATASOURCE_RENDERTARGET:var options=new BABYLON.RenderTargetCreationOptions;options.generateDepthBuffer=this._generateDepthBuffer;options.generateMipMaps=this.generateMipMaps;options.generateStencilBuffer=this._generateStencilBuffer;options.samplingMode=this.samplingMode;options.type=this.type;if(this.isCube){proxy=this._engine.createRenderTargetCubeTexture(this.width,options)}else{var size={width:this.width,height:this.height};proxy=this._engine.createRenderTargetTexture(size,options)}proxy._swapAndDie(this);this.isReady=true;return;case InternalTexture.DATASOURCE_CUBE:proxy=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,function(){_this.isReady=true},null,this.format,this._extension);proxy._swapAndDie(this);return;case InternalTexture.DATASOURCE_CUBERAW:proxy=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression);proxy._swapAndDie(this);this.isReady=true;return;case InternalTexture.DATASOURCE_CUBEPREFILTERED:proxy=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,function(proxy){proxy._swapAndDie(_this);_this.isReady=true},null,this.format,this._extension);return}};InternalTexture.prototype._swapAndDie=function(target){target._webGLTexture=this._webGLTexture;if(this._framebuffer){target._framebuffer=this._framebuffer}if(this._depthStencilBuffer){target._depthStencilBuffer=this._depthStencilBuffer}if(this._lodTextureHigh){if(target._lodTextureHigh){target._lodTextureHigh.dispose()}target._lodTextureHigh=this._lodTextureHigh}if(this._lodTextureMid){if(target._lodTextureMid){target._lodTextureMid.dispose()}target._lodTextureMid=this._lodTextureMid}if(this._lodTextureLow){if(target._lodTextureLow){target._lodTextureLow.dispose()}target._lodTextureLow=this._lodTextureLow}var cache=this._engine.getLoadedTexturesCache();var index=cache.indexOf(this);if(index!==-1){cache.splice(index,1)}};InternalTexture.prototype.dispose=function(){if(!this._webGLTexture){return}this._references--;if(this._references===0){this._engine._releaseTexture(this);this._webGLTexture=null}};InternalTexture.DATASOURCE_UNKNOWN=0;InternalTexture.DATASOURCE_URL=1;InternalTexture.DATASOURCE_TEMP=2;InternalTexture.DATASOURCE_RAW=3;InternalTexture.DATASOURCE_DYNAMIC=4;InternalTexture.DATASOURCE_RENDERTARGET=5;InternalTexture.DATASOURCE_MULTIRENDERTARGET=6;InternalTexture.DATASOURCE_CUBE=7;InternalTexture.DATASOURCE_CUBERAW=8;InternalTexture.DATASOURCE_CUBEPREFILTERED=9;return InternalTexture}();BABYLON.InternalTexture=InternalTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BaseTexture=function(){function BaseTexture(scene){this._hasAlpha=false;this.getAlphaFromRGB=false;this.level=1;this.coordinatesIndex=0;this._coordinatesMode=BABYLON.Texture.EXPLICIT_MODE;this.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE;this.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE;this.anisotropicFilteringLevel=BaseTexture.DEFAULT_ANISOTROPIC_FILTERING_LEVEL;this.isCube=false;this.gammaSpace=true;this.invertZ=false;this.lodLevelInAlpha=false;this.lodGenerationOffset=0;this.lodGenerationScale=.8;this.isRenderTarget=false;this.animations=new Array;this.onDisposeObservable=new BABYLON.Observable;this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NONE;this._scene=scene||BABYLON.Engine.LastCreatedScene;this._scene.textures.push(this);this._uid=null}Object.defineProperty(BaseTexture.prototype,"hasAlpha",{get:function(){return this._hasAlpha},set:function(value){if(this._hasAlpha===value){return}this._hasAlpha=value;this._scene.markAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(BaseTexture.prototype,"coordinatesMode",{get:function(){return this._coordinatesMode},set:function(value){if(this._coordinatesMode===value){return}this._coordinatesMode=value;this._scene.markAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(BaseTexture.prototype,"uid",{get:function(){if(!this._uid){this._uid=BABYLON.Tools.RandomId()}return this._uid},enumerable:true,configurable:true});BaseTexture.prototype.toString=function(){return this.name};BaseTexture.prototype.getClassName=function(){return"BaseTexture"};Object.defineProperty(BaseTexture.prototype,"onDispose",{set:function(callback){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(BaseTexture.prototype,"isBlocking",{get:function(){return true},enumerable:true,configurable:true});BaseTexture.prototype.getScene=function(){return this._scene};BaseTexture.prototype.getTextureMatrix=function(){return null};BaseTexture.prototype.getReflectionTextureMatrix=function(){return null};BaseTexture.prototype.getInternalTexture=function(){return this._texture};BaseTexture.prototype.isReadyOrNotBlocking=function(){return!this.isBlocking||this.isReady()};BaseTexture.prototype.isReady=function(){if(this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_NOTLOADED){this.delayLoad();return false}if(this._texture){return this._texture.isReady}return false};BaseTexture.prototype.getSize=function(){if(this._texture.width){return new BABYLON.Size(this._texture.width,this._texture.height)}if(this._texture._size){return new BABYLON.Size(this._texture._size,this._texture._size)}return BABYLON.Size.Zero()};BaseTexture.prototype.getBaseSize=function(){if(!this.isReady()||!this._texture)return BABYLON.Size.Zero();if(this._texture._size){return new BABYLON.Size(this._texture._size,this._texture._size)}return new BABYLON.Size(this._texture.baseWidth,this._texture.baseHeight)};BaseTexture.prototype.scale=function(ratio){};Object.defineProperty(BaseTexture.prototype,"canRescale",{get:function(){return false},enumerable:true,configurable:true});BaseTexture.prototype._getFromCache=function(url,noMipmap,sampling){var texturesCache=this._scene.getEngine().getLoadedTexturesCache();for(var index=0;index<texturesCache.length;index++){var texturesCacheEntry=texturesCache[index];if(texturesCacheEntry.url===url&&texturesCacheEntry.generateMipMaps===!noMipmap){if(!sampling||sampling===texturesCacheEntry.samplingMode){texturesCacheEntry.incrementReferences();return texturesCacheEntry}}}return null};BaseTexture.prototype._rebuild=function(){};BaseTexture.prototype.delayLoad=function(){};BaseTexture.prototype.clone=function(){return null};Object.defineProperty(BaseTexture.prototype,"textureType",{get:function(){if(!this._texture){return BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}return this._texture.type!==undefined?this._texture.type:BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT},enumerable:true,configurable:true});Object.defineProperty(BaseTexture.prototype,"textureFormat",{get:function(){if(!this._texture){return BABYLON.Engine.TEXTUREFORMAT_RGBA}return this._texture.format!==undefined?this._texture.format:BABYLON.Engine.TEXTUREFORMAT_RGBA},enumerable:true,configurable:true});BaseTexture.prototype.readPixels=function(faceIndex){if(faceIndex===void 0){faceIndex=0}if(!this._texture){return null}var size=this.getSize();var engine=this.getScene().getEngine();if(this._texture.isCube){return engine._readTexturePixels(this._texture,size.width,size.height,faceIndex)}return engine._readTexturePixels(this._texture,size.width,size.height,-1)};BaseTexture.prototype.releaseInternalTexture=function(){if(this._texture){this._texture.dispose();this._texture=null}};Object.defineProperty(BaseTexture.prototype,"sphericalPolynomial",{get:function(){if(!this._texture||!BABYLON.Internals.CubeMapToSphericalPolynomialTools||!this.isReady()){return null}if(!this._texture._sphericalPolynomial){this._texture._sphericalPolynomial=BABYLON.Internals.CubeMapToSphericalPolynomialTools.ConvertCubeMapTextureToSphericalPolynomial(this)}return this._texture._sphericalPolynomial},set:function(value){if(this._texture){this._texture._sphericalPolynomial=value}},enumerable:true,configurable:true});Object.defineProperty(BaseTexture.prototype,"_lodTextureHigh",{get:function(){if(this._texture){return this._texture._lodTextureHigh}return null},enumerable:true,configurable:true});Object.defineProperty(BaseTexture.prototype,"_lodTextureMid",{get:function(){if(this._texture){return this._texture._lodTextureMid}return null},enumerable:true,configurable:true});Object.defineProperty(BaseTexture.prototype,"_lodTextureLow",{get:function(){if(this._texture){return this._texture._lodTextureLow}return null},enumerable:true,configurable:true});BaseTexture.prototype.dispose=function(){this.getScene().stopAnimation(this);this._scene._removePendingData(this);var index=this._scene.textures.indexOf(this);if(index>=0){this._scene.textures.splice(index,1)}if(this._texture===undefined){return}this.releaseInternalTexture();this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()};BaseTexture.prototype.serialize=function(){if(!this.name){return null}var serializationObject=BABYLON.SerializationHelper.Serialize(this);BABYLON.Animation.AppendSerializedAnimations(this,serializationObject);return serializationObject};BaseTexture.WhenAllReady=function(textures,callback){var numRemaining=textures.length;if(numRemaining===0){callback();return}var _loop_1=function(){texture=textures[i];if(texture.isReady()){if(--numRemaining===0){callback()}}else{onLoadObservable=texture.onLoadObservable;var onLoadCallback_1=function(){onLoadObservable.removeCallback(onLoadCallback_1);if(--numRemaining===0){callback()}};onLoadObservable.add(onLoadCallback_1)}};var texture,onLoadObservable;for(var i=0;i<textures.length;i++){_loop_1()}};BaseTexture.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;__decorate([BABYLON.serialize()],BaseTexture.prototype,"name",void 0);__decorate([BABYLON.serialize("hasAlpha")],BaseTexture.prototype,"_hasAlpha",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"getAlphaFromRGB",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"level",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"coordinatesIndex",void 0);__decorate([BABYLON.serialize("coordinatesMode")],BaseTexture.prototype,"_coordinatesMode",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"wrapU",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"wrapV",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"anisotropicFilteringLevel",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"isCube",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"gammaSpace",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"invertZ",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"lodLevelInAlpha",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"lodGenerationOffset",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"lodGenerationScale",void 0);__decorate([BABYLON.serialize()],BaseTexture.prototype,"isRenderTarget",void 0);return BaseTexture}();BABYLON.BaseTexture=BaseTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Texture=function(_super){__extends(Texture,_super);function Texture(url,scene,noMipmap,invertY,samplingMode,onLoad,onError,buffer,deleteBuffer,format){if(noMipmap===void 0){noMipmap=false}if(invertY===void 0){invertY=true}if(samplingMode===void 0){samplingMode=Texture.TRILINEAR_SAMPLINGMODE}if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}if(buffer===void 0){buffer=null}if(deleteBuffer===void 0){deleteBuffer=false}var _this=_super.call(this,scene)||this;_this.uOffset=0;_this.vOffset=0;_this.uScale=1;_this.vScale=1;_this.uAng=0;_this.vAng=0;_this.wAng=0;_this._isBlocking=true;_this.name=url;_this.url=url;_this._noMipmap=noMipmap;_this._invertY=invertY;_this._samplingMode=samplingMode;_this._buffer=buffer;_this._deleteBuffer=deleteBuffer;_this._format=format;scene=_this.getScene();scene.getEngine().onBeforeTextureInitObservable.notifyObservers(_this);var load=function(){if(_this._onLoadObservable&&_this._onLoadObservable.hasObservers()){_this.onLoadObservable.notifyObservers(_this)}if(onLoad){onLoad()}if(!_this.isBlocking){scene.resetCachedMaterial()}};if(!_this.url){_this._delayedOnLoad=load;_this._delayedOnError=onError;return _this}_this._texture=_this._getFromCache(_this.url,noMipmap,samplingMode);if(!_this._texture){if(!scene.useDelayedTextureLoading){_this._texture=scene.getEngine().createTexture(_this.url,noMipmap,invertY,scene,_this._samplingMode,load,onError,_this._buffer,null,_this._format);if(deleteBuffer){delete _this._buffer}}else{_this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED;_this._delayedOnLoad=load;_this._delayedOnError=onError}}else{if(_this._texture.isReady){BABYLON.Tools.SetImmediate(function(){return load()})}else{_this._texture.onLoadedObservable.add(load)}}return _this}Object.defineProperty(Texture.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:true,configurable:true});Object.defineProperty(Texture.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(value){this._isBlocking=value},enumerable:true,configurable:true});Object.defineProperty(Texture.prototype,"samplingMode",{get:function(){return this._samplingMode},enumerable:true,configurable:true});Texture.prototype.updateURL=function(url){this.url=url;this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED;this.delayLoad()};Texture.prototype.delayLoad=function(){var _this=this;if(this.delayLoadState!==BABYLON.Engine.DELAYLOADSTATE_NOTLOADED){return}this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED;this._texture=this._getFromCache(this.url,this._noMipmap,this._samplingMode);if(!this._texture){this._texture=this.getScene().getEngine().createTexture(this.url,this._noMipmap,this._invertY,this.getScene(),this._samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format);if(this._deleteBuffer){delete this._buffer}}else{if(this._texture.isReady){BABYLON.Tools.SetImmediate(function(){return _this._delayedOnLoad()})}else{this._texture.onLoadedObservable.add(this._delayedOnLoad)}}};Texture.prototype.updateSamplingMode=function(samplingMode){if(!this._texture){return}this._samplingMode=samplingMode;this.getScene().getEngine().updateTextureSamplingMode(samplingMode,this._texture)};Texture.prototype._prepareRowForTextureGeneration=function(x,y,z,t){x*=this.uScale;y*=this.vScale;x-=.5*this.uScale;y-=.5*this.vScale;z-=.5;BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(x,y,z,this._rowGenerationMatrix,t);t.x+=.5*this.uScale+this.uOffset;t.y+=.5*this.vScale+this.vOffset;t.z+=.5};Texture.prototype.getTextureMatrix=function(){var _this=this;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng){return this._cachedTextureMatrix}this._cachedUOffset=this.uOffset;this._cachedVOffset=this.vOffset;this._cachedUScale=this.uScale;this._cachedVScale=this.vScale;this._cachedUAng=this.uAng;this._cachedVAng=this.vAng;this._cachedWAng=this.wAng;if(!this._cachedTextureMatrix){this._cachedTextureMatrix=BABYLON.Matrix.Zero();this._rowGenerationMatrix=new BABYLON.Matrix;this._t0=BABYLON.Vector3.Zero();this._t1=BABYLON.Vector3.Zero();this._t2=BABYLON.Vector3.Zero()}BABYLON.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix);this._prepareRowForTextureGeneration(0,0,0,this._t0);this._prepareRowForTextureGeneration(1,0,0,this._t1);this._prepareRowForTextureGeneration(0,1,0,this._t2);this._t1.subtractInPlace(this._t0);this._t2.subtractInPlace(this._t0);BABYLON.Matrix.IdentityToRef(this._cachedTextureMatrix);this._cachedTextureMatrix.m[0]=this._t1.x;this._cachedTextureMatrix.m[1]=this._t1.y;this._cachedTextureMatrix.m[2]=this._t1.z;this._cachedTextureMatrix.m[4]=this._t2.x;this._cachedTextureMatrix.m[5]=this._t2.y;this._cachedTextureMatrix.m[6]=this._t2.z;this._cachedTextureMatrix.m[8]=this._t0.x;this._cachedTextureMatrix.m[9]=this._t0.y;this._cachedTextureMatrix.m[10]=this._t0.z;this.getScene().markAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag,function(mat){return mat.hasTexture(_this)});return this._cachedTextureMatrix};Texture.prototype.getReflectionTextureMatrix=function(){var _this=this;var scene=this.getScene();if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode){if(this.coordinatesMode===Texture.PROJECTION_MODE){if(this._cachedProjectionMatrixId===scene.getProjectionMatrix().updateFlag){return this._cachedTextureMatrix}}else{return this._cachedTextureMatrix}}if(!this._cachedTextureMatrix){this._cachedTextureMatrix=BABYLON.Matrix.Zero();this._projectionModeMatrix=BABYLON.Matrix.Zero()}this._cachedUOffset=this.uOffset;this._cachedVOffset=this.vOffset;this._cachedUScale=this.uScale;this._cachedVScale=this.vScale;this._cachedCoordinatesMode=this.coordinatesMode;switch(this.coordinatesMode){case Texture.PLANAR_MODE:BABYLON.Matrix.IdentityToRef(this._cachedTextureMatrix);this._cachedTextureMatrix[0]=this.uScale;this._cachedTextureMatrix[5]=this.vScale;this._cachedTextureMatrix[12]=this.uOffset;this._cachedTextureMatrix[13]=this.vOffset;break;case Texture.PROJECTION_MODE:BABYLON.Matrix.IdentityToRef(this._projectionModeMatrix);this._projectionModeMatrix.m[0]=.5;this._projectionModeMatrix.m[5]=-.5;this._projectionModeMatrix.m[10]=0;this._projectionModeMatrix.m[12]=.5;this._projectionModeMatrix.m[13]=.5;this._projectionModeMatrix.m[14]=1;this._projectionModeMatrix.m[15]=1;var projectionMatrix=scene.getProjectionMatrix();this._cachedProjectionMatrixId=projectionMatrix.updateFlag;projectionMatrix.multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:BABYLON.Matrix.IdentityToRef(this._cachedTextureMatrix);break}scene.markAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag,function(mat){return mat.getActiveTextures().indexOf(_this)!==-1});return this._cachedTextureMatrix};Texture.prototype.clone=function(){var _this=this;return BABYLON.SerializationHelper.Clone(function(){return new Texture(_this._texture.url,_this.getScene(),_this._noMipmap,_this._invertY,_this._samplingMode)},this)};Object.defineProperty(Texture.prototype,"onLoadObservable",{get:function(){if(!this._onLoadObservable){this._onLoadObservable=new BABYLON.Observable}return this._onLoadObservable},enumerable:true,configurable:true});Texture.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);if(typeof this._buffer==="string"&&this._buffer.substr(0,5)==="data:"){serializationObject.base64String=this._buffer;serializationObject.name=serializationObject.name.replace("data:","")}return serializationObject};Texture.prototype.getClassName=function(){return"Texture"};Texture.prototype.dispose=function(){_super.prototype.dispose.call(this);if(this.onLoadObservable){this.onLoadObservable.clear();this._onLoadObservable=null}this._delayedOnLoad=null;this._delayedOnError=null};Texture.CreateFromBase64String=function(data,name,scene,noMipmap,invertY,samplingMode,onLoad,onError,format){if(samplingMode===void 0){samplingMode=Texture.TRILINEAR_SAMPLINGMODE}if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}if(format===void 0){format=BABYLON.Engine.TEXTUREFORMAT_RGBA}return new Texture("data:"+name,scene,noMipmap,invertY,samplingMode,onLoad,onError,data,false,format)};Texture.Parse=function(parsedTexture,scene,rootUrl){if(parsedTexture.customType){var customTexture=BABYLON.Tools.Instantiate(parsedTexture.customType);var parsedCustomTexture=customTexture.Parse(parsedTexture,scene,rootUrl);if(parsedTexture.samplingMode&&parsedCustomTexture.updateSamplingMode&&parsedCustomTexture._samplingMode){if(parsedCustomTexture._samplingMode!==parsedTexture.samplingMode){parsedCustomTexture.updateSamplingMode(parsedTexture.samplingMode)}}return parsedCustomTexture}if(parsedTexture.isCube){return BABYLON.CubeTexture.Parse(parsedTexture,scene,rootUrl)}if(!parsedTexture.name&&!parsedTexture.isRenderTarget){return null}var texture=BABYLON.SerializationHelper.Parse(function(){if(parsedTexture.mirrorPlane){var mirrorTexture=new BABYLON.MirrorTexture(parsedTexture.name,parsedTexture.renderTargetSize,scene);mirrorTexture._waitingRenderList=parsedTexture.renderList;mirrorTexture.mirrorPlane=BABYLON.Plane.FromArray(parsedTexture.mirrorPlane);return mirrorTexture}else if(parsedTexture.isRenderTarget){var renderTargetTexture=new BABYLON.RenderTargetTexture(parsedTexture.name,parsedTexture.renderTargetSize,scene);renderTargetTexture._waitingRenderList=parsedTexture.renderList;return renderTargetTexture}else{var texture;if(parsedTexture.base64String){texture=Texture.CreateFromBase64String(parsedTexture.base64String,parsedTexture.name,scene)}else{texture=new Texture(rootUrl+parsedTexture.name,scene)}return texture}},parsedTexture,scene);if(parsedTexture.samplingMode){var sampling=parsedTexture.samplingMode;if(texture._samplingMode!==sampling){texture.updateSamplingMode(sampling)}}if(parsedTexture.animations){for(var animationIndex=0;animationIndex<parsedTexture.animations.length;animationIndex++){var parsedAnimation=parsedTexture.animations[animationIndex];texture.animations.push(BABYLON.Animation.Parse(parsedAnimation))}}return texture};Texture.LoadFromDataString=function(name,buffer,scene,deleteBuffer,noMipmap,invertY,samplingMode,onLoad,onError,format){if(deleteBuffer===void 0){deleteBuffer=false}if(noMipmap===void 0){noMipmap=false}if(invertY===void 0){invertY=true}if(samplingMode===void 0){samplingMode=Texture.TRILINEAR_SAMPLINGMODE}if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}if(format===void 0){format=BABYLON.Engine.TEXTUREFORMAT_RGBA}if(name.substr(0,5)!=="data:"){name="data:"+name}return new Texture(name,scene,noMipmap,invertY,samplingMode,onLoad,onError,buffer,deleteBuffer,format)};Texture.NEAREST_SAMPLINGMODE=1;Texture.NEAREST_NEAREST_MIPLINEAR=1;Texture.BILINEAR_SAMPLINGMODE=2;Texture.LINEAR_LINEAR_MIPNEAREST=2;Texture.TRILINEAR_SAMPLINGMODE=3;Texture.LINEAR_LINEAR_MIPLINEAR=3;Texture.NEAREST_NEAREST_MIPNEAREST=4;Texture.NEAREST_LINEAR_MIPNEAREST=5;Texture.NEAREST_LINEAR_MIPLINEAR=6;Texture.NEAREST_LINEAR=7;Texture.NEAREST_NEAREST=8;Texture.LINEAR_NEAREST_MIPNEAREST=9;Texture.LINEAR_NEAREST_MIPLINEAR=10;Texture.LINEAR_LINEAR=11;Texture.LINEAR_NEAREST=12;Texture.EXPLICIT_MODE=0;Texture.SPHERICAL_MODE=1;Texture.PLANAR_MODE=2;Texture.CUBIC_MODE=3;Texture.PROJECTION_MODE=4;Texture.SKYBOX_MODE=5;Texture.INVCUBIC_MODE=6;Texture.EQUIRECTANGULAR_MODE=7;Texture.FIXED_EQUIRECTANGULAR_MODE=8;Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;Texture.CLAMP_ADDRESSMODE=0;Texture.WRAP_ADDRESSMODE=1;Texture.MIRROR_ADDRESSMODE=2;__decorate([BABYLON.serialize()],Texture.prototype,"url",void 0);__decorate([BABYLON.serialize()],Texture.prototype,"uOffset",void 0);__decorate([BABYLON.serialize()],Texture.prototype,"vOffset",void 0);__decorate([BABYLON.serialize()],Texture.prototype,"uScale",void 0);__decorate([BABYLON.serialize()],Texture.prototype,"vScale",void 0);__decorate([BABYLON.serialize()],Texture.prototype,"uAng",void 0);__decorate([BABYLON.serialize()],Texture.prototype,"vAng",void 0);__decorate([BABYLON.serialize()],Texture.prototype,"wAng",void 0);__decorate([BABYLON.serialize()],Texture.prototype,"isBlocking",null);return Texture}(BABYLON.BaseTexture);BABYLON.Texture=Texture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var _InstancesBatch=function(){function _InstancesBatch(){this.mustReturn=false;this.visibleInstances=new Array;this.renderSelf=new Array}return _InstancesBatch}();BABYLON._InstancesBatch=_InstancesBatch;var Mesh=function(_super){__extends(Mesh,_super);function Mesh(name,scene,parent,source,doNotCloneChildren,clonePhysicsImpostor){if(parent===void 0){parent=null}if(clonePhysicsImpostor===void 0){clonePhysicsImpostor=true}var _this=_super.call(this,name,scene)||this;_this.onBeforeRenderObservable=new BABYLON.Observable;_this.onAfterRenderObservable=new BABYLON.Observable;_this.onBeforeDrawObservable=new BABYLON.Observable;_this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NONE;_this.instances=new Array;_this._LODLevels=new Array;_this._visibleInstances={};_this._renderIdForInstances=new Array;_this._batchCache=new _InstancesBatch;_this._instancesBufferSize=32*16*4;_this._originalBuilderSideOrientation=Mesh._DEFAULTSIDE;_this.overrideMaterialSideOrientation=null;_this._areNormalsFrozen=false;_this._source=null;if(source){_this._source=source;if(source._geometry){source._geometry.applyToMesh(_this)}BABYLON.Tools.DeepCopy(source,_this,["name","material","skeleton","instances","parent","uniqueId"],["_poseMatrix"]);_this.parent=source.parent;_this.setPivotMatrix(source.getPivotMatrix());_this.id=name+"."+source.id;_this.material=source.material;var index;if(!doNotCloneChildren){for(index=0;index<scene.meshes.length;index++){var mesh=scene.meshes[index];if(mesh.parent===source){mesh.clone(name+"."+mesh.name,_this,doNotCloneChildren)}}}var physicsEngine=_this.getScene().getPhysicsEngine();if(clonePhysicsImpostor&&physicsEngine){var impostor=physicsEngine.getImpostorForPhysicsObject(source);if(impostor){_this.physicsImpostor=impostor.clone(_this)}}for(index=0;index<scene.particleSystems.length;index++){var system=scene.particleSystems[index];if(system.emitter===source){system.clone(system.name,_this)}}_this.computeWorldMatrix(true)}if(parent!==null){_this.parent=parent}return _this}Object.defineProperty(Mesh,"FRONTSIDE",{get:function(){return Mesh._FRONTSIDE},enumerable:true,configurable:true});Object.defineProperty(Mesh,"BACKSIDE",{get:function(){return Mesh._BACKSIDE},enumerable:true,configurable:true});Object.defineProperty(Mesh,"DOUBLESIDE",{get:function(){return Mesh._DOUBLESIDE},enumerable:true,configurable:true});Object.defineProperty(Mesh,"DEFAULTSIDE",{get:function(){return Mesh._DEFAULTSIDE},enumerable:true,configurable:true});Object.defineProperty(Mesh,"NO_CAP",{get:function(){return Mesh._NO_CAP},enumerable:true,configurable:true});Object.defineProperty(Mesh,"CAP_START",{get:function(){return Mesh._CAP_START},enumerable:true,configurable:true});Object.defineProperty(Mesh,"CAP_END",{get:function(){return Mesh._CAP_END},enumerable:true,configurable:true});Object.defineProperty(Mesh,"CAP_ALL",{get:function(){return Mesh._CAP_ALL},enumerable:true,configurable:true});Object.defineProperty(Mesh.prototype,"onBeforeDraw",{set:function(callback){if(this._onBeforeDrawObserver){this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver)}this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Mesh.prototype,"morphTargetManager",{get:function(){return this._morphTargetManager},set:function(value){if(this._morphTargetManager===value){return}this._morphTargetManager=value;this._syncGeometryWithMorphTargetManager()},enumerable:true,configurable:true});Object.defineProperty(Mesh.prototype,"source",{get:function(){return this._source},enumerable:true,configurable:true});Mesh.prototype.getClassName=function(){return"Mesh"};Mesh.prototype.toString=function(fullDetails){var ret=_super.prototype.toString.call(this,fullDetails);ret+=", n vertices: "+this.getTotalVertices();ret+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE");if(this.animations){for(var i=0;i<this.animations.length;i++){ret+=", animation[0]: "+this.animations[i].toString(fullDetails)}}if(fullDetails){ret+=", flat shading: "+(this._geometry?this.getVerticesData(BABYLON.VertexBuffer.PositionKind).length/3===this.getIndices().length?"YES":"NO":"UNKNOWN")}return ret};Object.defineProperty(Mesh.prototype,"hasLODLevels",{get:function(){return this._LODLevels.length>0},enumerable:true,configurable:true});Mesh.prototype._sortLODLevels=function(){this._LODLevels.sort(function(a,b){if(a.distance<b.distance){return 1}if(a.distance>b.distance){return-1}return 0})};Mesh.prototype.addLODLevel=function(distance,mesh){if(mesh&&mesh._masterMesh){BABYLON.Tools.Warn("You cannot use a mesh as LOD level twice");return this}var level=new BABYLON.Internals.MeshLODLevel(distance,mesh);this._LODLevels.push(level);if(mesh){mesh._masterMesh=this}this._sortLODLevels();return this};Mesh.prototype.getLODLevelAtDistance=function(distance){for(var index=0;index<this._LODLevels.length;index++){var level=this._LODLevels[index];if(level.distance===distance){return level.mesh}}return null};Mesh.prototype.removeLODLevel=function(mesh){for(var index=0;index<this._LODLevels.length;index++){if(this._LODLevels[index].mesh===mesh){this._LODLevels.splice(index,1);if(mesh){mesh._masterMesh=null}}}this._sortLODLevels();return this};Mesh.prototype.getLOD=function(camera,boundingSphere){if(!this._LODLevels||this._LODLevels.length===0){return this}var distanceToCamera=(boundingSphere?boundingSphere:this.getBoundingInfo().boundingSphere).centerWorld.subtract(camera.globalPosition).length();if(this._LODLevels[this._LODLevels.length-1].distance>distanceToCamera){if(this.onLODLevelSelection){this.onLODLevelSelection(distanceToCamera,this,this._LODLevels[this._LODLevels.length-1].mesh)}return this}for(var index=0;index<this._LODLevels.length;index++){var level=this._LODLevels[index];if(level.distance<distanceToCamera){if(level.mesh){level.mesh._preActivate();level.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}if(this.onLODLevelSelection){this.onLODLevelSelection(distanceToCamera,this,level.mesh)}return level.mesh}}if(this.onLODLevelSelection){this.onLODLevelSelection(distanceToCamera,this,this)}return this};Object.defineProperty(Mesh.prototype,"geometry",{get:function(){return this._geometry},enumerable:true,configurable:true});Mesh.prototype.getTotalVertices=function(){if(!this._geometry){return 0}return this._geometry.getTotalVertices()};Mesh.prototype.getVerticesData=function(kind,copyWhenShared,forceCopy){if(!this._geometry){return null}return this._geometry.getVerticesData(kind,copyWhenShared,forceCopy)};Mesh.prototype.getVertexBuffer=function(kind){if(!this._geometry){return undefined}return this._geometry.getVertexBuffer(kind)};Mesh.prototype.isVerticesDataPresent=function(kind){if(!this._geometry){if(this._delayInfo){return this._delayInfo.indexOf(kind)!==-1}return false}return this._geometry.isVerticesDataPresent(kind)};Mesh.prototype.getVerticesDataKinds=function(){if(!this._geometry){var result=new Array;if(this._delayInfo){this._delayInfo.forEach(function(kind,index,array){result.push(kind)})}return result}return this._geometry.getVerticesDataKinds()};Mesh.prototype.getTotalIndices=function(){if(!this._geometry){return 0}return this._geometry.getTotalIndices()};Mesh.prototype.getIndices=function(copyWhenShared){if(!this._geometry){return[]}return this._geometry.getIndices(copyWhenShared)};Object.defineProperty(Mesh.prototype,"isBlocked",{get:function(){return this._masterMesh!==null&&this._masterMesh!==undefined},enumerable:true,configurable:true});Mesh.prototype.isReady=function(){if(this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADING){return false}return _super.prototype.isReady.call(this)};Object.defineProperty(Mesh.prototype,"areNormalsFrozen",{get:function(){return this._areNormalsFrozen},enumerable:true,configurable:true});Mesh.prototype.freezeNormals=function(){this._areNormalsFrozen=true;return this};Mesh.prototype.unfreezeNormals=function(){this._areNormalsFrozen=false;return this};Object.defineProperty(Mesh.prototype,"overridenInstanceCount",{set:function(count){this._overridenInstanceCount=count},enumerable:true,configurable:true});Mesh.prototype._preActivate=function(){var sceneRenderId=this.getScene().getRenderId();if(this._preActivateId===sceneRenderId){return this}this._preActivateId=sceneRenderId;this._visibleInstances=null;return this};Mesh.prototype._preActivateForIntermediateRendering=function(renderId){if(this._visibleInstances){this._visibleInstances.intermediateDefaultRenderId=renderId}return this};Mesh.prototype._registerInstanceForRenderId=function(instance,renderId){if(!this._visibleInstances){this._visibleInstances={};this._visibleInstances.defaultRenderId=renderId;this._visibleInstances.selfDefaultRenderId=this._renderId}if(!this._visibleInstances[renderId]){this._visibleInstances[renderId]=new Array}this._visibleInstances[renderId].push(instance);return this};Mesh.prototype.refreshBoundingInfo=function(){if(this._boundingInfo.isLocked){return this}var data=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(data){var extend=BABYLON.Tools.ExtractMinAndMax(data,0,this.getTotalVertices());this._boundingInfo=new BABYLON.BoundingInfo(extend.minimum,extend.maximum)}if(this.subMeshes){for(var index=0;index<this.subMeshes.length;index++){this.subMeshes[index].refreshBoundingInfo()}}this._updateBoundingInfo();return this};Mesh.prototype._createGlobalSubMesh=function(force){var totalVertices=this.getTotalVertices();if(!totalVertices||!this.getIndices()){return null}if(this.subMeshes&&this.subMeshes.length>0){var totalIndices=this.getIndices().length;var needToRecreate=false;if(force){needToRecreate=true}else{for(var _i=0,_a=this.subMeshes;_i<_a.length;_i++){var submesh=_a[_i];if(submesh.indexStart+submesh.indexCount>=totalIndices){needToRecreate=true;break}if(submesh.verticesStart+submesh.verticesCount>=totalVertices){needToRecreate=true;break}}}if(!needToRecreate){return this.subMeshes[0]}}this.releaseSubMeshes();return new BABYLON.SubMesh(0,0,totalVertices,0,this.getTotalIndices(),this)};Mesh.prototype.subdivide=function(count){if(count<1){return}var totalIndices=this.getTotalIndices();var subdivisionSize=totalIndices/count|0;var offset=0;while(subdivisionSize%3!==0){subdivisionSize++}this.releaseSubMeshes();for(var index=0;index<count;index++){if(offset>=totalIndices){break}BABYLON.SubMesh.CreateFromIndices(0,offset,Math.min(subdivisionSize,totalIndices-offset),this);offset+=subdivisionSize}this.synchronizeInstances()};Mesh.prototype.setVerticesData=function(kind,data,updatable,stride){if(!this._geometry){var vertexData=new BABYLON.VertexData;vertexData.set(data,kind);var scene=this.getScene();new BABYLON.Geometry(BABYLON.Geometry.RandomId(),scene,vertexData,updatable,this)}else{this._geometry.setVerticesData(kind,data,updatable,stride)}return this};Mesh.prototype.markVerticesDataAsUpdatable=function(kind,updatable){if(updatable===void 0){updatable=true}if(this.getVertexBuffer(kind).isUpdatable()===updatable){return}this.setVerticesData(kind,this.getVerticesData(kind),updatable)};Mesh.prototype.setVerticesBuffer=function(buffer){if(!this._geometry){var scene=this.getScene();new BABYLON.Geometry(BABYLON.Geometry.RandomId(),scene).applyToMesh(this)}this._geometry.setVerticesBuffer(buffer);return this};Mesh.prototype.updateVerticesData=function(kind,data,updateExtends,makeItUnique){if(!this._geometry){return this}if(!makeItUnique){this._geometry.updateVerticesData(kind,data,updateExtends)}else{this.makeGeometryUnique();this.updateVerticesData(kind,data,updateExtends,false)}return this};Mesh.prototype.updateMeshPositions=function(positionFunction,computeNormals){if(computeNormals===void 0){computeNormals=true}var positions=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);positionFunction(positions);this.updateVerticesData(BABYLON.VertexBuffer.PositionKind,positions,false,false);if(computeNormals){var indices=this.getIndices();var normals=this.getVerticesData(BABYLON.VertexBuffer.NormalKind);BABYLON.VertexData.ComputeNormals(positions,indices,normals);this.updateVerticesData(BABYLON.VertexBuffer.NormalKind,normals,false,false)}return this};Mesh.prototype.makeGeometryUnique=function(){if(!this._geometry){return this}var oldGeometry=this._geometry;var geometry=this._geometry.copy(BABYLON.Geometry.RandomId());oldGeometry.releaseForMesh(this,true);geometry.applyToMesh(this);return this};Mesh.prototype.setIndices=function(indices,totalVertices,updatable){if(!this._geometry){var vertexData=new BABYLON.VertexData;vertexData.indices=indices;var scene=this.getScene();new BABYLON.Geometry(BABYLON.Geometry.RandomId(),scene,vertexData,updatable,this)}else{this._geometry.setIndices(indices,totalVertices,updatable)}return this};Mesh.prototype.updateIndices=function(indices,offset){if(!this._geometry){return this}this._geometry.updateIndices(indices,offset);return this};Mesh.prototype.toLeftHanded=function(){if(!this._geometry){return this}this._geometry.toLeftHanded();return this};Mesh.prototype._bind=function(subMesh,effect,fillMode){var engine=this.getScene().getEngine();var indexToBind;if(this._unIndexed){indexToBind=null}else{switch(fillMode){case BABYLON.Material.PointFillMode:indexToBind=null;break;case BABYLON.Material.WireFrameFillMode:indexToBind=subMesh.getLinesIndexBuffer(this.getIndices(),engine);break;default:case BABYLON.Material.TriangleFillMode:indexToBind=this._unIndexed?null:this._geometry.getIndexBuffer();break}}this._geometry._bind(effect,indexToBind);return this};Mesh.prototype._draw=function(subMesh,fillMode,instancesCount,alternate){if(alternate===void 0){alternate=false}if(!this._geometry||!this._geometry.getVertexBuffers()||!this._geometry.getIndexBuffer()){return this}this.onBeforeDrawObservable.notifyObservers(this);var scene=this.getScene();var engine=scene.getEngine();switch(fillMode){case BABYLON.Material.PointFillMode:engine.drawPointClouds(subMesh.verticesStart,subMesh.verticesCount,instancesCount);break;case BABYLON.Material.WireFrameFillMode:if(this._unIndexed){engine.drawUnIndexed(false,subMesh.verticesStart,subMesh.verticesCount,instancesCount)}else{engine.draw(false,0,subMesh.linesIndexCount,instancesCount)}break;default:if(this._unIndexed){engine.drawUnIndexed(true,subMesh.verticesStart,subMesh.verticesCount,instancesCount)}else{engine.draw(true,subMesh.indexStart,subMesh.indexCount,instancesCount)}}if(scene._isAlternateRenderingEnabled&&!alternate){var effect=subMesh.effect||this._effectiveMaterial.getEffect();scene._switchToAlternateCameraConfiguration(true);this._effectiveMaterial.bindView(effect);this._effectiveMaterial.bindViewProjection(effect);engine.setViewport(scene.activeCamera._alternateCamera.viewport);this._draw(subMesh,fillMode,instancesCount,true);engine.setViewport(scene.activeCamera.viewport);scene._switchToAlternateCameraConfiguration(false);this._effectiveMaterial.bindView(effect);this._effectiveMaterial.bindViewProjection(effect)}return this};Mesh.prototype.registerBeforeRender=function(func){this.onBeforeRenderObservable.add(func);return this};Mesh.prototype.unregisterBeforeRender=function(func){this.onBeforeRenderObservable.removeCallback(func);return this};Mesh.prototype.registerAfterRender=function(func){this.onAfterRenderObservable.add(func);return this};Mesh.prototype.unregisterAfterRender=function(func){this.onAfterRenderObservable.removeCallback(func);return this};Mesh.prototype._getInstancesRenderList=function(subMeshId){var scene=this.getScene();this._batchCache.mustReturn=false;this._batchCache.renderSelf[subMeshId]=this.isEnabled()&&this.isVisible;this._batchCache.visibleInstances[subMeshId]=null;if(this._visibleInstances){var currentRenderId=scene.getRenderId();var defaultRenderId=scene._isInIntermediateRendering()?this._visibleInstances.intermediateDefaultRenderId:this._visibleInstances.defaultRenderId;this._batchCache.visibleInstances[subMeshId]=this._visibleInstances[currentRenderId];var selfRenderId=this._renderId;if(!this._batchCache.visibleInstances[subMeshId]&&defaultRenderId){this._batchCache.visibleInstances[subMeshId]=this._visibleInstances[defaultRenderId];currentRenderId=Math.max(defaultRenderId,currentRenderId);selfRenderId=Math.max(this._visibleInstances.selfDefaultRenderId,currentRenderId)}if(this._batchCache.visibleInstances[subMeshId]&&this._batchCache.visibleInstances[subMeshId].length){if(this._renderIdForInstances[subMeshId]===currentRenderId){this._batchCache.mustReturn=true;return this._batchCache}if(currentRenderId!==selfRenderId){this._batchCache.renderSelf[subMeshId]=false}}this._renderIdForInstances[subMeshId]=currentRenderId}return this._batchCache};Mesh.prototype._renderWithInstances=function(subMesh,fillMode,batch,effect,engine){var visibleInstances=batch.visibleInstances[subMesh._id];var matricesCount=visibleInstances.length+1;var bufferSize=matricesCount*16*4;var currentInstancesBufferSize=this._instancesBufferSize;var instancesBuffer=this._instancesBuffer;while(this._instancesBufferSize<bufferSize){this._instancesBufferSize*=2}if(!this._instancesData||currentInstancesBufferSize!=this._instancesBufferSize){this._instancesData=new Float32Array(this._instancesBufferSize/4)}var offset=0;var instancesCount=0;var world=this.getWorldMatrix();if(batch.renderSelf[subMesh._id]){world.copyToArray(this._instancesData,offset);offset+=16;instancesCount++}if(visibleInstances){for(var instanceIndex=0;instanceIndex<visibleInstances.length;instanceIndex++){var instance=visibleInstances[instanceIndex];instance.getWorldMatrix().copyToArray(this._instancesData,offset);offset+=16;instancesCount++}}if(!instancesBuffer||currentInstancesBufferSize!=this._instancesBufferSize){if(instancesBuffer){instancesBuffer.dispose()}instancesBuffer=new BABYLON.Buffer(engine,this._instancesData,true,16,false,true);this._instancesBuffer=instancesBuffer;this.setVerticesBuffer(instancesBuffer.createVertexBuffer("world0",0,4));this.setVerticesBuffer(instancesBuffer.createVertexBuffer("world1",4,4));this.setVerticesBuffer(instancesBuffer.createVertexBuffer("world2",8,4));this.setVerticesBuffer(instancesBuffer.createVertexBuffer("world3",12,4))}else{instancesBuffer.updateDirectly(this._instancesData,0,instancesCount)}this._bind(subMesh,effect,fillMode);this._draw(subMesh,fillMode,instancesCount);engine.unbindInstanceAttributes();return this};Mesh.prototype._processRendering=function(subMesh,effect,fillMode,batch,hardwareInstancedRendering,onBeforeDraw,effectiveMaterial){var scene=this.getScene();var engine=scene.getEngine();if(hardwareInstancedRendering){this._renderWithInstances(subMesh,fillMode,batch,effect,engine)}else{if(batch.renderSelf[subMesh._id]){if(onBeforeDraw){onBeforeDraw(false,this.getWorldMatrix(),effectiveMaterial)}this._draw(subMesh,fillMode,this._overridenInstanceCount)}if(batch.visibleInstances[subMesh._id]){for(var instanceIndex=0;instanceIndex<batch.visibleInstances[subMesh._id].length;instanceIndex++){var instance=batch.visibleInstances[subMesh._id][instanceIndex];var world=instance.getWorldMatrix();if(onBeforeDraw){onBeforeDraw(true,world,effectiveMaterial)}this._draw(subMesh,fillMode)}}}return this};Mesh.prototype.render=function(subMesh,enableAlphaMode){this.checkOcclusionQuery();if(this._isOccluded){return this}var scene=this.getScene();var batch=this._getInstancesRenderList(subMesh._id);if(batch.mustReturn){return this}if(!this._geometry||!this._geometry.getVertexBuffers()||!this._geometry.getIndexBuffer()){return this}this.onBeforeRenderObservable.notifyObservers(this);var engine=scene.getEngine();var hardwareInstancedRendering=engine.getCaps().instancedArrays&&batch.visibleInstances[subMesh._id]!==null&&batch.visibleInstances[subMesh._id]!==undefined;this._effectiveMaterial=subMesh.getMaterial();if(!this._effectiveMaterial){return this}if(this._effectiveMaterial.storeEffectOnSubMeshes){if(!this._effectiveMaterial.isReadyForSubMesh(this,subMesh,hardwareInstancedRendering)){return this}}else if(!this._effectiveMaterial.isReady(this,hardwareInstancedRendering)){return this}if(enableAlphaMode){engine.setAlphaMode(this._effectiveMaterial.alphaMode)}var savedDepthWrite=engine.getDepthWrite();if(this.renderOutline){engine.setDepthWrite(false);scene.getOutlineRenderer().render(subMesh,batch);engine.setDepthWrite(savedDepthWrite)}var effect;if(this._effectiveMaterial.storeEffectOnSubMeshes){effect=subMesh.effect}else{effect=this._effectiveMaterial.getEffect()}var reverse=this._effectiveMaterial._preBind(effect,this.overrideMaterialSideOrientation);if(this._effectiveMaterial.forceDepthWrite){engine.setDepthWrite(true)}var fillMode=scene.forcePointsCloud?BABYLON.Material.PointFillMode:scene.forceWireframe?BABYLON.Material.WireFrameFillMode:this._effectiveMaterial.fillMode;if(!hardwareInstancedRendering){this._bind(subMesh,effect,fillMode)}var world=this.getWorldMatrix();if(this._effectiveMaterial.storeEffectOnSubMeshes){this._effectiveMaterial.bindForSubMesh(world,this,subMesh)}else{this._effectiveMaterial.bind(world,this)}if(!this._effectiveMaterial.backFaceCulling&&this._effectiveMaterial.separateCullingPass){engine.setState(true,this._effectiveMaterial.zOffset,false,!reverse);this._processRendering(subMesh,effect,fillMode,batch,hardwareInstancedRendering,this._onBeforeDraw,this._effectiveMaterial);engine.setState(true,this._effectiveMaterial.zOffset,false,reverse)}this._processRendering(subMesh,effect,fillMode,batch,hardwareInstancedRendering,this._onBeforeDraw,this._effectiveMaterial);this._effectiveMaterial.unbind();if(this.renderOutline&&savedDepthWrite){engine.setDepthWrite(true);engine.setColorWrite(false);scene.getOutlineRenderer().render(subMesh,batch);engine.setColorWrite(true)}if(this.renderOverlay){var currentMode=engine.getAlphaMode();engine.setAlphaMode(BABYLON.Engine.ALPHA_COMBINE);scene.getOutlineRenderer().render(subMesh,batch,true);engine.setAlphaMode(currentMode)}this.onAfterRenderObservable.notifyObservers(this);return this};Mesh.prototype._onBeforeDraw=function(isInstance,world,effectiveMaterial){if(isInstance){effectiveMaterial.bindOnlyWorldMatrix(world)}return this};Mesh.prototype.getEmittedParticleSystems=function(){var results=new Array;for(var index=0;index<this.getScene().particleSystems.length;index++){var particleSystem=this.getScene().particleSystems[index];if(particleSystem.emitter===this){results.push(particleSystem)}}return results};Mesh.prototype.getHierarchyEmittedParticleSystems=function(){var results=new Array;var descendants=this.getDescendants();descendants.push(this);for(var index=0;index<this.getScene().particleSystems.length;index++){var particleSystem=this.getScene().particleSystems[index];var emitter=particleSystem.emitter;if(emitter.position&&descendants.indexOf(emitter)!==-1){results.push(particleSystem)}}return results};Mesh.prototype._checkDelayState=function(){var scene=this.getScene();if(this._geometry){this._geometry.load(scene)}else if(this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_NOTLOADED){this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADING;this._queueLoad(this,scene)}return this};Mesh.prototype._queueLoad=function(mesh,scene){var _this=this;scene._addPendingData(mesh);var getBinaryData=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;BABYLON.Tools.LoadFile(this.delayLoadingFile,function(data){if(data instanceof ArrayBuffer){_this._delayLoadingFunction(data,_this)}else{_this._delayLoadingFunction(JSON.parse(data),_this)}_this.instances.forEach(function(instance){instance._syncSubMeshes()});_this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED;scene._removePendingData(_this)},function(){},scene.database,getBinaryData);return this};Mesh.prototype.isInFrustum=function(frustumPlanes){if(this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADING){return false}if(!_super.prototype.isInFrustum.call(this,frustumPlanes)){return false}this._checkDelayState();return true};Mesh.prototype.setMaterialByID=function(id){var materials=this.getScene().materials;var index;for(index=materials.length-1;index>-1;index--){if(materials[index].id===id){this.material=materials[index];return this}}var multiMaterials=this.getScene().multiMaterials;for(index=multiMaterials.length-1;index>-1;index--){if(multiMaterials[index].id===id){this.material=multiMaterials[index];return this}}return this};Mesh.prototype.getAnimatables=function(){var results=new Array;if(this.material){results.push(this.material)}if(this.skeleton){results.push(this.skeleton)}return results};Mesh.prototype.bakeTransformIntoVertices=function(transform){if(!this.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind)){return this}var submeshes=this.subMeshes.splice(0);this._resetPointsArrayCache();var data=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);var temp=new Array;var index;for(index=0;index<data.length;index+=3){BABYLON.Vector3.TransformCoordinates(BABYLON.Vector3.FromArray(data,index),transform).toArray(temp,index)}this.setVerticesData(BABYLON.VertexBuffer.PositionKind,temp,this.getVertexBuffer(BABYLON.VertexBuffer.PositionKind).isUpdatable());if(!this.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){return this}data=this.getVerticesData(BABYLON.VertexBuffer.NormalKind);temp=[];for(index=0;index<data.length;index+=3){BABYLON.Vector3.TransformNormal(BABYLON.Vector3.FromArray(data,index),transform).normalize().toArray(temp,index)}this.setVerticesData(BABYLON.VertexBuffer.NormalKind,temp,this.getVertexBuffer(BABYLON.VertexBuffer.NormalKind).isUpdatable());if(transform.m[0]*transform.m[5]*transform.m[10]<0){this.flipFaces()}this.releaseSubMeshes();this.subMeshes=submeshes;return this};Mesh.prototype.bakeCurrentTransformIntoVertices=function(){this.bakeTransformIntoVertices(this.computeWorldMatrix(true));this.scaling.copyFromFloats(1,1,1);this.position.copyFromFloats(0,0,0);this.rotation.copyFromFloats(0,0,0);if(this.rotationQuaternion){this.rotationQuaternion=BABYLON.Quaternion.Identity()}this._worldMatrix=BABYLON.Matrix.Identity();return this};Object.defineProperty(Mesh.prototype,"_positions",{get:function(){if(this._geometry){return this._geometry._positions}return null},enumerable:true,configurable:true});Mesh.prototype._resetPointsArrayCache=function(){if(this._geometry){this._geometry._resetPointsArrayCache()}return this};Mesh.prototype._generatePointsArray=function(){if(this._geometry){return this._geometry._generatePointsArray()}return false};Mesh.prototype.clone=function(name,newParent,doNotCloneChildren,clonePhysicsImpostor){if(clonePhysicsImpostor===void 0){clonePhysicsImpostor=true}return new Mesh(name,this.getScene(),newParent,this,doNotCloneChildren,clonePhysicsImpostor)};Mesh.prototype.dispose=function(doNotRecurse){var _this=this;this.morphTargetManager=undefined;if(this._geometry){this._geometry.releaseForMesh(this,true)}var meshes=this.getScene().meshes;meshes.forEach(function(mesh){if(mesh._source&&mesh._source===_this){mesh._source=null}});this._source=null;if(this._instancesBuffer){this._instancesBuffer.dispose();this._instancesBuffer=null}while(this.instances.length){this.instances[0].dispose()}var highlightLayers=this.getScene().highlightLayers;for(var i=0;i<highlightLayers.length;i++){var highlightLayer=highlightLayers[i];if(highlightLayer){highlightLayer.removeMesh(this);highlightLayer.removeExcludedMesh(this)}}_super.prototype.dispose.call(this,doNotRecurse)};Mesh.prototype.applyDisplacementMap=function(url,minHeight,maxHeight,onSuccess,uvOffset,uvScale){var _this=this;var scene=this.getScene();var onload=function(img){var canvas=document.createElement("canvas");var context=canvas.getContext("2d");var heightMapWidth=img.width;var heightMapHeight=img.height;canvas.width=heightMapWidth;canvas.height=heightMapHeight;context.drawImage(img,0,0);var buffer=context.getImageData(0,0,heightMapWidth,heightMapHeight).data;_this.applyDisplacementMapFromBuffer(buffer,heightMapWidth,heightMapHeight,minHeight,maxHeight,uvOffset,uvScale);if(onSuccess){onSuccess(_this)}};BABYLON.Tools.LoadImage(url,onload,function(){},scene.database);return this};Mesh.prototype.applyDisplacementMapFromBuffer=function(buffer,heightMapWidth,heightMapHeight,minHeight,maxHeight,uvOffset,uvScale){if(!this.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind)||!this.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)||!this.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){BABYLON.Tools.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing");return this}var positions=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);var normals=this.getVerticesData(BABYLON.VertexBuffer.NormalKind);var uvs=this.getVerticesData(BABYLON.VertexBuffer.UVKind);var position=BABYLON.Vector3.Zero();var normal=BABYLON.Vector3.Zero();var uv=BABYLON.Vector2.Zero();uvOffset=uvOffset||BABYLON.Vector2.Zero();uvScale=uvScale||new BABYLON.Vector2(1,1);for(var index=0;index<positions.length;index+=3){BABYLON.Vector3.FromArrayToRef(positions,index,position);BABYLON.Vector3.FromArrayToRef(normals,index,normal);BABYLON.Vector2.FromArrayToRef(uvs,index/3*2,uv);var u=Math.abs(uv.x*uvScale.x+uvOffset.x)*heightMapWidth%heightMapWidth|0;var v=Math.abs(uv.y*uvScale.y+uvOffset.y)*heightMapHeight%heightMapHeight|0;var pos=(u+v*heightMapWidth)*4;var r=buffer[pos]/255;var g=buffer[pos+1]/255;var b=buffer[pos+2]/255;var gradient=r*.3+g*.59+b*.11;normal.normalize();normal.scaleInPlace(minHeight+(maxHeight-minHeight)*gradient);position=position.add(normal);position.toArray(positions,index)}BABYLON.VertexData.ComputeNormals(positions,this.getIndices(),normals);this.updateVerticesData(BABYLON.VertexBuffer.PositionKind,positions);this.updateVerticesData(BABYLON.VertexBuffer.NormalKind,normals);return this};Mesh.prototype.convertToFlatShadedMesh=function(){var kinds=this.getVerticesDataKinds();var vbs={};var data={};var newdata={};var updatableNormals=false;var kindIndex;var kind;for(kindIndex=0;kindIndex<kinds.length;kindIndex++){kind=kinds[kindIndex];var vertexBuffer=this.getVertexBuffer(kind);if(kind===BABYLON.VertexBuffer.NormalKind){updatableNormals=vertexBuffer.isUpdatable();kinds.splice(kindIndex,1);kindIndex--;continue}vbs[kind]=vertexBuffer;data[kind]=vbs[kind].getData();newdata[kind]=[]}var previousSubmeshes=this.subMeshes.slice(0);var indices=this.getIndices();var totalIndices=this.getTotalIndices();var index;for(index=0;index<totalIndices;index++){var vertexIndex=indices[index];for(kindIndex=0;kindIndex<kinds.length;kindIndex++){kind=kinds[kindIndex];var stride=vbs[kind].getStrideSize();for(var offset=0;offset<stride;offset++){newdata[kind].push(data[kind][vertexIndex*stride+offset])}}}var normals=[];var positions=newdata[BABYLON.VertexBuffer.PositionKind];for(index=0;index<totalIndices;index+=3){indices[index]=index;indices[index+1]=index+1;indices[index+2]=index+2;var p1=BABYLON.Vector3.FromArray(positions,index*3);var p2=BABYLON.Vector3.FromArray(positions,(index+1)*3);var p3=BABYLON.Vector3.FromArray(positions,(index+2)*3);var p1p2=p1.subtract(p2);var p3p2=p3.subtract(p2);var normal=BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(p1p2,p3p2));for(var localIndex=0;localIndex<3;localIndex++){normals.push(normal.x);normals.push(normal.y);normals.push(normal.z)}}this.setIndices(indices);this.setVerticesData(BABYLON.VertexBuffer.NormalKind,normals,updatableNormals);for(kindIndex=0;kindIndex<kinds.length;kindIndex++){kind=kinds[kindIndex];this.setVerticesData(kind,newdata[kind],vbs[kind].isUpdatable())}this.releaseSubMeshes();for(var submeshIndex=0;submeshIndex<previousSubmeshes.length;submeshIndex++){var previousOne=previousSubmeshes[submeshIndex];BABYLON.SubMesh.AddToMesh(previousOne.materialIndex,previousOne.indexStart,previousOne.indexCount,previousOne.indexStart,previousOne.indexCount,this)}this.synchronizeInstances();return this};Mesh.prototype.convertToUnIndexedMesh=function(){var kinds=this.getVerticesDataKinds();var vbs={};var data={};var newdata={};var kindIndex;var kind;for(kindIndex=0;kindIndex<kinds.length;kindIndex++){kind=kinds[kindIndex];var vertexBuffer=this.getVertexBuffer(kind);vbs[kind]=vertexBuffer;data[kind]=vbs[kind].getData();newdata[kind]=[]}var previousSubmeshes=this.subMeshes.slice(0);var indices=this.getIndices();var totalIndices=this.getTotalIndices();var index;for(index=0;index<totalIndices;index++){var vertexIndex=indices[index];for(kindIndex=0;kindIndex<kinds.length;kindIndex++){kind=kinds[kindIndex];var stride=vbs[kind].getStrideSize();for(var offset=0;offset<stride;offset++){newdata[kind].push(data[kind][vertexIndex*stride+offset])}}}for(index=0;index<totalIndices;index+=3){indices[index]=index;indices[index+1]=index+1;indices[index+2]=index+2}this.setIndices(indices);for(kindIndex=0;kindIndex<kinds.length;kindIndex++){kind=kinds[kindIndex];this.setVerticesData(kind,newdata[kind],vbs[kind].isUpdatable())}this.releaseSubMeshes();for(var submeshIndex=0;submeshIndex<previousSubmeshes.length;submeshIndex++){var previousOne=previousSubmeshes[submeshIndex];BABYLON.SubMesh.AddToMesh(previousOne.materialIndex,previousOne.indexStart,previousOne.indexCount,previousOne.indexStart,previousOne.indexCount,this)}this._unIndexed=true;this.synchronizeInstances();return this};Mesh.prototype.flipFaces=function(flipNormals){if(flipNormals===void 0){flipNormals=false}var vertex_data=BABYLON.VertexData.ExtractFromMesh(this);var i;if(flipNormals&&this.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){for(i=0;i<vertex_data.normals.length;i++){vertex_data.normals[i]*=-1}}var temp;for(i=0;i<vertex_data.indices.length;i+=3){temp=vertex_data.indices[i+1];vertex_data.indices[i+1]=vertex_data.indices[i+2];vertex_data.indices[i+2]=temp}vertex_data.applyToMesh(this);return this};Mesh.prototype.createInstance=function(name){return new BABYLON.InstancedMesh(name,this)};Mesh.prototype.synchronizeInstances=function(){for(var instanceIndex=0;instanceIndex<this.instances.length;instanceIndex++){var instance=this.instances[instanceIndex];instance._syncSubMeshes()}return this};Mesh.prototype.simplify=function(settings,parallelProcessing,simplificationType,successCallback){if(parallelProcessing===void 0){parallelProcessing=true}if(simplificationType===void 0){simplificationType=BABYLON.SimplificationType.QUADRATIC}this.getScene().simplificationQueue.addTask({settings:settings,parallelProcessing:parallelProcessing,mesh:this,simplificationType:simplificationType,successCallback:successCallback});return this};Mesh.prototype.optimizeIndices=function(successCallback){var _this=this;var indices=this.getIndices();var positions=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);var vectorPositions=new Array;for(var pos=0;pos<positions.length;pos=pos+3){vectorPositions.push(BABYLON.Vector3.FromArray(positions,pos))}var dupes=new Array;BABYLON.AsyncLoop.SyncAsyncForLoop(vectorPositions.length,40,function(iteration){var realPos=vectorPositions.length-1-iteration;var testedPosition=vectorPositions[realPos];for(var j=0;j<realPos;++j){var againstPosition=vectorPositions[j];if(testedPosition.equals(againstPosition)){dupes[realPos]=j;break}}},function(){for(var i=0;i<indices.length;++i){indices[i]=dupes[indices[i]]||indices[i]}var originalSubMeshes=_this.subMeshes.slice(0);_this.setIndices(indices);_this.subMeshes=originalSubMeshes;if(successCallback){successCallback(_this)}});return this};Mesh.prototype.serialize=function(serializationObject){serializationObject.name=this.name;serializationObject.id=this.id;serializationObject.type=this.getClassName();if(BABYLON.Tags&&BABYLON.Tags.HasTags(this)){serializationObject.tags=BABYLON.Tags.GetTags(this)}serializationObject.position=this.position.asArray();if(this.rotationQuaternion){serializationObject.rotationQuaternion=this.rotationQuaternion.asArray()}else if(this.rotation){serializationObject.rotation=this.rotation.asArray()}serializationObject.scaling=this.scaling.asArray();serializationObject.localMatrix=this.getPivotMatrix().asArray();serializationObject.isEnabled=this.isEnabled();serializationObject.isVisible=this.isVisible;serializationObject.infiniteDistance=this.infiniteDistance;serializationObject.pickable=this.isPickable;serializationObject.receiveShadows=this.receiveShadows;serializationObject.billboardMode=this.billboardMode;serializationObject.visibility=this.visibility;serializationObject.checkCollisions=this.checkCollisions;serializationObject.isBlocker=this.isBlocker;if(this.parent){serializationObject.parentId=this.parent.id}var geometry=this._geometry;if(geometry){var geometryId=geometry.id;serializationObject.geometryId=geometryId;serializationObject.subMeshes=[];for(var subIndex=0;subIndex<this.subMeshes.length;subIndex++){var subMesh=this.subMeshes[subIndex];serializationObject.subMeshes.push({materialIndex:subMesh.materialIndex,verticesStart:subMesh.verticesStart,verticesCount:subMesh.verticesCount,indexStart:subMesh.indexStart,indexCount:subMesh.indexCount})}}if(this.material){serializationObject.materialId=this.material.id}else{this.material=null}if(this.morphTargetManager){serializationObject.morphTargetManagerId=this.morphTargetManager.uniqueId}if(this.skeleton){serializationObject.skeletonId=this.skeleton.id}if(this.getPhysicsImpostor()){var impostor=this.getPhysicsImpostor();serializationObject.physicsMass=impostor.getParam("mass");serializationObject.physicsFriction=impostor.getParam("friction");serializationObject.physicsRestitution=impostor.getParam("mass");serializationObject.physicsImpostor=this.getPhysicsImpostor().type}if(this.metadata){serializationObject.metadata=this.metadata}serializationObject.instances=[];for(var index=0;index<this.instances.length;index++){var instance=this.instances[index];var serializationInstance={name:instance.name,position:instance.position.asArray(),scaling:instance.scaling.asArray()};if(instance.rotationQuaternion){serializationInstance.rotationQuaternion=instance.rotationQuaternion.asArray()}else if(instance.rotation){serializationInstance.rotation=instance.rotation.asArray()}serializationObject.instances.push(serializationInstance);BABYLON.Animation.AppendSerializedAnimations(instance,serializationInstance);serializationInstance.ranges=instance.serializeAnimationRanges()}BABYLON.Animation.AppendSerializedAnimations(this,serializationObject);serializationObject.ranges=this.serializeAnimationRanges();serializationObject.layerMask=this.layerMask;serializationObject.alphaIndex=this.alphaIndex;serializationObject.hasVertexAlpha=this.hasVertexAlpha;serializationObject.overlayAlpha=this.overlayAlpha;serializationObject.overlayColor=this.overlayColor.asArray();serializationObject.renderOverlay=this.renderOverlay;serializationObject.applyFog=this.applyFog;if(this.actionManager){serializationObject.actions=this.actionManager.serialize(this.name)}};Mesh.prototype._syncGeometryWithMorphTargetManager=function(){if(!this.geometry){return}this._markSubMeshesAsAttributesDirty();if(this._morphTargetManager&&this._morphTargetManager.vertexCount){if(this._morphTargetManager.vertexCount!==this.getTotalVertices()){BABYLON.Tools.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count.");this.morphTargetManager=undefined;return}for(var index=0;index<this.morphTargetManager.numInfluencers;index++){var morphTarget=this.morphTargetManager.getActiveTarget(index);this.geometry.setVerticesData(BABYLON.VertexBuffer.PositionKind+index,morphTarget.getPositions(),false,3);if(morphTarget.hasNormals){this.geometry.setVerticesData(BABYLON.VertexBuffer.NormalKind+index,morphTarget.getNormals(),false,3)}if(morphTarget.hasTangents){this.geometry.setVerticesData(BABYLON.VertexBuffer.TangentKind+index,morphTarget.getTangents(),false,3)}}}else{var index=0;while(this.geometry.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind+index)){this.geometry.removeVerticesData(BABYLON.VertexBuffer.PositionKind+index);if(this.geometry.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind+index)){this.geometry.removeVerticesData(BABYLON.VertexBuffer.NormalKind+index)}if(this.geometry.isVerticesDataPresent(BABYLON.VertexBuffer.TangentKind+index)){this.geometry.removeVerticesData(BABYLON.VertexBuffer.TangentKind+index)}index++}}};Mesh.Parse=function(parsedMesh,scene,rootUrl){var mesh;if(parsedMesh.type&&parsedMesh.type==="GroundMesh"){mesh=BABYLON.GroundMesh.Parse(parsedMesh,scene)}else{mesh=new Mesh(parsedMesh.name,scene)}mesh.id=parsedMesh.id;if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(mesh,parsedMesh.tags)}mesh.position=BABYLON.Vector3.FromArray(parsedMesh.position);if(parsedMesh.metadata!==undefined){mesh.metadata=parsedMesh.metadata}if(parsedMesh.rotationQuaternion){mesh.rotationQuaternion=BABYLON.Quaternion.FromArray(parsedMesh.rotationQuaternion)}else if(parsedMesh.rotation){mesh.rotation=BABYLON.Vector3.FromArray(parsedMesh.rotation)}mesh.scaling=BABYLON.Vector3.FromArray(parsedMesh.scaling);if(parsedMesh.localMatrix){mesh.setPivotMatrix(BABYLON.Matrix.FromArray(parsedMesh.localMatrix))}else if(parsedMesh.pivotMatrix){mesh.setPivotMatrix(BABYLON.Matrix.FromArray(parsedMesh.pivotMatrix))}mesh.setEnabled(parsedMesh.isEnabled);mesh.isVisible=parsedMesh.isVisible;mesh.infiniteDistance=parsedMesh.infiniteDistance;mesh.showBoundingBox=parsedMesh.showBoundingBox;mesh.showSubMeshesBoundingBox=parsedMesh.showSubMeshesBoundingBox;if(parsedMesh.applyFog!==undefined){mesh.applyFog=parsedMesh.applyFog}if(parsedMesh.pickable!==undefined){mesh.isPickable=parsedMesh.pickable}if(parsedMesh.alphaIndex!==undefined){mesh.alphaIndex=parsedMesh.alphaIndex}mesh.receiveShadows=parsedMesh.receiveShadows;mesh.billboardMode=parsedMesh.billboardMode;if(parsedMesh.visibility!==undefined){mesh.visibility=parsedMesh.visibility}mesh.checkCollisions=parsedMesh.checkCollisions;if(parsedMesh.isBlocker!==undefined){mesh.isBlocker=parsedMesh.isBlocker}mesh._shouldGenerateFlatShading=parsedMesh.useFlatShading;if(parsedMesh.freezeWorldMatrix){mesh._waitingFreezeWorldMatrix=parsedMesh.freezeWorldMatrix}if(parsedMesh.parentId){mesh._waitingParentId=parsedMesh.parentId}if(parsedMesh.actions!==undefined){mesh._waitingActions=parsedMesh.actions}if(parsedMesh.overlayAlpha!==undefined){mesh.overlayAlpha=parsedMesh.overlayAlpha}if(parsedMesh.overlayColor!==undefined){mesh.overlayColor=BABYLON.Color3.FromArray(parsedMesh.overlayColor)}if(parsedMesh.renderOverlay!==undefined){mesh.renderOverlay=parsedMesh.renderOverlay}mesh.hasVertexAlpha=parsedMesh.hasVertexAlpha;if(parsedMesh.delayLoadingFile){mesh.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED;mesh.delayLoadingFile=rootUrl+parsedMesh.delayLoadingFile;mesh._boundingInfo=new BABYLON.BoundingInfo(BABYLON.Vector3.FromArray(parsedMesh.boundingBoxMinimum),BABYLON.Vector3.FromArray(parsedMesh.boundingBoxMaximum));if(parsedMesh._binaryInfo){mesh._binaryInfo=parsedMesh._binaryInfo}mesh._delayInfo=[];if(parsedMesh.hasUVs){mesh._delayInfo.push(BABYLON.VertexBuffer.UVKind)}if(parsedMesh.hasUVs2){mesh._delayInfo.push(BABYLON.VertexBuffer.UV2Kind)}if(parsedMesh.hasUVs3){mesh._delayInfo.push(BABYLON.VertexBuffer.UV3Kind)}if(parsedMesh.hasUVs4){mesh._delayInfo.push(BABYLON.VertexBuffer.UV4Kind)}if(parsedMesh.hasUVs5){mesh._delayInfo.push(BABYLON.VertexBuffer.UV5Kind)}if(parsedMesh.hasUVs6){mesh._delayInfo.push(BABYLON.VertexBuffer.UV6Kind)}if(parsedMesh.hasColors){mesh._delayInfo.push(BABYLON.VertexBuffer.ColorKind)}if(parsedMesh.hasMatricesIndices){mesh._delayInfo.push(BABYLON.VertexBuffer.MatricesIndicesKind)}if(parsedMesh.hasMatricesWeights){mesh._delayInfo.push(BABYLON.VertexBuffer.MatricesWeightsKind)}mesh._delayLoadingFunction=BABYLON.Geometry.ImportGeometry;if(BABYLON.SceneLoader.ForceFullSceneLoadingForIncremental){mesh._checkDelayState()}}else{BABYLON.Geometry.ImportGeometry(parsedMesh,mesh)}if(parsedMesh.materialId){mesh.setMaterialByID(parsedMesh.materialId)}else{mesh.material=null}if(parsedMesh.morphTargetManagerId>-1){mesh.morphTargetManager=scene.getMorphTargetManagerById(parsedMesh.morphTargetManagerId)}if(parsedMesh.skeletonId>-1){mesh.skeleton=scene.getLastSkeletonByID(parsedMesh.skeletonId);if(parsedMesh.numBoneInfluencers){mesh.numBoneInfluencers=parsedMesh.numBoneInfluencers}}if(parsedMesh.animations){for(var animationIndex=0;animationIndex<parsedMesh.animations.length;animationIndex++){var parsedAnimation=parsedMesh.animations[animationIndex];mesh.animations.push(BABYLON.Animation.Parse(parsedAnimation))}BABYLON.Node.ParseAnimationRanges(mesh,parsedMesh,scene)}if(parsedMesh.autoAnimate){scene.beginAnimation(mesh,parsedMesh.autoAnimateFrom,parsedMesh.autoAnimateTo,parsedMesh.autoAnimateLoop,parsedMesh.autoAnimateSpeed||1)}if(parsedMesh.layerMask&&!isNaN(parsedMesh.layerMask)){mesh.layerMask=Math.abs(parseInt(parsedMesh.layerMask))}else{mesh.layerMask=268435455}if(parsedMesh.physicsImpostor){mesh.physicsImpostor=new BABYLON.PhysicsImpostor(mesh,parsedMesh.physicsImpostor,{mass:parsedMesh.physicsMass,friction:parsedMesh.physicsFriction,restitution:parsedMesh.physicsRestitution},scene)}if(parsedMesh.instances){for(var index=0;index<parsedMesh.instances.length;index++){var parsedInstance=parsedMesh.instances[index];var instance=mesh.createInstance(parsedInstance.name);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(instance,parsedInstance.tags)}instance.position=BABYLON.Vector3.FromArray(parsedInstance.position);if(parsedInstance.parentId){instance._waitingParentId=parsedInstance.parentId}if(parsedInstance.rotationQuaternion){instance.rotationQuaternion=BABYLON.Quaternion.FromArray(parsedInstance.rotationQuaternion)}else if(parsedInstance.rotation){instance.rotation=BABYLON.Vector3.FromArray(parsedInstance.rotation)}instance.scaling=BABYLON.Vector3.FromArray(parsedInstance.scaling);instance.checkCollisions=mesh.checkCollisions;if(parsedMesh.animations){for(animationIndex=0;animationIndex<parsedMesh.animations.length;animationIndex++){parsedAnimation=parsedMesh.animations[animationIndex];instance.animations.push(BABYLON.Animation.Parse(parsedAnimation))}BABYLON.Node.ParseAnimationRanges(instance,parsedMesh,scene)}}}return mesh};Mesh.CreateRibbon=function(name,pathArray,closeArray,closePath,offset,scene,updatable,sideOrientation,instance){return BABYLON.MeshBuilder.CreateRibbon(name,{pathArray:pathArray,closeArray:closeArray,closePath:closePath,offset:offset,updatable:updatable,sideOrientation:sideOrientation,instance:instance},scene)};Mesh.CreateDisc=function(name,radius,tessellation,scene,updatable,sideOrientation){var options={radius:radius,tessellation:tessellation,sideOrientation:sideOrientation,updatable:updatable};return BABYLON.MeshBuilder.CreateDisc(name,options,scene)};Mesh.CreateBox=function(name,size,scene,updatable,sideOrientation){var options={size:size,sideOrientation:sideOrientation,updatable:updatable};return BABYLON.MeshBuilder.CreateBox(name,options,scene)};Mesh.CreateSphere=function(name,segments,diameter,scene,updatable,sideOrientation){var options={segments:segments,diameterX:diameter,diameterY:diameter,diameterZ:diameter,sideOrientation:sideOrientation,updatable:updatable};return BABYLON.MeshBuilder.CreateSphere(name,options,scene)};Mesh.CreateCylinder=function(name,height,diameterTop,diameterBottom,tessellation,subdivisions,scene,updatable,sideOrientation){if(scene===undefined||!(scene instanceof BABYLON.Scene)){if(scene!==undefined){sideOrientation=updatable||Mesh.DEFAULTSIDE;updatable=scene}scene=subdivisions;subdivisions=1}var options={height:height,diameterTop:diameterTop,diameterBottom:diameterBottom,tessellation:tessellation,subdivisions:subdivisions,sideOrientation:sideOrientation,updatable:updatable};return BABYLON.MeshBuilder.CreateCylinder(name,options,scene)};Mesh.CreateTorus=function(name,diameter,thickness,tessellation,scene,updatable,sideOrientation){var options={diameter:diameter,thickness:thickness,tessellation:tessellation,sideOrientation:sideOrientation,updatable:updatable};return BABYLON.MeshBuilder.CreateTorus(name,options,scene)};Mesh.CreateTorusKnot=function(name,radius,tube,radialSegments,tubularSegments,p,q,scene,updatable,sideOrientation){var options={radius:radius,tube:tube,radialSegments:radialSegments,tubularSegments:tubularSegments,p:p,q:q,sideOrientation:sideOrientation,updatable:updatable};return BABYLON.MeshBuilder.CreateTorusKnot(name,options,scene)};Mesh.CreateLines=function(name,points,scene,updatable,instance){var options={points:points,updatable:updatable,instance:instance};return BABYLON.MeshBuilder.CreateLines(name,options,scene)};Mesh.CreateDashedLines=function(name,points,dashSize,gapSize,dashNb,scene,updatable,instance){var options={points:points,dashSize:dashSize,gapSize:gapSize,dashNb:dashNb,updatable:updatable,instance:instance};return BABYLON.MeshBuilder.CreateDashedLines(name,options,scene)};Mesh.CreatePolygon=function(name,shape,scene,holes,updatable,sideOrientation){var options={shape:shape,holes:holes,updatable:updatable,sideOrientation:sideOrientation};return BABYLON.MeshBuilder.CreatePolygon(name,options,scene)};Mesh.ExtrudePolygon=function(name,shape,depth,scene,holes,updatable,sideOrientation){var options={shape:shape,holes:holes,depth:depth,updatable:updatable,sideOrientation:sideOrientation};return BABYLON.MeshBuilder.ExtrudePolygon(name,options,scene)};Mesh.ExtrudeShape=function(name,shape,path,scale,rotation,cap,scene,updatable,sideOrientation,instance){var options={shape:shape,path:path,scale:scale,rotation:rotation,cap:cap===0?0:cap||Mesh.NO_CAP,sideOrientation:sideOrientation,instance:instance,updatable:updatable};return BABYLON.MeshBuilder.ExtrudeShape(name,options,scene)};Mesh.ExtrudeShapeCustom=function(name,shape,path,scaleFunction,rotationFunction,ribbonCloseArray,ribbonClosePath,cap,scene,updatable,sideOrientation,instance){var options={shape:shape,path:path,scaleFunction:scaleFunction,rotationFunction:rotationFunction,ribbonCloseArray:ribbonCloseArray,ribbonClosePath:ribbonClosePath,cap:cap===0?0:cap||Mesh.NO_CAP,sideOrientation:sideOrientation,instance:instance,updatable:updatable};return BABYLON.MeshBuilder.ExtrudeShapeCustom(name,options,scene)};Mesh.CreateLathe=function(name,shape,radius,tessellation,scene,updatable,sideOrientation){var options={shape:shape,radius:radius,tessellation:tessellation,sideOrientation:sideOrientation,updatable:updatable};return BABYLON.MeshBuilder.CreateLathe(name,options,scene)};Mesh.CreatePlane=function(name,size,scene,updatable,sideOrientation){var options={size:size,width:size,height:size,sideOrientation:sideOrientation,updatable:updatable};return BABYLON.MeshBuilder.CreatePlane(name,options,scene)};Mesh.CreateGround=function(name,width,height,subdivisions,scene,updatable){var options={width:width,height:height,subdivisions:subdivisions,updatable:updatable};return BABYLON.MeshBuilder.CreateGround(name,options,scene)};Mesh.CreateTiledGround=function(name,xmin,zmin,xmax,zmax,subdivisions,precision,scene,updatable){var options={xmin:xmin,zmin:zmin,xmax:xmax,zmax:zmax,subdivisions:subdivisions,precision:precision,updatable:updatable};return BABYLON.MeshBuilder.CreateTiledGround(name,options,scene)};Mesh.CreateGroundFromHeightMap=function(name,url,width,height,subdivisions,minHeight,maxHeight,scene,updatable,onReady){var options={width:width,height:height,subdivisions:subdivisions,minHeight:minHeight,maxHeight:maxHeight,updatable:updatable,onReady:onReady};return BABYLON.MeshBuilder.CreateGroundFromHeightMap(name,url,options,scene)};Mesh.CreateTube=function(name,path,radius,tessellation,radiusFunction,cap,scene,updatable,sideOrientation,instance){var options={path:path,radius:radius,tessellation:tessellation,radiusFunction:radiusFunction,arc:1,cap:cap,updatable:updatable,sideOrientation:sideOrientation,instance:instance};return BABYLON.MeshBuilder.CreateTube(name,options,scene)};Mesh.CreatePolyhedron=function(name,options,scene){return BABYLON.MeshBuilder.CreatePolyhedron(name,options,scene)};Mesh.CreateIcoSphere=function(name,options,scene){return BABYLON.MeshBuilder.CreateIcoSphere(name,options,scene)};Mesh.CreateDecal=function(name,sourceMesh,position,normal,size,angle){var options={position:position,normal:normal,size:size,angle:angle};return BABYLON.MeshBuilder.CreateDecal(name,sourceMesh,options)};Mesh.prototype.setPositionsForCPUSkinning=function(){var source;if(!this._sourcePositions){source=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);this._sourcePositions=new Float32Array(source);if(!this.getVertexBuffer(BABYLON.VertexBuffer.PositionKind).isUpdatable()){this.setVerticesData(BABYLON.VertexBuffer.PositionKind,source,true)}}return this._sourcePositions};Mesh.prototype.setNormalsForCPUSkinning=function(){var source;if(!this._sourceNormals){source=this.getVerticesData(BABYLON.VertexBuffer.NormalKind);this._sourceNormals=new Float32Array(source);if(!this.getVertexBuffer(BABYLON.VertexBuffer.NormalKind).isUpdatable()){this.setVerticesData(BABYLON.VertexBuffer.NormalKind,source,true)}}return this._sourceNormals};Mesh.prototype.applySkeleton=function(skeleton){if(!this.geometry){return this}if(this.geometry._softwareSkinningRenderId==this.getScene().getRenderId()){return this}this.geometry._softwareSkinningRenderId=this.getScene().getRenderId();if(!this.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind)){return this}if(!this.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){return this}if(!this.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)){return this}if(!this.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)){return this}if(!this._sourcePositions){var submeshes=this.subMeshes.slice();this.setPositionsForCPUSkinning();this.subMeshes=submeshes}if(!this._sourceNormals){this.setNormalsForCPUSkinning()}var positionsData=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(!(positionsData instanceof Float32Array)){positionsData=new Float32Array(positionsData)}var normalsData=this.getVerticesData(BABYLON.VertexBuffer.NormalKind);if(!(normalsData instanceof Float32Array)){normalsData=new Float32Array(normalsData)}var matricesIndicesData=this.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind);var matricesWeightsData=this.getVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind);var needExtras=this.numBoneInfluencers>4;var matricesIndicesExtraData=needExtras?this.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesExtraKind):null;var matricesWeightsExtraData=needExtras?this.getVerticesData(BABYLON.VertexBuffer.MatricesWeightsExtraKind):null;var skeletonMatrices=skeleton.getTransformMatrices(this);var tempVector3=BABYLON.Vector3.Zero();var finalMatrix=new BABYLON.Matrix;var tempMatrix=new BABYLON.Matrix;var matWeightIdx=0;var inf;for(var index=0;index<positionsData.length;index+=3,matWeightIdx+=4){var weight;for(inf=0;inf<4;inf++){weight=matricesWeightsData[matWeightIdx+inf];if(weight>0){BABYLON.Matrix.FromFloat32ArrayToRefScaled(skeletonMatrices,matricesIndicesData[matWeightIdx+inf]*16,weight,tempMatrix);finalMatrix.addToSelf(tempMatrix)}else break}if(needExtras){for(inf=0;inf<4;inf++){weight=matricesWeightsExtraData[matWeightIdx+inf];if(weight>0){BABYLON.Matrix.FromFloat32ArrayToRefScaled(skeletonMatrices,matricesIndicesExtraData[matWeightIdx+inf]*16,weight,tempMatrix);finalMatrix.addToSelf(tempMatrix)}else break}}BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(this._sourcePositions[index],this._sourcePositions[index+1],this._sourcePositions[index+2],finalMatrix,tempVector3);tempVector3.toArray(positionsData,index);BABYLON.Vector3.TransformNormalFromFloatsToRef(this._sourceNormals[index],this._sourceNormals[index+1],this._sourceNormals[index+2],finalMatrix,tempVector3);tempVector3.toArray(normalsData,index);finalMatrix.reset()}this.updateVerticesData(BABYLON.VertexBuffer.PositionKind,positionsData);this.updateVerticesData(BABYLON.VertexBuffer.NormalKind,normalsData);return this};Mesh.MinMax=function(meshes){var minVector=null;var maxVector=null;meshes.forEach(function(mesh,index,array){var boundingBox=mesh.getBoundingInfo().boundingBox;if(!minVector){minVector=boundingBox.minimumWorld;maxVector=boundingBox.maximumWorld}else{minVector.MinimizeInPlace(boundingBox.minimumWorld);maxVector.MaximizeInPlace(boundingBox.maximumWorld)}});return{min:minVector,max:maxVector}};Mesh.Center=function(meshesOrMinMaxVector){var minMaxVector=meshesOrMinMaxVector instanceof Array?BABYLON.Mesh.MinMax(meshesOrMinMaxVector):meshesOrMinMaxVector;return BABYLON.Vector3.Center(minMaxVector.min,minMaxVector.max)};Mesh.MergeMeshes=function(meshes,disposeSource,allow32BitsIndices,meshSubclass,subdivideWithSubMeshes){if(disposeSource===void 0){disposeSource=true}var index;if(!allow32BitsIndices){var totalVertices=0;for(index=0;index<meshes.length;index++){if(meshes[index]){totalVertices+=meshes[index].getTotalVertices();if(totalVertices>65536){BABYLON.Tools.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices");return null}}}}var vertexData;var otherVertexData;var indiceArray=new Array;var source;for(index=0;index<meshes.length;index++){if(meshes[index]){meshes[index].computeWorldMatrix(true);otherVertexData=BABYLON.VertexData.ExtractFromMesh(meshes[index],true);otherVertexData.transform(meshes[index].getWorldMatrix());if(vertexData){vertexData.merge(otherVertexData)}else{vertexData=otherVertexData;source=meshes[index]}if(subdivideWithSubMeshes){indiceArray.push(meshes[index].getTotalIndices())}}}if(!meshSubclass){meshSubclass=new Mesh(source.name+"_merged",source.getScene())}vertexData.applyToMesh(meshSubclass);meshSubclass.material=source.material;meshSubclass.checkCollisions=source.checkCollisions;if(disposeSource){for(index=0;index<meshes.length;index++){if(meshes[index]){meshes[index].dispose()}}}if(subdivideWithSubMeshes){meshSubclass.releaseSubMeshes();index=0;var offset=0;while(index<indiceArray.length){BABYLON.SubMesh.CreateFromIndices(0,offset,indiceArray[index],meshSubclass);offset+=indiceArray[index];index++}}return meshSubclass};Mesh._FRONTSIDE=0;Mesh._BACKSIDE=1;Mesh._DOUBLESIDE=2;Mesh._DEFAULTSIDE=0;Mesh._NO_CAP=0;Mesh._CAP_START=1;Mesh._CAP_END=2;Mesh._CAP_ALL=3;return Mesh}(BABYLON.AbstractMesh);BABYLON.Mesh=Mesh})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BaseSubMesh=function(){function BaseSubMesh(){}Object.defineProperty(BaseSubMesh.prototype,"effect",{get:function(){return this._materialEffect},enumerable:true,configurable:true});BaseSubMesh.prototype.setEffect=function(effect,defines){if(this._materialEffect===effect){if(!effect){this._materialDefines=undefined}return}this._materialDefines=defines;this._materialEffect=effect};return BaseSubMesh}();BABYLON.BaseSubMesh=BaseSubMesh;var SubMesh=function(_super){__extends(SubMesh,_super);function SubMesh(materialIndex,verticesStart,verticesCount,indexStart,indexCount,mesh,renderingMesh,createBoundingBox){if(createBoundingBox===void 0){createBoundingBox=true}var _this=_super.call(this)||this;_this.materialIndex=materialIndex;_this.verticesStart=verticesStart;_this.verticesCount=verticesCount;_this.indexStart=indexStart;_this.indexCount=indexCount;_this._renderId=0;_this._mesh=mesh;_this._renderingMesh=renderingMesh||mesh;mesh.subMeshes.push(_this);_this._trianglePlanes=[];_this._id=mesh.subMeshes.length-1;if(createBoundingBox){_this.refreshBoundingInfo();mesh.computeWorldMatrix(true)}return _this}SubMesh.AddToMesh=function(materialIndex,verticesStart,verticesCount,indexStart,indexCount,mesh,renderingMesh,createBoundingBox){if(createBoundingBox===void 0){createBoundingBox=true}return new SubMesh(materialIndex,verticesStart,verticesCount,indexStart,indexCount,mesh,renderingMesh,createBoundingBox)};Object.defineProperty(SubMesh.prototype,"IsGlobal",{get:function(){return this.verticesStart===0&&this.verticesCount==this._mesh.getTotalVertices()},enumerable:true,configurable:true});SubMesh.prototype.getBoundingInfo=function(){if(this.IsGlobal){return this._mesh.getBoundingInfo()}return this._boundingInfo};SubMesh.prototype.setBoundingInfo=function(boundingInfo){this._boundingInfo=boundingInfo;return this};SubMesh.prototype.getMesh=function(){return this._mesh};SubMesh.prototype.getRenderingMesh=function(){return this._renderingMesh};SubMesh.prototype.getMaterial=function(){var rootMaterial=this._renderingMesh.material;if(rootMaterial&&rootMaterial.getSubMaterial){var multiMaterial=rootMaterial;var effectiveMaterial=multiMaterial.getSubMaterial(this.materialIndex);if(this._currentMaterial!==effectiveMaterial){this._currentMaterial=effectiveMaterial;this._materialDefines=undefined}return effectiveMaterial}if(!rootMaterial){return this._mesh.getScene().defaultMaterial}return rootMaterial};SubMesh.prototype.refreshBoundingInfo=function(){this._lastColliderWorldVertices=null;if(this.IsGlobal){return this}var data=this._renderingMesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(!data){this._boundingInfo=this._mesh._boundingInfo;return this}var indices=this._renderingMesh.getIndices();var extend;if(this.indexStart===0&&this.indexCount===indices.length){extend={minimum:this._renderingMesh.getBoundingInfo().minimum.clone(),maximum:this._renderingMesh.getBoundingInfo().maximum.clone()}}else{extend=BABYLON.Tools.ExtractMinAndMaxIndexed(data,indices,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias)}this._boundingInfo=new BABYLON.BoundingInfo(extend.minimum,extend.maximum);return this};SubMesh.prototype._checkCollision=function(collider){return this.getBoundingInfo()._checkCollision(collider)};SubMesh.prototype.updateBoundingInfo=function(world){if(!this.getBoundingInfo()){this.refreshBoundingInfo()}this.getBoundingInfo().update(world);return this};SubMesh.prototype.isInFrustum=function(frustumPlanes){return this.getBoundingInfo().isInFrustum(frustumPlanes)};SubMesh.prototype.isCompletelyInFrustum=function(frustumPlanes){return this.getBoundingInfo().isCompletelyInFrustum(frustumPlanes)};SubMesh.prototype.render=function(enableAlphaMode){this._renderingMesh.render(this,enableAlphaMode);return this};SubMesh.prototype.getLinesIndexBuffer=function(indices,engine){if(!this._linesIndexBuffer){var linesIndices=[];for(var index=this.indexStart;index<this.indexStart+this.indexCount;index+=3){linesIndices.push(indices[index],indices[index+1],indices[index+1],indices[index+2],indices[index+2],indices[index])}this._linesIndexBuffer=engine.createIndexBuffer(linesIndices);this.linesIndexCount=linesIndices.length}return this._linesIndexBuffer};SubMesh.prototype.canIntersects=function(ray){return ray.intersectsBox(this.getBoundingInfo().boundingBox)};SubMesh.prototype.intersects=function(ray,positions,indices,fastCheck){var intersectInfo=null;if(this._mesh instanceof BABYLON.LinesMesh){var lineMesh=this._mesh;for(var index=this.indexStart;index<this.indexStart+this.indexCount;index+=2){var p0=positions[indices[index]];var p1=positions[indices[index+1]];var length=ray.intersectionSegment(p0,p1,lineMesh.intersectionThreshold);if(length<0){continue}if(fastCheck||!intersectInfo||length<intersectInfo.distance){intersectInfo=new BABYLON.IntersectionInfo(null,null,length);if(fastCheck){break}}}}else{for(var index=this.indexStart;index<this.indexStart+this.indexCount;index+=3){var p0=positions[indices[index]];var p1=positions[indices[index+1]];var p2=positions[indices[index+2]];var currentIntersectInfo=ray.intersectsTriangle(p0,p1,p2);if(currentIntersectInfo){if(currentIntersectInfo.distance<0){continue}if(fastCheck||!intersectInfo||currentIntersectInfo.distance<intersectInfo.distance){intersectInfo=currentIntersectInfo;intersectInfo.faceId=index/3;if(fastCheck){break}}}}}return intersectInfo};SubMesh.prototype._rebuild=function(){if(this._linesIndexBuffer){this._linesIndexBuffer=null}};SubMesh.prototype.clone=function(newMesh,newRenderingMesh){var result=new SubMesh(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,newMesh,newRenderingMesh,false);if(!this.IsGlobal){result._boundingInfo=new BABYLON.BoundingInfo(this.getBoundingInfo().minimum,this.getBoundingInfo().maximum)}return result};SubMesh.prototype.dispose=function(){if(this._linesIndexBuffer){this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer);this._linesIndexBuffer=null}var index=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(index,1)};SubMesh.CreateFromIndices=function(materialIndex,startIndex,indexCount,mesh,renderingMesh){var minVertexIndex=Number.MAX_VALUE;var maxVertexIndex=-Number.MAX_VALUE;renderingMesh=renderingMesh||mesh;var indices=renderingMesh.getIndices();for(var index=startIndex;index<startIndex+indexCount;index++){var vertexIndex=indices[index];if(vertexIndex<minVertexIndex)minVertexIndex=vertexIndex;if(vertexIndex>maxVertexIndex)maxVertexIndex=vertexIndex}return new SubMesh(materialIndex,minVertexIndex,maxVertexIndex-minVertexIndex+1,startIndex,indexCount,mesh,renderingMesh)};return SubMesh}(BaseSubMesh);BABYLON.SubMesh=SubMesh})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var EffectFallbacks=function(){function EffectFallbacks(){this._defines={};this._currentRank=32;this._maxRank=-1}EffectFallbacks.prototype.unBindMesh=function(){this._mesh=null};EffectFallbacks.prototype.addFallback=function(rank,define){if(!this._defines[rank]){if(rank<this._currentRank){this._currentRank=rank}if(rank>this._maxRank){this._maxRank=rank}this._defines[rank]=new Array}this._defines[rank].push(define)};EffectFallbacks.prototype.addCPUSkinningFallback=function(rank,mesh){this._meshRank=rank;this._mesh=mesh;if(rank<this._currentRank){this._currentRank=rank}if(rank>this._maxRank){this._maxRank=rank}};Object.defineProperty(EffectFallbacks.prototype,"isMoreFallbacks",{get:function(){return this._currentRank<=this._maxRank},enumerable:true,configurable:true});EffectFallbacks.prototype.reduce=function(currentDefines){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=false;currentDefines=currentDefines.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0");BABYLON.Tools.Log("Falling back to CPU skinning for "+this._mesh.name);var scene=this._mesh.getScene();for(var index=0;index<scene.meshes.length;index++){var otherMesh=scene.meshes[index];if(otherMesh.material===this._mesh.material&&otherMesh.computeBonesUsingShaders&&otherMesh.numBoneInfluencers>0){otherMesh.computeBonesUsingShaders=false}}}else{var currentFallbacks=this._defines[this._currentRank];if(currentFallbacks){for(var index=0;index<currentFallbacks.length;index++){currentDefines=currentDefines.replace("#define "+currentFallbacks[index],"")}}this._currentRank++}return currentDefines};return EffectFallbacks}();BABYLON.EffectFallbacks=EffectFallbacks;var EffectCreationOptions=function(){function EffectCreationOptions(){}return EffectCreationOptions}();BABYLON.EffectCreationOptions=EffectCreationOptions;var Effect=function(){function Effect(baseName,attributesNamesOrOptions,uniformsNamesOrEngine,samplers,engine,defines,fallbacks,onCompiled,onError,indexParameters){var _this=this;this.uniqueId=0;this.onCompileObservable=new BABYLON.Observable;this.onErrorObservable=new BABYLON.Observable;this.onBindObservable=new BABYLON.Observable;this._uniformBuffersNames={};this._isReady=false;this._compilationError="";this.name=baseName;if(attributesNamesOrOptions.attributes){var options=attributesNamesOrOptions;this._engine=uniformsNamesOrEngine;this._attributesNames=options.attributes;this._uniformsNames=options.uniformsNames.concat(options.samplers);this._samplers=options.samplers;this.defines=options.defines;this.onError=options.onError;this.onCompiled=options.onCompiled;this._fallbacks=options.fallbacks;this._indexParameters=options.indexParameters;if(options.uniformBuffersNames){for(var i=0;i<options.uniformBuffersNames.length;i++){this._uniformBuffersNames[options.uniformBuffersNames[i]]=i}}}else{this._engine=engine;this.defines=defines;this._uniformsNames=uniformsNamesOrEngine.concat(samplers);this._samplers=samplers;this._attributesNames=attributesNamesOrOptions;this.onError=onError;this.onCompiled=onCompiled;this._indexParameters=indexParameters;this._fallbacks=fallbacks}this.uniqueId=Effect._uniqueIdSeed++;var vertexSource;var fragmentSource;if(baseName.vertexElement){vertexSource=document.getElementById(baseName.vertexElement);if(!vertexSource){vertexSource=baseName.vertexElement}}else{vertexSource=baseName.vertex||baseName}if(baseName.fragmentElement){fragmentSource=document.getElementById(baseName.fragmentElement);if(!fragmentSource){fragmentSource=baseName.fragmentElement}}else{fragmentSource=baseName.fragment||baseName}this._loadVertexShader(vertexSource,function(vertexCode){_this._processIncludes(vertexCode,function(vertexCodeWithIncludes){_this._processShaderConversion(vertexCodeWithIncludes,false,function(migratedVertexCode){_this._loadFragmentShader(fragmentSource,function(fragmentCode){_this._processIncludes(fragmentCode,function(fragmentCodeWithIncludes){_this._processShaderConversion(fragmentCodeWithIncludes,true,function(migratedFragmentCode){if(baseName){var vertex=baseName.vertexElement||baseName.vertex||baseName;var fragment=baseName.fragmentElement||baseName.fragment||baseName;_this._vertexSourceCode="#define SHADER_NAME vertex:"+vertex+"\n"+migratedVertexCode;_this._fragmentSourceCode="#define SHADER_NAME fragment:"+fragment+"\n"+migratedFragmentCode}else{_this._vertexSourceCode=migratedVertexCode;_this._fragmentSourceCode=migratedFragmentCode}_this._prepareEffect()})})})})})})}Object.defineProperty(Effect.prototype,"key",{get:function(){return this._key},enumerable:true,configurable:true});Effect.prototype.isReady=function(){return this._isReady};Effect.prototype.getEngine=function(){return this._engine};Effect.prototype.getProgram=function(){return this._program};Effect.prototype.getAttributesNames=function(){return this._attributesNames};Effect.prototype.getAttributeLocation=function(index){return this._attributes[index]};Effect.prototype.getAttributeLocationByName=function(name){var index=this._attributesNames.indexOf(name);return this._attributes[index]};Effect.prototype.getAttributesCount=function(){return this._attributes.length};Effect.prototype.getUniformIndex=function(uniformName){return this._uniformsNames.indexOf(uniformName)};Effect.prototype.getUniform=function(uniformName){return this._uniforms[this._uniformsNames.indexOf(uniformName)]};Effect.prototype.getSamplers=function(){return this._samplers};Effect.prototype.getCompilationError=function(){return this._compilationError};Effect.prototype.executeWhenCompiled=function(func){if(this.isReady()){func(this);return}this.onCompileObservable.add(function(effect){func(effect)})};Effect.prototype._loadVertexShader=function(vertex,callback){if(BABYLON.Tools.IsWindowObjectExist()){if(vertex instanceof HTMLElement){var vertexCode=BABYLON.Tools.GetDOMTextContent(vertex);callback(vertexCode);return}}if(vertex.substr(0,7)==="base64:"){var vertexBinary=window.atob(vertex.substr(7));callback(vertexBinary);return}if(Effect.ShadersStore[vertex+"VertexShader"]){callback(Effect.ShadersStore[vertex+"VertexShader"]);return}var vertexShaderUrl;if(vertex[0]==="."||vertex[0]==="/"||vertex.indexOf("http")>-1){vertexShaderUrl=vertex}else{vertexShaderUrl=BABYLON.Engine.ShadersRepository+vertex}BABYLON.Tools.LoadFile(vertexShaderUrl+".vertex.fx",callback)};Effect.prototype._loadFragmentShader=function(fragment,callback){if(BABYLON.Tools.IsWindowObjectExist()){if(fragment instanceof HTMLElement){var fragmentCode=BABYLON.Tools.GetDOMTextContent(fragment);callback(fragmentCode);return}}if(fragment.substr(0,7)==="base64:"){var fragmentBinary=window.atob(fragment.substr(7));callback(fragmentBinary);return}if(Effect.ShadersStore[fragment+"PixelShader"]){callback(Effect.ShadersStore[fragment+"PixelShader"]);return}if(Effect.ShadersStore[fragment+"FragmentShader"]){callback(Effect.ShadersStore[fragment+"FragmentShader"]);return}var fragmentShaderUrl;if(fragment[0]==="."||fragment[0]==="/"||fragment.indexOf("http")>-1){fragmentShaderUrl=fragment}else{fragmentShaderUrl=BABYLON.Engine.ShadersRepository+fragment}BABYLON.Tools.LoadFile(fragmentShaderUrl+".fragment.fx",callback)};Effect.prototype._dumpShadersSource=function(vertexCode,fragmentCode,defines){var shaderVersion=this._engine.webGLVersion>1?"#version 300 es\n":"";var prefix=shaderVersion+(defines?defines+"\n":"");vertexCode=prefix+vertexCode;fragmentCode=prefix+fragmentCode;var i=2;var regex=/\n/gm;var formattedVertexCode="\n1\t"+vertexCode.replace(regex,function(){return"\n"+i+++"\t"});i=2;var formattedFragmentCode="\n1\t"+fragmentCode.replace(regex,function(){return"\n"+i+++"\t"});if(this.name.vertexElement){BABYLON.Tools.Error("Vertex shader: "+this.name.vertexElement+formattedVertexCode);BABYLON.Tools.Error("Fragment shader: "+this.name.fragmentElement+formattedFragmentCode)}else if(this.name.vertex){BABYLON.Tools.Error("Vertex shader: "+this.name.vertex+formattedVertexCode);BABYLON.Tools.Error("Fragment shader: "+this.name.fragment+formattedFragmentCode)}else{BABYLON.Tools.Error("Vertex shader: "+this.name+formattedVertexCode);BABYLON.Tools.Error("Fragment shader: "+this.name+formattedFragmentCode)}};Effect.prototype._processShaderConversion=function(sourceCode,isFragment,callback){var preparedSourceCode=this._processPrecision(sourceCode);if(this._engine.webGLVersion==1){callback(preparedSourceCode);return}if(preparedSourceCode.indexOf("#version 3")!==-1){callback(preparedSourceCode.replace("#version 300 es",""));return}var hasDrawBuffersExtension=preparedSourceCode.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1;var regex=/#extension.+(GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;var result=preparedSourceCode.replace(regex,"");result=result.replace(/varying(?![\n\r])\s/g,isFragment?"in ":"out ");result=result.replace(/attribute[ \t]/g,"in ");result=result.replace(/[ \t]attribute/g," in");if(isFragment){result=result.replace(/texture2DLodEXT\s*\(/g,"textureLod(");result=result.replace(/textureCubeLodEXT\s*\(/g,"textureLod(");result=result.replace(/texture2D\s*\(/g,"texture(");result=result.replace(/textureCube\s*\(/g,"texture(");result=result.replace(/gl_FragDepthEXT/g,"gl_FragDepth");result=result.replace(/gl_FragColor/g,"glFragColor");result=result.replace(/gl_FragData/g,"glFragData");result=result.replace(/void\s+?main\s*\(/g,(hasDrawBuffersExtension?"":"out vec4 glFragColor;\n")+"void main(")}callback(result)};Effect.prototype._processIncludes=function(sourceCode,callback){var _this=this;var regex=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g;var match=regex.exec(sourceCode);var returnValue=new String(sourceCode);while(match!=null){var includeFile=match[1];if(includeFile.indexOf("__decl__")!==-1){includeFile=includeFile.replace(/__decl__/,"");if(this._engine.supportsUniformBuffers){includeFile=includeFile.replace(/Vertex/,"Ubo");includeFile=includeFile.replace(/Fragment/,"Ubo")}includeFile=includeFile+"Declaration"}if(Effect.IncludesShadersStore[includeFile]){var includeContent=Effect.IncludesShadersStore[includeFile];if(match[2]){var splits=match[3].split(",");for(var index=0;index<splits.length;index+=2){var source=new RegExp(splits[index],"g");var dest=splits[index+1];includeContent=includeContent.replace(source,dest)}}if(match[4]){var indexString=match[5];if(indexString.indexOf("..")!==-1){var indexSplits=indexString.split("..");var minIndex=parseInt(indexSplits[0]);var maxIndex=parseInt(indexSplits[1]);var sourceIncludeContent=includeContent.slice(0);includeContent="";if(isNaN(maxIndex)){maxIndex=this._indexParameters[indexSplits[1]]}for(var i=minIndex;i<maxIndex;i++){if(!this._engine.supportsUniformBuffers){sourceIncludeContent=sourceIncludeContent.replace(/light\{X\}.(\w*)/g,function(str,p1){return p1+"{X}"})}includeContent+=sourceIncludeContent.replace(/\{X\}/g,i.toString())+"\n"}}else{if(!this._engine.supportsUniformBuffers){includeContent=includeContent.replace(/light\{X\}.(\w*)/g,function(str,p1){return p1+"{X}"})}includeContent=includeContent.replace(/\{X\}/g,indexString)}}returnValue=returnValue.replace(match[0],includeContent)}else{var includeShaderUrl=BABYLON.Engine.ShadersRepository+"ShadersInclude/"+includeFile+".fx";BABYLON.Tools.LoadFile(includeShaderUrl,function(fileContent){Effect.IncludesShadersStore[includeFile]=fileContent;_this._processIncludes(returnValue,callback)});return}match=regex.exec(sourceCode)}callback(returnValue)};Effect.prototype._processPrecision=function(source){if(source.indexOf("precision highp float")===-1){if(!this._engine.getCaps().highPrecisionShaderSupported){source="precision mediump float;\n"+source}else{source="precision highp float;\n"+source}}else{if(!this._engine.getCaps().highPrecisionShaderSupported){source=source.replace("precision highp float","precision mediump float")}}return source};Effect.prototype._rebuildProgram=function(vertexSourceCode,fragmentSourceCode,onCompiled,onError){var _this=this;this._isReady=false;this._vertexSourceCodeOverride=vertexSourceCode;this._fragmentSourceCodeOverride=fragmentSourceCode;this.onError=function(effect,error){if(onError){onError(error)}};this.onCompiled=function(){var scenes=_this.getEngine().scenes;for(var i=0;i<scenes.length;i++){scenes[i].markAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)}if(onCompiled){onCompiled(_this._program)}};this._fallbacks=null;this._prepareEffect()};Effect.prototype._prepareEffect=function(){var attributesNames=this._attributesNames;var defines=this.defines;var fallbacks=this._fallbacks;this._valueCache={};var previousProgram=this._program;try{var engine=this._engine;if(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride){this._program=engine.createRawShaderProgram(this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride)}else{this._program=engine.createShaderProgram(this._vertexSourceCode,this._fragmentSourceCode,defines)}this._program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this);if(engine.webGLVersion>1){for(var name in this._uniformBuffersNames){this.bindUniformBlock(name,this._uniformBuffersNames[name])}}this._uniforms=engine.getUniforms(this._program,this._uniformsNames);this._attributes=engine.getAttributes(this._program,attributesNames);var index;for(index=0;index<this._samplers.length;index++){var sampler=this.getUniform(this._samplers[index]);if(sampler==null){this._samplers.splice(index,1);index--}}engine.bindSamplers(this);this._compilationError="";this._isReady=true;if(this.onCompiled){this.onCompiled(this)}this.onCompileObservable.notifyObservers(this);this.onCompileObservable.clear();if(this._fallbacks){this._fallbacks.unBindMesh()}if(previousProgram){this.getEngine()._deleteProgram(previousProgram)}}catch(e){this._compilationError=e.message;BABYLON.Tools.Error("Unable to compile effect:");BABYLON.Tools.Error("Uniforms: "+this._uniformsNames.map(function(uniform){return" "+uniform}));BABYLON.Tools.Error("Attributes: "+attributesNames.map(function(attribute){return" "+attribute}));this._dumpShadersSource(this._vertexSourceCode,this._fragmentSourceCode,defines);BABYLON.Tools.Error("Error: "+this._compilationError);if(previousProgram){this._program=previousProgram;this._isReady=true;if(this.onError){this.onError(this,this._compilationError)}this.onErrorObservable.notifyObservers(this)}if(fallbacks&&fallbacks.isMoreFallbacks){BABYLON.Tools.Error("Trying next fallback.");this.defines=fallbacks.reduce(this.defines);this._prepareEffect()}else{if(this.onError){this.onError(this,this._compilationError)}this.onErrorObservable.notifyObservers(this);this.onErrorObservable.clear();if(this._fallbacks){this._fallbacks.unBindMesh()}}}};Object.defineProperty(Effect.prototype,"isSupported",{get:function(){return this._compilationError===""},enumerable:true,configurable:true});Effect.prototype._bindTexture=function(channel,texture){this._engine._bindTexture(this._samplers.indexOf(channel),texture)};Effect.prototype.setTexture=function(channel,texture){this._engine.setTexture(this._samplers.indexOf(channel),this.getUniform(channel),texture)};Effect.prototype.setTextureArray=function(channel,textures){if(this._samplers.indexOf(channel+"Ex")===-1){var initialPos=this._samplers.indexOf(channel);for(var index=1;index<textures.length;index++){this._samplers.splice(initialPos+index,0,channel+"Ex")}}this._engine.setTextureArray(this._samplers.indexOf(channel),this.getUniform(channel),textures)};Effect.prototype.setTextureFromPostProcess=function(channel,postProcess){this._engine.setTextureFromPostProcess(this._samplers.indexOf(channel),postProcess)};Effect.prototype._cacheMatrix=function(uniformName,matrix){var cache=this._valueCache[uniformName];var flag=matrix.updateFlag;if(cache!==undefined&&cache===flag){return false}this._valueCache[uniformName]=flag;return true};Effect.prototype._cacheFloat2=function(uniformName,x,y){var cache=this._valueCache[uniformName];if(!cache){cache=[x,y];this._valueCache[uniformName]=cache;return true}var changed=false;if(cache[0]!==x){cache[0]=x;changed=true}if(cache[1]!==y){cache[1]=y;changed=true}return changed};Effect.prototype._cacheFloat3=function(uniformName,x,y,z){var cache=this._valueCache[uniformName];if(!cache){cache=[x,y,z];this._valueCache[uniformName]=cache;return true}var changed=false;if(cache[0]!==x){cache[0]=x;changed=true}if(cache[1]!==y){cache[1]=y;changed=true}if(cache[2]!==z){cache[2]=z;changed=true}return changed};Effect.prototype._cacheFloat4=function(uniformName,x,y,z,w){var cache=this._valueCache[uniformName];if(!cache){cache=[x,y,z,w];this._valueCache[uniformName]=cache;return true}var changed=false;if(cache[0]!==x){cache[0]=x;changed=true}if(cache[1]!==y){cache[1]=y;changed=true}if(cache[2]!==z){cache[2]=z;changed=true}if(cache[3]!==w){cache[3]=w;changed=true}return changed};Effect.prototype.bindUniformBuffer=function(buffer,name){if(Effect._baseCache[this._uniformBuffersNames[name]]===buffer){return}Effect._baseCache[this._uniformBuffersNames[name]]=buffer;this._engine.bindUniformBufferBase(buffer,this._uniformBuffersNames[name])};Effect.prototype.bindUniformBlock=function(blockName,index){this._engine.bindUniformBlock(this._program,blockName,index)};Effect.prototype.setIntArray=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setIntArray(this.getUniform(uniformName),array);return this};Effect.prototype.setIntArray2=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setIntArray2(this.getUniform(uniformName),array);return this};Effect.prototype.setIntArray3=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setIntArray3(this.getUniform(uniformName),array);return this};Effect.prototype.setIntArray4=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setIntArray4(this.getUniform(uniformName),array);return this};Effect.prototype.setFloatArray=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setFloatArray(this.getUniform(uniformName),array);return this};Effect.prototype.setFloatArray2=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setFloatArray2(this.getUniform(uniformName),array);return this};Effect.prototype.setFloatArray3=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setFloatArray3(this.getUniform(uniformName),array);return this};Effect.prototype.setFloatArray4=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setFloatArray4(this.getUniform(uniformName),array);return this};Effect.prototype.setArray=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setArray(this.getUniform(uniformName),array);return this};Effect.prototype.setArray2=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setArray2(this.getUniform(uniformName),array);return this};Effect.prototype.setArray3=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setArray3(this.getUniform(uniformName),array);return this};Effect.prototype.setArray4=function(uniformName,array){this._valueCache[uniformName]=null;this._engine.setArray4(this.getUniform(uniformName),array);return this};Effect.prototype.setMatrices=function(uniformName,matrices){if(!matrices){return this}this._valueCache[uniformName]=null;this._engine.setMatrices(this.getUniform(uniformName),matrices);return this};Effect.prototype.setMatrix=function(uniformName,matrix){if(this._cacheMatrix(uniformName,matrix)){this._engine.setMatrix(this.getUniform(uniformName),matrix)}return this};Effect.prototype.setMatrix3x3=function(uniformName,matrix){this._valueCache[uniformName]=null;this._engine.setMatrix3x3(this.getUniform(uniformName),matrix);return this};Effect.prototype.setMatrix2x2=function(uniformName,matrix){this._valueCache[uniformName]=null;this._engine.setMatrix2x2(this.getUniform(uniformName),matrix);return this};Effect.prototype.setFloat=function(uniformName,value){var cache=this._valueCache[uniformName];if(cache!==undefined&&cache===value)return this;this._valueCache[uniformName]=value;this._engine.setFloat(this.getUniform(uniformName),value);return this};Effect.prototype.setBool=function(uniformName,bool){var cache=this._valueCache[uniformName];if(cache!==undefined&&cache===bool)return this;this._valueCache[uniformName]=bool;this._engine.setBool(this.getUniform(uniformName),bool?1:0);return this};Effect.prototype.setVector2=function(uniformName,vector2){if(this._cacheFloat2(uniformName,vector2.x,vector2.y)){this._engine.setFloat2(this.getUniform(uniformName),vector2.x,vector2.y)}return this};Effect.prototype.setFloat2=function(uniformName,x,y){if(this._cacheFloat2(uniformName,x,y)){this._engine.setFloat2(this.getUniform(uniformName),x,y)}return this};Effect.prototype.setVector3=function(uniformName,vector3){if(this._cacheFloat3(uniformName,vector3.x,vector3.y,vector3.z)){this._engine.setFloat3(this.getUniform(uniformName),vector3.x,vector3.y,vector3.z)}return this};Effect.prototype.setFloat3=function(uniformName,x,y,z){if(this._cacheFloat3(uniformName,x,y,z)){this._engine.setFloat3(this.getUniform(uniformName),x,y,z)}return this};Effect.prototype.setVector4=function(uniformName,vector4){if(this._cacheFloat4(uniformName,vector4.x,vector4.y,vector4.z,vector4.w)){this._engine.setFloat4(this.getUniform(uniformName),vector4.x,vector4.y,vector4.z,vector4.w)}return this};Effect.prototype.setFloat4=function(uniformName,x,y,z,w){if(this._cacheFloat4(uniformName,x,y,z,w)){this._engine.setFloat4(this.getUniform(uniformName),x,y,z,w)}return this};Effect.prototype.setColor3=function(uniformName,color3){if(this._cacheFloat3(uniformName,color3.r,color3.g,color3.b)){this._engine.setColor3(this.getUniform(uniformName),color3)}return this};Effect.prototype.setColor4=function(uniformName,color3,alpha){if(this._cacheFloat4(uniformName,color3.r,color3.g,color3.b,alpha)){this._engine.setColor4(this.getUniform(uniformName),color3,alpha)}return this};Effect.ResetCache=function(){Effect._baseCache={}};Effect._uniqueIdSeed=0;Effect._baseCache={};Effect.ShadersStore={};Effect.IncludesShadersStore={};return Effect}();BABYLON.Effect=Effect})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MaterialHelper=function(){function MaterialHelper(){}MaterialHelper.PrepareDefinesForMergedUV=function(texture,defines,key){defines._needUVs=true;defines[key]=true;if(texture.getTextureMatrix().isIdentity(true)){defines[key+"DIRECTUV"]=texture.coordinatesIndex+1;if(texture.coordinatesIndex===0){defines["MAINUV1"]=true}else{defines["MAINUV2"]=true}}else{defines[key+"DIRECTUV"]=0}};MaterialHelper.BindTextureMatrix=function(texture,uniformBuffer,key){var matrix=texture.getTextureMatrix();if(!matrix.isIdentity(true)){uniformBuffer.updateMatrix(key+"Matrix",matrix)}};MaterialHelper.PrepareDefinesForMisc=function(mesh,scene,useLogarithmicDepth,pointsCloud,fogEnabled,defines){if(defines._areMiscDirty){defines["LOGARITHMICDEPTH"]=useLogarithmicDepth;defines["POINTSIZE"]=pointsCloud||scene.forcePointsCloud;defines["FOG"]=scene.fogEnabled&&mesh.applyFog&&scene.fogMode!==BABYLON.Scene.FOGMODE_NONE&&fogEnabled}};MaterialHelper.PrepareDefinesForFrameBoundValues=function(scene,engine,defines,useInstances,forceAlphaTest){if(forceAlphaTest===void 0){forceAlphaTest=false}var changed=false;if(defines["CLIPPLANE"]!==(scene.clipPlane!==undefined&&scene.clipPlane!==null)){defines["CLIPPLANE"]=!defines["CLIPPLANE"];changed=true}if(defines["ALPHATEST"]!==(engine.getAlphaTesting()||forceAlphaTest)){defines["ALPHATEST"]=!defines["ALPHATEST"];changed=true}if(defines["DEPTHPREPASS"]!==!engine.getColorWrite()){defines["DEPTHPREPASS"]=!defines["DEPTHPREPASS"];changed=true}if(defines["INSTANCES"]!==useInstances){defines["INSTANCES"]=useInstances;changed=true}if(changed){defines.markAsUnprocessed()}};MaterialHelper.PrepareDefinesForAttributes=function(mesh,defines,useVertexColor,useBones,useMorphTargets){if(useMorphTargets===void 0){useMorphTargets=false}if(!defines._areAttributesDirty&&defines._needNormals===defines._normals&&defines._needUVs===defines._uvs){return false}defines._normals=defines._needNormals;defines._uvs=defines._needUVs;defines["NORMAL"]=defines._needNormals&&mesh.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind);if(defines._needNormals&&mesh.isVerticesDataPresent(BABYLON.VertexBuffer.TangentKind)){defines["TANGENT"]=true}if(defines._needUVs){defines["UV1"]=mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind);defines["UV2"]=mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)}else{defines["UV1"]=false;defines["UV2"]=false}if(useVertexColor){defines["VERTEXCOLOR"]=mesh.useVertexColors&&mesh.isVerticesDataPresent(BABYLON.VertexBuffer.ColorKind);defines["VERTEXALPHA"]=mesh.hasVertexAlpha}if(useBones){if(mesh.useBones&&mesh.computeBonesUsingShaders){defines["NUM_BONE_INFLUENCERS"]=mesh.numBoneInfluencers;defines["BonesPerMesh"]=mesh.skeleton.bones.length+1}else{defines["NUM_BONE_INFLUENCERS"]=0;defines["BonesPerMesh"]=0}}if(useMorphTargets){if(mesh.morphTargetManager){var manager=mesh.morphTargetManager;defines["MORPHTARGETS_TANGENT"]=manager.supportsTangents&&defines["TANGENT"];defines["MORPHTARGETS_NORMAL"]=manager.supportsNormals&&defines["NORMAL"];defines["MORPHTARGETS"]=manager.numInfluencers>0;defines["NUM_MORPH_INFLUENCERS"]=manager.numInfluencers}else{defines["MORPHTARGETS_TANGENT"]=false;defines["MORPHTARGETS_NORMAL"]=false;defines["MORPHTARGETS"]=false;defines["NUM_MORPH_INFLUENCERS"]=0}}return true};MaterialHelper.PrepareDefinesForLights=function(scene,mesh,defines,specularSupported,maxSimultaneousLights,disableLighting){if(maxSimultaneousLights===void 0){maxSimultaneousLights=4}if(disableLighting===void 0){disableLighting=false}if(!defines._areLightsDirty){return defines._needNormals}var lightIndex=0;var needNormals=false;var needRebuild=false;var lightmapMode=false;var shadowEnabled=false;var specularEnabled=false;if(scene.lightsEnabled&&!disableLighting){for(var _i=0,_a=mesh._lightSources;_i<_a.length;_i++){var light=_a[_i];needNormals=true;if(defines["LIGHT"+lightIndex]===undefined){needRebuild=true}defines["LIGHT"+lightIndex]=true;defines["SPOTLIGHT"+lightIndex]=false;defines["HEMILIGHT"+lightIndex]=false;defines["POINTLIGHT"+lightIndex]=false;defines["DIRLIGHT"+lightIndex]=false;var type;if(light.getTypeID()===BABYLON.Light.LIGHTTYPEID_SPOTLIGHT){type="SPOTLIGHT"+lightIndex}else if(light.getTypeID()===BABYLON.Light.LIGHTTYPEID_HEMISPHERICLIGHT){type="HEMILIGHT"+lightIndex}else if(light.getTypeID()===BABYLON.Light.LIGHTTYPEID_POINTLIGHT){type="POINTLIGHT"+lightIndex}else{type="DIRLIGHT"+lightIndex}defines[type]=true;if(specularSupported&&!light.specular.equalsFloats(0,0,0)){specularEnabled=true}defines["SHADOW"+lightIndex]=false;defines["SHADOWPCF"+lightIndex]=false;defines["SHADOWESM"+lightIndex]=false;defines["SHADOWCUBE"+lightIndex]=false;if(mesh&&mesh.receiveShadows&&scene.shadowsEnabled&&light.shadowEnabled){var shadowGenerator=light.getShadowGenerator();if(shadowGenerator){shadowEnabled=true;shadowGenerator.prepareDefines(defines,lightIndex)}}if(light.lightmapMode!=BABYLON.Light.LIGHTMAP_DEFAULT){lightmapMode=true;defines["LIGHTMAPEXCLUDED"+lightIndex]=true;defines["LIGHTMAPNOSPECULAR"+lightIndex]=light.lightmapMode==BABYLON.Light.LIGHTMAP_SHADOWSONLY}else{defines["LIGHTMAPEXCLUDED"+lightIndex]=false;defines["LIGHTMAPNOSPECULAR"+lightIndex]=false}lightIndex++;if(lightIndex===maxSimultaneousLights)break}}defines["SPECULARTERM"]=specularEnabled;defines["SHADOWS"]=shadowEnabled;for(var index=lightIndex;index<maxSimultaneousLights;index++){if(defines["LIGHT"+index]!==undefined){defines["LIGHT"+index]=false;defines["HEMILIGHT"+lightIndex]=false;defines["POINTLIGHT"+lightIndex]=false;defines["DIRLIGHT"+lightIndex]=false;defines["SPOTLIGHT"+lightIndex]=false;defines["SHADOW"+lightIndex]=false}}var caps=scene.getEngine().getCaps();if(defines["SHADOWFLOAT"]===undefined){needRebuild=true}defines["SHADOWFLOAT"]=shadowEnabled&&(caps.textureFloatRender&&caps.textureFloatLinearFiltering||caps.textureHalfFloatRender&&caps.textureHalfFloatLinearFiltering);defines["LIGHTMAPEXCLUDED"]=lightmapMode;if(needRebuild){defines.rebuild()}return needNormals};MaterialHelper.PrepareUniformsAndSamplersList=function(uniformsListOrOptions,samplersList,defines,maxSimultaneousLights){if(maxSimultaneousLights===void 0){maxSimultaneousLights=4}var uniformsList,uniformBuffersList,samplersList,defines;if(uniformsListOrOptions.uniformsNames){var options=uniformsListOrOptions;uniformsList=options.uniformsNames;uniformBuffersList=options.uniformBuffersNames;samplersList=options.samplers;defines=options.defines;maxSimultaneousLights=options.maxSimultaneousLights}else{uniformsList=uniformsListOrOptions}for(var lightIndex=0;lightIndex<maxSimultaneousLights;lightIndex++){if(!defines["LIGHT"+lightIndex]){break}uniformsList.push("vLightData"+lightIndex,"vLightDiffuse"+lightIndex,"vLightSpecular"+lightIndex,"vLightDirection"+lightIndex,"vLightGround"+lightIndex,"lightMatrix"+lightIndex,"shadowsInfo"+lightIndex,"depthValues"+lightIndex);if(uniformBuffersList){uniformBuffersList.push("Light"+lightIndex)}samplersList.push("shadowSampler"+lightIndex)}if(defines["NUM_MORPH_INFLUENCERS"]){uniformsList.push("morphTargetInfluences")}};MaterialHelper.HandleFallbacksForShadows=function(defines,fallbacks,maxSimultaneousLights){if(maxSimultaneousLights===void 0){maxSimultaneousLights=4}if(!defines["SHADOWS"]){return}for(var lightIndex=0;lightIndex<maxSimultaneousLights;lightIndex++){if(!defines["LIGHT"+lightIndex]){break}if(lightIndex>0){fallbacks.addFallback(lightIndex,"LIGHT"+lightIndex)}if(defines["SHADOW"+lightIndex]){fallbacks.addFallback(0,"SHADOW"+lightIndex)}if(defines["SHADOWPCF"+lightIndex]){fallbacks.addFallback(0,"SHADOWPCF"+lightIndex)}if(defines["SHADOWESM"+lightIndex]){fallbacks.addFallback(0,"SHADOWESM"+lightIndex)}}};MaterialHelper.PrepareAttributesForMorphTargets=function(attribs,mesh,defines){var influencers=defines["NUM_MORPH_INFLUENCERS"];if(influencers>0){var maxAttributesCount=BABYLON.Engine.LastCreatedEngine.getCaps().maxVertexAttribs;var manager=mesh.morphTargetManager;var normal=manager.supportsNormals&&defines["NORMAL"];var tangent=manager.supportsTangents&&defines["TANGENT"];for(var index=0;index<influencers;index++){attribs.push(BABYLON.VertexBuffer.PositionKind+index);if(normal){attribs.push(BABYLON.VertexBuffer.NormalKind+index)}if(tangent){attribs.push(BABYLON.VertexBuffer.TangentKind+index)}if(attribs.length>maxAttributesCount){BABYLON.Tools.Error("Cannot add more vertex attributes for mesh "+mesh.name)}}}};MaterialHelper.PrepareAttributesForBones=function(attribs,mesh,defines,fallbacks){if(defines["NUM_BONE_INFLUENCERS"]>0){fallbacks.addCPUSkinningFallback(0,mesh);attribs.push(BABYLON.VertexBuffer.MatricesIndicesKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsKind);if(defines["NUM_BONE_INFLUENCERS"]>4){attribs.push(BABYLON.VertexBuffer.MatricesIndicesExtraKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsExtraKind)}}};MaterialHelper.PrepareAttributesForInstances=function(attribs,defines){if(defines["INSTANCES"]){attribs.push("world0");attribs.push("world1");attribs.push("world2");attribs.push("world3")}};MaterialHelper.BindLightShadow=function(light,scene,mesh,lightIndex,effect){if(light.shadowEnabled&&mesh.receiveShadows){var shadowGenerator=light.getShadowGenerator();if(shadowGenerator){shadowGenerator.bindShadowLight(lightIndex,effect)}}};MaterialHelper.BindLightProperties=function(light,effect,lightIndex){light.transferToEffect(effect,lightIndex+"")};MaterialHelper.BindLights=function(scene,mesh,effect,defines,maxSimultaneousLights,usePhysicalLightFalloff){if(maxSimultaneousLights===void 0){maxSimultaneousLights=4}if(usePhysicalLightFalloff===void 0){usePhysicalLightFalloff=false}var lightIndex=0;for(var _i=0,_a=mesh._lightSources;_i<_a.length;_i++){var light=_a[_i];var scaledIntensity=light.getScaledIntensity();light._uniformBuffer.bindToEffect(effect,"Light"+lightIndex);MaterialHelper.BindLightProperties(light,effect,lightIndex);light.diffuse.scaleToRef(scaledIntensity,BABYLON.Tmp.Color3[0]);light._uniformBuffer.updateColor4("vLightDiffuse",BABYLON.Tmp.Color3[0],usePhysicalLightFalloff?light.radius:light.range,lightIndex+"");if(defines["SPECULARTERM"]){light.specular.scaleToRef(scaledIntensity,BABYLON.Tmp.Color3[1]);light._uniformBuffer.updateColor3("vLightSpecular",BABYLON.Tmp.Color3[1],lightIndex+"")}if(scene.shadowsEnabled){this.BindLightShadow(light,scene,mesh,lightIndex+"",effect)}light._uniformBuffer.update();lightIndex++;if(lightIndex===maxSimultaneousLights)break}};MaterialHelper.BindFogParameters=function(scene,mesh,effect){if(scene.fogEnabled&&mesh.applyFog&&scene.fogMode!==BABYLON.Scene.FOGMODE_NONE){effect.setFloat4("vFogInfos",scene.fogMode,scene.fogStart,scene.fogEnd,scene.fogDensity);effect.setColor3("vFogColor",scene.fogColor)}};MaterialHelper.BindBonesParameters=function(mesh,effect){if(mesh&&mesh.useBones&&mesh.computeBonesUsingShaders){var matrices=mesh.skeleton.getTransformMatrices(mesh);if(matrices){effect.setMatrices("mBones",matrices)}}};MaterialHelper.BindMorphTargetParameters=function(abstractMesh,effect){if(!abstractMesh||!abstractMesh.morphTargetManager){return}effect.setFloatArray("morphTargetInfluences",abstractMesh.morphTargetManager.influences)};MaterialHelper.BindLogDepth=function(defines,effect,scene){if(defines["LOGARITHMICDEPTH"]){effect.setFloat("logarithmicDepthConstant",2/(Math.log(scene.activeCamera.maxZ+1)/Math.LN2))}};MaterialHelper.BindClipPlane=function(effect,scene){if(scene.clipPlane){var clipPlane=scene.clipPlane;effect.setFloat4("vClipPlane",clipPlane.normal.x,clipPlane.normal.y,clipPlane.normal.z,clipPlane.d)}};return MaterialHelper}();BABYLON.MaterialHelper=MaterialHelper})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MaterialDefines=function(){function MaterialDefines(){this._isDirty=true;this._areLightsDirty=true;this._areAttributesDirty=true;this._areTexturesDirty=true;this._areFresnelDirty=true;this._areMiscDirty=true;this._areImageProcessingDirty=true;this._normals=false;this._uvs=false;this._needNormals=false;this._needUVs=false}Object.defineProperty(MaterialDefines.prototype,"isDirty",{get:function(){return this._isDirty},enumerable:true,configurable:true});MaterialDefines.prototype.markAsProcessed=function(){this._isDirty=false;this._areAttributesDirty=false;this._areTexturesDirty=false;this._areFresnelDirty=false;this._areLightsDirty=false;this._areMiscDirty=false;this._areImageProcessingDirty=false};MaterialDefines.prototype.markAsUnprocessed=function(){this._isDirty=true};MaterialDefines.prototype.markAllAsDirty=function(){this._areTexturesDirty=true;this._areAttributesDirty=true;this._areLightsDirty=true;this._areFresnelDirty=true;this._areMiscDirty=true;this._areImageProcessingDirty=true;this._isDirty=true};MaterialDefines.prototype.markAsImageProcessingDirty=function(){this._areImageProcessingDirty=true;this._isDirty=true};MaterialDefines.prototype.markAsLightDirty=function(){this._areLightsDirty=true;this._isDirty=true};MaterialDefines.prototype.markAsAttributesDirty=function(){this._areAttributesDirty=true;this._isDirty=true};MaterialDefines.prototype.markAsTexturesDirty=function(){this._areTexturesDirty=true;this._isDirty=true};MaterialDefines.prototype.markAsFresnelDirty=function(){this._areFresnelDirty=true;this._isDirty=true};MaterialDefines.prototype.markAsMiscDirty=function(){this._areMiscDirty=true;this._isDirty=true};MaterialDefines.prototype.rebuild=function(){if(this._keys){delete this._keys}this._keys=[];for(var _i=0,_a=Object.keys(this);_i<_a.length;_i++){var key=_a[_i];if(key[0]==="_"){continue}this._keys.push(key)}};MaterialDefines.prototype.isEqual=function(other){if(this._keys.length!==other._keys.length){return false}for(var index=0;index<this._keys.length;index++){var prop=this._keys[index];if(this[prop]!==other[prop]){return false}}return true};MaterialDefines.prototype.cloneTo=function(other){if(this._keys.length!==other._keys.length){other._keys=this._keys.slice(0)}for(var index=0;index<this._keys.length;index++){var prop=this._keys[index];other[prop]=this[prop]}};MaterialDefines.prototype.reset=function(){for(var index=0;index<this._keys.length;index++){var prop=this._keys[index];if(typeof this[prop]==="number"){this[prop]=0}else{this[prop]=false}}};MaterialDefines.prototype.toString=function(){var result="";for(var index=0;index<this._keys.length;index++){var prop=this._keys[index];var value=this[prop];if(typeof value==="number"){result+="#define "+prop+" "+this[prop]+"\n"}else if(value){result+="#define "+prop+"\n"}}return result};return MaterialDefines}();BABYLON.MaterialDefines=MaterialDefines;var Material=function(){function Material(name,scene,doNotAdd){this.checkReadyOnEveryCall=false;this.checkReadyOnlyOnce=false;this.state="";this.alpha=1;this._backFaceCulling=true;this.doNotSerialize=false;this.storeEffectOnSubMeshes=false;this.onDisposeObservable=new BABYLON.Observable;this.onBindObservable=new BABYLON.Observable;this.onUnBindObservable=new BABYLON.Observable;this.alphaMode=BABYLON.Engine.ALPHA_COMBINE;this._needDepthPrePass=false;this.disableDepthWrite=false;this.forceDepthWrite=false;this.separateCullingPass=false;this._fogEnabled=true;this.pointSize=1;this.zOffset=0;this._wasPreviouslyReady=false;this._fillMode=Material.TriangleFillMode;this.name=name;this.id=name||BABYLON.Tools.RandomId();this._scene=scene||BABYLON.Engine.LastCreatedScene;if(this._scene.useRightHandedSystem){this.sideOrientation=Material.ClockWiseSideOrientation}else{this.sideOrientation=Material.CounterClockWiseSideOrientation}this._uniformBuffer=new BABYLON.UniformBuffer(this._scene.getEngine());this._useUBO=this.getScene().getEngine().supportsUniformBuffers;if(!doNotAdd){this._scene.materials.push(this)}}Object.defineProperty(Material,"TriangleFillMode",{get:function(){return Material._TriangleFillMode},enumerable:true,configurable:true});Object.defineProperty(Material,"WireFrameFillMode",{get:function(){return Material._WireFrameFillMode},enumerable:true,configurable:true});Object.defineProperty(Material,"PointFillMode",{get:function(){return Material._PointFillMode},enumerable:true,configurable:true});Object.defineProperty(Material,"ClockWiseSideOrientation",{get:function(){return Material._ClockWiseSideOrientation},enumerable:true,configurable:true});Object.defineProperty(Material,"CounterClockWiseSideOrientation",{get:function(){return Material._CounterClockWiseSideOrientation},enumerable:true,configurable:true});Object.defineProperty(Material,"TextureDirtyFlag",{get:function(){return Material._TextureDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(Material,"LightDirtyFlag",{get:function(){return Material._LightDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(Material,"FresnelDirtyFlag",{get:function(){return Material._FresnelDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(Material,"AttributesDirtyFlag",{get:function(){return Material._AttributesDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(Material,"MiscDirtyFlag",{get:function(){return Material._MiscDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(Material.prototype,"backFaceCulling",{get:function(){return this._backFaceCulling},set:function(value){if(this._backFaceCulling===value){return}this._backFaceCulling=value;this.markAsDirty(Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Material.prototype,"onDispose",{set:function(callback){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Material.prototype,"onBind",{set:function(callback){if(this._onBindObserver){this.onBindObservable.remove(this._onBindObserver)}this._onBindObserver=this.onBindObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Material.prototype,"needDepthPrePass",{get:function(){return this._needDepthPrePass},set:function(value){if(this._needDepthPrePass===value){return}this._needDepthPrePass=value;if(this._needDepthPrePass){this.checkReadyOnEveryCall=true}},enumerable:true,configurable:true});Object.defineProperty(Material.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(value){if(this._fogEnabled===value){return}this._fogEnabled=value;this.markAsDirty(Material.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(Material.prototype,"wireframe",{get:function(){return this._fillMode===Material.WireFrameFillMode},set:function(value){this._fillMode=value?Material.WireFrameFillMode:Material.TriangleFillMode},enumerable:true,configurable:true});Object.defineProperty(Material.prototype,"pointsCloud",{get:function(){return this._fillMode===Material.PointFillMode},set:function(value){this._fillMode=value?Material.PointFillMode:Material.TriangleFillMode},enumerable:true,configurable:true});Object.defineProperty(Material.prototype,"fillMode",{get:function(){return this._fillMode},set:function(value){if(this._fillMode===value){return}this._fillMode=value;this.markAsDirty(Material.MiscDirtyFlag)},enumerable:true,configurable:true});Material.prototype.toString=function(fullDetails){var ret="Name: "+this.name;if(fullDetails){}return ret};Material.prototype.getClassName=function(){return"Material"};Object.defineProperty(Material.prototype,"isFrozen",{get:function(){return this.checkReadyOnlyOnce},enumerable:true,configurable:true});Material.prototype.freeze=function(){this.checkReadyOnlyOnce=true};Material.prototype.unfreeze=function(){this.checkReadyOnlyOnce=false};Material.prototype.isReady=function(mesh,useInstances){return true};Material.prototype.isReadyForSubMesh=function(mesh,subMesh,useInstances){return false};Material.prototype.getEffect=function(){return this._effect};Material.prototype.getScene=function(){return this._scene};Material.prototype.needAlphaBlending=function(){return this.alpha<1};Material.prototype.needAlphaTesting=function(){return false};Material.prototype.getAlphaTestTexture=function(){return null};Material.prototype.markDirty=function(){this._wasPreviouslyReady=false};Material.prototype._preBind=function(effect,overrideOrientation){var engine=this._scene.getEngine();var orientation=overrideOrientation==null?this.sideOrientation:overrideOrientation;var reverse=orientation===Material.ClockWiseSideOrientation;engine.enableEffect(effect?effect:this._effect);engine.setState(this.backFaceCulling,this.zOffset,false,reverse);return reverse};Material.prototype.bind=function(world,mesh){};Material.prototype.bindForSubMesh=function(world,mesh,subMesh){};Material.prototype.bindOnlyWorldMatrix=function(world){};Material.prototype.bindSceneUniformBuffer=function(effect,sceneUbo){sceneUbo.bindToEffect(effect,"Scene")};Material.prototype.bindView=function(effect){if(!this._useUBO){effect.setMatrix("view",this.getScene().getViewMatrix())}else{this.bindSceneUniformBuffer(effect,this.getScene().getSceneUniformBuffer())}};Material.prototype.bindViewProjection=function(effect){if(!this._useUBO){effect.setMatrix("viewProjection",this.getScene().getTransformMatrix())}else{this.bindSceneUniformBuffer(effect,this.getScene().getSceneUniformBuffer())}};Material.prototype._afterBind=function(mesh){this._scene._cachedMaterial=this;if(mesh){this._scene._cachedVisibility=mesh.visibility}else{this._scene._cachedVisibility=1}this.onBindObservable.notifyObservers(mesh);if(this.disableDepthWrite){var engine=this._scene.getEngine();this._cachedDepthWriteState=engine.getDepthWrite();engine.setDepthWrite(false)}};Material.prototype.unbind=function(){this.onUnBindObservable.notifyObservers(this);if(this.disableDepthWrite){var engine=this._scene.getEngine();engine.setDepthWrite(this._cachedDepthWriteState)}};Material.prototype.getActiveTextures=function(){return[]};Material.prototype.hasTexture=function(texture){return false};Material.prototype.clone=function(name){return null};Material.prototype.getBindedMeshes=function(){var result=new Array;for(var index=0;index<this._scene.meshes.length;index++){var mesh=this._scene.meshes[index];if(mesh.material===this){result.push(mesh)}}return result};Material.prototype.forceCompilation=function(mesh,onCompiled,options){var _this=this;var subMesh=new BABYLON.BaseSubMesh;var scene=this.getScene();var engine=scene.getEngine();var checkReady=function(){if(!_this._scene||!_this._scene.getEngine()){return}if(subMesh._materialDefines){subMesh._materialDefines._renderId=-1}var alphaTestState=engine.getAlphaTesting();var clipPlaneState=scene.clipPlane;engine.setAlphaTesting(options?options.alphaTest:_this.needAlphaTesting());if(options&&options.clipPlane){scene.clipPlane=new BABYLON.Plane(0,0,0,1)}if(_this.storeEffectOnSubMeshes){if(_this.isReadyForSubMesh(mesh,subMesh)){if(onCompiled){onCompiled(_this)}}else{setTimeout(checkReady,16)}}else{if(_this.isReady(mesh)){if(onCompiled){onCompiled(_this)}}else{setTimeout(checkReady,16)}}engine.setAlphaTesting(alphaTestState);if(options&&options.clipPlane){scene.clipPlane=clipPlaneState}};checkReady()};Material.prototype.markAsDirty=function(flag){if(flag&Material.TextureDirtyFlag){this._markAllSubMeshesAsTexturesDirty()}if(flag&Material.LightDirtyFlag){this._markAllSubMeshesAsLightsDirty()}if(flag&Material.FresnelDirtyFlag){this._markAllSubMeshesAsFresnelDirty()}if(flag&Material.AttributesDirtyFlag){this._markAllSubMeshesAsAttributesDirty()}if(flag&Material.MiscDirtyFlag){this._markAllSubMeshesAsMiscDirty()}this.getScene().resetCachedMaterial()};Material.prototype._markAllSubMeshesAsDirty=function(func){for(var _i=0,_a=this.getScene().meshes;_i<_a.length;_i++){var mesh=_a[_i];if(!mesh.subMeshes){continue}for(var _b=0,_c=mesh.subMeshes;_b<_c.length;_b++){var subMesh=_c[_b];if(subMesh.getMaterial()!==this){continue}if(!subMesh._materialDefines){continue}func(subMesh._materialDefines)}}};Material.prototype._markAllSubMeshesAsImageProcessingDirty=function(){this._markAllSubMeshesAsDirty(function(defines){return defines.markAsImageProcessingDirty()})};Material.prototype._markAllSubMeshesAsTexturesDirty=function(){this._markAllSubMeshesAsDirty(function(defines){return defines.markAsTexturesDirty()})};Material.prototype._markAllSubMeshesAsFresnelDirty=function(){this._markAllSubMeshesAsDirty(function(defines){return defines.markAsFresnelDirty()})};Material.prototype._markAllSubMeshesAsLightsDirty=function(){this._markAllSubMeshesAsDirty(function(defines){return defines.markAsLightDirty()})};Material.prototype._markAllSubMeshesAsAttributesDirty=function(){this._markAllSubMeshesAsDirty(function(defines){return defines.markAsAttributesDirty()})};Material.prototype._markAllSubMeshesAsMiscDirty=function(){this._markAllSubMeshesAsDirty(function(defines){return defines.markAsMiscDirty()})};Material.prototype.dispose=function(forceDisposeEffect,forceDisposeTextures){this.getScene().stopAnimation(this);var index=this._scene.materials.indexOf(this);if(index>=0){this._scene.materials.splice(index,1)}for(index=0;index<this._scene.meshes.length;index++){var mesh=this._scene.meshes[index];if(mesh.material===this){mesh.material=null;if(mesh.geometry){var geometry=mesh.geometry;if(this.storeEffectOnSubMeshes){for(var _i=0,_a=mesh.subMeshes;_i<_a.length;_i++){var subMesh=_a[_i];geometry._releaseVertexArrayObject(subMesh._materialEffect)}}else{geometry._releaseVertexArrayObject(this._effect)}}}}this._uniformBuffer.dispose();if(forceDisposeEffect&&this._effect){if(this.storeEffectOnSubMeshes){for(var _b=0,_c=mesh.subMeshes;_b<_c.length;_b++){var subMesh=_c[_b];this._scene.getEngine()._releaseEffect(subMesh._materialEffect)}}else{this._scene.getEngine()._releaseEffect(this._effect)}this._effect=null}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBindObservable.clear();this.onUnBindObservable.clear()};Material.prototype.serialize=function(){return BABYLON.SerializationHelper.Serialize(this)};Material.ParseMultiMaterial=function(parsedMultiMaterial,scene){var multiMaterial=new BABYLON.MultiMaterial(parsedMultiMaterial.name,scene);multiMaterial.id=parsedMultiMaterial.id;if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(multiMaterial,parsedMultiMaterial.tags)}for(var matIndex=0;matIndex<parsedMultiMaterial.materials.length;matIndex++){var subMatId=parsedMultiMaterial.materials[matIndex];if(subMatId){multiMaterial.subMaterials.push(scene.getMaterialByID(subMatId))}else{multiMaterial.subMaterials.push(null)}}return multiMaterial};Material.Parse=function(parsedMaterial,scene,rootUrl){if(!parsedMaterial.customType){return BABYLON.StandardMaterial.Parse(parsedMaterial,scene,rootUrl)}if(parsedMaterial.customType==="BABYLON.PBRMaterial"&&parsedMaterial.overloadedAlbedo){parsedMaterial.customType="BABYLON.LegacyPBRMaterial";if(!BABYLON.LegacyPBRMaterial){BABYLON.Tools.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library.");return}}var materialType=BABYLON.Tools.Instantiate(parsedMaterial.customType);return materialType.Parse(parsedMaterial,scene,rootUrl)};Material._TriangleFillMode=0;Material._WireFrameFillMode=1;Material._PointFillMode=2;Material._ClockWiseSideOrientation=0;Material._CounterClockWiseSideOrientation=1;Material._TextureDirtyFlag=1;Material._LightDirtyFlag=2;Material._FresnelDirtyFlag=4;Material._AttributesDirtyFlag=8;Material._MiscDirtyFlag=16;__decorate([BABYLON.serialize()],Material.prototype,"id",void 0);__decorate([BABYLON.serialize()],Material.prototype,"name",void 0);__decorate([BABYLON.serialize()],Material.prototype,"checkReadyOnEveryCall",void 0);__decorate([BABYLON.serialize()],Material.prototype,"checkReadyOnlyOnce",void 0);__decorate([BABYLON.serialize()],Material.prototype,"state",void 0);__decorate([BABYLON.serialize()],Material.prototype,"alpha",void 0);__decorate([BABYLON.serialize("backFaceCulling")],Material.prototype,"_backFaceCulling",void 0);__decorate([BABYLON.serialize()],Material.prototype,"sideOrientation",void 0);__decorate([BABYLON.serialize()],Material.prototype,"alphaMode",void 0);__decorate([BABYLON.serialize()],Material.prototype,"_needDepthPrePass",void 0);__decorate([BABYLON.serialize()],Material.prototype,"disableDepthWrite",void 0);__decorate([BABYLON.serialize()],Material.prototype,"forceDepthWrite",void 0);__decorate([BABYLON.serialize()],Material.prototype,"separateCullingPass",void 0);__decorate([BABYLON.serialize("fogEnabled")],Material.prototype,"_fogEnabled",void 0);__decorate([BABYLON.serialize()],Material.prototype,"pointSize",void 0);__decorate([BABYLON.serialize()],Material.prototype,"zOffset",void 0);__decorate([BABYLON.serialize()],Material.prototype,"wireframe",null);__decorate([BABYLON.serialize()],Material.prototype,"pointsCloud",null);__decorate([BABYLON.serialize()],Material.prototype,"fillMode",null);return Material}();BABYLON.Material=Material})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var UniformBuffer=function(){function UniformBuffer(engine,data,dynamic){this._engine=engine;this._noUBO=!engine.supportsUniformBuffers;this._dynamic=dynamic;this._data=data||[];this._uniformLocations={};this._uniformSizes={};this._uniformLocationPointer=0;this._needSync=false;if(this._noUBO){this.updateMatrix3x3=this._updateMatrix3x3ForEffect;this.updateMatrix2x2=this._updateMatrix2x2ForEffect;this.updateFloat=this._updateFloatForEffect;this.updateFloat2=this._updateFloat2ForEffect;this.updateFloat3=this._updateFloat3ForEffect;this.updateFloat4=this._updateFloat4ForEffect;this.updateMatrix=this._updateMatrixForEffect;this.updateVector3=this._updateVector3ForEffect;this.updateVector4=this._updateVector4ForEffect;this.updateColor3=this._updateColor3ForEffect;this.updateColor4=this._updateColor4ForEffect}else{this._engine._uniformBuffers.push(this);this.updateMatrix3x3=this._updateMatrix3x3ForUniform;this.updateMatrix2x2=this._updateMatrix2x2ForUniform;this.updateFloat=this._updateFloatForUniform;this.updateFloat2=this._updateFloat2ForUniform;this.updateFloat3=this._updateFloat3ForUniform;this.updateFloat4=this._updateFloat4ForUniform;this.updateMatrix=this._updateMatrixForUniform;this.updateVector3=this._updateVector3ForUniform;this.updateVector4=this._updateVector4ForUniform;this.updateColor3=this._updateColor3ForUniform;this.updateColor4=this._updateColor4ForUniform}}Object.defineProperty(UniformBuffer.prototype,"useUbo",{get:function(){return!this._noUBO},enumerable:true,configurable:true});Object.defineProperty(UniformBuffer.prototype,"isSync",{get:function(){return!this._needSync},enumerable:true,configurable:true});UniformBuffer.prototype.isDynamic=function(){return this._dynamic};UniformBuffer.prototype.getData=function(){return this._bufferData};UniformBuffer.prototype.getBuffer=function(){return this._buffer};UniformBuffer.prototype._fillAlignment=function(size){var alignment;if(size<=2){alignment=size}else{alignment=4}if(this._uniformLocationPointer%alignment!==0){var oldPointer=this._uniformLocationPointer;this._uniformLocationPointer+=alignment-this._uniformLocationPointer%alignment;var diff=this._uniformLocationPointer-oldPointer;for(var i=0;i<diff;i++){this._data.push(0)}}};UniformBuffer.prototype.addUniform=function(name,size){if(this._noUBO){return}if(this._uniformLocations[name]!==undefined){return}var data;if(size instanceof Array){data=size;size=data.length}else{size=size;data=[];for(var i=0;i<size;i++){data.push(0)}}this._fillAlignment(size);this._uniformSizes[name]=size;this._uniformLocations[name]=this._uniformLocationPointer;this._uniformLocationPointer+=size;for(var i=0;i<size;i++){this._data.push(data[i])}this._needSync=true};UniformBuffer.prototype.addMatrix=function(name,mat){this.addUniform(name,Array.prototype.slice.call(mat.toArray()))};UniformBuffer.prototype.addFloat2=function(name,x,y){var temp=[x,y];this.addUniform(name,temp)};UniformBuffer.prototype.addFloat3=function(name,x,y,z){var temp=[x,y,z];this.addUniform(name,temp)};UniformBuffer.prototype.addColor3=function(name,color){var temp=new Array;color.toArray(temp);this.addUniform(name,temp)};UniformBuffer.prototype.addColor4=function(name,color,alpha){var temp=new Array;color.toArray(temp);temp.push(alpha);this.addUniform(name,temp)};UniformBuffer.prototype.addVector3=function(name,vector){var temp=new Array;vector.toArray(temp);this.addUniform(name,temp)};UniformBuffer.prototype.addMatrix3x3=function(name){this.addUniform(name,12)};UniformBuffer.prototype.addMatrix2x2=function(name){this.addUniform(name,8)};UniformBuffer.prototype.create=function(){if(this._noUBO){return}if(this._buffer){return}this._fillAlignment(4);this._bufferData=new Float32Array(this._data);this._rebuild();this._needSync=true};UniformBuffer.prototype._rebuild=function(){if(this._noUBO){return}if(this._dynamic){this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData)}else{this._buffer=this._engine.createUniformBuffer(this._bufferData)}};UniformBuffer.prototype.update=function(){if(!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){return}this._engine.updateUniformBuffer(this._buffer,this._bufferData);this._needSync=false};UniformBuffer.prototype.updateUniform=function(uniformName,data,size){var location=this._uniformLocations[uniformName];if(location===undefined){if(this._buffer){BABYLON.Tools.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(uniformName,size);location=this._uniformLocations[uniformName]}if(!this._buffer){this.create()}if(!this._dynamic){var changed=false;for(var i=0;i<size;i++){if(this._bufferData[location+i]!==data[i]){changed=true;this._bufferData[location+i]=data[i]}}this._needSync=this._needSync||changed}else{for(var i=0;i<size;i++){this._bufferData[location+i]=data[i]}}};UniformBuffer.prototype._updateMatrix3x3ForUniform=function(name,matrix){for(var i=0;i<3;i++){UniformBuffer._tempBuffer[i*4]=matrix[i*3];UniformBuffer._tempBuffer[i*4+1]=matrix[i*3+1];UniformBuffer._tempBuffer[i*4+2]=matrix[i*3+2];UniformBuffer._tempBuffer[i*4+3]=0}this.updateUniform(name,UniformBuffer._tempBuffer,12)};UniformBuffer.prototype._updateMatrix3x3ForEffect=function(name,matrix){this._currentEffect.setMatrix3x3(name,matrix)};UniformBuffer.prototype._updateMatrix2x2ForEffect=function(name,matrix){this._currentEffect.setMatrix2x2(name,matrix)};UniformBuffer.prototype._updateMatrix2x2ForUniform=function(name,matrix){for(var i=0;i<2;i++){UniformBuffer._tempBuffer[i*4]=matrix[i*2];UniformBuffer._tempBuffer[i*4+1]=matrix[i*2+1];UniformBuffer._tempBuffer[i*4+2]=0;UniformBuffer._tempBuffer[i*4+3]=0}this.updateUniform(name,UniformBuffer._tempBuffer,8)};UniformBuffer.prototype._updateFloatForEffect=function(name,x){this._currentEffect.setFloat(name,x)};UniformBuffer.prototype._updateFloatForUniform=function(name,x){UniformBuffer._tempBuffer[0]=x;this.updateUniform(name,UniformBuffer._tempBuffer,1)};UniformBuffer.prototype._updateFloat2ForEffect=function(name,x,y,suffix){if(suffix===void 0){suffix=""}this._currentEffect.setFloat2(name+suffix,x,y)};UniformBuffer.prototype._updateFloat2ForUniform=function(name,x,y,suffix){if(suffix===void 0){suffix=""}UniformBuffer._tempBuffer[0]=x;UniformBuffer._tempBuffer[1]=y;this.updateUniform(name,UniformBuffer._tempBuffer,2)};UniformBuffer.prototype._updateFloat3ForEffect=function(name,x,y,z,suffix){if(suffix===void 0){suffix=""}this._currentEffect.setFloat3(name+suffix,x,y,z)};UniformBuffer.prototype._updateFloat3ForUniform=function(name,x,y,z,suffix){if(suffix===void 0){suffix=""}UniformBuffer._tempBuffer[0]=x;UniformBuffer._tempBuffer[1]=y;UniformBuffer._tempBuffer[2]=z;this.updateUniform(name,UniformBuffer._tempBuffer,3)};UniformBuffer.prototype._updateFloat4ForEffect=function(name,x,y,z,w,suffix){if(suffix===void 0){suffix=""}this._currentEffect.setFloat4(name+suffix,x,y,z,w)};UniformBuffer.prototype._updateFloat4ForUniform=function(name,x,y,z,w,suffix){if(suffix===void 0){suffix=""}UniformBuffer._tempBuffer[0]=x;UniformBuffer._tempBuffer[1]=y;UniformBuffer._tempBuffer[2]=z;UniformBuffer._tempBuffer[3]=w;this.updateUniform(name,UniformBuffer._tempBuffer,4)};UniformBuffer.prototype._updateMatrixForEffect=function(name,mat){this._currentEffect.setMatrix(name,mat)};UniformBuffer.prototype._updateMatrixForUniform=function(name,mat){this.updateUniform(name,mat.toArray(),16)};UniformBuffer.prototype._updateVector3ForEffect=function(name,vector){this._currentEffect.setVector3(name,vector)};UniformBuffer.prototype._updateVector3ForUniform=function(name,vector){vector.toArray(UniformBuffer._tempBuffer);this.updateUniform(name,UniformBuffer._tempBuffer,3)};UniformBuffer.prototype._updateVector4ForEffect=function(name,vector){this._currentEffect.setVector4(name,vector)};UniformBuffer.prototype._updateVector4ForUniform=function(name,vector){vector.toArray(UniformBuffer._tempBuffer);this.updateUniform(name,UniformBuffer._tempBuffer,4)};UniformBuffer.prototype._updateColor3ForEffect=function(name,color,suffix){if(suffix===void 0){suffix=""}this._currentEffect.setColor3(name+suffix,color)};UniformBuffer.prototype._updateColor3ForUniform=function(name,color,suffix){if(suffix===void 0){suffix=""}color.toArray(UniformBuffer._tempBuffer);this.updateUniform(name,UniformBuffer._tempBuffer,3)};UniformBuffer.prototype._updateColor4ForEffect=function(name,color,alpha,suffix){if(suffix===void 0){suffix=""}this._currentEffect.setColor4(name+suffix,color,alpha)};UniformBuffer.prototype._updateColor4ForUniform=function(name,color,alpha,suffix){if(suffix===void 0){suffix=""}color.toArray(UniformBuffer._tempBuffer);UniformBuffer._tempBuffer[3]=alpha;this.updateUniform(name,UniformBuffer._tempBuffer,4)};UniformBuffer.prototype.setTexture=function(name,texture){this._currentEffect.setTexture(name,texture)};UniformBuffer.prototype.updateUniformDirectly=function(uniformName,data){this.updateUniform(uniformName,data,data.length);this.update()};UniformBuffer.prototype.bindToEffect=function(effect,name){this._currentEffect=effect;if(this._noUBO){return}effect.bindUniformBuffer(this._buffer,name)};UniformBuffer.prototype.dispose=function(){if(this._noUBO){return}var index=this._engine._uniformBuffers.indexOf(this);if(index!==-1){this._engine._uniformBuffers.splice(index,1)}if(!this._buffer){return}if(this._engine._releaseBuffer(this._buffer)){this._buffer=null}};UniformBuffer._MAX_UNIFORM_SIZE=256;UniformBuffer._tempBuffer=new Float32Array(UniformBuffer._MAX_UNIFORM_SIZE);return UniformBuffer}();BABYLON.UniformBuffer=UniformBuffer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PushMaterial=function(_super){__extends(PushMaterial,_super);function PushMaterial(name,scene){var _this=_super.call(this,name,scene)||this;_this.storeEffectOnSubMeshes=true;return _this}PushMaterial.prototype.getEffect=function(){return this._activeEffect};PushMaterial.prototype.isReady=function(mesh,useInstances){if(!mesh){return false}if(!mesh.subMeshes||mesh.subMeshes.length===0){return true}return this.isReadyForSubMesh(mesh,mesh.subMeshes[0],useInstances)};PushMaterial.prototype.bindOnlyWorldMatrix=function(world){this._activeEffect.setMatrix("world",world)};PushMaterial.prototype.bind=function(world,mesh){if(!mesh){return}this.bindForSubMesh(world,mesh,mesh.subMeshes[0])};PushMaterial.prototype._afterBind=function(mesh,effect){_super.prototype._afterBind.call(this,mesh);this.getScene()._cachedEffect=effect};PushMaterial.prototype._mustRebind=function(scene,effect,visibility){if(visibility===void 0){visibility=1}return scene.isCachedMaterialInvalid(this,effect,visibility)};return PushMaterial}(BABYLON.Material);BABYLON.PushMaterial=PushMaterial})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VertexData=function(){function VertexData(){}VertexData.prototype.set=function(data,kind){switch(kind){case BABYLON.VertexBuffer.PositionKind:this.positions=data;break;case BABYLON.VertexBuffer.NormalKind:this.normals=data;break;case BABYLON.VertexBuffer.TangentKind:this.tangents=data;break;case BABYLON.VertexBuffer.UVKind:this.uvs=data;break;case BABYLON.VertexBuffer.UV2Kind:this.uvs2=data;break;case BABYLON.VertexBuffer.UV3Kind:this.uvs3=data;break;case BABYLON.VertexBuffer.UV4Kind:this.uvs4=data;break;case BABYLON.VertexBuffer.UV5Kind:this.uvs5=data;break;case BABYLON.VertexBuffer.UV6Kind:this.uvs6=data;break;case BABYLON.VertexBuffer.ColorKind:this.colors=data;break;case BABYLON.VertexBuffer.MatricesIndicesKind:this.matricesIndices=data;break;case BABYLON.VertexBuffer.MatricesWeightsKind:this.matricesWeights=data;break;case BABYLON.VertexBuffer.MatricesIndicesExtraKind:this.matricesIndicesExtra=data;break;case BABYLON.VertexBuffer.MatricesWeightsExtraKind:this.matricesWeightsExtra=data;break}};VertexData.prototype.applyToMesh=function(mesh,updatable){this._applyTo(mesh,updatable);return this};VertexData.prototype.applyToGeometry=function(geometry,updatable){this._applyTo(geometry,updatable);return this};VertexData.prototype.updateMesh=function(mesh,updateExtends,makeItUnique){this._update(mesh);return this};VertexData.prototype.updateGeometry=function(geometry,updateExtends,makeItUnique){this._update(geometry);return this};VertexData.prototype._applyTo=function(meshOrGeometry,updatable){if(this.positions){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.PositionKind,this.positions,updatable)}if(this.normals){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.NormalKind,this.normals,updatable)}if(this.tangents){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.TangentKind,this.tangents,updatable)}if(this.uvs){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.UVKind,this.uvs,updatable)}if(this.uvs2){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.UV2Kind,this.uvs2,updatable)}if(this.uvs3){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.UV3Kind,this.uvs3,updatable)}if(this.uvs4){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.UV4Kind,this.uvs4,updatable)}if(this.uvs5){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.UV5Kind,this.uvs5,updatable)}if(this.uvs6){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.UV6Kind,this.uvs6,updatable)}if(this.colors){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.ColorKind,this.colors,updatable)}if(this.matricesIndices){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,this.matricesIndices,updatable)}if(this.matricesWeights){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind,this.matricesWeights,updatable)}if(this.matricesIndicesExtra){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,updatable)}if(this.matricesWeightsExtra){meshOrGeometry.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,updatable)}if(this.indices){meshOrGeometry.setIndices(this.indices,null,updatable)}return this};VertexData.prototype._update=function(meshOrGeometry,updateExtends,makeItUnique){if(this.positions){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.PositionKind,this.positions,updateExtends,makeItUnique)}if(this.normals){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.NormalKind,this.normals,updateExtends,makeItUnique)}if(this.tangents){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.TangentKind,this.tangents,updateExtends,makeItUnique)}if(this.uvs){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.UVKind,this.uvs,updateExtends,makeItUnique)}if(this.uvs2){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.UV2Kind,this.uvs2,updateExtends,makeItUnique)}if(this.uvs3){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.UV3Kind,this.uvs3,updateExtends,makeItUnique)}if(this.uvs4){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.UV4Kind,this.uvs4,updateExtends,makeItUnique)}if(this.uvs5){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.UV5Kind,this.uvs5,updateExtends,makeItUnique)}if(this.uvs6){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.UV6Kind,this.uvs6,updateExtends,makeItUnique)}if(this.colors){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.ColorKind,this.colors,updateExtends,makeItUnique)}if(this.matricesIndices){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,this.matricesIndices,updateExtends,makeItUnique)}if(this.matricesWeights){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind,this.matricesWeights,updateExtends,makeItUnique)}if(this.matricesIndicesExtra){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,updateExtends,makeItUnique)}if(this.matricesWeightsExtra){meshOrGeometry.updateVerticesData(BABYLON.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,updateExtends,makeItUnique)}if(this.indices){meshOrGeometry.setIndices(this.indices)}return this};VertexData.prototype.transform=function(matrix){var transformed=BABYLON.Vector3.Zero();var index;if(this.positions){var position=BABYLON.Vector3.Zero();for(index=0;index<this.positions.length;index+=3){BABYLON.Vector3.FromArrayToRef(this.positions,index,position);BABYLON.Vector3.TransformCoordinatesToRef(position,matrix,transformed);this.positions[index]=transformed.x;this.positions[index+1]=transformed.y;this.positions[index+2]=transformed.z}}if(this.normals){var normal=BABYLON.Vector3.Zero();for(index=0;index<this.normals.length;index+=3){BABYLON.Vector3.FromArrayToRef(this.normals,index,normal);BABYLON.Vector3.TransformNormalToRef(normal,matrix,transformed);this.normals[index]=transformed.x;this.normals[index+1]=transformed.y;this.normals[index+2]=transformed.z}}if(this.tangents){var tangent=BABYLON.Vector4.Zero();var tangentTransformed=BABYLON.Vector4.Zero();for(index=0;index<this.tangents.length;index+=4){BABYLON.Vector4.FromArrayToRef(this.tangents,index,tangent);BABYLON.Vector4.TransformNormalToRef(tangent,matrix,tangentTransformed);this.tangents[index]=tangentTransformed.x;this.tangents[index+1]=tangentTransformed.y;this.tangents[index+2]=tangentTransformed.z;this.tangents[index+3]=tangentTransformed.w}}return this};VertexData.prototype.merge=function(other){if(other.indices){if(!this.indices){this.indices=[]}var offset=this.positions?this.positions.length/3:0;for(var index=0;index<other.indices.length;index++){this.indices.push(other.indices[index]+offset)}}this.positions=this._mergeElement(this.positions,other.positions);var count=this.positions.length/3;this.normals=this._mergeElement(this.normals,other.normals,count*3);this.tangents=this._mergeElement(this.tangents,other.tangents,count*4);this.uvs=this._mergeElement(this.uvs,other.uvs,count*2);this.uvs2=this._mergeElement(this.uvs2,other.uvs2,count*2);this.uvs3=this._mergeElement(this.uvs3,other.uvs3,count*2);this.uvs4=this._mergeElement(this.uvs4,other.uvs4,count*2);this.uvs5=this._mergeElement(this.uvs5,other.uvs5,count*2);this.uvs6=this._mergeElement(this.uvs6,other.uvs6,count*2);this.colors=this._mergeElement(this.colors,other.colors,count*4);this.matricesIndices=this._mergeElement(this.matricesIndices,other.matricesIndices,count*4);this.matricesWeights=this._mergeElement(this.matricesWeights,other.matricesWeights,count*4);this.matricesIndicesExtra=this._mergeElement(this.matricesIndicesExtra,other.matricesIndicesExtra,count*4);this.matricesWeightsExtra=this._mergeElement(this.matricesWeightsExtra,other.matricesWeightsExtra,count*4);return this};VertexData.prototype._mergeElement=function(source,other,length){if(length===void 0){length=0}if(!other&&!source){return null}if(!other){return this._mergeElement(source,new Float32Array(source.length),length)}if(!source){if(length===0||length===other.length){return other}return this._mergeElement(new Float32Array(length-other.length),other,length)}var len=other.length+source.length;var isSrcTypedArray=source instanceof Float32Array;var isOthTypedArray=other instanceof Float32Array;if(isSrcTypedArray){var ret32=new Float32Array(len);ret32.set(source);ret32.set(other,source.length);return ret32}else if(!isOthTypedArray){return source.concat(other)}else{var ret=source.slice(0);for(var i=0,len=other.length;i<len;i++){ret.push(other[i])}return ret}};VertexData.prototype.serialize=function(){var serializationObject=this.serialize();if(this.positions){serializationObject.positions=this.positions}if(this.normals){serializationObject.normals=this.normals}if(this.tangents){serializationObject.tangents=this.tangents}if(this.uvs){serializationObject.uvs=this.uvs}if(this.uvs2){serializationObject.uvs2=this.uvs2}if(this.uvs3){serializationObject.uvs3=this.uvs3}if(this.uvs4){serializationObject.uvs4=this.uvs4}if(this.uvs5){serializationObject.uvs5=this.uvs5}if(this.uvs6){serializationObject.uvs6=this.uvs6}if(this.colors){serializationObject.colors=this.colors}if(this.matricesIndices){serializationObject.matricesIndices=this.matricesIndices;serializationObject.matricesIndices._isExpanded=true}if(this.matricesWeights){serializationObject.matricesWeights=this.matricesWeights}if(this.matricesIndicesExtra){serializationObject.matricesIndicesExtra=this.matricesIndicesExtra;serializationObject.matricesIndicesExtra._isExpanded=true}if(this.matricesWeightsExtra){serializationObject.matricesWeightsExtra=this.matricesWeightsExtra}serializationObject.indices=this.indices;return serializationObject};VertexData.ExtractFromMesh=function(mesh,copyWhenShared,forceCopy){return VertexData._ExtractFrom(mesh,copyWhenShared,forceCopy)};VertexData.ExtractFromGeometry=function(geometry,copyWhenShared,forceCopy){return VertexData._ExtractFrom(geometry,copyWhenShared,forceCopy)};VertexData._ExtractFrom=function(meshOrGeometry,copyWhenShared,forceCopy){var result=new VertexData;if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind)){result.positions=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.PositionKind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){result.normals=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.NormalKind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.TangentKind)){result.tangents=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.TangentKind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){result.uvs=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.UVKind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)){result.uvs2=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.UV2Kind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.UV3Kind)){result.uvs3=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.UV3Kind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.UV4Kind)){result.uvs4=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.UV4Kind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.UV5Kind)){result.uvs5=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.UV5Kind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.UV6Kind)){result.uvs6=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.UV6Kind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.ColorKind)){result.colors=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.ColorKind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)){result.matricesIndices=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)){result.matricesWeights=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesExtraKind)){result.matricesIndicesExtra=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesExtraKind,copyWhenShared,forceCopy)}if(meshOrGeometry.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsExtraKind)){result.matricesWeightsExtra=meshOrGeometry.getVerticesData(BABYLON.VertexBuffer.MatricesWeightsExtraKind,copyWhenShared,forceCopy)}result.indices=meshOrGeometry.getIndices(copyWhenShared);return result};VertexData.CreateRibbon=function(options){var pathArray=options.pathArray;var closeArray=options.closeArray||false;var closePath=options.closePath||false;var invertUV=options.invertUV||false;var defaultOffset=Math.floor(pathArray[0].length/2);var offset=options.offset||defaultOffset;offset=offset>defaultOffset?defaultOffset:Math.floor(offset);var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var customUV=options.uvs;var customColors=options.colors;var positions=[];var indices=[];var normals=[];var uvs=[];var us=[];var vs=[];var uTotalDistance=[];var vTotalDistance=[];var minlg;var lg=[];var idx=[];var p;var i;var j;if(pathArray.length<2){var ar1=[];var ar2=[];for(i=0;i<pathArray[0].length-offset;i++){ar1.push(pathArray[0][i]);ar2.push(pathArray[0][i+offset])}pathArray=[ar1,ar2]}var idc=0;var closePathCorr=closePath?1:0;var path;var l;minlg=pathArray[0].length;var vectlg;var dist;for(p=0;p<pathArray.length;p++){uTotalDistance[p]=0;us[p]=[0];path=pathArray[p];l=path.length;minlg=minlg<l?minlg:l;j=0;while(j<l){positions.push(path[j].x,path[j].y,path[j].z);if(j>0){vectlg=path[j].subtract(path[j-1]).length();dist=vectlg+uTotalDistance[p];us[p].push(dist);uTotalDistance[p]=dist}j++}if(closePath){j--;positions.push(path[0].x,path[0].y,path[0].z);vectlg=path[j].subtract(path[0]).length();dist=vectlg+uTotalDistance[p];us[p].push(dist);uTotalDistance[p]=dist}lg[p]=l+closePathCorr;idx[p]=idc;idc+=l+closePathCorr}var path1;var path2;var vertex1;var vertex2;for(i=0;i<minlg+closePathCorr;i++){vTotalDistance[i]=0;vs[i]=[0];for(p=0;p<pathArray.length-1;p++){path1=pathArray[p];path2=pathArray[p+1];if(i===minlg){vertex1=path1[0];vertex2=path2[0]}else{vertex1=path1[i];vertex2=path2[i]}vectlg=vertex2.subtract(vertex1).length();dist=vectlg+vTotalDistance[i];vs[i].push(dist);vTotalDistance[i]=dist}if(closeArray){path1=pathArray[p];path2=pathArray[0];if(i===minlg){vertex2=path2[0]}vectlg=vertex2.subtract(vertex1).length();dist=vectlg+vTotalDistance[i];vTotalDistance[i]=dist}}var u;var v;if(customUV){for(p=0;p<customUV.length;p++){uvs.push(customUV[p].x,customUV[p].y)}}else{for(p=0;p<pathArray.length;p++){for(i=0;i<minlg+closePathCorr;i++){u=uTotalDistance[p]!=0?us[p][i]/uTotalDistance[p]:0;v=vTotalDistance[i]!=0?vs[i][p]/vTotalDistance[i]:0;if(invertUV){uvs.push(v,u)}else{uvs.push(u,v)}}}}p=0;var pi=0;var l1=lg[p]-1;var l2=lg[p+1]-1;var min=l1<l2?l1:l2;var shft=idx[1]-idx[0];var path1nb=closeArray?lg.length:lg.length-1;while(pi<=min&&p<path1nb){indices.push(pi,pi+shft,pi+1);indices.push(pi+shft+1,pi+1,pi+shft);pi+=1;if(pi===min){p++;if(p===lg.length-1){shft=idx[0]-idx[p];l1=lg[p]-1;l2=lg[0]-1}else{shft=idx[p+1]-idx[p];l1=lg[p]-1;l2=lg[p+1]-1}pi=idx[p];min=l1<l2?l1+pi:l2+pi}}VertexData.ComputeNormals(positions,indices,normals);if(closePath){var indexFirst=0;var indexLast=0;for(p=0;p<pathArray.length;p++){indexFirst=idx[p]*3;if(p+1<pathArray.length){indexLast=(idx[p+1]-1)*3}else{indexLast=normals.length-3}normals[indexFirst]=(normals[indexFirst]+normals[indexLast])*.5;normals[indexFirst+1]=(normals[indexFirst+1]+normals[indexLast+1])*.5;normals[indexFirst+2]=(normals[indexFirst+2]+normals[indexLast+2])*.5;normals[indexLast]=normals[indexFirst];normals[indexLast+1]=normals[indexFirst+1];normals[indexLast+2]=normals[indexFirst+2]}}VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);if(customColors){var colors=new Float32Array(customColors.length*4);for(var c=0;c<customColors.length;c++){colors[c*4]=customColors[c].r;colors[c*4+1]=customColors[c].g;colors[c*4+2]=customColors[c].b;colors[c*4+3]=customColors[c].a}}var vertexData=new VertexData;var positions32=new Float32Array(positions);var normals32=new Float32Array(normals);var uvs32=new Float32Array(uvs);vertexData.indices=indices;vertexData.positions=positions32;vertexData.normals=normals32;vertexData.uvs=uvs32;if(customColors){vertexData.set(colors,BABYLON.VertexBuffer.ColorKind)}if(closePath){vertexData._idx=idx}return vertexData};VertexData.CreateBox=function(options){var normalsSource=[new BABYLON.Vector3(0,0,1),new BABYLON.Vector3(0,0,-1),new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(-1,0,0),new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,-1,0)];var indices=[];var positions=[];var normals=[];var uvs=[];var width=options.width||options.size||1;var height=options.height||options.size||1;var depth=options.depth||options.size||1;var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var faceUV=options.faceUV||new Array(6);var faceColors=options.faceColors;var colors=[];for(var f=0;f<6;f++){if(faceUV[f]===undefined){faceUV[f]=new BABYLON.Vector4(0,0,1,1)}if(faceColors&&faceColors[f]===undefined){faceColors[f]=new BABYLON.Color4(1,1,1,1)}}var scaleVector=new BABYLON.Vector3(width/2,height/2,depth/2);for(var index=0;index<normalsSource.length;index++){var normal=normalsSource[index];var side1=new BABYLON.Vector3(normal.y,normal.z,normal.x);var side2=BABYLON.Vector3.Cross(normal,side1);var verticesLength=positions.length/3;indices.push(verticesLength);indices.push(verticesLength+1);indices.push(verticesLength+2);indices.push(verticesLength);indices.push(verticesLength+2);indices.push(verticesLength+3);var vertex=normal.subtract(side1).subtract(side2).multiply(scaleVector);positions.push(vertex.x,vertex.y,vertex.z);normals.push(normal.x,normal.y,normal.z);uvs.push(faceUV[index].z,faceUV[index].w);if(faceColors){colors.push(faceColors[index].r,faceColors[index].g,faceColors[index].b,faceColors[index].a)}vertex=normal.subtract(side1).add(side2).multiply(scaleVector);positions.push(vertex.x,vertex.y,vertex.z);normals.push(normal.x,normal.y,normal.z);uvs.push(faceUV[index].x,faceUV[index].w);if(faceColors){colors.push(faceColors[index].r,faceColors[index].g,faceColors[index].b,faceColors[index].a)}vertex=normal.add(side1).add(side2).multiply(scaleVector);positions.push(vertex.x,vertex.y,vertex.z);normals.push(normal.x,normal.y,normal.z);uvs.push(faceUV[index].x,faceUV[index].y);if(faceColors){colors.push(faceColors[index].r,faceColors[index].g,faceColors[index].b,faceColors[index].a)}vertex=normal.add(side1).subtract(side2).multiply(scaleVector);positions.push(vertex.x,vertex.y,vertex.z);normals.push(normal.x,normal.y,normal.z);uvs.push(faceUV[index].z,faceUV[index].y);if(faceColors){colors.push(faceColors[index].r,faceColors[index].g,faceColors[index].b,faceColors[index].a)}}VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;if(faceColors){var totalColors=sideOrientation===BABYLON.Mesh.DOUBLESIDE?colors.concat(colors):colors;vertexData.colors=totalColors}return vertexData};VertexData.CreateSphere=function(options){var segments=options.segments||32;var diameterX=options.diameterX||options.diameter||1;var diameterY=options.diameterY||options.diameter||1;var diameterZ=options.diameterZ||options.diameter||1;var arc=options.arc<=0||options.arc>1?1:options.arc||1;var slice=options.slice<=0?1:options.slice||1;var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var radius=new BABYLON.Vector3(diameterX/2,diameterY/2,diameterZ/2);var totalZRotationSteps=2+segments;var totalYRotationSteps=2*totalZRotationSteps;var indices=[];var positions=[];var normals=[];var uvs=[];for(var zRotationStep=0;zRotationStep<=totalZRotationSteps;zRotationStep++){var normalizedZ=zRotationStep/totalZRotationSteps;var angleZ=normalizedZ*Math.PI*slice;for(var yRotationStep=0;yRotationStep<=totalYRotationSteps;yRotationStep++){var normalizedY=yRotationStep/totalYRotationSteps;var angleY=normalizedY*Math.PI*2*arc;var rotationZ=BABYLON.Matrix.RotationZ(-angleZ);var rotationY=BABYLON.Matrix.RotationY(angleY);var afterRotZ=BABYLON.Vector3.TransformCoordinates(BABYLON.Vector3.Up(),rotationZ);var complete=BABYLON.Vector3.TransformCoordinates(afterRotZ,rotationY);var vertex=complete.multiply(radius);var normal=complete.divide(radius).normalize();positions.push(vertex.x,vertex.y,vertex.z);normals.push(normal.x,normal.y,normal.z);uvs.push(normalizedY,normalizedZ)}if(zRotationStep>0){var verticesCount=positions.length/3;for(var firstIndex=verticesCount-2*(totalYRotationSteps+1);firstIndex+totalYRotationSteps+2<verticesCount;firstIndex++){indices.push(firstIndex);indices.push(firstIndex+1);indices.push(firstIndex+totalYRotationSteps+1);indices.push(firstIndex+totalYRotationSteps+1);indices.push(firstIndex+1);indices.push(firstIndex+totalYRotationSteps+2)}}}VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.CreateCylinder=function(options){var height=options.height||2;var diameterTop=options.diameterTop===0?0:options.diameterTop||options.diameter||1;var diameterBottom=options.diameterBottom===0?0:options.diameterBottom||options.diameter||1;var tessellation=options.tessellation||24;var subdivisions=options.subdivisions||1;var hasRings=options.hasRings;var enclose=options.enclose;var arc=options.arc<=0||options.arc>1?1:options.arc||1;var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var faceUV=options.faceUV||new Array(3);var faceColors=options.faceColors;var quadNb=arc!==1&&enclose?2:0;var ringNb=hasRings?subdivisions:1;var surfaceNb=2+(1+quadNb)*ringNb;var f;for(f=0;f<surfaceNb;f++){if(faceColors&&faceColors[f]===undefined){faceColors[f]=new BABYLON.Color4(1,1,1,1)}}for(f=0;f<surfaceNb;f++){if(faceUV&&faceUV[f]===undefined){faceUV[f]=new BABYLON.Vector4(0,0,1,1)}}var indices=new Array;var positions=new Array;var normals=new Array;var uvs=new Array;var colors=new Array;var angle_step=Math.PI*2*arc/tessellation;var angle;var h;var radius;var tan=(diameterBottom-diameterTop)/2/height;var ringVertex=BABYLON.Vector3.Zero();var ringNormal=BABYLON.Vector3.Zero();var ringFirstVertex=BABYLON.Vector3.Zero();var ringFirstNormal=BABYLON.Vector3.Zero();var quadNormal=BABYLON.Vector3.Zero();var Y=BABYLON.Axis.Y;var i;var j;var r;var ringIdx=1;var s=1;var cs=0;var v=0;for(i=0;i<=subdivisions;i++){h=i/subdivisions;radius=(h*(diameterTop-diameterBottom)+diameterBottom)/2;ringIdx=hasRings&&i!==0&&i!==subdivisions?2:1;for(r=0;r<ringIdx;r++){if(hasRings){s+=r}if(enclose){s+=2*r}for(j=0;j<=tessellation;j++){angle=j*angle_step;ringVertex.x=Math.cos(-angle)*radius;ringVertex.y=-height/2+h*height;ringVertex.z=Math.sin(-angle)*radius;if(diameterTop===0&&i===subdivisions){ringNormal.x=normals[normals.length-(tessellation+1)*3];ringNormal.y=normals[normals.length-(tessellation+1)*3+1];ringNormal.z=normals[normals.length-(tessellation+1)*3+2]}else{ringNormal.x=ringVertex.x;ringNormal.z=ringVertex.z;ringNormal.y=Math.sqrt(ringNormal.x*ringNormal.x+ringNormal.z*ringNormal.z)*tan;ringNormal.normalize()}if(j===0){ringFirstVertex.copyFrom(ringVertex);ringFirstNormal.copyFrom(ringNormal)}positions.push(ringVertex.x,ringVertex.y,ringVertex.z);normals.push(ringNormal.x,ringNormal.y,ringNormal.z);if(hasRings){v=cs!==s?faceUV[s].y:faceUV[s].w}else{v=faceUV[s].y+(faceUV[s].w-faceUV[s].y)*h}uvs.push(faceUV[s].x+(faceUV[s].z-faceUV[s].x)*j/tessellation,v);if(faceColors){colors.push(faceColors[s].r,faceColors[s].g,faceColors[s].b,faceColors[s].a)}}if(arc!==1&&enclose){positions.push(ringVertex.x,ringVertex.y,ringVertex.z);positions.push(0,ringVertex.y,0);positions.push(0,ringVertex.y,0);positions.push(ringFirstVertex.x,ringFirstVertex.y,ringFirstVertex.z);BABYLON.Vector3.CrossToRef(Y,ringNormal,quadNormal);quadNormal.normalize();normals.push(quadNormal.x,quadNormal.y,quadNormal.z,quadNormal.x,quadNormal.y,quadNormal.z);BABYLON.Vector3.CrossToRef(ringFirstNormal,Y,quadNormal);quadNormal.normalize();normals.push(quadNormal.x,quadNormal.y,quadNormal.z,quadNormal.x,quadNormal.y,quadNormal.z);if(hasRings){v=cs!==s?faceUV[s+1].y:faceUV[s+1].w}else{v=faceUV[s+1].y+(faceUV[s+1].w-faceUV[s+1].y)*h}uvs.push(faceUV[s+1].x,v);uvs.push(faceUV[s+1].z,v);if(hasRings){v=cs!==s?faceUV[s+2].y:faceUV[s+2].w}else{v=faceUV[s+2].y+(faceUV[s+2].w-faceUV[s+2].y)*h}uvs.push(faceUV[s+2].x,v);uvs.push(faceUV[s+2].z,v);if(faceColors){colors.push(faceColors[s+1].r,faceColors[s+1].g,faceColors[s+1].b,faceColors[s+1].a);colors.push(faceColors[s+1].r,faceColors[s+1].g,faceColors[s+1].b,faceColors[s+1].a);colors.push(faceColors[s+2].r,faceColors[s+2].g,faceColors[s+2].b,faceColors[s+2].a);colors.push(faceColors[s+2].r,faceColors[s+2].g,faceColors[s+2].b,faceColors[s+2].a)}}if(cs!==s){cs=s}}}var e=arc!==1&&enclose?tessellation+4:tessellation;var s;i=0;for(s=0;s<subdivisions;s++){for(j=0;j<tessellation;j++){var i0=i*(e+1)+j;var i1=(i+1)*(e+1)+j;var i2=i*(e+1)+(j+1);var i3=(i+1)*(e+1)+(j+1);indices.push(i0,i1,i2);indices.push(i3,i2,i1)}if(arc!==1&&enclose){indices.push(i0+2,i1+2,i2+2);indices.push(i3+2,i2+2,i1+2);indices.push(i0+4,i1+4,i2+4);indices.push(i3+4,i2+4,i1+4)}i=hasRings?i+2:i+1}var createCylinderCap=function(isTop){var radius=isTop?diameterTop/2:diameterBottom/2;if(radius===0){return}var angle;var circleVector;var i;var u=isTop?faceUV[surfaceNb-1]:faceUV[0];var c;if(faceColors){c=isTop?faceColors[surfaceNb-1]:faceColors[0]}var vbase=positions.length/3;var offset=isTop?height/2:-height/2;var center=new BABYLON.Vector3(0,offset,0);positions.push(center.x,center.y,center.z);normals.push(0,isTop?1:-1,0);uvs.push(u.x+(u.z-u.x)*.5,u.y+(u.w-u.y)*.5);if(faceColors){colors.push(c.r,c.g,c.b,c.a)}var textureScale=new BABYLON.Vector2(.5,.5);for(i=0;i<=tessellation;i++){angle=Math.PI*2*i*arc/tessellation;var cos=Math.cos(-angle);var sin=Math.sin(-angle);circleVector=new BABYLON.Vector3(cos*radius,offset,sin*radius);var textureCoordinate=new BABYLON.Vector2(cos*textureScale.x+.5,sin*textureScale.y+.5);positions.push(circleVector.x,circleVector.y,circleVector.z);normals.push(0,isTop?1:-1,0);uvs.push(u.x+(u.z-u.x)*textureCoordinate.x,u.y+(u.w-u.y)*textureCoordinate.y);if(faceColors){colors.push(c.r,c.g,c.b,c.a)}}for(i=0;i<tessellation;i++){if(!isTop){indices.push(vbase);indices.push(vbase+(i+1));indices.push(vbase+(i+2))}else{indices.push(vbase);indices.push(vbase+(i+2));indices.push(vbase+(i+1))}}};createCylinderCap(false);createCylinderCap(true);VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;if(faceColors){vertexData.colors=colors}return vertexData};VertexData.CreateTorus=function(options){var indices=[];var positions=[];var normals=[];var uvs=[];var diameter=options.diameter||1;var thickness=options.thickness||.5;var tessellation=options.tessellation||16;var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var stride=tessellation+1;for(var i=0;i<=tessellation;i++){var u=i/tessellation;var outerAngle=i*Math.PI*2/tessellation-Math.PI/2;var transform=BABYLON.Matrix.Translation(diameter/2,0,0).multiply(BABYLON.Matrix.RotationY(outerAngle));for(var j=0;j<=tessellation;j++){var v=1-j/tessellation;var innerAngle=j*Math.PI*2/tessellation+Math.PI;var dx=Math.cos(innerAngle);var dy=Math.sin(innerAngle);var normal=new BABYLON.Vector3(dx,dy,0);var position=normal.scale(thickness/2);var textureCoordinate=new BABYLON.Vector2(u,v);position=BABYLON.Vector3.TransformCoordinates(position,transform);normal=BABYLON.Vector3.TransformNormal(normal,transform);positions.push(position.x,position.y,position.z);normals.push(normal.x,normal.y,normal.z);uvs.push(textureCoordinate.x,textureCoordinate.y);var nextI=(i+1)%stride;var nextJ=(j+1)%stride;indices.push(i*stride+j);indices.push(i*stride+nextJ);indices.push(nextI*stride+j);indices.push(i*stride+nextJ);indices.push(nextI*stride+nextJ);indices.push(nextI*stride+j)}}VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.CreateLineSystem=function(options){var indices=[];var positions=[];var lines=options.lines;var idx=0;for(var l=0;l<lines.length;l++){var points=lines[l];for(var index=0;index<points.length;index++){positions.push(points[index].x,points[index].y,points[index].z);if(index>0){indices.push(idx-1);indices.push(idx)}idx++}}var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;return vertexData};VertexData.CreateDashedLines=function(options){var dashSize=options.dashSize||3;var gapSize=options.gapSize||1;var dashNb=options.dashNb||200;var points=options.points;var positions=new Array;var indices=new Array;var curvect=BABYLON.Vector3.Zero();var lg=0;var nb=0;var shft=0;var dashshft=0;var curshft=0;var idx=0;var i=0;for(i=0;i<points.length-1;i++){points[i+1].subtractToRef(points[i],curvect);lg+=curvect.length()}shft=lg/dashNb;dashshft=dashSize*shft/(dashSize+gapSize);for(i=0;i<points.length-1;i++){points[i+1].subtractToRef(points[i],curvect);nb=Math.floor(curvect.length()/shft);curvect.normalize();for(var j=0;j<nb;j++){curshft=shft*j;positions.push(points[i].x+curshft*curvect.x,points[i].y+curshft*curvect.y,points[i].z+curshft*curvect.z);positions.push(points[i].x+(curshft+dashshft)*curvect.x,points[i].y+(curshft+dashshft)*curvect.y,points[i].z+(curshft+dashshft)*curvect.z);indices.push(idx,idx+1);idx+=2}}var vertexData=new VertexData;vertexData.positions=positions;vertexData.indices=indices;return vertexData};VertexData.CreateGround=function(options){var indices=[];var positions=[];var normals=[];var uvs=[];var row,col;var width=options.width||1;var height=options.height||1;var subdivisionsX=options.subdivisionsX||options.subdivisions||1;var subdivisionsY=options.subdivisionsY||options.subdivisions||1;for(row=0;row<=subdivisionsY;row++){for(col=0;col<=subdivisionsX;col++){var position=new BABYLON.Vector3(col*width/subdivisionsX-width/2,0,(subdivisionsY-row)*height/subdivisionsY-height/2);var normal=new BABYLON.Vector3(0,1,0);positions.push(position.x,position.y,position.z);normals.push(normal.x,normal.y,normal.z);uvs.push(col/subdivisionsX,1-row/subdivisionsY)}}for(row=0;row<subdivisionsY;row++){for(col=0;col<subdivisionsX;col++){indices.push(col+1+(row+1)*(subdivisionsX+1));indices.push(col+1+row*(subdivisionsX+1));indices.push(col+row*(subdivisionsX+1));indices.push(col+(row+1)*(subdivisionsX+1));indices.push(col+1+(row+1)*(subdivisionsX+1));indices.push(col+row*(subdivisionsX+1))}}var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.CreateTiledGround=function(options){var xmin=options.xmin||-1;var zmin=options.zmin||-1;var xmax=options.xmax||1;var zmax=options.zmax||1;var subdivisions=options.subdivisions||{w:1,h:1};var precision=options.precision||{w:1,h:1};var indices=new Array;var positions=new Array;var normals=new Array;var uvs=new Array;var row,col,tileRow,tileCol;subdivisions.h=subdivisions.h<1?1:subdivisions.h;subdivisions.w=subdivisions.w<1?1:subdivisions.w;precision.w=precision.w<1?1:precision.w;precision.h=precision.h<1?1:precision.h;var tileSize={w:(xmax-xmin)/subdivisions.w,h:(zmax-zmin)/subdivisions.h};function applyTile(xTileMin,zTileMin,xTileMax,zTileMax){var base=positions.length/3;var rowLength=precision.w+1;for(row=0;row<precision.h;row++){for(col=0;col<precision.w;col++){var square=[base+col+row*rowLength,base+(col+1)+row*rowLength,base+(col+1)+(row+1)*rowLength,base+col+(row+1)*rowLength];indices.push(square[1]);indices.push(square[2]);indices.push(square[3]);indices.push(square[0]);indices.push(square[1]);indices.push(square[3])}}var position=BABYLON.Vector3.Zero();var normal=new BABYLON.Vector3(0,1,0);for(row=0;row<=precision.h;row++){position.z=row*(zTileMax-zTileMin)/precision.h+zTileMin;for(col=0;col<=precision.w;col++){position.x=col*(xTileMax-xTileMin)/precision.w+xTileMin;position.y=0;positions.push(position.x,position.y,position.z);normals.push(normal.x,normal.y,normal.z);uvs.push(col/precision.w,row/precision.h)}}}for(tileRow=0;tileRow<subdivisions.h;tileRow++){for(tileCol=0;tileCol<subdivisions.w;tileCol++){applyTile(xmin+tileCol*tileSize.w,zmin+tileRow*tileSize.h,xmin+(tileCol+1)*tileSize.w,zmin+(tileRow+1)*tileSize.h)}}var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.CreateGroundFromHeightMap=function(options){var indices=[];var positions=[];var normals=[];var uvs=[];var row,col;var filter=options.colorFilter||new BABYLON.Color3(.3,.59,.11);for(row=0;row<=options.subdivisions;row++){for(col=0;col<=options.subdivisions;col++){var position=new BABYLON.Vector3(col*options.width/options.subdivisions-options.width/2,0,(options.subdivisions-row)*options.height/options.subdivisions-options.height/2);var heightMapX=(position.x+options.width/2)/options.width*(options.bufferWidth-1)|0;var heightMapY=(1-(position.z+options.height/2)/options.height)*(options.bufferHeight-1)|0;var pos=(heightMapX+heightMapY*options.bufferWidth)*4;var r=options.buffer[pos]/255;var g=options.buffer[pos+1]/255;var b=options.buffer[pos+2]/255;var gradient=r*filter.r+g*filter.g+b*filter.b;position.y=options.minHeight+(options.maxHeight-options.minHeight)*gradient;positions.push(position.x,position.y,position.z);normals.push(0,0,0);uvs.push(col/options.subdivisions,1-row/options.subdivisions)}}for(row=0;row<options.subdivisions;row++){for(col=0;col<options.subdivisions;col++){indices.push(col+1+(row+1)*(options.subdivisions+1));indices.push(col+1+row*(options.subdivisions+1));indices.push(col+row*(options.subdivisions+1));indices.push(col+(row+1)*(options.subdivisions+1));indices.push(col+1+(row+1)*(options.subdivisions+1));indices.push(col+row*(options.subdivisions+1))}}VertexData.ComputeNormals(positions,indices,normals);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.CreatePlane=function(options){var indices=[];var positions=[];var normals=[];var uvs=[];var width=options.width||options.size||1;var height=options.height||options.size||1;var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var halfWidth=width/2;var halfHeight=height/2;positions.push(-halfWidth,-halfHeight,0);normals.push(0,0,-1);uvs.push(0,0);positions.push(halfWidth,-halfHeight,0);normals.push(0,0,-1);uvs.push(1,0);positions.push(halfWidth,halfHeight,0);normals.push(0,0,-1);uvs.push(1,1);positions.push(-halfWidth,halfHeight,0);normals.push(0,0,-1);uvs.push(0,1);indices.push(0);indices.push(1);indices.push(2);indices.push(0);indices.push(2);indices.push(3);VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.CreateDisc=function(options){var positions=new Array;var indices=new Array;var normals=new Array;var uvs=new Array;var radius=options.radius||.5;var tessellation=options.tessellation||64;var arc=options.arc<=0||options.arc>1?1:options.arc||1;var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;positions.push(0,0,0);uvs.push(.5,.5);var theta=Math.PI*2*arc;var step=theta/tessellation;for(var a=0;a<theta;a+=step){var x=Math.cos(a);var y=Math.sin(a);var u=(x+1)/2;var v=(1-y)/2;positions.push(radius*x,radius*y,0);uvs.push(u,v)}if(arc===1){positions.push(positions[3],positions[4],positions[5]);uvs.push(uvs[2],uvs[3])}var vertexNb=positions.length/3;for(var i=1;i<vertexNb-1;i++){indices.push(i+1,0,i)}VertexData.ComputeNormals(positions,indices,normals);VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.CreatePolygon=function(polygon,sideOrientation,fUV,fColors,frontUVs,backUVs){var faceUV=fUV||new Array(3);var faceColors=fColors;var colors=[];for(var f=0;f<3;f++){if(faceUV[f]===undefined){faceUV[f]=new BABYLON.Vector4(0,0,1,1)}if(faceColors&&faceColors[f]===undefined){faceColors[f]=new BABYLON.Color4(1,1,1,1)}}var positions=polygon.getVerticesData(BABYLON.VertexBuffer.PositionKind);var normals=polygon.getVerticesData(BABYLON.VertexBuffer.NormalKind);var uvs=polygon.getVerticesData(BABYLON.VertexBuffer.UVKind);var indices=polygon.getIndices();var idx=0;var face=0;for(var index=0;index<normals.length;index+=3){if(Math.abs(normals[index+1])<.001){face=1}if(Math.abs(normals[index+1]-1)<.001){face=0}if(Math.abs(normals[index+1]+1)<.001){face=2}idx=index/3;uvs[2*idx]=(1-uvs[2*idx])*faceUV[face].x+uvs[2*idx]*faceUV[face].z;uvs[2*idx+1]=(1-uvs[2*idx+1])*faceUV[face].y+uvs[2*idx+1]*faceUV[face].w;if(faceColors){colors.push(faceColors[face].r,faceColors[face].g,faceColors[face].b,faceColors[face].a)}}VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,frontUVs,backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;if(faceColors){var totalColors=sideOrientation===BABYLON.Mesh.DOUBLESIDE?colors.concat(colors):colors;vertexData.colors=totalColors}return vertexData};VertexData.CreateIcoSphere=function(options){var sideOrientation=options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var radius=options.radius||1;var flat=options.flat===undefined?true:options.flat;var subdivisions=options.subdivisions||4;var radiusX=options.radiusX||radius;var radiusY=options.radiusY||radius;var radiusZ=options.radiusZ||radius;var t=(1+Math.sqrt(5))/2;var ico_vertices=[-1,t,-0,1,t,0,-1,-t,0,1,-t,0,0,-1,-t,0,1,-t,0,-1,t,0,1,t,t,0,1,t,0,-1,-t,0,1,-t,0,-1];var ico_indices=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1];var vertices_unalias_id=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11];var ico_vertexuv=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4];var ustep=138/1024;var vstep=239/1024;var uoffset=60/1024;var voffset=26/1024;var island_u_offset=-40/1024;var island_v_offset=+20/1024;var island=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0];var indices=new Array;var positions=new Array;var normals=new Array;var uvs=new Array;var current_indice=0;var face_vertex_pos=new Array(3);var face_vertex_uv=new Array(3);var v012;for(v012=0;v012<3;v012++){face_vertex_pos[v012]=BABYLON.Vector3.Zero();face_vertex_uv[v012]=BABYLON.Vector2.Zero()}for(var face=0;face<20;face++){for(v012=0;v012<3;v012++){var v_id=ico_indices[3*face+v012];face_vertex_pos[v012].copyFromFloats(ico_vertices[3*vertices_unalias_id[v_id]],ico_vertices[3*vertices_unalias_id[v_id]+1],ico_vertices[3*vertices_unalias_id[v_id]+2]);face_vertex_pos[v012].normalize().scaleInPlace(radius);face_vertex_uv[v012].copyFromFloats(ico_vertexuv[2*v_id]*ustep+uoffset+island[face]*island_u_offset,ico_vertexuv[2*v_id+1]*vstep+voffset+island[face]*island_v_offset)}var interp_vertex=function(i1,i2,c1,c2){var pos_x0=BABYLON.Vector3.Lerp(face_vertex_pos[0],face_vertex_pos[2],i2/subdivisions);var pos_x1=BABYLON.Vector3.Lerp(face_vertex_pos[1],face_vertex_pos[2],i2/subdivisions);var pos_interp=subdivisions===i2?face_vertex_pos[2]:BABYLON.Vector3.Lerp(pos_x0,pos_x1,i1/(subdivisions-i2));pos_interp.normalize();var vertex_normal;if(flat){var centroid_x0=BABYLON.Vector3.Lerp(face_vertex_pos[0],face_vertex_pos[2],c2/subdivisions);var centroid_x1=BABYLON.Vector3.Lerp(face_vertex_pos[1],face_vertex_pos[2],c2/subdivisions);vertex_normal=BABYLON.Vector3.Lerp(centroid_x0,centroid_x1,c1/(subdivisions-c2))}else{vertex_normal=new BABYLON.Vector3(pos_interp.x,pos_interp.y,pos_interp.z)}vertex_normal.x/=radiusX;vertex_normal.y/=radiusY;vertex_normal.z/=radiusZ;vertex_normal.normalize();var uv_x0=BABYLON.Vector2.Lerp(face_vertex_uv[0],face_vertex_uv[2],i2/subdivisions);var uv_x1=BABYLON.Vector2.Lerp(face_vertex_uv[1],face_vertex_uv[2],i2/subdivisions);var uv_interp=subdivisions===i2?face_vertex_uv[2]:BABYLON.Vector2.Lerp(uv_x0,uv_x1,i1/(subdivisions-i2));positions.push(pos_interp.x*radiusX,pos_interp.y*radiusY,pos_interp.z*radiusZ);normals.push(vertex_normal.x,vertex_normal.y,vertex_normal.z);uvs.push(uv_interp.x,uv_interp.y);indices.push(current_indice);current_indice++};for(var i2=0;i2<subdivisions;i2++){for(var i1=0;i1+i2<subdivisions;i1++){interp_vertex(i1,i2,i1+1/3,i2+1/3);interp_vertex(i1+1,i2,i1+1/3,i2+1/3);interp_vertex(i1,i2+1,i1+1/3,i2+1/3);if(i1+i2+1<subdivisions){interp_vertex(i1+1,i2,i1+2/3,i2+2/3);interp_vertex(i1+1,i2+1,i1+2/3,i2+2/3);interp_vertex(i1,i2+1,i1+2/3,i2+2/3)}}}}VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.CreatePolyhedron=function(options){var polyhedra=[];polyhedra[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]};polyhedra[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]};polyhedra[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]};polyhedra[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]};polyhedra[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]};polyhedra[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]};polyhedra[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]};polyhedra[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]};polyhedra[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]};polyhedra[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]};polyhedra[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]};polyhedra[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]};polyhedra[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]};polyhedra[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]};polyhedra[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};var type=options.type<0||options.type>=polyhedra.length?0:options.type||0;var size=options.size;var sizeX=options.sizeX||size||1;var sizeY=options.sizeY||size||1;var sizeZ=options.sizeZ||size||1;var data=options.custom||polyhedra[type];var nbfaces=data.face.length;var faceUV=options.faceUV||new Array(nbfaces);var faceColors=options.faceColors;var flat=options.flat===undefined?true:options.flat;var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var positions=new Array;var indices=new Array;var normals=new Array;var uvs=new Array;var colors=new Array;var index=0;var faceIdx=0;var indexes=new Array;var i=0;var f=0;var u,v,ang,x,y,tmp;if(flat){for(f=0;f<nbfaces;f++){if(faceColors&&faceColors[f]===undefined){faceColors[f]=new BABYLON.Color4(1,1,1,1)}if(faceUV&&faceUV[f]===undefined){faceUV[f]=new BABYLON.Vector4(0,0,1,1)}}}if(!flat){for(i=0;i<data.vertex.length;i++){positions.push(data.vertex[i][0]*sizeX,data.vertex[i][1]*sizeY,data.vertex[i][2]*sizeZ);uvs.push(0,0)}for(f=0;f<nbfaces;f++){for(i=0;i<data.face[f].length-2;i++){indices.push(data.face[f][0],data.face[f][i+2],data.face[f][i+1])}}}else{for(f=0;f<nbfaces;f++){var fl=data.face[f].length;ang=2*Math.PI/fl;x=.5*Math.tan(ang/2);y=.5;for(i=0;i<fl;i++){positions.push(data.vertex[data.face[f][i]][0]*sizeX,data.vertex[data.face[f][i]][1]*sizeY,data.vertex[data.face[f][i]][2]*sizeZ);indexes.push(index);index++;u=faceUV[f].x+(faceUV[f].z-faceUV[f].x)*(.5+x);v=faceUV[f].y+(faceUV[f].w-faceUV[f].y)*(y-.5);uvs.push(u,v);tmp=x*Math.cos(ang)-y*Math.sin(ang);y=x*Math.sin(ang)+y*Math.cos(ang);x=tmp;if(faceColors){colors.push(faceColors[f].r,faceColors[f].g,faceColors[f].b,faceColors[f].a)}}for(i=0;i<fl-2;i++){indices.push(indexes[0+faceIdx],indexes[i+2+faceIdx],indexes[i+1+faceIdx])}faceIdx+=fl}}VertexData.ComputeNormals(positions,indices,normals);VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.positions=positions;vertexData.indices=indices;vertexData.normals=normals;vertexData.uvs=uvs;if(faceColors&&flat){vertexData.colors=colors}return vertexData};VertexData.CreateTorusKnot=function(options){var indices=new Array;var positions=new Array;var normals=new Array;var uvs=new Array;var radius=options.radius||2;var tube=options.tube||.5;var radialSegments=options.radialSegments||32;var tubularSegments=options.tubularSegments||32;var p=options.p||2;var q=options.q||3;var sideOrientation=options.sideOrientation===0?0:options.sideOrientation||BABYLON.Mesh.DEFAULTSIDE;var getPos=function(angle){var cu=Math.cos(angle);var su=Math.sin(angle);var quOverP=q/p*angle;var cs=Math.cos(quOverP);var tx=radius*(2+cs)*.5*cu;var ty=radius*(2+cs)*su*.5;var tz=radius*Math.sin(quOverP)*.5;return new BABYLON.Vector3(tx,ty,tz)};var i;var j;for(i=0;i<=radialSegments;i++){var modI=i%radialSegments;var u=modI/radialSegments*2*p*Math.PI;var p1=getPos(u);var p2=getPos(u+.01);var tang=p2.subtract(p1);var n=p2.add(p1);var bitan=BABYLON.Vector3.Cross(tang,n);n=BABYLON.Vector3.Cross(bitan,tang);bitan.normalize();n.normalize();for(j=0;j<tubularSegments;j++){var modJ=j%tubularSegments;var v=modJ/tubularSegments*2*Math.PI;var cx=-tube*Math.cos(v);var cy=tube*Math.sin(v);positions.push(p1.x+cx*n.x+cy*bitan.x);positions.push(p1.y+cx*n.y+cy*bitan.y);positions.push(p1.z+cx*n.z+cy*bitan.z);uvs.push(i/radialSegments);uvs.push(j/tubularSegments)}}for(i=0;i<radialSegments;i++){for(j=0;j<tubularSegments;j++){var jNext=(j+1)%tubularSegments;var a=i*tubularSegments+j;var b=(i+1)*tubularSegments+j;var c=(i+1)*tubularSegments+jNext;var d=i*tubularSegments+jNext;indices.push(d);indices.push(b);indices.push(a);indices.push(d);indices.push(c);indices.push(b)}}VertexData.ComputeNormals(positions,indices,normals);VertexData._ComputeSides(sideOrientation,positions,indices,normals,uvs,options.frontUVs,options.backUVs);var vertexData=new VertexData;vertexData.indices=indices;vertexData.positions=positions;vertexData.normals=normals;vertexData.uvs=uvs;return vertexData};VertexData.ComputeNormals=function(positions,indices,normals,options){var index=0;var p1p2x=0;var p1p2y=0;var p1p2z=0;var p3p2x=0;var p3p2y=0;var p3p2z=0;var faceNormalx=0;var faceNormaly=0;var faceNormalz=0;var length=0;var v1x=0;var v1y=0;var v1z=0;var v2x=0;var v2y=0;var v2z=0;var v3x=0;var v3y=0;var v3z=0;var computeFacetNormals=false;var computeFacetPositions=false;var computeFacetPartitioning=false;var faceNormalSign=1;if(options){computeFacetNormals=options.facetNormals?true:false;computeFacetPositions=options.facetPositions?true:false;computeFacetPartitioning=options.facetPartitioning?true:false;faceNormalSign=options.useRightHandedSystem===true?-1:1}if(computeFacetPartitioning){var ox=0;var oy=0;var oz=0;var b1x=0;var b1y=0;var b1z=0;var b2x=0;var b2y=0;var b2z=0;var b3x=0;var b3y=0;var b3z=0;var block_idx_o=0;var block_idx_v1=0;var block_idx_v2=0;var block_idx_v3=0;var bbSizeMax=options.bbSize.x>options.bbSize.y?options.bbSize.x:options.bbSize.y;bbSizeMax=bbSizeMax>options.bbSize.z?bbSizeMax:options.bbSize.z;var xSubRatio=options.subDiv.X*options.ratio/options.bbSize.x;var ySubRatio=options.subDiv.Y*options.ratio/options.bbSize.y;var zSubRatio=options.subDiv.Z*options.ratio/options.bbSize.z;var subSq=options.subDiv.max*options.subDiv.max;options.facetPartitioning.length=0}for(index=0;index<positions.length;index++){normals[index]=0}var nbFaces=indices.length/3;for(index=0;index<nbFaces;index++){v1x=indices[index*3]*3;v1y=v1x+1;v1z=v1x+2;v2x=indices[index*3+1]*3;v2y=v2x+1;v2z=v2x+2;v3x=indices[index*3+2]*3;v3y=v3x+1;v3z=v3x+2;p1p2x=positions[v1x]-positions[v2x];p1p2y=positions[v1y]-positions[v2y];p1p2z=positions[v1z]-positions[v2z];p3p2x=positions[v3x]-positions[v2x];p3p2y=positions[v3y]-positions[v2y];p3p2z=positions[v3z]-positions[v2z];faceNormalx=faceNormalSign*(p1p2y*p3p2z-p1p2z*p3p2y);faceNormaly=faceNormalSign*(p1p2z*p3p2x-p1p2x*p3p2z);faceNormalz=faceNormalSign*(p1p2x*p3p2y-p1p2y*p3p2x);length=Math.sqrt(faceNormalx*faceNormalx+faceNormaly*faceNormaly+faceNormalz*faceNormalz);length=length===0?1:length;faceNormalx/=length;faceNormaly/=length;faceNormalz/=length;if(computeFacetNormals){options.facetNormals[index].x=faceNormalx;options.facetNormals[index].y=faceNormaly;options.facetNormals[index].z=faceNormalz}if(computeFacetPositions){options.facetPositions[index].x=(positions[v1x]+positions[v2x]+positions[v3x])/3;options.facetPositions[index].y=(positions[v1y]+positions[v2y]+positions[v3y])/3;options.facetPositions[index].z=(positions[v1z]+positions[v2z]+positions[v3z])/3}if(computeFacetPartitioning){ox=Math.floor((options.facetPositions[index].x-options.bInfo.minimum.x*options.ratio)*xSubRatio);oy=Math.floor((options.facetPositions[index].y-options.bInfo.minimum.y*options.ratio)*ySubRatio);oz=Math.floor((options.facetPositions[index].z-options.bInfo.minimum.z*options.ratio)*zSubRatio);b1x=Math.floor((positions[v1x]-options.bInfo.minimum.x*options.ratio)*xSubRatio);b1y=Math.floor((positions[v1y]-options.bInfo.minimum.y*options.ratio)*ySubRatio);b1z=Math.floor((positions[v1z]-options.bInfo.minimum.z*options.ratio)*zSubRatio);b2x=Math.floor((positions[v2x]-options.bInfo.minimum.x*options.ratio)*xSubRatio);b2y=Math.floor((positions[v2y]-options.bInfo.minimum.y*options.ratio)*ySubRatio);b2z=Math.floor((positions[v2z]-options.bInfo.minimum.z*options.ratio)*zSubRatio);b3x=Math.floor((positions[v3x]-options.bInfo.minimum.x*options.ratio)*xSubRatio);b3y=Math.floor((positions[v3y]-options.bInfo.minimum.y*options.ratio)*ySubRatio);b3z=Math.floor((positions[v3z]-options.bInfo.minimum.z*options.ratio)*zSubRatio);block_idx_v1=b1x+options.subDiv.max*b1y+subSq*b1z;block_idx_v2=b2x+options.subDiv.max*b2y+subSq*b2z;block_idx_v3=b3x+options.subDiv.max*b3y+subSq*b3z;block_idx_o=ox+options.subDiv.max*oy+subSq*oz;options.facetPartitioning[block_idx_o]=options.facetPartitioning[block_idx_o]?options.facetPartitioning[block_idx_o]:new Array;options.facetPartitioning[block_idx_v1]=options.facetPartitioning[block_idx_v1]?options.facetPartitioning[block_idx_v1]:new Array;options.facetPartitioning[block_idx_v2]=options.facetPartitioning[block_idx_v2]?options.facetPartitioning[block_idx_v2]:new Array;options.facetPartitioning[block_idx_v3]=options.facetPartitioning[block_idx_v3]?options.facetPartitioning[block_idx_v3]:new Array;options.facetPartitioning[block_idx_v1].push(index);if(block_idx_v2!=block_idx_v1){options.facetPartitioning[block_idx_v2].push(index)}if(!(block_idx_v3==block_idx_v2||block_idx_v3==block_idx_v1)){options.facetPartitioning[block_idx_v3].push(index)}if(!(block_idx_o==block_idx_v1||block_idx_o==block_idx_v2||block_idx_o==block_idx_v3)){options.facetPartitioning[block_idx_o].push(index)}}normals[v1x]+=faceNormalx;normals[v1y]+=faceNormaly;normals[v1z]+=faceNormalz;normals[v2x]+=faceNormalx;normals[v2y]+=faceNormaly;normals[v2z]+=faceNormalz;normals[v3x]+=faceNormalx;normals[v3y]+=faceNormaly;normals[v3z]+=faceNormalz}for(index=0;index<normals.length/3;index++){faceNormalx=normals[index*3];faceNormaly=normals[index*3+1];faceNormalz=normals[index*3+2];length=Math.sqrt(faceNormalx*faceNormalx+faceNormaly*faceNormaly+faceNormalz*faceNormalz);length=length===0?1:length;faceNormalx/=length;faceNormaly/=length;faceNormalz/=length;normals[index*3]=faceNormalx;normals[index*3+1]=faceNormaly;normals[index*3+2]=faceNormalz}};VertexData._ComputeSides=function(sideOrientation,positions,indices,normals,uvs,frontUVs,backUVs){var li=indices.length;var ln=normals.length;var i;var n;sideOrientation=sideOrientation||BABYLON.Mesh.DEFAULTSIDE;switch(sideOrientation){case BABYLON.Mesh.FRONTSIDE:break;case BABYLON.Mesh.BACKSIDE:var tmp;for(i=0;i<li;i+=3){tmp=indices[i];indices[i]=indices[i+2];indices[i+2]=tmp}for(n=0;n<ln;n++){normals[n]=-normals[n]}break;case BABYLON.Mesh.DOUBLESIDE:var lp=positions.length;var l=lp/3;for(var p=0;p<lp;p++){positions[lp+p]=positions[p]}for(i=0;i<li;i+=3){indices[i+li]=indices[i+2]+l;indices[i+1+li]=indices[i+1]+l;indices[i+2+li]=indices[i]+l}for(n=0;n<ln;n++){normals[ln+n]=-normals[n]}var lu=uvs.length;var u=0;for(u=0;u<lu;u++){uvs[u+lu]=uvs[u]}var frontUVs=frontUVs?frontUVs:new BABYLON.Vector4(0,0,1,1);var backUVs=backUVs?backUVs:new BABYLON.Vector4(0,0,1,1);u=0;for(i=0;i<lu/2;i++){uvs[u]=frontUVs.x+(frontUVs.z-frontUVs.x)*uvs[u];uvs[u+1]=frontUVs.y+(frontUVs.w-frontUVs.y)*uvs[u+1];uvs[u+lu]=backUVs.x+(backUVs.z-backUVs.x)*uvs[u+lu];uvs[u+lu+1]=backUVs.y+(backUVs.w-backUVs.y)*uvs[u+lu+1];u+=2}break}};VertexData.ImportVertexData=function(parsedVertexData,geometry){var vertexData=new VertexData;var positions=parsedVertexData.positions;if(positions){vertexData.set(positions,BABYLON.VertexBuffer.PositionKind)}var normals=parsedVertexData.normals;if(normals){vertexData.set(normals,BABYLON.VertexBuffer.NormalKind)}var tangents=parsedVertexData.tangents;if(tangents){vertexData.set(tangents,BABYLON.VertexBuffer.TangentKind)}var uvs=parsedVertexData.uvs;if(uvs){vertexData.set(uvs,BABYLON.VertexBuffer.UVKind)}var uv2s=parsedVertexData.uv2s;if(uv2s){vertexData.set(uv2s,BABYLON.VertexBuffer.UV2Kind)}var uv3s=parsedVertexData.uv3s;if(uv3s){vertexData.set(uv3s,BABYLON.VertexBuffer.UV3Kind)}var uv4s=parsedVertexData.uv4s;if(uv4s){vertexData.set(uv4s,BABYLON.VertexBuffer.UV4Kind)}var uv5s=parsedVertexData.uv5s;if(uv5s){vertexData.set(uv5s,BABYLON.VertexBuffer.UV5Kind)}var uv6s=parsedVertexData.uv6s;if(uv6s){vertexData.set(uv6s,BABYLON.VertexBuffer.UV6Kind)}var colors=parsedVertexData.colors;if(colors){vertexData.set(BABYLON.Color4.CheckColors4(colors,positions.length/3),BABYLON.VertexBuffer.ColorKind)}var matricesIndices=parsedVertexData.matricesIndices;if(matricesIndices){vertexData.set(matricesIndices,BABYLON.VertexBuffer.MatricesIndicesKind)}var matricesWeights=parsedVertexData.matricesWeights;if(matricesWeights){vertexData.set(matricesWeights,BABYLON.VertexBuffer.MatricesWeightsKind)}var indices=parsedVertexData.indices;if(indices){vertexData.indices=indices}geometry.setAllVerticesData(vertexData,parsedVertexData.updatable)};return VertexData}();BABYLON.VertexData=VertexData})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Geometry=function(){function Geometry(id,scene,vertexData,updatable,mesh){this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NONE;this._totalVertices=0;this._isDisposed=false;this._indexBufferIsUpdatable=false;this.id=id;this._engine=scene.getEngine();this._meshes=[];this._scene=scene;this._vertexBuffers={};this._indices=[];this._updatable=updatable;if(vertexData){this.setAllVerticesData(vertexData,updatable)}else{this._totalVertices=0;this._indices=[]}if(this._engine.getCaps().vertexArrayObject){this._vertexArrayObjects={}}if(mesh){if(mesh.getClassName()==="LinesMesh"){this.boundingBias=new BABYLON.Vector2(0,mesh.intersectionThreshold);this.updateExtend()}this.applyToMesh(mesh);mesh.computeWorldMatrix(true)}}Object.defineProperty(Geometry.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(value){if(this._boundingBias&&this._boundingBias.equals(value)){return}this._boundingBias=value.clone();this.updateBoundingInfo(true,null)},enumerable:true,configurable:true});Object.defineProperty(Geometry.prototype,"extend",{get:function(){return this._extend},enumerable:true,configurable:true});Geometry.prototype.getScene=function(){return this._scene};Geometry.prototype.getEngine=function(){return this._engine};Geometry.prototype.isReady=function(){return this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADED||this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_NONE};Object.defineProperty(Geometry.prototype,"doNotSerialize",{get:function(){for(var index=0;index<this._meshes.length;index++){if(!this._meshes[index].doNotSerialize){return false}}return true},enumerable:true,configurable:true});Geometry.prototype._rebuild=function(){if(this._vertexArrayObjects){this._vertexArrayObjects={}}if(this._meshes.length!==0&&this._indices){this._indexBuffer=this._engine.createIndexBuffer(this._indices)}for(var key in this._vertexBuffers){var vertexBuffer=this._vertexBuffers[key];vertexBuffer._rebuild()}};Geometry.prototype.setAllVerticesData=function(vertexData,updatable){vertexData.applyToGeometry(this,updatable);this.notifyUpdate()};Geometry.prototype.setVerticesData=function(kind,data,updatable,stride){var buffer=new BABYLON.VertexBuffer(this._engine,data,kind,updatable,this._meshes.length===0,stride);this.setVerticesBuffer(buffer)};Geometry.prototype.removeVerticesData=function(kind){if(this._vertexBuffers[kind]){this._vertexBuffers[kind].dispose();delete this._vertexBuffers[kind]}};Geometry.prototype.setVerticesBuffer=function(buffer){var kind=buffer.getKind();if(this._vertexBuffers[kind]){this._vertexBuffers[kind].dispose()}this._vertexBuffers[kind]=buffer;if(kind===BABYLON.VertexBuffer.PositionKind){var data=buffer.getData();var stride=buffer.getStrideSize();this._totalVertices=data.length/stride;this.updateExtend(data,stride);this._resetPointsArrayCache();var meshes=this._meshes;var numOfMeshes=meshes.length;for(var index=0;index<numOfMeshes;index++){var mesh=meshes[index];mesh._boundingInfo=new BABYLON.BoundingInfo(this._extend.minimum,this._extend.maximum);mesh._createGlobalSubMesh(false);mesh.computeWorldMatrix(true)}}this.notifyUpdate(kind);if(this._vertexArrayObjects){this._disposeVertexArrayObjects();this._vertexArrayObjects={}}};Geometry.prototype.updateVerticesDataDirectly=function(kind,data,offset){var vertexBuffer=this.getVertexBuffer(kind);if(!vertexBuffer){return}vertexBuffer.updateDirectly(data,offset);this.notifyUpdate(kind)};Geometry.prototype.updateVerticesData=function(kind,data,updateExtends){var vertexBuffer=this.getVertexBuffer(kind);if(!vertexBuffer){return}vertexBuffer.update(data);if(kind===BABYLON.VertexBuffer.PositionKind){var stride=vertexBuffer.getStrideSize();this._totalVertices=data.length/stride;this.updateBoundingInfo(updateExtends,data)}this.notifyUpdate(kind)};Geometry.prototype.updateBoundingInfo=function(updateExtends,data){if(updateExtends){this.updateExtend(data)}var meshes=this._meshes;var numOfMeshes=meshes.length;this._resetPointsArrayCache();for(var index=0;index<numOfMeshes;index++){var mesh=meshes[index];if(updateExtends){mesh._boundingInfo=new BABYLON.BoundingInfo(this._extend.minimum,this._extend.maximum);for(var subIndex=0;subIndex<mesh.subMeshes.length;subIndex++){var subMesh=mesh.subMeshes[subIndex];subMesh.refreshBoundingInfo()}}}};Geometry.prototype._bind=function(effect,indexToBind){if(indexToBind===void 0){indexToBind=undefined}if(indexToBind===undefined){indexToBind=this._indexBuffer}if(indexToBind!=this._indexBuffer||!this._vertexArrayObjects){this._engine.bindBuffers(this.getVertexBuffers(),indexToBind,effect);return}if(!this._vertexArrayObjects[effect.key]){this._vertexArrayObjects[effect.key]=this._engine.recordVertexArrayObject(this.getVertexBuffers(),indexToBind,effect)}this._engine.bindVertexArrayObject(this._vertexArrayObjects[effect.key],indexToBind)};Geometry.prototype.getTotalVertices=function(){if(!this.isReady()){return 0}return this._totalVertices};Geometry.prototype.getVerticesData=function(kind,copyWhenShared,forceCopy){var vertexBuffer=this.getVertexBuffer(kind);if(!vertexBuffer){return null}var orig=vertexBuffer.getData();if(!forceCopy&&(!copyWhenShared||this._meshes.length===1)){return orig}else{var len=orig.length;var copy=[];for(var i=0;i<len;i++){copy.push(orig[i])}return copy}};Geometry.prototype.getVertexBuffer=function(kind){if(!this.isReady()){return null}return this._vertexBuffers[kind]};Geometry.prototype.getVertexBuffers=function(){if(!this.isReady()){return null}return this._vertexBuffers};Geometry.prototype.isVerticesDataPresent=function(kind){if(!this._vertexBuffers){if(this._delayInfo){return this._delayInfo.indexOf(kind)!==-1}return false}return this._vertexBuffers[kind]!==undefined};Geometry.prototype.getVerticesDataKinds=function(){var result=[];var kind;if(!this._vertexBuffers&&this._delayInfo){for(kind in this._delayInfo){result.push(kind)}}else{for(kind in this._vertexBuffers){result.push(kind)}}return result};Geometry.prototype.updateIndices=function(indices,offset){if(!this._indexBuffer){return}if(!this._indexBufferIsUpdatable){this.setIndices(indices,null,true)}else{this._engine.updateDynamicIndexBuffer(this._indexBuffer,indices,offset)}};Geometry.prototype.setIndices=function(indices,totalVertices,updatable){if(this._indexBuffer){this._engine._releaseBuffer(this._indexBuffer)}this._disposeVertexArrayObjects();this._indices=indices;this._indexBufferIsUpdatable=updatable;if(this._meshes.length!==0&&this._indices){this._indexBuffer=this._engine.createIndexBuffer(this._indices,updatable)}if(totalVertices!=undefined){this._totalVertices=totalVertices}var meshes=this._meshes;var numOfMeshes=meshes.length;for(var index=0;index<numOfMeshes;index++){meshes[index]._createGlobalSubMesh(true)}this.notifyUpdate()};Geometry.prototype.getTotalIndices=function(){if(!this.isReady()){return 0}return this._indices.length};Geometry.prototype.getIndices=function(copyWhenShared){if(!this.isReady()){return null}var orig=this._indices;if(!copyWhenShared||this._meshes.length===1){return orig}else{var len=orig.length;var copy=[];for(var i=0;i<len;i++){copy.push(orig[i])}return copy}};Geometry.prototype.getIndexBuffer=function(){if(!this.isReady()){return null}return this._indexBuffer};Geometry.prototype._releaseVertexArrayObject=function(effect){if(!effect||!this._vertexArrayObjects){return}if(this._vertexArrayObjects[effect.key]){this._engine.releaseVertexArrayObject(this._vertexArrayObjects[effect.key]);delete this._vertexArrayObjects[effect.key]}};Geometry.prototype.releaseForMesh=function(mesh,shouldDispose){var meshes=this._meshes;var index=meshes.indexOf(mesh);if(index===-1){return}meshes.splice(index,1);mesh._geometry=null;if(meshes.length===0&&shouldDispose){this.dispose()}};Geometry.prototype.applyToMesh=function(mesh){if(mesh._geometry===this){return}var previousGeometry=mesh._geometry;if(previousGeometry){previousGeometry.releaseForMesh(mesh)}var meshes=this._meshes;mesh._geometry=this;this._scene.pushGeometry(this);meshes.push(mesh);if(this.isReady()){this._applyToMesh(mesh)}else{mesh._boundingInfo=this._boundingInfo}};Geometry.prototype.updateExtend=function(data,stride){if(data===void 0){data=null}if(!data){data=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind].getData()}this._extend=BABYLON.Tools.ExtractMinAndMax(data,0,this._totalVertices,this.boundingBias,stride)};Geometry.prototype._applyToMesh=function(mesh){var numOfMeshes=this._meshes.length;for(var kind in this._vertexBuffers){if(numOfMeshes===1){this._vertexBuffers[kind].create()}var buffer=this._vertexBuffers[kind].getBuffer();if(buffer)buffer.references=numOfMeshes;if(kind===BABYLON.VertexBuffer.PositionKind){if(!this._extend){this.updateExtend(this._vertexBuffers[kind].getData())}mesh._boundingInfo=new BABYLON.BoundingInfo(this._extend.minimum,this._extend.maximum);mesh._createGlobalSubMesh(false);mesh._updateBoundingInfo()}}if(numOfMeshes===1&&this._indices&&this._indices.length>0){this._indexBuffer=this._engine.createIndexBuffer(this._indices)}if(this._indexBuffer){this._indexBuffer.references=numOfMeshes}};Geometry.prototype.notifyUpdate=function(kind){if(this.onGeometryUpdated){this.onGeometryUpdated(this,kind)}for(var _i=0,_a=this._meshes;_i<_a.length;_i++){var mesh=_a[_i];mesh._markSubMeshesAsAttributesDirty()}};Geometry.prototype.load=function(scene,onLoaded){if(this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADING){return}if(this.isReady()){if(onLoaded){onLoaded()}return}this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADING;this._queueLoad(scene,onLoaded)};Geometry.prototype._queueLoad=function(scene,onLoaded){var _this=this;scene._addPendingData(this);BABYLON.Tools.LoadFile(this.delayLoadingFile,function(data){_this._delayLoadingFunction(JSON.parse(data),_this);_this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED;_this._delayInfo=[];scene._removePendingData(_this);var meshes=_this._meshes;var numOfMeshes=meshes.length;for(var index=0;index<numOfMeshes;index++){_this._applyToMesh(meshes[index])}if(onLoaded){onLoaded()}},function(){},scene.database)};Geometry.prototype.toLeftHanded=function(){var tIndices=this.getIndices(false);if(tIndices!=null&&tIndices.length>0){for(var i=0;i<tIndices.length;i+=3){var tTemp=tIndices[i+0];tIndices[i+0]=tIndices[i+2];tIndices[i+2]=tTemp}this.setIndices(tIndices)}var tPositions=this.getVerticesData(BABYLON.VertexBuffer.PositionKind,false);if(tPositions!=null&&tPositions.length>0){for(var i=0;i<tPositions.length;i+=3){tPositions[i+2]=-tPositions[i+2]}this.setVerticesData(BABYLON.VertexBuffer.PositionKind,tPositions,false)}var tNormals=this.getVerticesData(BABYLON.VertexBuffer.NormalKind,false);if(tNormals!=null&&tNormals.length>0){for(var i=0;i<tNormals.length;i+=3){tNormals[i+2]=-tNormals[i+2]}this.setVerticesData(BABYLON.VertexBuffer.NormalKind,tNormals,false)}};Geometry.prototype._resetPointsArrayCache=function(){this._positions=null};Geometry.prototype._generatePointsArray=function(){if(this._positions)return true;this._positions=[];var data=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(!data){return false}for(var index=0;index<data.length;index+=3){this._positions.push(BABYLON.Vector3.FromArray(data,index))}return true};Geometry.prototype.isDisposed=function(){return this._isDisposed};Geometry.prototype._disposeVertexArrayObjects=function(){if(this._vertexArrayObjects){for(var kind in this._vertexArrayObjects){this._engine.releaseVertexArrayObject(this._vertexArrayObjects[kind])}this._vertexArrayObjects={}}};Geometry.prototype.dispose=function(){var meshes=this._meshes;var numOfMeshes=meshes.length;var index;for(index=0;index<numOfMeshes;index++){this.releaseForMesh(meshes[index])}this._meshes=[];this._disposeVertexArrayObjects();for(var kind in this._vertexBuffers){this._vertexBuffers[kind].dispose()}this._vertexBuffers={};this._totalVertices=0;if(this._indexBuffer){this._engine._releaseBuffer(this._indexBuffer)}this._indexBuffer=null;this._indices=[];this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NONE;this.delayLoadingFile=null;this._delayLoadingFunction=null;this._delayInfo=[];this._boundingInfo=null;this._scene.removeGeometry(this);this._isDisposed=true};Geometry.prototype.copy=function(id){var vertexData=new BABYLON.VertexData;vertexData.indices=[];var indices=this.getIndices();for(var index=0;index<indices.length;index++){vertexData.indices.push(indices[index])}var updatable=false;var stopChecking=false;var kind;for(kind in this._vertexBuffers){var data=this.getVerticesData(kind);if(data instanceof Float32Array){vertexData.set(new Float32Array(data),kind)}else{vertexData.set(data.slice(0),kind)}if(!stopChecking){updatable=this.getVertexBuffer(kind).isUpdatable();stopChecking=!updatable}}var geometry=new Geometry(id,this._scene,vertexData,updatable,null);geometry.delayLoadState=this.delayLoadState;geometry.delayLoadingFile=this.delayLoadingFile;geometry._delayLoadingFunction=this._delayLoadingFunction;for(kind in this._delayInfo){geometry._delayInfo=geometry._delayInfo||[];geometry._delayInfo.push(kind)}geometry._boundingInfo=new BABYLON.BoundingInfo(this._extend.minimum,this._extend.maximum);return geometry};Geometry.prototype.serialize=function(){var serializationObject={};serializationObject.id=this.id;serializationObject.updatable=this._updatable;if(BABYLON.Tags&&BABYLON.Tags.HasTags(this)){serializationObject.tags=BABYLON.Tags.GetTags(this)}return serializationObject};Geometry.prototype.toNumberArray=function(origin){if(Array.isArray(origin)){return origin}else{return Array.prototype.slice.call(origin)}};Geometry.prototype.serializeVerticeData=function(){var serializationObject=this.serialize();if(this.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind)){serializationObject.positions=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.PositionKind));if(this.getVertexBuffer(BABYLON.VertexBuffer.PositionKind).isUpdatable){serializationObject.positions._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){serializationObject.normals=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.NormalKind));if(this.getVertexBuffer(BABYLON.VertexBuffer.NormalKind).isUpdatable){serializationObject.normals._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){serializationObject.uvs=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.UVKind));if(this.getVertexBuffer(BABYLON.VertexBuffer.UVKind).isUpdatable){serializationObject.uvs._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)){serializationObject.uv2s=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.UV2Kind));if(this.getVertexBuffer(BABYLON.VertexBuffer.UV2Kind).isUpdatable){serializationObject.uv2s._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.UV3Kind)){serializationObject.uv3s=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.UV3Kind));if(this.getVertexBuffer(BABYLON.VertexBuffer.UV3Kind).isUpdatable){serializationObject.uv3s._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.UV4Kind)){serializationObject.uv4s=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.UV4Kind));if(this.getVertexBuffer(BABYLON.VertexBuffer.UV4Kind).isUpdatable){serializationObject.uv4s._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.UV5Kind)){serializationObject.uv5s=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.UV5Kind));if(this.getVertexBuffer(BABYLON.VertexBuffer.UV5Kind).isUpdatable){serializationObject.uv5s._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.UV6Kind)){serializationObject.uv6s=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.UV6Kind));if(this.getVertexBuffer(BABYLON.VertexBuffer.UV6Kind).isUpdatable){serializationObject.uv6s._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.ColorKind)){serializationObject.colors=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.ColorKind));if(this.getVertexBuffer(BABYLON.VertexBuffer.ColorKind).isUpdatable){serializationObject.colors._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)){serializationObject.matricesIndices=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind));serializationObject.matricesIndices._isExpanded=true;if(this.getVertexBuffer(BABYLON.VertexBuffer.MatricesIndicesKind).isUpdatable){serializationObject.matricesIndices._updatable=true}}if(this.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)){serializationObject.matricesWeights=this.toNumberArray(this.getVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind));if(this.getVertexBuffer(BABYLON.VertexBuffer.MatricesWeightsKind).isUpdatable){serializationObject.matricesWeights._updatable=true}}serializationObject.indices=this.toNumberArray(this.getIndices());return serializationObject};Geometry.ExtractFromMesh=function(mesh,id){var geometry=mesh._geometry;if(!geometry){return null}return geometry.copy(id)};Geometry.RandomId=function(){return BABYLON.Tools.RandomId()};Geometry.ImportGeometry=function(parsedGeometry,mesh){var scene=mesh.getScene();var geometryId=parsedGeometry.geometryId;if(geometryId){var geometry=scene.getGeometryByID(geometryId);if(geometry){geometry.applyToMesh(mesh)}}else if(parsedGeometry instanceof ArrayBuffer){var binaryInfo=mesh._binaryInfo;if(binaryInfo.positionsAttrDesc&&binaryInfo.positionsAttrDesc.count>0){var positionsData=new Float32Array(parsedGeometry,binaryInfo.positionsAttrDesc.offset,binaryInfo.positionsAttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.PositionKind,positionsData,false)}if(binaryInfo.normalsAttrDesc&&binaryInfo.normalsAttrDesc.count>0){var normalsData=new Float32Array(parsedGeometry,binaryInfo.normalsAttrDesc.offset,binaryInfo.normalsAttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.NormalKind,normalsData,false)}if(binaryInfo.uvsAttrDesc&&binaryInfo.uvsAttrDesc.count>0){var uvsData=new Float32Array(parsedGeometry,binaryInfo.uvsAttrDesc.offset,binaryInfo.uvsAttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.UVKind,uvsData,false)}if(binaryInfo.uvs2AttrDesc&&binaryInfo.uvs2AttrDesc.count>0){var uvs2Data=new Float32Array(parsedGeometry,binaryInfo.uvs2AttrDesc.offset,binaryInfo.uvs2AttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.UV2Kind,uvs2Data,false)}if(binaryInfo.uvs3AttrDesc&&binaryInfo.uvs3AttrDesc.count>0){var uvs3Data=new Float32Array(parsedGeometry,binaryInfo.uvs3AttrDesc.offset,binaryInfo.uvs3AttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.UV3Kind,uvs3Data,false)}if(binaryInfo.uvs4AttrDesc&&binaryInfo.uvs4AttrDesc.count>0){var uvs4Data=new Float32Array(parsedGeometry,binaryInfo.uvs4AttrDesc.offset,binaryInfo.uvs4AttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.UV4Kind,uvs4Data,false)}if(binaryInfo.uvs5AttrDesc&&binaryInfo.uvs5AttrDesc.count>0){var uvs5Data=new Float32Array(parsedGeometry,binaryInfo.uvs5AttrDesc.offset,binaryInfo.uvs5AttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.UV5Kind,uvs5Data,false)}if(binaryInfo.uvs6AttrDesc&&binaryInfo.uvs6AttrDesc.count>0){var uvs6Data=new Float32Array(parsedGeometry,binaryInfo.uvs6AttrDesc.offset,binaryInfo.uvs6AttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.UV6Kind,uvs6Data,false)}if(binaryInfo.colorsAttrDesc&&binaryInfo.colorsAttrDesc.count>0){var colorsData=new Float32Array(parsedGeometry,binaryInfo.colorsAttrDesc.offset,binaryInfo.colorsAttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.ColorKind,colorsData,false,binaryInfo.colorsAttrDesc.stride)}if(binaryInfo.matricesIndicesAttrDesc&&binaryInfo.matricesIndicesAttrDesc.count>0){var matricesIndicesData=new Int32Array(parsedGeometry,binaryInfo.matricesIndicesAttrDesc.offset,binaryInfo.matricesIndicesAttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,matricesIndicesData,false)}if(binaryInfo.matricesWeightsAttrDesc&&binaryInfo.matricesWeightsAttrDesc.count>0){var matricesWeightsData=new Float32Array(parsedGeometry,binaryInfo.matricesWeightsAttrDesc.offset,binaryInfo.matricesWeightsAttrDesc.count);mesh.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind,matricesWeightsData,false)}if(binaryInfo.indicesAttrDesc&&binaryInfo.indicesAttrDesc.count>0){var indicesData=new Int32Array(parsedGeometry,binaryInfo.indicesAttrDesc.offset,binaryInfo.indicesAttrDesc.count);mesh.setIndices(indicesData)}if(binaryInfo.subMeshesAttrDesc&&binaryInfo.subMeshesAttrDesc.count>0){var subMeshesData=new Int32Array(parsedGeometry,binaryInfo.subMeshesAttrDesc.offset,binaryInfo.subMeshesAttrDesc.count*5);mesh.subMeshes=[];for(var i=0;i<binaryInfo.subMeshesAttrDesc.count;i++){var materialIndex=subMeshesData[i*5+0];var verticesStart=subMeshesData[i*5+1];var verticesCount=subMeshesData[i*5+2];var indexStart=subMeshesData[i*5+3];var indexCount=subMeshesData[i*5+4];BABYLON.SubMesh.AddToMesh(materialIndex,verticesStart,verticesCount,indexStart,indexCount,mesh)}}}else if(parsedGeometry.positions&&parsedGeometry.normals&&parsedGeometry.indices){mesh.setVerticesData(BABYLON.VertexBuffer.PositionKind,parsedGeometry.positions,parsedGeometry.positions._updatable);mesh.setVerticesData(BABYLON.VertexBuffer.NormalKind,parsedGeometry.normals,parsedGeometry.normals._updatable);if(parsedGeometry.uvs){mesh.setVerticesData(BABYLON.VertexBuffer.UVKind,parsedGeometry.uvs,parsedGeometry.uvs._updatable)}if(parsedGeometry.uvs2){mesh.setVerticesData(BABYLON.VertexBuffer.UV2Kind,parsedGeometry.uvs2,parsedGeometry.uvs2._updatable)}if(parsedGeometry.uvs3){mesh.setVerticesData(BABYLON.VertexBuffer.UV3Kind,parsedGeometry.uvs3,parsedGeometry.uvs3._updatable)}if(parsedGeometry.uvs4){mesh.setVerticesData(BABYLON.VertexBuffer.UV4Kind,parsedGeometry.uvs4,parsedGeometry.uvs4._updatable)}if(parsedGeometry.uvs5){mesh.setVerticesData(BABYLON.VertexBuffer.UV5Kind,parsedGeometry.uvs5,parsedGeometry.uvs5._updatable)}if(parsedGeometry.uvs6){mesh.setVerticesData(BABYLON.VertexBuffer.UV6Kind,parsedGeometry.uvs6,parsedGeometry.uvs6._updatable)}if(parsedGeometry.colors){mesh.setVerticesData(BABYLON.VertexBuffer.ColorKind,BABYLON.Color4.CheckColors4(parsedGeometry.colors,parsedGeometry.positions.length/3),parsedGeometry.colors._updatable)}if(parsedGeometry.matricesIndices){if(!parsedGeometry.matricesIndices._isExpanded){var floatIndices=[];for(var i=0;i<parsedGeometry.matricesIndices.length;i++){var matricesIndex=parsedGeometry.matricesIndices[i];floatIndices.push(matricesIndex&255);floatIndices.push((matricesIndex&65280)>>8);floatIndices.push((matricesIndex&16711680)>>16);floatIndices.push(matricesIndex>>24)}mesh.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,floatIndices,parsedGeometry.matricesIndices._updatable)}else{delete parsedGeometry.matricesIndices._isExpanded;mesh.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,parsedGeometry.matricesIndices,parsedGeometry.matricesIndices._updatable)}}if(parsedGeometry.matricesIndicesExtra){if(!parsedGeometry.matricesIndicesExtra._isExpanded){var floatIndices=[];for(var i=0;i<parsedGeometry.matricesIndicesExtra.length;i++){var matricesIndex=parsedGeometry.matricesIndicesExtra[i];floatIndices.push(matricesIndex&255);floatIndices.push((matricesIndex&65280)>>8);floatIndices.push((matricesIndex&16711680)>>16);floatIndices.push(matricesIndex>>24)}mesh.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesExtraKind,floatIndices,parsedGeometry.matricesIndicesExtra._updatable)}else{delete parsedGeometry.matricesIndices._isExpanded;mesh.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesExtraKind,parsedGeometry.matricesIndicesExtra,parsedGeometry.matricesIndicesExtra._updatable)}}if(parsedGeometry.matricesWeights){Geometry._CleanMatricesWeights(parsedGeometry,mesh);mesh.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind,parsedGeometry.matricesWeights,parsedGeometry.matricesWeights._updatable)}if(parsedGeometry.matricesWeightsExtra){mesh.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsExtraKind,parsedGeometry.matricesWeightsExtra,parsedGeometry.matricesWeights._updatable)}mesh.setIndices(parsedGeometry.indices)}if(parsedGeometry.subMeshes){mesh.subMeshes=[];for(var subIndex=0;subIndex<parsedGeometry.subMeshes.length;subIndex++){var parsedSubMesh=parsedGeometry.subMeshes[subIndex];BABYLON.SubMesh.AddToMesh(parsedSubMesh.materialIndex,parsedSubMesh.verticesStart,parsedSubMesh.verticesCount,parsedSubMesh.indexStart,parsedSubMesh.indexCount,mesh)}}if(mesh._shouldGenerateFlatShading){mesh.convertToFlatShadedMesh();delete mesh._shouldGenerateFlatShading}mesh.computeWorldMatrix(true);if(scene["_selectionOctree"]){scene["_selectionOctree"].addMesh(mesh)}};Geometry._CleanMatricesWeights=function(parsedGeometry,mesh){var epsilon=.001;if(!BABYLON.SceneLoader.CleanBoneMatrixWeights){return}var noInfluenceBoneIndex=0;if(parsedGeometry.skeletonId>-1){var skeleton=mesh.getScene().getLastSkeletonByID(parsedGeometry.skeletonId);noInfluenceBoneIndex=skeleton.bones.length}else{return}var matricesIndices=mesh.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind);var matricesIndicesExtra=mesh.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesExtraKind);var matricesWeights=parsedGeometry.matricesWeights;var matricesWeightsExtra=parsedGeometry.matricesWeightsExtra;var influencers=parsedGeometry.numBoneInfluencer;var size=matricesWeights.length;for(var i=0;i<size;i+=4){var weight=0;var firstZeroWeight=-1;for(var j=0;j<4;j++){var w=matricesWeights[i+j];weight+=w;if(w<epsilon&&firstZeroWeight<0){firstZeroWeight=j}}if(matricesWeightsExtra){for(var j=0;j<4;j++){var w=matricesWeightsExtra[i+j];weight+=w;if(w<epsilon&&firstZeroWeight<0){firstZeroWeight=j+4}}}if(firstZeroWeight<0||firstZeroWeight>influencers-1){firstZeroWeight=influencers-1}if(weight>epsilon){var mweight=1/weight;for(var j=0;j<4;j++){matricesWeights[i+j]*=mweight}if(matricesWeightsExtra){for(var j=0;j<4;j++){matricesWeightsExtra[i+j]*=mweight}}}else{if(firstZeroWeight>=4){matricesWeightsExtra[i+firstZeroWeight-4]=1-weight;matricesIndicesExtra[i+firstZeroWeight-4]=noInfluenceBoneIndex}else{matricesWeights[i+firstZeroWeight]=1-weight;matricesIndices[i+firstZeroWeight]=noInfluenceBoneIndex}}}mesh.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,matricesIndices);if(parsedGeometry.matricesWeightsExtra){mesh.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesExtraKind,matricesIndicesExtra)}};Geometry.Parse=function(parsedVertexData,scene,rootUrl){if(scene.getGeometryByID(parsedVertexData.id)){return null}var geometry=new Geometry(parsedVertexData.id,scene,null,parsedVertexData.updatable);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(geometry,parsedVertexData.tags)}if(parsedVertexData.delayLoadingFile){geometry.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED;geometry.delayLoadingFile=rootUrl+parsedVertexData.delayLoadingFile;geometry._boundingInfo=new BABYLON.BoundingInfo(BABYLON.Vector3.FromArray(parsedVertexData.boundingBoxMinimum),BABYLON.Vector3.FromArray(parsedVertexData.boundingBoxMaximum));geometry._delayInfo=[];if(parsedVertexData.hasUVs){geometry._delayInfo.push(BABYLON.VertexBuffer.UVKind)}if(parsedVertexData.hasUVs2){geometry._delayInfo.push(BABYLON.VertexBuffer.UV2Kind)}if(parsedVertexData.hasUVs3){geometry._delayInfo.push(BABYLON.VertexBuffer.UV3Kind)}if(parsedVertexData.hasUVs4){geometry._delayInfo.push(BABYLON.VertexBuffer.UV4Kind)}if(parsedVertexData.hasUVs5){geometry._delayInfo.push(BABYLON.VertexBuffer.UV5Kind)}if(parsedVertexData.hasUVs6){geometry._delayInfo.push(BABYLON.VertexBuffer.UV6Kind)}if(parsedVertexData.hasColors){geometry._delayInfo.push(BABYLON.VertexBuffer.ColorKind)}if(parsedVertexData.hasMatricesIndices){geometry._delayInfo.push(BABYLON.VertexBuffer.MatricesIndicesKind)}if(parsedVertexData.hasMatricesWeights){geometry._delayInfo.push(BABYLON.VertexBuffer.MatricesWeightsKind)}geometry._delayLoadingFunction=BABYLON.VertexData.ImportVertexData}else{BABYLON.VertexData.ImportVertexData(parsedVertexData,geometry)}scene.pushGeometry(geometry,true);return geometry};return Geometry}();BABYLON.Geometry=Geometry;(function(Geometry){var Primitives;(function(Primitives){var _Primitive=function(_super){__extends(_Primitive,_super);function _Primitive(id,scene,_canBeRegenerated,mesh){var _this=_super.call(this,id,scene,null,false,mesh)||this;_this._canBeRegenerated=_canBeRegenerated;_this._beingRegenerated=true;_this.regenerate();_this._beingRegenerated=false;return _this}_Primitive.prototype.canBeRegenerated=function(){return this._canBeRegenerated};_Primitive.prototype.regenerate=function(){if(!this._canBeRegenerated){return}this._beingRegenerated=true;this.setAllVerticesData(this._regenerateVertexData(),false);this._beingRegenerated=false};_Primitive.prototype.asNewGeometry=function(id){return _super.prototype.copy.call(this,id)};_Primitive.prototype.setAllVerticesData=function(vertexData,updatable){if(!this._beingRegenerated){return}_super.prototype.setAllVerticesData.call(this,vertexData,false)};_Primitive.prototype.setVerticesData=function(kind,data,updatable){if(!this._beingRegenerated){return}_super.prototype.setVerticesData.call(this,kind,data,false)};_Primitive.prototype._regenerateVertexData=function(){throw new Error("Abstract method")};_Primitive.prototype.copy=function(id){throw new Error("Must be overriden in sub-classes.")};_Primitive.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);serializationObject.canBeRegenerated=this.canBeRegenerated();return serializationObject};return _Primitive}(Geometry);Primitives._Primitive=_Primitive;var Ribbon=function(_super){__extends(Ribbon,_super);function Ribbon(id,scene,pathArray,closeArray,closePath,offset,canBeRegenerated,mesh,side){if(side===void 0){side=BABYLON.Mesh.DEFAULTSIDE}var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.pathArray=pathArray;_this.closeArray=closeArray;_this.closePath=closePath;_this.offset=offset;_this.side=side;return _this}Ribbon.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateRibbon({pathArray:this.pathArray,closeArray:this.closeArray,closePath:this.closePath,offset:this.offset,sideOrientation:this.side})};Ribbon.prototype.copy=function(id){return new Ribbon(id,this.getScene(),this.pathArray,this.closeArray,this.closePath,this.offset,this.canBeRegenerated(),null,this.side)};return Ribbon}(_Primitive);Primitives.Ribbon=Ribbon;var Box=function(_super){__extends(Box,_super);function Box(id,scene,size,canBeRegenerated,mesh,side){if(side===void 0){side=BABYLON.Mesh.DEFAULTSIDE}var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.size=size;_this.side=side;return _this}Box.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateBox({size:this.size,sideOrientation:this.side})};Box.prototype.copy=function(id){return new Box(id,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)};Box.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);serializationObject.size=this.size;return serializationObject};Box.Parse=function(parsedBox,scene){if(scene.getGeometryByID(parsedBox.id)){return null}var box=new Geometry.Primitives.Box(parsedBox.id,scene,parsedBox.size,parsedBox.canBeRegenerated,null);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(box,parsedBox.tags)}scene.pushGeometry(box,true);return box};return Box}(_Primitive);Primitives.Box=Box;var Sphere=function(_super){__extends(Sphere,_super);function Sphere(id,scene,segments,diameter,canBeRegenerated,mesh,side){if(side===void 0){side=BABYLON.Mesh.DEFAULTSIDE}var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.segments=segments;_this.diameter=diameter;_this.side=side;return _this}Sphere.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateSphere({segments:this.segments,diameter:this.diameter,sideOrientation:this.side})};Sphere.prototype.copy=function(id){return new Sphere(id,this.getScene(),this.segments,this.diameter,this.canBeRegenerated(),null,this.side)};Sphere.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);serializationObject.segments=this.segments;serializationObject.diameter=this.diameter;return serializationObject};Sphere.Parse=function(parsedSphere,scene){if(scene.getGeometryByID(parsedSphere.id)){return null}var sphere=new Geometry.Primitives.Sphere(parsedSphere.id,scene,parsedSphere.segments,parsedSphere.diameter,parsedSphere.canBeRegenerated,null);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(sphere,parsedSphere.tags)}scene.pushGeometry(sphere,true);return sphere};return Sphere}(_Primitive);Primitives.Sphere=Sphere;var Disc=function(_super){__extends(Disc,_super);function Disc(id,scene,radius,tessellation,canBeRegenerated,mesh,side){if(side===void 0){side=BABYLON.Mesh.DEFAULTSIDE}var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.radius=radius;_this.tessellation=tessellation;_this.side=side;return _this}Disc.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateDisc({radius:this.radius,tessellation:this.tessellation,sideOrientation:this.side})};Disc.prototype.copy=function(id){return new Disc(id,this.getScene(),this.radius,this.tessellation,this.canBeRegenerated(),null,this.side)};return Disc}(_Primitive);Primitives.Disc=Disc;var Cylinder=function(_super){__extends(Cylinder,_super);function Cylinder(id,scene,height,diameterTop,diameterBottom,tessellation,subdivisions,canBeRegenerated,mesh,side){if(subdivisions===void 0){subdivisions=1}if(side===void 0){side=BABYLON.Mesh.DEFAULTSIDE}var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.height=height;_this.diameterTop=diameterTop;_this.diameterBottom=diameterBottom;_this.tessellation=tessellation;_this.subdivisions=subdivisions;_this.side=side;return _this}Cylinder.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateCylinder({height:this.height,diameterTop:this.diameterTop,diameterBottom:this.diameterBottom,tessellation:this.tessellation,subdivisions:this.subdivisions,sideOrientation:this.side})};Cylinder.prototype.copy=function(id){return new Cylinder(id,this.getScene(),this.height,this.diameterTop,this.diameterBottom,this.tessellation,this.subdivisions,this.canBeRegenerated(),null,this.side)};Cylinder.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);serializationObject.height=this.height;serializationObject.diameterTop=this.diameterTop;serializationObject.diameterBottom=this.diameterBottom;serializationObject.tessellation=this.tessellation;return serializationObject};Cylinder.Parse=function(parsedCylinder,scene){if(scene.getGeometryByID(parsedCylinder.id)){return null}var cylinder=new Geometry.Primitives.Cylinder(parsedCylinder.id,scene,parsedCylinder.height,parsedCylinder.diameterTop,parsedCylinder.diameterBottom,parsedCylinder.tessellation,parsedCylinder.subdivisions,parsedCylinder.canBeRegenerated,null);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(cylinder,parsedCylinder.tags)}scene.pushGeometry(cylinder,true);return cylinder};return Cylinder}(_Primitive);Primitives.Cylinder=Cylinder;var Torus=function(_super){__extends(Torus,_super);function Torus(id,scene,diameter,thickness,tessellation,canBeRegenerated,mesh,side){if(side===void 0){side=BABYLON.Mesh.DEFAULTSIDE}var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.diameter=diameter;_this.thickness=thickness;_this.tessellation=tessellation;_this.side=side;return _this}Torus.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateTorus({diameter:this.diameter,thickness:this.thickness,tessellation:this.tessellation,sideOrientation:this.side})};Torus.prototype.copy=function(id){return new Torus(id,this.getScene(),this.diameter,this.thickness,this.tessellation,this.canBeRegenerated(),null,this.side)};Torus.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);serializationObject.diameter=this.diameter;serializationObject.thickness=this.thickness;serializationObject.tessellation=this.tessellation;return serializationObject};Torus.Parse=function(parsedTorus,scene){if(scene.getGeometryByID(parsedTorus.id)){return null}var torus=new Geometry.Primitives.Torus(parsedTorus.id,scene,parsedTorus.diameter,parsedTorus.thickness,parsedTorus.tessellation,parsedTorus.canBeRegenerated,null);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(torus,parsedTorus.tags)}scene.pushGeometry(torus,true);return torus};return Torus}(_Primitive);Primitives.Torus=Torus;var Ground=function(_super){__extends(Ground,_super);function Ground(id,scene,width,height,subdivisions,canBeRegenerated,mesh){var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.width=width;_this.height=height;_this.subdivisions=subdivisions;return _this}Ground.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateGround({width:this.width,height:this.height,subdivisions:this.subdivisions})};Ground.prototype.copy=function(id){return new Ground(id,this.getScene(),this.width,this.height,this.subdivisions,this.canBeRegenerated(),null)};Ground.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);serializationObject.width=this.width;serializationObject.height=this.height;serializationObject.subdivisions=this.subdivisions;return serializationObject};Ground.Parse=function(parsedGround,scene){if(scene.getGeometryByID(parsedGround.id)){return null}var ground=new Geometry.Primitives.Ground(parsedGround.id,scene,parsedGround.width,parsedGround.height,parsedGround.subdivisions,parsedGround.canBeRegenerated,null);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(ground,parsedGround.tags)}scene.pushGeometry(ground,true);return ground};return Ground}(_Primitive);Primitives.Ground=Ground;var TiledGround=function(_super){__extends(TiledGround,_super);function TiledGround(id,scene,xmin,zmin,xmax,zmax,subdivisions,precision,canBeRegenerated,mesh){var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.xmin=xmin;_this.zmin=zmin;_this.xmax=xmax;_this.zmax=zmax;_this.subdivisions=subdivisions;_this.precision=precision;return _this}TiledGround.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateTiledGround({xmin:this.xmin,zmin:this.zmin,xmax:this.xmax,zmax:this.zmax,subdivisions:this.subdivisions,precision:this.precision})};TiledGround.prototype.copy=function(id){return new TiledGround(id,this.getScene(),this.xmin,this.zmin,this.xmax,this.zmax,this.subdivisions,this.precision,this.canBeRegenerated(),null)};return TiledGround}(_Primitive);Primitives.TiledGround=TiledGround;var Plane=function(_super){__extends(Plane,_super);function Plane(id,scene,size,canBeRegenerated,mesh,side){if(side===void 0){side=BABYLON.Mesh.DEFAULTSIDE}var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.size=size;_this.side=side;return _this}Plane.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreatePlane({size:this.size,sideOrientation:this.side})};Plane.prototype.copy=function(id){return new Plane(id,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)};Plane.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);serializationObject.size=this.size;return serializationObject};Plane.Parse=function(parsedPlane,scene){if(scene.getGeometryByID(parsedPlane.id)){return null}var plane=new Geometry.Primitives.Plane(parsedPlane.id,scene,parsedPlane.size,parsedPlane.canBeRegenerated,null);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(plane,parsedPlane.tags)}scene.pushGeometry(plane,true);return plane};return Plane}(_Primitive);Primitives.Plane=Plane;var TorusKnot=function(_super){__extends(TorusKnot,_super);function TorusKnot(id,scene,radius,tube,radialSegments,tubularSegments,p,q,canBeRegenerated,mesh,side){if(side===void 0){side=BABYLON.Mesh.DEFAULTSIDE}var _this=_super.call(this,id,scene,canBeRegenerated,mesh)||this;_this.radius=radius;_this.tube=tube;_this.radialSegments=radialSegments;_this.tubularSegments=tubularSegments;_this.p=p;_this.q=q;_this.side=side;return _this}TorusKnot.prototype._regenerateVertexData=function(){return BABYLON.VertexData.CreateTorusKnot({radius:this.radius,tube:this.tube,radialSegments:this.radialSegments,tubularSegments:this.tubularSegments,p:this.p,q:this.q,sideOrientation:this.side})};TorusKnot.prototype.copy=function(id){return new TorusKnot(id,this.getScene(),this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q,this.canBeRegenerated(),null,this.side)};TorusKnot.prototype.serialize=function(){var serializationObject=_super.prototype.serialize.call(this);serializationObject.radius=this.radius;serializationObject.tube=this.tube;serializationObject.radialSegments=this.radialSegments;serializationObject.tubularSegments=this.tubularSegments;serializationObject.p=this.p;serializationObject.q=this.q;return serializationObject};TorusKnot.Parse=function(parsedTorusKnot,scene){if(scene.getGeometryByID(parsedTorusKnot.id)){return null}var torusKnot=new Geometry.Primitives.TorusKnot(parsedTorusKnot.id,scene,parsedTorusKnot.radius,parsedTorusKnot.tube,parsedTorusKnot.radialSegments,parsedTorusKnot.tubularSegments,parsedTorusKnot.p,parsedTorusKnot.q,parsedTorusKnot.canBeRegenerated,null);if(BABYLON.Tags){BABYLON.Tags.AddTagsTo(torusKnot,parsedTorusKnot.tags)}scene.pushGeometry(torusKnot,true);return torusKnot};return TorusKnot}(_Primitive);Primitives.TorusKnot=TorusKnot})(Primitives=Geometry.Primitives||(Geometry.Primitives={}))})(Geometry=BABYLON.Geometry||(BABYLON.Geometry={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PostProcessManager=function(){function PostProcessManager(scene){this._vertexBuffers={};this._scene=scene}PostProcessManager.prototype._prepareBuffers=function(){if(this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]){return}var vertices=[];vertices.push(1,1);vertices.push(-1,1);vertices.push(-1,-1);vertices.push(1,-1);this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=new BABYLON.VertexBuffer(this._scene.getEngine(),vertices,BABYLON.VertexBuffer.PositionKind,false,false,2);this._buildIndexBuffer()};PostProcessManager.prototype._buildIndexBuffer=function(){var indices=[];indices.push(0);indices.push(1);indices.push(2);indices.push(0);indices.push(2);indices.push(3);this._indexBuffer=this._scene.getEngine().createIndexBuffer(indices)};PostProcessManager.prototype._rebuild=function(){if(!this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]){return}this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]._rebuild();this._buildIndexBuffer()};PostProcessManager.prototype._prepareFrame=function(sourceTexture,postProcesses){var postProcesses=postProcesses||this._scene.activeCamera._postProcesses;if(postProcesses.length===0||!this._scene.postProcessesEnabled){return false}postProcesses[0].activate(this._scene.activeCamera,sourceTexture,postProcesses!==null&&postProcesses!==undefined);return true};PostProcessManager.prototype.directRender=function(postProcesses,targetTexture,forceFullscreenViewport){if(forceFullscreenViewport===void 0){forceFullscreenViewport=false}var engine=this._scene.getEngine();for(var index=0;index<postProcesses.length;index++){if(index<postProcesses.length-1){postProcesses[index+1].activate(this._scene.activeCamera,targetTexture)}else{if(targetTexture){engine.bindFramebuffer(targetTexture,0,null,null,forceFullscreenViewport)}else{engine.restoreDefaultFramebuffer()}}var pp=postProcesses[index];var effect=pp.apply();if(effect){pp.onBeforeRenderObservable.notifyObservers(effect);this._prepareBuffers();engine.bindBuffers(this._vertexBuffers,this._indexBuffer,effect);engine.draw(true,0,6);pp.onAfterRenderObservable.notifyObservers(effect)}}engine.setDepthBuffer(true);engine.setDepthWrite(true)};PostProcessManager.prototype._finalizeFrame=function(doNotPresent,targetTexture,faceIndex,postProcesses,forceFullscreenViewport){if(forceFullscreenViewport===void 0){forceFullscreenViewport=false}postProcesses=postProcesses||this._scene.activeCamera._postProcesses;if(postProcesses.length===0||!this._scene.postProcessesEnabled){return}var engine=this._scene.getEngine();for(var index=0,len=postProcesses.length;index<len;index++){if(index<len-1){postProcesses[index+1].activate(this._scene.activeCamera,targetTexture)}else{if(targetTexture){engine.bindFramebuffer(targetTexture,faceIndex,null,null,forceFullscreenViewport)}else{engine.restoreDefaultFramebuffer()}}if(doNotPresent){break}var pp=postProcesses[index];var effect=pp.apply();if(effect){pp.onBeforeRenderObservable.notifyObservers(effect);this._prepareBuffers();engine.bindBuffers(this._vertexBuffers,this._indexBuffer,effect);engine.draw(true,0,6);pp.onAfterRenderObservable.notifyObservers(effect)}}engine.setDepthBuffer(true);engine.setDepthWrite(true);engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE)};PostProcessManager.prototype.dispose=function(){var buffer=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind];if(buffer){buffer.dispose();this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}};return PostProcessManager}();BABYLON.PostProcessManager=PostProcessManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PerformanceMonitor=function(){function PerformanceMonitor(frameSampleSize){if(frameSampleSize===void 0){frameSampleSize=30}this._enabled=true;this._rollingFrameTime=new RollingAverage(frameSampleSize)}PerformanceMonitor.prototype.sampleFrame=function(timeMs){if(timeMs===void 0){timeMs=BABYLON.Tools.Now}if(!this._enabled)return;if(this._lastFrameTimeMs!=null){var dt=timeMs-this._lastFrameTimeMs;this._rollingFrameTime.add(dt)}this._lastFrameTimeMs=timeMs};Object.defineProperty(PerformanceMonitor.prototype,"averageFrameTime",{get:function(){return this._rollingFrameTime.average},enumerable:true,configurable:true});Object.defineProperty(PerformanceMonitor.prototype,"averageFrameTimeVariance",{get:function(){return this._rollingFrameTime.variance},enumerable:true,configurable:true});Object.defineProperty(PerformanceMonitor.prototype,"instantaneousFrameTime",{get:function(){return this._rollingFrameTime.history(0)},enumerable:true,configurable:true});Object.defineProperty(PerformanceMonitor.prototype,"averageFPS",{get:function(){return 1e3/this._rollingFrameTime.average},enumerable:true,configurable:true});Object.defineProperty(PerformanceMonitor.prototype,"instantaneousFPS",{get:function(){return 1e3/this._rollingFrameTime.history(0)},enumerable:true,configurable:true});Object.defineProperty(PerformanceMonitor.prototype,"isSaturated",{get:function(){return this._rollingFrameTime.isSaturated()},enumerable:true,configurable:true});PerformanceMonitor.prototype.enable=function(){this._enabled=true};PerformanceMonitor.prototype.disable=function(){this._enabled=false;this._lastFrameTimeMs=null;this._lastChangeTimeMs=null};Object.defineProperty(PerformanceMonitor.prototype,"isEnabled",{get:function(){return this._enabled},enumerable:true,configurable:true});PerformanceMonitor.prototype.reset=function(){this._lastFrameTimeMs=null;this._lastChangeTimeMs=null;this._rollingFrameTime.reset()};return PerformanceMonitor}();BABYLON.PerformanceMonitor=PerformanceMonitor;var RollingAverage=function(){function RollingAverage(length){this._samples=new Array(length);this.reset()}RollingAverage.prototype.add=function(v){var delta;if(this.isSaturated()){var bottomValue=this._samples[this._pos];delta=bottomValue-this.average;this.average-=delta/(this._sampleCount-1);this._m2-=delta*(bottomValue-this.average)}else{this._sampleCount++}delta=v-this.average;this.average+=delta/this._sampleCount;this._m2+=delta*(v-this.average);this.variance=this._m2/(this._sampleCount-1);this._samples[this._pos]=v;this._pos++;this._pos%=this._samples.length};RollingAverage.prototype.history=function(i){if(i>=this._sampleCount||i>=this._samples.length){return null}var i0=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(i0-i)]};RollingAverage.prototype.isSaturated=function(){return this._sampleCount>=this._samples.length};RollingAverage.prototype.reset=function(){this.average=0;this.variance=0;this._sampleCount=0;this._pos=0;this._m2=0};RollingAverage.prototype._wrapPosition=function(i){var max=this._samples.length;return(i%max+max)%max};return RollingAverage}();BABYLON.RollingAverage=RollingAverage})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ImageProcessingConfiguration=function(){function ImageProcessingConfiguration(){this.colorCurves=new BABYLON.ColorCurves;this._colorCurvesEnabled=false;this._colorGradingEnabled=false;this._colorGradingWithGreenDepth=false;this._colorGradingBGR=false;this._exposure=1;this._toneMappingEnabled=false;this._contrast=1;this.vignetteStretch=0;this.vignetteCentreX=0;this.vignetteCentreY=0;this.vignetteWeight=1.5;this.vignetteColor=new BABYLON.Color4(0,0,0,0);this.vignetteCameraFov=.5;this._vignetteBlendMode=ImageProcessingConfiguration.VIGNETTEMODE_MULTIPLY;this._vignetteEnabled=false;this._applyByPostProcess=false;this.onUpdateParameters=new BABYLON.Observable}Object.defineProperty(ImageProcessingConfiguration.prototype,"colorCurvesEnabled",{get:function(){return this._colorCurvesEnabled},set:function(value){if(this._colorCurvesEnabled===value){return}this._colorCurvesEnabled=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"colorGradingEnabled",{get:function(){return this._colorGradingEnabled},set:function(value){if(this._colorGradingEnabled===value){return}this._colorGradingEnabled=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"colorGradingWithGreenDepth",{get:function(){return this._colorGradingWithGreenDepth},set:function(value){if(this._colorGradingWithGreenDepth===value){return}this._colorGradingWithGreenDepth=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"colorGradingBGR",{get:function(){return this._colorGradingBGR},set:function(value){if(this._colorGradingBGR===value){return}this._colorGradingBGR=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"exposure",{get:function(){return this._exposure},set:function(value){if(this._exposure===value){return}this._exposure=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"toneMappingEnabled",{get:function(){return this._toneMappingEnabled},set:function(value){if(this._toneMappingEnabled===value){return}this._toneMappingEnabled=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"contrast",{get:function(){return this._contrast},set:function(value){if(this._contrast===value){return}this._contrast=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"vignetteBlendMode",{get:function(){return this._vignetteBlendMode},set:function(value){if(this._vignetteBlendMode===value){return}this._vignetteBlendMode=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"vignetteEnabled",{get:function(){return this._vignetteEnabled},set:function(value){if(this._vignetteEnabled===value){return}this._vignetteEnabled=value;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration.prototype,"applyByPostProcess",{get:function(){return this._applyByPostProcess},set:function(value){if(this._applyByPostProcess===value){return}this._applyByPostProcess=value;this._updateParameters()},enumerable:true,configurable:true});ImageProcessingConfiguration.prototype._updateParameters=function(){this.onUpdateParameters.notifyObservers(this)};ImageProcessingConfiguration.prototype.getClassName=function(){return"ImageProcessingConfiguration"};ImageProcessingConfiguration.PrepareUniforms=function(uniforms,defines){if(defines.EXPOSURE){uniforms.push("exposureLinear")}if(defines.CONTRAST){uniforms.push("contrast")}if(defines.COLORGRADING){uniforms.push("colorTransformSettings")}if(defines.VIGNETTE){uniforms.push("vInverseScreenSize");uniforms.push("vignetteSettings1");uniforms.push("vignetteSettings2")}if(defines.COLORCURVES){BABYLON.ColorCurves.PrepareUniforms(uniforms)}};ImageProcessingConfiguration.PrepareSamplers=function(samplersList,defines){if(defines.COLORGRADING){samplersList.push("txColorTransform")}};ImageProcessingConfiguration.prototype.prepareDefines=function(defines,forPostProcess){if(forPostProcess===void 0){forPostProcess=false}if(forPostProcess!==this.applyByPostProcess){defines.VIGNETTE=false;defines.TONEMAPPING=false;defines.CONTRAST=false;defines.EXPOSURE=false;defines.COLORCURVES=false;defines.COLORGRADING=false;defines.IMAGEPROCESSING=false;defines.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess;return}defines.VIGNETTE=this.vignetteEnabled;defines.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===ImageProcessingConfiguration._VIGNETTEMODE_MULTIPLY;defines.VIGNETTEBLENDMODEOPAQUE=!defines.VIGNETTEBLENDMODEMULTIPLY;defines.TONEMAPPING=this.toneMappingEnabled;defines.CONTRAST=this.contrast!==1;defines.EXPOSURE=this.exposure!==1;defines.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves;defines.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture;defines.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth;defines.SAMPLER3DBGRMAP=this.colorGradingBGR;defines.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess;defines.IMAGEPROCESSING=defines.VIGNETTE||defines.TONEMAPPING||defines.CONTRAST||defines.EXPOSURE||defines.COLORCURVES||defines.COLORGRADING};ImageProcessingConfiguration.prototype.isReady=function(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()};ImageProcessingConfiguration.prototype.bind=function(effect,aspectRatio){if(aspectRatio===void 0){aspectRatio=1}if(this._colorCurvesEnabled){BABYLON.ColorCurves.Bind(this.colorCurves,effect)}if(this._vignetteEnabled){var inverseWidth=1/effect.getEngine().getRenderWidth();var inverseHeight=1/effect.getEngine().getRenderHeight();effect.setFloat2("vInverseScreenSize",inverseWidth,inverseHeight);var vignetteScaleY=Math.tan(this.vignetteCameraFov*.5);var vignetteScaleX=vignetteScaleY*aspectRatio;var vignetteScaleGeometricMean=Math.sqrt(vignetteScaleX*vignetteScaleY);vignetteScaleX=BABYLON.Tools.Mix(vignetteScaleX,vignetteScaleGeometricMean,this.vignetteStretch);vignetteScaleY=BABYLON.Tools.Mix(vignetteScaleY,vignetteScaleGeometricMean,this.vignetteStretch);effect.setFloat4("vignetteSettings1",vignetteScaleX,vignetteScaleY,-vignetteScaleX*this.vignetteCentreX,-vignetteScaleY*this.vignetteCentreY);var vignettePower=-2*this.vignetteWeight;effect.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,vignettePower)}effect.setFloat("exposureLinear",this.exposure);effect.setFloat("contrast",this.contrast);if(this.colorGradingTexture){effect.setTexture("txColorTransform",this.colorGradingTexture);var textureSize=this.colorGradingTexture.getSize().height;effect.setFloat4("colorTransformSettings",(textureSize-1)/textureSize,.5/textureSize,textureSize,this.colorGradingTexture.level)}};ImageProcessingConfiguration.prototype.clone=function(){return BABYLON.SerializationHelper.Clone(function(){return new ImageProcessingConfiguration},this)};ImageProcessingConfiguration.prototype.serialize=function(){return BABYLON.SerializationHelper.Serialize(this)};ImageProcessingConfiguration.Parse=function(source){return BABYLON.SerializationHelper.Parse(function(){return new ImageProcessingConfiguration},source,null,null)};Object.defineProperty(ImageProcessingConfiguration,"VIGNETTEMODE_MULTIPLY",{get:function(){return this._VIGNETTEMODE_MULTIPLY},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingConfiguration,"VIGNETTEMODE_OPAQUE",{get:function(){return this._VIGNETTEMODE_OPAQUE},enumerable:true,configurable:true});ImageProcessingConfiguration._VIGNETTEMODE_MULTIPLY=0;ImageProcessingConfiguration._VIGNETTEMODE_OPAQUE=1;__decorate([BABYLON.serializeAsColorCurves()],ImageProcessingConfiguration.prototype,"colorCurves",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_colorCurvesEnabled",void 0);__decorate([BABYLON.serializeAsTexture()],ImageProcessingConfiguration.prototype,"colorGradingTexture",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_colorGradingEnabled",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_colorGradingWithGreenDepth",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_colorGradingBGR",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_exposure",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_toneMappingEnabled",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_contrast",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"vignetteStretch",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"vignetteCentreX",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"vignetteCentreY",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"vignetteWeight",void 0);__decorate([BABYLON.serializeAsColor4()],ImageProcessingConfiguration.prototype,"vignetteColor",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"vignetteCameraFov",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_vignetteBlendMode",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_vignetteEnabled",void 0);__decorate([BABYLON.serialize()],ImageProcessingConfiguration.prototype,"_applyByPostProcess",void 0);return ImageProcessingConfiguration}();BABYLON.ImageProcessingConfiguration=ImageProcessingConfiguration})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ColorGradingTexture=function(_super){__extends(ColorGradingTexture,_super);function ColorGradingTexture(url,scene){var _this=_super.call(this,scene)||this;if(!url){return _this}_this._textureMatrix=BABYLON.Matrix.Identity();_this.name=url;_this.url=url;_this.hasAlpha=false;_this.isCube=false;_this.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;_this.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;_this.anisotropicFilteringLevel=1;_this._texture=_this._getFromCache(url,true);if(!_this._texture){if(!scene.useDelayedTextureLoading){_this.loadTexture()}else{_this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED}}return _this}ColorGradingTexture.prototype.getTextureMatrix=function(){return this._textureMatrix};ColorGradingTexture.prototype.load3dlTexture=function(){var _this=this;var texture=this.getScene().getEngine().createRawTexture(null,1,1,BABYLON.Engine.TEXTUREFORMAT_RGBA,false,false,BABYLON.Texture.BILINEAR_SAMPLINGMODE);this._texture=texture;var callback=function(text){var data;var tempData;var line;var lines=text.split("\n");var size=0,pixelIndexW=0,pixelIndexH=0,pixelIndexSlice=0;var maxColor=0;for(var i=0;i<lines.length;i++){line=lines[i];if(!ColorGradingTexture._noneEmptyLineRegex.test(line))continue;if(line.indexOf("#")===0)continue;var words=line.split(" ");if(size===0){size=words.length;data=new Uint8Array(size*size*size*4);tempData=new Float32Array(size*size*size*4);continue}if(size!=0){var r=Math.max(parseInt(words[0]),0);var g=Math.max(parseInt(words[1]),0);var b=Math.max(parseInt(words[2]),0);maxColor=Math.max(r,maxColor);maxColor=Math.max(g,maxColor);maxColor=Math.max(b,maxColor);var pixelStorageIndex=(pixelIndexW+pixelIndexSlice*size+pixelIndexH*size*size)*4;tempData[pixelStorageIndex+0]=r;tempData[pixelStorageIndex+1]=g;tempData[pixelStorageIndex+2]=b;pixelIndexSlice++;if(pixelIndexSlice%size==0){pixelIndexH++;pixelIndexSlice=0;if(pixelIndexH%size==0){pixelIndexW++;pixelIndexH=0}}}}for(var i=0;i<tempData.length;i++){if(i>0&&(i+1)%4===0){data[i]=255}else{var value=tempData[i];data[i]=value/maxColor*255}}texture.updateSize(size*size,size);_this.getScene().getEngine().updateRawTexture(texture,data,BABYLON.Engine.TEXTUREFORMAT_RGBA,false)};BABYLON.Tools.LoadFile(this.url,callback);return this._texture};ColorGradingTexture.prototype.loadTexture=function(){if(this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4){this.load3dlTexture()}};ColorGradingTexture.prototype.clone=function(){var newTexture=new ColorGradingTexture(this.url,this.getScene());newTexture.level=this.level;return newTexture};ColorGradingTexture.prototype.delayLoad=function(){if(this.delayLoadState!==BABYLON.Engine.DELAYLOADSTATE_NOTLOADED){return}this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED;this._texture=this._getFromCache(this.url,true);if(!this._texture){this.loadTexture()}};ColorGradingTexture.Parse=function(parsedTexture,scene,rootUrl){var texture=null;if(parsedTexture.name&&!parsedTexture.isRenderTarget){texture=new BABYLON.ColorGradingTexture(parsedTexture.name,scene);texture.name=parsedTexture.name;texture.level=parsedTexture.level}return texture};ColorGradingTexture.prototype.serialize=function(){if(!this.name){return null}var serializationObject={};serializationObject.name=this.name;serializationObject.level=this.level;serializationObject.customType="BABYLON.ColorGradingTexture";return serializationObject};ColorGradingTexture._noneEmptyLineRegex=/\S+/;return ColorGradingTexture}(BABYLON.BaseTexture);BABYLON.ColorGradingTexture=ColorGradingTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ColorCurves=function(){function ColorCurves(){this._dirty=true;this._tempColor=new BABYLON.Color4(0,0,0,0);this._globalCurve=new BABYLON.Color4(0,0,0,0);this._highlightsCurve=new BABYLON.Color4(0,0,0,0);this._midtonesCurve=new BABYLON.Color4(0,0,0,0);this._shadowsCurve=new BABYLON.Color4(0,0,0,0);this._positiveCurve=new BABYLON.Color4(0,0,0,0);this._negativeCurve=new BABYLON.Color4(0,0,0,0);this._globalHue=30;this._globalDensity=0;this._globalSaturation=0;this._globalExposure=0;this._highlightsHue=30;this._highlightsDensity=0;this._highlightsSaturation=0;this._highlightsExposure=0;this._midtonesHue=30;this._midtonesDensity=0;this._midtonesSaturation=0;this._midtonesExposure=0;this._shadowsHue=30;this._shadowsDensity=0;this._shadowsSaturation=0;this._shadowsExposure=0}Object.defineProperty(ColorCurves.prototype,"globalHue",{get:function(){return this._globalHue},set:function(value){this._globalHue=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(value){this._globalDensity=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"globalSaturation",{get:function(){return this._globalSaturation},set:function(value){this._globalSaturation=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"highlightsHue",{get:function(){return this._highlightsHue},set:function(value){this._highlightsHue=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"highlightsDensity",{get:function(){return this._highlightsDensity},set:function(value){this._highlightsDensity=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"highlightsSaturation",{get:function(){return this._highlightsSaturation},set:function(value){this._highlightsSaturation=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"highlightsExposure",{get:function(){return this._highlightsExposure},set:function(value){this._highlightsExposure=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"midtonesHue",{get:function(){return this._midtonesHue},set:function(value){this._midtonesHue=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"midtonesDensity",{get:function(){return this._midtonesDensity},set:function(value){this._midtonesDensity=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"midtonesSaturation",{get:function(){return this._midtonesSaturation},set:function(value){this._midtonesSaturation=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"midtonesExposure",{get:function(){return this._midtonesExposure},set:function(value){this._midtonesExposure=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"shadowsHue",{get:function(){return this._shadowsHue},set:function(value){this._shadowsHue=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"shadowsDensity",{get:function(){return this._shadowsDensity},set:function(value){this._shadowsDensity=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"shadowsSaturation",{get:function(){return this._shadowsSaturation},set:function(value){this._shadowsSaturation=value;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(ColorCurves.prototype,"shadowsExposure",{get:function(){return this._shadowsExposure},set:function(value){this._shadowsExposure=value;this._dirty=true},enumerable:true,configurable:true});ColorCurves.prototype.getClassName=function(){return"ColorCurves"};ColorCurves.Bind=function(colorCurves,effect,positiveUniform,neutralUniform,negativeUniform){if(positiveUniform===void 0){positiveUniform="vCameraColorCurvePositive"}if(neutralUniform===void 0){neutralUniform="vCameraColorCurveNeutral"}if(negativeUniform===void 0){negativeUniform="vCameraColorCurveNegative"}if(colorCurves._dirty){colorCurves._dirty=false;colorCurves.getColorGradingDataToRef(colorCurves._globalHue,colorCurves._globalDensity,colorCurves._globalSaturation,colorCurves._globalExposure,colorCurves._globalCurve);colorCurves.getColorGradingDataToRef(colorCurves._highlightsHue,colorCurves._highlightsDensity,colorCurves._highlightsSaturation,colorCurves._highlightsExposure,colorCurves._tempColor);colorCurves._tempColor.multiplyToRef(colorCurves._globalCurve,colorCurves._highlightsCurve);colorCurves.getColorGradingDataToRef(colorCurves._midtonesHue,colorCurves._midtonesDensity,colorCurves._midtonesSaturation,colorCurves._midtonesExposure,colorCurves._tempColor);colorCurves._tempColor.multiplyToRef(colorCurves._globalCurve,colorCurves._midtonesCurve);colorCurves.getColorGradingDataToRef(colorCurves._shadowsHue,colorCurves._shadowsDensity,colorCurves._shadowsSaturation,colorCurves._shadowsExposure,colorCurves._tempColor);colorCurves._tempColor.multiplyToRef(colorCurves._globalCurve,colorCurves._shadowsCurve);colorCurves._highlightsCurve.subtractToRef(colorCurves._midtonesCurve,colorCurves._positiveCurve);colorCurves._midtonesCurve.subtractToRef(colorCurves._shadowsCurve,colorCurves._negativeCurve)}if(effect){effect.setFloat4(positiveUniform,colorCurves._positiveCurve.r,colorCurves._positiveCurve.g,colorCurves._positiveCurve.b,colorCurves._positiveCurve.a);effect.setFloat4(neutralUniform,colorCurves._midtonesCurve.r,colorCurves._midtonesCurve.g,colorCurves._midtonesCurve.b,colorCurves._midtonesCurve.a);effect.setFloat4(negativeUniform,colorCurves._negativeCurve.r,colorCurves._negativeCurve.g,colorCurves._negativeCurve.b,colorCurves._negativeCurve.a)}};ColorCurves.PrepareUniforms=function(uniformsList){uniformsList.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")};ColorCurves.prototype.getColorGradingDataToRef=function(hue,density,saturation,exposure,result){if(hue==null){return}hue=ColorCurves.clamp(hue,0,360);density=ColorCurves.clamp(density,-100,100);saturation=ColorCurves.clamp(saturation,-100,100);exposure=ColorCurves.clamp(exposure,-100,100);density=ColorCurves.applyColorGradingSliderNonlinear(density);density*=.5;exposure=ColorCurves.applyColorGradingSliderNonlinear(exposure);if(density<0){density*=-1;hue=(hue+180)%360}ColorCurves.fromHSBToRef(hue,density,50+.25*exposure,result);result.scaleToRef(2,result);result.a=1+.01*saturation};ColorCurves.applyColorGradingSliderNonlinear=function(value){value/=100;var x=Math.abs(value);x=Math.pow(x,2);if(value<0){x*=-1}x*=100;return x};ColorCurves.fromHSBToRef=function(hue,saturation,brightness,result){var h=ColorCurves.clamp(hue,0,360);var s=ColorCurves.clamp(saturation/100,0,1);var v=ColorCurves.clamp(brightness/100,0,1);if(s===0){result.r=v;result.g=v;result.b=v}else{h/=60;var i=Math.floor(h);var f=h-i;var p=v*(1-s);var q=v*(1-s*f);var t=v*(1-s*(1-f));switch(i){case 0:result.r=v;result.g=t;result.b=p;break;case 1:result.r=q;result.g=v;result.b=p;break;case 2:result.r=p;result.g=v;result.b=t;break;case 3:result.r=p;result.g=q;result.b=v;break;case 4:result.r=t;result.g=p;result.b=v;break;default:result.r=v;result.g=p;result.b=q;break}}result.a=1};ColorCurves.clamp=function(value,min,max){return Math.min(Math.max(value,min),max)};ColorCurves.prototype.clone=function(){return BABYLON.SerializationHelper.Clone(function(){return new ColorCurves},this)};ColorCurves.prototype.serialize=function(){return BABYLON.SerializationHelper.Serialize(this)};ColorCurves.Parse=function(source){return BABYLON.SerializationHelper.Parse(function(){return new ColorCurves},source,null,null)};__decorate([BABYLON.serialize()],ColorCurves.prototype,"_globalHue",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_globalDensity",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_globalSaturation",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_globalExposure",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_highlightsHue",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_highlightsDensity",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_highlightsSaturation",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_highlightsExposure",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_midtonesHue",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_midtonesDensity",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_midtonesSaturation",void 0);__decorate([BABYLON.serialize()],ColorCurves.prototype,"_midtonesExposure",void 0);return ColorCurves}();BABYLON.ColorCurves=ColorCurves})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var StandardMaterialDefines=function(_super){__extends(StandardMaterialDefines,_super);function StandardMaterialDefines(){var _this=_super.call(this)||this;_this.MAINUV1=false;_this.MAINUV2=false;_this.DIFFUSE=false;_this.DIFFUSEDIRECTUV=0;_this.AMBIENT=false;_this.AMBIENTDIRECTUV=0;_this.OPACITY=false;_this.OPACITYDIRECTUV=0;_this.OPACITYRGB=false;_this.REFLECTION=false;_this.EMISSIVE=false;_this.EMISSIVEDIRECTUV=0;_this.SPECULAR=false;_this.SPECULARDIRECTUV=0;_this.BUMP=false;_this.BUMPDIRECTUV=0;_this.PARALLAX=false;_this.PARALLAXOCCLUSION=false;_this.SPECULAROVERALPHA=false;_this.CLIPPLANE=false;_this.ALPHATEST=false;_this.DEPTHPREPASS=false;_this.ALPHAFROMDIFFUSE=false;_this.POINTSIZE=false;_this.FOG=false;_this.SPECULARTERM=false;_this.DIFFUSEFRESNEL=false;_this.OPACITYFRESNEL=false;_this.REFLECTIONFRESNEL=false;_this.REFRACTIONFRESNEL=false;_this.EMISSIVEFRESNEL=false;_this.FRESNEL=false;_this.NORMAL=false;_this.UV1=false;_this.UV2=false;_this.VERTEXCOLOR=false;_this.VERTEXALPHA=false;_this.NUM_BONE_INFLUENCERS=0;_this.BonesPerMesh=0;_this.INSTANCES=false;_this.GLOSSINESS=false;_this.ROUGHNESS=false;_this.EMISSIVEASILLUMINATION=false;_this.LINKEMISSIVEWITHDIFFUSE=false;_this.REFLECTIONFRESNELFROMSPECULAR=false;_this.LIGHTMAP=false;_this.LIGHTMAPDIRECTUV=0;_this.USELIGHTMAPASSHADOWMAP=false;_this.REFLECTIONMAP_3D=false;_this.REFLECTIONMAP_SPHERICAL=false;_this.REFLECTIONMAP_PLANAR=false;_this.REFLECTIONMAP_CUBIC=false;_this.REFLECTIONMAP_PROJECTION=false;_this.REFLECTIONMAP_SKYBOX=false;_this.REFLECTIONMAP_EXPLICIT=false;_this.REFLECTIONMAP_EQUIRECTANGULAR=false;_this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false;_this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false;_this.INVERTCUBICMAP=false;_this.LOGARITHMICDEPTH=false;_this.REFRACTION=false;_this.REFRACTIONMAP_3D=false;_this.REFLECTIONOVERALPHA=false;_this.TWOSIDEDLIGHTING=false;_this.SHADOWFLOAT=false;_this.MORPHTARGETS=false;_this.MORPHTARGETS_NORMAL=false;_this.MORPHTARGETS_TANGENT=false;_this.NUM_MORPH_INFLUENCERS=0;_this.IMAGEPROCESSING=false;_this.VIGNETTE=false;_this.VIGNETTEBLENDMODEMULTIPLY=false;_this.VIGNETTEBLENDMODEOPAQUE=false;_this.TONEMAPPING=false;_this.CONTRAST=false;_this.COLORCURVES=false;_this.COLORGRADING=false;_this.SAMPLER3DGREENDEPTH=false;_this.SAMPLER3DBGRMAP=false;_this.IMAGEPROCESSINGPOSTPROCESS=false;_this.EXPOSURE=false;_this.rebuild();return _this}StandardMaterialDefines.prototype.setReflectionMode=function(modeToEnable){var modes=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(var _i=0,modes_1=modes;_i<modes_1.length;_i++){var mode=modes_1[_i];this[mode]=mode===modeToEnable}};return StandardMaterialDefines}(BABYLON.MaterialDefines);BABYLON.StandardMaterialDefines=StandardMaterialDefines;var StandardMaterial=function(_super){__extends(StandardMaterial,_super);function StandardMaterial(name,scene){var _this=_super.call(this,name,scene)||this;_this.ambientColor=new BABYLON.Color3(0,0,0);_this.diffuseColor=new BABYLON.Color3(1,1,1);_this.specularColor=new BABYLON.Color3(1,1,1);_this.emissiveColor=new BABYLON.Color3(0,0,0);_this.specularPower=64;_this._useAlphaFromDiffuseTexture=false;_this._useEmissiveAsIllumination=false;_this._linkEmissiveWithDiffuse=false;_this._useSpecularOverAlpha=false;_this._useReflectionOverAlpha=false;_this._disableLighting=false;_this._useParallax=false;_this._useParallaxOcclusion=false;_this.parallaxScaleBias=.05;_this._roughness=0;_this.indexOfRefraction=.98;_this.invertRefractionY=true;_this._useLightmapAsShadowmap=false;_this._useReflectionFresnelFromSpecular=false;_this._useGlossinessFromSpecularMapAlpha=false;_this._maxSimultaneousLights=4;_this._invertNormalMapX=false;_this._invertNormalMapY=false;_this._twoSidedLighting=false;_this._renderTargets=new BABYLON.SmartArray(16);_this._worldViewProjectionMatrix=BABYLON.Matrix.Zero();_this._globalAmbientColor=new BABYLON.Color3(0,0,0);_this._attachImageProcessingConfiguration(null);_this.getRenderTargetTextures=function(){_this._renderTargets.reset();if(StandardMaterial.ReflectionTextureEnabled&&_this._reflectionTexture&&_this._reflectionTexture.isRenderTarget){_this._renderTargets.push(_this._reflectionTexture)}if(StandardMaterial.RefractionTextureEnabled&&_this._refractionTexture&&_this._refractionTexture.isRenderTarget){_this._renderTargets.push(_this._refractionTexture)}return _this._renderTargets};return _this}Object.defineProperty(StandardMaterial.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(value){this._attachImageProcessingConfiguration(value);this._markAllSubMeshesAsTexturesDirty()},enumerable:true,configurable:true});StandardMaterial.prototype._attachImageProcessingConfiguration=function(configuration){var _this=this;if(configuration===this._imageProcessingConfiguration){return}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}if(!configuration){this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration}else{this._imageProcessingConfiguration=configuration}this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(conf){_this._markAllSubMeshesAsImageProcessingDirty()})};Object.defineProperty(StandardMaterial.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(value){this.imageProcessingConfiguration.colorCurvesEnabled=value},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(value){this.imageProcessingConfiguration.colorGradingEnabled=value},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(value){this._imageProcessingConfiguration.toneMappingEnabled=value},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(value){this._imageProcessingConfiguration.exposure=value},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(value){this._imageProcessingConfiguration.contrast=value},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(value){this._imageProcessingConfiguration.colorGradingTexture=value},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(value){this._imageProcessingConfiguration.colorCurves=value},enumerable:true,configurable:true});StandardMaterial.prototype.getClassName=function(){return"StandardMaterial"};Object.defineProperty(StandardMaterial.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(value){this._useLogarithmicDepth=value&&this.getScene().getEngine().getCaps().fragmentDepthSupported;this._markAllSubMeshesAsMiscDirty()},enumerable:true,configurable:true});StandardMaterial.prototype.needAlphaBlending=function(){return this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled};StandardMaterial.prototype.needAlphaTesting=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha};StandardMaterial.prototype._shouldUseAlphaFromDiffuseTexture=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture};StandardMaterial.prototype.getAlphaTestTexture=function(){return this._diffuseTexture};StandardMaterial.prototype.isReadyForSubMesh=function(mesh,subMesh,useInstances){if(this.isFrozen){if(this._wasPreviouslyReady&&subMesh.effect){return true}}if(!subMesh._materialDefines){subMesh._materialDefines=new StandardMaterialDefines}var scene=this.getScene();var defines=subMesh._materialDefines;if(!this.checkReadyOnEveryCall&&subMesh.effect){if(defines._renderId===scene.getRenderId()){return true}}var engine=scene.getEngine();defines._needNormals=BABYLON.MaterialHelper.PrepareDefinesForLights(scene,mesh,defines,true,this._maxSimultaneousLights,this._disableLighting);if(defines._areTexturesDirty){defines._needUVs=false;defines.MAINUV1=false;defines.MAINUV2=false;if(scene.texturesEnabled){if(this._diffuseTexture&&StandardMaterial.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking()){return false}else{BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._diffuseTexture,defines,"DIFFUSE")}}else{defines.DIFFUSE=false}if(this._ambientTexture&&StandardMaterial.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking()){return false}else{BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._ambientTexture,defines,"AMBIENT")}}else{defines.AMBIENT=false}if(this._opacityTexture&&StandardMaterial.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking()){return false}else{BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._opacityTexture,defines,"OPACITY");defines.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}}else{defines.OPACITY=false}if(this._reflectionTexture&&StandardMaterial.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking()){return false}else{defines._needNormals=true;defines.REFLECTION=true;defines.ROUGHNESS=this._roughness>0;defines.REFLECTIONOVERALPHA=this._useReflectionOverAlpha;defines.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===BABYLON.Texture.INVCUBIC_MODE;defines.REFLECTIONMAP_3D=this._reflectionTexture.isCube;switch(this._reflectionTexture.coordinatesMode){case BABYLON.Texture.CUBIC_MODE:case BABYLON.Texture.INVCUBIC_MODE:defines.setReflectionMode("REFLECTIONMAP_CUBIC");break;case BABYLON.Texture.EXPLICIT_MODE:defines.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case BABYLON.Texture.PLANAR_MODE:defines.setReflectionMode("REFLECTIONMAP_PLANAR");break;case BABYLON.Texture.PROJECTION_MODE:defines.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case BABYLON.Texture.SKYBOX_MODE:defines.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case BABYLON.Texture.SPHERICAL_MODE:defines.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case BABYLON.Texture.EQUIRECTANGULAR_MODE:defines.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case BABYLON.Texture.FIXED_EQUIRECTANGULAR_MODE:defines.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case BABYLON.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:defines.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break}}}else{defines.REFLECTION=false}if(this._emissiveTexture&&StandardMaterial.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking()){return false}else{BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._emissiveTexture,defines,"EMISSIVE")}}else{defines.EMISSIVE=false}if(this._lightmapTexture&&StandardMaterial.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking()){return false}else{BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._lightmapTexture,defines,"LIGHTMAP");defines.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap}}else{defines.LIGHTMAP=false}if(this._specularTexture&&StandardMaterial.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking()){return false}else{BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._specularTexture,defines,"SPECULAR");defines.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}}else{defines.SPECULAR=false}if(scene.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&StandardMaterial.BumpTextureEnabled){if(!this._bumpTexture.isReady()){return false}else{BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._bumpTexture,defines,"BUMP");defines.PARALLAX=this._useParallax;defines.PARALLAXOCCLUSION=this._useParallaxOcclusion}}else{defines.BUMP=false}if(this._refractionTexture&&StandardMaterial.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking()){return false}else{defines._needUVs=true;defines.REFRACTION=true;defines.REFRACTIONMAP_3D=this._refractionTexture.isCube}}else{defines.REFRACTION=false}defines.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else{defines.DIFFUSE=false;defines.AMBIENT=false;defines.OPACITY=false;defines.REFLECTION=false;defines.EMISSIVE=false;defines.LIGHTMAP=false;defines.BUMP=false;defines.REFRACTION=false}defines.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture();defines.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination;defines.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse;defines.SPECULAROVERALPHA=this._useSpecularOverAlpha}if(defines._areImageProcessingDirty){if(!this._imageProcessingConfiguration.isReady()){return false}this._imageProcessingConfiguration.prepareDefines(defines)}if(defines._areFresnelDirty){if(StandardMaterial.FresnelEnabled){if(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters){defines.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled;defines.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled;defines.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled;defines.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular;defines.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled;defines.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled;defines._needNormals=true;defines.FRESNEL=true}}else{defines.FRESNEL=false}}BABYLON.MaterialHelper.PrepareDefinesForMisc(mesh,scene,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,defines);BABYLON.MaterialHelper.PrepareDefinesForAttributes(mesh,defines,true,true,true);BABYLON.MaterialHelper.PrepareDefinesForFrameBoundValues(scene,engine,defines,useInstances);if(defines.isDirty){defines.markAsProcessed();scene.resetCachedMaterial();var fallbacks=new BABYLON.EffectFallbacks;if(defines.REFLECTION){fallbacks.addFallback(0,"REFLECTION")}if(defines.SPECULAR){fallbacks.addFallback(0,"SPECULAR")}if(defines.BUMP){fallbacks.addFallback(0,"BUMP")}if(defines.PARALLAX){fallbacks.addFallback(1,"PARALLAX")}if(defines.PARALLAXOCCLUSION){fallbacks.addFallback(0,"PARALLAXOCCLUSION")}if(defines.SPECULAROVERALPHA){fallbacks.addFallback(0,"SPECULAROVERALPHA")}if(defines.FOG){fallbacks.addFallback(1,"FOG")}if(defines.POINTSIZE){fallbacks.addFallback(0,"POINTSIZE")}if(defines.LOGARITHMICDEPTH){fallbacks.addFallback(0,"LOGARITHMICDEPTH")}BABYLON.MaterialHelper.HandleFallbacksForShadows(defines,fallbacks,this._maxSimultaneousLights);if(defines.SPECULARTERM){fallbacks.addFallback(0,"SPECULARTERM")}if(defines.DIFFUSEFRESNEL){fallbacks.addFallback(1,"DIFFUSEFRESNEL")}if(defines.OPACITYFRESNEL){fallbacks.addFallback(2,"OPACITYFRESNEL")}if(defines.REFLECTIONFRESNEL){fallbacks.addFallback(3,"REFLECTIONFRESNEL")}if(defines.EMISSIVEFRESNEL){fallbacks.addFallback(4,"EMISSIVEFRESNEL")}if(defines.FRESNEL){fallbacks.addFallback(4,"FRESNEL")}var attribs=[BABYLON.VertexBuffer.PositionKind];if(defines.NORMAL){attribs.push(BABYLON.VertexBuffer.NormalKind)}if(defines.UV1){attribs.push(BABYLON.VertexBuffer.UVKind)}if(defines.UV2){attribs.push(BABYLON.VertexBuffer.UV2Kind)}if(defines.VERTEXCOLOR){attribs.push(BABYLON.VertexBuffer.ColorKind)}BABYLON.MaterialHelper.PrepareAttributesForBones(attribs,mesh,defines,fallbacks);BABYLON.MaterialHelper.PrepareAttributesForInstances(attribs,defines);BABYLON.MaterialHelper.PrepareAttributesForMorphTargets(attribs,mesh,defines);var shaderName="default";var uniforms=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","logarithmicDepthConstant","vTangentSpaceParams"];var samplers=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler"];var uniformBuffers=["Material","Scene"];BABYLON.ImageProcessingConfiguration.PrepareUniforms(uniforms,defines);BABYLON.ImageProcessingConfiguration.PrepareSamplers(samplers,defines);BABYLON.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:uniforms,uniformBuffersNames:uniformBuffers,samplers:samplers,defines:defines,maxSimultaneousLights:this._maxSimultaneousLights});if(this.customShaderNameResolve){shaderName=this.customShaderNameResolve(shaderName,uniforms,uniformBuffers,samplers,defines)}var join=defines.toString();subMesh.setEffect(scene.getEngine().createEffect(shaderName,{attributes:attribs,uniformsNames:uniforms,uniformBuffersNames:uniformBuffers,samplers:samplers,defines:join,fallbacks:fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:defines.NUM_MORPH_INFLUENCERS}},engine),defines);this.buildUniformLayout()}if(!subMesh.effect.isReady()){return false}defines._renderId=scene.getRenderId();this._wasPreviouslyReady=true;return true};StandardMaterial.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("diffuseLeftColor",4);this._uniformBuffer.addUniform("diffuseRightColor",4);this._uniformBuffer.addUniform("opacityParts",4);this._uniformBuffer.addUniform("reflectionLeftColor",4);this._uniformBuffer.addUniform("reflectionRightColor",4);this._uniformBuffer.addUniform("refractionLeftColor",4);this._uniformBuffer.addUniform("refractionRightColor",4);this._uniformBuffer.addUniform("emissiveLeftColor",4);this._uniformBuffer.addUniform("emissiveRightColor",4);this._uniformBuffer.addUniform("vDiffuseInfos",2);this._uniformBuffer.addUniform("vAmbientInfos",2);this._uniformBuffer.addUniform("vOpacityInfos",2);this._uniformBuffer.addUniform("vReflectionInfos",2);this._uniformBuffer.addUniform("vEmissiveInfos",2);this._uniformBuffer.addUniform("vLightmapInfos",2);this._uniformBuffer.addUniform("vSpecularInfos",2);this._uniformBuffer.addUniform("vBumpInfos",3);this._uniformBuffer.addUniform("diffuseMatrix",16);this._uniformBuffer.addUniform("ambientMatrix",16);this._uniformBuffer.addUniform("opacityMatrix",16);this._uniformBuffer.addUniform("reflectionMatrix",16);this._uniformBuffer.addUniform("emissiveMatrix",16);this._uniformBuffer.addUniform("lightmapMatrix",16);this._uniformBuffer.addUniform("specularMatrix",16);this._uniformBuffer.addUniform("bumpMatrix",16);this._uniformBuffer.addUniform("vTangentSpaceParams",2);this._uniformBuffer.addUniform("refractionMatrix",16);this._uniformBuffer.addUniform("vRefractionInfos",4);this._uniformBuffer.addUniform("vSpecularColor",4);this._uniformBuffer.addUniform("vEmissiveColor",3);this._uniformBuffer.addUniform("vDiffuseColor",4);this._uniformBuffer.addUniform("pointSize",1);this._uniformBuffer.create()};StandardMaterial.prototype.unbind=function(){if(this._activeEffect){if(this._reflectionTexture&&this._reflectionTexture.isRenderTarget){this._activeEffect.setTexture("reflection2DSampler",null)}if(this._refractionTexture&&this._refractionTexture.isRenderTarget){this._activeEffect.setTexture("refraction2DSampler",null)}}_super.prototype.unbind.call(this)};StandardMaterial.prototype.bindForSubMesh=function(world,mesh,subMesh){var scene=this.getScene();var defines=subMesh._materialDefines;if(!defines){return}var effect=subMesh.effect;this._activeEffect=effect;this.bindOnlyWorldMatrix(world);var mustRebind=this._mustRebind(scene,effect,mesh.visibility);BABYLON.MaterialHelper.BindBonesParameters(mesh,effect);if(mustRebind){this._uniformBuffer.bindToEffect(effect,"Material");this.bindViewProjection(effect);if(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync){if(StandardMaterial.FresnelEnabled&&defines.FRESNEL){if(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power);this._uniformBuffer.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)}if(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("opacityParts",new BABYLON.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power)}if(this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power);this._uniformBuffer.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)}if(this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power);this._uniformBuffer.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)}if(this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power);this._uniformBuffer.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias)}}if(scene.texturesEnabled){if(this._diffuseTexture&&StandardMaterial.DiffuseTextureEnabled){this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")}if(this._ambientTexture&&StandardMaterial.AmbientTextureEnabled){this._uniformBuffer.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._ambientTexture,this._uniformBuffer,"ambient")}if(this._opacityTexture&&StandardMaterial.OpacityTextureEnabled){this._uniformBuffer.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._opacityTexture,this._uniformBuffer,"opacity")}if(this._reflectionTexture&&StandardMaterial.ReflectionTextureEnabled){this._uniformBuffer.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness);this._uniformBuffer.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix())}if(this._emissiveTexture&&StandardMaterial.EmissiveTextureEnabled){this._uniformBuffer.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._emissiveTexture,this._uniformBuffer,"emissive")}if(this._lightmapTexture&&StandardMaterial.LightmapTextureEnabled){this._uniformBuffer.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._lightmapTexture,this._uniformBuffer,"lightmap")}if(this._specularTexture&&StandardMaterial.SpecularTextureEnabled){this._uniformBuffer.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._specularTexture,this._uniformBuffer,"specular")}if(this._bumpTexture&&scene.getEngine().getCaps().standardDerivatives&&StandardMaterial.BumpTextureEnabled){this._uniformBuffer.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias);BABYLON.MaterialHelper.BindTextureMatrix(this._bumpTexture,this._uniformBuffer,"bump");if(scene._mirroredCameraPosition){this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1)}else{this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)}}if(this._refractionTexture&&StandardMaterial.RefractionTextureEnabled){var depth=1;if(!this._refractionTexture.isCube){this._uniformBuffer.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix());if(this._refractionTexture.depth){depth=this._refractionTexture.depth}}this._uniformBuffer.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,depth,this.invertRefractionY?-1:1)}}if(this.pointsCloud){this._uniformBuffer.updateFloat("pointSize",this.pointSize)}if(defines.SPECULARTERM){this._uniformBuffer.updateColor4("vSpecularColor",this.specularColor,this.specularPower)}this._uniformBuffer.updateColor3("vEmissiveColor",this.emissiveColor);this._uniformBuffer.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha*mesh.visibility)}if(scene.texturesEnabled){if(this._diffuseTexture&&StandardMaterial.DiffuseTextureEnabled){effect.setTexture("diffuseSampler",this._diffuseTexture)}if(this._ambientTexture&&StandardMaterial.AmbientTextureEnabled){effect.setTexture("ambientSampler",this._ambientTexture)}if(this._opacityTexture&&StandardMaterial.OpacityTextureEnabled){effect.setTexture("opacitySampler",this._opacityTexture)}if(this._reflectionTexture&&StandardMaterial.ReflectionTextureEnabled){if(this._reflectionTexture.isCube){effect.setTexture("reflectionCubeSampler",this._reflectionTexture)}else{effect.setTexture("reflection2DSampler",this._reflectionTexture)}}if(this._emissiveTexture&&StandardMaterial.EmissiveTextureEnabled){effect.setTexture("emissiveSampler",this._emissiveTexture)}if(this._lightmapTexture&&StandardMaterial.LightmapTextureEnabled){effect.setTexture("lightmapSampler",this._lightmapTexture)}if(this._specularTexture&&StandardMaterial.SpecularTextureEnabled){effect.setTexture("specularSampler",this._specularTexture)}if(this._bumpTexture&&scene.getEngine().getCaps().standardDerivatives&&StandardMaterial.BumpTextureEnabled){effect.setTexture("bumpSampler",this._bumpTexture)}if(this._refractionTexture&&StandardMaterial.RefractionTextureEnabled){var depth=1;if(this._refractionTexture.isCube){effect.setTexture("refractionCubeSampler",this._refractionTexture)}else{effect.setTexture("refraction2DSampler",this._refractionTexture)}}}BABYLON.MaterialHelper.BindClipPlane(effect,scene);scene.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor);effect.setVector3("vEyePosition",scene._mirroredCameraPosition?scene._mirroredCameraPosition:scene.activeCamera.globalPosition);effect.setColor3("vAmbientColor",this._globalAmbientColor)}if(mustRebind||!this.isFrozen){if(scene.lightsEnabled&&!this._disableLighting){BABYLON.MaterialHelper.BindLights(scene,mesh,effect,defines,this._maxSimultaneousLights)}if(scene.fogEnabled&&mesh.applyFog&&scene.fogMode!==BABYLON.Scene.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture){this.bindView(effect)}BABYLON.MaterialHelper.BindFogParameters(scene,mesh,effect);if(defines.NUM_MORPH_INFLUENCERS){BABYLON.MaterialHelper.BindMorphTargetParameters(mesh,effect)}BABYLON.MaterialHelper.BindLogDepth(defines,effect,scene);this._imageProcessingConfiguration.bind(this._activeEffect)}this._uniformBuffer.update();this._afterBind(mesh,this._activeEffect)};StandardMaterial.prototype.getAnimatables=function(){var results=[];if(this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0){results.push(this._diffuseTexture)}if(this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0){results.push(this._ambientTexture)}if(this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0){results.push(this._opacityTexture)}if(this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0){results.push(this._reflectionTexture)}if(this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0){results.push(this._emissiveTexture)}if(this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0){results.push(this._specularTexture)}if(this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0){results.push(this._bumpTexture)}if(this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0){results.push(this._lightmapTexture)}if(this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0){results.push(this._refractionTexture)}return results};StandardMaterial.prototype.getActiveTextures=function(){var activeTextures=_super.prototype.getActiveTextures.call(this);if(this._diffuseTexture){activeTextures.push(this._diffuseTexture)}if(this._ambientTexture){activeTextures.push(this._ambientTexture)}if(this._opacityTexture){activeTextures.push(this._opacityTexture)}if(this._reflectionTexture){activeTextures.push(this._reflectionTexture)}if(this._emissiveTexture){activeTextures.push(this._emissiveTexture)}if(this._specularTexture){activeTextures.push(this._specularTexture)}if(this._bumpTexture){activeTextures.push(this._bumpTexture)}if(this._lightmapTexture){activeTextures.push(this._lightmapTexture)}if(this._refractionTexture){activeTextures.push(this._refractionTexture)}return activeTextures};StandardMaterial.prototype.hasTexture=function(texture){if(_super.prototype.hasTexture.call(this,texture)){return true}if(this._diffuseTexture===texture){return true}if(this._ambientTexture===texture){return true}if(this._opacityTexture===texture){return true}if(this._reflectionTexture===texture){return true}if(this._emissiveTexture===texture){return true}if(this._specularTexture===texture){return true}if(this._bumpTexture===texture){return true}if(this._lightmapTexture===texture){return true}if(this._refractionTexture===texture){return true}return false};StandardMaterial.prototype.dispose=function(forceDisposeEffect,forceDisposeTextures){if(forceDisposeTextures){if(this._diffuseTexture){this._diffuseTexture.dispose()}if(this._ambientTexture){this._ambientTexture.dispose()}if(this._opacityTexture){this._opacityTexture.dispose()}if(this._reflectionTexture){this._reflectionTexture.dispose()}if(this._emissiveTexture){this._emissiveTexture.dispose()}if(this._specularTexture){this._specularTexture.dispose()}if(this._bumpTexture){this._bumpTexture.dispose()}if(this._lightmapTexture){this._lightmapTexture.dispose()}if(this._refractionTexture){this._refractionTexture.dispose()}}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}_super.prototype.dispose.call(this,forceDisposeEffect,forceDisposeTextures)};StandardMaterial.prototype.clone=function(name){var _this=this;var result=BABYLON.SerializationHelper.Clone(function(){return new StandardMaterial(name,_this.getScene())},this);result.name=name;result.id=name;return result};StandardMaterial.prototype.serialize=function(){return BABYLON.SerializationHelper.Serialize(this)};StandardMaterial.Parse=function(source,scene,rootUrl){return BABYLON.SerializationHelper.Parse(function(){return new StandardMaterial(source.name,scene)},source,scene,rootUrl)};Object.defineProperty(StandardMaterial,"DiffuseTextureEnabled",{get:function(){return StandardMaterial._DiffuseTextureEnabled},set:function(value){if(StandardMaterial._DiffuseTextureEnabled===value){return}StandardMaterial._DiffuseTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"AmbientTextureEnabled",{get:function(){return StandardMaterial._AmbientTextureEnabled},set:function(value){if(StandardMaterial._AmbientTextureEnabled===value){return}StandardMaterial._AmbientTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"OpacityTextureEnabled",{get:function(){return StandardMaterial._OpacityTextureEnabled},set:function(value){if(StandardMaterial._OpacityTextureEnabled===value){return}StandardMaterial._OpacityTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"ReflectionTextureEnabled",{get:function(){return StandardMaterial._ReflectionTextureEnabled},set:function(value){if(StandardMaterial._ReflectionTextureEnabled===value){return}StandardMaterial._ReflectionTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"EmissiveTextureEnabled",{get:function(){return StandardMaterial._EmissiveTextureEnabled},set:function(value){if(StandardMaterial._EmissiveTextureEnabled===value){return}StandardMaterial._EmissiveTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"SpecularTextureEnabled",{get:function(){return StandardMaterial._SpecularTextureEnabled},set:function(value){if(StandardMaterial._SpecularTextureEnabled===value){return}StandardMaterial._SpecularTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"BumpTextureEnabled",{get:function(){return StandardMaterial._BumpTextureEnabled},set:function(value){if(StandardMaterial._BumpTextureEnabled===value){return}StandardMaterial._BumpTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"LightmapTextureEnabled",{get:function(){return StandardMaterial._LightmapTextureEnabled},set:function(value){if(StandardMaterial._LightmapTextureEnabled===value){return}StandardMaterial._LightmapTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"RefractionTextureEnabled",{get:function(){return StandardMaterial._RefractionTextureEnabled},set:function(value){if(StandardMaterial._RefractionTextureEnabled===value){return}StandardMaterial._RefractionTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"ColorGradingTextureEnabled",{get:function(){return StandardMaterial._ColorGradingTextureEnabled},set:function(value){if(StandardMaterial._ColorGradingTextureEnabled===value){return}StandardMaterial._ColorGradingTextureEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(StandardMaterial,"FresnelEnabled",{get:function(){return StandardMaterial._FresnelEnabled},set:function(value){if(StandardMaterial._FresnelEnabled===value){return}StandardMaterial._FresnelEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.FresnelDirtyFlag)},enumerable:true,configurable:true});StandardMaterial._DiffuseTextureEnabled=true;StandardMaterial._AmbientTextureEnabled=true;StandardMaterial._OpacityTextureEnabled=true;StandardMaterial._ReflectionTextureEnabled=true;StandardMaterial._EmissiveTextureEnabled=true;StandardMaterial._SpecularTextureEnabled=true;StandardMaterial._BumpTextureEnabled=true;StandardMaterial._LightmapTextureEnabled=true;StandardMaterial._RefractionTextureEnabled=true;StandardMaterial._ColorGradingTextureEnabled=true;StandardMaterial._FresnelEnabled=true;__decorate([BABYLON.serializeAsTexture("diffuseTexture")],StandardMaterial.prototype,"_diffuseTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"diffuseTexture",void 0);__decorate([BABYLON.serializeAsTexture("ambientTexture")],StandardMaterial.prototype,"_ambientTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"ambientTexture",void 0);__decorate([BABYLON.serializeAsTexture("opacityTexture")],StandardMaterial.prototype,"_opacityTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"opacityTexture",void 0);__decorate([BABYLON.serializeAsTexture("reflectionTexture")],StandardMaterial.prototype,"_reflectionTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"reflectionTexture",void 0);__decorate([BABYLON.serializeAsTexture("emissiveTexture")],StandardMaterial.prototype,"_emissiveTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"emissiveTexture",void 0);__decorate([BABYLON.serializeAsTexture("specularTexture")],StandardMaterial.prototype,"_specularTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"specularTexture",void 0);__decorate([BABYLON.serializeAsTexture("bumpTexture")],StandardMaterial.prototype,"_bumpTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"bumpTexture",void 0);__decorate([BABYLON.serializeAsTexture("lightmapTexture")],StandardMaterial.prototype,"_lightmapTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"lightmapTexture",void 0);__decorate([BABYLON.serializeAsTexture("refractionTexture")],StandardMaterial.prototype,"_refractionTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"refractionTexture",void 0);__decorate([BABYLON.serializeAsColor3("ambient")],StandardMaterial.prototype,"ambientColor",void 0);__decorate([BABYLON.serializeAsColor3("diffuse")],StandardMaterial.prototype,"diffuseColor",void 0);__decorate([BABYLON.serializeAsColor3("specular")],StandardMaterial.prototype,"specularColor",void 0);__decorate([BABYLON.serializeAsColor3("emissive")],StandardMaterial.prototype,"emissiveColor",void 0);__decorate([BABYLON.serialize()],StandardMaterial.prototype,"specularPower",void 0);__decorate([BABYLON.serialize("useAlphaFromDiffuseTexture")],StandardMaterial.prototype,"_useAlphaFromDiffuseTexture",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useAlphaFromDiffuseTexture",void 0);__decorate([BABYLON.serialize("useEmissiveAsIllumination")],StandardMaterial.prototype,"_useEmissiveAsIllumination",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useEmissiveAsIllumination",void 0);__decorate([BABYLON.serialize("linkEmissiveWithDiffuse")],StandardMaterial.prototype,"_linkEmissiveWithDiffuse",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"linkEmissiveWithDiffuse",void 0);__decorate([BABYLON.serialize("useSpecularOverAlpha")],StandardMaterial.prototype,"_useSpecularOverAlpha",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useSpecularOverAlpha",void 0);__decorate([BABYLON.serialize("useReflectionOverAlpha")],StandardMaterial.prototype,"_useReflectionOverAlpha",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useReflectionOverAlpha",void 0);__decorate([BABYLON.serialize("disableLighting")],StandardMaterial.prototype,"_disableLighting",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsLightsDirty")],StandardMaterial.prototype,"disableLighting",void 0);__decorate([BABYLON.serialize("useParallax")],StandardMaterial.prototype,"_useParallax",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useParallax",void 0);__decorate([BABYLON.serialize("useParallaxOcclusion")],StandardMaterial.prototype,"_useParallaxOcclusion",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useParallaxOcclusion",void 0);__decorate([BABYLON.serialize()],StandardMaterial.prototype,"parallaxScaleBias",void 0);__decorate([BABYLON.serialize("roughness")],StandardMaterial.prototype,"_roughness",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"roughness",void 0);__decorate([BABYLON.serialize()],StandardMaterial.prototype,"indexOfRefraction",void 0);__decorate([BABYLON.serialize()],StandardMaterial.prototype,"invertRefractionY",void 0);__decorate([BABYLON.serialize("useLightmapAsShadowmap")],StandardMaterial.prototype,"_useLightmapAsShadowmap",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useLightmapAsShadowmap",void 0);__decorate([BABYLON.serializeAsFresnelParameters("diffuseFresnelParameters")],StandardMaterial.prototype,"_diffuseFresnelParameters",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"diffuseFresnelParameters",void 0);__decorate([BABYLON.serializeAsFresnelParameters("opacityFresnelParameters")],StandardMaterial.prototype,"_opacityFresnelParameters",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"opacityFresnelParameters",void 0);__decorate([BABYLON.serializeAsFresnelParameters("reflectionFresnelParameters")],StandardMaterial.prototype,"_reflectionFresnelParameters",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"reflectionFresnelParameters",void 0);__decorate([BABYLON.serializeAsFresnelParameters("refractionFresnelParameters")],StandardMaterial.prototype,"_refractionFresnelParameters",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"refractionFresnelParameters",void 0);__decorate([BABYLON.serializeAsFresnelParameters("emissiveFresnelParameters")],StandardMaterial.prototype,"_emissiveFresnelParameters",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"emissiveFresnelParameters",void 0);__decorate([BABYLON.serialize("useReflectionFresnelFromSpecular")],StandardMaterial.prototype,"_useReflectionFresnelFromSpecular",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"useReflectionFresnelFromSpecular",void 0);__decorate([BABYLON.serialize("useGlossinessFromSpecularMapAlpha")],StandardMaterial.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useGlossinessFromSpecularMapAlpha",void 0);__decorate([BABYLON.serialize("maxSimultaneousLights")],StandardMaterial.prototype,"_maxSimultaneousLights",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsLightsDirty")],StandardMaterial.prototype,"maxSimultaneousLights",void 0);__decorate([BABYLON.serialize("invertNormalMapX")],StandardMaterial.prototype,"_invertNormalMapX",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"invertNormalMapX",void 0);__decorate([BABYLON.serialize("invertNormalMapY")],StandardMaterial.prototype,"_invertNormalMapY",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"invertNormalMapY",void 0);__decorate([BABYLON.serialize("twoSidedLighting")],StandardMaterial.prototype,"_twoSidedLighting",void 0);__decorate([BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"twoSidedLighting",void 0);__decorate([BABYLON.serialize()],StandardMaterial.prototype,"useLogarithmicDepth",null);return StandardMaterial}(BABYLON.PushMaterial);BABYLON.StandardMaterial=StandardMaterial})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PBRMaterialDefines=function(_super){__extends(PBRMaterialDefines,_super);function PBRMaterialDefines(){var _this=_super.call(this)||this;_this.PBR=true;_this.MAINUV1=false;_this.MAINUV2=false;_this.UV1=false;_this.UV2=false;_this.ALBEDO=false;_this.ALBEDODIRECTUV=0;_this.VERTEXCOLOR=false;_this.AMBIENT=false;_this.AMBIENTDIRECTUV=0;_this.AMBIENTINGRAYSCALE=false;_this.OPACITY=false;_this.VERTEXALPHA=false;_this.OPACITYDIRECTUV=0;_this.OPACITYRGB=false;_this.ALPHATEST=false;_this.DEPTHPREPASS=false;_this.ALPHABLEND=false;_this.ALPHAFROMALBEDO=false;_this.ALPHATESTVALUE=.5;_this.SPECULAROVERALPHA=false;_this.RADIANCEOVERALPHA=false;_this.ALPHAFRESNEL=false;_this.PREMULTIPLYALPHA=false;_this.EMISSIVE=false;_this.EMISSIVEDIRECTUV=0;_this.REFLECTIVITY=false;_this.REFLECTIVITYDIRECTUV=0;_this.SPECULARTERM=false;_this.MICROSURFACEFROMREFLECTIVITYMAP=false;_this.MICROSURFACEAUTOMATIC=false;_this.LODBASEDMICROSFURACE=false;_this.MICROSURFACEMAP=false;_this.MICROSURFACEMAPDIRECTUV=0;_this.METALLICWORKFLOW=false;_this.ROUGHNESSSTOREINMETALMAPALPHA=false;_this.ROUGHNESSSTOREINMETALMAPGREEN=false;_this.METALLNESSSTOREINMETALMAPBLUE=false;_this.AOSTOREINMETALMAPRED=false;_this.ENVIRONMENTBRDF=false;_this.NORMAL=false;_this.TANGENT=false;_this.BUMP=false;_this.BUMPDIRECTUV=0;_this.PARALLAX=false;_this.PARALLAXOCCLUSION=false;_this.NORMALXYSCALE=true;_this.LIGHTMAP=false;_this.LIGHTMAPDIRECTUV=0;_this.USELIGHTMAPASSHADOWMAP=false;_this.REFLECTION=false;_this.REFLECTIONMAP_3D=false;_this.REFLECTIONMAP_SPHERICAL=false;_this.REFLECTIONMAP_PLANAR=false;_this.REFLECTIONMAP_CUBIC=false;_this.REFLECTIONMAP_PROJECTION=false;_this.REFLECTIONMAP_SKYBOX=false;_this.REFLECTIONMAP_EXPLICIT=false;_this.REFLECTIONMAP_EQUIRECTANGULAR=false;_this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false;_this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false;_this.INVERTCUBICMAP=false;_this.USESPHERICALFROMREFLECTIONMAP=false;_this.USESPHERICALINFRAGMENT=false;_this.REFLECTIONMAP_OPPOSITEZ=false;_this.LODINREFLECTIONALPHA=false;_this.GAMMAREFLECTION=false;_this.REFRACTION=false;_this.REFRACTIONMAP_3D=false;_this.REFRACTIONMAP_OPPOSITEZ=false;_this.LODINREFRACTIONALPHA=false;_this.GAMMAREFRACTION=false;_this.LINKREFRACTIONTOTRANSPARENCY=false;_this.INSTANCES=false;_this.NUM_BONE_INFLUENCERS=0;_this.BonesPerMesh=0;_this.MORPHTARGETS=false;_this.MORPHTARGETS_NORMAL=false;_this.MORPHTARGETS_TANGENT=false;_this.NUM_MORPH_INFLUENCERS=0;_this.IMAGEPROCESSING=false;_this.VIGNETTE=false;_this.VIGNETTEBLENDMODEMULTIPLY=false;_this.VIGNETTEBLENDMODEOPAQUE=false;_this.TONEMAPPING=false;_this.CONTRAST=false;_this.COLORCURVES=false;_this.COLORGRADING=false;_this.SAMPLER3DGREENDEPTH=false;_this.SAMPLER3DBGRMAP=false;_this.IMAGEPROCESSINGPOSTPROCESS=false;_this.EXPOSURE=false;_this.USEPHYSICALLIGHTFALLOFF=false;_this.TWOSIDEDLIGHTING=false;_this.SHADOWFLOAT=false;_this.CLIPPLANE=false;_this.POINTSIZE=false;_this.FOG=false;_this.LOGARITHMICDEPTH=false;_this.FORCENORMALFORWARD=false;_this.rebuild();return _this}PBRMaterialDefines.prototype.reset=function(){_super.prototype.reset.call(this);this.ALPHATESTVALUE=.5;this.PBR=true};return PBRMaterialDefines}(BABYLON.MaterialDefines);var PBRBaseMaterial=function(_super){__extends(PBRBaseMaterial,_super);function PBRBaseMaterial(name,scene){var _this=_super.call(this,name,scene)||this;_this._directIntensity=1;_this._emissiveIntensity=1;_this._environmentIntensity=1;_this._specularIntensity=1;_this._lightingInfos=new BABYLON.Vector4(_this._directIntensity,_this._emissiveIntensity,_this._environmentIntensity,_this._specularIntensity);_this._disableBumpMap=false;_this._ambientTextureStrength=1;_this._ambientColor=new BABYLON.Color3(0,0,0);_this._albedoColor=new BABYLON.Color3(1,1,1);_this._reflectivityColor=new BABYLON.Color3(1,1,1);_this._reflectionColor=new BABYLON.Color3(1,1,1);_this._emissiveColor=new BABYLON.Color3(0,0,0);_this._microSurface=.9;_this._indexOfRefraction=.66;_this._invertRefractionY=false;_this._linkRefractionWithTransparency=false;_this._useLightmapAsShadowmap=false;_this._useAlphaFromAlbedoTexture=false;_this._useSpecularOverAlpha=true;_this._useMicroSurfaceFromReflectivityMapAlpha=false;_this._useRoughnessFromMetallicTextureAlpha=true;_this._useRoughnessFromMetallicTextureGreen=false;_this._useMetallnessFromMetallicTextureBlue=false;_this._useAmbientOcclusionFromMetallicTextureRed=false;_this._useAmbientInGrayScale=false;_this._useAutoMicroSurfaceFromReflectivityMap=false;_this._usePhysicalLightFalloff=true;_this._useRadianceOverAlpha=true;_this._useParallax=false;_this._useParallaxOcclusion=false;_this._parallaxScaleBias=.05;_this._disableLighting=false;_this._maxSimultaneousLights=4;_this._invertNormalMapX=false;_this._invertNormalMapY=false;_this._twoSidedLighting=false;_this._alphaCutOff=.4;_this._forceAlphaTest=false;_this._preMultiplyAlpha=false;_this._useAlphaFresnel=false;_this._environmentBRDFTexture=null;_this._forceIrradianceInFragment=false;_this._forceNormalForward=false;_this._renderTargets=new BABYLON.SmartArray(16);_this._globalAmbientColor=new BABYLON.Color3(0,0,0);_this._attachImageProcessingConfiguration(null);_this.getRenderTargetTextures=function(){_this._renderTargets.reset();if(BABYLON.StandardMaterial.ReflectionTextureEnabled&&_this._reflectionTexture&&_this._reflectionTexture.isRenderTarget){_this._renderTargets.push(_this._reflectionTexture)}if(BABYLON.StandardMaterial.RefractionTextureEnabled&&_this._refractionTexture&&_this._refractionTexture.isRenderTarget){_this._renderTargets.push(_this._refractionTexture)}return _this._renderTargets};_this._environmentBRDFTexture=BABYLON.TextureTools.GetEnvironmentBRDFTexture(scene);return _this}PBRBaseMaterial.prototype._attachImageProcessingConfiguration=function(configuration){var _this=this;if(configuration===this._imageProcessingConfiguration){return}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}if(!configuration){this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration}else{this._imageProcessingConfiguration=configuration}this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(conf){_this._markAllSubMeshesAsImageProcessingDirty()})};PBRBaseMaterial.prototype.getClassName=function(){return"PBRBaseMaterial"};Object.defineProperty(PBRBaseMaterial.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(value){this._useLogarithmicDepth=value&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:true,configurable:true});PBRBaseMaterial.prototype.needAlphaBlending=function(){if(this._linkRefractionWithTransparency){return false}return this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()};PBRBaseMaterial.prototype.needAlphaTesting=function(){if(this._forceAlphaTest){return true}if(this._linkRefractionWithTransparency){return false}return this._albedoTexture!=null&&this._albedoTexture.hasAlpha};PBRBaseMaterial.prototype._shouldUseAlphaFromAlbedoTexture=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture};PBRBaseMaterial.prototype.getAlphaTestTexture=function(){return this._albedoTexture};PBRBaseMaterial.prototype.isReadyForSubMesh=function(mesh,subMesh,useInstances){var _this=this;if(this.isFrozen){if(this._wasPreviouslyReady){return true}}if(!subMesh._materialDefines){subMesh._materialDefines=new PBRMaterialDefines}var scene=this.getScene();var defines=subMesh._materialDefines;if(!this.checkReadyOnEveryCall&&subMesh.effect){if(defines._renderId===scene.getRenderId()){return true}}var engine=scene.getEngine();BABYLON.MaterialHelper.PrepareDefinesForLights(scene,mesh,defines,true,this._maxSimultaneousLights,this._disableLighting);defines._needNormals=true;if(defines._areTexturesDirty){defines._needUVs=false;if(scene.texturesEnabled){if(scene.getEngine().getCaps().textureLOD){defines.LODBASEDMICROSFURACE=true}if(this._albedoTexture&&BABYLON.StandardMaterial.DiffuseTextureEnabled){if(!this._albedoTexture.isReadyOrNotBlocking()){return false}BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._albedoTexture,defines,"ALBEDO")}else{defines.ALBEDO=false}if(this._ambientTexture&&BABYLON.StandardMaterial.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking()){return false}BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._ambientTexture,defines,"AMBIENT");defines.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale}else{defines.AMBIENT=false}if(this._opacityTexture&&BABYLON.StandardMaterial.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking()){return false}BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._opacityTexture,defines,"OPACITY");defines.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else{defines.OPACITY=false}var reflectionTexture=this._getReflectionTexture();if(reflectionTexture&&BABYLON.StandardMaterial.ReflectionTextureEnabled){if(!reflectionTexture.isReadyOrNotBlocking()){return false}defines.REFLECTION=true;defines.GAMMAREFLECTION=reflectionTexture.gammaSpace;defines.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!reflectionTexture.invertZ:reflectionTexture.invertZ;defines.LODINREFLECTIONALPHA=reflectionTexture.lodLevelInAlpha;if(reflectionTexture.coordinatesMode===BABYLON.Texture.INVCUBIC_MODE){defines.INVERTCUBICMAP=true}defines.REFLECTIONMAP_3D=reflectionTexture.isCube;switch(reflectionTexture.coordinatesMode){case BABYLON.Texture.CUBIC_MODE:case BABYLON.Texture.INVCUBIC_MODE:defines.REFLECTIONMAP_CUBIC=true;break;case BABYLON.Texture.EXPLICIT_MODE:defines.REFLECTIONMAP_EXPLICIT=true;break;case BABYLON.Texture.PLANAR_MODE:defines.REFLECTIONMAP_PLANAR=true;break;case BABYLON.Texture.PROJECTION_MODE:defines.REFLECTIONMAP_PROJECTION=true;break;case BABYLON.Texture.SKYBOX_MODE:defines.REFLECTIONMAP_SKYBOX=true;break;case BABYLON.Texture.SPHERICAL_MODE:defines.REFLECTIONMAP_SPHERICAL=true;break;case BABYLON.Texture.EQUIRECTANGULAR_MODE:defines.REFLECTIONMAP_EQUIRECTANGULAR=true;break;case BABYLON.Texture.FIXED_EQUIRECTANGULAR_MODE:defines.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=true;break;case BABYLON.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:defines.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=true;break}if(reflectionTexture.coordinatesMode!==BABYLON.Texture.SKYBOX_MODE){if(reflectionTexture.sphericalPolynomial){defines.USESPHERICALFROMREFLECTIONMAP=true;if(this._forceIrradianceInFragment||scene.getEngine().getCaps().maxVaryingVectors<=8){defines.USESPHERICALINFRAGMENT=true}}}}else{defines.REFLECTION=false;defines.REFLECTIONMAP_3D=false;defines.REFLECTIONMAP_SPHERICAL=false;defines.REFLECTIONMAP_PLANAR=false;defines.REFLECTIONMAP_CUBIC=false;defines.REFLECTIONMAP_PROJECTION=false;defines.REFLECTIONMAP_SKYBOX=false;defines.REFLECTIONMAP_EXPLICIT=false;defines.REFLECTIONMAP_EQUIRECTANGULAR=false;defines.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false;defines.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false;defines.INVERTCUBICMAP=false;defines.USESPHERICALFROMREFLECTIONMAP=false;defines.USESPHERICALINFRAGMENT=false;defines.REFLECTIONMAP_OPPOSITEZ=false;defines.LODINREFLECTIONALPHA=false;defines.GAMMAREFLECTION=false}if(this._lightmapTexture&&BABYLON.StandardMaterial.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking()){return false}BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._lightmapTexture,defines,"LIGHTMAP");defines.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap}else{defines.LIGHTMAP=false}if(this._emissiveTexture&&BABYLON.StandardMaterial.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking()){return false}BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._emissiveTexture,defines,"EMISSIVE")}else{defines.EMISSIVE=false}if(BABYLON.StandardMaterial.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking()){return false}BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._metallicTexture,defines,"REFLECTIVITY");defines.METALLICWORKFLOW=true;defines.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha;defines.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen;defines.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue;defines.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed}else if(this._reflectivityTexture){if(!this._reflectivityTexture.isReadyOrNotBlocking()){return false}defines.METALLICWORKFLOW=false;BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._reflectivityTexture,defines,"REFLECTIVITY");defines.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha;defines.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap}else{defines.METALLICWORKFLOW=false;defines.REFLECTIVITY=false}if(this._microSurfaceTexture){if(!this._microSurfaceTexture.isReadyOrNotBlocking()){return false}BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._microSurfaceTexture,defines,"MICROSURFACEMAP")}else{defines.MICROSURFACEMAP=false}}else{defines.REFLECTIVITY=false;defines.MICROSURFACEMAP=false}if(scene.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&BABYLON.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap){if(!this._bumpTexture.isReady()){return false}BABYLON.MaterialHelper.PrepareDefinesForMergedUV(this._bumpTexture,defines,"BUMP");if(this._useParallax&&this._albedoTexture&&BABYLON.StandardMaterial.DiffuseTextureEnabled){defines.PARALLAX=true;defines.PARALLAXOCCLUSION=!!this._useParallaxOcclusion}else{defines.PARALLAX=false}}else{defines.BUMP=false}var refractionTexture=this._getRefractionTexture();if(refractionTexture&&BABYLON.StandardMaterial.RefractionTextureEnabled){if(!refractionTexture.isReadyOrNotBlocking()){return false}defines.REFRACTION=true;defines.REFRACTIONMAP_3D=refractionTexture.isCube;defines.GAMMAREFRACTION=refractionTexture.gammaSpace;defines.REFRACTIONMAP_OPPOSITEZ=reflectionTexture.invertZ;defines.LODINREFRACTIONALPHA=reflectionTexture.lodLevelInAlpha;if(this._linkRefractionWithTransparency){defines.LINKREFRACTIONTOTRANSPARENCY=true}}else{defines.REFRACTION=false}if(this._environmentBRDFTexture&&BABYLON.StandardMaterial.ReflectionTextureEnabled){if(!this._environmentBRDFTexture.isReady()){return false}defines.ENVIRONMENTBRDF=true}if(this._shouldUseAlphaFromAlbedoTexture()){defines.ALPHAFROMALBEDO=true}}if(this._useSpecularOverAlpha){defines.SPECULAROVERALPHA=true}if(this._usePhysicalLightFalloff){defines.USEPHYSICALLIGHTFALLOFF=true}if(this._useRadianceOverAlpha){defines.RADIANCEOVERALPHA=true}if(this._metallic!==undefined&&this._metallic!==null||this._roughness!==undefined&&this._roughness!==null){defines.METALLICWORKFLOW=true}if(!this.backFaceCulling&&this._twoSidedLighting){defines.TWOSIDEDLIGHTING=true}defines.ALPHATESTVALUE=this._alphaCutOff;defines.PREMULTIPLYALPHA=this._preMultiplyAlpha;defines.ALPHABLEND=this.needAlphaBlending();defines.ALPHAFRESNEL=this._useAlphaFresnel}if(defines._areImageProcessingDirty){if(!this._imageProcessingConfiguration.isReady()){return false}this._imageProcessingConfiguration.prepareDefines(defines)}defines.FORCENORMALFORWARD=this._forceNormalForward;BABYLON.MaterialHelper.PrepareDefinesForMisc(mesh,scene,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,defines);BABYLON.MaterialHelper.PrepareDefinesForFrameBoundValues(scene,engine,defines,useInstances,this._forceAlphaTest);if(BABYLON.MaterialHelper.PrepareDefinesForAttributes(mesh,defines,true,true,true)){if(mesh){if(!scene.getEngine().getCaps().standardDerivatives&&!mesh.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){mesh.createNormals(true);BABYLON.Tools.Warn("PBRMaterial: Normals have been created for the mesh: "+mesh.name)}}}if(defines.isDirty){defines.markAsProcessed();scene.resetCachedMaterial();var fallbacks=new BABYLON.EffectFallbacks;if(defines.ENVIRONMENTBRDF){fallbacks.addFallback(0,"ENVIRONMENTBRDF")}if(defines.REFLECTION){fallbacks.addFallback(0,"REFLECTION")}if(defines.REFRACTION){fallbacks.addFallback(0,"REFRACTION")}if(defines.REFLECTIVITY){fallbacks.addFallback(0,"REFLECTIVITY")}if(defines.BUMP){fallbacks.addFallback(0,"BUMP")}if(defines.PARALLAX){fallbacks.addFallback(1,"PARALLAX")}if(defines.PARALLAXOCCLUSION){fallbacks.addFallback(0,"PARALLAXOCCLUSION")}if(defines.SPECULAROVERALPHA){fallbacks.addFallback(0,"SPECULAROVERALPHA")}if(defines.FOG){fallbacks.addFallback(1,"FOG")}if(defines.POINTSIZE){fallbacks.addFallback(0,"POINTSIZE")}if(defines.LOGARITHMICDEPTH){fallbacks.addFallback(0,"LOGARITHMICDEPTH")}BABYLON.MaterialHelper.HandleFallbacksForShadows(defines,fallbacks,this._maxSimultaneousLights);if(defines.SPECULARTERM){fallbacks.addFallback(0,"SPECULARTERM")}if(defines.NUM_BONE_INFLUENCERS>0){fallbacks.addCPUSkinningFallback(0,mesh)}var attribs=[BABYLON.VertexBuffer.PositionKind];if(defines.NORMAL){attribs.push(BABYLON.VertexBuffer.NormalKind)}if(defines.TANGENT){attribs.push(BABYLON.VertexBuffer.TangentKind)}if(defines.UV1){attribs.push(BABYLON.VertexBuffer.UVKind)}if(defines.UV2){attribs.push(BABYLON.VertexBuffer.UV2Kind)}if(defines.VERTEXCOLOR){attribs.push(BABYLON.VertexBuffer.ColorKind)}BABYLON.MaterialHelper.PrepareAttributesForBones(attribs,mesh,defines,fallbacks);BABYLON.MaterialHelper.PrepareAttributesForInstances(attribs,defines);BABYLON.MaterialHelper.PrepareAttributesForMorphTargets(attribs,mesh,defines);var uniforms=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vEmissiveColor","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vReflectivityInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","refractionMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX","vSphericalYY","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vReflectionMicrosurfaceInfos","vRefractionMicrosurfaceInfos","vTangentSpaceParams"];var samplers=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","microSurfaceSampler","environmentBrdfSampler"];var uniformBuffers=["Material","Scene"];BABYLON.ImageProcessingConfiguration.PrepareUniforms(uniforms,defines);BABYLON.ImageProcessingConfiguration.PrepareSamplers(samplers,defines);BABYLON.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:uniforms,uniformBuffersNames:uniformBuffers,samplers:samplers,defines:defines,maxSimultaneousLights:this._maxSimultaneousLights});var onCompiled=function(effect){if(_this.onCompiled){_this.onCompiled(effect)}_this.bindSceneUniformBuffer(effect,scene.getSceneUniformBuffer())};var join=defines.toString();subMesh.setEffect(scene.getEngine().createEffect("pbr",{attributes:attribs,uniformsNames:uniforms,uniformBuffersNames:uniformBuffers,samplers:samplers,defines:join,fallbacks:fallbacks,onCompiled:onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:defines.NUM_MORPH_INFLUENCERS}},engine),defines);this.buildUniformLayout()}if(!subMesh.effect.isReady()){return false}defines._renderId=scene.getRenderId();this._wasPreviouslyReady=true;return true};PBRBaseMaterial.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("vAlbedoInfos",2);this._uniformBuffer.addUniform("vAmbientInfos",3);this._uniformBuffer.addUniform("vOpacityInfos",2);this._uniformBuffer.addUniform("vEmissiveInfos",2);this._uniformBuffer.addUniform("vLightmapInfos",2);this._uniformBuffer.addUniform("vReflectivityInfos",3);this._uniformBuffer.addUniform("vMicroSurfaceSamplerInfos",2);this._uniformBuffer.addUniform("vRefractionInfos",4);this._uniformBuffer.addUniform("vReflectionInfos",2);this._uniformBuffer.addUniform("vBumpInfos",3);this._uniformBuffer.addUniform("albedoMatrix",16);this._uniformBuffer.addUniform("ambientMatrix",16);this._uniformBuffer.addUniform("opacityMatrix",16);this._uniformBuffer.addUniform("emissiveMatrix",16);this._uniformBuffer.addUniform("lightmapMatrix",16);this._uniformBuffer.addUniform("reflectivityMatrix",16);this._uniformBuffer.addUniform("microSurfaceSamplerMatrix",16);this._uniformBuffer.addUniform("bumpMatrix",16);this._uniformBuffer.addUniform("vTangentSpaceParams",2);this._uniformBuffer.addUniform("refractionMatrix",16);this._uniformBuffer.addUniform("reflectionMatrix",16);this._uniformBuffer.addUniform("vReflectionColor",3);this._uniformBuffer.addUniform("vAlbedoColor",4);this._uniformBuffer.addUniform("vLightingIntensity",4);this._uniformBuffer.addUniform("vRefractionMicrosurfaceInfos",3);this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3);this._uniformBuffer.addUniform("vReflectivityColor",4);this._uniformBuffer.addUniform("vEmissiveColor",3);this._uniformBuffer.addUniform("pointSize",1);this._uniformBuffer.create()};PBRBaseMaterial.prototype.unbind=function(){if(this._reflectionTexture&&this._reflectionTexture.isRenderTarget){this._uniformBuffer.setTexture("reflectionSampler",null)}if(this._refractionTexture&&this._refractionTexture.isRenderTarget){this._uniformBuffer.setTexture("refractionSampler",null)}_super.prototype.unbind.call(this)};PBRBaseMaterial.prototype.bindOnlyWorldMatrix=function(world){this._activeEffect.setMatrix("world",world)};PBRBaseMaterial.prototype.bindForSubMesh=function(world,mesh,subMesh){var scene=this.getScene();var defines=subMesh._materialDefines;if(!defines){return}var effect=subMesh.effect;this._activeEffect=effect;this.bindOnlyWorldMatrix(world);var mustRebind=this._mustRebind(scene,effect,mesh.visibility);BABYLON.MaterialHelper.BindBonesParameters(mesh,this._activeEffect);if(mustRebind){this._uniformBuffer.bindToEffect(effect,"Material");this.bindViewProjection(effect);var reflectionTexture=this._getReflectionTexture();var refractionTexture=this._getRefractionTexture();if(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync){if(scene.texturesEnabled){if(this._albedoTexture&&BABYLON.StandardMaterial.DiffuseTextureEnabled){this._uniformBuffer.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._albedoTexture,this._uniformBuffer,"albedo")}if(this._ambientTexture&&BABYLON.StandardMaterial.AmbientTextureEnabled){this._uniformBuffer.updateFloat3("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength);BABYLON.MaterialHelper.BindTextureMatrix(this._ambientTexture,this._uniformBuffer,"ambient")}if(this._opacityTexture&&BABYLON.StandardMaterial.OpacityTextureEnabled){this._uniformBuffer.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._opacityTexture,this._uniformBuffer,"opacity")}if(reflectionTexture&&BABYLON.StandardMaterial.ReflectionTextureEnabled){this._uniformBuffer.updateMatrix("reflectionMatrix",reflectionTexture.getReflectionTextureMatrix());this._uniformBuffer.updateFloat2("vReflectionInfos",reflectionTexture.level,0);if(defines.USESPHERICALFROMREFLECTIONMAP){var polynomials=reflectionTexture.sphericalPolynomial;this._activeEffect.setFloat3("vSphericalX",polynomials.x.x,polynomials.x.y,polynomials.x.z);this._activeEffect.setFloat3("vSphericalY",polynomials.y.x,polynomials.y.y,polynomials.y.z);this._activeEffect.setFloat3("vSphericalZ",polynomials.z.x,polynomials.z.y,polynomials.z.z);this._activeEffect.setFloat3("vSphericalXX_ZZ",polynomials.xx.x-polynomials.zz.x,polynomials.xx.y-polynomials.zz.y,polynomials.xx.z-polynomials.zz.z);this._activeEffect.setFloat3("vSphericalYY_ZZ",polynomials.yy.x-polynomials.zz.x,polynomials.yy.y-polynomials.zz.y,polynomials.yy.z-polynomials.zz.z);this._activeEffect.setFloat3("vSphericalZZ",polynomials.zz.x,polynomials.zz.y,polynomials.zz.z);this._activeEffect.setFloat3("vSphericalXY",polynomials.xy.x,polynomials.xy.y,polynomials.xy.z);this._activeEffect.setFloat3("vSphericalYZ",polynomials.yz.x,polynomials.yz.y,polynomials.yz.z);this._activeEffect.setFloat3("vSphericalZX",polynomials.zx.x,polynomials.zx.y,polynomials.zx.z)}this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",reflectionTexture.getSize().width,reflectionTexture.lodGenerationScale,reflectionTexture.lodGenerationOffset)}if(this._emissiveTexture&&BABYLON.StandardMaterial.EmissiveTextureEnabled){this._uniformBuffer.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._emissiveTexture,this._uniformBuffer,"emissive")}if(this._lightmapTexture&&BABYLON.StandardMaterial.LightmapTextureEnabled){this._uniformBuffer.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._lightmapTexture,this._uniformBuffer,"lightmap")}if(BABYLON.StandardMaterial.SpecularTextureEnabled){if(this._metallicTexture){this._uniformBuffer.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength);BABYLON.MaterialHelper.BindTextureMatrix(this._metallicTexture,this._uniformBuffer,"reflectivity")}else if(this._reflectivityTexture){this._uniformBuffer.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1);BABYLON.MaterialHelper.BindTextureMatrix(this._reflectivityTexture,this._uniformBuffer,"reflectivity")}if(this._microSurfaceTexture){this._uniformBuffer.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level);BABYLON.MaterialHelper.BindTextureMatrix(this._microSurfaceTexture,this._uniformBuffer,"microSurfaceSampler")}}if(this._bumpTexture&&scene.getEngine().getCaps().standardDerivatives&&BABYLON.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap){this._uniformBuffer.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias);BABYLON.MaterialHelper.BindTextureMatrix(this._bumpTexture,this._uniformBuffer,"bump");if(scene._mirroredCameraPosition){this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1)}else{this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)}}if(refractionTexture&&BABYLON.StandardMaterial.RefractionTextureEnabled){this._uniformBuffer.updateMatrix("refractionMatrix",refractionTexture.getReflectionTextureMatrix());var depth=1;if(!refractionTexture.isCube){if(refractionTexture.depth){depth=refractionTexture.depth}}this._uniformBuffer.updateFloat4("vRefractionInfos",refractionTexture.level,this._indexOfRefraction,depth,this._invertRefractionY?-1:1);this._uniformBuffer.updateFloat3("vRefractionMicrosurfaceInfos",refractionTexture.getSize().width,refractionTexture.lodGenerationScale,refractionTexture.lodGenerationOffset)}}if(this.pointsCloud){this._uniformBuffer.updateFloat("pointSize",this.pointSize)}if(defines.METALLICWORKFLOW){BABYLON.PBRMaterial._scaledReflectivity.r=this._metallic===undefined||this._metallic===null?1:this._metallic;BABYLON.PBRMaterial._scaledReflectivity.g=this._roughness===undefined||this._roughness===null?1:this._roughness;this._uniformBuffer.updateColor4("vReflectivityColor",BABYLON.PBRMaterial._scaledReflectivity,0)}else{this._uniformBuffer.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface)}this._uniformBuffer.updateColor3("vEmissiveColor",this._emissiveColor);this._uniformBuffer.updateColor3("vReflectionColor",this._reflectionColor);this._uniformBuffer.updateColor4("vAlbedoColor",this._albedoColor,this.alpha*mesh.visibility);this._lightingInfos.x=this._directIntensity;this._lightingInfos.y=this._emissiveIntensity;this._lightingInfos.z=this._environmentIntensity;this._lightingInfos.w=this._specularIntensity;this._uniformBuffer.updateVector4("vLightingIntensity",this._lightingInfos)}if(scene.texturesEnabled){if(this._albedoTexture&&BABYLON.StandardMaterial.DiffuseTextureEnabled){this._uniformBuffer.setTexture("albedoSampler",this._albedoTexture)}if(this._ambientTexture&&BABYLON.StandardMaterial.AmbientTextureEnabled){this._uniformBuffer.setTexture("ambientSampler",this._ambientTexture)}if(this._opacityTexture&&BABYLON.StandardMaterial.OpacityTextureEnabled){this._uniformBuffer.setTexture("opacitySampler",this._opacityTexture)}if(reflectionTexture&&BABYLON.StandardMaterial.ReflectionTextureEnabled){if(defines.LODBASEDMICROSFURACE){this._uniformBuffer.setTexture("reflectionSampler",reflectionTexture)}else{this._uniformBuffer.setTexture("reflectionSampler",reflectionTexture._lodTextureMid||reflectionTexture);this._uniformBuffer.setTexture("reflectionSamplerLow",reflectionTexture._lodTextureLow||reflectionTexture);this._uniformBuffer.setTexture("reflectionSamplerHigh",reflectionTexture._lodTextureHigh||reflectionTexture)}}if(defines.ENVIRONMENTBRDF){this._uniformBuffer.setTexture("environmentBrdfSampler",this._environmentBRDFTexture)}if(refractionTexture&&BABYLON.StandardMaterial.RefractionTextureEnabled){if(defines.LODBASEDMICROSFURACE){this._uniformBuffer.setTexture("refractionSampler",refractionTexture)}else{this._uniformBuffer.setTexture("refractionSampler",refractionTexture._lodTextureMid||refractionTexture);this._uniformBuffer.setTexture("refractionSamplerLow",refractionTexture._lodTextureLow||refractionTexture);this._uniformBuffer.setTexture("refractionSamplerHigh",refractionTexture._lodTextureHigh||refractionTexture)}}if(this._emissiveTexture&&BABYLON.StandardMaterial.EmissiveTextureEnabled){this._uniformBuffer.setTexture("emissiveSampler",this._emissiveTexture)}if(this._lightmapTexture&&BABYLON.StandardMaterial.LightmapTextureEnabled){this._uniformBuffer.setTexture("lightmapSampler",this._lightmapTexture)}if(BABYLON.StandardMaterial.SpecularTextureEnabled){if(this._metallicTexture){this._uniformBuffer.setTexture("reflectivitySampler",this._metallicTexture)}else if(this._reflectivityTexture){this._uniformBuffer.setTexture("reflectivitySampler",this._reflectivityTexture)}if(this._microSurfaceTexture){this._uniformBuffer.setTexture("microSurfaceSampler",this._microSurfaceTexture)}}if(this._bumpTexture&&scene.getEngine().getCaps().standardDerivatives&&BABYLON.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap){this._uniformBuffer.setTexture("bumpSampler",this._bumpTexture)}}BABYLON.MaterialHelper.BindClipPlane(this._activeEffect,scene);scene.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor);var eyePosition=scene._mirroredCameraPosition?scene._mirroredCameraPosition:scene.activeCamera.globalPosition;var invertNormal=scene.useRightHandedSystem===(scene._mirroredCameraPosition!=null);effect.setFloat4("vEyePosition",eyePosition.x,eyePosition.y,eyePosition.z,invertNormal?-1:1);effect.setColor3("vAmbientColor",this._globalAmbientColor)}if(mustRebind||!this.isFrozen){if(scene.lightsEnabled&&!this._disableLighting){BABYLON.MaterialHelper.BindLights(scene,mesh,this._activeEffect,defines,this._maxSimultaneousLights,this._usePhysicalLightFalloff)}if(scene.fogEnabled&&mesh.applyFog&&scene.fogMode!==BABYLON.Scene.FOGMODE_NONE||reflectionTexture){this.bindView(effect)}BABYLON.MaterialHelper.BindFogParameters(scene,mesh,this._activeEffect);if(defines.NUM_MORPH_INFLUENCERS){BABYLON.MaterialHelper.BindMorphTargetParameters(mesh,this._activeEffect)}this._imageProcessingConfiguration.bind(this._activeEffect);BABYLON.MaterialHelper.BindLogDepth(defines,this._activeEffect,scene)}this._uniformBuffer.update();this._afterBind(mesh);scene=null};PBRBaseMaterial.prototype.getAnimatables=function(){var results=[];if(this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0){results.push(this._albedoTexture)}if(this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0){results.push(this._ambientTexture)}if(this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0){results.push(this._opacityTexture)}if(this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0){results.push(this._reflectionTexture)}if(this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0){results.push(this._emissiveTexture)}if(this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0){results.push(this._metallicTexture)}else if(this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0){results.push(this._reflectivityTexture)}if(this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0){results.push(this._bumpTexture)}if(this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0){results.push(this._lightmapTexture)}if(this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0){results.push(this._refractionTexture)}return results};PBRBaseMaterial.prototype._getReflectionTexture=function(){if(this._reflectionTexture){return this._reflectionTexture}return this.getScene().environmentTexture};PBRBaseMaterial.prototype._getRefractionTexture=function(){if(this._refractionTexture){return this._refractionTexture}if(this._linkRefractionWithTransparency){return this.getScene().environmentTexture}return null};PBRBaseMaterial.prototype.dispose=function(forceDisposeEffect,forceDisposeTextures){if(forceDisposeTextures){if(this._albedoTexture){this._albedoTexture.dispose()}if(this._ambientTexture){this._ambientTexture.dispose()}if(this._opacityTexture){this._opacityTexture.dispose()}if(this._reflectionTexture){this._reflectionTexture.dispose()}if(this._environmentBRDFTexture){this._environmentBRDFTexture.dispose()}if(this._emissiveTexture){this._emissiveTexture.dispose()}if(this._metallicTexture){this._metallicTexture.dispose()}if(this._reflectivityTexture){this._reflectivityTexture.dispose()}if(this._bumpTexture){this._bumpTexture.dispose()}if(this._lightmapTexture){this._lightmapTexture.dispose()}if(this._refractionTexture){this._refractionTexture.dispose()}}this._renderTargets.dispose();if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}_super.prototype.dispose.call(this,forceDisposeEffect,forceDisposeTextures)};PBRBaseMaterial._scaledReflectivity=new BABYLON.Color3;__decorate([BABYLON.serializeAsImageProcessingConfiguration()],PBRBaseMaterial.prototype,"_imageProcessingConfiguration",void 0);__decorate([BABYLON.serialize()],PBRBaseMaterial.prototype,"useLogarithmicDepth",null);return PBRBaseMaterial}(BABYLON.PushMaterial);BABYLON.PBRBaseMaterial=PBRBaseMaterial})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var PBRBaseSimpleMaterial=function(_super){__extends(PBRBaseSimpleMaterial,_super);function PBRBaseSimpleMaterial(name,scene){var _this=_super.call(this,name,scene)||this;_this.maxSimultaneousLights=4;_this.disableLighting=false;_this.invertNormalMapX=false;_this.invertNormalMapY=false;_this.emissiveColor=new BABYLON.Color3(0,0,0);_this.occlusionStrength=1;_this._transparencyMode=BABYLON.PBRMaterial.PBRMATERIAL_OPAQUE;_this._useAmbientInGrayScale=true;return _this}Object.defineProperty(PBRBaseSimpleMaterial.prototype,"transparencyMode",{get:function(){return this._transparencyMode},set:function(value){if(this._transparencyMode===value){return}this._transparencyMode=value;if(value===BABYLON.PBRMaterial.PBRMATERIAL_ALPHATESTANDBLEND){this._forceAlphaTest=true}else{this._forceAlphaTest=false}this._markAllSubMeshesAsTexturesDirty()},enumerable:true,configurable:true});Object.defineProperty(PBRBaseSimpleMaterial.prototype,"doubleSided",{get:function(){return this._twoSidedLighting},set:function(value){if(this._twoSidedLighting===value){return}this._twoSidedLighting=value;this.backFaceCulling=!value;this._markAllSubMeshesAsTexturesDirty()},enumerable:true,configurable:true});PBRBaseSimpleMaterial.prototype._shouldUseAlphaFromAlbedoTexture=function(){return this._albedoTexture&&this._albedoTexture.hasAlpha&&this._transparencyMode!==BABYLON.PBRMaterial.PBRMATERIAL_OPAQUE};PBRBaseSimpleMaterial.prototype.needAlphaBlending=function(){if(this._linkRefractionWithTransparency){return false}return this.alpha<1||this._shouldUseAlphaFromAlbedoTexture()&&(this._transparencyMode===BABYLON.PBRMaterial.PBRMATERIAL_ALPHABLEND||this._transparencyMode===BABYLON.PBRMaterial.PBRMATERIAL_ALPHATESTANDBLEND)};PBRBaseSimpleMaterial.prototype.needAlphaTesting=function(){if(this._linkRefractionWithTransparency){return false}return this._shouldUseAlphaFromAlbedoTexture()&&this._transparencyMode===BABYLON.PBRMaterial.PBRMATERIAL_ALPHATEST};PBRBaseSimpleMaterial.prototype.getActiveTextures=function(){var activeTextures=_super.prototype.getActiveTextures.call(this);if(this.environmentTexture){activeTextures.push(this.environmentTexture)}if(this.normalTexture){activeTextures.push(this.normalTexture)}if(this.emissiveTexture){activeTextures.push(this.emissiveTexture)}if(this.occlusionTexture){activeTextures.push(this.occlusionTexture)}return activeTextures};PBRBaseSimpleMaterial.prototype.getClassName=function(){return"PBRBaseSimpleMaterial"};__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsLightsDirty")],PBRBaseSimpleMaterial.prototype,"maxSimultaneousLights",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsLightsDirty")],PBRBaseSimpleMaterial.prototype,"disableLighting",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],PBRBaseSimpleMaterial.prototype,"environmentTexture",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRBaseSimpleMaterial.prototype,"invertNormalMapX",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRBaseSimpleMaterial.prototype,"invertNormalMapY",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],PBRBaseSimpleMaterial.prototype,"normalTexture",void 0);__decorate([BABYLON.serializeAsColor3("emissive"),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRBaseSimpleMaterial.prototype,"emissiveColor",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRBaseSimpleMaterial.prototype,"emissiveTexture",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],PBRBaseSimpleMaterial.prototype,"occlusionStrength",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],PBRBaseSimpleMaterial.prototype,"occlusionTexture",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],PBRBaseSimpleMaterial.prototype,"alphaCutOff",void 0);__decorate([BABYLON.serialize()],PBRBaseSimpleMaterial.prototype,"transparencyMode",null);__decorate([BABYLON.serialize()],PBRBaseSimpleMaterial.prototype,"doubleSided",null);return PBRBaseSimpleMaterial}(BABYLON.PBRBaseMaterial);Internals.PBRBaseSimpleMaterial=PBRBaseSimpleMaterial})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PBRMaterial=function(_super){__extends(PBRMaterial,_super);function PBRMaterial(name,scene){var _this=_super.call(this,name,scene)||this;_this.directIntensity=1;_this.emissiveIntensity=1;_this.environmentIntensity=1;_this.specularIntensity=1;_this.disableBumpMap=false;_this.ambientTextureStrength=1;_this.ambientColor=new BABYLON.Color3(0,0,0);_this.albedoColor=new BABYLON.Color3(1,1,1);_this.reflectivityColor=new BABYLON.Color3(1,1,1);_this.reflectionColor=new BABYLON.Color3(1,1,1);_this.emissiveColor=new BABYLON.Color3(0,0,0);_this.microSurface=1;_this.indexOfRefraction=.66;_this.invertRefractionY=false;_this.linkRefractionWithTransparency=false;_this.useLightmapAsShadowmap=false;_this.useAlphaFromAlbedoTexture=false;_this.forceAlphaTest=false;_this.alphaCutOff=.4;_this.useSpecularOverAlpha=true;_this.useMicroSurfaceFromReflectivityMapAlpha=false;_this.useRoughnessFromMetallicTextureAlpha=true;_this.useRoughnessFromMetallicTextureGreen=false;_this.useMetallnessFromMetallicTextureBlue=false;_this.useAmbientOcclusionFromMetallicTextureRed=false;_this.useAmbientInGrayScale=false;_this.useAutoMicroSurfaceFromReflectivityMap=false;_this.usePhysicalLightFalloff=true;_this.useRadianceOverAlpha=true;_this.useParallax=false;_this.useParallaxOcclusion=false;_this.parallaxScaleBias=.05;_this.disableLighting=false;_this.forceIrradianceInFragment=false;_this.maxSimultaneousLights=4;_this.invertNormalMapX=false;_this.invertNormalMapY=false;_this.twoSidedLighting=false;_this.preMultiplyAlpha=false;_this.useAlphaFresnel=false;_this.environmentBRDFTexture=null;_this.forceNormalForward=false;_this._environmentBRDFTexture=BABYLON.TextureTools.GetEnvironmentBRDFTexture(scene);return _this}Object.defineProperty(PBRMaterial,"PBRMATERIAL_OPAQUE",{get:function(){return this._PBRMATERIAL_OPAQUE},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial,"PBRMATERIAL_ALPHATEST",{get:function(){return this._PBRMATERIAL_ALPHATEST},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial,"PBRMATERIAL_ALPHABLEND",{get:function(){return this._PBRMATERIAL_ALPHABLEND},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial,"PBRMATERIAL_ALPHATESTANDBLEND",{get:function(){return this._PBRMATERIAL_ALPHATESTANDBLEND},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(value){this._attachImageProcessingConfiguration(value);this._markAllSubMeshesAsTexturesDirty()},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(value){this.imageProcessingConfiguration.colorCurvesEnabled=value},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(value){this.imageProcessingConfiguration.colorGradingEnabled=value},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(value){this._imageProcessingConfiguration.toneMappingEnabled=value},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(value){this._imageProcessingConfiguration.exposure=value},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(value){this._imageProcessingConfiguration.contrast=value},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(value){this._imageProcessingConfiguration.colorGradingTexture=value},enumerable:true,configurable:true});Object.defineProperty(PBRMaterial.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(value){this._imageProcessingConfiguration.colorCurves=value},enumerable:true,configurable:true});PBRMaterial.prototype.getClassName=function(){return"PBRMaterial"};PBRMaterial.prototype.getActiveTextures=function(){var activeTextures=_super.prototype.getActiveTextures.call(this);if(this._albedoTexture){activeTextures.push(this._albedoTexture)}if(this._ambientTexture){activeTextures.push(this._ambientTexture)}if(this._opacityTexture){activeTextures.push(this._opacityTexture)}if(this._reflectionTexture){activeTextures.push(this._reflectionTexture)}if(this._emissiveTexture){activeTextures.push(this._emissiveTexture)}if(this._reflectivityTexture){activeTextures.push(this._reflectivityTexture)}if(this._metallicTexture){activeTextures.push(this._metallicTexture)}if(this._microSurfaceTexture){activeTextures.push(this._microSurfaceTexture)}if(this._bumpTexture){activeTextures.push(this._bumpTexture)}if(this._lightmapTexture){activeTextures.push(this._lightmapTexture)}if(this._refractionTexture){activeTextures.push(this._refractionTexture)}return activeTextures};PBRMaterial.prototype.hasTexture=function(texture){if(_super.prototype.hasTexture.call(this,texture)){return true}if(this._albedoTexture===texture){return true}if(this._ambientTexture===texture){return true}if(this._opacityTexture===texture){return true}if(this._reflectionTexture===texture){return true}if(this._reflectivityTexture===texture){return true}if(this._metallicTexture===texture){return true}if(this._microSurfaceTexture===texture){return true}if(this._bumpTexture===texture){return true}if(this._lightmapTexture===texture){return true}if(this._refractionTexture===texture){return true}return false};PBRMaterial.prototype.clone=function(name){var _this=this;var clone=BABYLON.SerializationHelper.Clone(function(){return new PBRMaterial(name,_this.getScene())},this);clone.id=name;clone.name=name;return clone};PBRMaterial.prototype.serialize=function(){var serializationObject=BABYLON.SerializationHelper.Serialize(this);serializationObject.customType="BABYLON.PBRMaterial";return serializationObject};PBRMaterial.Parse=function(source,scene,rootUrl){return BABYLON.SerializationHelper.Parse(function(){return new PBRMaterial(source.name,scene)},source,scene,rootUrl)};PBRMaterial._PBRMATERIAL_OPAQUE=0;PBRMaterial._PBRMATERIAL_ALPHATEST=1;PBRMaterial._PBRMATERIAL_ALPHABLEND=2;PBRMaterial._PBRMATERIAL_ALPHATESTANDBLEND=3;__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"directIntensity",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"emissiveIntensity",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"environmentIntensity",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"specularIntensity",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"disableBumpMap",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"albedoTexture",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"ambientTexture",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"ambientTextureStrength",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"opacityTexture",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"reflectionTexture",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"emissiveTexture",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"reflectivityTexture",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"metallicTexture",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"metallic",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"roughness",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"microSurfaceTexture",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"bumpTexture",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty",null)],PBRMaterial.prototype,"lightmapTexture",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"refractionTexture",void 0);__decorate([BABYLON.serializeAsColor3("ambient"),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"ambientColor",void 0);__decorate([BABYLON.serializeAsColor3("albedo"),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"albedoColor",void 0);__decorate([BABYLON.serializeAsColor3("reflectivity"),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"reflectivityColor",void 0);__decorate([BABYLON.serializeAsColor3("reflection"),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"reflectionColor",void 0);__decorate([BABYLON.serializeAsColor3("emissive"),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"emissiveColor",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"microSurface",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"indexOfRefraction",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"invertRefractionY",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"linkRefractionWithTransparency",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useLightmapAsShadowmap",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useAlphaFromAlbedoTexture",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"forceAlphaTest",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"alphaCutOff",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useSpecularOverAlpha",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useRoughnessFromMetallicTextureGreen",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useMetallnessFromMetallicTextureBlue",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useAmbientInGrayScale",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"usePhysicalLightFalloff",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useRadianceOverAlpha",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useParallax",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useParallaxOcclusion",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"parallaxScaleBias",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsLightsDirty")],PBRMaterial.prototype,"disableLighting",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"forceIrradianceInFragment",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsLightsDirty")],PBRMaterial.prototype,"maxSimultaneousLights",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"invertNormalMapX",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"invertNormalMapY",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"twoSidedLighting",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"preMultiplyAlpha",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"useAlphaFresnel",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"environmentBRDFTexture",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMaterial.prototype,"forceNormalForward",void 0);return PBRMaterial}(BABYLON.PBRBaseMaterial);BABYLON.PBRMaterial=PBRMaterial})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PBRMetallicRoughnessMaterial=function(_super){__extends(PBRMetallicRoughnessMaterial,_super);function PBRMetallicRoughnessMaterial(name,scene){var _this=_super.call(this,name,scene)||this;_this._useRoughnessFromMetallicTextureAlpha=false;_this._useRoughnessFromMetallicTextureGreen=true;_this._useMetallnessFromMetallicTextureBlue=true;return _this}PBRMetallicRoughnessMaterial.prototype.getClassName=function(){return"PBRMetallicRoughnessMaterial"};PBRMetallicRoughnessMaterial.prototype.getActiveTextures=function(){var activeTextures=_super.prototype.getActiveTextures.call(this);if(this.baseTexture){activeTextures.push(this.baseTexture)}if(this.metallicRoughnessTexture){activeTextures.push(this.metallicRoughnessTexture)}return activeTextures};PBRMetallicRoughnessMaterial.prototype.hasTexture=function(texture){if(_super.prototype.hasTexture.call(this,texture)){return true}if(this.baseTexture===texture){return true}if(this.metallicRoughnessTexture===texture){return true}return false};PBRMetallicRoughnessMaterial.prototype.clone=function(name){var _this=this;var clone=BABYLON.SerializationHelper.Clone(function(){return new PBRMetallicRoughnessMaterial(name,_this.getScene())},this);clone.id=name;clone.name=name;return clone};PBRMetallicRoughnessMaterial.prototype.serialize=function(){var serializationObject=BABYLON.SerializationHelper.Serialize(this);serializationObject.customType="BABYLON.PBRMetallicRoughnessMaterial";return serializationObject};PBRMetallicRoughnessMaterial.Parse=function(source,scene,rootUrl){return BABYLON.SerializationHelper.Parse(function(){return new PBRMetallicRoughnessMaterial(source.name,scene)},source,scene,rootUrl)};__decorate([BABYLON.serializeAsColor3(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_albedoColor")],PBRMetallicRoughnessMaterial.prototype,"baseColor",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],PBRMetallicRoughnessMaterial.prototype,"baseTexture",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMetallicRoughnessMaterial.prototype,"metallic",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty")],PBRMetallicRoughnessMaterial.prototype,"roughness",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],PBRMetallicRoughnessMaterial.prototype,"metallicRoughnessTexture",void 0);return PBRMetallicRoughnessMaterial}(BABYLON.Internals.PBRBaseSimpleMaterial);BABYLON.PBRMetallicRoughnessMaterial=PBRMetallicRoughnessMaterial})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PBRSpecularGlossinessMaterial=function(_super){__extends(PBRSpecularGlossinessMaterial,_super);function PBRSpecularGlossinessMaterial(name,scene){var _this=_super.call(this,name,scene)||this;_this._useMicroSurfaceFromReflectivityMapAlpha=true;return _this}PBRSpecularGlossinessMaterial.prototype.getClassName=function(){return"PBRSpecularGlossinessMaterial"};PBRSpecularGlossinessMaterial.prototype.getActiveTextures=function(){var activeTextures=_super.prototype.getActiveTextures.call(this);if(this.diffuseTexture){activeTextures.push(this.diffuseTexture)}if(this.specularGlossinessTexture){activeTextures.push(this.specularGlossinessTexture)}return activeTextures};PBRSpecularGlossinessMaterial.prototype.hasTexture=function(texture){if(_super.prototype.hasTexture.call(this,texture)){return true}if(this.diffuseTexture===texture){return true}if(this.specularGlossinessTexture===texture){return true}return false};PBRSpecularGlossinessMaterial.prototype.clone=function(name){var _this=this;var clone=BABYLON.SerializationHelper.Clone(function(){return new PBRSpecularGlossinessMaterial(name,_this.getScene())},this);clone.id=name;clone.name=name;return clone};PBRSpecularGlossinessMaterial.prototype.serialize=function(){var serializationObject=BABYLON.SerializationHelper.Serialize(this);serializationObject.customType="BABYLON.PBRSpecularGlossinessMaterial";return serializationObject};PBRSpecularGlossinessMaterial.Parse=function(source,scene,rootUrl){return BABYLON.SerializationHelper.Parse(function(){return new PBRSpecularGlossinessMaterial(source.name,scene)},source,scene,rootUrl)};__decorate([BABYLON.serializeAsColor3("diffuse"),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_albedoColor")],PBRSpecularGlossinessMaterial.prototype,"diffuseColor",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],PBRSpecularGlossinessMaterial.prototype,"diffuseTexture",void 0);__decorate([BABYLON.serializeAsColor3("specular"),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],PBRSpecularGlossinessMaterial.prototype,"specularColor",void 0);__decorate([BABYLON.serialize(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_microSurface")],PBRSpecularGlossinessMaterial.prototype,"glossiness",void 0);__decorate([BABYLON.serializeAsTexture(),BABYLON.expandToProperty("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],PBRSpecularGlossinessMaterial.prototype,"specularGlossinessTexture",void 0);return PBRSpecularGlossinessMaterial}(BABYLON.Internals.PBRBaseSimpleMaterial);BABYLON.PBRSpecularGlossinessMaterial=PBRSpecularGlossinessMaterial})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){BABYLON.CameraInputTypes={};var CameraInputsManager=function(){function CameraInputsManager(camera){this.attached={};this.camera=camera;this.checkInputs=function(){}}CameraInputsManager.prototype.add=function(input){var type=input.getSimpleName();if(this.attached[type]){BABYLON.Tools.Warn("camera input of type "+type+" already exists on camera");return}this.attached[type]=input;input.camera=this.camera;if(input.checkInputs){this.checkInputs=this._addCheckInputs(input.checkInputs.bind(input))}if(this.attachedElement){input.attachControl(this.attachedElement)}};CameraInputsManager.prototype.remove=function(inputToRemove){for(var cam in this.attached){var input=this.attached[cam];if(input===inputToRemove){input.detachControl(this.attachedElement);input.camera=null;delete this.attached[cam];this.rebuildInputCheck()}}};CameraInputsManager.prototype.removeByType=function(inputType){for(var cam in this.attached){var input=this.attached[cam];if(input.getClassName()===inputType){input.detachControl(this.attachedElement);input.camera=null;delete this.attached[cam];this.rebuildInputCheck()}}};CameraInputsManager.prototype._addCheckInputs=function(fn){var current=this.checkInputs;return function(){current();fn()}};CameraInputsManager.prototype.attachInput=function(input){input.attachControl(this.attachedElement,this.noPreventDefault)};CameraInputsManager.prototype.attachElement=function(element,noPreventDefault){if(this.attachedElement){return}noPreventDefault=BABYLON.Camera.ForceAttachControlToAlwaysPreventDefault?false:noPreventDefault;this.attachedElement=element;this.noPreventDefault=noPreventDefault;for(var cam in this.attached){this.attached[cam].attachControl(element,noPreventDefault)}};CameraInputsManager.prototype.detachElement=function(element,disconnect){if(disconnect===void 0){disconnect=false}if(this.attachedElement!==element){return}for(var cam in this.attached){this.attached[cam].detachControl(element);if(disconnect){this.attached[cam].camera=null}}this.attachedElement=null};CameraInputsManager.prototype.rebuildInputCheck=function(){this.checkInputs=function(){};for(var cam in this.attached){var input=this.attached[cam];if(input.checkInputs){this.checkInputs=this._addCheckInputs(input.checkInputs.bind(input))}}};CameraInputsManager.prototype.clear=function(){if(this.attachedElement){this.detachElement(this.attachedElement,true)}this.attached={};this.attachedElement=null;this.checkInputs=function(){}};CameraInputsManager.prototype.serialize=function(serializedCamera){var inputs={};for(var cam in this.attached){var input=this.attached[cam];var res=BABYLON.SerializationHelper.Serialize(input);inputs[input.getClassName()]=res}serializedCamera.inputsmgr=inputs};CameraInputsManager.prototype.parse=function(parsedCamera){var parsedInputs=parsedCamera.inputsmgr;if(parsedInputs){this.clear();for(var n in parsedInputs){var construct=BABYLON.CameraInputTypes[n];if(construct){var parsedinput=parsedInputs[n];var input=BABYLON.SerializationHelper.Parse(function(){return new construct},parsedinput,null);this.add(input)}}}else{for(var n in this.attached){var construct=BABYLON.CameraInputTypes[this.attached[n].getClassName()];if(construct){var input=BABYLON.SerializationHelper.Parse(function(){return new construct},parsedCamera,null);this.remove(this.attached[n]);this.add(input)}}}};return CameraInputsManager}();BABYLON.CameraInputsManager=CameraInputsManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FreeCameraMouseInput=function(){function FreeCameraMouseInput(touchEnabled){if(touchEnabled===void 0){touchEnabled=true}this.touchEnabled=touchEnabled;this.buttons=[0,1,2];this.angularSensibility=2e3}FreeCameraMouseInput.prototype.attachControl=function(element,noPreventDefault){var _this=this;var engine=this.camera.getEngine();if(!this._pointerInput){this._pointerInput=function(p,s){var evt=p.event;if(engine.isInVRExclusivePointerMode){return}if(!_this.touchEnabled&&evt.pointerType==="touch"){return}if(p.type!==BABYLON.PointerEventTypes.POINTERMOVE&&_this.buttons.indexOf(evt.button)===-1){return}if(p.type===BABYLON.PointerEventTypes.POINTERDOWN){try{evt.srcElement.setPointerCapture(evt.pointerId)}catch(e){}_this.previousPosition={x:evt.clientX,y:evt.clientY};if(!noPreventDefault){evt.preventDefault();element.focus()}}else if(p.type===BABYLON.PointerEventTypes.POINTERUP){try{evt.srcElement.releasePointerCapture(evt.pointerId)}catch(e){}_this.previousPosition=null;if(!noPreventDefault){evt.preventDefault()}}else if(p.type===BABYLON.PointerEventTypes.POINTERMOVE){if(!_this.previousPosition||engine.isPointerLock){return}var offsetX=evt.clientX-_this.previousPosition.x;var offsetY=evt.clientY-_this.previousPosition.y;if(_this.camera.getScene().useRightHandedSystem){_this.camera.cameraRotation.y-=offsetX/_this.angularSensibility}else{_this.camera.cameraRotation.y+=offsetX/_this.angularSensibility}_this.camera.cameraRotation.x+=offsetY/_this.angularSensibility;_this.previousPosition={x:evt.clientX,y:evt.clientY};if(!noPreventDefault){evt.preventDefault()}}}}this._onMouseMove=function(evt){if(!engine.isPointerLock){return}if(engine.isInVRExclusivePointerMode){return}var offsetX=evt.movementX||evt.mozMovementX||evt.webkitMovementX||evt.msMovementX||0;var offsetY=evt.movementY||evt.mozMovementY||evt.webkitMovementY||evt.msMovementY||0;if(_this.camera.getScene().useRightHandedSystem){_this.camera.cameraRotation.y-=offsetX/_this.angularSensibility}else{_this.camera.cameraRotation.y+=offsetX/_this.angularSensibility}_this.camera.cameraRotation.x+=offsetY/_this.angularSensibility;_this.previousPosition=null;if(!noPreventDefault){evt.preventDefault()}};this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,BABYLON.PointerEventTypes.POINTERDOWN|BABYLON.PointerEventTypes.POINTERUP|BABYLON.PointerEventTypes.POINTERMOVE);element.addEventListener("mousemove",this._onMouseMove,false)};FreeCameraMouseInput.prototype.detachControl=function(element){if(this._observer&&element){this.camera.getScene().onPointerObservable.remove(this._observer);element.removeEventListener("mousemove",this._onMouseMove);this._observer=null;this._onMouseMove=null;this.previousPosition=null}};FreeCameraMouseInput.prototype.getClassName=function(){return"FreeCameraMouseInput"};FreeCameraMouseInput.prototype.getSimpleName=function(){return"mouse"};__decorate([BABYLON.serialize()],FreeCameraMouseInput.prototype,"buttons",void 0);__decorate([BABYLON.serialize()],FreeCameraMouseInput.prototype,"angularSensibility",void 0);return FreeCameraMouseInput}();BABYLON.FreeCameraMouseInput=FreeCameraMouseInput;BABYLON.CameraInputTypes["FreeCameraMouseInput"]=FreeCameraMouseInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FreeCameraKeyboardMoveInput=function(){function FreeCameraKeyboardMoveInput(){this._keys=new Array;this.keysUp=[38];this.keysDown=[40];this.keysLeft=[37];this.keysRight=[39]}FreeCameraKeyboardMoveInput.prototype.attachControl=function(element,noPreventDefault){var _this=this;if(this._onCanvasBlurObserver){return}this._scene=this.camera.getScene();this._engine=this._scene.getEngine();this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){_this._keys=[]});this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(info){var evt=info.event;if(info.type===BABYLON.KeyboardEventTypes.KEYDOWN){if(_this.keysUp.indexOf(evt.keyCode)!==-1||_this.keysDown.indexOf(evt.keyCode)!==-1||_this.keysLeft.indexOf(evt.keyCode)!==-1||_this.keysRight.indexOf(evt.keyCode)!==-1){var index=_this._keys.indexOf(evt.keyCode);if(index===-1){_this._keys.push(evt.keyCode)}if(!noPreventDefault){evt.preventDefault()}}}else{if(_this.keysUp.indexOf(evt.keyCode)!==-1||_this.keysDown.indexOf(evt.keyCode)!==-1||_this.keysLeft.indexOf(evt.keyCode)!==-1||_this.keysRight.indexOf(evt.keyCode)!==-1){var index=_this._keys.indexOf(evt.keyCode);if(index>=0){_this._keys.splice(index,1)}if(!noPreventDefault){evt.preventDefault()}}}})};FreeCameraKeyboardMoveInput.prototype.detachControl=function(element){if(this._scene){this._scene.onKeyboardObservable.remove(this._onKeyboardObserver);this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver);this._onKeyboardObserver=null;this._onCanvasBlurObserver=null}this._keys=[]};FreeCameraKeyboardMoveInput.prototype.checkInputs=function(){if(this._onKeyboardObserver){var camera=this.camera;for(var index=0;index<this._keys.length;index++){var keyCode=this._keys[index];var speed=camera._computeLocalCameraSpeed();if(this.keysLeft.indexOf(keyCode)!==-1){camera._localDirection.copyFromFloats(-speed,0,0)}else if(this.keysUp.indexOf(keyCode)!==-1){camera._localDirection.copyFromFloats(0,0,speed)}else if(this.keysRight.indexOf(keyCode)!==-1){camera._localDirection.copyFromFloats(speed,0,0)}else if(this.keysDown.indexOf(keyCode)!==-1){camera._localDirection.copyFromFloats(0,0,-speed)}if(camera.getScene().useRightHandedSystem){camera._localDirection.z*=-1}camera.getViewMatrix().invertToRef(camera._cameraTransformMatrix);BABYLON.Vector3.TransformNormalToRef(camera._localDirection,camera._cameraTransformMatrix,camera._transformedDirection);camera.cameraDirection.addInPlace(camera._transformedDirection)}}};FreeCameraKeyboardMoveInput.prototype.getClassName=function(){return"FreeCameraKeyboardMoveInput"};FreeCameraKeyboardMoveInput.prototype._onLostFocus=function(e){this._keys=[]};FreeCameraKeyboardMoveInput.prototype.getSimpleName=function(){return"keyboard"};__decorate([BABYLON.serialize()],FreeCameraKeyboardMoveInput.prototype,"keysUp",void 0);__decorate([BABYLON.serialize()],FreeCameraKeyboardMoveInput.prototype,"keysDown",void 0);__decorate([BABYLON.serialize()],FreeCameraKeyboardMoveInput.prototype,"keysLeft",void 0);__decorate([BABYLON.serialize()],FreeCameraKeyboardMoveInput.prototype,"keysRight",void 0);return FreeCameraKeyboardMoveInput}();BABYLON.FreeCameraKeyboardMoveInput=FreeCameraKeyboardMoveInput;BABYLON.CameraInputTypes["FreeCameraKeyboardMoveInput"]=FreeCameraKeyboardMoveInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FreeCameraInputsManager=function(_super){__extends(FreeCameraInputsManager,_super);function FreeCameraInputsManager(camera){return _super.call(this,camera)||this}FreeCameraInputsManager.prototype.addKeyboard=function(){this.add(new BABYLON.FreeCameraKeyboardMoveInput);return this};FreeCameraInputsManager.prototype.addMouse=function(touchEnabled){if(touchEnabled===void 0){touchEnabled=true}this.add(new BABYLON.FreeCameraMouseInput(touchEnabled));return this};FreeCameraInputsManager.prototype.addGamepad=function(){this.add(new BABYLON.FreeCameraGamepadInput);return this};FreeCameraInputsManager.prototype.addDeviceOrientation=function(){this.add(new BABYLON.FreeCameraDeviceOrientationInput);return this};FreeCameraInputsManager.prototype.addTouch=function(){this.add(new BABYLON.FreeCameraTouchInput);return this};FreeCameraInputsManager.prototype.addVirtualJoystick=function(){this.add(new BABYLON.FreeCameraVirtualJoystickInput);return this};return FreeCameraInputsManager}(BABYLON.CameraInputsManager);BABYLON.FreeCameraInputsManager=FreeCameraInputsManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var TargetCamera=function(_super){__extends(TargetCamera,_super);function TargetCamera(name,position,scene){var _this=_super.call(this,name,position,scene)||this;_this.cameraDirection=new BABYLON.Vector3(0,0,0);_this.cameraRotation=new BABYLON.Vector2(0,0);_this.rotation=new BABYLON.Vector3(0,0,0);_this.speed=2;_this.noRotationConstraint=false;_this.lockedTarget=null;_this._currentTarget=BABYLON.Vector3.Zero();_this._viewMatrix=BABYLON.Matrix.Zero();_this._camMatrix=BABYLON.Matrix.Zero();_this._cameraTransformMatrix=BABYLON.Matrix.Zero();_this._cameraRotationMatrix=BABYLON.Matrix.Zero();_this._referencePoint=new BABYLON.Vector3(0,0,1);_this._defaultUpVector=new BABYLON.Vector3(0,1,0);_this._transformedReferencePoint=BABYLON.Vector3.Zero();_this._lookAtTemp=BABYLON.Matrix.Zero();_this._tempMatrix=BABYLON.Matrix.Zero();return _this}TargetCamera.prototype.getFrontPosition=function(distance){var direction=this.getTarget().subtract(this.position);direction.normalize();direction.scaleInPlace(distance);return this.globalPosition.add(direction)};TargetCamera.prototype._getLockedTargetPosition=function(){if(!this.lockedTarget){return null}if(this.lockedTarget.absolutePosition){this.lockedTarget.computeWorldMatrix()}return this.lockedTarget.absolutePosition||this.lockedTarget};TargetCamera.prototype.storeState=function(){this._storedPosition=this.position.clone();this._storedRotation=this.rotation.clone();if(this.rotationQuaternion){this._storedRotationQuaternion=this.rotationQuaternion.clone()}return _super.prototype.storeState.call(this)};TargetCamera.prototype._restoreStateValues=function(){if(!_super.prototype._restoreStateValues.call(this)){return false}this.position=this._storedPosition.clone();this.rotation=this._storedRotation.clone();if(this.rotationQuaternion){this.rotationQuaternion=this._storedRotationQuaternion.clone()}this.cameraDirection.copyFromFloats(0,0,0);this.cameraRotation.copyFromFloats(0,0);return true};TargetCamera.prototype._initCache=function(){_super.prototype._initCache.call(this);this._cache.lockedTarget=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.rotation=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.rotationQuaternion=new BABYLON.Quaternion(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};TargetCamera.prototype._updateCache=function(ignoreParentClass){if(!ignoreParentClass){_super.prototype._updateCache.call(this)}var lockedTargetPosition=this._getLockedTargetPosition();if(!lockedTargetPosition){this._cache.lockedTarget=null}else{if(!this._cache.lockedTarget){this._cache.lockedTarget=lockedTargetPosition.clone()}else{this._cache.lockedTarget.copyFrom(lockedTargetPosition)}}this._cache.rotation.copyFrom(this.rotation);if(this.rotationQuaternion)this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)};TargetCamera.prototype._isSynchronizedViewMatrix=function(){if(!_super.prototype._isSynchronizedViewMatrix.call(this)){return false}var lockedTargetPosition=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(lockedTargetPosition):!lockedTargetPosition)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))};TargetCamera.prototype._computeLocalCameraSpeed=function(){var engine=this.getEngine();return this.speed*Math.sqrt(engine.getDeltaTime()/(engine.getFps()*100))};TargetCamera.prototype.setTarget=function(target){this.upVector.normalize();BABYLON.Matrix.LookAtLHToRef(this.position,target,this._defaultUpVector,this._camMatrix);this._camMatrix.invert();this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var vDir=target.subtract(this.position);if(vDir.x>=0){this.rotation.y=-Math.atan(vDir.z/vDir.x)+Math.PI/2}else{this.rotation.y=-Math.atan(vDir.z/vDir.x)-Math.PI/2}this.rotation.z=0;if(isNaN(this.rotation.x)){this.rotation.x=0}if(isNaN(this.rotation.y)){this.rotation.y=0}if(isNaN(this.rotation.z)){this.rotation.z=0}if(this.rotationQuaternion){BABYLON.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}};TargetCamera.prototype.getTarget=function(){return this._currentTarget};TargetCamera.prototype._decideIfNeedsToMove=function(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0};TargetCamera.prototype._updatePosition=function(){if(this.parent){this.parent.getWorldMatrix().invertToRef(BABYLON.Tmp.Matrix[0]);BABYLON.Vector3.TransformNormalToRef(this.cameraDirection,BABYLON.Tmp.Matrix[0],BABYLON.Tmp.Vector3[0]);this.position.addInPlace(BABYLON.Tmp.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)};TargetCamera.prototype._checkInputs=function(){var needToMove=this._decideIfNeedsToMove();var needToRotate=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(needToMove){this._updatePosition()}if(needToRotate){this.rotation.x+=this.cameraRotation.x;this.rotation.y+=this.cameraRotation.y;if(this.rotationQuaternion){var len=this.rotation.lengthSquared();if(len){BABYLON.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}}if(!this.noRotationConstraint){var limit=Math.PI/2*.95;if(this.rotation.x>limit)this.rotation.x=limit;if(this.rotation.x<-limit)this.rotation.x=-limit}}if(needToMove){if(Math.abs(this.cameraDirection.x)<this.speed*BABYLON.Epsilon){this.cameraDirection.x=0}if(Math.abs(this.cameraDirection.y)<this.speed*BABYLON.Epsilon){this.cameraDirection.y=0}if(Math.abs(this.cameraDirection.z)<this.speed*BABYLON.Epsilon){this.cameraDirection.z=0}this.cameraDirection.scaleInPlace(this.inertia)}if(needToRotate){if(Math.abs(this.cameraRotation.x)<this.speed*BABYLON.Epsilon){this.cameraRotation.x=0}if(Math.abs(this.cameraRotation.y)<this.speed*BABYLON.Epsilon){this.cameraRotation.y=0}this.cameraRotation.scaleInPlace(this.inertia)}_super.prototype._checkInputs.call(this)};TargetCamera.prototype._updateCameraRotationMatrix=function(){if(this.rotationQuaternion){this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix)}else{BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}BABYLON.Vector3.TransformNormalToRef(this._defaultUpVector,this._cameraRotationMatrix,this.upVector)};TargetCamera.prototype._getViewMatrix=function(){if(!this.lockedTarget){this._updateCameraRotationMatrix();BABYLON.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint);this.position.addToRef(this._transformedReferencePoint,this._currentTarget)}else{this._currentTarget.copyFrom(this._getLockedTargetPosition())}if(this.getScene().useRightHandedSystem){BABYLON.Matrix.LookAtRHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix)}else{BABYLON.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix)}return this._viewMatrix};TargetCamera.prototype.createRigCamera=function(name,cameraIndex){if(this.cameraRigMode!==BABYLON.Camera.RIG_MODE_NONE){var rigCamera=new TargetCamera(name,this.position.clone(),this.getScene());if(this.cameraRigMode===BABYLON.Camera.RIG_MODE_VR||this.cameraRigMode===BABYLON.Camera.RIG_MODE_WEBVR){if(!this.rotationQuaternion){this.rotationQuaternion=new BABYLON.Quaternion}rigCamera._cameraRigParams={};rigCamera.rotationQuaternion=new BABYLON.Quaternion}return rigCamera}return null};TargetCamera.prototype._updateRigCameras=function(){var camLeft=this._rigCameras[0];var camRight=this._rigCameras[1];switch(this.cameraRigMode){case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:var leftSign=this.cameraRigMode===BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1;var rightSign=this.cameraRigMode===BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*leftSign,camLeft.position);this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*rightSign,camRight.position);camLeft.setTarget(this.getTarget());camRight.setTarget(this.getTarget());break;case BABYLON.Camera.RIG_MODE_VR:if(camLeft.rotationQuaternion){camLeft.rotationQuaternion.copyFrom(this.rotationQuaternion);camRight.rotationQuaternion.copyFrom(this.rotationQuaternion)}else{camLeft.rotation.copyFrom(this.rotation);camRight.rotation.copyFrom(this.rotation)}camLeft.position.copyFrom(this.position);camRight.position.copyFrom(this.position);break}_super.prototype._updateRigCameras.call(this)};TargetCamera.prototype._getRigCamPosition=function(halfSpace,result){if(!this._rigCamTransformMatrix){this._rigCamTransformMatrix=new BABYLON.Matrix}var target=this.getTarget();BABYLON.Matrix.Translation(-target.x,-target.y,-target.z).multiplyToRef(BABYLON.Matrix.RotationY(halfSpace),this._rigCamTransformMatrix);this._rigCamTransformMatrix=this._rigCamTransformMatrix.multiply(BABYLON.Matrix.Translation(target.x,target.y,target.z));BABYLON.Vector3.TransformCoordinatesToRef(this.position,this._rigCamTransformMatrix,result)};TargetCamera.prototype.getClassName=function(){return"TargetCamera"};__decorate([BABYLON.serializeAsVector3()],TargetCamera.prototype,"rotation",void 0);__decorate([BABYLON.serialize()],TargetCamera.prototype,"speed",void 0);__decorate([BABYLON.serializeAsMeshReference("lockedTargetId")],TargetCamera.prototype,"lockedTarget",void 0);return TargetCamera}(BABYLON.Camera);BABYLON.TargetCamera=TargetCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FreeCamera=function(_super){__extends(FreeCamera,_super);function FreeCamera(name,position,scene){var _this=_super.call(this,name,position,scene)||this;_this.ellipsoid=new BABYLON.Vector3(.5,1,.5);_this.checkCollisions=false;_this.applyGravity=false;_this._needMoveForGravity=false;_this._oldPosition=BABYLON.Vector3.Zero();_this._diffPosition=BABYLON.Vector3.Zero();_this._newPosition=BABYLON.Vector3.Zero();_this._collisionMask=-1;_this._onCollisionPositionChange=function(collisionId,newPosition,collidedMesh){if(collidedMesh===void 0){collidedMesh=null}if(_this.getScene().workerCollisions)newPosition.multiplyInPlace(_this._collider.radius);var updatePosition=function(newPos){_this._newPosition.copyFrom(newPos);_this._newPosition.subtractToRef(_this._oldPosition,_this._diffPosition);if(_this._diffPosition.length()>BABYLON.Engine.CollisionsEpsilon){_this.position.addInPlace(_this._diffPosition);if(_this.onCollide&&collidedMesh){_this.onCollide(collidedMesh)}}};updatePosition(newPosition)};_this.inputs=new BABYLON.FreeCameraInputsManager(_this);_this.inputs.addKeyboard().addMouse();return _this}Object.defineProperty(FreeCamera.prototype,"angularSensibility",{get:function(){var mouse=this.inputs.attached["mouse"];if(mouse)return mouse.angularSensibility;return null},set:function(value){var mouse=this.inputs.attached["mouse"];if(mouse)mouse.angularSensibility=value},enumerable:true,configurable:true});Object.defineProperty(FreeCamera.prototype,"keysUp",{get:function(){var keyboard=this.inputs.attached["keyboard"];if(keyboard)return keyboard.keysUp;return null},set:function(value){var keyboard=this.inputs.attached["keyboard"];if(keyboard)keyboard.keysUp=value},enumerable:true,configurable:true});Object.defineProperty(FreeCamera.prototype,"keysDown",{get:function(){var keyboard=this.inputs.attached["keyboard"];if(keyboard)return keyboard.keysDown;return null},set:function(value){var keyboard=this.inputs.attached["keyboard"];if(keyboard)keyboard.keysDown=value},enumerable:true,configurable:true});Object.defineProperty(FreeCamera.prototype,"keysLeft",{get:function(){var keyboard=this.inputs.attached["keyboard"];if(keyboard)return keyboard.keysLeft;return null},set:function(value){var keyboard=this.inputs.attached["keyboard"];if(keyboard)keyboard.keysLeft=value},enumerable:true,configurable:true});Object.defineProperty(FreeCamera.prototype,"keysRight",{get:function(){var keyboard=this.inputs.attached["keyboard"];if(keyboard)return keyboard.keysRight;return null},set:function(value){var keyboard=this.inputs.attached["keyboard"];if(keyboard)keyboard.keysRight=value},enumerable:true,configurable:true});FreeCamera.prototype.attachControl=function(element,noPreventDefault){this.inputs.attachElement(element,noPreventDefault)};FreeCamera.prototype.detachControl=function(element){this.inputs.detachElement(element);this.cameraDirection=new BABYLON.Vector3(0,0,0);this.cameraRotation=new BABYLON.Vector2(0,0)};Object.defineProperty(FreeCamera.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(mask){this._collisionMask=!isNaN(mask)?mask:-1},enumerable:true,configurable:true});FreeCamera.prototype._collideWithWorld=function(displacement){var globalPosition;if(this.parent){globalPosition=BABYLON.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix())}else{globalPosition=this.position}globalPosition.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition);if(!this._collider){this._collider=new BABYLON.Collider}this._collider.radius=this.ellipsoid;this._collider.collisionMask=this._collisionMask;var actualDisplacement=displacement;if(this.applyGravity){actualDisplacement=displacement.add(this.getScene().gravity)}this.getScene().collisionCoordinator.getNewPosition(this._oldPosition,actualDisplacement,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)};FreeCamera.prototype._checkInputs=function(){if(!this._localDirection){this._localDirection=BABYLON.Vector3.Zero();this._transformedDirection=BABYLON.Vector3.Zero()}this.inputs.checkInputs();_super.prototype._checkInputs.call(this)};FreeCamera.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0};FreeCamera.prototype._updatePosition=function(){if(this.checkCollisions&&this.getScene().collisionsEnabled){this._collideWithWorld(this.cameraDirection)}else{_super.prototype._updatePosition.call(this)}};FreeCamera.prototype.dispose=function(){this.inputs.clear();_super.prototype.dispose.call(this)};FreeCamera.prototype.getClassName=function(){return"FreeCamera"};__decorate([BABYLON.serializeAsVector3()],FreeCamera.prototype,"ellipsoid",void 0);__decorate([BABYLON.serialize()],FreeCamera.prototype,"checkCollisions",void 0);__decorate([BABYLON.serialize()],FreeCamera.prototype,"applyGravity",void 0);return FreeCamera}(BABYLON.TargetCamera);BABYLON.FreeCamera=FreeCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ArcRotateCameraKeyboardMoveInput=function(){function ArcRotateCameraKeyboardMoveInput(){this._keys=new Array;this.keysUp=[38];this.keysDown=[40];this.keysLeft=[37];this.keysRight=[39];this.keysReset=[220];this.panningSensibility=50;this.zoomingSensibility=25;this.useAltToZoom=true}ArcRotateCameraKeyboardMoveInput.prototype.attachControl=function(element,noPreventDefault){var _this=this;if(this._onCanvasBlurObserver){return}this._scene=this.camera.getScene();this._engine=this._scene.getEngine();this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){_this._keys=[]});this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(info){var evt=info.event;if(info.type===BABYLON.KeyboardEventTypes.KEYDOWN){_this._ctrlPressed=evt.ctrlKey;_this._altPressed=evt.altKey;if(_this.keysUp.indexOf(evt.keyCode)!==-1||_this.keysDown.indexOf(evt.keyCode)!==-1||_this.keysLeft.indexOf(evt.keyCode)!==-1||_this.keysRight.indexOf(evt.keyCode)!==-1||_this.keysReset.indexOf(evt.keyCode)!==-1){var index=_this._keys.indexOf(evt.keyCode);if(index===-1){_this._keys.push(evt.keyCode)}if(evt.preventDefault){if(!noPreventDefault){evt.preventDefault()}}}}else{if(_this.keysUp.indexOf(evt.keyCode)!==-1||_this.keysDown.indexOf(evt.keyCode)!==-1||_this.keysLeft.indexOf(evt.keyCode)!==-1||_this.keysRight.indexOf(evt.keyCode)!==-1||_this.keysReset.indexOf(evt.keyCode)!==-1){var index=_this._keys.indexOf(evt.keyCode);if(index>=0){_this._keys.splice(index,1)}if(evt.preventDefault){if(!noPreventDefault){evt.preventDefault()}}}}})};ArcRotateCameraKeyboardMoveInput.prototype.detachControl=function(element){if(this._scene){this._scene.onKeyboardObservable.remove(this._onKeyboardObserver);this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver);this._onKeyboardObserver=null;this._onCanvasBlurObserver=null}this._keys=[]};ArcRotateCameraKeyboardMoveInput.prototype.checkInputs=function(){if(this._onKeyboardObserver){var camera=this.camera;for(var index=0;index<this._keys.length;index++){var keyCode=this._keys[index];if(this.keysLeft.indexOf(keyCode)!==-1){if(this._ctrlPressed&&this.camera._useCtrlForPanning){camera.inertialPanningX-=1/this.panningSensibility}else{camera.inertialAlphaOffset-=.01}}else if(this.keysUp.indexOf(keyCode)!==-1){if(this._ctrlPressed&&this.camera._useCtrlForPanning){camera.inertialPanningY+=1/this.panningSensibility}else if(this._altPressed&&this.useAltToZoom){camera.inertialRadiusOffset+=1/this.zoomingSensibility}else{camera.inertialBetaOffset-=.01}}else if(this.keysRight.indexOf(keyCode)!==-1){if(this._ctrlPressed&&this.camera._useCtrlForPanning){camera.inertialPanningX+=1/this.panningSensibility}else{camera.inertialAlphaOffset+=.01}}else if(this.keysDown.indexOf(keyCode)!==-1){if(this._ctrlPressed&&this.camera._useCtrlForPanning){camera.inertialPanningY-=1/this.panningSensibility}else if(this._altPressed&&this.useAltToZoom){camera.inertialRadiusOffset-=1/this.zoomingSensibility}else{camera.inertialBetaOffset+=.01}}else if(this.keysReset.indexOf(keyCode)!==-1){camera.restoreState()}}}};ArcRotateCameraKeyboardMoveInput.prototype.getClassName=function(){return"ArcRotateCameraKeyboardMoveInput"};ArcRotateCameraKeyboardMoveInput.prototype.getSimpleName=function(){return"keyboard"};__decorate([BABYLON.serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysUp",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysDown",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysLeft",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysRight",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysReset",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"panningSensibility",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"zoomingSensibility",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"useAltToZoom",void 0);return ArcRotateCameraKeyboardMoveInput}();BABYLON.ArcRotateCameraKeyboardMoveInput=ArcRotateCameraKeyboardMoveInput;BABYLON.CameraInputTypes["ArcRotateCameraKeyboardMoveInput"]=ArcRotateCameraKeyboardMoveInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ArcRotateCameraMouseWheelInput=function(){function ArcRotateCameraMouseWheelInput(){this.wheelPrecision=3;this.wheelDeltaPercentage=0}ArcRotateCameraMouseWheelInput.prototype.attachControl=function(element,noPreventDefault){var _this=this;this._wheel=function(p,s){if(p.type!==BABYLON.PointerEventTypes.POINTERWHEEL)return;var event=p.event;var delta=0;if(event.wheelDelta){delta=_this.wheelDeltaPercentage?event.wheelDelta*.01*_this.camera.radius*_this.wheelDeltaPercentage:event.wheelDelta/(_this.wheelPrecision*40)}else if(event.detail){delta=-event.detail/_this.wheelPrecision}if(delta)_this.camera.inertialRadiusOffset+=delta;if(event.preventDefault){if(!noPreventDefault){event.preventDefault()}}};this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,BABYLON.PointerEventTypes.POINTERWHEEL)};ArcRotateCameraMouseWheelInput.prototype.detachControl=function(element){if(this._observer&&element){this.camera.getScene().onPointerObservable.remove(this._observer);this._observer=null;this._wheel=null}};ArcRotateCameraMouseWheelInput.prototype.getClassName=function(){return"ArcRotateCameraMouseWheelInput"};ArcRotateCameraMouseWheelInput.prototype.getSimpleName=function(){return"mousewheel"};__decorate([BABYLON.serialize()],ArcRotateCameraMouseWheelInput.prototype,"wheelPrecision",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraMouseWheelInput.prototype,"wheelDeltaPercentage",void 0);return ArcRotateCameraMouseWheelInput}();BABYLON.ArcRotateCameraMouseWheelInput=ArcRotateCameraMouseWheelInput;BABYLON.CameraInputTypes["ArcRotateCameraMouseWheelInput"]=ArcRotateCameraMouseWheelInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ArcRotateCameraPointersInput=function(){function ArcRotateCameraPointersInput(){this.buttons=[0,1,2];this.angularSensibilityX=1e3;this.angularSensibilityY=1e3;this.pinchPrecision=12;this.pinchDeltaPercentage=0;this.panningSensibility=1e3;this.multiTouchPanning=true;this.multiTouchPanAndZoom=true;this._isPanClick=false;this.pinchInwards=true}ArcRotateCameraPointersInput.prototype.attachControl=function(element,noPreventDefault){var _this=this;var engine=this.camera.getEngine();var cacheSoloPointer;var pointA,pointB;var previousPinchSquaredDistance=0;var initialDistance=0;var twoFingerActivityCount=0;var previousMultiTouchPanPosition={x:0,y:0,isPaning:false,isPinching:false};this._pointerInput=function(p,s){var evt=p.event;if(engine.isInVRExclusivePointerMode){return}if(p.type!==BABYLON.PointerEventTypes.POINTERMOVE&&_this.buttons.indexOf(evt.button)===-1){return}if(p.type===BABYLON.PointerEventTypes.POINTERDOWN){try{evt.srcElement.setPointerCapture(evt.pointerId)}catch(e){}_this._isPanClick=evt.button===_this.camera._panningMouseButton;cacheSoloPointer={x:evt.clientX,y:evt.clientY,pointerId:evt.pointerId,type:evt.pointerType};if(pointA===undefined){pointA=cacheSoloPointer}else if(pointB===undefined){pointB=cacheSoloPointer}if(!noPreventDefault){evt.preventDefault();element.focus()}}else if(p.type===BABYLON.PointerEventTypes.POINTERDOUBLETAP){_this.camera.restoreState()}else if(p.type===BABYLON.PointerEventTypes.POINTERUP){try{evt.srcElement.releasePointerCapture(evt.pointerId)}catch(e){}cacheSoloPointer=null;previousPinchSquaredDistance=0;previousMultiTouchPanPosition.isPaning=false;previousMultiTouchPanPosition.isPinching=false;twoFingerActivityCount=0;initialDistance=0;if(p.event.pointerType!=="touch"){pointB=undefined}if(engine.badOS){pointA=pointB=undefined}else{if(pointB&&pointA&&pointA.pointerId==evt.pointerId){pointA=pointB;pointB=undefined;cacheSoloPointer={x:pointA.x,y:pointA.y,pointerId:pointA.pointerId,type:evt.pointerType}}else if(pointA&&pointB&&pointB.pointerId==evt.pointerId){pointB=undefined;cacheSoloPointer={x:pointA.x,y:pointA.y,pointerId:pointA.pointerId,type:evt.pointerType}}else{pointA=pointB=undefined}}if(!noPreventDefault){evt.preventDefault()}}else if(p.type===BABYLON.PointerEventTypes.POINTERMOVE){if(!noPreventDefault){evt.preventDefault()}if(pointA&&pointB===undefined){if(_this.panningSensibility!==0&&(evt.ctrlKey&&_this.camera._useCtrlForPanning||_this._isPanClick)){_this.camera.inertialPanningX+=-(evt.clientX-cacheSoloPointer.x)/_this.panningSensibility;_this.camera.inertialPanningY+=(evt.clientY-cacheSoloPointer.y)/_this.panningSensibility}else{var offsetX=evt.clientX-cacheSoloPointer.x;var offsetY=evt.clientY-cacheSoloPointer.y;_this.camera.inertialAlphaOffset-=offsetX/_this.angularSensibilityX;_this.camera.inertialBetaOffset-=offsetY/_this.angularSensibilityY}cacheSoloPointer.x=evt.clientX;cacheSoloPointer.y=evt.clientY}else if(pointA&&pointB){var ed=pointA.pointerId===evt.pointerId?pointA:pointB;ed.x=evt.clientX;ed.y=evt.clientY;var direction=_this.pinchInwards?1:-1;var distX=pointA.x-pointB.x;var distY=pointA.y-pointB.y;var pinchSquaredDistance=distX*distX+distY*distY;var pinchDistance=Math.sqrt(pinchSquaredDistance);if(previousPinchSquaredDistance===0){initialDistance=pinchDistance;previousPinchSquaredDistance=pinchSquaredDistance;previousMultiTouchPanPosition.x=(pointA.x+pointB.x)/2;previousMultiTouchPanPosition.y=(pointA.y+pointB.y)/2;return}if(_this.multiTouchPanAndZoom){if(_this.pinchDeltaPercentage){_this.camera.inertialRadiusOffset+=(pinchSquaredDistance-previousPinchSquaredDistance)*.001*_this.camera.radius*_this.pinchDeltaPercentage}else{_this.camera.inertialRadiusOffset+=(pinchSquaredDistance-previousPinchSquaredDistance)/(_this.pinchPrecision*((_this.angularSensibilityX+_this.angularSensibilityY)/2)*direction)}if(_this.panningSensibility!==0){var pointersCenterX=(pointA.x+pointB.x)/2;var pointersCenterY=(pointA.y+pointB.y)/2;var pointersCenterDistX=pointersCenterX-previousMultiTouchPanPosition.x;var pointersCenterDistY=pointersCenterY-previousMultiTouchPanPosition.y;previousMultiTouchPanPosition.x=pointersCenterX;previousMultiTouchPanPosition.y=pointersCenterY;_this.camera.inertialPanningX+=-pointersCenterDistX/_this.panningSensibility;_this.camera.inertialPanningY+=pointersCenterDistY/_this.panningSensibility}}else{twoFingerActivityCount++;if(previousMultiTouchPanPosition.isPinching||twoFingerActivityCount<20&&Math.abs(pinchDistance-initialDistance)>_this.camera.pinchToPanMaxDistance){if(_this.pinchDeltaPercentage){_this.camera.inertialRadiusOffset+=(pinchSquaredDistance-previousPinchSquaredDistance)*.001*_this.camera.radius*_this.pinchDeltaPercentage}else{_this.camera.inertialRadiusOffset+=(pinchSquaredDistance-previousPinchSquaredDistance)/(_this.pinchPrecision*((_this.angularSensibilityX+_this.angularSensibilityY)/2)*direction)}previousMultiTouchPanPosition.isPaning=false;previousMultiTouchPanPosition.isPinching=true}else{if(cacheSoloPointer.pointerId===ed.pointerId&&_this.panningSensibility!==0&&_this.multiTouchPanning){if(!previousMultiTouchPanPosition.isPaning){previousMultiTouchPanPosition.isPaning=true;previousMultiTouchPanPosition.isPinching=false;previousMultiTouchPanPosition.x=ed.x;previousMultiTouchPanPosition.y=ed.y;return}_this.camera.inertialPanningX+=-(ed.x-previousMultiTouchPanPosition.x)/_this.panningSensibility;_this.camera.inertialPanningY+=(ed.y-previousMultiTouchPanPosition.y)/_this.panningSensibility}}if(cacheSoloPointer.pointerId===evt.pointerId){previousMultiTouchPanPosition.x=ed.x;previousMultiTouchPanPosition.y=ed.y}}previousPinchSquaredDistance=pinchSquaredDistance}}};this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,BABYLON.PointerEventTypes.POINTERDOWN|BABYLON.PointerEventTypes.POINTERUP|BABYLON.PointerEventTypes.POINTERMOVE|BABYLON.PointerEventTypes._POINTERDOUBLETAP);this._onContextMenu=function(evt){evt.preventDefault()};if(!this.camera._useCtrlForPanning){element.addEventListener("contextmenu",this._onContextMenu,false)}this._onLostFocus=function(){pointA=pointB=undefined;previousPinchSquaredDistance=0;previousMultiTouchPanPosition.isPaning=false;previousMultiTouchPanPosition.isPinching=false;twoFingerActivityCount=0;cacheSoloPointer=null;initialDistance=0};this._onMouseMove=function(evt){if(!engine.isPointerLock){return}var offsetX=evt.movementX||evt.mozMovementX||evt.webkitMovementX||evt.msMovementX||0;var offsetY=evt.movementY||evt.mozMovementY||evt.webkitMovementY||evt.msMovementY||0;_this.camera.inertialAlphaOffset-=offsetX/_this.angularSensibilityX;_this.camera.inertialBetaOffset-=offsetY/_this.angularSensibilityY;if(!noPreventDefault){evt.preventDefault()}};this._onGestureStart=function(e){if(window.MSGesture===undefined){return}if(!_this._MSGestureHandler){_this._MSGestureHandler=new MSGesture;_this._MSGestureHandler.target=element}_this._MSGestureHandler.addPointer(e.pointerId)};this._onGesture=function(e){_this.camera.radius*=e.scale;if(e.preventDefault){if(!noPreventDefault){e.stopPropagation();e.preventDefault()}}};element.addEventListener("mousemove",this._onMouseMove,false);element.addEventListener("MSPointerDown",this._onGestureStart,false);element.addEventListener("MSGestureChange",this._onGesture,false);BABYLON.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])};ArcRotateCameraPointersInput.prototype.detachControl=function(element){BABYLON.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]);if(element&&this._observer){this.camera.getScene().onPointerObservable.remove(this._observer);this._observer=null;element.removeEventListener("contextmenu",this._onContextMenu);element.removeEventListener("mousemove",this._onMouseMove);element.removeEventListener("MSPointerDown",this._onGestureStart);element.removeEventListener("MSGestureChange",this._onGesture);this._isPanClick=false;this.pinchInwards=true;this._onMouseMove=null;this._onGestureStart=null;this._onGesture=null;this._MSGestureHandler=null;this._onLostFocus=null;this._onContextMenu=null}};ArcRotateCameraPointersInput.prototype.getClassName=function(){return"ArcRotateCameraPointersInput"};ArcRotateCameraPointersInput.prototype.getSimpleName=function(){return"pointers"};__decorate([BABYLON.serialize()],ArcRotateCameraPointersInput.prototype,"buttons",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraPointersInput.prototype,"angularSensibilityX",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraPointersInput.prototype,"angularSensibilityY",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraPointersInput.prototype,"pinchPrecision",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraPointersInput.prototype,"pinchDeltaPercentage",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraPointersInput.prototype,"panningSensibility",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraPointersInput.prototype,"multiTouchPanning",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraPointersInput.prototype,"multiTouchPanAndZoom",void 0);return ArcRotateCameraPointersInput}();BABYLON.ArcRotateCameraPointersInput=ArcRotateCameraPointersInput;BABYLON.CameraInputTypes["ArcRotateCameraPointersInput"]=ArcRotateCameraPointersInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ArcRotateCamera=function(_super){__extends(ArcRotateCamera,_super);function ArcRotateCamera(name,alpha,beta,radius,target,scene){var _this=_super.call(this,name,BABYLON.Vector3.Zero(),scene)||this;_this.inertialAlphaOffset=0;_this.inertialBetaOffset=0;_this.inertialRadiusOffset=0;_this.lowerAlphaLimit=null;_this.upperAlphaLimit=null;_this.lowerBetaLimit=.01;_this.upperBetaLimit=Math.PI;_this.lowerRadiusLimit=null;_this.upperRadiusLimit=null;_this.inertialPanningX=0;_this.inertialPanningY=0;_this.pinchToPanMaxDistance=20;_this.panningDistanceLimit=null;_this.panningOriginTarget=BABYLON.Vector3.Zero();_this.panningInertia=.9;_this.zoomOnFactor=1;_this.targetScreenOffset=BABYLON.Vector2.Zero();_this.allowUpsideDown=true;_this._viewMatrix=new BABYLON.Matrix;_this.panningAxis=new BABYLON.Vector3(1,1,0);_this.onMeshTargetChangedObservable=new BABYLON.Observable;_this.checkCollisions=false;_this.collisionRadius=new BABYLON.Vector3(.5,.5,.5);_this._previousPosition=BABYLON.Vector3.Zero();_this._collisionVelocity=BABYLON.Vector3.Zero();_this._newPosition=BABYLON.Vector3.Zero();_this._onCollisionPositionChange=function(collisionId,newPosition,collidedMesh){if(collidedMesh===void 0){collidedMesh=null}if(_this.getScene().workerCollisions&&_this.checkCollisions){newPosition.multiplyInPlace(_this._collider.radius)}if(!collidedMesh){_this._previousPosition.copyFrom(_this.position)}else{_this.setPosition(newPosition);if(_this.onCollide){_this.onCollide(collidedMesh)}}var cosa=Math.cos(_this.alpha);var sina=Math.sin(_this.alpha);var cosb=Math.cos(_this.beta);var sinb=Math.sin(_this.beta);if(sinb===0){sinb=1e-4}var target=_this._getTargetPosition();target.addToRef(new BABYLON.Vector3(_this.radius*cosa*sinb,_this.radius*cosb,_this.radius*sina*sinb),_this._newPosition);_this.position.copyFrom(_this._newPosition);var up=_this.upVector;if(_this.allowUpsideDown&&_this.beta<0){up=up.clone();up=up.negate()}BABYLON.Matrix.LookAtLHToRef(_this.position,target,up,_this._viewMatrix);_this._viewMatrix.m[12]+=_this.targetScreenOffset.x;_this._viewMatrix.m[13]+=_this.targetScreenOffset.y;_this._collisionTriggered=false};_this._target=BABYLON.Vector3.Zero();if(target){_this.setTarget(target)}_this.alpha=alpha;_this.beta=beta;_this.radius=radius;_this.getViewMatrix();_this.inputs=new BABYLON.ArcRotateCameraInputsManager(_this);_this.inputs.addKeyboard().addMouseWheel().addPointers();return _this}Object.defineProperty(ArcRotateCamera.prototype,"target",{get:function(){return this._target},set:function(value){this.setTarget(value)},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"angularSensibilityX",{get:function(){var pointers=this.inputs.attached["pointers"];if(pointers)return pointers.angularSensibilityX;return null},set:function(value){var pointers=this.inputs.attached["pointers"];if(pointers){pointers.angularSensibilityX=value}},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"angularSensibilityY",{get:function(){var pointers=this.inputs.attached["pointers"];if(pointers)return pointers.angularSensibilityY;return null},set:function(value){var pointers=this.inputs.attached["pointers"];if(pointers){pointers.angularSensibilityY=value}},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"pinchPrecision",{get:function(){var pointers=this.inputs.attached["pointers"];if(pointers)return pointers.pinchPrecision;return null},set:function(value){var pointers=this.inputs.attached["pointers"];if(pointers){pointers.pinchPrecision=value}},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"pinchDeltaPercentage",{get:function(){var pointers=this.inputs.attached["pointers"];if(pointers)return pointers.pinchDeltaPercentage;return null},set:function(value){var pointers=this.inputs.attached["pointers"];if(pointers){pointers.pinchDeltaPercentage=value}},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"panningSensibility",{get:function(){var pointers=this.inputs.attached["pointers"];if(pointers)return pointers.panningSensibility;return null},set:function(value){var pointers=this.inputs.attached["pointers"];if(pointers){pointers.panningSensibility=value}},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"keysUp",{get:function(){var keyboard=this.inputs.attached["keyboard"];if(keyboard)return keyboard.keysUp;return null},set:function(value){var keyboard=this.inputs.attached["keyboard"];if(keyboard)keyboard.keysUp=value},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"keysDown",{get:function(){var keyboard=this.inputs.attached["keyboard"];if(keyboard)return keyboard.keysDown;return null},set:function(value){var keyboard=this.inputs.attached["keyboard"];if(keyboard)keyboard.keysDown=value},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"keysLeft",{get:function(){var keyboard=this.inputs.attached["keyboard"];if(keyboard)return keyboard.keysLeft;return null},set:function(value){var keyboard=this.inputs.attached["keyboard"];if(keyboard)keyboard.keysLeft=value},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"keysRight",{get:function(){var keyboard=this.inputs.attached["keyboard"];if(keyboard)return keyboard.keysRight;return null},set:function(value){var keyboard=this.inputs.attached["keyboard"];if(keyboard)keyboard.keysRight=value},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"wheelPrecision",{get:function(){var mousewheel=this.inputs.attached["mousewheel"];if(mousewheel)return mousewheel.wheelPrecision;return null},set:function(value){var mousewheel=this.inputs.attached["mousewheel"];if(mousewheel)mousewheel.wheelPrecision=value},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"wheelDeltaPercentage",{get:function(){var mousewheel=this.inputs.attached["mousewheel"];if(mousewheel)return mousewheel.wheelDeltaPercentage;return null},set:function(value){var mousewheel=this.inputs.attached["mousewheel"];if(mousewheel)mousewheel.wheelDeltaPercentage=value},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"bouncingBehavior",{get:function(){return this._bouncingBehavior},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"useBouncingBehavior",{get:function(){return this._bouncingBehavior!=null},set:function(value){if(value===this.useBouncingBehavior){return}if(value){this._bouncingBehavior=new BABYLON.BouncingBehavior;this.addBehavior(this._bouncingBehavior)}else{this.removeBehavior(this._bouncingBehavior);this._bouncingBehavior=null}},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"framingBehavior",{get:function(){return this._framingBehavior},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"useFramingBehavior",{get:function(){return this._framingBehavior!=null},set:function(value){if(value===this.useFramingBehavior){return}if(value){this._framingBehavior=new BABYLON.FramingBehavior;this.addBehavior(this._framingBehavior)}else{this.removeBehavior(this._framingBehavior);this._framingBehavior=null}},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"autoRotationBehavior",{get:function(){return this._autoRotationBehavior},enumerable:true,configurable:true});Object.defineProperty(ArcRotateCamera.prototype,"useAutoRotationBehavior",{get:function(){return this._autoRotationBehavior!=null},set:function(value){if(value===this.useAutoRotationBehavior){return}if(value){this._autoRotationBehavior=new BABYLON.AutoRotationBehavior;this.addBehavior(this._autoRotationBehavior)}else{this.removeBehavior(this._autoRotationBehavior);this._autoRotationBehavior=null}},enumerable:true,configurable:true});ArcRotateCamera.prototype._initCache=function(){_super.prototype._initCache.call(this);this._cache._target=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.alpha=undefined;this._cache.beta=undefined;this._cache.radius=undefined;this._cache.targetScreenOffset=BABYLON.Vector2.Zero()};ArcRotateCamera.prototype._updateCache=function(ignoreParentClass){if(!ignoreParentClass){_super.prototype._updateCache.call(this)}this._cache._target.copyFrom(this._getTargetPosition());this._cache.alpha=this.alpha;this._cache.beta=this.beta;this._cache.radius=this.radius;this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)};ArcRotateCamera.prototype._getTargetPosition=function(){if(this._targetHost&&this._targetHost.getAbsolutePosition){var pos=this._targetHost.getAbsolutePosition();if(this._targetBoundingCenter){pos.addToRef(this._targetBoundingCenter,this._target)}else{this._target.copyFrom(pos)}}var lockedTargetPosition=this._getLockedTargetPosition();if(lockedTargetPosition){return lockedTargetPosition}return this._target};ArcRotateCamera.prototype.storeState=function(){this._storedAlpha=this.alpha;this._storedBeta=this.beta;this._storedRadius=this.radius;this._storedTarget=this._getTargetPosition().clone();return _super.prototype.storeState.call(this)};ArcRotateCamera.prototype._restoreStateValues=function(){if(!_super.prototype._restoreStateValues.call(this)){return false}this.alpha=this._storedAlpha;this.beta=this._storedBeta;this.radius=this._storedRadius;this.setTarget(this._storedTarget.clone());this.inertialAlphaOffset=0;this.inertialBetaOffset=0;this.inertialRadiusOffset=0;this.inertialPanningX=0;this.inertialPanningY=0;return true};ArcRotateCamera.prototype._isSynchronizedViewMatrix=function(){if(!_super.prototype._isSynchronizedViewMatrix.call(this))return false;return this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)};ArcRotateCamera.prototype.attachControl=function(element,noPreventDefault,useCtrlForPanning,panningMouseButton){var _this=this;if(useCtrlForPanning===void 0){useCtrlForPanning=true}if(panningMouseButton===void 0){panningMouseButton=2}this._useCtrlForPanning=useCtrlForPanning;this._panningMouseButton=panningMouseButton;this.inputs.attachElement(element,noPreventDefault);this._reset=function(){_this.inertialAlphaOffset=0;_this.inertialBetaOffset=0;_this.inertialRadiusOffset=0;_this.inertialPanningX=0;_this.inertialPanningY=0}};ArcRotateCamera.prototype.detachControl=function(element){this.inputs.detachElement(element);if(this._reset){this._reset()}};ArcRotateCamera.prototype._checkInputs=function(){if(this._collisionTriggered){return}this.inputs.checkInputs();if(this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){if(this.getScene().useRightHandedSystem){this.alpha-=this.beta<=0?-this.inertialAlphaOffset:this.inertialAlphaOffset}else{this.alpha+=this.beta<=0?-this.inertialAlphaOffset:this.inertialAlphaOffset}this.beta+=this.inertialBetaOffset;this.radius-=this.inertialRadiusOffset;this.inertialAlphaOffset*=this.inertia;this.inertialBetaOffset*=this.inertia;this.inertialRadiusOffset*=this.inertia;if(Math.abs(this.inertialAlphaOffset)<BABYLON.Epsilon)this.inertialAlphaOffset=0;if(Math.abs(this.inertialBetaOffset)<BABYLON.Epsilon)this.inertialBetaOffset=0;if(Math.abs(this.inertialRadiusOffset)<this.speed*BABYLON.Epsilon)this.inertialRadiusOffset=0}if(this.inertialPanningX!==0||this.inertialPanningY!==0){if(!this._localDirection){this._localDirection=BABYLON.Vector3.Zero();this._transformedDirection=BABYLON.Vector3.Zero()}this._localDirection.copyFromFloats(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);this._localDirection.multiplyInPlace(this.panningAxis);this._viewMatrix.invertToRef(this._cameraTransformMatrix);BABYLON.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection);if(!this.panningAxis.y){this._transformedDirection.y=0}if(!this._targetHost){if(this.panningDistanceLimit){this._transformedDirection.addInPlace(this._target);var distanceSquared=BABYLON.Vector3.DistanceSquared(this._transformedDirection,this.panningOriginTarget);if(distanceSquared<=this.panningDistanceLimit*this.panningDistanceLimit){this._target.copyFrom(this._transformedDirection)}}else{this._target.addInPlace(this._transformedDirection)}}this.inertialPanningX*=this.panningInertia;this.inertialPanningY*=this.panningInertia;if(Math.abs(this.inertialPanningX)<this.speed*BABYLON.Epsilon)this.inertialPanningX=0;if(Math.abs(this.inertialPanningY)<this.speed*BABYLON.Epsilon)this.inertialPanningY=0}this._checkLimits();_super.prototype._checkInputs.call(this)};ArcRotateCamera.prototype._checkLimits=function(){if(this.lowerBetaLimit===null||this.lowerBetaLimit===undefined){if(this.allowUpsideDown&&this.beta>Math.PI){this.beta=this.beta-2*Math.PI}}else{if(this.beta<this.lowerBetaLimit){this.beta=this.lowerBetaLimit}}if(this.upperBetaLimit===null||this.upperBetaLimit===undefined){if(this.allowUpsideDown&&this.beta<-Math.PI){this.beta=this.beta+2*Math.PI}}else{if(this.beta>this.upperBetaLimit){this.beta=this.upperBetaLimit}}if(this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit){this.alpha=this.lowerAlphaLimit}if(this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit){this.alpha=this.upperAlphaLimit}if(this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit){this.radius=this.lowerRadiusLimit}if(this.upperRadiusLimit&&this.radius>this.upperRadiusLimit){this.radius=this.upperRadiusLimit}};ArcRotateCamera.prototype.rebuildAnglesAndRadius=function(){var radiusv3=this.position.subtract(this._getTargetPosition());this.radius=radiusv3.length();if(this.radius===0){this.radius=1e-4}this.alpha=Math.acos(radiusv3.x/Math.sqrt(Math.pow(radiusv3.x,2)+Math.pow(radiusv3.z,2)));if(radiusv3.z<0){this.alpha=2*Math.PI-this.alpha}this.beta=Math.acos(radiusv3.y/this.radius);this._checkLimits()};ArcRotateCamera.prototype.setPosition=function(position){if(this.position.equals(position)){return}this.position.copyFrom(position);this.rebuildAnglesAndRadius()};ArcRotateCamera.prototype.setTarget=function(target,toBoundingCenter,allowSamePosition){if(toBoundingCenter===void 0){toBoundingCenter=false}if(allowSamePosition===void 0){allowSamePosition=false}if(target.getBoundingInfo){if(toBoundingCenter){this._targetBoundingCenter=target.getBoundingInfo().boundingBox.centerWorld.clone()}else{this._targetBoundingCenter=null}this._targetHost=target;this._target=this._getTargetPosition();this.onMeshTargetChangedObservable.notifyObservers(this._targetHost)}else{var newTarget=target;var currentTarget=this._getTargetPosition();if(currentTarget&&!allowSamePosition&&currentTarget.equals(newTarget)){return}this._targetHost=null;this._target=newTarget;this._targetBoundingCenter=null;this.onMeshTargetChangedObservable.notifyObservers(null)}this.rebuildAnglesAndRadius()};ArcRotateCamera.prototype._getViewMatrix=function(){var cosa=Math.cos(this.alpha);var sina=Math.sin(this.alpha);var cosb=Math.cos(this.beta);var sinb=Math.sin(this.beta);if(sinb===0){sinb=1e-4}var target=this._getTargetPosition();target.addToRef(new BABYLON.Vector3(this.radius*cosa*sinb,this.radius*cosb,this.radius*sina*sinb),this._newPosition);if(this.getScene().collisionsEnabled&&this.checkCollisions){if(!this._collider){this._collider=new BABYLON.Collider}this._collider.radius=this.collisionRadius;this._newPosition.subtractToRef(this.position,this._collisionVelocity);this._collisionTriggered=true;this.getScene().collisionCoordinator.getNewPosition(this.position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this.position.copyFrom(this._newPosition);var up=this.upVector;if(this.allowUpsideDown&&sinb<0){up=up.clone();up=up.negate()}if(this.getScene().useRightHandedSystem){BABYLON.Matrix.LookAtRHToRef(this.position,target,up,this._viewMatrix)}else{BABYLON.Matrix.LookAtLHToRef(this.position,target,up,this._viewMatrix)}this._viewMatrix.m[12]+=this.targetScreenOffset.x;this._viewMatrix.m[13]+=this.targetScreenOffset.y}this._currentTarget=target;return this._viewMatrix};ArcRotateCamera.prototype.zoomOn=function(meshes,doNotUpdateMaxZ){if(doNotUpdateMaxZ===void 0){doNotUpdateMaxZ=false}meshes=meshes||this.getScene().meshes;var minMaxVector=BABYLON.Mesh.MinMax(meshes);var distance=BABYLON.Vector3.Distance(minMaxVector.min,minMaxVector.max);this.radius=distance*this.zoomOnFactor;this.focusOn({min:minMaxVector.min,max:minMaxVector.max,distance:distance},doNotUpdateMaxZ)};ArcRotateCamera.prototype.focusOn=function(meshesOrMinMaxVectorAndDistance,doNotUpdateMaxZ){if(doNotUpdateMaxZ===void 0){doNotUpdateMaxZ=false}var meshesOrMinMaxVector;var distance;if(meshesOrMinMaxVectorAndDistance.min===undefined){var meshes=meshesOrMinMaxVectorAndDistance||this.getScene().meshes;meshesOrMinMaxVector=BABYLON.Mesh.MinMax(meshes);distance=BABYLON.Vector3.Distance(meshesOrMinMaxVector.min,meshesOrMinMaxVector.max)}else{var minMaxVectorAndDistance=meshesOrMinMaxVectorAndDistance;meshesOrMinMaxVector=minMaxVectorAndDistance;distance=minMaxVectorAndDistance.distance}this._target=BABYLON.Mesh.Center(meshesOrMinMaxVector);if(!doNotUpdateMaxZ){this.maxZ=distance*2}};ArcRotateCamera.prototype.createRigCamera=function(name,cameraIndex){var alphaShift;switch(this.cameraRigMode){case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case BABYLON.Camera.RIG_MODE_VR:alphaShift=this._cameraRigParams.stereoHalfAngle*(cameraIndex===0?1:-1);break;case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:alphaShift=this._cameraRigParams.stereoHalfAngle*(cameraIndex===0?-1:1);break}var rigCam=new ArcRotateCamera(name,this.alpha+alphaShift,this.beta,this.radius,this._target,this.getScene());rigCam._cameraRigParams={};return rigCam};ArcRotateCamera.prototype._updateRigCameras=function(){var camLeft=this._rigCameras[0];var camRight=this._rigCameras[1];camLeft.beta=camRight.beta=this.beta;camLeft.radius=camRight.radius=this.radius;switch(this.cameraRigMode){case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case BABYLON.Camera.RIG_MODE_VR:camLeft.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;camRight.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:camLeft.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;camRight.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}_super.prototype._updateRigCameras.call(this)};ArcRotateCamera.prototype.dispose=function(){this.inputs.clear();_super.prototype.dispose.call(this)};ArcRotateCamera.prototype.getClassName=function(){return"ArcRotateCamera"};__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"alpha",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"beta",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"radius",void 0);__decorate([BABYLON.serializeAsVector3("target")],ArcRotateCamera.prototype,"_target",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"inertialAlphaOffset",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"inertialBetaOffset",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"inertialRadiusOffset",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"lowerAlphaLimit",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"upperAlphaLimit",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"lowerBetaLimit",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"upperBetaLimit",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"lowerRadiusLimit",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"upperRadiusLimit",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"inertialPanningX",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"inertialPanningY",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"pinchToPanMaxDistance",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"panningDistanceLimit",void 0);__decorate([BABYLON.serializeAsVector3()],ArcRotateCamera.prototype,"panningOriginTarget",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"panningInertia",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"zoomOnFactor",void 0);__decorate([BABYLON.serialize()],ArcRotateCamera.prototype,"allowUpsideDown",void 0);return ArcRotateCamera}(BABYLON.TargetCamera);BABYLON.ArcRotateCamera=ArcRotateCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ArcRotateCameraInputsManager=function(_super){__extends(ArcRotateCameraInputsManager,_super);function ArcRotateCameraInputsManager(camera){return _super.call(this,camera)||this}ArcRotateCameraInputsManager.prototype.addMouseWheel=function(){this.add(new BABYLON.ArcRotateCameraMouseWheelInput);return this};ArcRotateCameraInputsManager.prototype.addPointers=function(){this.add(new BABYLON.ArcRotateCameraPointersInput);return this};ArcRotateCameraInputsManager.prototype.addKeyboard=function(){this.add(new BABYLON.ArcRotateCameraKeyboardMoveInput);return this};ArcRotateCameraInputsManager.prototype.addGamepad=function(){this.add(new BABYLON.ArcRotateCameraGamepadInput);return this};ArcRotateCameraInputsManager.prototype.addVRDeviceOrientation=function(){this.add(new BABYLON.ArcRotateCameraVRDeviceOrientationInput);return this};return ArcRotateCameraInputsManager}(BABYLON.CameraInputsManager);BABYLON.ArcRotateCameraInputsManager=ArcRotateCameraInputsManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var HemisphericLight=function(_super){__extends(HemisphericLight,_super);function HemisphericLight(name,direction,scene){var _this=_super.call(this,name,scene)||this;_this.groundColor=new BABYLON.Color3(0,0,0);_this.direction=direction||BABYLON.Vector3.Up();return _this}HemisphericLight.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",3);this._uniformBuffer.addUniform("vLightGround",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};HemisphericLight.prototype.getClassName=function(){return"HemisphericLight"};HemisphericLight.prototype.setDirectionToTarget=function(target){this.direction=BABYLON.Vector3.Normalize(target.subtract(BABYLON.Vector3.Zero()));return this.direction};HemisphericLight.prototype.getShadowGenerator=function(){return null};HemisphericLight.prototype.transferToEffect=function(effect,lightIndex){var normalizeDirection=BABYLON.Vector3.Normalize(this.direction);this._uniformBuffer.updateFloat4("vLightData",normalizeDirection.x,normalizeDirection.y,normalizeDirection.z,0,lightIndex);this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),lightIndex);return this};HemisphericLight.prototype._getWorldMatrix=function(){if(!this._worldMatrix){this._worldMatrix=BABYLON.Matrix.Identity()}return this._worldMatrix};HemisphericLight.prototype.getTypeID=function(){return BABYLON.Light.LIGHTTYPEID_HEMISPHERICLIGHT};__decorate([BABYLON.serializeAsColor3()],HemisphericLight.prototype,"groundColor",void 0);__decorate([BABYLON.serializeAsVector3()],HemisphericLight.prototype,"direction",void 0);return HemisphericLight}(BABYLON.Light);BABYLON.HemisphericLight=HemisphericLight})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ShadowLight=function(_super){__extends(ShadowLight,_super);function ShadowLight(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this._needProjectionMatrixCompute=true;return _this}Object.defineProperty(ShadowLight.prototype,"direction",{get:function(){return this._direction},set:function(value){this._direction=value},enumerable:true,configurable:true});Object.defineProperty(ShadowLight.prototype,"shadowMinZ",{get:function(){return this._shadowMinZ},set:function(value){this._shadowMinZ=value;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(ShadowLight.prototype,"shadowMaxZ",{get:function(){return this._shadowMaxZ},set:function(value){this._shadowMaxZ=value;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});ShadowLight.prototype.computeTransformedInformation=function(){if(this.parent&&this.parent.getWorldMatrix){if(!this.transformedPosition){this.transformedPosition=BABYLON.Vector3.Zero()}BABYLON.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition);if(this.direction){if(!this.transformedDirection){this.transformedDirection=BABYLON.Vector3.Zero()}BABYLON.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)}return true}return false};ShadowLight.prototype.getDepthScale=function(){return 50};ShadowLight.prototype.getShadowDirection=function(faceIndex){return this.transformedDirection?this.transformedDirection:this.direction};ShadowLight.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position};ShadowLight.prototype.setDirectionToTarget=function(target){this.direction=BABYLON.Vector3.Normalize(target.subtract(this.position));return this.direction};ShadowLight.prototype.getRotation=function(){this.direction.normalize();var xaxis=BABYLON.Vector3.Cross(this.direction,BABYLON.Axis.Y);var yaxis=BABYLON.Vector3.Cross(xaxis,this.direction);return BABYLON.Vector3.RotationFromAxis(xaxis,yaxis,this.direction)};ShadowLight.prototype.needCube=function(){return false};ShadowLight.prototype.needProjectionMatrixCompute=function(){return this._needProjectionMatrixCompute};ShadowLight.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=true};ShadowLight.prototype._getWorldMatrix=function(){if(!this._worldMatrix){this._worldMatrix=BABYLON.Matrix.Identity()}BABYLON.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix);return this._worldMatrix};ShadowLight.prototype.getDepthMinZ=function(activeCamera){return this.shadowMinZ!==undefined?this.shadowMinZ:activeCamera.minZ};ShadowLight.prototype.getDepthMaxZ=function(activeCamera){return this.shadowMaxZ!==undefined?this.shadowMaxZ:activeCamera.maxZ};ShadowLight.prototype.setShadowProjectionMatrix=function(matrix,viewMatrix,renderList){if(this.customProjectionMatrixBuilder){this.customProjectionMatrixBuilder(viewMatrix,renderList,matrix)}else{this._setDefaultShadowProjectionMatrix(matrix,viewMatrix,renderList)}return this};__decorate([BABYLON.serializeAsVector3()],ShadowLight.prototype,"position",void 0);__decorate([BABYLON.serializeAsVector3()],ShadowLight.prototype,"direction",null);__decorate([BABYLON.serialize()],ShadowLight.prototype,"shadowMinZ",null);__decorate([BABYLON.serialize()],ShadowLight.prototype,"shadowMaxZ",null);return ShadowLight}(BABYLON.Light);BABYLON.ShadowLight=ShadowLight})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PointLight=function(_super){__extends(PointLight,_super);function PointLight(name,position,scene){var _this=_super.call(this,name,scene)||this;_this._shadowAngle=Math.PI/2;_this.position=position;return _this}Object.defineProperty(PointLight.prototype,"shadowAngle",{get:function(){return this._shadowAngle},set:function(value){this._shadowAngle=value;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(PointLight.prototype,"direction",{get:function(){return this._direction},set:function(value){var previousNeedCube=this.needCube();this._direction=value;if(this.needCube()!==previousNeedCube&&this._shadowGenerator){this._shadowGenerator.recreateShadowMap()}},enumerable:true,configurable:true});PointLight.prototype.getClassName=function(){return"PointLight"};PointLight.prototype.getTypeID=function(){return BABYLON.Light.LIGHTTYPEID_POINTLIGHT};PointLight.prototype.needCube=function(){return!this.direction};PointLight.prototype.getShadowDirection=function(faceIndex){if(this.direction){return _super.prototype.getShadowDirection.call(this,faceIndex)}else{switch(faceIndex){case 0:return new BABYLON.Vector3(1,0,0);case 1:return new BABYLON.Vector3(-1,0,0);case 2:return new BABYLON.Vector3(0,-1,0);case 3:return new BABYLON.Vector3(0,1,0);case 4:return new BABYLON.Vector3(0,0,1);case 5:return new BABYLON.Vector3(0,0,-1)}}return BABYLON.Vector3.Zero()};PointLight.prototype._setDefaultShadowProjectionMatrix=function(matrix,viewMatrix,renderList){var activeCamera=this.getScene().activeCamera;BABYLON.Matrix.PerspectiveFovLHToRef(this.shadowAngle,1,this.getDepthMinZ(activeCamera),this.getDepthMaxZ(activeCamera),matrix)};PointLight.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};PointLight.prototype.transferToEffect=function(effect,lightIndex){if(this.computeTransformedInformation()){this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,lightIndex);return this}this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,lightIndex);return this};__decorate([BABYLON.serialize()],PointLight.prototype,"shadowAngle",null);return PointLight}(BABYLON.ShadowLight);BABYLON.PointLight=PointLight})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DirectionalLight=function(_super){__extends(DirectionalLight,_super);function DirectionalLight(name,direction,scene){var _this=_super.call(this,name,scene)||this;_this._shadowFrustumSize=0;_this._shadowOrthoScale=.5;_this.autoUpdateExtends=true;_this._orthoLeft=Number.MAX_VALUE;_this._orthoRight=Number.MIN_VALUE;_this._orthoTop=Number.MIN_VALUE;_this._orthoBottom=Number.MAX_VALUE;_this.position=direction.scale(-1);_this.direction=direction;return _this}Object.defineProperty(DirectionalLight.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(value){this._shadowFrustumSize=value;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(DirectionalLight.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(value){this._shadowOrthoScale=value;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});DirectionalLight.prototype.getClassName=function(){return"DirectionalLight"};DirectionalLight.prototype.getTypeID=function(){return BABYLON.Light.LIGHTTYPEID_DIRECTIONALLIGHT};DirectionalLight.prototype._setDefaultShadowProjectionMatrix=function(matrix,viewMatrix,renderList){if(this.shadowFrustumSize>0){this._setDefaultFixedFrustumShadowProjectionMatrix(matrix,viewMatrix)}else{this._setDefaultAutoExtendShadowProjectionMatrix(matrix,viewMatrix,renderList)}};DirectionalLight.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(matrix,viewMatrix){var activeCamera=this.getScene().activeCamera;BABYLON.Matrix.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==undefined?this.shadowMinZ:activeCamera.minZ,this.shadowMaxZ!==undefined?this.shadowMaxZ:activeCamera.maxZ,matrix)};DirectionalLight.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(matrix,viewMatrix,renderList){var activeCamera=this.getScene().activeCamera;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var tempVector3=BABYLON.Vector3.Zero();this._orthoLeft=Number.MAX_VALUE;this._orthoRight=Number.MIN_VALUE;this._orthoTop=Number.MIN_VALUE;this._orthoBottom=Number.MAX_VALUE;for(var meshIndex=0;meshIndex<renderList.length;meshIndex++){var mesh=renderList[meshIndex];if(!mesh){continue}var boundingInfo=mesh.getBoundingInfo();if(!boundingInfo){continue}var boundingBox=boundingInfo.boundingBox;for(var index=0;index<boundingBox.vectorsWorld.length;index++){BABYLON.Vector3.TransformCoordinatesToRef(boundingBox.vectorsWorld[index],viewMatrix,tempVector3);if(tempVector3.x<this._orthoLeft)this._orthoLeft=tempVector3.x;if(tempVector3.y<this._orthoBottom)this._orthoBottom=tempVector3.y;if(tempVector3.x>this._orthoRight)this._orthoRight=tempVector3.x;if(tempVector3.y>this._orthoTop)this._orthoTop=tempVector3.y}}}var xOffset=this._orthoRight-this._orthoLeft;var yOffset=this._orthoTop-this._orthoBottom;BABYLON.Matrix.OrthoOffCenterLHToRef(this._orthoLeft-xOffset*this.shadowOrthoScale,this._orthoRight+xOffset*this.shadowOrthoScale,this._orthoBottom-yOffset*this.shadowOrthoScale,this._orthoTop+yOffset*this.shadowOrthoScale,this.shadowMinZ!==undefined?this.shadowMinZ:activeCamera.minZ,this.shadowMaxZ!==undefined?this.shadowMaxZ:activeCamera.maxZ,matrix)};DirectionalLight.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};DirectionalLight.prototype.transferToEffect=function(effect,lightIndex){if(this.computeTransformedInformation()){this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,lightIndex);return this}this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,lightIndex);return this};DirectionalLight.prototype.getDepthMinZ=function(activeCamera){return 1};DirectionalLight.prototype.getDepthMaxZ=function(activeCamera){return 1};__decorate([BABYLON.serialize()],DirectionalLight.prototype,"shadowFrustumSize",null);__decorate([BABYLON.serialize()],DirectionalLight.prototype,"shadowOrthoScale",null);__decorate([BABYLON.serialize()],DirectionalLight.prototype,"autoUpdateExtends",void 0);return DirectionalLight}(BABYLON.ShadowLight);BABYLON.DirectionalLight=DirectionalLight})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SpotLight=function(_super){__extends(SpotLight,_super);function SpotLight(name,position,direction,angle,exponent,scene){var _this=_super.call(this,name,scene)||this;_this.position=position;_this.direction=direction;_this.angle=angle;_this.exponent=exponent;return _this}Object.defineProperty(SpotLight.prototype,"angle",{get:function(){return this._angle},set:function(value){this._angle=value;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(SpotLight.prototype,"shadowAngleScale",{get:function(){return this._shadowAngleScale},set:function(value){this._shadowAngleScale=value;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});SpotLight.prototype.getClassName=function(){return"SpotLight"};SpotLight.prototype.getTypeID=function(){return BABYLON.Light.LIGHTTYPEID_SPOTLIGHT};SpotLight.prototype._setDefaultShadowProjectionMatrix=function(matrix,viewMatrix,renderList){var activeCamera=this.getScene().activeCamera;this._shadowAngleScale=this._shadowAngleScale||1;var angle=this._shadowAngleScale*this._angle;BABYLON.Matrix.PerspectiveFovLHToRef(angle,1,this.getDepthMinZ(activeCamera),this.getDepthMaxZ(activeCamera),matrix)};SpotLight.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",3);this._uniformBuffer.addUniform("vLightDirection",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};SpotLight.prototype.transferToEffect=function(effect,lightIndex){var normalizeDirection;if(this.computeTransformedInformation()){this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,lightIndex);normalizeDirection=BABYLON.Vector3.Normalize(this.transformedDirection)}else{this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,lightIndex);normalizeDirection=BABYLON.Vector3.Normalize(this.direction)}this._uniformBuffer.updateFloat4("vLightDirection",normalizeDirection.x,normalizeDirection.y,normalizeDirection.z,Math.cos(this.angle*.5),lightIndex);return this};__decorate([BABYLON.serialize()],SpotLight.prototype,"angle",null);__decorate([BABYLON.serialize()],SpotLight.prototype,"shadowAngleScale",null);__decorate([BABYLON.serialize()],SpotLight.prototype,"exponent",void 0);return SpotLight}(BABYLON.ShadowLight);BABYLON.SpotLight=SpotLight})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var AnimationRange=function(){function AnimationRange(name,from,to){this.name=name;this.from=from;this.to=to}AnimationRange.prototype.clone=function(){return new AnimationRange(this.name,this.from,this.to)};return AnimationRange}();BABYLON.AnimationRange=AnimationRange;var AnimationEvent=function(){function AnimationEvent(frame,action,onlyOnce){this.frame=frame;this.action=action;this.onlyOnce=onlyOnce;this.isDone=false}return AnimationEvent}();BABYLON.AnimationEvent=AnimationEvent;var PathCursor=function(){function PathCursor(path){this.path=path;this._onchange=new Array;this.value=0;this.animations=new Array}PathCursor.prototype.getPoint=function(){var point=this.path.getPointAtLengthPosition(this.value);return new BABYLON.Vector3(point.x,0,point.y)};PathCursor.prototype.moveAhead=function(step){if(step===void 0){step=.002}this.move(step);return this};PathCursor.prototype.moveBack=function(step){if(step===void 0){step=.002}this.move(-step);return this};PathCursor.prototype.move=function(step){if(Math.abs(step)>1){throw"step size should be less than 1."}this.value+=step;this.ensureLimits();this.raiseOnChange();return this};PathCursor.prototype.ensureLimits=function(){while(this.value>1){this.value-=1}while(this.value<0){this.value+=1}return this};PathCursor.prototype.raiseOnChange=function(){var _this=this;this._onchange.forEach(function(f){return f(_this)});return this};PathCursor.prototype.onchange=function(f){this._onchange.push(f);return this};return PathCursor}();BABYLON.PathCursor=PathCursor;var Animation=function(){function Animation(name,targetProperty,framePerSecond,dataType,loopMode,enableBlending){this.name=name;this.targetProperty=targetProperty;this.framePerSecond=framePerSecond;this.dataType=dataType;this.loopMode=loopMode;this.enableBlending=enableBlending;this._runtimeAnimations=new Array;this._events=new Array;this.blendingSpeed=.01;this._ranges={};this.targetPropertyPath=targetProperty.split(".");this.dataType=dataType;this.loopMode=loopMode===undefined?Animation.ANIMATIONLOOPMODE_CYCLE:loopMode}Animation._PrepareAnimation=function(name,targetProperty,framePerSecond,totalFrame,from,to,loopMode,easingFunction){var dataType=undefined;if(!isNaN(parseFloat(from))&&isFinite(from)){dataType=Animation.ANIMATIONTYPE_FLOAT}else if(from instanceof BABYLON.Quaternion){dataType=Animation.ANIMATIONTYPE_QUATERNION}else if(from instanceof BABYLON.Vector3){dataType=Animation.ANIMATIONTYPE_VECTOR3}else if(from instanceof BABYLON.Vector2){dataType=Animation.ANIMATIONTYPE_VECTOR2}else if(from instanceof BABYLON.Color3){dataType=Animation.ANIMATIONTYPE_COLOR3}else if(from instanceof BABYLON.Size){dataType=Animation.ANIMATIONTYPE_SIZE}if(dataType==undefined){return null}var animation=new Animation(name,targetProperty,framePerSecond,dataType,loopMode);var keys=[{frame:0,value:from},{frame:totalFrame,value:to}];animation.setKeys(keys);if(easingFunction!==undefined){animation.setEasingFunction(easingFunction)}return animation};Animation.CreateAnimation=function(property,animationType,framePerSecond,easingFunction){var animation=new BABYLON.Animation(property+"Animation",property,framePerSecond,animationType,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);animation.setEasingFunction(easingFunction);return animation};Animation.CreateAndStartAnimation=function(name,node,targetProperty,framePerSecond,totalFrame,from,to,loopMode,easingFunction,onAnimationEnd){var animation=Animation._PrepareAnimation(name,targetProperty,framePerSecond,totalFrame,from,to,loopMode,easingFunction);return node.getScene().beginDirectAnimation(node,[animation],0,totalFrame,animation.loopMode===1,1,onAnimationEnd)};Animation.CreateMergeAndStartAnimation=function(name,node,targetProperty,framePerSecond,totalFrame,from,to,loopMode,easingFunction,onAnimationEnd){var animation=Animation._PrepareAnimation(name,targetProperty,framePerSecond,totalFrame,from,to,loopMode,easingFunction);node.animations.push(animation);return node.getScene().beginAnimation(node,0,totalFrame,animation.loopMode===1,1,onAnimationEnd)};Animation.TransitionTo=function(property,targetValue,host,scene,frameRate,transition,duration,onAnimationEnd){if(onAnimationEnd===void 0){onAnimationEnd=null}if(duration<=0){host[property]=targetValue;if(onAnimationEnd){onAnimationEnd()}return null}var endFrame=frameRate*(duration/1e3);transition.setKeys([{frame:0,value:host[property].clone?host[property].clone():host[property]},{frame:endFrame,value:targetValue}]);if(!host.animations){host.animations=[]}host.animations.push(transition);var animation=scene.beginAnimation(host,0,endFrame,false);animation.onAnimationEnd=onAnimationEnd;return animation};Object.defineProperty(Animation.prototype,"runtimeAnimations",{get:function(){return this._runtimeAnimations},enumerable:true,configurable:true});Object.defineProperty(Animation.prototype,"hasRunningRuntimeAnimations",{get:function(){for(var _i=0,_a=this._runtimeAnimations;_i<_a.length;_i++){var runtimeAnimation=_a[_i];if(!runtimeAnimation.isStopped){return true}}return false},enumerable:true,configurable:true});Animation.prototype.toString=function(fullDetails){var ret="Name: "+this.name+", property: "+this.targetProperty;ret+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType];ret+=", nKeys: "+(this._keys?this._keys.length:"none");ret+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none");if(fullDetails){ret+=", Ranges: {";var first=true;for(var name in this._ranges){if(first){ret+=", ";first=false}ret+=name}ret+="}"}return ret};Animation.prototype.addEvent=function(event){this._events.push(event)};Animation.prototype.removeEvents=function(frame){for(var index=0;index<this._events.length;index++){if(this._events[index].frame===frame){this._events.splice(index,1);index--}}};Animation.prototype.getEvents=function(){return this._events};Animation.prototype.createRange=function(name,from,to){if(!this._ranges[name]){this._ranges[name]=new AnimationRange(name,from,to)}};Animation.prototype.deleteRange=function(name,deleteFrames){if(deleteFrames===void 0){deleteFrames=true}if(this._ranges[name]){if(deleteFrames){var from=this._ranges[name].from;var to=this._ranges[name].to;for(var key=this._keys.length-1;key>=0;key--){if(this._keys[key].frame>=from&&this._keys[key].frame<=to){this._keys.splice(key,1)}}}this._ranges[name]=undefined}};Animation.prototype.getRange=function(name){return this._ranges[name]};Animation.prototype.getKeys=function(){return this._keys};Animation.prototype.getHighestFrame=function(){var ret=0;for(var key=0,nKeys=this._keys.length;key<nKeys;key++){if(ret<this._keys[key].frame){ret=this._keys[key].frame}}return ret};Animation.prototype.getEasingFunction=function(){return this._easingFunction};Animation.prototype.setEasingFunction=function(easingFunction){this._easingFunction=easingFunction};Animation.prototype.floatInterpolateFunction=function(startValue,endValue,gradient){return BABYLON.Scalar.Lerp(startValue,endValue,gradient)};Animation.prototype.floatInterpolateFunctionWithTangents=function(startValue,outTangent,endValue,inTangent,gradient){return BABYLON.Scalar.Hermite(startValue,outTangent,endValue,inTangent,gradient)};Animation.prototype.quaternionInterpolateFunction=function(startValue,endValue,gradient){return BABYLON.Quaternion.Slerp(startValue,endValue,gradient)};Animation.prototype.quaternionInterpolateFunctionWithTangents=function(startValue,outTangent,endValue,inTangent,gradient){return BABYLON.Quaternion.Hermite(startValue,outTangent,endValue,inTangent,gradient).normalize()};Animation.prototype.vector3InterpolateFunction=function(startValue,endValue,gradient){return BABYLON.Vector3.Lerp(startValue,endValue,gradient)};Animation.prototype.vector3InterpolateFunctionWithTangents=function(startValue,outTangent,endValue,inTangent,gradient){return BABYLON.Vector3.Hermite(startValue,outTangent,endValue,inTangent,gradient)};Animation.prototype.vector2InterpolateFunction=function(startValue,endValue,gradient){return BABYLON.Vector2.Lerp(startValue,endValue,gradient)};Animation.prototype.vector2InterpolateFunctionWithTangents=function(startValue,outTangent,endValue,inTangent,gradient){return BABYLON.Vector2.Hermite(startValue,outTangent,endValue,inTangent,gradient)};Animation.prototype.sizeInterpolateFunction=function(startValue,endValue,gradient){return BABYLON.Size.Lerp(startValue,endValue,gradient)};Animation.prototype.color3InterpolateFunction=function(startValue,endValue,gradient){return BABYLON.Color3.Lerp(startValue,endValue,gradient)};Animation.prototype.matrixInterpolateFunction=function(startValue,endValue,gradient){return BABYLON.Matrix.Lerp(startValue,endValue,gradient)};Animation.prototype.clone=function(){var clone=new Animation(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);clone.enableBlending=this.enableBlending;clone.blendingSpeed=this.blendingSpeed;if(this._keys){clone.setKeys(this._keys)}if(this._ranges){clone._ranges={};for(var name in this._ranges){clone._ranges[name]=this._ranges[name].clone()}}return clone};Animation.prototype.setKeys=function(values){this._keys=values.slice(0)};Animation.prototype.serialize=function(){var serializationObject={};serializationObject.name=this.name;serializationObject.property=this.targetProperty;serializationObject.framePerSecond=this.framePerSecond;serializationObject.dataType=this.dataType;serializationObject.loopBehavior=this.loopMode;serializationObject.enableBlending=this.enableBlending;serializationObject.blendingSpeed=this.blendingSpeed;var dataType=this.dataType;serializationObject.keys=[];var keys=this.getKeys();for(var index=0;index<keys.length;index++){var animationKey=keys[index];var key={};key.frame=animationKey.frame;switch(dataType){case Animation.ANIMATIONTYPE_FLOAT:key.values=[animationKey.value];break;case Animation.ANIMATIONTYPE_QUATERNION:case Animation.ANIMATIONTYPE_MATRIX:case Animation.ANIMATIONTYPE_VECTOR3:case Animation.ANIMATIONTYPE_COLOR3:key.values=animationKey.value.asArray();break}serializationObject.keys.push(key)}serializationObject.ranges=[];for(var name in this._ranges){var range={};range.name=name;range.from=this._ranges[name].from;range.to=this._ranges[name].to;serializationObject.ranges.push(range)}return serializationObject};Object.defineProperty(Animation,"ANIMATIONTYPE_FLOAT",{get:function(){return Animation._ANIMATIONTYPE_FLOAT},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONTYPE_VECTOR3",{get:function(){return Animation._ANIMATIONTYPE_VECTOR3},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONTYPE_VECTOR2",{get:function(){return Animation._ANIMATIONTYPE_VECTOR2},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONTYPE_SIZE",{get:function(){return Animation._ANIMATIONTYPE_SIZE},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONTYPE_QUATERNION",{get:function(){return Animation._ANIMATIONTYPE_QUATERNION},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONTYPE_MATRIX",{get:function(){return Animation._ANIMATIONTYPE_MATRIX},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONTYPE_COLOR3",{get:function(){return Animation._ANIMATIONTYPE_COLOR3},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONLOOPMODE_RELATIVE",{get:function(){return Animation._ANIMATIONLOOPMODE_RELATIVE},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONLOOPMODE_CYCLE",{get:function(){return Animation._ANIMATIONLOOPMODE_CYCLE},enumerable:true,configurable:true});Object.defineProperty(Animation,"ANIMATIONLOOPMODE_CONSTANT",{get:function(){return Animation._ANIMATIONLOOPMODE_CONSTANT},enumerable:true,configurable:true});Animation.Parse=function(parsedAnimation){var animation=new Animation(parsedAnimation.name,parsedAnimation.property,parsedAnimation.framePerSecond,parsedAnimation.dataType,parsedAnimation.loopBehavior);var dataType=parsedAnimation.dataType;var keys=[];var data;var index;if(parsedAnimation.enableBlending){animation.enableBlending=parsedAnimation.enableBlending}if(parsedAnimation.blendingSpeed){animation.blendingSpeed=parsedAnimation.blendingSpeed}for(index=0;index<parsedAnimation.keys.length;index++){var key=parsedAnimation.keys[index];var inTangent;var outTangent;switch(dataType){case Animation.ANIMATIONTYPE_FLOAT:data=key.values[0];if(key.values.length>=1){inTangent=key.values[1]}if(key.values.length>=2){outTangent=key.values[2]}break;case Animation.ANIMATIONTYPE_QUATERNION:data=BABYLON.Quaternion.FromArray(key.values);if(key.values.length>=8){var _inTangent=BABYLON.Quaternion.FromArray(key.values.slice(4,8));if(!_inTangent.equals(BABYLON.Quaternion.Zero())){inTangent=_inTangent}}if(key.values.length>=12){var _outTangent=BABYLON.Quaternion.FromArray(key.values.slice(8,12));if(!_outTangent.equals(BABYLON.Quaternion.Zero())){outTangent=_outTangent}}break;case Animation.ANIMATIONTYPE_MATRIX:data=BABYLON.Matrix.FromArray(key.values);break;case Animation.ANIMATIONTYPE_COLOR3:data=BABYLON.Color3.FromArray(key.values);break;case Animation.ANIMATIONTYPE_VECTOR3:default:data=BABYLON.Vector3.FromArray(key.values);break}var keyData={};keyData.frame=key.frame;keyData.value=data;if(inTangent!=undefined){keyData.inTangent=inTangent}if(outTangent!=undefined){keyData.outTangent=outTangent}keys.push(keyData)}animation.setKeys(keys);if(parsedAnimation.ranges){for(index=0;index<parsedAnimation.ranges.length;index++){data=parsedAnimation.ranges[index];animation.createRange(data.name,data.from,data.to)}}return animation};Animation.AppendSerializedAnimations=function(source,destination){if(source.animations){destination.animations=[];for(var animationIndex=0;animationIndex<source.animations.length;animationIndex++){var animation=source.animations[animationIndex];destination.animations.push(animation.serialize())}}};Animation.AllowMatricesInterpolation=false;Animation._ANIMATIONTYPE_FLOAT=0;Animation._ANIMATIONTYPE_VECTOR3=1;Animation._ANIMATIONTYPE_QUATERNION=2;Animation._ANIMATIONTYPE_MATRIX=3;Animation._ANIMATIONTYPE_COLOR3=4;Animation._ANIMATIONTYPE_VECTOR2=5;Animation._ANIMATIONTYPE_SIZE=6;Animation._ANIMATIONLOOPMODE_RELATIVE=0;Animation._ANIMATIONLOOPMODE_CYCLE=1;Animation._ANIMATIONLOOPMODE_CONSTANT=2;return Animation}();BABYLON.Animation=Animation})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var RuntimeAnimation=function(){function RuntimeAnimation(target,animation){this._offsetsCache={};this._highLimitsCache={};this._stopped=false;this._blendingFactor=0;this._ratioOffset=0;this._animation=animation;this._target=target;animation._runtimeAnimations.push(this)}Object.defineProperty(RuntimeAnimation.prototype,"animation",{get:function(){return this._animation},enumerable:true,configurable:true});RuntimeAnimation.prototype.reset=function(){this._offsetsCache={};this._highLimitsCache={};this.currentFrame=0;this._blendingFactor=0;this._originalBlendValue=null};RuntimeAnimation.prototype.isStopped=function(){return this._stopped};RuntimeAnimation.prototype.dispose=function(){var index=this._animation.runtimeAnimations.indexOf(this);if(index>-1){this._animation.runtimeAnimations.splice(index,1)}};RuntimeAnimation.prototype._getKeyValue=function(value){if(typeof value==="function"){return value()}return value};RuntimeAnimation.prototype._interpolate=function(currentFrame,repeatCount,loopMode,offsetValue,highLimitValue){if(loopMode===BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT&&repeatCount>0){return highLimitValue.clone?highLimitValue.clone():highLimitValue}this.currentFrame=currentFrame;var keys=this._animation.getKeys();var startKeyIndex=Math.max(0,Math.min(keys.length-1,Math.floor(keys.length*(currentFrame-keys[0].frame)/(keys[keys.length-1].frame-keys[0].frame))-1));if(keys[startKeyIndex].frame>=currentFrame){while(startKeyIndex-1>=0&&keys[startKeyIndex].frame>=currentFrame){startKeyIndex--}}for(var key=startKeyIndex;key<keys.length;key++){var endKey=keys[key+1];if(endKey.frame>=currentFrame){var startKey=keys[key];var startValue=this._getKeyValue(startKey.value);var endValue=this._getKeyValue(endKey.value);var useTangent=startKey.outTangent!==undefined&&endKey.inTangent!==undefined;var frameDelta=endKey.frame-startKey.frame;var gradient=(currentFrame-startKey.frame)/frameDelta;var easingFunction=this._animation.getEasingFunction();if(easingFunction!=null){gradient=easingFunction.ease(gradient)}switch(this._animation.dataType){case BABYLON.Animation.ANIMATIONTYPE_FLOAT:var floatValue=useTangent?this._animation.floatInterpolateFunctionWithTangents(startValue,startKey.outTangent*frameDelta,endValue,endKey.inTangent*frameDelta,gradient):this._animation.floatInterpolateFunction(startValue,endValue,gradient);switch(loopMode){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:return floatValue;case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return offsetValue*repeatCount+floatValue}break;case BABYLON.Animation.ANIMATIONTYPE_QUATERNION:var quatValue=useTangent?this._animation.quaternionInterpolateFunctionWithTangents(startValue,startKey.outTangent.scale(frameDelta),endValue,endKey.inTangent.scale(frameDelta),gradient):this._animation.quaternionInterpolateFunction(startValue,endValue,gradient);switch(loopMode){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:return quatValue;case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return quatValue.add(offsetValue.scale(repeatCount))}return quatValue;case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:var vec3Value=useTangent?this._animation.vector3InterpolateFunctionWithTangents(startValue,startKey.outTangent.scale(frameDelta),endValue,endKey.inTangent.scale(frameDelta),gradient):this._animation.vector3InterpolateFunction(startValue,endValue,gradient);switch(loopMode){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:return vec3Value;case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return vec3Value.add(offsetValue.scale(repeatCount))}case BABYLON.Animation.ANIMATIONTYPE_VECTOR2:var vec2Value=useTangent?this._animation.vector2InterpolateFunctionWithTangents(startValue,startKey.outTangent.scale(frameDelta),endValue,endKey.inTangent.scale(frameDelta),gradient):this._animation.vector2InterpolateFunction(startValue,endValue,gradient);switch(loopMode){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:return vec2Value;case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return vec2Value.add(offsetValue.scale(repeatCount))}case BABYLON.Animation.ANIMATIONTYPE_SIZE:switch(loopMode){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:return this._animation.sizeInterpolateFunction(startValue,endValue,gradient);case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return this._animation.sizeInterpolateFunction(startValue,endValue,gradient).add(offsetValue.scale(repeatCount))}case BABYLON.Animation.ANIMATIONTYPE_COLOR3:switch(loopMode){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:return this._animation.color3InterpolateFunction(startValue,endValue,gradient);case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return this._animation.color3InterpolateFunction(startValue,endValue,gradient).add(offsetValue.scale(repeatCount))}case BABYLON.Animation.ANIMATIONTYPE_MATRIX:switch(loopMode){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:if(BABYLON.Animation.AllowMatricesInterpolation){return this._animation.matrixInterpolateFunction(startValue,endValue,gradient)}case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return startValue}default:break}break}}return this._getKeyValue(keys[keys.length-1].value)};RuntimeAnimation.prototype.setValue=function(currentValue,blend){if(blend===void 0){blend=false}var path;var destination;var targetPropertyPath=this._animation.targetPropertyPath;if(targetPropertyPath.length>1){var property=this._target[targetPropertyPath[0]];for(var index=1;index<targetPropertyPath.length-1;index++){property=property[targetPropertyPath[index]]}path=targetPropertyPath[targetPropertyPath.length-1];destination=property}else{path=targetPropertyPath[0];destination=this._target}if(this._animation.enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){if(destination[path].clone){this._originalBlendValue=destination[path].clone()}else{this._originalBlendValue=destination[path]}}if(this._originalBlendValue.prototype){if(this._originalBlendValue.prototype.Lerp){destination[path]=this._originalBlendValue.construtor.prototype.Lerp(currentValue,this._originalBlendValue,this._blendingFactor)}else{destination[path]=currentValue}}else if(this._originalBlendValue.m){destination[path]=BABYLON.Matrix.Lerp(this._originalBlendValue,currentValue,this._blendingFactor)}else{destination[path]=this._originalBlendValue*(1-this._blendingFactor)+this._blendingFactor*currentValue}this._blendingFactor+=this._animation.blendingSpeed}else{destination[path]=currentValue}if(this._target.markAsDirty){this._target.markAsDirty(this._animation.targetProperty)}};RuntimeAnimation.prototype.goToFrame=function(frame){var keys=this._animation.getKeys();if(frame<keys[0].frame){frame=keys[0].frame}else if(frame>keys[keys.length-1].frame){frame=keys[keys.length-1].frame}var currentValue=this._interpolate(frame,0,this._animation.loopMode);this.setValue(currentValue)};RuntimeAnimation.prototype._prepareForSpeedRatioChange=function(newSpeedRatio){var newRatio=this._previousDelay*(this._animation.framePerSecond*newSpeedRatio)/1e3;this._ratioOffset=this._previousRatio-newRatio};RuntimeAnimation.prototype.animate=function(delay,from,to,loop,speedRatio,blend){if(blend===void 0){blend=false}var targetPropertyPath=this._animation.targetPropertyPath;if(!targetPropertyPath||targetPropertyPath.length<1){this._stopped=true;return false}var returnValue=true;var keys=this._animation.getKeys();if(keys[0].frame!==0){var newKey={frame:0,value:keys[0].value};keys.splice(0,0,newKey)}if(from<keys[0].frame||from>keys[keys.length-1].frame){from=keys[0].frame}if(to<keys[0].frame||to>keys[keys.length-1].frame){to=keys[keys.length-1].frame}if(from===to){if(from>keys[0].frame){from--}else if(to<keys[keys.length-1].frame){to++}}var range=to-from;var offsetValue;var ratio=delay*(this._animation.framePerSecond*speedRatio)/1e3+this._ratioOffset;var highLimitValue=0;this._previousDelay=delay;this._previousRatio=ratio;if((to>from&&ratio>range||from>to&&ratio<range)&&!loop){returnValue=false;highLimitValue=this._getKeyValue(keys[keys.length-1].value)}else{if(this._animation.loopMode!==BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE){var keyOffset=to.toString()+from.toString();if(!this._offsetsCache[keyOffset]){var fromValue=this._interpolate(from,0,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);var toValue=this._interpolate(to,0,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);switch(this._animation.dataType){case BABYLON.Animation.ANIMATIONTYPE_FLOAT:this._offsetsCache[keyOffset]=toValue-fromValue;break;case BABYLON.Animation.ANIMATIONTYPE_QUATERNION:this._offsetsCache[keyOffset]=toValue.subtract(fromValue);break;case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:this._offsetsCache[keyOffset]=toValue.subtract(fromValue);case BABYLON.Animation.ANIMATIONTYPE_VECTOR2:this._offsetsCache[keyOffset]=toValue.subtract(fromValue);case BABYLON.Animation.ANIMATIONTYPE_SIZE:this._offsetsCache[keyOffset]=toValue.subtract(fromValue);case BABYLON.Animation.ANIMATIONTYPE_COLOR3:this._offsetsCache[keyOffset]=toValue.subtract(fromValue);default:break}this._highLimitsCache[keyOffset]=toValue}highLimitValue=this._highLimitsCache[keyOffset];offsetValue=this._offsetsCache[keyOffset]}}if(offsetValue===undefined){switch(this._animation.dataType){case BABYLON.Animation.ANIMATIONTYPE_FLOAT:offsetValue=0;break;case BABYLON.Animation.ANIMATIONTYPE_QUATERNION:offsetValue=new BABYLON.Quaternion(0,0,0,0);break;case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:offsetValue=BABYLON.Vector3.Zero();break;case BABYLON.Animation.ANIMATIONTYPE_VECTOR2:offsetValue=BABYLON.Vector2.Zero();break;case BABYLON.Animation.ANIMATIONTYPE_SIZE:offsetValue=BABYLON.Size.Zero();break;case BABYLON.Animation.ANIMATIONTYPE_COLOR3:offsetValue=BABYLON.Color3.Black()}}var repeatCount=ratio/range>>0;var currentFrame=returnValue?from+ratio%range:to;var currentValue=this._interpolate(currentFrame,repeatCount,this._animation.loopMode,offsetValue,highLimitValue);this.setValue(currentValue);var events=this._animation.getEvents();for(var index=0;index<events.length;index++){if(range>0&&currentFrame>=events[index].frame&&events[index].frame>=from||range<0&&currentFrame<=events[index].frame&&events[index].frame<=from){var event=events[index];if(!event.isDone){if(event.onlyOnce){events.splice(index,1);index--}event.isDone=true;event.action()}}else if(events[index].isDone&&!events[index].onlyOnce){events[index].isDone=false}}if(!returnValue){this._stopped=true}return returnValue};return RuntimeAnimation}();BABYLON.RuntimeAnimation=RuntimeAnimation})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Animatable=function(){function Animatable(scene,target,fromFrame,toFrame,loopAnimation,speedRatio,onAnimationEnd,animations){if(fromFrame===void 0){fromFrame=0}if(toFrame===void 0){toFrame=100}if(loopAnimation===void 0){loopAnimation=false}if(speedRatio===void 0){speedRatio=1}this.target=target;this.fromFrame=fromFrame;this.toFrame=toFrame;this.loopAnimation=loopAnimation;this.onAnimationEnd=onAnimationEnd;this._localDelayOffset=null;this._pausedDelay=null;this._runtimeAnimations=new Array;this._paused=false;this._speedRatio=1;this.animationStarted=false;if(animations){this.appendAnimations(target,animations)}this._speedRatio=speedRatio;this._scene=scene;scene._activeAnimatables.push(this)}Object.defineProperty(Animatable.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(value){for(var index=0;index<this._runtimeAnimations.length;index++){var animation=this._runtimeAnimations[index];animation._prepareForSpeedRatioChange(value)}this._speedRatio=value},enumerable:true,configurable:true});Animatable.prototype.getAnimations=function(){return this._runtimeAnimations};Animatable.prototype.appendAnimations=function(target,animations){for(var index=0;index<animations.length;index++){var animation=animations[index];this._runtimeAnimations.push(new BABYLON.RuntimeAnimation(target,animation))}};Animatable.prototype.getAnimationByTargetProperty=function(property){var runtimeAnimations=this._runtimeAnimations;for(var index=0;index<runtimeAnimations.length;index++){if(runtimeAnimations[index].animation.targetProperty===property){return runtimeAnimations[index].animation}}return null};Animatable.prototype.getRuntimeAnimationByTargetProperty=function(property){var runtimeAnimations=this._runtimeAnimations;for(var index=0;index<runtimeAnimations.length;index++){if(runtimeAnimations[index].animation.targetProperty===property){return runtimeAnimations[index]}}return null};Animatable.prototype.reset=function(){var runtimeAnimations=this._runtimeAnimations;for(var index=0;index<runtimeAnimations.length;index++){runtimeAnimations[index].reset()}this._localDelayOffset=null;this._pausedDelay=null};Animatable.prototype.enableBlending=function(blendingSpeed){var runtimeAnimations=this._runtimeAnimations;for(var index=0;index<runtimeAnimations.length;index++){runtimeAnimations[index].animation.enableBlending=true;runtimeAnimations[index].animation.blendingSpeed=blendingSpeed}};Animatable.prototype.disableBlending=function(){var runtimeAnimations=this._runtimeAnimations;for(var index=0;index<runtimeAnimations.length;index++){runtimeAnimations[index].animation.enableBlending=false}};Animatable.prototype.goToFrame=function(frame){var runtimeAnimations=this._runtimeAnimations;if(runtimeAnimations[0]){var fps=runtimeAnimations[0].animation.framePerSecond;var currentFrame=runtimeAnimations[0].currentFrame;var adjustTime=frame-currentFrame;var delay=adjustTime*1e3/fps;this._localDelayOffset-=delay}for(var index=0;index<runtimeAnimations.length;index++){runtimeAnimations[index].goToFrame(frame)}};Animatable.prototype.pause=function(){if(this._paused){return}this._paused=true};Animatable.prototype.restart=function(){this._paused=false};Animatable.prototype.stop=function(animationName){if(animationName){var idx=this._scene._activeAnimatables.indexOf(this);if(idx>-1){var runtimeAnimations=this._runtimeAnimations;for(var index=runtimeAnimations.length-1;index>=0;index--){if(typeof animationName==="string"&&runtimeAnimations[index].animation.name!=animationName){continue}runtimeAnimations[index].dispose();runtimeAnimations.splice(index,1)}if(runtimeAnimations.length==0){this._scene._activeAnimatables.splice(idx,1);if(this.onAnimationEnd){this.onAnimationEnd()}}}}else{var index=this._scene._activeAnimatables.indexOf(this);if(index>-1){this._scene._activeAnimatables.splice(index,1);var runtimeAnimations=this._runtimeAnimations;for(var index=0;index<runtimeAnimations.length;index++){runtimeAnimations[index].dispose()}if(this.onAnimationEnd){this.onAnimationEnd()}}}};Animatable.prototype._animate=function(delay){if(this._paused){this.animationStarted=false;if(this._pausedDelay===null){this._pausedDelay=delay}return true}if(this._localDelayOffset===null){this._localDelayOffset=delay}else if(this._pausedDelay!==null){this._localDelayOffset+=delay-this._pausedDelay;this._pausedDelay=null}var running=false;var runtimeAnimations=this._runtimeAnimations;var index;for(index=0;index<runtimeAnimations.length;index++){var animation=runtimeAnimations[index];var isRunning=animation.animate(delay-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio);running=running||isRunning}this.animationStarted=running;if(!running){index=this._scene._activeAnimatables.indexOf(this);this._scene._activeAnimatables.splice(index,1);for(index=0;index<runtimeAnimations.length;index++){runtimeAnimations[index].dispose()}}if(!running&&this.onAnimationEnd){this.onAnimationEnd();this.onAnimationEnd=null}return running};return Animatable}();BABYLON.Animatable=Animatable})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var EasingFunction=function(){function EasingFunction(){this._easingMode=EasingFunction.EASINGMODE_EASEIN}Object.defineProperty(EasingFunction,"EASINGMODE_EASEIN",{get:function(){return EasingFunction._EASINGMODE_EASEIN},enumerable:true,configurable:true});Object.defineProperty(EasingFunction,"EASINGMODE_EASEOUT",{get:function(){return EasingFunction._EASINGMODE_EASEOUT},enumerable:true,configurable:true});Object.defineProperty(EasingFunction,"EASINGMODE_EASEINOUT",{get:function(){return EasingFunction._EASINGMODE_EASEINOUT},enumerable:true,configurable:true});EasingFunction.prototype.setEasingMode=function(easingMode){var n=Math.min(Math.max(easingMode,0),2);this._easingMode=n};EasingFunction.prototype.getEasingMode=function(){return this._easingMode};EasingFunction.prototype.easeInCore=function(gradient){throw new Error("You must implement this method")};EasingFunction.prototype.ease=function(gradient){switch(this._easingMode){case EasingFunction.EASINGMODE_EASEIN:return this.easeInCore(gradient);case EasingFunction.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-gradient)}if(gradient>=.5){return(1-this.easeInCore((1-gradient)*2))*.5+.5}return this.easeInCore(gradient*2)*.5};EasingFunction._EASINGMODE_EASEIN=0;EasingFunction._EASINGMODE_EASEOUT=1;EasingFunction._EASINGMODE_EASEINOUT=2;return EasingFunction}();BABYLON.EasingFunction=EasingFunction;var CircleEase=function(_super){__extends(CircleEase,_super);function CircleEase(){return _super!==null&&_super.apply(this,arguments)||this}CircleEase.prototype.easeInCore=function(gradient){gradient=Math.max(0,Math.min(1,gradient));return 1-Math.sqrt(1-gradient*gradient)};return CircleEase}(EasingFunction);BABYLON.CircleEase=CircleEase;var BackEase=function(_super){__extends(BackEase,_super);function BackEase(amplitude){if(amplitude===void 0){amplitude=1}var _this=_super.call(this)||this;_this.amplitude=amplitude;return _this}BackEase.prototype.easeInCore=function(gradient){var num=Math.max(0,this.amplitude);return Math.pow(gradient,3)-gradient*num*Math.sin(3.141592653589793*gradient)};return BackEase}(EasingFunction);BABYLON.BackEase=BackEase;var BounceEase=function(_super){__extends(BounceEase,_super);function BounceEase(bounces,bounciness){if(bounces===void 0){bounces=3}if(bounciness===void 0){bounciness=2}var _this=_super.call(this)||this;_this.bounces=bounces;_this.bounciness=bounciness;return _this}BounceEase.prototype.easeInCore=function(gradient){var y=Math.max(0,this.bounces);var bounciness=this.bounciness;if(bounciness<=1){bounciness=1.001}var num9=Math.pow(bounciness,y);var num5=1-bounciness;var num4=(1-num9)/num5+num9*.5;var num15=gradient*num4;var num65=Math.log(-num15*(1-bounciness)+1)/Math.log(bounciness);var num3=Math.floor(num65);var num13=num3+1;var num8=(1-Math.pow(bounciness,num3))/(num5*num4);var num12=(1-Math.pow(bounciness,num13))/(num5*num4);var num7=(num8+num12)*.5;var num6=gradient-num7;var num2=num7-num8;return-Math.pow(1/bounciness,y-num3)/(num2*num2)*(num6-num2)*(num6+num2)};return BounceEase}(EasingFunction);BABYLON.BounceEase=BounceEase;var CubicEase=function(_super){__extends(CubicEase,_super);function CubicEase(){return _super!==null&&_super.apply(this,arguments)||this}CubicEase.prototype.easeInCore=function(gradient){return gradient*gradient*gradient};return CubicEase}(EasingFunction);BABYLON.CubicEase=CubicEase;var ElasticEase=function(_super){__extends(ElasticEase,_super);function ElasticEase(oscillations,springiness){if(oscillations===void 0){oscillations=3}if(springiness===void 0){springiness=3}var _this=_super.call(this)||this;_this.oscillations=oscillations;_this.springiness=springiness;return _this}ElasticEase.prototype.easeInCore=function(gradient){var num2;var num3=Math.max(0,this.oscillations);var num=Math.max(0,this.springiness);if(num==0){num2=gradient}else{num2=(Math.exp(num*gradient)-1)/(Math.exp(num)-1)}return num2*Math.sin((6.283185307179586*num3+1.5707963267948966)*gradient)};return ElasticEase}(EasingFunction);BABYLON.ElasticEase=ElasticEase;var ExponentialEase=function(_super){__extends(ExponentialEase,_super);function ExponentialEase(exponent){if(exponent===void 0){exponent=2}var _this=_super.call(this)||this;_this.exponent=exponent;return _this}ExponentialEase.prototype.easeInCore=function(gradient){if(this.exponent<=0){return gradient}return(Math.exp(this.exponent*gradient)-1)/(Math.exp(this.exponent)-1)};return ExponentialEase}(EasingFunction);BABYLON.ExponentialEase=ExponentialEase;var PowerEase=function(_super){__extends(PowerEase,_super);function PowerEase(power){if(power===void 0){power=2}var _this=_super.call(this)||this;_this.power=power;return _this}PowerEase.prototype.easeInCore=function(gradient){var y=Math.max(0,this.power);return Math.pow(gradient,y)};return PowerEase}(EasingFunction);BABYLON.PowerEase=PowerEase;var QuadraticEase=function(_super){__extends(QuadraticEase,_super);function QuadraticEase(){return _super!==null&&_super.apply(this,arguments)||this}QuadraticEase.prototype.easeInCore=function(gradient){return gradient*gradient};return QuadraticEase}(EasingFunction);BABYLON.QuadraticEase=QuadraticEase;var QuarticEase=function(_super){__extends(QuarticEase,_super);function QuarticEase(){return _super!==null&&_super.apply(this,arguments)||this}QuarticEase.prototype.easeInCore=function(gradient){return gradient*gradient*gradient*gradient};return QuarticEase}(EasingFunction);BABYLON.QuarticEase=QuarticEase;var QuinticEase=function(_super){__extends(QuinticEase,_super);function QuinticEase(){return _super!==null&&_super.apply(this,arguments)||this}QuinticEase.prototype.easeInCore=function(gradient){return gradient*gradient*gradient*gradient*gradient};return QuinticEase}(EasingFunction);BABYLON.QuinticEase=QuinticEase;var SineEase=function(_super){__extends(SineEase,_super);function SineEase(){return _super!==null&&_super.apply(this,arguments)||this}SineEase.prototype.easeInCore=function(gradient){return 1-Math.sin(1.5707963267948966*(1-gradient))};return SineEase}(EasingFunction);BABYLON.SineEase=SineEase;var BezierCurveEase=function(_super){__extends(BezierCurveEase,_super);function BezierCurveEase(x1,y1,x2,y2){if(x1===void 0){x1=0}if(y1===void 0){y1=0}if(x2===void 0){x2=1}if(y2===void 0){y2=1}var _this=_super.call(this)||this;_this.x1=x1;_this.y1=y1;_this.x2=x2;_this.y2=y2;return _this}BezierCurveEase.prototype.easeInCore=function(gradient){return BABYLON.BezierCurve.interpolate(gradient,this.x1,this.y1,this.x2,this.y2)};return BezierCurveEase}(EasingFunction);BABYLON.BezierCurveEase=BezierCurveEase})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Condition=function(){function Condition(actionManager){this._actionManager=actionManager}Condition.prototype.isValid=function(){return true};Condition.prototype._getProperty=function(propertyPath){return this._actionManager._getProperty(propertyPath)};Condition.prototype._getEffectiveTarget=function(target,propertyPath){return this._actionManager._getEffectiveTarget(target,propertyPath)};Condition.prototype.serialize=function(){};Condition.prototype._serialize=function(serializedCondition){return{type:2,children:[],name:serializedCondition.name,properties:serializedCondition.properties}};return Condition}();BABYLON.Condition=Condition;var ValueCondition=function(_super){__extends(ValueCondition,_super);function ValueCondition(actionManager,target,propertyPath,value,operator){if(operator===void 0){operator=ValueCondition.IsEqual}var _this=_super.call(this,actionManager)||this;_this.propertyPath=propertyPath;_this.value=value;_this.operator=operator;_this._target=target;_this._effectiveTarget=_this._getEffectiveTarget(target,_this.propertyPath);_this._property=_this._getProperty(_this.propertyPath);return _this}Object.defineProperty(ValueCondition,"IsEqual",{get:function(){return ValueCondition._IsEqual},enumerable:true,configurable:true});Object.defineProperty(ValueCondition,"IsDifferent",{get:function(){return ValueCondition._IsDifferent},enumerable:true,configurable:true});Object.defineProperty(ValueCondition,"IsGreater",{get:function(){return ValueCondition._IsGreater},enumerable:true,configurable:true});Object.defineProperty(ValueCondition,"IsLesser",{get:function(){return ValueCondition._IsLesser},enumerable:true,configurable:true});ValueCondition.prototype.isValid=function(){switch(this.operator){case ValueCondition.IsGreater:return this._effectiveTarget[this._property]>this.value;case ValueCondition.IsLesser:return this._effectiveTarget[this._property]<this.value;case ValueCondition.IsEqual:case ValueCondition.IsDifferent:var check;if(this.value.equals){check=this.value.equals(this._effectiveTarget[this._property])}else{check=this.value===this._effectiveTarget[this._property]}return this.operator===ValueCondition.IsEqual?check:!check}return false};ValueCondition.prototype.serialize=function(){return this._serialize({name:"ValueCondition",properties:[BABYLON.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:BABYLON.Action._SerializeValueAsString(this.value)},{name:"operator",value:ValueCondition.GetOperatorName(this.operator)}]})};ValueCondition.GetOperatorName=function(operator){switch(operator){case ValueCondition._IsEqual:return"IsEqual";case ValueCondition._IsDifferent:return"IsDifferent";case ValueCondition._IsGreater:return"IsGreater";case ValueCondition._IsLesser:return"IsLesser";default:return""}};ValueCondition._IsEqual=0;ValueCondition._IsDifferent=1;ValueCondition._IsGreater=2;ValueCondition._IsLesser=3;return ValueCondition}(Condition);BABYLON.ValueCondition=ValueCondition;var PredicateCondition=function(_super){__extends(PredicateCondition,_super);function PredicateCondition(actionManager,predicate){var _this=_super.call(this,actionManager)||this;_this.predicate=predicate;return _this}PredicateCondition.prototype.isValid=function(){return this.predicate()};return PredicateCondition}(Condition);BABYLON.PredicateCondition=PredicateCondition;var StateCondition=function(_super){__extends(StateCondition,_super);function StateCondition(actionManager,target,value){var _this=_super.call(this,actionManager)||this;_this.value=value;_this._target=target;return _this}StateCondition.prototype.isValid=function(){return this._target.state===this.value};StateCondition.prototype.serialize=function(){return this._serialize({name:"StateCondition",properties:[BABYLON.Action._GetTargetProperty(this._target),{name:"value",value:this.value}]})};return StateCondition}(Condition);BABYLON.StateCondition=StateCondition})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Action=function(){function Action(triggerOptions,condition){this.triggerOptions=triggerOptions;this.onBeforeExecuteObservable=new BABYLON.Observable;if(triggerOptions.parameter){this.trigger=triggerOptions.trigger;this._triggerParameter=triggerOptions.parameter}else{this.trigger=triggerOptions}this._nextActiveAction=this;this._condition=condition}Action.prototype._prepare=function(){};Action.prototype.getTriggerParameter=function(){return this._triggerParameter};Action.prototype._executeCurrent=function(evt){if(this._nextActiveAction._condition){var condition=this._nextActiveAction._condition;var currentRenderId=this._actionManager.getScene().getRenderId();if(condition._evaluationId===currentRenderId){if(!condition._currentResult){return}}else{condition._evaluationId=currentRenderId;if(!condition.isValid()){condition._currentResult=false;return}condition._currentResult=true}}this.onBeforeExecuteObservable.notifyObservers(this);this._nextActiveAction.execute(evt);this.skipToNextActiveAction()};Action.prototype.execute=function(evt){};Action.prototype.skipToNextActiveAction=function(){if(this._nextActiveAction._child){if(!this._nextActiveAction._child._actionManager){this._nextActiveAction._child._actionManager=this._actionManager}this._nextActiveAction=this._nextActiveAction._child}else{this._nextActiveAction=this}};Action.prototype.then=function(action){this._child=action;action._actionManager=this._actionManager;action._prepare();return action};Action.prototype._getProperty=function(propertyPath){return this._actionManager._getProperty(propertyPath)};Action.prototype._getEffectiveTarget=function(target,propertyPath){return this._actionManager._getEffectiveTarget(target,propertyPath)};Action.prototype.serialize=function(parent){};Action.prototype._serialize=function(serializedAction,parent){var serializationObject={type:1,children:[],name:serializedAction.name,properties:serializedAction.properties||[]};if(this._child){this._child.serialize(serializationObject)}if(this._condition){var serializedCondition=this._condition.serialize();serializedCondition.children.push(serializationObject);if(parent){parent.children.push(serializedCondition)}return serializedCondition}if(parent){parent.children.push(serializationObject)}return serializationObject};Action._SerializeValueAsString=function(value){if(typeof value==="number"){return value.toString()}if(typeof value==="boolean"){return value?"true":"false"}if(value instanceof BABYLON.Vector2){return value.x+", "+value.y}if(value instanceof BABYLON.Vector3){return value.x+", "+value.y+", "+value.z}if(value instanceof BABYLON.Color3){return value.r+", "+value.g+", "+value.b}if(value instanceof BABYLON.Color4){return value.r+", "+value.g+", "+value.b+", "+value.a}return value};Action._GetTargetProperty=function(target){return{name:"target",targetType:target instanceof BABYLON.Mesh?"MeshProperties":target instanceof BABYLON.Light?"LightProperties":target instanceof BABYLON.Camera?"CameraProperties":"SceneProperties",value:target instanceof BABYLON.Scene?"Scene":target.name}};return Action}();BABYLON.Action=Action})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ActionEvent=function(){function ActionEvent(source,pointerX,pointerY,meshUnderPointer,sourceEvent,additionalData){this.source=source;this.pointerX=pointerX;this.pointerY=pointerY;this.meshUnderPointer=meshUnderPointer;this.sourceEvent=sourceEvent;this.additionalData=additionalData}ActionEvent.CreateNew=function(source,evt,additionalData){var scene=source.getScene();return new ActionEvent(source,scene.pointerX,scene.pointerY,scene.meshUnderPointer,evt,additionalData)};ActionEvent.CreateNewFromSprite=function(source,scene,evt,additionalData){return new ActionEvent(source,scene.pointerX,scene.pointerY,scene.meshUnderPointer,evt,additionalData)};ActionEvent.CreateNewFromScene=function(scene,evt){return new ActionEvent(null,scene.pointerX,scene.pointerY,scene.meshUnderPointer,evt)};ActionEvent.CreateNewFromPrimitive=function(prim,pointerPos,evt,additionalData){return new ActionEvent(prim,pointerPos.x,pointerPos.y,null,evt,additionalData)};return ActionEvent}();BABYLON.ActionEvent=ActionEvent;var ActionManager=function(){function ActionManager(scene){this.actions=new Array;this.hoverCursor="";this._scene=scene;scene._actionManagers.push(this)}Object.defineProperty(ActionManager,"NothingTrigger",{get:function(){return ActionManager._NothingTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnPickTrigger",{get:function(){return ActionManager._OnPickTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnLeftPickTrigger",{get:function(){return ActionManager._OnLeftPickTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnRightPickTrigger",{get:function(){return ActionManager._OnRightPickTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnCenterPickTrigger",{get:function(){return ActionManager._OnCenterPickTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnPickDownTrigger",{get:function(){return ActionManager._OnPickDownTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnDoublePickTrigger",{get:function(){return ActionManager._OnDoublePickTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnPickUpTrigger",{get:function(){return ActionManager._OnPickUpTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnPickOutTrigger",{get:function(){return ActionManager._OnPickOutTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnLongPressTrigger",{get:function(){return ActionManager._OnLongPressTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnPointerOverTrigger",{get:function(){return ActionManager._OnPointerOverTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnPointerOutTrigger",{get:function(){return ActionManager._OnPointerOutTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnEveryFrameTrigger",{get:function(){return ActionManager._OnEveryFrameTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnIntersectionEnterTrigger",{get:function(){return ActionManager._OnIntersectionEnterTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnIntersectionExitTrigger",{get:function(){return ActionManager._OnIntersectionExitTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnKeyDownTrigger",{get:function(){return ActionManager._OnKeyDownTrigger},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"OnKeyUpTrigger",{get:function(){return ActionManager._OnKeyUpTrigger},enumerable:true,configurable:true});ActionManager.prototype.dispose=function(){var index=this._scene._actionManagers.indexOf(this);for(var i=0;i<this.actions.length;i++){var action=this.actions[i];ActionManager.Triggers[action.trigger]--;if(ActionManager.Triggers[action.trigger]===0){delete ActionManager.Triggers[action.trigger]}}if(index>-1){this._scene._actionManagers.splice(index,1)}};ActionManager.prototype.getScene=function(){return this._scene};ActionManager.prototype.hasSpecificTriggers=function(triggers){for(var index=0;index<this.actions.length;index++){var action=this.actions[index];if(triggers.indexOf(action.trigger)>-1){return true}}return false};ActionManager.prototype.hasSpecificTrigger=function(trigger){for(var index=0;index<this.actions.length;index++){var action=this.actions[index];if(action.trigger===trigger){return true}}return false};Object.defineProperty(ActionManager.prototype,"hasPointerTriggers",{get:function(){for(var index=0;index<this.actions.length;index++){var action=this.actions[index];if(action.trigger>=ActionManager._OnPickTrigger&&action.trigger<=ActionManager._OnPointerOutTrigger){return true}}return false},enumerable:true,configurable:true});Object.defineProperty(ActionManager.prototype,"hasPickTriggers",{get:function(){for(var index=0;index<this.actions.length;index++){var action=this.actions[index];if(action.trigger>=ActionManager._OnPickTrigger&&action.trigger<=ActionManager._OnPickUpTrigger){return true}}return false},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"HasTriggers",{get:function(){for(var t in ActionManager.Triggers){if(ActionManager.Triggers.hasOwnProperty(t)){return true}}return false},enumerable:true,configurable:true});Object.defineProperty(ActionManager,"HasPickTriggers",{get:function(){for(var t in ActionManager.Triggers){if(ActionManager.Triggers.hasOwnProperty(t)){var t_int=parseInt(t);if(t_int>=ActionManager._OnPickTrigger&&t_int<=ActionManager._OnPickUpTrigger){return true}}}return false},enumerable:true,configurable:true});ActionManager.HasSpecificTrigger=function(trigger){for(var t in ActionManager.Triggers){if(ActionManager.Triggers.hasOwnProperty(t)){var t_int=parseInt(t);if(t_int===trigger){return true}}}return false};ActionManager.prototype.registerAction=function(action){if(action.trigger===ActionManager.OnEveryFrameTrigger){if(this.getScene().actionManager!==this){BABYLON.Tools.Warn("OnEveryFrameTrigger can only be used with scene.actionManager");return null}}this.actions.push(action);if(ActionManager.Triggers[action.trigger]){ActionManager.Triggers[action.trigger]++}else{ActionManager.Triggers[action.trigger]=1}action._actionManager=this;action._prepare();return action};ActionManager.prototype.processTrigger=function(trigger,evt){for(var index=0;index<this.actions.length;index++){var action=this.actions[index];if(action.trigger===trigger){if(trigger===ActionManager.OnKeyUpTrigger||trigger===ActionManager.OnKeyDownTrigger){var parameter=action.getTriggerParameter();if(parameter&&parameter!==evt.sourceEvent.keyCode){if(!parameter.toLowerCase){continue}var lowerCase=parameter.toLowerCase();if(lowerCase!==evt.sourceEvent.key){var unicode=evt.sourceEvent.charCode?evt.sourceEvent.charCode:evt.sourceEvent.keyCode;var actualkey=String.fromCharCode(unicode).toLowerCase();if(actualkey!==lowerCase){continue}}}}action._executeCurrent(evt)}}};ActionManager.prototype._getEffectiveTarget=function(target,propertyPath){var properties=propertyPath.split(".");for(var index=0;index<properties.length-1;index++){target=target[properties[index]]}return target};ActionManager.prototype._getProperty=function(propertyPath){var properties=propertyPath.split(".");return properties[properties.length-1]};ActionManager.prototype.serialize=function(name){var root={children:new Array,name:name,type:3,properties:new Array};for(var i=0;i<this.actions.length;i++){var triggerObject={type:0,children:new Array,name:ActionManager.GetTriggerName(this.actions[i].trigger),properties:new Array};var triggerOptions=this.actions[i].triggerOptions;if(triggerOptions&&typeof triggerOptions!=="number"){if(triggerOptions.parameter instanceof BABYLON.Node){triggerObject.properties.push(BABYLON.Action._GetTargetProperty(triggerOptions.parameter))}else{var parameter={};BABYLON.Tools.DeepCopy(triggerOptions.parameter,parameter,["mesh"]);if(triggerOptions.parameter.mesh){parameter._meshId=triggerOptions.parameter.mesh.id}triggerObject.properties.push({name:"parameter",targetType:null,value:parameter})}}this.actions[i].serialize(triggerObject);root.children.push(triggerObject)}return root};ActionManager.Parse=function(parsedActions,object,scene){var actionManager=new BABYLON.ActionManager(scene);if(object===null)scene.actionManager=actionManager;else object.actionManager=actionManager;var instanciate=function(name,params){var newInstance=Object.create(BABYLON.Tools.Instantiate("BABYLON."+name).prototype);newInstance.constructor.apply(newInstance,params);return newInstance};var parseParameter=function(name,value,target,propertyPath){if(propertyPath===null){var floatValue=parseFloat(value);if(value==="true"||value==="false")return value==="true";else return isNaN(floatValue)?value:floatValue}var effectiveTarget=propertyPath.split(".");var values=value.split(",");for(var i=0;i<effectiveTarget.length;i++){target=target[effectiveTarget[i]]}if(typeof target==="boolean")return values[0]==="true";if(typeof target==="string")return values[0];var split=new Array;for(var i=0;i<values.length;i++)split.push(parseFloat(values[i]));if(target instanceof BABYLON.Vector3)return BABYLON.Vector3.FromArray(split);if(target instanceof BABYLON.Vector4)return BABYLON.Vector4.FromArray(split);if(target instanceof BABYLON.Color3)return BABYLON.Color3.FromArray(split);if(target instanceof BABYLON.Color4)return BABYLON.Color4.FromArray(split);return parseFloat(values[0])};var traverse=function(parsedAction,trigger,condition,action,combineArray){if(combineArray===void 0){combineArray=null}if(parsedAction.detached)return;var parameters=new Array;var target=null;var propertyPath=null;var combine=parsedAction.combine&&parsedAction.combine.length>0;if(parsedAction.type===2)parameters.push(actionManager);else parameters.push(trigger);if(combine){var actions=new Array;for(var j=0;j<parsedAction.combine.length;j++){traverse(parsedAction.combine[j],ActionManager.NothingTrigger,condition,action,actions)}parameters.push(actions)}else{for(var i=0;i<parsedAction.properties.length;i++){var value=parsedAction.properties[i].value;var name=parsedAction.properties[i].name;var targetType=parsedAction.properties[i].targetType;if(name==="target")if(targetType!==null&&targetType==="SceneProperties")value=target=scene;else value=target=scene.getNodeByName(value);else if(name==="parent")value=scene.getNodeByName(value);else if(name==="sound")value=scene.getSoundByName(value);else if(name!=="propertyPath"){if(parsedAction.type===2&&name==="operator")value=BABYLON.ValueCondition[value];else value=parseParameter(name,value,target,name==="value"?propertyPath:null)}else{propertyPath=value}parameters.push(value)}}if(combineArray===null){parameters.push(condition)}else{parameters.push(null)}if(parsedAction.name==="InterpolateValueAction"){var param=parameters[parameters.length-2];parameters[parameters.length-1]=param;parameters[parameters.length-2]=condition}var newAction=instanciate(parsedAction.name,parameters);if(newAction instanceof BABYLON.Condition&&condition!==null){var nothing=new BABYLON.DoNothingAction(trigger,condition);if(action)action.then(nothing);else actionManager.registerAction(nothing);action=nothing}if(combineArray===null){if(newAction instanceof BABYLON.Condition){condition=newAction;newAction=action}else{condition=null;if(action)action.then(newAction);else actionManager.registerAction(newAction)}}else{combineArray.push(newAction)}for(var i=0;i<parsedAction.children.length;i++)traverse(parsedAction.children[i],trigger,condition,newAction,null)};for(var i=0;i<parsedActions.children.length;i++){var triggerParams;var trigger=parsedActions.children[i];if(trigger.properties.length>0){var param=trigger.properties[0].value;var value=trigger.properties[0].targetType===null?param:scene.getMeshByName(param);if(value._meshId){value.mesh=scene.getMeshByID(value._meshId)}triggerParams={trigger:ActionManager[trigger.name],parameter:value}}else triggerParams=ActionManager[trigger.name];for(var j=0;j<trigger.children.length;j++){if(!trigger.detached)traverse(trigger.children[j],triggerParams,null,null)}}};ActionManager.GetTriggerName=function(trigger){switch(trigger){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnPickUpTrigger";case 7:return"OnLongPressTrigger";case 8:return"OnPointerOverTrigger";case 9:return"OnPointerOutTrigger";case 10:return"OnEveryFrameTrigger";case 11:return"OnIntersectionEnterTrigger";case 12:return"OnIntersectionExitTrigger";case 13:return"OnKeyDownTrigger";case 14:return"OnKeyUpTrigger";case 15:return"OnPickOutTrigger";default:return""}};ActionManager._NothingTrigger=0;ActionManager._OnPickTrigger=1;ActionManager._OnLeftPickTrigger=2;ActionManager._OnRightPickTrigger=3;ActionManager._OnCenterPickTrigger=4;ActionManager._OnPickDownTrigger=5;ActionManager._OnDoublePickTrigger=6;ActionManager._OnPickUpTrigger=7;ActionManager._OnLongPressTrigger=8;ActionManager._OnPointerOverTrigger=9;ActionManager._OnPointerOutTrigger=10;ActionManager._OnEveryFrameTrigger=11;ActionManager._OnIntersectionEnterTrigger=12;ActionManager._OnIntersectionExitTrigger=13;ActionManager._OnKeyDownTrigger=14;ActionManager._OnKeyUpTrigger=15;ActionManager._OnPickOutTrigger=16;ActionManager.Triggers={};return ActionManager}();BABYLON.ActionManager=ActionManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var InterpolateValueAction=function(_super){__extends(InterpolateValueAction,_super);function InterpolateValueAction(triggerOptions,target,propertyPath,value,duration,condition,stopOtherAnimations,onInterpolationDone){if(duration===void 0){duration=1e3}var _this=_super.call(this,triggerOptions,condition)||this;_this.propertyPath=propertyPath;_this.value=value;_this.duration=duration;_this.stopOtherAnimations=stopOtherAnimations;_this.onInterpolationDone=onInterpolationDone;_this.onInterpolationDoneObservable=new BABYLON.Observable;_this._target=_this._effectiveTarget=target;return _this}InterpolateValueAction.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)};InterpolateValueAction.prototype.execute=function(){var _this=this;var scene=this._actionManager.getScene();var keys=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];var dataType;if(typeof this.value==="number"){dataType=BABYLON.Animation.ANIMATIONTYPE_FLOAT}else if(this.value instanceof BABYLON.Color3){dataType=BABYLON.Animation.ANIMATIONTYPE_COLOR3}else if(this.value instanceof BABYLON.Vector3){dataType=BABYLON.Animation.ANIMATIONTYPE_VECTOR3}else if(this.value instanceof BABYLON.Matrix){dataType=BABYLON.Animation.ANIMATIONTYPE_MATRIX}else if(this.value instanceof BABYLON.Quaternion){dataType=BABYLON.Animation.ANIMATIONTYPE_QUATERNION}else{BABYLON.Tools.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}var animation=new BABYLON.Animation("InterpolateValueAction",this._property,100*(1e3/this.duration),dataType,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);animation.setKeys(keys);if(this.stopOtherAnimations){scene.stopAnimation(this._effectiveTarget)}var wrapper=function(){_this.onInterpolationDoneObservable.notifyObservers(_this);if(_this.onInterpolationDone){_this.onInterpolationDone()}};scene.beginDirectAnimation(this._effectiveTarget,[animation],0,100,false,1,wrapper)};InterpolateValueAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"InterpolateValueAction",properties:[BABYLON.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:BABYLON.Action._SerializeValueAsString(this.value)},{name:"duration",value:BABYLON.Action._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:BABYLON.Action._SerializeValueAsString(this.stopOtherAnimations)||false}]},parent)};return InterpolateValueAction}(BABYLON.Action);BABYLON.InterpolateValueAction=InterpolateValueAction})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SwitchBooleanAction=function(_super){__extends(SwitchBooleanAction,_super);function SwitchBooleanAction(triggerOptions,target,propertyPath,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this.propertyPath=propertyPath;_this._target=_this._effectiveTarget=target;return _this}SwitchBooleanAction.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)};SwitchBooleanAction.prototype.execute=function(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]};SwitchBooleanAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"SwitchBooleanAction",properties:[BABYLON.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},parent)};return SwitchBooleanAction}(BABYLON.Action);BABYLON.SwitchBooleanAction=SwitchBooleanAction;var SetStateAction=function(_super){__extends(SetStateAction,_super);function SetStateAction(triggerOptions,target,value,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this.value=value;_this._target=target;return _this}SetStateAction.prototype.execute=function(){this._target.state=this.value};SetStateAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"SetStateAction",properties:[BABYLON.Action._GetTargetProperty(this._target),{name:"value",value:this.value}]},parent)};return SetStateAction}(BABYLON.Action);BABYLON.SetStateAction=SetStateAction;var SetValueAction=function(_super){__extends(SetValueAction,_super);function SetValueAction(triggerOptions,target,propertyPath,value,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this.propertyPath=propertyPath;_this.value=value;_this._target=_this._effectiveTarget=target;return _this}SetValueAction.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)};SetValueAction.prototype.execute=function(){this._effectiveTarget[this._property]=this.value;if(this._target.markAsDirty){this._target.markAsDirty(this._property)}};SetValueAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"SetValueAction",properties:[BABYLON.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:BABYLON.Action._SerializeValueAsString(this.value)}]},parent)};return SetValueAction}(BABYLON.Action);BABYLON.SetValueAction=SetValueAction;var IncrementValueAction=function(_super){__extends(IncrementValueAction,_super);function IncrementValueAction(triggerOptions,target,propertyPath,value,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this.propertyPath=propertyPath;_this.value=value;_this._target=_this._effectiveTarget=target;return _this}IncrementValueAction.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath);if(typeof this._effectiveTarget[this._property]!=="number"){BABYLON.Tools.Warn("Warning: IncrementValueAction can only be used with number values")}};IncrementValueAction.prototype.execute=function(){this._effectiveTarget[this._property]+=this.value;if(this._target.markAsDirty){this._target.markAsDirty(this._property)}};IncrementValueAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"IncrementValueAction",properties:[BABYLON.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:BABYLON.Action._SerializeValueAsString(this.value)}]},parent)};return IncrementValueAction}(BABYLON.Action);BABYLON.IncrementValueAction=IncrementValueAction;var PlayAnimationAction=function(_super){__extends(PlayAnimationAction,_super);function PlayAnimationAction(triggerOptions,target,from,to,loop,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this.from=from;_this.to=to;_this.loop=loop;_this._target=target;return _this}PlayAnimationAction.prototype._prepare=function(){};PlayAnimationAction.prototype.execute=function(){var scene=this._actionManager.getScene();scene.beginAnimation(this._target,this.from,this.to,this.loop)};PlayAnimationAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"PlayAnimationAction",properties:[BABYLON.Action._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:BABYLON.Action._SerializeValueAsString(this.loop)||false}]},parent)};return PlayAnimationAction}(BABYLON.Action);BABYLON.PlayAnimationAction=PlayAnimationAction;var StopAnimationAction=function(_super){__extends(StopAnimationAction,_super);function StopAnimationAction(triggerOptions,target,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this._target=target;return _this}StopAnimationAction.prototype._prepare=function(){};StopAnimationAction.prototype.execute=function(){var scene=this._actionManager.getScene();scene.stopAnimation(this._target)};StopAnimationAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"StopAnimationAction",properties:[BABYLON.Action._GetTargetProperty(this._target)]},parent)};return StopAnimationAction}(BABYLON.Action);BABYLON.StopAnimationAction=StopAnimationAction;var DoNothingAction=function(_super){__extends(DoNothingAction,_super);function DoNothingAction(triggerOptions,condition){if(triggerOptions===void 0){triggerOptions=BABYLON.ActionManager.NothingTrigger}return _super.call(this,triggerOptions,condition)||this}DoNothingAction.prototype.execute=function(){};DoNothingAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"DoNothingAction",properties:[]},parent)};return DoNothingAction}(BABYLON.Action);BABYLON.DoNothingAction=DoNothingAction;var CombineAction=function(_super){__extends(CombineAction,_super);function CombineAction(triggerOptions,children,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this.children=children;return _this}CombineAction.prototype._prepare=function(){for(var index=0;index<this.children.length;index++){this.children[index]._actionManager=this._actionManager;this.children[index]._prepare()}};CombineAction.prototype.execute=function(evt){for(var index=0;index<this.children.length;index++){this.children[index].execute(evt)}};CombineAction.prototype.serialize=function(parent){var serializationObject=_super.prototype._serialize.call(this,{name:"CombineAction",properties:[],combine:[]},parent);for(var i=0;i<this.children.length;i++){serializationObject.combine.push(this.children[i].serialize(null))}return serializationObject};return CombineAction}(BABYLON.Action);BABYLON.CombineAction=CombineAction;var ExecuteCodeAction=function(_super){__extends(ExecuteCodeAction,_super);function ExecuteCodeAction(triggerOptions,func,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this.func=func;return _this}ExecuteCodeAction.prototype.execute=function(evt){this.func(evt)};return ExecuteCodeAction}(BABYLON.Action);BABYLON.ExecuteCodeAction=ExecuteCodeAction;var SetParentAction=function(_super){__extends(SetParentAction,_super);function SetParentAction(triggerOptions,target,parent,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this._target=target;_this._parent=parent;return _this}SetParentAction.prototype._prepare=function(){};SetParentAction.prototype.execute=function(){if(this._target.parent===this._parent){return}var invertParentWorldMatrix=this._parent.getWorldMatrix().clone();invertParentWorldMatrix.invert();this._target.position=BABYLON.Vector3.TransformCoordinates(this._target.position,invertParentWorldMatrix);this._target.parent=this._parent};SetParentAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"SetParentAction",properties:[BABYLON.Action._GetTargetProperty(this._target),BABYLON.Action._GetTargetProperty(this._parent)]},parent)};return SetParentAction}(BABYLON.Action);BABYLON.SetParentAction=SetParentAction;var PlaySoundAction=function(_super){__extends(PlaySoundAction,_super);function PlaySoundAction(triggerOptions,sound,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this._sound=sound;return _this}PlaySoundAction.prototype._prepare=function(){};PlaySoundAction.prototype.execute=function(){if(this._sound!==undefined)this._sound.play()};PlaySoundAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},parent)};return PlaySoundAction}(BABYLON.Action);BABYLON.PlaySoundAction=PlaySoundAction;var StopSoundAction=function(_super){__extends(StopSoundAction,_super);function StopSoundAction(triggerOptions,sound,condition){var _this=_super.call(this,triggerOptions,condition)||this;_this._sound=sound;return _this}StopSoundAction.prototype._prepare=function(){};StopSoundAction.prototype.execute=function(){if(this._sound!==undefined)this._sound.stop()};StopSoundAction.prototype.serialize=function(parent){return _super.prototype._serialize.call(this,{name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},parent)};return StopSoundAction}(BABYLON.Action);BABYLON.StopSoundAction=StopSoundAction})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SpriteManager=function(){function SpriteManager(name,imgUrl,capacity,cellSize,scene,epsilon,samplingMode){if(epsilon===void 0){epsilon=.01}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}this.name=name;this.sprites=new Array;this.renderingGroupId=0;this.layerMask=268435455;this.fogEnabled=true;this.isPickable=false;this.onDisposeObservable=new BABYLON.Observable;this._vertexBuffers={};this._capacity=capacity;this._spriteTexture=new BABYLON.Texture(imgUrl,scene,true,false,samplingMode);this._spriteTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;this._spriteTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;if(cellSize.width&&cellSize.height){this.cellWidth=cellSize.width;this.cellHeight=cellSize.height}else if(cellSize!==undefined){this.cellWidth=cellSize;this.cellHeight=cellSize}else{return}this._epsilon=epsilon;this._scene=scene;this._scene.spriteManagers.push(this);var indices=[];var index=0;for(var count=0;count<capacity;count++){indices.push(index);indices.push(index+1);indices.push(index+2);indices.push(index);indices.push(index+2);indices.push(index+3);index+=4}this._indexBuffer=scene.getEngine().createIndexBuffer(indices);this._vertexData=new Float32Array(capacity*16*4);this._buffer=new BABYLON.Buffer(scene.getEngine(),this._vertexData,true,16);var positions=this._buffer.createVertexBuffer(BABYLON.VertexBuffer.PositionKind,0,4);var options=this._buffer.createVertexBuffer("options",4,4);var cellInfo=this._buffer.createVertexBuffer("cellInfo",8,4);var colors=this._buffer.createVertexBuffer(BABYLON.VertexBuffer.ColorKind,12,4);this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=positions;this._vertexBuffers["options"]=options;this._vertexBuffers["cellInfo"]=cellInfo;this._vertexBuffers[BABYLON.VertexBuffer.ColorKind]=colors;this._effectBase=this._scene.getEngine().createEffect("sprites",[BABYLON.VertexBuffer.PositionKind,"options","cellInfo",BABYLON.VertexBuffer.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],"");this._effectFog=this._scene.getEngine().createEffect("sprites",[BABYLON.VertexBuffer.PositionKind,"options","cellInfo",BABYLON.VertexBuffer.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG")}Object.defineProperty(SpriteManager.prototype,"onDispose",{set:function(callback){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(SpriteManager.prototype,"texture",{get:function(){return this._spriteTexture},set:function(value){this._spriteTexture=value},enumerable:true,configurable:true});SpriteManager.prototype._appendSpriteVertex=function(index,sprite,offsetX,offsetY,rowSize){var arrayOffset=index*16;if(offsetX===0)offsetX=this._epsilon;else if(offsetX===1)offsetX=1-this._epsilon;if(offsetY===0)offsetY=this._epsilon;else if(offsetY===1)offsetY=1-this._epsilon;this._vertexData[arrayOffset]=sprite.position.x;this._vertexData[arrayOffset+1]=sprite.position.y;this._vertexData[arrayOffset+2]=sprite.position.z;this._vertexData[arrayOffset+3]=sprite.angle;this._vertexData[arrayOffset+4]=sprite.width;this._vertexData[arrayOffset+5]=sprite.height;this._vertexData[arrayOffset+6]=offsetX;this._vertexData[arrayOffset+7]=offsetY;this._vertexData[arrayOffset+8]=sprite.invertU?1:0;this._vertexData[arrayOffset+9]=sprite.invertV?1:0;var offset=sprite.cellIndex/rowSize>>0;this._vertexData[arrayOffset+10]=sprite.cellIndex-offset*rowSize;this._vertexData[arrayOffset+11]=offset;this._vertexData[arrayOffset+12]=sprite.color.r;this._vertexData[arrayOffset+13]=sprite.color.g;this._vertexData[arrayOffset+14]=sprite.color.b;this._vertexData[arrayOffset+15]=sprite.color.a};SpriteManager.prototype.intersects=function(ray,camera,predicate,fastCheck){var count=Math.min(this._capacity,this.sprites.length);var min=BABYLON.Vector3.Zero();var max=BABYLON.Vector3.Zero();var distance=Number.MAX_VALUE;var currentSprite;var cameraSpacePosition=BABYLON.Vector3.Zero();var cameraView=camera.getViewMatrix();for(var index=0;index<count;index++){var sprite=this.sprites[index];if(!sprite){continue}if(predicate){if(!predicate(sprite)){continue}}else if(!sprite.isPickable){continue}BABYLON.Vector3.TransformCoordinatesToRef(sprite.position,cameraView,cameraSpacePosition);min.copyFromFloats(cameraSpacePosition.x-sprite.width/2,cameraSpacePosition.y-sprite.height/2,cameraSpacePosition.z);max.copyFromFloats(cameraSpacePosition.x+sprite.width/2,cameraSpacePosition.y+sprite.height/2,cameraSpacePosition.z);if(ray.intersectsBoxMinMax(min,max)){var currentDistance=BABYLON.Vector3.Distance(cameraSpacePosition,ray.origin);if(distance>currentDistance){distance=currentDistance;currentSprite=sprite;if(fastCheck){break}}}}if(currentSprite){var result=new BABYLON.PickingInfo;result.hit=true;result.pickedSprite=currentSprite;result.distance=distance;return result}return null};SpriteManager.prototype.render=function(){if(!this._effectBase.isReady()||!this._effectFog.isReady()||!this._spriteTexture||!this._spriteTexture.isReady())return;var engine=this._scene.getEngine();var baseSize=this._spriteTexture.getBaseSize();var deltaTime=engine.getDeltaTime();var max=Math.min(this._capacity,this.sprites.length);var rowSize=baseSize.width/this.cellWidth;var offset=0;for(var index=0;index<max;index++){var sprite=this.sprites[index];if(!sprite){continue}sprite._animate(deltaTime);this._appendSpriteVertex(offset++,sprite,0,0,rowSize);this._appendSpriteVertex(offset++,sprite,1,0,rowSize);this._appendSpriteVertex(offset++,sprite,1,1,rowSize);this._appendSpriteVertex(offset++,sprite,0,1,rowSize)}this._buffer.update(this._vertexData);var effect=this._effectBase;if(this._scene.fogEnabled&&this._scene.fogMode!==BABYLON.Scene.FOGMODE_NONE&&this.fogEnabled){effect=this._effectFog}engine.enableEffect(effect);var viewMatrix=this._scene.getViewMatrix();effect.setTexture("diffuseSampler",this._spriteTexture);effect.setMatrix("view",viewMatrix);effect.setMatrix("projection",this._scene.getProjectionMatrix());effect.setFloat2("textureInfos",this.cellWidth/baseSize.width,this.cellHeight/baseSize.height);if(this._scene.fogEnabled&&this._scene.fogMode!==BABYLON.Scene.FOGMODE_NONE&&this.fogEnabled){effect.setFloat4("vFogInfos",this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity);effect.setColor3("vFogColor",this._scene.fogColor)}engine.bindBuffers(this._vertexBuffers,this._indexBuffer,effect);engine.setDepthFunctionToLessOrEqual();effect.setBool("alphaTest",true);engine.setColorWrite(false);engine.draw(true,0,max*6);engine.setColorWrite(true);effect.setBool("alphaTest",false);engine.setAlphaMode(BABYLON.Engine.ALPHA_COMBINE);engine.draw(true,0,max*6);engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE)};SpriteManager.prototype.dispose=function(){if(this._buffer){this._buffer.dispose();this._buffer=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}if(this._spriteTexture){this._spriteTexture.dispose();this._spriteTexture=null}var index=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(index,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()};return SpriteManager}();BABYLON.SpriteManager=SpriteManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Sprite=function(){function Sprite(name,manager){this.name=name;this.color=new BABYLON.Color4(1,1,1,1);this.width=1;this.height=1;this.angle=0;this.cellIndex=0;this.invertU=0;this.invertV=0;this.animations=new Array;this.isPickable=false;this._animationStarted=false;this._loopAnimation=false;this._fromIndex=0;this._toIndex=0;this._delay=0;this._direction=1;this._time=0;this._manager=manager;this._manager.sprites.push(this);this.position=BABYLON.Vector3.Zero()}Object.defineProperty(Sprite.prototype,"size",{get:function(){return this.width},set:function(value){this.width=value;this.height=value},enumerable:true,configurable:true});Sprite.prototype.playAnimation=function(from,to,loop,delay,onAnimationEnd){this._fromIndex=from;this._toIndex=to;this._loopAnimation=loop;this._delay=delay;this._animationStarted=true;this._direction=from<to?1:-1;this.cellIndex=from;this._time=0;this._onAnimationEnd=onAnimationEnd};Sprite.prototype.stopAnimation=function(){this._animationStarted=false};Sprite.prototype._animate=function(deltaTime){if(!this._animationStarted)return;this._time+=deltaTime;if(this._time>this._delay){this._time=this._time%this._delay;this.cellIndex+=this._direction;if(this.cellIndex>this._toIndex){if(this._loopAnimation){this.cellIndex=this._fromIndex}else{this.cellIndex=this._toIndex;this._animationStarted=false;if(this._onAnimationEnd){this._onAnimationEnd()}if(this.disposeWhenFinishedAnimating){this.dispose()}}}}};Sprite.prototype.dispose=function(){for(var i=0;i<this._manager.sprites.length;i++){if(this._manager.sprites[i]==this){this._manager.sprites.splice(i,1)}}};return Sprite}();BABYLON.Sprite=Sprite})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var IntersectionInfo=function(){function IntersectionInfo(bu,bv,distance){this.bu=bu;this.bv=bv;this.distance=distance;this.faceId=0;this.subMeshId=0}return IntersectionInfo}();BABYLON.IntersectionInfo=IntersectionInfo;var PickingInfo=function(){function PickingInfo(){this.hit=false;this.distance=0;this.pickedPoint=null;this.pickedMesh=null;this.bu=0;this.bv=0;this.faceId=-1;this.subMeshId=0;this.pickedSprite=null}PickingInfo.prototype.getNormal=function(useWorldCoordinates,useVerticesNormals){if(useWorldCoordinates===void 0){useWorldCoordinates=false}if(useVerticesNormals===void 0){useVerticesNormals=true}if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){return null}var indices=this.pickedMesh.getIndices();var result;if(useVerticesNormals){var normals=this.pickedMesh.getVerticesData(BABYLON.VertexBuffer.NormalKind);var normal0=BABYLON.Vector3.FromArray(normals,indices[this.faceId*3]*3);var normal1=BABYLON.Vector3.FromArray(normals,indices[this.faceId*3+1]*3);var normal2=BABYLON.Vector3.FromArray(normals,indices[this.faceId*3+2]*3);normal0=normal0.scale(this.bu);normal1=normal1.scale(this.bv);normal2=normal2.scale(1-this.bu-this.bv);result=new BABYLON.Vector3(normal0.x+normal1.x+normal2.x,normal0.y+normal1.y+normal2.y,normal0.z+normal1.z+normal2.z)}else{var positions=this.pickedMesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);var vertex1=BABYLON.Vector3.FromArray(positions,indices[this.faceId*3]*3);var vertex2=BABYLON.Vector3.FromArray(positions,indices[this.faceId*3+1]*3);var vertex3=BABYLON.Vector3.FromArray(positions,indices[this.faceId*3+2]*3);var p1p2=vertex1.subtract(vertex2);var p3p2=vertex3.subtract(vertex2);result=BABYLON.Vector3.Cross(p1p2,p3p2)}if(useWorldCoordinates){result=BABYLON.Vector3.TransformNormal(result,this.pickedMesh.getWorldMatrix())}return BABYLON.Vector3.Normalize(result)};PickingInfo.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){return null}var indices=this.pickedMesh.getIndices();var uvs=this.pickedMesh.getVerticesData(BABYLON.VertexBuffer.UVKind);var uv0=BABYLON.Vector2.FromArray(uvs,indices[this.faceId*3]*2);var uv1=BABYLON.Vector2.FromArray(uvs,indices[this.faceId*3+1]*2);var uv2=BABYLON.Vector2.FromArray(uvs,indices[this.faceId*3+2]*2);uv0=uv0.scale(1-this.bu-this.bv);uv1=uv1.scale(this.bu);uv2=uv2.scale(this.bv);return new BABYLON.Vector2(uv0.x+uv1.x+uv2.x,uv0.y+uv1.y+uv2.y)};return PickingInfo}();BABYLON.PickingInfo=PickingInfo})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Ray=function(){function Ray(origin,direction,length){if(length===void 0){length=Number.MAX_VALUE}this.origin=origin;this.direction=direction;this.length=length}Ray.prototype.intersectsBoxMinMax=function(minimum,maximum){var d=0;var maxValue=Number.MAX_VALUE;var inv;var min;var max;var temp;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<minimum.x||this.origin.x>maximum.x){return false}}else{inv=1/this.direction.x;min=(minimum.x-this.origin.x)*inv;max=(maximum.x-this.origin.x)*inv;if(max===-Infinity){max=Infinity}if(min>max){temp=min;min=max;max=temp}d=Math.max(min,d);maxValue=Math.min(max,maxValue);if(d>maxValue){return false}}if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<minimum.y||this.origin.y>maximum.y){return false}}else{inv=1/this.direction.y;min=(minimum.y-this.origin.y)*inv;max=(maximum.y-this.origin.y)*inv;if(max===-Infinity){max=Infinity}if(min>max){temp=min;min=max;max=temp}d=Math.max(min,d);maxValue=Math.min(max,maxValue);if(d>maxValue){return false}}if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<minimum.z||this.origin.z>maximum.z){return false}}else{inv=1/this.direction.z;min=(minimum.z-this.origin.z)*inv;max=(maximum.z-this.origin.z)*inv;if(max===-Infinity){max=Infinity}if(min>max){temp=min;min=max;max=temp}d=Math.max(min,d);maxValue=Math.min(max,maxValue);if(d>maxValue){return false}}return true};Ray.prototype.intersectsBox=function(box){return this.intersectsBoxMinMax(box.minimum,box.maximum)};Ray.prototype.intersectsSphere=function(sphere){var x=sphere.center.x-this.origin.x;var y=sphere.center.y-this.origin.y;var z=sphere.center.z-this.origin.z;var pyth=x*x+y*y+z*z;var rr=sphere.radius*sphere.radius;if(pyth<=rr){return true}var dot=x*this.direction.x+y*this.direction.y+z*this.direction.z;if(dot<0){return false}var temp=pyth-dot*dot;return temp<=rr};Ray.prototype.intersectsTriangle=function(vertex0,vertex1,vertex2){if(!this._edge1){this._edge1=BABYLON.Vector3.Zero();this._edge2=BABYLON.Vector3.Zero();this._pvec=BABYLON.Vector3.Zero();this._tvec=BABYLON.Vector3.Zero();this._qvec=BABYLON.Vector3.Zero()}vertex1.subtractToRef(vertex0,this._edge1);vertex2.subtractToRef(vertex0,this._edge2);BABYLON.Vector3.CrossToRef(this.direction,this._edge2,this._pvec);var det=BABYLON.Vector3.Dot(this._edge1,this._pvec);if(det===0){return null}var invdet=1/det;this.origin.subtractToRef(vertex0,this._tvec);var bu=BABYLON.Vector3.Dot(this._tvec,this._pvec)*invdet;if(bu<0||bu>1){return null}BABYLON.Vector3.CrossToRef(this._tvec,this._edge1,this._qvec);var bv=BABYLON.Vector3.Dot(this.direction,this._qvec)*invdet;if(bv<0||bu+bv>1){return null}var distance=BABYLON.Vector3.Dot(this._edge2,this._qvec)*invdet;if(distance>this.length){return null}return new BABYLON.IntersectionInfo(bu,bv,distance)};Ray.prototype.intersectsPlane=function(plane){var distance;var result1=BABYLON.Vector3.Dot(plane.normal,this.direction);if(Math.abs(result1)<9.99999997475243e-7){return null}else{var result2=BABYLON.Vector3.Dot(plane.normal,this.origin);distance=(-plane.d-result2)/result1;if(distance<0){if(distance<-9.99999997475243e-7){return null}else{return 0}}return distance}};Ray.prototype.intersectsMesh=function(mesh,fastCheck){var tm=BABYLON.Tmp.Matrix[0];mesh.getWorldMatrix().invertToRef(tm);if(this._tmpRay){Ray.TransformToRef(this,tm,this._tmpRay)}else{this._tmpRay=Ray.Transform(this,tm)}return mesh.intersects(this._tmpRay,fastCheck)};Ray.prototype.intersectsMeshes=function(meshes,fastCheck,results){if(results){results.length=0}else{results=[]}for(var i=0;i<meshes.length;i++){var pickInfo=this.intersectsMesh(meshes[i],fastCheck);if(pickInfo.hit){results.push(pickInfo)}}results.sort(this._comparePickingInfo);return results};Ray.prototype._comparePickingInfo=function(pickingInfoA,pickingInfoB){if(pickingInfoA.distance<pickingInfoB.distance){return-1}else if(pickingInfoA.distance>pickingInfoB.distance){return 1}else{return 0}};Ray.prototype.intersectionSegment=function(sega,segb,threshold){var rsegb=this.origin.add(this.direction.multiplyByFloats(Ray.rayl,Ray.rayl,Ray.rayl));var u=segb.subtract(sega);var v=rsegb.subtract(this.origin);var w=sega.subtract(this.origin);var a=BABYLON.Vector3.Dot(u,u);var b=BABYLON.Vector3.Dot(u,v);var c=BABYLON.Vector3.Dot(v,v);var d=BABYLON.Vector3.Dot(u,w);var e=BABYLON.Vector3.Dot(v,w);var D=a*c-b*b;var sc,sN,sD=D;var tc,tN,tD=D;if(D<Ray.smallnum){sN=0;sD=1;tN=e;tD=c}else{sN=b*e-c*d;tN=a*e-b*d;if(sN<0){sN=0;tN=e;tD=c}else if(sN>sD){sN=sD;tN=e+b;tD=c}}if(tN<0){tN=0;if(-d<0){sN=0}else if(-d>a)sN=sD;else{sN=-d;sD=a}}else if(tN>tD){tN=tD;if(-d+b<0){sN=0}else if(-d+b>a){sN=sD}else{sN=-d+b;sD=a}}sc=Math.abs(sN)<Ray.smallnum?0:sN/sD;tc=Math.abs(tN)<Ray.smallnum?0:tN/tD;var qtc=v.multiplyByFloats(tc,tc,tc);var dP=w.add(u.multiplyByFloats(sc,sc,sc)).subtract(qtc);var isIntersected=tc>0&&tc<=this.length&&dP.lengthSquared()<threshold*threshold;if(isIntersected){return qtc.length()}return-1};Ray.CreateNew=function(x,y,viewportWidth,viewportHeight,world,view,projection){var start=BABYLON.Vector3.Unproject(new BABYLON.Vector3(x,y,0),viewportWidth,viewportHeight,world,view,projection);var end=BABYLON.Vector3.Unproject(new BABYLON.Vector3(x,y,1),viewportWidth,viewportHeight,world,view,projection);var direction=end.subtract(start);direction.normalize();return new Ray(start,direction)};Ray.CreateNewFromTo=function(origin,end,world){if(world===void 0){world=BABYLON.Matrix.Identity()}var direction=end.subtract(origin);var length=Math.sqrt(direction.x*direction.x+direction.y*direction.y+direction.z*direction.z);direction.normalize();return Ray.Transform(new Ray(origin,direction,length),world)};Ray.Transform=function(ray,matrix){var result=new Ray(new BABYLON.Vector3(0,0,0),new BABYLON.Vector3(0,0,0));Ray.TransformToRef(ray,matrix,result);return result};Ray.TransformToRef=function(ray,matrix,result){BABYLON.Vector3.TransformCoordinatesToRef(ray.origin,matrix,result.origin);BABYLON.Vector3.TransformNormalToRef(ray.direction,matrix,result.direction);result.length=ray.length;var dir=result.direction;var len=dir.length();if(!(len===0||len===1)){var num=1/len;dir.x*=num;dir.y*=num;dir.z*=num;result.length*=len}};Ray.smallnum=1e-8;Ray.rayl=1e9;return Ray}();BABYLON.Ray=Ray})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var intersectBoxAASphere=function(boxMin,boxMax,sphereCenter,sphereRadius){if(boxMin.x>sphereCenter.x+sphereRadius)return false;if(sphereCenter.x-sphereRadius>boxMax.x)return false;if(boxMin.y>sphereCenter.y+sphereRadius)return false;if(sphereCenter.y-sphereRadius>boxMax.y)return false;if(boxMin.z>sphereCenter.z+sphereRadius)return false;if(sphereCenter.z-sphereRadius>boxMax.z)return false;return true};var getLowestRoot=function(){var result={root:0,found:false};return function(a,b,c,maxR){result.root=0;result.found=false;var determinant=b*b-4*a*c;if(determinant<0)return result;var sqrtD=Math.sqrt(determinant);var r1=(-b-sqrtD)/(2*a);var r2=(-b+sqrtD)/(2*a);if(r1>r2){var temp=r2;r2=r1;r1=temp}if(r1>0&&r1<maxR){result.root=r1;result.found=true;return result}if(r2>0&&r2<maxR){result.root=r2;result.found=true;return result}return result}}();var Collider=function(){function Collider(){this.radius=BABYLON.Vector3.One();this.retry=0;this.basePointWorld=BABYLON.Vector3.Zero();this.velocityWorld=BABYLON.Vector3.Zero();this.normalizedVelocity=BABYLON.Vector3.Zero();this._collisionPoint=BABYLON.Vector3.Zero();this._planeIntersectionPoint=BABYLON.Vector3.Zero();this._tempVector=BABYLON.Vector3.Zero();this._tempVector2=BABYLON.Vector3.Zero();this._tempVector3=BABYLON.Vector3.Zero();this._tempVector4=BABYLON.Vector3.Zero();this._edge=BABYLON.Vector3.Zero();this._baseToVertex=BABYLON.Vector3.Zero();this._destinationPoint=BABYLON.Vector3.Zero();this._slidePlaneNormal=BABYLON.Vector3.Zero();this._displacementVector=BABYLON.Vector3.Zero();this._collisionMask=-1}Object.defineProperty(Collider.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(mask){this._collisionMask=!isNaN(mask)?mask:-1},enumerable:true,configurable:true});Collider.prototype._initialize=function(source,dir,e){this.velocity=dir;BABYLON.Vector3.NormalizeToRef(dir,this.normalizedVelocity);this.basePoint=source;source.multiplyToRef(this.radius,this.basePointWorld);dir.multiplyToRef(this.radius,this.velocityWorld);this.velocityWorldLength=this.velocityWorld.length();this.epsilon=e;this.collisionFound=false};Collider.prototype._checkPointInTriangle=function(point,pa,pb,pc,n){pa.subtractToRef(point,this._tempVector);pb.subtractToRef(point,this._tempVector2);BABYLON.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var d=BABYLON.Vector3.Dot(this._tempVector4,n);if(d<0)return false;pc.subtractToRef(point,this._tempVector3);BABYLON.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4);d=BABYLON.Vector3.Dot(this._tempVector4,n);if(d<0)return false;BABYLON.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4);d=BABYLON.Vector3.Dot(this._tempVector4,n);return d>=0};Collider.prototype._canDoCollision=function(sphereCenter,sphereRadius,vecMin,vecMax){var distance=BABYLON.Vector3.Distance(this.basePointWorld,sphereCenter);var max=Math.max(this.radius.x,this.radius.y,this.radius.z);if(distance>this.velocityWorldLength+max+sphereRadius){return false}if(!intersectBoxAASphere(vecMin,vecMax,this.basePointWorld,this.velocityWorldLength+max))return false;return true};Collider.prototype._testTriangle=function(faceIndex,trianglePlaneArray,p1,p2,p3,hasMaterial){var t0;var embeddedInPlane=false;if(!trianglePlaneArray){trianglePlaneArray=[]}if(!trianglePlaneArray[faceIndex]){trianglePlaneArray[faceIndex]=new BABYLON.Plane(0,0,0,0);trianglePlaneArray[faceIndex].copyFromPoints(p1,p2,p3)}var trianglePlane=trianglePlaneArray[faceIndex];if(!hasMaterial&&!trianglePlane.isFrontFacingTo(this.normalizedVelocity,0))return;var signedDistToTrianglePlane=trianglePlane.signedDistanceTo(this.basePoint);var normalDotVelocity=BABYLON.Vector3.Dot(trianglePlane.normal,this.velocity);if(normalDotVelocity==0){if(Math.abs(signedDistToTrianglePlane)>=1)return;embeddedInPlane=true;t0=0}else{t0=(-1-signedDistToTrianglePlane)/normalDotVelocity;var t1=(1-signedDistToTrianglePlane)/normalDotVelocity;if(t0>t1){var temp=t1;t1=t0;t0=temp}if(t0>1||t1<0)return;if(t0<0)t0=0;if(t0>1)t0=1}this._collisionPoint.copyFromFloats(0,0,0);var found=false;var t=1;if(!embeddedInPlane){this.basePoint.subtractToRef(trianglePlane.normal,this._planeIntersectionPoint);this.velocity.scaleToRef(t0,this._tempVector);this._planeIntersectionPoint.addInPlace(this._tempVector);if(this._checkPointInTriangle(this._planeIntersectionPoint,p1,p2,p3,trianglePlane.normal)){found=true;t=t0;this._collisionPoint.copyFrom(this._planeIntersectionPoint)}}if(!found){var velocitySquaredLength=this.velocity.lengthSquared();var a=velocitySquaredLength;this.basePoint.subtractToRef(p1,this._tempVector);var b=2*BABYLON.Vector3.Dot(this.velocity,this._tempVector);var c=this._tempVector.lengthSquared()-1;var lowestRoot=getLowestRoot(a,b,c,t);if(lowestRoot.found){t=lowestRoot.root;found=true;this._collisionPoint.copyFrom(p1)}this.basePoint.subtractToRef(p2,this._tempVector);b=2*BABYLON.Vector3.Dot(this.velocity,this._tempVector);c=this._tempVector.lengthSquared()-1;lowestRoot=getLowestRoot(a,b,c,t);if(lowestRoot.found){t=lowestRoot.root;found=true;this._collisionPoint.copyFrom(p2)}this.basePoint.subtractToRef(p3,this._tempVector);b=2*BABYLON.Vector3.Dot(this.velocity,this._tempVector);c=this._tempVector.lengthSquared()-1;lowestRoot=getLowestRoot(a,b,c,t);if(lowestRoot.found){t=lowestRoot.root;found=true;this._collisionPoint.copyFrom(p3)}p2.subtractToRef(p1,this._edge);p1.subtractToRef(this.basePoint,this._baseToVertex);var edgeSquaredLength=this._edge.lengthSquared();var edgeDotVelocity=BABYLON.Vector3.Dot(this._edge,this.velocity);var edgeDotBaseToVertex=BABYLON.Vector3.Dot(this._edge,this._baseToVertex);a=edgeSquaredLength*-velocitySquaredLength+edgeDotVelocity*edgeDotVelocity;b=edgeSquaredLength*(2*BABYLON.Vector3.Dot(this.velocity,this._baseToVertex))-2*edgeDotVelocity*edgeDotBaseToVertex;c=edgeSquaredLength*(1-this._baseToVertex.lengthSquared())+edgeDotBaseToVertex*edgeDotBaseToVertex;lowestRoot=getLowestRoot(a,b,c,t);if(lowestRoot.found){var f=(edgeDotVelocity*lowestRoot.root-edgeDotBaseToVertex)/edgeSquaredLength;if(f>=0&&f<=1){t=lowestRoot.root;found=true;this._edge.scaleInPlace(f);p1.addToRef(this._edge,this._collisionPoint)}}p3.subtractToRef(p2,this._edge);p2.subtractToRef(this.basePoint,this._baseToVertex);edgeSquaredLength=this._edge.lengthSquared();edgeDotVelocity=BABYLON.Vector3.Dot(this._edge,this.velocity);edgeDotBaseToVertex=BABYLON.Vector3.Dot(this._edge,this._baseToVertex);a=edgeSquaredLength*-velocitySquaredLength+edgeDotVelocity*edgeDotVelocity;b=edgeSquaredLength*(2*BABYLON.Vector3.Dot(this.velocity,this._baseToVertex))-2*edgeDotVelocity*edgeDotBaseToVertex;c=edgeSquaredLength*(1-this._baseToVertex.lengthSquared())+edgeDotBaseToVertex*edgeDotBaseToVertex;lowestRoot=getLowestRoot(a,b,c,t);if(lowestRoot.found){f=(edgeDotVelocity*lowestRoot.root-edgeDotBaseToVertex)/edgeSquaredLength;if(f>=0&&f<=1){t=lowestRoot.root;found=true;this._edge.scaleInPlace(f);p2.addToRef(this._edge,this._collisionPoint)}}p1.subtractToRef(p3,this._edge);p3.subtractToRef(this.basePoint,this._baseToVertex);edgeSquaredLength=this._edge.lengthSquared();edgeDotVelocity=BABYLON.Vector3.Dot(this._edge,this.velocity);edgeDotBaseToVertex=BABYLON.Vector3.Dot(this._edge,this._baseToVertex);a=edgeSquaredLength*-velocitySquaredLength+edgeDotVelocity*edgeDotVelocity;b=edgeSquaredLength*(2*BABYLON.Vector3.Dot(this.velocity,this._baseToVertex))-2*edgeDotVelocity*edgeDotBaseToVertex;c=edgeSquaredLength*(1-this._baseToVertex.lengthSquared())+edgeDotBaseToVertex*edgeDotBaseToVertex;lowestRoot=getLowestRoot(a,b,c,t);if(lowestRoot.found){f=(edgeDotVelocity*lowestRoot.root-edgeDotBaseToVertex)/edgeSquaredLength;if(f>=0&&f<=1){t=lowestRoot.root;found=true;this._edge.scaleInPlace(f);p3.addToRef(this._edge,this._collisionPoint)}}}if(found){var distToCollision=t*this.velocity.length();if(!this.collisionFound||distToCollision<this.nearestDistance){if(!this.intersectionPoint){this.intersectionPoint=this._collisionPoint.clone()}else{this.intersectionPoint.copyFrom(this._collisionPoint)}this.nearestDistance=distToCollision;this.collisionFound=true}}};Collider.prototype._collide=function(trianglePlaneArray,pts,indices,indexStart,indexEnd,decal,hasMaterial){for(var i=indexStart;i<indexEnd;i+=3){var p1=pts[indices[i]-decal];var p2=pts[indices[i+1]-decal];var p3=pts[indices[i+2]-decal];this._testTriangle(i,trianglePlaneArray,p3,p2,p1,hasMaterial)}};Collider.prototype._getResponse=function(pos,vel){pos.addToRef(vel,this._destinationPoint);vel.scaleInPlace(this.nearestDistance/vel.length());this.basePoint.addToRef(vel,pos);pos.subtractToRef(this.intersectionPoint,this._slidePlaneNormal);this._slidePlaneNormal.normalize();this._slidePlaneNormal.scaleToRef(this.epsilon,this._displacementVector);pos.addInPlace(this._displacementVector);this.intersectionPoint.addInPlace(this._displacementVector);this._slidePlaneNormal.scaleInPlace(BABYLON.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint));this._destinationPoint.subtractInPlace(this._slidePlaneNormal);this._destinationPoint.subtractToRef(this.intersectionPoint,vel)};return Collider}();BABYLON.Collider=Collider})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){BABYLON.CollisionWorker="";var WorkerTaskType;(function(WorkerTaskType){WorkerTaskType[WorkerTaskType["INIT"]=0]="INIT";WorkerTaskType[WorkerTaskType["UPDATE"]=1]="UPDATE";WorkerTaskType[WorkerTaskType["COLLIDE"]=2]="COLLIDE"})(WorkerTaskType=BABYLON.WorkerTaskType||(BABYLON.WorkerTaskType={}));var WorkerReplyType;(function(WorkerReplyType){WorkerReplyType[WorkerReplyType["SUCCESS"]=0]="SUCCESS";WorkerReplyType[WorkerReplyType["UNKNOWN_ERROR"]=1]="UNKNOWN_ERROR"})(WorkerReplyType=BABYLON.WorkerReplyType||(BABYLON.WorkerReplyType={}));var CollisionCoordinatorWorker=function(){function CollisionCoordinatorWorker(){var _this=this;this._scaledPosition=BABYLON.Vector3.Zero();this._scaledVelocity=BABYLON.Vector3.Zero();this.onMeshUpdated=function(mesh){_this._addUpdateMeshesList[mesh.uniqueId]=CollisionCoordinatorWorker.SerializeMesh(mesh)};this.onGeometryUpdated=function(geometry){_this._addUpdateGeometriesList[geometry.id]=CollisionCoordinatorWorker.SerializeGeometry(geometry)};this._afterRender=function(){if(!_this._init)return;if(_this._toRemoveGeometryArray.length==0&&_this._toRemoveMeshesArray.length==0&&Object.keys(_this._addUpdateGeometriesList).length==0&&Object.keys(_this._addUpdateMeshesList).length==0){return}if(_this._runningUpdated>4){return}++_this._runningUpdated;var payload={updatedMeshes:_this._addUpdateMeshesList,updatedGeometries:_this._addUpdateGeometriesList,removedGeometries:_this._toRemoveGeometryArray,removedMeshes:_this._toRemoveMeshesArray};var message={payload:payload,taskType:WorkerTaskType.UPDATE};var serializable=[];for(var id in payload.updatedGeometries){if(payload.updatedGeometries.hasOwnProperty(id)){serializable.push(message.payload.updatedGeometries[id].indices.buffer);serializable.push(message.payload.updatedGeometries[id].normals.buffer);serializable.push(message.payload.updatedGeometries[id].positions.buffer)}}_this._worker.postMessage(message,serializable);_this._addUpdateMeshesList={};_this._addUpdateGeometriesList={};_this._toRemoveGeometryArray=[];_this._toRemoveMeshesArray=[]};this._onMessageFromWorker=function(e){var returnData=e.data;if(returnData.error!=WorkerReplyType.SUCCESS){BABYLON.Tools.Warn("error returned from worker!");return}switch(returnData.taskType){case WorkerTaskType.INIT:_this._init=true;_this._scene.meshes.forEach(function(mesh){_this.onMeshAdded(mesh)});_this._scene.getGeometries().forEach(function(geometry){_this.onGeometryAdded(geometry)});break;case WorkerTaskType.UPDATE:_this._runningUpdated--;break;case WorkerTaskType.COLLIDE:_this._runningCollisionTask=false;var returnPayload=returnData.payload;if(!_this._collisionsCallbackArray[returnPayload.collisionId])return;_this._collisionsCallbackArray[returnPayload.collisionId](returnPayload.collisionId,BABYLON.Vector3.FromArray(returnPayload.newPosition),_this._scene.getMeshByUniqueID(returnPayload.collidedMeshUniqueId));_this._collisionsCallbackArray[returnPayload.collisionId]=undefined;break}};this._collisionsCallbackArray=[];this._init=false;this._runningUpdated=0;this._runningCollisionTask=false;this._addUpdateMeshesList={};this._addUpdateGeometriesList={};this._toRemoveGeometryArray=[];this._toRemoveMeshesArray=[]}CollisionCoordinatorWorker.prototype.getNewPosition=function(position,displacement,collider,maximumRetry,excludedMesh,onNewPosition,collisionIndex){if(!this._init)return;if(this._collisionsCallbackArray[collisionIndex]||this._collisionsCallbackArray[collisionIndex+1e5])return;position.divideToRef(collider.radius,this._scaledPosition);displacement.divideToRef(collider.radius,this._scaledVelocity);this._collisionsCallbackArray[collisionIndex]=onNewPosition;var payload={collider:{position:this._scaledPosition.asArray(),velocity:this._scaledVelocity.asArray(),radius:collider.radius.asArray()},collisionId:collisionIndex,excludedMeshUniqueId:excludedMesh?excludedMesh.uniqueId:null,maximumRetry:maximumRetry};var message={payload:payload,taskType:WorkerTaskType.COLLIDE};this._worker.postMessage(message)};CollisionCoordinatorWorker.prototype.init=function(scene){this._scene=scene;this._scene.registerAfterRender(this._afterRender);var workerUrl=BABYLON.WorkerIncluded?BABYLON.Engine.CodeRepository+"Collisions/babylon.collisionWorker.js":URL.createObjectURL(new Blob([BABYLON.CollisionWorker],{type:"application/javascript"}));this._worker=new Worker(workerUrl);this._worker.onmessage=this._onMessageFromWorker;var message={payload:{},taskType:WorkerTaskType.INIT};this._worker.postMessage(message)};CollisionCoordinatorWorker.prototype.destroy=function(){this._scene.unregisterAfterRender(this._afterRender);this._worker.terminate()};CollisionCoordinatorWorker.prototype.onMeshAdded=function(mesh){mesh.registerAfterWorldMatrixUpdate(this.onMeshUpdated);this.onMeshUpdated(mesh)};CollisionCoordinatorWorker.prototype.onMeshRemoved=function(mesh){this._toRemoveMeshesArray.push(mesh.uniqueId)};CollisionCoordinatorWorker.prototype.onGeometryAdded=function(geometry){geometry.onGeometryUpdated=this.onGeometryUpdated;this.onGeometryUpdated(geometry)};CollisionCoordinatorWorker.prototype.onGeometryDeleted=function(geometry){this._toRemoveGeometryArray.push(geometry.id)};CollisionCoordinatorWorker.SerializeMesh=function(mesh){var submeshes=[];if(mesh.subMeshes){submeshes=mesh.subMeshes.map(function(sm,idx){return{position:idx,verticesStart:sm.verticesStart,verticesCount:sm.verticesCount,indexStart:sm.indexStart,indexCount:sm.indexCount,hasMaterial:!!sm.getMaterial(),sphereCenter:sm.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:sm.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:sm.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:sm.getBoundingInfo().boundingBox.maximumWorld.asArray()}})}var geometryId=null;if(mesh instanceof BABYLON.Mesh){geometryId=mesh.geometry?mesh.geometry.id:null}else if(mesh instanceof BABYLON.InstancedMesh){geometryId=mesh.sourceMesh&&mesh.sourceMesh.geometry?mesh.sourceMesh.geometry.id:null}return{uniqueId:mesh.uniqueId,id:mesh.id,name:mesh.name,geometryId:geometryId,sphereCenter:mesh.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:mesh.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:mesh.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:mesh.getBoundingInfo().boundingBox.maximumWorld.asArray(),worldMatrixFromCache:mesh.worldMatrixFromCache.asArray(),subMeshes:submeshes,checkCollisions:mesh.checkCollisions}};CollisionCoordinatorWorker.SerializeGeometry=function(geometry){return{id:geometry.id,positions:new Float32Array(geometry.getVerticesData(BABYLON.VertexBuffer.PositionKind)||[]),normals:new Float32Array(geometry.getVerticesData(BABYLON.VertexBuffer.NormalKind)||[]),indices:new Uint32Array(geometry.getIndices()||[])}};return CollisionCoordinatorWorker}();BABYLON.CollisionCoordinatorWorker=CollisionCoordinatorWorker;var CollisionCoordinatorLegacy=function(){function CollisionCoordinatorLegacy(){this._scaledPosition=BABYLON.Vector3.Zero();this._scaledVelocity=BABYLON.Vector3.Zero();this._finalPosition=BABYLON.Vector3.Zero()}CollisionCoordinatorLegacy.prototype.getNewPosition=function(position,displacement,collider,maximumRetry,excludedMesh,onNewPosition,collisionIndex){position.divideToRef(collider.radius,this._scaledPosition);displacement.divideToRef(collider.radius,this._scaledVelocity);collider.collidedMesh=null;collider.retry=0;collider.initialVelocity=this._scaledVelocity;collider.initialPosition=this._scaledPosition;this._collideWithWorld(this._scaledPosition,this._scaledVelocity,collider,maximumRetry,this._finalPosition,excludedMesh);this._finalPosition.multiplyInPlace(collider.radius);onNewPosition(collisionIndex,this._finalPosition,collider.collidedMesh)};CollisionCoordinatorLegacy.prototype.init=function(scene){this._scene=scene};CollisionCoordinatorLegacy.prototype.destroy=function(){};CollisionCoordinatorLegacy.prototype.onMeshAdded=function(mesh){};CollisionCoordinatorLegacy.prototype.onMeshUpdated=function(mesh){};CollisionCoordinatorLegacy.prototype.onMeshRemoved=function(mesh){};CollisionCoordinatorLegacy.prototype.onGeometryAdded=function(geometry){};CollisionCoordinatorLegacy.prototype.onGeometryUpdated=function(geometry){};CollisionCoordinatorLegacy.prototype.onGeometryDeleted=function(geometry){};CollisionCoordinatorLegacy.prototype._collideWithWorld=function(position,velocity,collider,maximumRetry,finalPosition,excludedMesh){if(excludedMesh===void 0){excludedMesh=null}var closeDistance=BABYLON.Engine.CollisionsEpsilon*10;if(collider.retry>=maximumRetry){finalPosition.copyFrom(position);return}var collisionMask=excludedMesh?excludedMesh.collisionMask:collider.collisionMask;collider._initialize(position,velocity,closeDistance);for(var index=0;index<this._scene.meshes.length;index++){var mesh=this._scene.meshes[index];if(mesh.isEnabled()&&mesh.checkCollisions&&mesh.subMeshes&&mesh!==excludedMesh&&(collisionMask&mesh.collisionGroup)!==0){mesh._checkCollision(collider)}}if(!collider.collisionFound){position.addToRef(velocity,finalPosition);return}if(velocity.x!==0||velocity.y!==0||velocity.z!==0){collider._getResponse(position,velocity)}if(velocity.length()<=closeDistance){finalPosition.copyFrom(position);return}collider.retry++;this._collideWithWorld(position,velocity,collider,maximumRetry,finalPosition,excludedMesh)};return CollisionCoordinatorLegacy}();BABYLON.CollisionCoordinatorLegacy=CollisionCoordinatorLegacy})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Particle=function(){function Particle(particleSystem){this.particleSystem=particleSystem;this.position=BABYLON.Vector3.Zero();this.direction=BABYLON.Vector3.Zero();this.color=new BABYLON.Color4(0,0,0,0);this.colorStep=new BABYLON.Color4(0,0,0,0);this.lifeTime=1;this.age=0;this.size=0;this.angle=0;this.angularSpeed=0;this._currentFrameCounter=0;this.cellIndex=0;if(!this.particleSystem.isAnimationSheetEnabled){return}this.cellIndex=this.particleSystem.startSpriteCellID;if(this.particleSystem.spriteCellChangeSpeed==0){this.updateCellIndex=this.updateCellIndexWithSpeedCalculated}else{this.updateCellIndex=this.updateCellIndexWithCustomSpeed}}Particle.prototype.updateCellIndexWithSpeedCalculated=function(scaledUpdateSpeed){var numberOfScaledUpdatesPerCell=(this.lifeTime-this.age)/scaledUpdateSpeed/(this.particleSystem.endSpriteCellID+1-this.cellIndex);this._currentFrameCounter+=scaledUpdateSpeed;if(this._currentFrameCounter>=numberOfScaledUpdatesPerCell*scaledUpdateSpeed){this._currentFrameCounter=0;this.cellIndex++;if(this.cellIndex>this.particleSystem.endSpriteCellID){this.cellIndex=this.particleSystem.endSpriteCellID}}};Particle.prototype.updateCellIndexWithCustomSpeed=function(){if(this._currentFrameCounter>=this.particleSystem.spriteCellChangeSpeed){this.cellIndex++;this._currentFrameCounter=0;if(this.cellIndex>this.particleSystem.endSpriteCellID){if(this.particleSystem.spriteCellLoop){this.cellIndex=this.particleSystem.startSpriteCellID}else{this.cellIndex=this.particleSystem.endSpriteCellID}}}else{this._currentFrameCounter++}};Particle.prototype.copyTo=function(other){other.position.copyFrom(this.position);other.direction.copyFrom(this.direction);other.color.copyFrom(this.color);other.colorStep.copyFrom(this.colorStep);other.lifeTime=this.lifeTime;other.age=this.age;other.size=this.size;other.angle=this.angle;other.angularSpeed=this.angularSpeed;other.particleSystem=this.particleSystem;other.cellIndex=this.cellIndex};return Particle}();BABYLON.Particle=Particle})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var randomNumber=function(min,max){if(min===max){return min}var random=Math.random();return random*(max-min)+min};var ParticleSystem=function(){function ParticleSystem(name,capacity,scene,customEffect,_isAnimationSheetEnabled,epsilon){if(_isAnimationSheetEnabled===void 0){_isAnimationSheetEnabled=false}if(epsilon===void 0){epsilon=.01}var _this=this;this.name=name;this._isAnimationSheetEnabled=_isAnimationSheetEnabled;this.animations=[];this.renderingGroupId=0;this.emitter=null;this.emitRate=10;this.manualEmitCount=-1;this.updateSpeed=.01;this.targetStopDuration=0;this.disposeOnStop=false;this.minEmitPower=1;this.maxEmitPower=1;this.minLifeTime=1;this.maxLifeTime=1;this.minSize=1;this.maxSize=1;this.minAngularSpeed=0;this.maxAngularSpeed=0;this.layerMask=268435455;this.customShader=null;this.preventAutoStart=false;this.onDisposeObservable=new BABYLON.Observable;this.onAnimationEnd=null;this.blendMode=ParticleSystem.BLENDMODE_ONEONE;this.forceDepthWrite=false;this.gravity=BABYLON.Vector3.Zero();this.direction1=new BABYLON.Vector3(0,1,0);this.direction2=new BABYLON.Vector3(0,1,0);this.minEmitBox=new BABYLON.Vector3(-.5,-.5,-.5);this.maxEmitBox=new BABYLON.Vector3(.5,.5,.5);this.color1=new BABYLON.Color4(1,1,1,1);this.color2=new BABYLON.Color4(1,1,1,1);this.colorDead=new BABYLON.Color4(0,0,0,1);this.textureMask=new BABYLON.Color4(1,1,1,1);this.particles=new Array;this._stockParticles=new Array;this._newPartsExcess=0;this._vertexBuffers={};this._scaledColorStep=new BABYLON.Color4(0,0,0,0);this._colorDiff=new BABYLON.Color4(0,0,0,0);this._scaledDirection=BABYLON.Vector3.Zero();this._scaledGravity=BABYLON.Vector3.Zero();this._currentRenderId=-1;this._started=false;this._stopped=false;this._actualFrame=0;this.startSpriteCellID=0;this.endSpriteCellID=0;this.spriteCellLoop=true;this.spriteCellChangeSpeed=0;this.spriteCellWidth=0;this.spriteCellHeight=0;this._vertexBufferSize=11;this.appendParticleVertexes=null;this.id=name;this._capacity=capacity;this._epsilon=epsilon;if(_isAnimationSheetEnabled){this._vertexBufferSize=12}this._scene=scene||BABYLON.Engine.LastCreatedScene;this._customEffect=customEffect;scene.particleSystems.push(this);this._createIndexBuffer();this._vertexData=new Float32Array(capacity*this._vertexBufferSize*4);this._vertexBuffer=new BABYLON.Buffer(scene.getEngine(),this._vertexData,true,this._vertexBufferSize);var positions=this._vertexBuffer.createVertexBuffer(BABYLON.VertexBuffer.PositionKind,0,3);var colors=this._vertexBuffer.createVertexBuffer(BABYLON.VertexBuffer.ColorKind,3,4);var options=this._vertexBuffer.createVertexBuffer("options",7,4);if(this._isAnimationSheetEnabled){var cellIndexBuffer=this._vertexBuffer.createVertexBuffer("cellIndex",11,1);this._vertexBuffers["cellIndex"]=cellIndexBuffer}this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=positions;this._vertexBuffers[BABYLON.VertexBuffer.ColorKind]=colors;this._vertexBuffers["options"]=options;this.startDirectionFunction=function(emitPower,worldMatrix,directionToUpdate,particle){var randX=randomNumber(_this.direction1.x,_this.direction2.x);var randY=randomNumber(_this.direction1.y,_this.direction2.y);var randZ=randomNumber(_this.direction1.z,_this.direction2.z);BABYLON.Vector3.TransformNormalFromFloatsToRef(randX*emitPower,randY*emitPower,randZ*emitPower,worldMatrix,directionToUpdate)};this.startPositionFunction=function(worldMatrix,positionToUpdate,particle){var randX=randomNumber(_this.minEmitBox.x,_this.maxEmitBox.x);var randY=randomNumber(_this.minEmitBox.y,_this.maxEmitBox.y);var randZ=randomNumber(_this.minEmitBox.z,_this.maxEmitBox.z);BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(randX,randY,randZ,worldMatrix,positionToUpdate)};this.updateFunction=function(particles){for(var index=0;index<particles.length;index++){var particle=particles[index];particle.age+=_this._scaledUpdateSpeed;if(particle.age>=particle.lifeTime){_this.recycleParticle(particle);index--;continue}else{particle.colorStep.scaleToRef(_this._scaledUpdateSpeed,_this._scaledColorStep);particle.color.addInPlace(_this._scaledColorStep);if(particle.color.a<0)particle.color.a=0;particle.angle+=particle.angularSpeed*_this._scaledUpdateSpeed;particle.direction.scaleToRef(_this._scaledUpdateSpeed,_this._scaledDirection);particle.position.addInPlace(_this._scaledDirection);_this.gravity.scaleToRef(_this._scaledUpdateSpeed,_this._scaledGravity);particle.direction.addInPlace(_this._scaledGravity);if(_this._isAnimationSheetEnabled){particle.updateCellIndex(_this._scaledUpdateSpeed)}}}}}Object.defineProperty(ParticleSystem.prototype,"onDispose",{set:function(callback){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(ParticleSystem.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},enumerable:true,configurable:true});ParticleSystem.prototype._createIndexBuffer=function(){var indices=[];var index=0;for(var count=0;count<this._capacity;count++){indices.push(index);indices.push(index+1);indices.push(index+2);indices.push(index);indices.push(index+2);indices.push(index+3);index+=4}this._indexBuffer=this._scene.getEngine().createIndexBuffer(indices)};ParticleSystem.prototype.recycleParticle=function(particle){var lastParticle=this.particles.pop();if(lastParticle!==particle){lastParticle.copyTo(particle);this._stockParticles.push(lastParticle)}};ParticleSystem.prototype.getCapacity=function(){return this._capacity};ParticleSystem.prototype.isAlive=function(){return this._alive};ParticleSystem.prototype.isStarted=function(){return this._started};ParticleSystem.prototype.start=function(){this._started=true;this._stopped=false;this._actualFrame=0};ParticleSystem.prototype.stop=function(){this._stopped=true};ParticleSystem.prototype._appendParticleVertex=function(index,particle,offsetX,offsetY){var offset=index*this._vertexBufferSize;this._vertexData[offset]=particle.position.x;this._vertexData[offset+1]=particle.position.y;this._vertexData[offset+2]=particle.position.z;this._vertexData[offset+3]=particle.color.r;this._vertexData[offset+4]=particle.color.g;this._vertexData[offset+5]=particle.color.b;this._vertexData[offset+6]=particle.color.a;this._vertexData[offset+7]=particle.angle;this._vertexData[offset+8]=particle.size;this._vertexData[offset+9]=offsetX;this._vertexData[offset+10]=offsetY};ParticleSystem.prototype._appendParticleVertexWithAnimation=function(index,particle,offsetX,offsetY){if(offsetX===0)offsetX=this._epsilon;else if(offsetX===1)offsetX=1-this._epsilon;if(offsetY===0)offsetY=this._epsilon;else if(offsetY===1)offsetY=1-this._epsilon;var offset=index*this._vertexBufferSize;this._vertexData[offset]=particle.position.x;this._vertexData[offset+1]=particle.position.y;this._vertexData[offset+2]=particle.position.z;this._vertexData[offset+3]=particle.color.r;this._vertexData[offset+4]=particle.color.g;this._vertexData[offset+5]=particle.color.b;this._vertexData[offset+6]=particle.color.a;this._vertexData[offset+7]=particle.angle;this._vertexData[offset+8]=particle.size;this._vertexData[offset+9]=offsetX;this._vertexData[offset+10]=offsetY;this._vertexData[offset+11]=particle.cellIndex};ParticleSystem.prototype._update=function(newParticles){this._alive=this.particles.length>0;this.updateFunction(this.particles);var worldMatrix;if(this.emitter.position){var emitterMesh=this.emitter;worldMatrix=emitterMesh.getWorldMatrix()}else{var emitterPosition=this.emitter;worldMatrix=BABYLON.Matrix.Translation(emitterPosition.x,emitterPosition.y,emitterPosition.z)}var particle;for(var index=0;index<newParticles;index++){if(this.particles.length===this._capacity){break}if(this._stockParticles.length!==0){particle=this._stockParticles.pop();particle.age=0;particle.cellIndex=this.startSpriteCellID}else{particle=new BABYLON.Particle(this)}this.particles.push(particle);var emitPower=randomNumber(this.minEmitPower,this.maxEmitPower);this.startDirectionFunction(emitPower,worldMatrix,particle.direction,particle);particle.lifeTime=randomNumber(this.minLifeTime,this.maxLifeTime);particle.size=randomNumber(this.minSize,this.maxSize);particle.angularSpeed=randomNumber(this.minAngularSpeed,this.maxAngularSpeed);this.startPositionFunction(worldMatrix,particle.position,particle);var step=randomNumber(0,1);BABYLON.Color4.LerpToRef(this.color1,this.color2,step,particle.color);this.colorDead.subtractToRef(particle.color,this._colorDiff);this._colorDiff.scaleToRef(1/particle.lifeTime,particle.colorStep)}};ParticleSystem.prototype._getEffect=function(){if(this._customEffect){return this._customEffect}var defines=[];if(this._scene.clipPlane){defines.push("#define CLIPPLANE")}if(this._isAnimationSheetEnabled){defines.push("#define ANIMATESHEET")}var join=defines.join("\n");if(this._cachedDefines!==join){this._cachedDefines=join;var attributesNamesOrOptions;var effectCreationOption;if(this._isAnimationSheetEnabled){attributesNamesOrOptions=[BABYLON.VertexBuffer.PositionKind,BABYLON.VertexBuffer.ColorKind,"options","cellIndex"];effectCreationOption=["invView","view","projection","particlesInfos","vClipPlane","textureMask"]}else{attributesNamesOrOptions=[BABYLON.VertexBuffer.PositionKind,BABYLON.VertexBuffer.ColorKind,"options"];effectCreationOption=["invView","view","projection","vClipPlane","textureMask"]}this._effect=this._scene.getEngine().createEffect("particles",attributesNamesOrOptions,effectCreationOption,["diffuseSampler"],join)}return this._effect};ParticleSystem.prototype.animate=function(){if(!this._started)return;var effect=this._getEffect();if(!this.emitter||!effect.isReady()||!this.particleTexture||!this.particleTexture.isReady())return;if(this._currentRenderId===this._scene.getRenderId()){return}this._currentRenderId=this._scene.getRenderId();this._scaledUpdateSpeed=this.updateSpeed*this._scene.getAnimationRatio();var newParticles;if(this.manualEmitCount>-1){newParticles=this.manualEmitCount;this._newPartsExcess=0;this.manualEmitCount=0}else{newParticles=this.emitRate*this._scaledUpdateSpeed>>0;this._newPartsExcess+=this.emitRate*this._scaledUpdateSpeed-newParticles}if(this._newPartsExcess>1){newParticles+=this._newPartsExcess>>0;this._newPartsExcess-=this._newPartsExcess>>0}this._alive=false;if(!this._stopped){this._actualFrame+=this._scaledUpdateSpeed;if(this.targetStopDuration&&this._actualFrame>=this.targetStopDuration)this.stop()}else{newParticles=0}this._update(newParticles);if(this._stopped){if(!this._alive){this._started=false;if(this.onAnimationEnd){this.onAnimationEnd()}if(this.disposeOnStop){this._scene._toBeDisposed.push(this)}}}if(this._isAnimationSheetEnabled){this.appendParticleVertexes=this.appenedParticleVertexesWithSheet}else{this.appendParticleVertexes=this.appenedParticleVertexesNoSheet}var offset=0;for(var index=0;index<this.particles.length;index++){var particle=this.particles[index];this.appendParticleVertexes(offset,particle);offset+=4}this._vertexBuffer.update(this._vertexData)};ParticleSystem.prototype.appenedParticleVertexesWithSheet=function(offset,particle){this._appendParticleVertexWithAnimation(offset++,particle,0,0);this._appendParticleVertexWithAnimation(offset++,particle,1,0);this._appendParticleVertexWithAnimation(offset++,particle,1,1);this._appendParticleVertexWithAnimation(offset++,particle,0,1)};ParticleSystem.prototype.appenedParticleVertexesNoSheet=function(offset,particle){this._appendParticleVertex(offset++,particle,0,0);this._appendParticleVertex(offset++,particle,1,0);this._appendParticleVertex(offset++,particle,1,1);this._appendParticleVertex(offset++,particle,0,1)};ParticleSystem.prototype.rebuild=function(){this._createIndexBuffer();this._vertexBuffer._rebuild()};ParticleSystem.prototype.render=function(){var effect=this._getEffect();if(!this.emitter||!effect.isReady()||!this.particleTexture||!this.particleTexture.isReady()||!this.particles.length)return 0;var engine=this._scene.getEngine();engine.enableEffect(effect);engine.setState(false);var viewMatrix=this._scene.getViewMatrix();effect.setTexture("diffuseSampler",this.particleTexture);effect.setMatrix("view",viewMatrix);effect.setMatrix("projection",this._scene.getProjectionMatrix());if(this._isAnimationSheetEnabled){var baseSize=this.particleTexture.getBaseSize();effect.setFloat3("particlesInfos",this.spriteCellWidth/baseSize.width,this.spriteCellHeight/baseSize.height,baseSize.width/this.spriteCellWidth)}effect.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a);if(this._scene.clipPlane){var clipPlane=this._scene.clipPlane;var invView=viewMatrix.clone();invView.invert();effect.setMatrix("invView",invView);effect.setFloat4("vClipPlane",clipPlane.normal.x,clipPlane.normal.y,clipPlane.normal.z,clipPlane.d)}engine.bindBuffers(this._vertexBuffers,this._indexBuffer,effect);if(this.blendMode===ParticleSystem.BLENDMODE_ONEONE){engine.setAlphaMode(BABYLON.Engine.ALPHA_ONEONE)}else{engine.setAlphaMode(BABYLON.Engine.ALPHA_COMBINE)}if(this.forceDepthWrite){engine.setDepthWrite(true)}engine.draw(true,0,this.particles.length*6);engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE);return this.particles.length};ParticleSystem.prototype.dispose=function(){if(this._vertexBuffer){this._vertexBuffer.dispose();this._vertexBuffer=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}if(this.particleTexture){this.particleTexture.dispose();this.particleTexture=null}var index=this._scene.particleSystems.indexOf(this);if(index>-1){this._scene.particleSystems.splice(index,1)}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()};ParticleSystem.prototype.clone=function(name,newEmitter){var custom=null;var program=null;if(this.customShader!=null){program=this.customShader;var defines=program.shaderOptions.defines.length>0?program.shaderOptions.defines.join("\n"):"";custom=this._scene.getEngine().createEffectForParticles(program.shaderPath.fragmentElement,program.shaderOptions.uniforms,program.shaderOptions.samplers,defines)}var result=new ParticleSystem(name,this._capacity,this._scene,custom);result.customShader=program;BABYLON.Tools.DeepCopy(this,result,["particles","customShader"]);if(newEmitter===undefined){newEmitter=this.emitter}result.emitter=newEmitter;if(this.particleTexture){result.particleTexture=new BABYLON.Texture(this.particleTexture.url,this._scene)}if(!this.preventAutoStart){result.start()}return result};ParticleSystem.prototype.serialize=function(){var serializationObject={};serializationObject.name=this.name;serializationObject.id=this.id;if(this.emitter.position){var emitterMesh=this.emitter;serializationObject.emitterId=emitterMesh.id}else{var emitterPosition=this.emitter;serializationObject.emitter=emitterPosition.asArray()}serializationObject.capacity=this.getCapacity();if(this.particleTexture){serializationObject.textureName=this.particleTexture.name}BABYLON.Animation.AppendSerializedAnimations(this,serializationObject);serializationObject.minAngularSpeed=this.minAngularSpeed;serializationObject.maxAngularSpeed=this.maxAngularSpeed;serializationObject.minSize=this.minSize;serializationObject.maxSize=this.maxSize;serializationObject.minEmitPower=this.minEmitPower;serializationObject.maxEmitPower=this.maxEmitPower;serializationObject.minLifeTime=this.minLifeTime;serializationObject.maxLifeTime=this.maxLifeTime;serializationObject.emitRate=this.emitRate;serializationObject.minEmitBox=this.minEmitBox.asArray();serializationObject.maxEmitBox=this.maxEmitBox.asArray();serializationObject.gravity=this.gravity.asArray();serializationObject.direction1=this.direction1.asArray();serializationObject.direction2=this.direction2.asArray();serializationObject.color1=this.color1.asArray();serializationObject.color2=this.color2.asArray();serializationObject.colorDead=this.colorDead.asArray();serializationObject.updateSpeed=this.updateSpeed;serializationObject.targetStopDuration=this.targetStopDuration;serializationObject.textureMask=this.textureMask.asArray();serializationObject.blendMode=this.blendMode;serializationObject.customShader=this.customShader;serializationObject.preventAutoStart=this.preventAutoStart;return serializationObject};ParticleSystem.Parse=function(parsedParticleSystem,scene,rootUrl){var name=parsedParticleSystem.name;var custom=null;var program=null;if(parsedParticleSystem.customShader){program=parsedParticleSystem.customShader;var defines=program.shaderOptions.defines.length>0?program.shaderOptions.defines.join("\n"):"";custom=scene.getEngine().createEffectForParticles(program.shaderPath.fragmentElement,program.shaderOptions.uniforms,program.shaderOptions.samplers,defines)}var particleSystem=new ParticleSystem(name,parsedParticleSystem.capacity,scene,custom);particleSystem.customShader=program;if(parsedParticleSystem.id){particleSystem.id=parsedParticleSystem.id}if(parsedParticleSystem.preventAutoStart){particleSystem.preventAutoStart=parsedParticleSystem.preventAutoStart}if(parsedParticleSystem.textureName){particleSystem.particleTexture=new BABYLON.Texture(rootUrl+parsedParticleSystem.textureName,scene);particleSystem.particleTexture.name=parsedParticleSystem.textureName}if(parsedParticleSystem.emitterId){particleSystem.emitter=scene.getLastMeshByID(parsedParticleSystem.emitterId)}else{particleSystem.emitter=BABYLON.Vector3.FromArray(parsedParticleSystem.emitter)}if(parsedParticleSystem.animations){for(var animationIndex=0;animationIndex<parsedParticleSystem.animations.length;animationIndex++){var parsedAnimation=parsedParticleSystem.animations[animationIndex];particleSystem.animations.push(BABYLON.Animation.Parse(parsedAnimation))}}if(parsedParticleSystem.autoAnimate){scene.beginAnimation(particleSystem,parsedParticleSystem.autoAnimateFrom,parsedParticleSystem.autoAnimateTo,parsedParticleSystem.autoAnimateLoop,parsedParticleSystem.autoAnimateSpeed||1)}particleSystem.minAngularSpeed=parsedParticleSystem.minAngularSpeed;particleSystem.maxAngularSpeed=parsedParticleSystem.maxAngularSpeed;particleSystem.minSize=parsedParticleSystem.minSize;particleSystem.maxSize=parsedParticleSystem.maxSize;particleSystem.minLifeTime=parsedParticleSystem.minLifeTime;particleSystem.maxLifeTime=parsedParticleSystem.maxLifeTime;particleSystem.minEmitPower=parsedParticleSystem.minEmitPower;particleSystem.maxEmitPower=parsedParticleSystem.maxEmitPower;particleSystem.emitRate=parsedParticleSystem.emitRate;particleSystem.minEmitBox=BABYLON.Vector3.FromArray(parsedParticleSystem.minEmitBox);particleSystem.maxEmitBox=BABYLON.Vector3.FromArray(parsedParticleSystem.maxEmitBox);particleSystem.gravity=BABYLON.Vector3.FromArray(parsedParticleSystem.gravity);particleSystem.direction1=BABYLON.Vector3.FromArray(parsedParticleSystem.direction1);particleSystem.direction2=BABYLON.Vector3.FromArray(parsedParticleSystem.direction2);particleSystem.color1=BABYLON.Color4.FromArray(parsedParticleSystem.color1);particleSystem.color2=BABYLON.Color4.FromArray(parsedParticleSystem.color2);particleSystem.colorDead=BABYLON.Color4.FromArray(parsedParticleSystem.colorDead);particleSystem.updateSpeed=parsedParticleSystem.updateSpeed;particleSystem.targetStopDuration=parsedParticleSystem.targetStopDuration;particleSystem.textureMask=BABYLON.Color4.FromArray(parsedParticleSystem.textureMask);particleSystem.blendMode=parsedParticleSystem.blendMode;if(!particleSystem.preventAutoStart){particleSystem.start()}return particleSystem};ParticleSystem.BLENDMODE_ONEONE=0;ParticleSystem.BLENDMODE_STANDARD=1;return ParticleSystem}();BABYLON.ParticleSystem=ParticleSystem})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SolidParticle=function(){function SolidParticle(particleIndex,positionIndex,indiceIndex,model,shapeId,idxInShape,sps,modelBoundingInfo){this.idx=0;this.color=new BABYLON.Color4(1,1,1,1);this.position=BABYLON.Vector3.Zero();this.rotation=BABYLON.Vector3.Zero();this.scaling=BABYLON.Vector3.One();this.uvs=new BABYLON.Vector4(0,0,1,1);this.velocity=BABYLON.Vector3.Zero();this.alive=true;this.isVisible=true;this._pos=0;this._ind=0;this.shapeId=0;this.idxInShape=0;this._stillInvisible=false;this.idx=particleIndex;this._pos=positionIndex;this._ind=indiceIndex;this._model=model;this.shapeId=shapeId;this.idxInShape=idxInShape;this._sps=sps;if(modelBoundingInfo){this._modelBoundingInfo=modelBoundingInfo;this._boundingInfo=new BABYLON.BoundingInfo(modelBoundingInfo.minimum,modelBoundingInfo.maximum)}}Object.defineProperty(SolidParticle.prototype,"scale",{get:function(){return this.scaling},set:function(scale){this.scaling=scale},enumerable:true,configurable:true});Object.defineProperty(SolidParticle.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(q){this.rotationQuaternion=q},enumerable:true,configurable:true});SolidParticle.prototype.intersectsMesh=function(target){if(!this._boundingInfo||!target._boundingInfo){return false}if(this._sps._bSphereOnly){return BABYLON.BoundingSphere.Intersects(this._boundingInfo.boundingSphere,target._boundingInfo.boundingSphere)}return this._boundingInfo.intersects(target._boundingInfo,false)};return SolidParticle}();BABYLON.SolidParticle=SolidParticle;var ModelShape=function(){function ModelShape(id,shape,indicesLength,shapeUV,posFunction,vtxFunction){this._indicesLength=0;this.shapeID=id;this._shape=shape;this._indicesLength=indicesLength;this._shapeUV=shapeUV;this._positionFunction=posFunction;this._vertexFunction=vtxFunction}return ModelShape}();BABYLON.ModelShape=ModelShape;var DepthSortedParticle=function(){function DepthSortedParticle(){this.ind=0;this.indicesLength=0;this.sqDistance=0}return DepthSortedParticle}();BABYLON.DepthSortedParticle=DepthSortedParticle})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SolidParticleSystem=function(){function SolidParticleSystem(name,scene,options){this.particles=new Array;this.nbParticles=0;this.billboard=false;this.recomputeNormals=true;this.counter=0;this.vars={};this._positions=new Array;this._indices=new Array;this._normals=new Array;this._colors=new Array;this._uvs=new Array;this._index=0;this._updatable=true;this._pickable=false;this._isVisibilityBoxLocked=false;this._alwaysVisible=false;this._depthSort=false;this._shapeCounter=0;this._copy=new BABYLON.SolidParticle(null,null,null,null,null,null,null);this._color=new BABYLON.Color4(0,0,0,0);this._computeParticleColor=true;this._computeParticleTexture=true;this._computeParticleRotation=true;this._computeParticleVertex=false;this._computeBoundingBox=false;this._depthSortParticles=true;this._cam_axisZ=BABYLON.Vector3.Zero();this._cam_axisY=BABYLON.Vector3.Zero();this._cam_axisX=BABYLON.Vector3.Zero();this._axisZ=BABYLON.Axis.Z;this._camDir=BABYLON.Vector3.Zero();this._camInvertedPosition=BABYLON.Vector3.Zero();this._rotMatrix=new BABYLON.Matrix;this._invertMatrix=new BABYLON.Matrix;this._rotated=BABYLON.Vector3.Zero();this._quaternion=new BABYLON.Quaternion;this._vertex=BABYLON.Vector3.Zero();this._normal=BABYLON.Vector3.Zero();this._yaw=0;this._pitch=0;this._roll=0;this._halfroll=0;this._halfpitch=0;this._halfyaw=0;this._sinRoll=0;this._cosRoll=0;this._sinPitch=0;this._cosPitch=0;this._sinYaw=0;this._cosYaw=0;this._mustUnrotateFixedNormals=false;this._minimum=BABYLON.Tmp.Vector3[0];this._maximum=BABYLON.Tmp.Vector3[1];this._minBbox=BABYLON.Tmp.Vector3[4];this._maxBbox=BABYLON.Tmp.Vector3[5];this._particlesIntersect=false;this._depthSortFunction=function(p1,p2){return p2.sqDistance-p1.sqDistance};this._needs32Bits=false;this._bSphereOnly=false;this._bSphereRadiusFactor=1;this.name=name;this._scene=scene||BABYLON.Engine.LastCreatedScene;this._camera=scene.activeCamera;this._pickable=options?options.isPickable:false;this._depthSort=options?options.enableDepthSort:false;this._particlesIntersect=options?options.particleIntersection:false;this._bSphereOnly=options?options.boundingSphereOnly:false;this._bSphereRadiusFactor=options&&options.bSphereRadiusFactor?options.bSphereRadiusFactor:1;if(options&&options.updatable){this._updatable=options.updatable}else{this._updatable=true}if(this._pickable){this.pickedParticles=[]}if(this._depthSort){this.depthSortedParticles=[]}}SolidParticleSystem.prototype.buildMesh=function(){if(this.nbParticles===0){var triangle=BABYLON.MeshBuilder.CreateDisc("",{radius:1,tessellation:3},this._scene);this.addShape(triangle,1);triangle.dispose()}this._positions32=new Float32Array(this._positions);this._uvs32=new Float32Array(this._uvs);this._colors32=new Float32Array(this._colors);if(this.recomputeNormals){BABYLON.VertexData.ComputeNormals(this._positions32,this._indices,this._normals)}this._normals32=new Float32Array(this._normals);this._fixedNormal32=new Float32Array(this._normals);if(this._mustUnrotateFixedNormals){this._unrotateFixedNormals()}var vertexData=new BABYLON.VertexData;if(this._depthSort){this._depthSortedIndices=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices);vertexData.indices=this._depthSortedIndices}else{vertexData.indices=this._indices}vertexData.set(this._positions32,BABYLON.VertexBuffer.PositionKind);vertexData.set(this._normals32,BABYLON.VertexBuffer.NormalKind);if(this._uvs32){vertexData.set(this._uvs32,BABYLON.VertexBuffer.UVKind)}if(this._colors32){vertexData.set(this._colors32,BABYLON.VertexBuffer.ColorKind)}var mesh=new BABYLON.Mesh(this.name,this._scene);vertexData.applyToMesh(mesh,this._updatable);this.mesh=mesh;this.mesh.isPickable=this._pickable;this._positions=null;this._normals=null;this._uvs=null;this._colors=null;if(!this._updatable){this.particles.length=0}return mesh};SolidParticleSystem.prototype.digest=function(mesh,options){var size=options&&options.facetNb||1;var number=options&&options.number;var delta=options&&options.delta||0;var meshPos=mesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);var meshInd=mesh.getIndices();var meshUV=mesh.getVerticesData(BABYLON.VertexBuffer.UVKind);var meshCol=mesh.getVerticesData(BABYLON.VertexBuffer.ColorKind);var meshNor=mesh.getVerticesData(BABYLON.VertexBuffer.NormalKind);var f=0;var totalFacets=meshInd.length/3;if(number){number=number>totalFacets?totalFacets:number;size=Math.round(totalFacets/number);delta=0}else{size=size>totalFacets?totalFacets:size}var facetPos=[];var facetInd=[];var facetUV=[];var facetCol=[];var barycenter=BABYLON.Tmp.Vector3[0];var sizeO=size;while(f<totalFacets){size=sizeO+Math.floor((1+delta)*Math.random());if(f>totalFacets-size){size=totalFacets-f}facetPos.length=0;facetInd.length=0;facetUV.length=0;facetCol.length=0;var fi=0;for(var j=f*3;j<(f+size)*3;j++){facetInd.push(fi);var i=meshInd[j];facetPos.push(meshPos[i*3],meshPos[i*3+1],meshPos[i*3+2]);if(meshUV){facetUV.push(meshUV[i*2],meshUV[i*2+1])}if(meshCol){facetCol.push(meshCol[i*4],meshCol[i*4+1],meshCol[i*4+2],meshCol[i*4+3])}fi++}var idx=this.nbParticles;var shape=this._posToShape(facetPos);var shapeUV=this._uvsToShapeUV(facetUV);var v;for(v=0;v<shape.length;v++){barycenter.addInPlace(shape[v])}barycenter.scaleInPlace(1/shape.length);for(v=0;v<shape.length;v++){shape[v].subtractInPlace(barycenter)}var bInfo;if(this._particlesIntersect){bInfo=new BABYLON.BoundingInfo(barycenter,barycenter)}var modelShape=new BABYLON.ModelShape(this._shapeCounter,shape,size*3,shapeUV,null,null);var currentPos=this._positions.length;var currentInd=this._indices.length;this._meshBuilder(this._index,shape,this._positions,facetInd,this._indices,facetUV,this._uvs,facetCol,this._colors,meshNor,this._normals,idx,0,null);this._addParticle(idx,currentPos,currentInd,modelShape,this._shapeCounter,0,bInfo);this.particles[this.nbParticles].position.addInPlace(barycenter);this._index+=shape.length;idx++;this.nbParticles++;this._shapeCounter++;f+=size}return this};SolidParticleSystem.prototype._unrotateFixedNormals=function(){var index=0;var idx=0;for(var p=0;p<this.particles.length;p++){this._particle=this.particles[p];this._shape=this._particle._model._shape;if(this._particle.rotationQuaternion){this._quaternion.copyFrom(this._particle.rotationQuaternion)}else{this._yaw=this._particle.rotation.y;this._pitch=this._particle.rotation.x;this._roll=this._particle.rotation.z;this._quaternionRotationYPR()}this._quaternionToRotationMatrix();this._rotMatrix.invertToRef(this._invertMatrix);for(var pt=0;pt<this._shape.length;pt++){idx=index+pt*3;BABYLON.Vector3.TransformNormalFromFloatsToRef(this._normals32[idx],this._normals32[idx+1],this._normals32[idx+2],this._invertMatrix,this._normal);this._fixedNormal32[idx]=this._normal.x;this._fixedNormal32[idx+1]=this._normal.y;this._fixedNormal32[idx+2]=this._normal.z}index=idx+3}};SolidParticleSystem.prototype._resetCopy=function(){this._copy.position.x=0;this._copy.position.y=0;this._copy.position.z=0;this._copy.rotation.x=0;this._copy.rotation.y=0;this._copy.rotation.z=0;this._copy.rotationQuaternion=null;this._copy.scaling.x=1;this._copy.scaling.y=1;this._copy.scaling.z=1;this._copy.uvs.x=0;this._copy.uvs.y=0;this._copy.uvs.z=1;this._copy.uvs.w=1;this._copy.color=null};SolidParticleSystem.prototype._meshBuilder=function(p,shape,positions,meshInd,indices,meshUV,uvs,meshCol,colors,meshNor,normals,idx,idxInShape,options){var i;var u=0;var c=0;var n=0;this._resetCopy();if(options&&options.positionFunction){options.positionFunction(this._copy,idx,idxInShape);this._mustUnrotateFixedNormals=true}if(this._copy.rotationQuaternion){this._quaternion.copyFrom(this._copy.rotationQuaternion)}else{this._yaw=this._copy.rotation.y;this._pitch=this._copy.rotation.x;this._roll=this._copy.rotation.z;this._quaternionRotationYPR()}this._quaternionToRotationMatrix();for(i=0;i<shape.length;i++){this._vertex.x=shape[i].x;this._vertex.y=shape[i].y;this._vertex.z=shape[i].z;if(options&&options.vertexFunction){options.vertexFunction(this._copy,this._vertex,i)}this._vertex.x*=this._copy.scaling.x;this._vertex.y*=this._copy.scaling.y;this._vertex.z*=this._copy.scaling.z;BABYLON.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated);positions.push(this._copy.position.x+this._rotated.x,this._copy.position.y+this._rotated.y,this._copy.position.z+this._rotated.z);if(meshUV){uvs.push((this._copy.uvs.z-this._copy.uvs.x)*meshUV[u]+this._copy.uvs.x,(this._copy.uvs.w-this._copy.uvs.y)*meshUV[u+1]+this._copy.uvs.y);u+=2}if(this._copy.color){this._color=this._copy.color}else if(meshCol&&meshCol[c]!==undefined){this._color.r=meshCol[c];this._color.g=meshCol[c+1];this._color.b=meshCol[c+2];this._color.a=meshCol[c+3]}else{this._color.r=1;this._color.g=1;this._color.b=1;this._color.a=1}colors.push(this._color.r,this._color.g,this._color.b,this._color.a);c+=4;if(!this.recomputeNormals&&meshNor){this._normal.x=meshNor[n];this._normal.y=meshNor[n+1];this._normal.z=meshNor[n+2];BABYLON.Vector3.TransformNormalToRef(this._normal,this._rotMatrix,this._normal);normals.push(this._normal.x,this._normal.y,this._normal.z);n+=3}}for(i=0;i<meshInd.length;i++){var current_ind=p+meshInd[i];indices.push(current_ind);if(current_ind>65535){this._needs32Bits=true}}if(this._pickable){var nbfaces=meshInd.length/3;for(i=0;i<nbfaces;i++){this.pickedParticles.push({idx:idx,faceId:i})}}if(this._depthSort){this.depthSortedParticles.push(new BABYLON.DepthSortedParticle)}return this._copy};SolidParticleSystem.prototype._posToShape=function(positions){var shape=[];for(var i=0;i<positions.length;i+=3){shape.push(new BABYLON.Vector3(positions[i],positions[i+1],positions[i+2]))}return shape};SolidParticleSystem.prototype._uvsToShapeUV=function(uvs){var shapeUV=[];if(uvs){for(var i=0;i<uvs.length;i++)shapeUV.push(uvs[i])}return shapeUV};SolidParticleSystem.prototype._addParticle=function(idx,idxpos,idxind,model,shapeId,idxInShape,bInfo){var sp=new BABYLON.SolidParticle(idx,idxpos,idxind,model,shapeId,idxInShape,this,bInfo);this.particles.push(sp);return sp};SolidParticleSystem.prototype.addShape=function(mesh,nb,options){var meshPos=mesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);var meshInd=mesh.getIndices();var meshUV=mesh.getVerticesData(BABYLON.VertexBuffer.UVKind);var meshCol=mesh.getVerticesData(BABYLON.VertexBuffer.ColorKind);var meshNor=mesh.getVerticesData(BABYLON.VertexBuffer.NormalKind);var bbInfo;if(this._particlesIntersect){bbInfo=mesh.getBoundingInfo()}var shape=this._posToShape(meshPos);var shapeUV=this._uvsToShapeUV(meshUV);var posfunc=options?options.positionFunction:null;var vtxfunc=options?options.vertexFunction:null;var modelShape=new BABYLON.ModelShape(this._shapeCounter,shape,meshInd.length,shapeUV,posfunc,vtxfunc);var sp;var currentCopy;var idx=this.nbParticles;for(var i=0;i<nb;i++){var currentPos=this._positions.length;var currentInd=this._indices.length;currentCopy=this._meshBuilder(this._index,shape,this._positions,meshInd,this._indices,meshUV,this._uvs,meshCol,this._colors,meshNor,this._normals,idx,i,options);if(this._updatable){sp=this._addParticle(idx,currentPos,currentInd,modelShape,this._shapeCounter,i,bbInfo);sp.position.copyFrom(currentCopy.position);sp.rotation.copyFrom(currentCopy.rotation);if(currentCopy.rotationQuaternion){sp.rotationQuaternion.copyFrom(currentCopy.rotationQuaternion)}if(currentCopy.color){sp.color.copyFrom(currentCopy.color)}sp.scaling.copyFrom(currentCopy.scaling);sp.uvs.copyFrom(currentCopy.uvs)}this._index+=shape.length;idx++}this.nbParticles+=nb;this._shapeCounter++;return this._shapeCounter-1};SolidParticleSystem.prototype._rebuildParticle=function(particle){this._resetCopy();if(particle._model._positionFunction){particle._model._positionFunction(this._copy,particle.idx,particle.idxInShape)}if(this._copy.rotationQuaternion){this._quaternion.copyFrom(this._copy.rotationQuaternion)}else{this._yaw=this._copy.rotation.y;this._pitch=this._copy.rotation.x;this._roll=this._copy.rotation.z;this._quaternionRotationYPR()}this._quaternionToRotationMatrix();this._shape=particle._model._shape;for(var pt=0;pt<this._shape.length;pt++){this._vertex.x=this._shape[pt].x;this._vertex.y=this._shape[pt].y;this._vertex.z=this._shape[pt].z;if(particle._model._vertexFunction){particle._model._vertexFunction(this._copy,this._vertex,pt)}this._vertex.x*=this._copy.scaling.x;this._vertex.y*=this._copy.scaling.y;this._vertex.z*=this._copy.scaling.z;BABYLON.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated);this._positions32[particle._pos+pt*3]=this._copy.position.x+this._rotated.x;this._positions32[particle._pos+pt*3+1]=this._copy.position.y+this._rotated.y;this._positions32[particle._pos+pt*3+2]=this._copy.position.z+this._rotated.z}particle.position.x=0;particle.position.y=0;particle.position.z=0;particle.rotation.x=0;particle.rotation.y=0;particle.rotation.z=0;particle.rotationQuaternion=null;particle.scaling.x=1;particle.scaling.y=1;particle.scaling.z=1};SolidParticleSystem.prototype.rebuildMesh=function(){for(var p=0;p<this.particles.length;p++){this._rebuildParticle(this.particles[p])}this.mesh.updateVerticesData(BABYLON.VertexBuffer.PositionKind,this._positions32,false,false);return this};SolidParticleSystem.prototype.setParticles=function(start,end,update){if(start===void 0){start=0}if(end===void 0){end=this.nbParticles-1}if(update===void 0){update=true}if(!this._updatable){return this}this.beforeUpdateParticles(start,end,update);this._cam_axisX.x=1;this._cam_axisX.y=0;this._cam_axisX.z=0;this._cam_axisY.x=0;this._cam_axisY.y=1;this._cam_axisY.z=0;this._cam_axisZ.x=0;this._cam_axisZ.y=0;this._cam_axisZ.z=1;if(this.billboard||this._depthSort){this.mesh.computeWorldMatrix(true);this.mesh._worldMatrix.invertToRef(this._invertMatrix)}if(this.billboard){this._camera.getDirectionToRef(this._axisZ,this._camDir);BABYLON.Vector3.TransformNormalToRef(this._camDir,this._invertMatrix,this._cam_axisZ);this._cam_axisZ.normalize();var view=this._camera.getViewMatrix(true);BABYLON.Vector3.TransformNormalFromFloatsToRef(view.m[1],view.m[5],view.m[9],this._invertMatrix,this._cam_axisY);BABYLON.Vector3.CrossToRef(this._cam_axisY,this._cam_axisZ,this._cam_axisX);this._cam_axisY.normalize();this._cam_axisX.normalize()}if(this._depthSort){BABYLON.Vector3.TransformCoordinatesToRef(this._camera.globalPosition,this._invertMatrix,this._camInvertedPosition)}BABYLON.Matrix.IdentityToRef(this._rotMatrix);var idx=0;var index=0;var colidx=0;var colorIndex=0;var uvidx=0;var uvIndex=0;var pt=0;if(this.mesh.isFacetDataEnabled){this._computeBoundingBox=true}end=end>=this.nbParticles?this.nbParticles-1:end;if(this._computeBoundingBox){if(start==0&&end==this.nbParticles-1){BABYLON.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this._minimum);BABYLON.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this._maximum)}else{this._minimum.copyFrom(this.mesh._boundingInfo.boundingBox.minimum);this._maximum.copyFrom(this.mesh._boundingInfo.boundingBox.maximum)}}index=this.particles[start]._pos;var vpos=index/3|0;colorIndex=vpos*4;uvIndex=vpos*2;for(var p=start;p<=end;p++){this._particle=this.particles[p];this._shape=this._particle._model._shape;this._shapeUV=this._particle._model._shapeUV;this.updateParticle(this._particle);if(!this._particle.alive||this._particle._stillInvisible&&!this._particle.isVisible){pt=this._shape.length;index+=pt*3;colorIndex+=pt*4;uvIndex+=pt*2;continue}if(this._particle.isVisible){this._particle._stillInvisible=false;if(this.billboard){this._particle.rotation.x=0;this._particle.rotation.y=0}if(this._computeParticleRotation||this.billboard){if(this._particle.rotationQuaternion){this._quaternion.copyFrom(this._particle.rotationQuaternion)}else{this._yaw=this._particle.rotation.y;this._pitch=this._particle.rotation.x;this._roll=this._particle.rotation.z;this._quaternionRotationYPR()}this._quaternionToRotationMatrix()}if(this._depthSort&&this._depthSortParticles){var dsp=this.depthSortedParticles[p];dsp.ind=this._particle._ind;dsp.indicesLength=this._particle._model._indicesLength;dsp.sqDistance=BABYLON.Vector3.DistanceSquared(this._particle.position,this._camInvertedPosition)}for(pt=0;pt<this._shape.length;pt++){idx=index+pt*3;colidx=colorIndex+pt*4;uvidx=uvIndex+pt*2;this._vertex.x=this._shape[pt].x;this._vertex.y=this._shape[pt].y;this._vertex.z=this._shape[pt].z;if(this._computeParticleVertex){this.updateParticleVertex(this._particle,this._vertex,pt)}this._vertex.x*=this._particle.scaling.x;this._vertex.y*=this._particle.scaling.y;this._vertex.z*=this._particle.scaling.z;this._rotated.x=this._vertex.x*this._rotMatrix.m[0]+this._vertex.y*this._rotMatrix.m[4]+this._vertex.z*this._rotMatrix.m[8];this._rotated.y=this._vertex.x*this._rotMatrix.m[1]+this._vertex.y*this._rotMatrix.m[5]+this._vertex.z*this._rotMatrix.m[9];this._rotated.z=this._vertex.x*this._rotMatrix.m[2]+this._vertex.y*this._rotMatrix.m[6]+this._vertex.z*this._rotMatrix.m[10];this._positions32[idx]=this._particle.position.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z;this._positions32[idx+1]=this._particle.position.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z;this._positions32[idx+2]=this._particle.position.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z;if(this._computeBoundingBox){if(this._positions32[idx]<this._minimum.x){this._minimum.x=this._positions32[idx]}if(this._positions32[idx]>this._maximum.x){this._maximum.x=this._positions32[idx]}if(this._positions32[idx+1]<this._minimum.y){this._minimum.y=this._positions32[idx+1]}if(this._positions32[idx+1]>this._maximum.y){this._maximum.y=this._positions32[idx+1]}if(this._positions32[idx+2]<this._minimum.z){this._minimum.z=this._positions32[idx+2]}if(this._positions32[idx+2]>this._maximum.z){this._maximum.z=this._positions32[idx+2]}}if(!this._computeParticleVertex){this._normal.x=this._fixedNormal32[idx];this._normal.y=this._fixedNormal32[idx+1];this._normal.z=this._fixedNormal32[idx+2];this._rotated.x=this._normal.x*this._rotMatrix.m[0]+this._normal.y*this._rotMatrix.m[4]+this._normal.z*this._rotMatrix.m[8];this._rotated.y=this._normal.x*this._rotMatrix.m[1]+this._normal.y*this._rotMatrix.m[5]+this._normal.z*this._rotMatrix.m[9];this._rotated.z=this._normal.x*this._rotMatrix.m[2]+this._normal.y*this._rotMatrix.m[6]+this._normal.z*this._rotMatrix.m[10];this._normals32[idx]=this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z;this._normals32[idx+1]=this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z;this._normals32[idx+2]=this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z}if(this._computeParticleColor){this._colors32[colidx]=this._particle.color.r;this._colors32[colidx+1]=this._particle.color.g;this._colors32[colidx+2]=this._particle.color.b;this._colors32[colidx+3]=this._particle.color.a}if(this._computeParticleTexture){this._uvs32[uvidx]=this._shapeUV[pt*2]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x;this._uvs32[uvidx+1]=this._shapeUV[pt*2+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y}}}else{this._particle._stillInvisible=true;for(pt=0;pt<this._shape.length;pt++){idx=index+pt*3;colidx=colorIndex+pt*4;uvidx=uvIndex+pt*2;this._positions32[idx]=0;this._positions32[idx+1]=0;this._positions32[idx+2]=0;this._normals32[idx]=0;this._normals32[idx+1]=0;this._normals32[idx+2]=0;if(this._computeParticleColor){this._colors32[colidx]=this._particle.color.r;this._colors32[colidx+1]=this._particle.color.g;this._colors32[colidx+2]=this._particle.color.b;this._colors32[colidx+3]=this._particle.color.a}if(this._computeParticleTexture){this._uvs32[uvidx]=this._shapeUV[pt*2]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x;this._uvs32[uvidx+1]=this._shapeUV[pt*2+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y}}}if(this._particlesIntersect){var bInfo=this._particle._boundingInfo;var bBox=bInfo.boundingBox;var bSphere=bInfo.boundingSphere;if(!this._bSphereOnly){for(var b=0;b<bBox.vectors.length;b++){this._vertex.x=this._particle._modelBoundingInfo.boundingBox.vectors[b].x*this._particle.scaling.x;this._vertex.y=this._particle._modelBoundingInfo.boundingBox.vectors[b].y*this._particle.scaling.y;this._vertex.z=this._particle._modelBoundingInfo.boundingBox.vectors[b].z*this._particle.scaling.z;this._rotated.x=this._vertex.x*this._rotMatrix.m[0]+this._vertex.y*this._rotMatrix.m[4]+this._vertex.z*this._rotMatrix.m[8];this._rotated.y=this._vertex.x*this._rotMatrix.m[1]+this._vertex.y*this._rotMatrix.m[5]+this._vertex.z*this._rotMatrix.m[9];this._rotated.z=this._vertex.x*this._rotMatrix.m[2]+this._vertex.y*this._rotMatrix.m[6]+this._vertex.z*this._rotMatrix.m[10];bBox.vectors[b].x=this._particle.position.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z;bBox.vectors[b].y=this._particle.position.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z;bBox.vectors[b].z=this._particle.position.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z}bBox._update(this.mesh._worldMatrix)}this._minBbox.x=this._particle._modelBoundingInfo.minimum.x*this._particle.scaling.x;this._minBbox.y=this._particle._modelBoundingInfo.minimum.y*this._particle.scaling.y;this._minBbox.z=this._particle._modelBoundingInfo.minimum.z*this._particle.scaling.z;this._maxBbox.x=this._particle._modelBoundingInfo.maximum.x*this._particle.scaling.x;this._maxBbox.y=this._particle._modelBoundingInfo.maximum.y*this._particle.scaling.y;this._maxBbox.z=this._particle._modelBoundingInfo.maximum.z*this._particle.scaling.z;bSphere.center.x=this._particle.position.x+(this._minBbox.x+this._maxBbox.x)*.5;bSphere.center.y=this._particle.position.y+(this._minBbox.y+this._maxBbox.y)*.5;bSphere.center.z=this._particle.position.z+(this._minBbox.z+this._maxBbox.z)*.5;bSphere.radius=this._bSphereRadiusFactor*.5*Math.sqrt((this._maxBbox.x-this._minBbox.x)*(this._maxBbox.x-this._minBbox.x)+(this._maxBbox.y-this._minBbox.y)*(this._maxBbox.y-this._minBbox.y)+(this._maxBbox.z-this._minBbox.z)*(this._maxBbox.z-this._minBbox.z));bSphere._update(this.mesh._worldMatrix)}index=idx+3;colorIndex=colidx+4;uvIndex=uvidx+2}if(update){if(this._computeParticleColor){this.mesh.updateVerticesData(BABYLON.VertexBuffer.ColorKind,this._colors32,false,false)}if(this._computeParticleTexture){this.mesh.updateVerticesData(BABYLON.VertexBuffer.UVKind,this._uvs32,false,false)}this.mesh.updateVerticesData(BABYLON.VertexBuffer.PositionKind,this._positions32,false,false);if(!this.mesh.areNormalsFrozen||this.mesh.isFacetDataEnabled){if(this._computeParticleVertex||this.mesh.isFacetDataEnabled){var params=this.mesh.isFacetDataEnabled?this.mesh.getFacetDataParameters():null;BABYLON.VertexData.ComputeNormals(this._positions32,this._indices,this._normals32,params);for(var i=0;i<this._normals32.length;i++){this._fixedNormal32[i]=this._normals32[i]}}if(!this.mesh.areNormalsFrozen){this.mesh.updateVerticesData(BABYLON.VertexBuffer.NormalKind,this._normals32,false,false)}}if(this._depthSort&&this._depthSortParticles){this.depthSortedParticles.sort(this._depthSortFunction);var dspl=this.depthSortedParticles.length;var sorted=0;var lind=0;var sind=0;var sid=0;for(sorted=0;sorted<dspl;sorted++){lind=this.depthSortedParticles[sorted].indicesLength;sind=this.depthSortedParticles[sorted].ind;for(var i=0;i<lind;i++){this._depthSortedIndices[sid]=this._indices[sind+i];sid++}}this.mesh.updateIndices(this._depthSortedIndices)}}if(this._computeBoundingBox){this.mesh._boundingInfo=new BABYLON.BoundingInfo(this._minimum,this._maximum);this.mesh._boundingInfo.update(this.mesh._worldMatrix)}this.afterUpdateParticles(start,end,update);return this};SolidParticleSystem.prototype._quaternionRotationYPR=function(){this._halfroll=this._roll*.5;this._halfpitch=this._pitch*.5;this._halfyaw=this._yaw*.5;this._sinRoll=Math.sin(this._halfroll);this._cosRoll=Math.cos(this._halfroll);this._sinPitch=Math.sin(this._halfpitch);this._cosPitch=Math.cos(this._halfpitch);this._sinYaw=Math.sin(this._halfyaw);this._cosYaw=Math.cos(this._halfyaw);this._quaternion.x=this._cosYaw*this._sinPitch*this._cosRoll+this._sinYaw*this._cosPitch*this._sinRoll;this._quaternion.y=this._sinYaw*this._cosPitch*this._cosRoll-this._cosYaw*this._sinPitch*this._sinRoll;this._quaternion.z=this._cosYaw*this._cosPitch*this._sinRoll-this._sinYaw*this._sinPitch*this._cosRoll;this._quaternion.w=this._cosYaw*this._cosPitch*this._cosRoll+this._sinYaw*this._sinPitch*this._sinRoll};SolidParticleSystem.prototype._quaternionToRotationMatrix=function(){this._rotMatrix.m[0]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.z*this._quaternion.z);this._rotMatrix.m[1]=2*(this._quaternion.x*this._quaternion.y+this._quaternion.z*this._quaternion.w);this._rotMatrix.m[2]=2*(this._quaternion.z*this._quaternion.x-this._quaternion.y*this._quaternion.w);this._rotMatrix.m[3]=0;this._rotMatrix.m[4]=2*(this._quaternion.x*this._quaternion.y-this._quaternion.z*this._quaternion.w);this._rotMatrix.m[5]=1-2*(this._quaternion.z*this._quaternion.z+this._quaternion.x*this._quaternion.x);this._rotMatrix.m[6]=2*(this._quaternion.y*this._quaternion.z+this._quaternion.x*this._quaternion.w);this._rotMatrix.m[7]=0;this._rotMatrix.m[8]=2*(this._quaternion.z*this._quaternion.x+this._quaternion.y*this._quaternion.w);this._rotMatrix.m[9]=2*(this._quaternion.y*this._quaternion.z-this._quaternion.x*this._quaternion.w);this._rotMatrix.m[10]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.x*this._quaternion.x);this._rotMatrix.m[11]=0;this._rotMatrix.m[12]=0;this._rotMatrix.m[13]=0;this._rotMatrix.m[14]=0;this._rotMatrix.m[15]=1};SolidParticleSystem.prototype.dispose=function(){this.mesh.dispose();this.vars=null;this._positions=null;this._indices=null;this._normals=null;this._uvs=null;this._colors=null;this._positions32=null;this._normals32=null;this._fixedNormal32=null;this._uvs32=null;this._colors32=null;this.pickedParticles=null};SolidParticleSystem.prototype.refreshVisibleSize=function(){if(!this._isVisibilityBoxLocked){this.mesh.refreshBoundingInfo()}return this};SolidParticleSystem.prototype.setVisibilityBox=function(size){var vis=size/2;this.mesh._boundingInfo=new BABYLON.BoundingInfo(new BABYLON.Vector3(-vis,-vis,-vis),new BABYLON.Vector3(vis,vis,vis))};Object.defineProperty(SolidParticleSystem.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(val){this._alwaysVisible=val;this.mesh.alwaysSelectAsActiveMesh=val},enumerable:true,configurable:true});Object.defineProperty(SolidParticleSystem.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(val){this._isVisibilityBoxLocked=val;this.mesh.getBoundingInfo().isLocked=val},enumerable:true,configurable:true});Object.defineProperty(SolidParticleSystem.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(val){this._computeParticleRotation=val},enumerable:true,configurable:true});Object.defineProperty(SolidParticleSystem.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(val){this._computeParticleColor=val},enumerable:true,configurable:true});Object.defineProperty(SolidParticleSystem.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(val){this._computeParticleTexture=val},enumerable:true,configurable:true});Object.defineProperty(SolidParticleSystem.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(val){this._computeParticleVertex=val},enumerable:true,configurable:true});Object.defineProperty(SolidParticleSystem.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(val){this._computeBoundingBox=val},enumerable:true,configurable:true});Object.defineProperty(SolidParticleSystem.prototype,"depthSortParticles",{get:function(){return this._depthSortParticles},set:function(val){this._depthSortParticles=val},enumerable:true,configurable:true});SolidParticleSystem.prototype.initParticles=function(){};SolidParticleSystem.prototype.recycleParticle=function(particle){return particle};SolidParticleSystem.prototype.updateParticle=function(particle){return particle};SolidParticleSystem.prototype.updateParticleVertex=function(particle,vertex,pt){return vertex};SolidParticleSystem.prototype.beforeUpdateParticles=function(start,stop,update){};SolidParticleSystem.prototype.afterUpdateParticles=function(start,stop,update){};return SolidParticleSystem}();BABYLON.SolidParticleSystem=SolidParticleSystem})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var GroundMesh=function(_super){__extends(GroundMesh,_super);function GroundMesh(name,scene){var _this=_super.call(this,name,scene)||this;_this.generateOctree=false;return _this}GroundMesh.prototype.getClassName=function(){return"GroundMesh"};Object.defineProperty(GroundMesh.prototype,"subdivisions",{get:function(){return Math.min(this._subdivisionsX,this._subdivisionsY)},enumerable:true,configurable:true});Object.defineProperty(GroundMesh.prototype,"subdivisionsX",{get:function(){return this._subdivisionsX},enumerable:true,configurable:true});Object.defineProperty(GroundMesh.prototype,"subdivisionsY",{get:function(){return this._subdivisionsY},enumerable:true,configurable:true});GroundMesh.prototype.optimize=function(chunksCount,octreeBlocksSize){if(octreeBlocksSize===void 0){octreeBlocksSize=32}this._subdivisionsX=chunksCount;this._subdivisionsY=chunksCount;this.subdivide(chunksCount);this.createOrUpdateSubmeshesOctree(octreeBlocksSize)};GroundMesh.prototype.getHeightAtCoordinates=function(x,z){var world=this.getWorldMatrix();var invMat=BABYLON.Tmp.Matrix[5];world.invertToRef(invMat);var tmpVect=BABYLON.Tmp.Vector3[8];BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(x,0,z,invMat,tmpVect);x=tmpVect.x;z=tmpVect.z;if(x<this._minX||x>this._maxX||z<this._minZ||z>this._maxZ){return this.position.y}if(!this._heightQuads||this._heightQuads.length==0){this._initHeightQuads();this._computeHeightQuads()}var facet=this._getFacetAt(x,z);var y=-(facet.x*x+facet.z*z+facet.w)/facet.y;BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(0,y,0,world,tmpVect);return tmpVect.y};GroundMesh.prototype.getNormalAtCoordinates=function(x,z){var normal=new BABYLON.Vector3(0,1,0);this.getNormalAtCoordinatesToRef(x,z,normal);return normal};GroundMesh.prototype.getNormalAtCoordinatesToRef=function(x,z,ref){var world=this.getWorldMatrix();var tmpMat=BABYLON.Tmp.Matrix[5];world.invertToRef(tmpMat);var tmpVect=BABYLON.Tmp.Vector3[8];BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(x,0,z,tmpMat,tmpVect);x=tmpVect.x;z=tmpVect.z;if(x<this._minX||x>this._maxX||z<this._minZ||z>this._maxZ){return this}if(!this._heightQuads||this._heightQuads.length==0){this._initHeightQuads();this._computeHeightQuads()}var facet=this._getFacetAt(x,z);BABYLON.Vector3.TransformNormalFromFloatsToRef(facet.x,facet.y,facet.z,world,ref);return this};GroundMesh.prototype.updateCoordinateHeights=function(){if(!this._heightQuads||this._heightQuads.length==0){this._initHeightQuads()}this._computeHeightQuads();return this};GroundMesh.prototype._getFacetAt=function(x,z){var col=Math.floor((x+this._maxX)*this._subdivisionsX/this._width);var row=Math.floor(-(z+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY);var quad=this._heightQuads[row*this._subdivisionsX+col];var facet;if(z<quad.slope.x*x+quad.slope.y){facet=quad.facet1}else{facet=quad.facet2}return facet};GroundMesh.prototype._initHeightQuads=function(){var subdivisionsX=this._subdivisionsX;var subdivisionsY=this._subdivisionsY;this._heightQuads=new Array;for(var row=0;row<subdivisionsY;row++){for(var col=0;col<subdivisionsX;col++){var quad={slope:BABYLON.Vector2.Zero(),facet1:new BABYLON.Vector4(0,0,0,0),facet2:new BABYLON.Vector4(0,0,0,0)};this._heightQuads[row*subdivisionsX+col]=quad}}return this};GroundMesh.prototype._computeHeightQuads=function(){var positions=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);var v1=BABYLON.Tmp.Vector3[3];var v2=BABYLON.Tmp.Vector3[2];var v3=BABYLON.Tmp.Vector3[1];var v4=BABYLON.Tmp.Vector3[0];var v1v2=BABYLON.Tmp.Vector3[4];var v1v3=BABYLON.Tmp.Vector3[5];var v1v4=BABYLON.Tmp.Vector3[6];var norm1=BABYLON.Tmp.Vector3[7];var norm2=BABYLON.Tmp.Vector3[8];var i=0;var j=0;var k=0;var cd=0;var h=0;var d1=0;var d2=0;var subdivisionsX=this._subdivisionsX;var subdivisionsY=this._subdivisionsY;for(var row=0;row<subdivisionsY;row++){for(var col=0;col<subdivisionsX;col++){i=col*3;j=row*(subdivisionsX+1)*3;k=(row+1)*(subdivisionsX+1)*3;v1.x=positions[j+i];v1.y=positions[j+i+1];v1.z=positions[j+i+2];v2.x=positions[j+i+3];v2.y=positions[j+i+4];v2.z=positions[j+i+5];v3.x=positions[k+i];v3.y=positions[k+i+1];v3.z=positions[k+i+2];v4.x=positions[k+i+3];v4.y=positions[k+i+4];v4.z=positions[k+i+5];cd=(v4.z-v1.z)/(v4.x-v1.x);h=v1.z-cd*v1.x;v2.subtractToRef(v1,v1v2);v3.subtractToRef(v1,v1v3);v4.subtractToRef(v1,v1v4);BABYLON.Vector3.CrossToRef(v1v4,v1v3,norm1);BABYLON.Vector3.CrossToRef(v1v2,v1v4,norm2);norm1.normalize();norm2.normalize();d1=-(norm1.x*v1.x+norm1.y*v1.y+norm1.z*v1.z);d2=-(norm2.x*v2.x+norm2.y*v2.y+norm2.z*v2.z);var quad=this._heightQuads[row*subdivisionsX+col];quad.slope.copyFromFloats(cd,h);quad.facet1.copyFromFloats(norm1.x,norm1.y,norm1.z,d1);quad.facet2.copyFromFloats(norm2.x,norm2.y,norm2.z,d2)}}return this};GroundMesh.prototype.serialize=function(serializationObject){_super.prototype.serialize.call(this,serializationObject);serializationObject.subdivisionsX=this._subdivisionsX;serializationObject.subdivisionsY=this._subdivisionsY;serializationObject.minX=this._minX;serializationObject.maxX=this._maxX;serializationObject.minZ=this._minZ;serializationObject.maxZ=this._maxZ;serializationObject.width=this._width;serializationObject.height=this._height};GroundMesh.Parse=function(parsedMesh,scene){var result=new GroundMesh(parsedMesh.name,scene);result._subdivisionsX=parsedMesh.subdivisionsX||1;result._subdivisionsY=parsedMesh.subdivisionsY||1;result._minX=parsedMesh.minX;result._maxX=parsedMesh.maxX;result._minZ=parsedMesh.minZ;result._maxZ=parsedMesh.maxZ;result._width=parsedMesh.width;result._height=parsedMesh.height;return result};return GroundMesh}(BABYLON.Mesh);BABYLON.GroundMesh=GroundMesh})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var InstancedMesh=function(_super){__extends(InstancedMesh,_super);function InstancedMesh(name,source){var _this=_super.call(this,name,source.getScene())||this;source.instances.push(_this);_this._sourceMesh=source;_this.position.copyFrom(source.position);_this.rotation.copyFrom(source.rotation);_this.scaling.copyFrom(source.scaling);if(source.rotationQuaternion){_this.rotationQuaternion=source.rotationQuaternion.clone()}_this.infiniteDistance=source.infiniteDistance;_this.setPivotMatrix(source.getPivotMatrix());_this.refreshBoundingInfo();_this._syncSubMeshes();return _this}InstancedMesh.prototype.getClassName=function(){return"InstancedMesh"};Object.defineProperty(InstancedMesh.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:true,configurable:true});Object.defineProperty(InstancedMesh.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:true,configurable:true});Object.defineProperty(InstancedMesh.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:true,configurable:true});Object.defineProperty(InstancedMesh.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:true,configurable:true});Object.defineProperty(InstancedMesh.prototype,"renderingGroupId",{get:function(){return this._sourceMesh.renderingGroupId},enumerable:true,configurable:true});InstancedMesh.prototype.getTotalVertices=function(){return this._sourceMesh.getTotalVertices()};Object.defineProperty(InstancedMesh.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:true,configurable:true});InstancedMesh.prototype.getVerticesData=function(kind,copyWhenShared){return this._sourceMesh.getVerticesData(kind,copyWhenShared)};InstancedMesh.prototype.setVerticesData=function(kind,data,updatable,stride){if(this.sourceMesh){this.sourceMesh.setVerticesData(kind,data,updatable,stride)}return this.sourceMesh};InstancedMesh.prototype.updateVerticesData=function(kind,data,updateExtends,makeItUnique){if(this.sourceMesh){this.sourceMesh.updateVerticesData(kind,data,updateExtends,makeItUnique)}return this.sourceMesh};InstancedMesh.prototype.setIndices=function(indices,totalVertices){if(this.sourceMesh){this.sourceMesh.setIndices(indices,totalVertices)}return this.sourceMesh};InstancedMesh.prototype.isVerticesDataPresent=function(kind){return this._sourceMesh.isVerticesDataPresent(kind)};InstancedMesh.prototype.getIndices=function(){return this._sourceMesh.getIndices()};Object.defineProperty(InstancedMesh.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:true,configurable:true});InstancedMesh.prototype.refreshBoundingInfo=function(){var meshBB=this._sourceMesh.getBoundingInfo();this._boundingInfo=new BABYLON.BoundingInfo(meshBB.minimum.clone(),meshBB.maximum.clone());this._updateBoundingInfo();return this};InstancedMesh.prototype._preActivate=function(){if(this._currentLOD){this._currentLOD._preActivate()}return this};InstancedMesh.prototype._activate=function(renderId){if(this._currentLOD){this._currentLOD._registerInstanceForRenderId(this,renderId)}return this};InstancedMesh.prototype.getLOD=function(camera){this._currentLOD=this.sourceMesh.getLOD(this.getScene().activeCamera,this.getBoundingInfo().boundingSphere);if(this._currentLOD===this.sourceMesh){return this}return this._currentLOD};InstancedMesh.prototype._syncSubMeshes=function(){this.releaseSubMeshes();if(this._sourceMesh.subMeshes){for(var index=0;index<this._sourceMesh.subMeshes.length;index++){this._sourceMesh.subMeshes[index].clone(this,this._sourceMesh)}}return this};InstancedMesh.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()};InstancedMesh.prototype.clone=function(name,newParent,doNotCloneChildren){var result=this._sourceMesh.createInstance(name);BABYLON.Tools.DeepCopy(this,result,["name","subMeshes","uniqueId"],[]);this.refreshBoundingInfo();if(newParent){result.parent=newParent}if(!doNotCloneChildren){for(var index=0;index<this.getScene().meshes.length;index++){var mesh=this.getScene().meshes[index];if(mesh.parent===this){mesh.clone(mesh.name,result)}}}result.computeWorldMatrix(true);return result};InstancedMesh.prototype.dispose=function(doNotRecurse){var index=this._sourceMesh.instances.indexOf(this);this._sourceMesh.instances.splice(index,1);_super.prototype.dispose.call(this,doNotRecurse)};return InstancedMesh}(BABYLON.AbstractMesh);BABYLON.InstancedMesh=InstancedMesh})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var LinesMesh=function(_super){__extends(LinesMesh,_super);function LinesMesh(name,scene,parent,source,doNotCloneChildren,useVertexColor){if(parent===void 0){parent=null}var _this=_super.call(this,name,scene,parent,source,doNotCloneChildren)||this;_this.useVertexColor=useVertexColor;_this.color=new BABYLON.Color3(1,1,1);_this.alpha=1;if(source){_this.color=source.color.clone();_this.alpha=source.alpha;_this.useVertexColor=source.useVertexColor}_this._intersectionThreshold=.1;var options={attributes:[BABYLON.VertexBuffer.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:false};if(!useVertexColor){options.uniforms.push("color");options.needAlphaBlending=true}_this._colorShader=new BABYLON.ShaderMaterial("colorShader",scene,"color",options);return _this}Object.defineProperty(LinesMesh.prototype,"intersectionThreshold",{get:function(){return this._intersectionThreshold},set:function(value){if(this._intersectionThreshold===value){return}this._intersectionThreshold=value;if(this.geometry){this.geometry.boundingBias=new BABYLON.Vector2(0,value)}},enumerable:true,configurable:true});LinesMesh.prototype.getClassName=function(){return"LinesMesh"};Object.defineProperty(LinesMesh.prototype,"material",{get:function(){return this._colorShader},enumerable:true,configurable:true});Object.defineProperty(LinesMesh.prototype,"checkCollisions",{get:function(){return false},enumerable:true,configurable:true});LinesMesh.prototype.createInstance=function(name){BABYLON.Tools.Log("LinesMeshes do not support createInstance.");return null};LinesMesh.prototype._bind=function(subMesh,effect,fillMode){this._geometry._bind(this._colorShader.getEffect());if(!this.useVertexColor){this._colorShader.setColor4("color",this.color.toColor4(this.alpha))}return this};LinesMesh.prototype._draw=function(subMesh,fillMode,instancesCount){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._geometry.getIndexBuffer()){return this}var engine=this.getScene().getEngine();engine.draw(false,subMesh.indexStart,subMesh.indexCount);return this};LinesMesh.prototype.dispose=function(doNotRecurse){this._colorShader.dispose();_super.prototype.dispose.call(this,doNotRecurse)};LinesMesh.prototype.clone=function(name,newParent,doNotCloneChildren){return new LinesMesh(name,this.getScene(),newParent,this,doNotCloneChildren)};return LinesMesh}(BABYLON.Mesh);BABYLON.LinesMesh=LinesMesh})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ShaderMaterial=function(_super){__extends(ShaderMaterial,_super);function ShaderMaterial(name,scene,shaderPath,options){var _this=_super.call(this,name,scene)||this;_this._textures={};_this._textureArrays={};_this._floats={};_this._floatsArrays={};_this._colors3={};_this._colors3Arrays={};_this._colors4={};_this._vectors2={};_this._vectors3={};_this._vectors4={};_this._matrices={};_this._matrices3x3={};_this._matrices2x2={};_this._vectors3Arrays={};_this._cachedWorldViewMatrix=new BABYLON.Matrix;_this._shaderPath=shaderPath;options.needAlphaBlending=options.needAlphaBlending||false;options.needAlphaTesting=options.needAlphaTesting||false;options.attributes=options.attributes||["position","normal","uv"];options.uniforms=options.uniforms||["worldViewProjection"];options.uniformBuffers=options.uniformBuffers||[];options.samplers=options.samplers||[];options.defines=options.defines||[];_this._options=options;return _this}ShaderMaterial.prototype.getClassName=function(){return"ShaderMaterial"};ShaderMaterial.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending};ShaderMaterial.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting};ShaderMaterial.prototype._checkUniform=function(uniformName){if(this._options.uniforms.indexOf(uniformName)===-1){this._options.uniforms.push(uniformName)}};ShaderMaterial.prototype.setTexture=function(name,texture){if(this._options.samplers.indexOf(name)===-1){this._options.samplers.push(name)}this._textures[name]=texture;return this};ShaderMaterial.prototype.setTextureArray=function(name,textures){if(this._options.samplers.indexOf(name)===-1){this._options.samplers.push(name)}this._checkUniform(name);this._textureArrays[name]=textures;return this};ShaderMaterial.prototype.setFloat=function(name,value){this._checkUniform(name);this._floats[name]=value;return this};ShaderMaterial.prototype.setFloats=function(name,value){this._checkUniform(name);this._floatsArrays[name]=value;return this};ShaderMaterial.prototype.setColor3=function(name,value){this._checkUniform(name);this._colors3[name]=value;return this};ShaderMaterial.prototype.setColor3Array=function(name,value){this._checkUniform(name);this._colors3Arrays[name]=value.reduce(function(arr,color){color.toArray(arr,arr.length);return arr},[]);return this};ShaderMaterial.prototype.setColor4=function(name,value){this._checkUniform(name);this._colors4[name]=value;return this};ShaderMaterial.prototype.setVector2=function(name,value){this._checkUniform(name);this._vectors2[name]=value;return this};ShaderMaterial.prototype.setVector3=function(name,value){this._checkUniform(name);this._vectors3[name]=value;return this};ShaderMaterial.prototype.setVector4=function(name,value){this._checkUniform(name);this._vectors4[name]=value;return this};ShaderMaterial.prototype.setMatrix=function(name,value){this._checkUniform(name);this._matrices[name]=value;return this};ShaderMaterial.prototype.setMatrix3x3=function(name,value){this._checkUniform(name);this._matrices3x3[name]=value;return this};ShaderMaterial.prototype.setMatrix2x2=function(name,value){this._checkUniform(name);this._matrices2x2[name]=value;return this};ShaderMaterial.prototype.setArray3=function(name,value){this._checkUniform(name);this._vectors3Arrays[name]=value;return this};ShaderMaterial.prototype._checkCache=function(scene,mesh,useInstances){if(!mesh){return true}if(this._effect&&this._effect.defines.indexOf("#define INSTANCES")!==-1!==useInstances){return false}return false};ShaderMaterial.prototype.isReady=function(mesh,useInstances){var scene=this.getScene();var engine=scene.getEngine();if(!this.checkReadyOnEveryCall){if(this._renderId===scene.getRenderId()){if(this._checkCache(scene,mesh,useInstances)){return true}}}var defines=[];var attribs=[];var fallbacks=new BABYLON.EffectFallbacks;if(useInstances){defines.push("#define INSTANCES")}for(var index=0;index<this._options.defines.length;index++){defines.push(this._options.defines[index])}for(var index=0;index<this._options.attributes.length;index++){attribs.push(this._options.attributes[index])}if(mesh&&mesh.isVerticesDataPresent(BABYLON.VertexBuffer.ColorKind)){attribs.push(BABYLON.VertexBuffer.ColorKind);defines.push("#define VERTEXCOLOR")}if(mesh&&mesh.useBones&&mesh.computeBonesUsingShaders){attribs.push(BABYLON.VertexBuffer.MatricesIndicesKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsKind);if(mesh.numBoneInfluencers>4){attribs.push(BABYLON.VertexBuffer.MatricesIndicesExtraKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsExtraKind)}defines.push("#define NUM_BONE_INFLUENCERS "+mesh.numBoneInfluencers);defines.push("#define BonesPerMesh "+(mesh.skeleton.bones.length+1));fallbacks.addCPUSkinningFallback(0,mesh);if(this._options.uniforms.indexOf("mBones")===-1){this._options.uniforms.push("mBones")}}else{defines.push("#define NUM_BONE_INFLUENCERS 0")}for(var name in this._textures){if(!this._textures[name].isReady()){return false}}if(engine.getAlphaTesting()){defines.push("#define ALPHATEST")}var previousEffect=this._effect;var join=defines.join("\n");this._effect=engine.createEffect(this._shaderPath,{attributes:attribs,uniformsNames:this._options.uniforms,uniformBuffersNames:this._options.uniformBuffers,samplers:this._options.samplers,defines:join,fallbacks:fallbacks,onCompiled:this.onCompiled,onError:this.onError},engine);if(!this._effect.isReady()){return false}if(previousEffect!==this._effect){scene.resetCachedMaterial()}this._renderId=scene.getRenderId();return true};ShaderMaterial.prototype.bindOnlyWorldMatrix=function(world){var scene=this.getScene();if(this._options.uniforms.indexOf("world")!==-1){this._effect.setMatrix("world",world)}if(this._options.uniforms.indexOf("worldView")!==-1){world.multiplyToRef(scene.getViewMatrix(),this._cachedWorldViewMatrix);this._effect.setMatrix("worldView",this._cachedWorldViewMatrix)}if(this._options.uniforms.indexOf("worldViewProjection")!==-1){this._effect.setMatrix("worldViewProjection",world.multiply(scene.getTransformMatrix()))}};ShaderMaterial.prototype.bind=function(world,mesh){this.bindOnlyWorldMatrix(world);if(this.getScene().getCachedMaterial()!==this){if(this._options.uniforms.indexOf("view")!==-1){this._effect.setMatrix("view",this.getScene().getViewMatrix())}if(this._options.uniforms.indexOf("projection")!==-1){this._effect.setMatrix("projection",this.getScene().getProjectionMatrix())}if(this._options.uniforms.indexOf("viewProjection")!==-1){this._effect.setMatrix("viewProjection",this.getScene().getTransformMatrix())}BABYLON.MaterialHelper.BindBonesParameters(mesh,this._effect);var name;for(name in this._textures){this._effect.setTexture(name,this._textures[name])}for(name in this._textureArrays){this._effect.setTextureArray(name,this._textureArrays[name])}for(name in this._floats){this._effect.setFloat(name,this._floats[name])}for(name in this._floatsArrays){this._effect.setArray(name,this._floatsArrays[name])}for(name in this._colors3){this._effect.setColor3(name,this._colors3[name])}for(name in this._colors3Arrays){this._effect.setArray3(name,this._colors3Arrays[name])}for(name in this._colors4){var color=this._colors4[name];this._effect.setFloat4(name,color.r,color.g,color.b,color.a)}for(name in this._vectors2){this._effect.setVector2(name,this._vectors2[name])}for(name in this._vectors3){this._effect.setVector3(name,this._vectors3[name])}for(name in this._vectors4){this._effect.setVector4(name,this._vectors4[name])}for(name in this._matrices){this._effect.setMatrix(name,this._matrices[name])}for(name in this._matrices3x3){this._effect.setMatrix3x3(name,this._matrices3x3[name])}for(name in this._matrices2x2){this._effect.setMatrix2x2(name,this._matrices2x2[name])}for(name in this._vectors3Arrays){this._effect.setArray3(name,this._vectors3Arrays[name])}}this._afterBind(mesh)};ShaderMaterial.prototype.getActiveTextures=function(){var activeTextures=_super.prototype.getActiveTextures.call(this);for(var name in this._textures){activeTextures.push(this._textures[name])}for(var name in this._textureArrays){var array=this._textureArrays[name];for(var index=0;index<array.length;index++){activeTextures.push(array[index])}}return activeTextures};ShaderMaterial.prototype.hasTexture=function(texture){if(_super.prototype.hasTexture.call(this,texture)){return true}for(var name in this._textures){if(this._textures[name]===texture){return true}}for(var name in this._textureArrays){var array=this._textureArrays[name];for(var index=0;index<array.length;index++){if(array[index]===texture){return true}}}return false};ShaderMaterial.prototype.clone=function(name){var newShaderMaterial=new ShaderMaterial(name,this.getScene(),this._shaderPath,this._options);return newShaderMaterial};ShaderMaterial.prototype.dispose=function(forceDisposeEffect,forceDisposeTextures){if(forceDisposeTextures){var name;for(name in this._textures){this._textures[name].dispose()}for(name in this._textureArrays){var array=this._textureArrays[name];for(var index=0;index<array.length;index++){array[index].dispose()}}}this._textures={};_super.prototype.dispose.call(this,forceDisposeEffect,forceDisposeTextures)};ShaderMaterial.prototype.serialize=function(){var serializationObject=BABYLON.SerializationHelper.Serialize(this);serializationObject.customType="BABYLON.ShaderMaterial";serializationObject.options=this._options;serializationObject.shaderPath=this._shaderPath;var name;serializationObject.textures={};for(name in this._textures){serializationObject.textures[name]=this._textures[name].serialize()}serializationObject.textureArrays={};for(name in this._textureArrays){serializationObject.textureArrays[name]=[];var array=this._textureArrays[name];for(var index=0;index<array.length;index++){serializationObject.textureArrays[name].push(array[index].serialize())}}serializationObject.floats={};for(name in this._floats){serializationObject.floats[name]=this._floats[name]}serializationObject.floatArrays={};for(name in this._floatsArrays){serializationObject.floatArrays[name]=this._floatsArrays[name]}serializationObject.colors3={};for(name in this._colors3){serializationObject.colors3[name]=this._colors3[name].asArray()}serializationObject.colors3Arrays={};for(name in this._colors3Arrays){serializationObject.colors3Arrays[name]=this._colors3Arrays[name]}serializationObject.colors4={};for(name in this._colors4){serializationObject.colors4[name]=this._colors4[name].asArray()}serializationObject.vectors2={};for(name in this._vectors2){serializationObject.vectors2[name]=this._vectors2[name].asArray()}serializationObject.vectors3={};for(name in this._vectors3){serializationObject.vectors3[name]=this._vectors3[name].asArray()}serializationObject.vectors4={};for(name in this._vectors4){serializationObject.vectors4[name]=this._vectors4[name].asArray()}serializationObject.matrices={};for(name in this._matrices){serializationObject.matrices[name]=this._matrices[name].asArray()}serializationObject.matrices3x3={};for(name in this._matrices3x3){serializationObject.matrices3x3[name]=this._matrices3x3[name]}serializationObject.matrices2x2={};for(name in this._matrices2x2){serializationObject.matrices2x2[name]=this._matrices2x2[name]}serializationObject.vectors3Arrays={};for(name in this._vectors3Arrays){serializationObject.vectors3Arrays[name]=this._vectors3Arrays[name]}return serializationObject};ShaderMaterial.Parse=function(source,scene,rootUrl){var material=BABYLON.SerializationHelper.Parse(function(){return new ShaderMaterial(source.name,scene,source.shaderPath,source.options)},source,scene,rootUrl);var name;for(name in source.textures){material.setTexture(name,BABYLON.Texture.Parse(source.textures[name],scene,rootUrl))}for(name in source.textureArrays){var array=source.textureArrays[name];var textureArray=new Array;for(var index=0;index<array.length;index++){textureArray.push(BABYLON.Texture.Parse(array[index],scene,rootUrl))}material.setTextureArray(name,textureArray)}for(name in source.floats){material.setFloat(name,source.floats[name])}for(name in source.floatsArrays){material.setFloats(name,source.floatsArrays[name])}for(name in source.colors3){material.setColor3(name,BABYLON.Color3.FromArray(source.colors3[name]))}for(name in source.colors3Arrays){var colors=source.colors3Arrays[name].reduce(function(arr,num,i){if(i%3===0){arr.push([num])}else{arr[arr.length-1].push(num)}return arr},[]).map(function(color){return BABYLON.Color3.FromArray(color)});material.setColor3Array(name,colors)}for(name in source.colors4){material.setColor4(name,BABYLON.Color4.FromArray(source.colors4[name]))}for(name in source.vectors2){material.setVector2(name,BABYLON.Vector2.FromArray(source.vectors2[name]))}for(name in source.vectors3){material.setVector3(name,BABYLON.Vector3.FromArray(source.vectors3[name]))}for(name in source.vectors4){material.setVector4(name,BABYLON.Vector4.FromArray(source.vectors4[name]))}for(name in source.matrices){material.setMatrix(name,BABYLON.Matrix.FromArray(source.matrices[name]))}for(name in source.matrices3x3){material.setMatrix3x3(name,source.matrices3x3[name])}for(name in source.matrices2x2){material.setMatrix2x2(name,source.matrices2x2[name])}for(name in source.vectors3Arrays){material.setArray3(name,source.vectors3Arrays[name])}return material};return ShaderMaterial}(BABYLON.Material);BABYLON.ShaderMaterial=ShaderMaterial})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MeshBuilder=function(){function MeshBuilder(){}MeshBuilder.updateSideOrientation=function(orientation,scene){if(orientation==BABYLON.Mesh.DOUBLESIDE){return BABYLON.Mesh.DOUBLESIDE}if(orientation===undefined||orientation===null){return BABYLON.Mesh.FRONTSIDE}return orientation};MeshBuilder.CreateBox=function(name,options,scene){var box=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);box._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreateBox(options);vertexData.applyToMesh(box,options.updatable);return box};MeshBuilder.CreateSphere=function(name,options,scene){var sphere=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);sphere._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreateSphere(options);vertexData.applyToMesh(sphere,options.updatable);return sphere};MeshBuilder.CreateDisc=function(name,options,scene){var disc=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);disc._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreateDisc(options);vertexData.applyToMesh(disc,options.updatable);return disc};MeshBuilder.CreateIcoSphere=function(name,options,scene){var sphere=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);sphere._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreateIcoSphere(options);vertexData.applyToMesh(sphere,options.updatable);return sphere};MeshBuilder.CreateRibbon=function(name,options,scene){var pathArray=options.pathArray;var closeArray=options.closeArray;var closePath=options.closePath;var sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);var instance=options.instance;var updatable=options.updatable;if(instance){BABYLON.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,BABYLON.Tmp.Vector3[0]);BABYLON.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,BABYLON.Tmp.Vector3[1]);var positionFunction=function(positions){var minlg=pathArray[0].length;var i=0;var ns=instance._originalBuilderSideOrientation===BABYLON.Mesh.DOUBLESIDE?2:1;for(var si=1;si<=ns;si++){for(var p=0;p<pathArray.length;p++){var path=pathArray[p];var l=path.length;minlg=minlg<l?minlg:l;var j=0;while(j<minlg){positions[i]=path[j].x;positions[i+1]=path[j].y;positions[i+2]=path[j].z;if(path[j].x<BABYLON.Tmp.Vector3[0].x){BABYLON.Tmp.Vector3[0].x=path[j].x}if(path[j].x>BABYLON.Tmp.Vector3[1].x){BABYLON.Tmp.Vector3[1].x=path[j].x}if(path[j].y<BABYLON.Tmp.Vector3[0].y){BABYLON.Tmp.Vector3[0].y=path[j].y}if(path[j].y>BABYLON.Tmp.Vector3[1].y){BABYLON.Tmp.Vector3[1].y=path[j].y}if(path[j].z<BABYLON.Tmp.Vector3[0].z){BABYLON.Tmp.Vector3[0].z=path[j].z}if(path[j].z>BABYLON.Tmp.Vector3[1].z){BABYLON.Tmp.Vector3[1].z=path[j].z}j++;i+=3}if(instance._closePath){positions[i]=path[0].x;positions[i+1]=path[0].y;positions[i+2]=path[0].z;i+=3}}}};var positions=instance.getVerticesData(BABYLON.VertexBuffer.PositionKind);positionFunction(positions);instance._boundingInfo=new BABYLON.BoundingInfo(BABYLON.Tmp.Vector3[0],BABYLON.Tmp.Vector3[1]);instance._boundingInfo.update(instance._worldMatrix);instance.updateVerticesData(BABYLON.VertexBuffer.PositionKind,positions,false,false);if(options.colors){var colors=instance.getVerticesData(BABYLON.VertexBuffer.ColorKind);for(var c=0;c<options.colors.length;c++){colors[c*4]=options.colors[c].r;colors[c*4+1]=options.colors[c].g;colors[c*4+2]=options.colors[c].b;colors[c*4+3]=options.colors[c].a}instance.updateVerticesData(BABYLON.VertexBuffer.ColorKind,colors,false,false)}if(options.uvs){var uvs=instance.getVerticesData(BABYLON.VertexBuffer.UVKind);for(var i=0;i<options.uvs.length;i++){uvs[i*2]=options.uvs[i].x;uvs[i*2+1]=options.uvs[i].y}instance.updateVerticesData(BABYLON.VertexBuffer.UVKind,uvs,false,false)}if(!instance.areNormalsFrozen||instance.isFacetDataEnabled){var indices=instance.getIndices();var normals=instance.getVerticesData(BABYLON.VertexBuffer.NormalKind);var params=instance.isFacetDataEnabled?instance.getFacetDataParameters():null;BABYLON.VertexData.ComputeNormals(positions,indices,normals,params);if(instance._closePath){var indexFirst=0;var indexLast=0;for(var p=0;p<pathArray.length;p++){indexFirst=instance._idx[p]*3;if(p+1<pathArray.length){indexLast=(instance._idx[p+1]-1)*3}else{indexLast=normals.length-3}normals[indexFirst]=(normals[indexFirst]+normals[indexLast])*.5;normals[indexFirst+1]=(normals[indexFirst+1]+normals[indexLast+1])*.5;normals[indexFirst+2]=(normals[indexFirst+2]+normals[indexLast+2])*.5;normals[indexLast]=normals[indexFirst];normals[indexLast+1]=normals[indexFirst+1];normals[indexLast+2]=normals[indexFirst+2]}}if(!instance.areNormalsFrozen){instance.updateVerticesData(BABYLON.VertexBuffer.NormalKind,normals,false,false)}}return instance}else{var ribbon=new BABYLON.Mesh(name,scene);ribbon._originalBuilderSideOrientation=sideOrientation;var vertexData=BABYLON.VertexData.CreateRibbon(options);if(closePath){ribbon._idx=vertexData._idx}ribbon._closePath=closePath;ribbon._closeArray=closeArray;vertexData.applyToMesh(ribbon,updatable);return ribbon}};MeshBuilder.CreateCylinder=function(name,options,scene){var cylinder=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);cylinder._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreateCylinder(options);vertexData.applyToMesh(cylinder,options.updatable);return cylinder};MeshBuilder.CreateTorus=function(name,options,scene){var torus=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);torus._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreateTorus(options);vertexData.applyToMesh(torus,options.updatable);return torus};MeshBuilder.CreateTorusKnot=function(name,options,scene){var torusKnot=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);torusKnot._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreateTorusKnot(options);vertexData.applyToMesh(torusKnot,options.updatable);return torusKnot};MeshBuilder.CreateLineSystem=function(name,options,scene){var instance=options.instance;var lines=options.lines;if(instance){var positionFunction=function(positions){var i=0;for(var l=0;l<lines.length;l++){var points=lines[l];for(var p=0;p<points.length;p++){positions[i]=points[p].x;positions[i+1]=points[p].y;positions[i+2]=points[p].z;i+=3}}};instance.updateMeshPositions(positionFunction,false);return instance}var lineSystem=new BABYLON.LinesMesh(name,scene);var vertexData=BABYLON.VertexData.CreateLineSystem(options);vertexData.applyToMesh(lineSystem,options.updatable);return lineSystem};MeshBuilder.CreateLines=function(name,options,scene){var lines=MeshBuilder.CreateLineSystem(name,{lines:[options.points],updatable:options.updatable,instance:options.instance},scene);return lines};MeshBuilder.CreateDashedLines=function(name,options,scene){var points=options.points;var instance=options.instance;var gapSize=options.gapSize||1;var dashSize=options.dashSize||3;if(instance){var positionFunction=function(positions){var curvect=BABYLON.Vector3.Zero();var nbSeg=positions.length/6;var lg=0;var nb=0;var shft=0;var dashshft=0;var curshft=0;var p=0;var i=0;var j=0;for(i=0;i<points.length-1;i++){points[i+1].subtractToRef(points[i],curvect);lg+=curvect.length()}shft=lg/nbSeg;dashshft=instance.dashSize*shft/(instance.dashSize+instance.gapSize);for(i=0;i<points.length-1;i++){points[i+1].subtractToRef(points[i],curvect);nb=Math.floor(curvect.length()/shft);curvect.normalize();j=0;while(j<nb&&p<positions.length){curshft=shft*j;positions[p]=points[i].x+curshft*curvect.x;positions[p+1]=points[i].y+curshft*curvect.y;positions[p+2]=points[i].z+curshft*curvect.z;positions[p+3]=points[i].x+(curshft+dashshft)*curvect.x;positions[p+4]=points[i].y+(curshft+dashshft)*curvect.y;positions[p+5]=points[i].z+(curshft+dashshft)*curvect.z;p+=6;j++}}while(p<positions.length){positions[p]=points[i].x;positions[p+1]=points[i].y;positions[p+2]=points[i].z;p+=3}};instance.updateMeshPositions(positionFunction,false);return instance}var dashedLines=new BABYLON.LinesMesh(name,scene);var vertexData=BABYLON.VertexData.CreateDashedLines(options);vertexData.applyToMesh(dashedLines,options.updatable);dashedLines.dashSize=dashSize;dashedLines.gapSize=gapSize;return dashedLines};MeshBuilder.ExtrudeShape=function(name,options,scene){var path=options.path;var shape=options.shape;var scale=options.scale||1;var rotation=options.rotation||0;var cap=options.cap===0?0:options.cap||BABYLON.Mesh.NO_CAP;var updatable=options.updatable;var sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);var instance=options.instance;var invertUV=options.invertUV||false;return MeshBuilder._ExtrudeShapeGeneric(name,shape,path,scale,rotation,null,null,false,false,cap,false,scene,updatable,sideOrientation,instance,invertUV,options.frontUVs,options.backUVs)};MeshBuilder.ExtrudeShapeCustom=function(name,options,scene){var path=options.path;var shape=options.shape;var scaleFunction=options.scaleFunction||function(){return 1};var rotationFunction=options.rotationFunction||function(){return 0};var ribbonCloseArray=options.ribbonCloseArray||false;var ribbonClosePath=options.ribbonClosePath||false;var cap=options.cap===0?0:options.cap||BABYLON.Mesh.NO_CAP;var updatable=options.updatable;var sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);var instance=options.instance;var invertUV=options.invertUV||false;return MeshBuilder._ExtrudeShapeGeneric(name,shape,path,null,null,scaleFunction,rotationFunction,ribbonCloseArray,ribbonClosePath,cap,true,scene,updatable,sideOrientation,instance,invertUV,options.frontUVs,options.backUVs)};MeshBuilder.CreateLathe=function(name,options,scene){var arc=options.arc?options.arc<=0||options.arc>1?1:options.arc:1;var closed=options.closed===undefined?true:options.closed;var shape=options.shape;var radius=options.radius||1;var tessellation=options.tessellation||64;var updatable=options.updatable;var sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);var cap=options.cap||BABYLON.Mesh.NO_CAP;var pi2=Math.PI*2;var paths=new Array;var invertUV=options.invertUV||false;var i=0;var p=0;var step=pi2/tessellation*arc;var rotated;var path=new Array;for(i=0;i<=tessellation;i++){var path=[];if(cap==BABYLON.Mesh.CAP_START||cap==BABYLON.Mesh.CAP_ALL){path.push(new BABYLON.Vector3(0,shape[0].y,0));path.push(new BABYLON.Vector3(Math.cos(i*step)*shape[0].x*radius,shape[0].y,Math.sin(i*step)*shape[0].x*radius))}for(p=0;p<shape.length;p++){rotated=new BABYLON.Vector3(Math.cos(i*step)*shape[p].x*radius,shape[p].y,Math.sin(i*step)*shape[p].x*radius);path.push(rotated)}if(cap==BABYLON.Mesh.CAP_END||cap==BABYLON.Mesh.CAP_ALL){path.push(new BABYLON.Vector3(Math.cos(i*step)*shape[shape.length-1].x*radius,shape[shape.length-1].y,Math.sin(i*step)*shape[shape.length-1].x*radius));path.push(new BABYLON.Vector3(0,shape[shape.length-1].y,0))}paths.push(path)}var lathe=MeshBuilder.CreateRibbon(name,{pathArray:paths,closeArray:closed,sideOrientation:sideOrientation,updatable:updatable,invertUV:invertUV,frontUVs:options.frontUVs,backUVs:options.backUVs},scene);return lathe};MeshBuilder.CreatePlane=function(name,options,scene){var plane=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);plane._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreatePlane(options);vertexData.applyToMesh(plane,options.updatable);if(options.sourcePlane){plane.translate(options.sourcePlane.normal,options.sourcePlane.d);var product=Math.acos(BABYLON.Vector3.Dot(options.sourcePlane.normal,BABYLON.Axis.Z));var vectorProduct=BABYLON.Vector3.Cross(BABYLON.Axis.Z,options.sourcePlane.normal);plane.rotate(vectorProduct,product)}return plane};MeshBuilder.CreateGround=function(name,options,scene){var ground=new BABYLON.GroundMesh(name,scene);ground._setReady(false);ground._subdivisionsX=options.subdivisionsX||options.subdivisions||1;ground._subdivisionsY=options.subdivisionsY||options.subdivisions||1;ground._width=options.width||1;ground._height=options.height||1;ground._maxX=ground._width/2;ground._maxZ=ground._height/2;ground._minX=-ground._maxX;ground._minZ=-ground._maxZ;var vertexData=BABYLON.VertexData.CreateGround(options);vertexData.applyToMesh(ground,options.updatable);ground._setReady(true);return ground};MeshBuilder.CreateTiledGround=function(name,options,scene){var tiledGround=new BABYLON.Mesh(name,scene);var vertexData=BABYLON.VertexData.CreateTiledGround(options);vertexData.applyToMesh(tiledGround,options.updatable);return tiledGround};MeshBuilder.CreateGroundFromHeightMap=function(name,url,options,scene){var width=options.width||10;var height=options.height||10;var subdivisions=options.subdivisions||1|0;var minHeight=options.minHeight||0;var maxHeight=options.maxHeight||1;var filter=options.colorFilter||new BABYLON.Color3(.3,.59,.11);var updatable=options.updatable;var onReady=options.onReady;var ground=new BABYLON.GroundMesh(name,scene);ground._subdivisionsX=subdivisions;ground._subdivisionsY=subdivisions;ground._width=width;ground._height=height;ground._maxX=ground._width/2;ground._maxZ=ground._height/2;ground._minX=-ground._maxX;ground._minZ=-ground._maxZ;ground._setReady(false);var onload=function(img){var canvas=document.createElement("canvas");var context=canvas.getContext("2d");var bufferWidth=img.width;var bufferHeight=img.height;canvas.width=bufferWidth;canvas.height=bufferHeight;context.drawImage(img,0,0);var buffer=context.getImageData(0,0,bufferWidth,bufferHeight).data;var vertexData=BABYLON.VertexData.CreateGroundFromHeightMap({width:width,height:height,subdivisions:subdivisions,minHeight:minHeight,maxHeight:maxHeight,colorFilter:filter,buffer:buffer,bufferWidth:bufferWidth,bufferHeight:bufferHeight});vertexData.applyToMesh(ground,updatable);ground._setReady(true);if(onReady){onReady(ground)}};BABYLON.Tools.LoadImage(url,onload,function(){},scene.database);return ground};MeshBuilder.CreatePolygon=function(name,options,scene){options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);var shape=options.shape;var holes=options.holes||[];var depth=options.depth||0;var contours=[];var hole=[];for(var i=0;i<shape.length;i++){contours[i]=new BABYLON.Vector2(shape[i].x,shape[i].z)}var epsilon=1e-8;if(contours[0].equalsWithEpsilon(contours[contours.length-1],epsilon)){contours.pop()}var polygonTriangulation=new BABYLON.PolygonMeshBuilder(name,contours,scene);for(var hNb=0;hNb<holes.length;hNb++){hole=[];for(var hPoint=0;hPoint<holes[hNb].length;hPoint++){hole.push(new BABYLON.Vector2(holes[hNb][hPoint].x,holes[hNb][hPoint].z))}polygonTriangulation.addHole(hole)}var polygon=polygonTriangulation.build(options.updatable,depth);polygon._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreatePolygon(polygon,options.sideOrientation,options.faceUV,options.faceColors,options.frontUVs,options.backUVs);vertexData.applyToMesh(polygon,options.updatable);return polygon};MeshBuilder.ExtrudePolygon=function(name,options,scene){return MeshBuilder.CreatePolygon(name,options,scene)};MeshBuilder.CreateTube=function(name,options,scene){var path=options.path;var instance=options.instance;var radius=1;if(instance){radius=instance.radius}if(options.radius!==undefined){radius=options.radius}var tessellation=options.tessellation||64|0;var radiusFunction=options.radiusFunction;var cap=options.cap||BABYLON.Mesh.NO_CAP;var invertUV=options.invertUV||false;var updatable=options.updatable;var sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);options.arc=options.arc<=0||options.arc>1?1:options.arc||1;var tubePathArray=function(path,path3D,circlePaths,radius,tessellation,radiusFunction,cap,arc){var tangents=path3D.getTangents();var normals=path3D.getNormals();var distances=path3D.getDistances();var pi2=Math.PI*2;var step=pi2/tessellation*arc;var returnRadius=function(){return radius};var radiusFunctionFinal=radiusFunction||returnRadius;var circlePath;var rad;var normal;var rotated;var rotationMatrix=BABYLON.Tmp.Matrix[0];var index=cap===BABYLON.Mesh._NO_CAP||cap===BABYLON.Mesh.CAP_END?0:2;for(var i=0;i<path.length;i++){rad=radiusFunctionFinal(i,distances[i]);circlePath=Array();normal=normals[i];for(var t=0;t<tessellation;t++){BABYLON.Matrix.RotationAxisToRef(tangents[i],step*t,rotationMatrix);rotated=circlePath[t]?circlePath[t]:BABYLON.Vector3.Zero();BABYLON.Vector3.TransformCoordinatesToRef(normal,rotationMatrix,rotated);rotated.scaleInPlace(rad).addInPlace(path[i]);circlePath[t]=rotated}circlePaths[index]=circlePath;index++}var capPath=function(nbPoints,pathIndex){var pointCap=Array();for(var i=0;i<nbPoints;i++){pointCap.push(path[pathIndex])}return pointCap};switch(cap){case BABYLON.Mesh.NO_CAP:break;case BABYLON.Mesh.CAP_START:circlePaths[0]=capPath(tessellation,0);circlePaths[1]=circlePaths[2].slice(0);break;case BABYLON.Mesh.CAP_END:circlePaths[index]=circlePaths[index-1].slice(0);circlePaths[index+1]=capPath(tessellation,path.length-1);break;case BABYLON.Mesh.CAP_ALL:circlePaths[0]=capPath(tessellation,0);circlePaths[1]=circlePaths[2].slice(0);circlePaths[index]=circlePaths[index-1].slice(0);circlePaths[index+1]=capPath(tessellation,path.length-1);break;default:break}return circlePaths};var path3D;var pathArray;if(instance){var arc=options.arc||instance.arc;path3D=instance.path3D.update(path);pathArray=tubePathArray(path,path3D,instance.pathArray,radius,instance.tessellation,radiusFunction,instance.cap,arc);instance=MeshBuilder.CreateRibbon(null,{pathArray:pathArray,instance:instance});instance.path3D=path3D;instance.pathArray=pathArray;instance.arc=arc;instance.radius=radius;return instance}path3D=new BABYLON.Path3D(path);var newPathArray=new Array;cap=cap<0||cap>3?0:cap;pathArray=tubePathArray(path,path3D,newPathArray,radius,tessellation,radiusFunction,cap,options.arc);var tube=MeshBuilder.CreateRibbon(name,{pathArray:pathArray,closePath:true,closeArray:false,updatable:updatable,sideOrientation:sideOrientation,invertUV:invertUV,frontUVs:options.frontUVs,backUVs:options.backUVs},scene);tube.pathArray=pathArray;tube.path3D=path3D;tube.tessellation=tessellation;tube.cap=cap;tube.arc=options.arc;tube.radius=radius;return tube};MeshBuilder.CreatePolyhedron=function(name,options,scene){var polyhedron=new BABYLON.Mesh(name,scene);options.sideOrientation=MeshBuilder.updateSideOrientation(options.sideOrientation,scene);polyhedron._originalBuilderSideOrientation=options.sideOrientation;var vertexData=BABYLON.VertexData.CreatePolyhedron(options);vertexData.applyToMesh(polyhedron,options.updatable);return polyhedron};MeshBuilder.CreateDecal=function(name,sourceMesh,options){var indices=sourceMesh.getIndices();var positions=sourceMesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);var normals=sourceMesh.getVerticesData(BABYLON.VertexBuffer.NormalKind);var position=options.position||BABYLON.Vector3.Zero();var normal=options.normal||BABYLON.Vector3.Up();var size=options.size||BABYLON.Vector3.One();var angle=options.angle||0;if(!normal){var target=new BABYLON.Vector3(0,0,1);var camera=sourceMesh.getScene().activeCamera;var cameraWorldTarget=BABYLON.Vector3.TransformCoordinates(target,camera.getWorldMatrix());normal=camera.globalPosition.subtract(cameraWorldTarget)}var yaw=-Math.atan2(normal.z,normal.x)-Math.PI/2;var len=Math.sqrt(normal.x*normal.x+normal.z*normal.z);var pitch=Math.atan2(normal.y,len);var decalWorldMatrix=BABYLON.Matrix.RotationYawPitchRoll(yaw,pitch,angle).multiply(BABYLON.Matrix.Translation(position.x,position.y,position.z));var inverseDecalWorldMatrix=BABYLON.Matrix.Invert(decalWorldMatrix);var meshWorldMatrix=sourceMesh.getWorldMatrix();var transformMatrix=meshWorldMatrix.multiply(inverseDecalWorldMatrix);var vertexData=new BABYLON.VertexData;vertexData.indices=[];vertexData.positions=[];vertexData.normals=[];vertexData.uvs=[];var currentVertexDataIndex=0;var extractDecalVector3=function(indexId){var vertexId=indices[indexId];var result=new BABYLON.PositionNormalVertex;result.position=new BABYLON.Vector3(positions[vertexId*3],positions[vertexId*3+1],positions[vertexId*3+2]);result.position=BABYLON.Vector3.TransformCoordinates(result.position,transformMatrix);result.normal=new BABYLON.Vector3(normals[vertexId*3],normals[vertexId*3+1],normals[vertexId*3+2]);result.normal=BABYLON.Vector3.TransformNormal(result.normal,transformMatrix);return result};var clip=function(vertices,axis){if(vertices.length===0){return vertices}var clipSize=.5*Math.abs(BABYLON.Vector3.Dot(size,axis));var clipVertices=function(v0,v1){var clipFactor=BABYLON.Vector3.GetClipFactor(v0.position,v1.position,axis,clipSize);return new BABYLON.PositionNormalVertex(BABYLON.Vector3.Lerp(v0.position,v1.position,clipFactor),BABYLON.Vector3.Lerp(v0.normal,v1.normal,clipFactor))};var result=new Array;for(var index=0;index<vertices.length;index+=3){var v1Out;var v2Out;var v3Out;var total=0;var nV1,nV2,nV3,nV4;var d1=BABYLON.Vector3.Dot(vertices[index].position,axis)-clipSize;var d2=BABYLON.Vector3.Dot(vertices[index+1].position,axis)-clipSize;var d3=BABYLON.Vector3.Dot(vertices[index+2].position,axis)-clipSize;v1Out=d1>0;v2Out=d2>0;v3Out=d3>0;total=(v1Out?1:0)+(v2Out?1:0)+(v3Out?1:0);switch(total){case 0:result.push(vertices[index]);result.push(vertices[index+1]);result.push(vertices[index+2]);break;case 1:if(v1Out){nV1=vertices[index+1];nV2=vertices[index+2];nV3=clipVertices(vertices[index],nV1);nV4=clipVertices(vertices[index],nV2)}if(v2Out){nV1=vertices[index];nV2=vertices[index+2];nV3=clipVertices(vertices[index+1],nV1);nV4=clipVertices(vertices[index+1],nV2);result.push(nV3);result.push(nV2.clone());result.push(nV1.clone());result.push(nV2.clone());result.push(nV3.clone());result.push(nV4);break}if(v3Out){nV1=vertices[index];nV2=vertices[index+1];nV3=clipVertices(vertices[index+2],nV1);nV4=clipVertices(vertices[index+2],nV2)}result.push(nV1.clone());result.push(nV2.clone());result.push(nV3);result.push(nV4);result.push(nV3.clone());result.push(nV2.clone());break;case 2:if(!v1Out){nV1=vertices[index].clone();nV2=clipVertices(nV1,vertices[index+1]);nV3=clipVertices(nV1,vertices[index+2]);result.push(nV1);result.push(nV2);result.push(nV3)}if(!v2Out){nV1=vertices[index+1].clone();nV2=clipVertices(nV1,vertices[index+2]);nV3=clipVertices(nV1,vertices[index]);result.push(nV1);result.push(nV2);result.push(nV3)}if(!v3Out){nV1=vertices[index+2].clone();nV2=clipVertices(nV1,vertices[index]);nV3=clipVertices(nV1,vertices[index+1]);result.push(nV1);result.push(nV2);result.push(nV3)}break;case 3:break}}return result};for(var index=0;index<indices.length;index+=3){var faceVertices=new Array;faceVertices.push(extractDecalVector3(index));faceVertices.push(extractDecalVector3(index+1));faceVertices.push(extractDecalVector3(index+2));faceVertices=clip(faceVertices,new BABYLON.Vector3(1,0,0));faceVertices=clip(faceVertices,new BABYLON.Vector3(-1,0,0));faceVertices=clip(faceVertices,new BABYLON.Vector3(0,1,0));faceVertices=clip(faceVertices,new BABYLON.Vector3(0,-1,0));faceVertices=clip(faceVertices,new BABYLON.Vector3(0,0,1));faceVertices=clip(faceVertices,new BABYLON.Vector3(0,0,-1));if(faceVertices.length===0){continue}for(var vIndex=0;vIndex<faceVertices.length;vIndex++){var vertex=faceVertices[vIndex];vertexData.indices.push(currentVertexDataIndex);vertex.position.toArray(vertexData.positions,currentVertexDataIndex*3);vertex.normal.toArray(vertexData.normals,currentVertexDataIndex*3);vertexData.uvs.push(.5+vertex.position.x/size.x);vertexData.uvs.push(.5+vertex.position.y/size.y);currentVertexDataIndex++}}var decal=new BABYLON.Mesh(name,sourceMesh.getScene());vertexData.applyToMesh(decal);decal.position=position.clone();decal.rotation=new BABYLON.Vector3(pitch,yaw,angle);return decal};MeshBuilder._ExtrudeShapeGeneric=function(name,shape,curve,scale,rotation,scaleFunction,rotateFunction,rbCA,rbCP,cap,custom,scene,updtbl,side,instance,invertUV,frontUVs,backUVs){var extrusionPathArray=function(shape,curve,path3D,shapePaths,scale,rotation,scaleFunction,rotateFunction,cap,custom){var tangents=path3D.getTangents();var normals=path3D.getNormals();var binormals=path3D.getBinormals();var distances=path3D.getDistances();var angle=0;var returnScale=function(){return scale};var returnRotation=function(){return rotation};var rotate=custom?rotateFunction:returnRotation;var scl=custom?scaleFunction:returnScale;var index=cap===BABYLON.Mesh.NO_CAP||cap===BABYLON.Mesh.CAP_END?0:2;var rotationMatrix=BABYLON.Tmp.Matrix[0];for(var i=0;i<curve.length;i++){var shapePath=new Array;var angleStep=rotate(i,distances[i]);var scaleRatio=scl(i,distances[i]);for(var p=0;p<shape.length;p++){BABYLON.Matrix.RotationAxisToRef(tangents[i],angle,rotationMatrix);var planed=tangents[i].scale(shape[p].z).add(normals[i].scale(shape[p].x)).add(binormals[i].scale(shape[p].y));var rotated=shapePath[p]?shapePath[p]:BABYLON.Vector3.Zero();BABYLON.Vector3.TransformCoordinatesToRef(planed,rotationMatrix,rotated);rotated.scaleInPlace(scaleRatio).addInPlace(curve[i]);shapePath[p]=rotated}shapePaths[index]=shapePath;angle+=angleStep;index++}var capPath=function(shapePath){var pointCap=Array();var barycenter=BABYLON.Vector3.Zero();var i;for(i=0;i<shapePath.length;i++){barycenter.addInPlace(shapePath[i])}barycenter.scaleInPlace(1/shapePath.length);for(i=0;i<shapePath.length;i++){pointCap.push(barycenter)}return pointCap};switch(cap){case BABYLON.Mesh.NO_CAP:break;case BABYLON.Mesh.CAP_START:shapePaths[0]=capPath(shapePaths[2]);shapePaths[1]=shapePaths[2];break;case BABYLON.Mesh.CAP_END:shapePaths[index]=shapePaths[index-1];shapePaths[index+1]=capPath(shapePaths[index-1]);break;case BABYLON.Mesh.CAP_ALL:shapePaths[0]=capPath(shapePaths[2]);shapePaths[1]=shapePaths[2];shapePaths[index]=shapePaths[index-1];shapePaths[index+1]=capPath(shapePaths[index-1]);break;default:break}return shapePaths};var path3D;var pathArray;if(instance){path3D=instance.path3D.update(curve);pathArray=extrusionPathArray(shape,curve,instance.path3D,instance.pathArray,scale,rotation,scaleFunction,rotateFunction,instance.cap,custom);instance=BABYLON.Mesh.CreateRibbon(null,pathArray,null,null,null,scene,null,null,instance);return instance}path3D=new BABYLON.Path3D(curve);var newShapePaths=new Array;cap=cap<0||cap>3?0:cap;pathArray=extrusionPathArray(shape,curve,path3D,newShapePaths,scale,rotation,scaleFunction,rotateFunction,cap,custom);var extrudedGeneric=MeshBuilder.CreateRibbon(name,{pathArray:pathArray,closeArray:rbCA,closePath:rbCP,updatable:updtbl,sideOrientation:side,invertUV:invertUV,frontUVs:frontUVs,backUVs:backUVs},scene);extrudedGeneric.pathArray=pathArray;extrudedGeneric.path3D=path3D;extrudedGeneric.cap=cap;return extrudedGeneric};return MeshBuilder}();BABYLON.MeshBuilder=MeshBuilder})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var AudioEngine=function(){function AudioEngine(){this._audioContext=null;this._audioContextInitialized=false;this.canUseWebAudio=false;this.WarnedWebAudioUnsupported=false;this.unlocked=false;this.isMP3supported=false;this.isOGGsupported=false;if(typeof window.AudioContext!=="undefined"||typeof window.webkitAudioContext!=="undefined"){window.AudioContext=window.AudioContext||window.webkitAudioContext;this.canUseWebAudio=true}var audioElem=document.createElement("audio");try{if(audioElem&&!!audioElem.canPlayType&&audioElem.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")){this.isMP3supported=true}}catch(e){}try{if(audioElem&&!!audioElem.canPlayType&&audioElem.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")){this.isOGGsupported=true}}catch(e){}if(/iPad|iPhone|iPod/.test(navigator.platform)){this._unlockiOSaudio()}else{this.unlocked=true}}Object.defineProperty(AudioEngine.prototype,"audioContext",{get:function(){if(!this._audioContextInitialized){this._initializeAudioContext()}return this._audioContext},enumerable:true,configurable:true});AudioEngine.prototype._unlockiOSaudio=function(){var _this=this;var unlockaudio=function(){var buffer=_this.audioContext.createBuffer(1,1,22050);var source=_this.audioContext.createBufferSource();source.buffer=buffer;source.connect(_this.audioContext.destination);source.start(0);setTimeout(function(){if(source.playbackState===source.PLAYING_STATE||source.playbackState===source.FINISHED_STATE){_this.unlocked=true;window.removeEventListener("touchend",unlockaudio,false);if(_this.onAudioUnlocked){_this.onAudioUnlocked()}}},0)};window.addEventListener("touchend",unlockaudio,false)};AudioEngine.prototype._initializeAudioContext=function(){try{if(this.canUseWebAudio){this._audioContext=new AudioContext;this.masterGain=this._audioContext.createGain();this.masterGain.gain.value=1;this.masterGain.connect(this._audioContext.destination);this._audioContextInitialized=true}}catch(e){this.canUseWebAudio=false;BABYLON.Tools.Error("Web Audio: "+e.message)}};AudioEngine.prototype.dispose=function(){if(this.canUseWebAudio&&this._audioContextInitialized){if(this._connectedAnalyser){this._connectedAnalyser.stopDebugCanvas();this._connectedAnalyser.dispose();this.masterGain.disconnect();this.masterGain.connect(this._audioContext.destination);this._connectedAnalyser=null}this.masterGain.gain.value=1}this.WarnedWebAudioUnsupported=false};AudioEngine.prototype.getGlobalVolume=function(){if(this.canUseWebAudio&&this._audioContextInitialized){return this.masterGain.gain.value}else{return-1}};AudioEngine.prototype.setGlobalVolume=function(newVolume){if(this.canUseWebAudio&&this._audioContextInitialized){this.masterGain.gain.value=newVolume}};AudioEngine.prototype.connectToAnalyser=function(analyser){if(this._connectedAnalyser){this._connectedAnalyser.stopDebugCanvas()}if(this.canUseWebAudio&&this._audioContextInitialized){this._connectedAnalyser=analyser;this.masterGain.disconnect();this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination)}};return AudioEngine}();BABYLON.AudioEngine=AudioEngine})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Sound=function(){function Sound(name,urlOrArrayBuffer,scene,readyToPlayCallback,options){var _this=this;this.autoplay=false;this.loop=false;this.useCustomAttenuation=false;this.spatialSound=false;this.refDistance=1;this.rolloffFactor=1;this.maxDistance=100;this.distanceModel="linear";this._panningModel="equalpower";this._playbackRate=1;this._streaming=false;this._startTime=0;this._startOffset=0;this._position=BABYLON.Vector3.Zero();this._localDirection=new BABYLON.Vector3(1,0,0);this._volume=1;this._isLoaded=false;this._isReadyToPlay=false;this.isPlaying=false;this.isPaused=false;this._isDirectional=false;this._coneInnerAngle=360;this._coneOuterAngle=360;this._coneOuterGain=0;this._isOutputConnected=false;this._urlType="Unknown";this.name=name;this._scene=scene;this._readyToPlayCallback=readyToPlayCallback;this._customAttenuationFunction=function(currentVolume,currentDistance,maxDistance,refDistance,rolloffFactor){if(currentDistance<maxDistance){return currentVolume*(1-currentDistance/maxDistance)}else{return 0}};if(options){this.autoplay=options.autoplay||false;this.loop=options.loop||false;if(options.volume!==undefined){this._volume=options.volume}this.spatialSound=options.spatialSound||false;this.maxDistance=options.maxDistance||100;this.useCustomAttenuation=options.useCustomAttenuation||false;this.rolloffFactor=options.rolloffFactor||1;this.refDistance=options.refDistance||1;this.distanceModel=options.distanceModel||"linear";this._playbackRate=options.playbackRate||1;this._streaming=options.streaming||false}if(BABYLON.Engine.audioEngine.canUseWebAudio){this._soundGain=BABYLON.Engine.audioEngine.audioContext.createGain();this._soundGain.gain.value=this._volume;this._inputAudioNode=this._soundGain;this._ouputAudioNode=this._soundGain;if(this.spatialSound){this._createSpatialParameters()}this._scene.mainSoundTrack.AddSound(this);var validParameter=true;if(urlOrArrayBuffer){if(typeof urlOrArrayBuffer==="string")this._urlType="String";if(Array.isArray(urlOrArrayBuffer))this._urlType="Array";if(urlOrArrayBuffer instanceof ArrayBuffer)this._urlType="ArrayBuffer";var urls=[];var codecSupportedFound=false;switch(this._urlType){case"ArrayBuffer":if(urlOrArrayBuffer.byteLength>0){codecSupportedFound=true;this._soundLoaded(urlOrArrayBuffer)}break;case"String":urls.push(urlOrArrayBuffer);case"Array":if(urls.length===0)urls=urlOrArrayBuffer;for(var i=0;i<urls.length;i++){var url=urls[i];if(url.indexOf(".mp3",url.length-4)!==-1&&BABYLON.Engine.audioEngine.isMP3supported){codecSupportedFound=true}if(url.indexOf(".ogg",url.length-4)!==-1&&BABYLON.Engine.audioEngine.isOGGsupported){codecSupportedFound=true}if(url.indexOf(".wav",url.length-4)!==-1){codecSupportedFound=true}if(url.indexOf("blob:")!==-1){codecSupportedFound=true}if(codecSupportedFound){if(!this._streaming){BABYLON.Tools.LoadFile(url,function(data){_this._soundLoaded(data)},null,this._scene.database,true)}else{this._htmlAudioElement=new Audio(url);this._htmlAudioElement.controls=false;this._htmlAudioElement.loop=this.loop;this._htmlAudioElement.crossOrigin="anonymous";this._htmlAudioElement.preload="auto";this._htmlAudioElement.addEventListener("canplaythrough",function(){_this._isReadyToPlay=true;if(_this.autoplay){_this.play()}if(_this._readyToPlayCallback){_this._readyToPlayCallback()}});document.body.appendChild(this._htmlAudioElement)}break}}break;default:validParameter=false;break}if(!validParameter){BABYLON.Tools.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}else{if(!codecSupportedFound){this._isReadyToPlay=true;if(this._readyToPlayCallback){window.setTimeout(function(){_this._readyToPlayCallback()},1e3)}}}}}else{this._scene.mainSoundTrack.AddSound(this);if(!BABYLON.Engine.audioEngine.WarnedWebAudioUnsupported){BABYLON.Tools.Error("Web Audio is not supported by your browser.");BABYLON.Engine.audioEngine.WarnedWebAudioUnsupported=true}if(this._readyToPlayCallback){window.setTimeout(function(){_this._readyToPlayCallback()},1e3)}}}Sound.prototype.dispose=function(){if(BABYLON.Engine.audioEngine.canUseWebAudio&&this._isReadyToPlay){if(this.isPlaying){this.stop()}this._isReadyToPlay=false;if(this.soundTrackId===-1){this._scene.mainSoundTrack.RemoveSound(this)}else{this._scene.soundTracks[this.soundTrackId].RemoveSound(this)}if(this._soundGain){this._soundGain.disconnect();this._soundGain=null}if(this._soundPanner){this._soundPanner.disconnect();this._soundPanner=null}if(this._soundSource){this._soundSource.disconnect();this._soundSource=null}this._audioBuffer=null;if(this._htmlAudioElement){this._htmlAudioElement.pause();this._htmlAudioElement.src="";document.body.removeChild(this._htmlAudioElement)}if(this._connectedMesh){this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc);this._connectedMesh=null}}};Sound.prototype.isReady=function(){return this._isReadyToPlay};Sound.prototype._soundLoaded=function(audioData){var _this=this;this._isLoaded=true;BABYLON.Engine.audioEngine.audioContext.decodeAudioData(audioData,function(buffer){_this._audioBuffer=buffer;_this._isReadyToPlay=true;if(_this.autoplay){_this.play()}if(_this._readyToPlayCallback){_this._readyToPlayCallback()}},function(err){BABYLON.Tools.Error("Error while decoding audio data for: "+_this.name+" / Error: "+err)})};Sound.prototype.setAudioBuffer=function(audioBuffer){if(BABYLON.Engine.audioEngine.canUseWebAudio){this._audioBuffer=audioBuffer;this._isReadyToPlay=true}};Sound.prototype.updateOptions=function(options){if(options){this.loop=options.loop||this.loop;this.maxDistance=options.maxDistance||this.maxDistance;this.useCustomAttenuation=options.useCustomAttenuation||this.useCustomAttenuation;this.rolloffFactor=options.rolloffFactor||this.rolloffFactor;this.refDistance=options.refDistance||this.refDistance;this.distanceModel=options.distanceModel||this.distanceModel;this._playbackRate=options.playbackRate||this._playbackRate;this._updateSpatialParameters();if(this.isPlaying){if(this._streaming){this._htmlAudioElement.playbackRate=this._playbackRate}else{this._soundSource.playbackRate.value=this._playbackRate}}}};Sound.prototype._createSpatialParameters=function(){if(BABYLON.Engine.audioEngine.canUseWebAudio){if(this._scene.headphone){this._panningModel="HRTF"}this._soundPanner=BABYLON.Engine.audioEngine.audioContext.createPanner();this._updateSpatialParameters();this._soundPanner.connect(this._ouputAudioNode);this._inputAudioNode=this._soundPanner}};Sound.prototype._updateSpatialParameters=function(){if(this.spatialSound){if(this.useCustomAttenuation){this._soundPanner.distanceModel="linear";this._soundPanner.maxDistance=Number.MAX_VALUE;this._soundPanner.refDistance=1;this._soundPanner.rolloffFactor=1;this._soundPanner.panningModel=this._panningModel}else{this._soundPanner.distanceModel=this.distanceModel;this._soundPanner.maxDistance=this.maxDistance;this._soundPanner.refDistance=this.refDistance;this._soundPanner.rolloffFactor=this.rolloffFactor;this._soundPanner.panningModel=this._panningModel}}};Sound.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF";this._switchPanningModel()};Sound.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower";this._switchPanningModel()};Sound.prototype._switchPanningModel=function(){if(BABYLON.Engine.audioEngine.canUseWebAudio&&this.spatialSound){this._soundPanner.panningModel=this._panningModel}};Sound.prototype.connectToSoundTrackAudioNode=function(soundTrackAudioNode){if(BABYLON.Engine.audioEngine.canUseWebAudio){if(this._isOutputConnected){this._ouputAudioNode.disconnect()}this._ouputAudioNode.connect(soundTrackAudioNode);this._isOutputConnected=true}};Sound.prototype.setDirectionalCone=function(coneInnerAngle,coneOuterAngle,coneOuterGain){if(coneOuterAngle<coneInnerAngle){BABYLON.Tools.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=coneInnerAngle;this._coneOuterAngle=coneOuterAngle;this._coneOuterGain=coneOuterGain;this._isDirectional=true;if(this.isPlaying&&this.loop){this.stop();this.play()}};Sound.prototype.setPosition=function(newPosition){this._position=newPosition;if(BABYLON.Engine.audioEngine.canUseWebAudio&&this.spatialSound){this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z)}};Sound.prototype.setLocalDirectionToMesh=function(newLocalDirection){this._localDirection=newLocalDirection;if(BABYLON.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.isPlaying){this._updateDirection()}};Sound.prototype._updateDirection=function(){var mat=this._connectedMesh.getWorldMatrix();var direction=BABYLON.Vector3.TransformNormal(this._localDirection,mat);direction.normalize();this._soundPanner.setOrientation(direction.x,direction.y,direction.z)};Sound.prototype.updateDistanceFromListener=function(){if(BABYLON.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.useCustomAttenuation){var distance=this._connectedMesh.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,distance,this.maxDistance,this.refDistance,this.rolloffFactor)}};Sound.prototype.setAttenuationFunction=function(callback){this._customAttenuationFunction=callback};Sound.prototype.play=function(time,offset){var _this=this;if(this._isReadyToPlay&&this._scene.audioEnabled){try{if(this._startOffset<0){time=-this._startOffset;this._startOffset=0}var startTime=time?BABYLON.Engine.audioEngine.audioContext.currentTime+time:BABYLON.Engine.audioEngine.audioContext.currentTime;if(!this._soundSource||!this._streamingSource){if(this.spatialSound){this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z);if(this._isDirectional){this._soundPanner.coneInnerAngle=this._coneInnerAngle;this._soundPanner.coneOuterAngle=this._coneOuterAngle;this._soundPanner.coneOuterGain=this._coneOuterGain;if(this._connectedMesh){this._updateDirection()}else{this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z)}}}}if(this._streaming){if(!this._streamingSource){this._streamingSource=BABYLON.Engine.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement);this._htmlAudioElement.onended=function(){_this._onended()};this._htmlAudioElement.playbackRate=this._playbackRate}this._streamingSource.disconnect();this._streamingSource.connect(this._inputAudioNode);this._htmlAudioElement.play()}else{this._soundSource=BABYLON.Engine.audioEngine.audioContext.createBufferSource();this._soundSource.buffer=this._audioBuffer;this._soundSource.connect(this._inputAudioNode);this._soundSource.loop=this.loop;this._soundSource.playbackRate.value=this._playbackRate;this._soundSource.onended=function(){_this._onended()};this._soundSource.start(startTime,this.isPaused?this._startOffset%this._soundSource.buffer.duration:offset?offset:0)}this._startTime=startTime;this.isPlaying=true;this.isPaused=false}catch(ex){BABYLON.Tools.Error("Error while trying to play audio: "+this.name+", "+ex.message)}}};Sound.prototype._onended=function(){this.isPlaying=false;if(this.onended){this.onended()}};Sound.prototype.stop=function(time){if(this.isPlaying){if(this._streaming){this._htmlAudioElement.pause();if(this._htmlAudioElement.currentTime>0){this._htmlAudioElement.currentTime=0}}else{var stopTime=time?BABYLON.Engine.audioEngine.audioContext.currentTime+time:BABYLON.Engine.audioEngine.audioContext.currentTime;this._soundSource.stop(stopTime);this._soundSource.onended=null;if(!this.isPaused){this._startOffset=0}}this.isPlaying=false}};Sound.prototype.pause=function(){if(this.isPlaying){this.isPaused=true;if(this._streaming){this._htmlAudioElement.pause()}else{this.stop(0);this._startOffset+=BABYLON.Engine.audioEngine.audioContext.currentTime-this._startTime}}};Sound.prototype.setVolume=function(newVolume,time){if(BABYLON.Engine.audioEngine.canUseWebAudio){if(time){this._soundGain.gain.cancelScheduledValues(BABYLON.Engine.audioEngine.audioContext.currentTime);this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,BABYLON.Engine.audioEngine.audioContext.currentTime);this._soundGain.gain.linearRampToValueAtTime(newVolume,BABYLON.Engine.audioEngine.audioContext.currentTime+time)}else{this._soundGain.gain.value=newVolume}}this._volume=newVolume};Sound.prototype.setPlaybackRate=function(newPlaybackRate){this._playbackRate=newPlaybackRate;if(this.isPlaying){if(this._streaming){this._htmlAudioElement.playbackRate=this._playbackRate}else{this._soundSource.playbackRate.value=this._playbackRate}}};Sound.prototype.getVolume=function(){return this._volume};Sound.prototype.attachToMesh=function(meshToConnectTo){var _this=this;if(this._connectedMesh){this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc);this._registerFunc=null}this._connectedMesh=meshToConnectTo;if(!this.spatialSound){this.spatialSound=true;this._createSpatialParameters();if(this.isPlaying&&this.loop){this.stop();this.play()}}this._onRegisterAfterWorldMatrixUpdate(this._connectedMesh);this._registerFunc=function(connectedMesh){return _this._onRegisterAfterWorldMatrixUpdate(connectedMesh)};meshToConnectTo.registerAfterWorldMatrixUpdate(this._registerFunc)};Sound.prototype.detachFromMesh=function(){if(this._connectedMesh){this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc);this._registerFunc=null;this._connectedMesh=null}};Sound.prototype._onRegisterAfterWorldMatrixUpdate=function(connectedMesh){this.setPosition(connectedMesh.getBoundingInfo().boundingSphere.centerWorld);if(BABYLON.Engine.audioEngine.canUseWebAudio&&this._isDirectional&&this.isPlaying){this._updateDirection()}};Sound.prototype.clone=function(){var _this=this;if(!this._streaming){var setBufferAndRun=function(){if(_this._isReadyToPlay){clonedSound._audioBuffer=_this.getAudioBuffer();clonedSound._isReadyToPlay=true;if(clonedSound.autoplay){clonedSound.play()}}else{window.setTimeout(setBufferAndRun,300)}};var currentOptions={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel};var clonedSound=new Sound(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,currentOptions);if(this.useCustomAttenuation){clonedSound.setAttenuationFunction(this._customAttenuationFunction)}clonedSound.setPosition(this._position);clonedSound.setPlaybackRate(this._playbackRate);setBufferAndRun();return clonedSound}else{return null}};Sound.prototype.getAudioBuffer=function(){return this._audioBuffer};Sound.prototype.serialize=function(){var serializationObject={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId};if(this.spatialSound){if(this._connectedMesh)serializationObject.connectedMeshId=this._connectedMesh.id;serializationObject.position=this._position.asArray();serializationObject.refDistance=this.refDistance;serializationObject.distanceModel=this.distanceModel;serializationObject.isDirectional=this._isDirectional;serializationObject.localDirectionToMesh=this._localDirection.asArray();serializationObject.coneInnerAngle=this._coneInnerAngle;serializationObject.coneOuterAngle=this._coneOuterAngle;serializationObject.coneOuterGain=this._coneOuterGain}return serializationObject};Sound.Parse=function(parsedSound,scene,rootUrl,sourceSound){var soundName=parsedSound.name;var soundUrl;if(parsedSound.url){soundUrl=rootUrl+parsedSound.url}else{soundUrl=rootUrl+soundName}var options={autoplay:parsedSound.autoplay,loop:parsedSound.loop,volume:parsedSound.volume,spatialSound:parsedSound.spatialSound,maxDistance:parsedSound.maxDistance,rolloffFactor:parsedSound.rolloffFactor,refDistance:parsedSound.refDistance,distanceModel:parsedSound.distanceModel,playbackRate:parsedSound.playbackRate};var newSound;if(!sourceSound){newSound=new Sound(soundName,soundUrl,scene,function(){scene._removePendingData(newSound)},options);scene._addPendingData(newSound)}else{var setBufferAndRun=function(){if(sourceSound._isReadyToPlay){newSound._audioBuffer=sourceSound.getAudioBuffer();newSound._isReadyToPlay=true;if(newSound.autoplay){newSound.play()}}else{window.setTimeout(setBufferAndRun,300)}};newSound=new Sound(soundName,new ArrayBuffer(0),scene,null,options);setBufferAndRun()}if(parsedSound.position){var soundPosition=BABYLON.Vector3.FromArray(parsedSound.position);newSound.setPosition(soundPosition)}if(parsedSound.isDirectional){newSound.setDirectionalCone(parsedSound.coneInnerAngle||360,parsedSound.coneOuterAngle||360,parsedSound.coneOuterGain||0);if(parsedSound.localDirectionToMesh){var localDirectionToMesh=BABYLON.Vector3.FromArray(parsedSound.localDirectionToMesh);newSound.setLocalDirectionToMesh(localDirectionToMesh)}}if(parsedSound.connectedMeshId){var connectedMesh=scene.getMeshByID(parsedSound.connectedMeshId);if(connectedMesh){newSound.attachToMesh(connectedMesh)}}return newSound};return Sound}();BABYLON.Sound=Sound})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SoundTrack=function(){function SoundTrack(scene,options){this.id=-1;this._isMainTrack=false;this._isInitialized=false;this._scene=scene;this.soundCollection=new Array;this._options=options;if(!this._isMainTrack){this._scene.soundTracks.push(this);this.id=this._scene.soundTracks.length-1}}SoundTrack.prototype._initializeSoundTrackAudioGraph=function(){if(BABYLON.Engine.audioEngine.canUseWebAudio){this._outputAudioNode=BABYLON.Engine.audioEngine.audioContext.createGain();this._outputAudioNode.connect(BABYLON.Engine.audioEngine.masterGain);if(this._options){if(this._options.volume){this._outputAudioNode.gain.value=this._options.volume}if(this._options.mainTrack){this._isMainTrack=this._options.mainTrack}}this._isInitialized=true}};SoundTrack.prototype.dispose=function(){if(BABYLON.Engine.audioEngine.canUseWebAudio){if(this._connectedAnalyser){this._connectedAnalyser.stopDebugCanvas()}while(this.soundCollection.length){this.soundCollection[0].dispose()}if(this._outputAudioNode){this._outputAudioNode.disconnect()}this._outputAudioNode=null}};SoundTrack.prototype.AddSound=function(sound){if(!this._isInitialized){this._initializeSoundTrackAudioGraph()}if(BABYLON.Engine.audioEngine.canUseWebAudio){sound.connectToSoundTrackAudioNode(this._outputAudioNode)}if(sound.soundTrackId){if(sound.soundTrackId===-1){this._scene.mainSoundTrack.RemoveSound(sound)}else{this._scene.soundTracks[sound.soundTrackId].RemoveSound(sound)}}this.soundCollection.push(sound);sound.soundTrackId=this.id};SoundTrack.prototype.RemoveSound=function(sound){var index=this.soundCollection.indexOf(sound);if(index!==-1){this.soundCollection.splice(index,1)}};SoundTrack.prototype.setVolume=function(newVolume){if(BABYLON.Engine.audioEngine.canUseWebAudio){this._outputAudioNode.gain.value=newVolume}};SoundTrack.prototype.switchPanningModelToHRTF=function(){if(BABYLON.Engine.audioEngine.canUseWebAudio){for(var i=0;i<this.soundCollection.length;i++){this.soundCollection[i].switchPanningModelToHRTF()}}};SoundTrack.prototype.switchPanningModelToEqualPower=function(){if(BABYLON.Engine.audioEngine.canUseWebAudio){for(var i=0;i<this.soundCollection.length;i++){this.soundCollection[i].switchPanningModelToEqualPower()}}};SoundTrack.prototype.connectToAnalyser=function(analyser){if(this._connectedAnalyser){this._connectedAnalyser.stopDebugCanvas()}this._connectedAnalyser=analyser;if(BABYLON.Engine.audioEngine.canUseWebAudio){this._outputAudioNode.disconnect();this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,BABYLON.Engine.audioEngine.masterGain)}};return SoundTrack}();BABYLON.SoundTrack=SoundTrack})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Analyser=function(){function Analyser(scene){this.SMOOTHING=.75;this.FFT_SIZE=512;this.BARGRAPHAMPLITUDE=256;this.DEBUGCANVASPOS={x:20,y:20};this.DEBUGCANVASSIZE={width:320,height:200};this._scene=scene;this._audioEngine=BABYLON.Engine.audioEngine;if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser();this._webAudioAnalyser.minDecibels=-140;this._webAudioAnalyser.maxDecibels=0;this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount);this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount);this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount)}}Analyser.prototype.getFrequencyBinCount=function(){if(this._audioEngine.canUseWebAudio){return this._webAudioAnalyser.frequencyBinCount}else{return 0}};Analyser.prototype.getByteFrequencyData=function(){if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING;this._webAudioAnalyser.fftSize=this.FFT_SIZE;this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)}return this._byteFreqs};Analyser.prototype.getByteTimeDomainData=function(){if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING;this._webAudioAnalyser.fftSize=this.FFT_SIZE;this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)}return this._byteTime};Analyser.prototype.getFloatFrequencyData=function(){if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING;this._webAudioAnalyser.fftSize=this.FFT_SIZE;this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)}return this._floatFreqs};Analyser.prototype.drawDebugCanvas=function(){var _this=this;if(this._audioEngine.canUseWebAudio){if(!this._debugCanvas){this._debugCanvas=document.createElement("canvas");this._debugCanvas.width=this.DEBUGCANVASSIZE.width;this._debugCanvas.height=this.DEBUGCANVASSIZE.height;this._debugCanvas.style.position="absolute";this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px";this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px";this._debugCanvasContext=this._debugCanvas.getContext("2d");document.body.appendChild(this._debugCanvas);this._registerFunc=function(){_this.drawDebugCanvas()};this._scene.registerBeforeRender(this._registerFunc)}if(this._registerFunc){var workingArray=this.getByteFrequencyData();this._debugCanvasContext.fillStyle="rgb(0, 0, 0)";this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(var i=0;i<this.getFrequencyBinCount();i++){var value=workingArray[i];var percent=value/this.BARGRAPHAMPLITUDE;var height=this.DEBUGCANVASSIZE.height*percent;var offset=this.DEBUGCANVASSIZE.height-height-1;var barWidth=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount();var hue=i/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+hue+", 100%, 50%)";this._debugCanvasContext.fillRect(i*barWidth,offset,barWidth,height)}}}};Analyser.prototype.stopDebugCanvas=function(){if(this._debugCanvas){this._scene.unregisterBeforeRender(this._registerFunc);this._registerFunc=null;document.body.removeChild(this._debugCanvas);this._debugCanvas=null;this._debugCanvasContext=null}};Analyser.prototype.connectAudioNodes=function(inputAudioNode,outputAudioNode){if(this._audioEngine.canUseWebAudio){inputAudioNode.connect(this._webAudioAnalyser);this._webAudioAnalyser.connect(outputAudioNode)}};Analyser.prototype.dispose=function(){if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser.disconnect()}};return Analyser}();BABYLON.Analyser=Analyser})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var CubeTexture=function(_super){__extends(CubeTexture,_super);function CubeTexture(rootUrl,scene,extensions,noMipmap,files,onLoad,onError,format,prefiltered,forcedExtension){if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}if(format===void 0){format=BABYLON.Engine.TEXTUREFORMAT_RGBA}if(prefiltered===void 0){prefiltered=false}if(forcedExtension===void 0){forcedExtension=null}var _this=_super.call(this,scene)||this;_this.coordinatesMode=BABYLON.Texture.CUBIC_MODE;_this.name=rootUrl;_this.url=rootUrl;_this._noMipmap=noMipmap;_this.hasAlpha=false;_this._format=format;_this._prefiltered=prefiltered;_this.isCube=true;_this._textureMatrix=BABYLON.Matrix.Identity();if(prefiltered){_this.gammaSpace=false}if(!rootUrl&&!files){return _this}_this._texture=_this._getFromCache(rootUrl,noMipmap);if(!files){if(!extensions){extensions=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]}files=[];for(var index=0;index<extensions.length;index++){files.push(rootUrl+extensions[index])}_this._extensions=extensions}_this._files=files;if(!_this._texture){if(!scene.useDelayedTextureLoading){if(prefiltered){_this._texture=scene.getEngine().createPrefilteredCubeTexture(rootUrl,scene,_this.lodGenerationScale,_this.lodGenerationOffset,onLoad,onError,format,forcedExtension)}else{_this._texture=scene.getEngine().createCubeTexture(rootUrl,scene,files,noMipmap,onLoad,onError,_this._format,forcedExtension)}}else{_this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED}}else if(onLoad){if(_this._texture.isReady){BABYLON.Tools.SetImmediate(function(){return onLoad()})}else{_this._texture.onLoadedObservable.add(onLoad)}}return _this}CubeTexture.CreateFromImages=function(files,scene,noMipmap){return new CubeTexture("",scene,null,noMipmap,files)};CubeTexture.CreateFromPrefilteredData=function(url,scene,forcedExtension){if(forcedExtension===void 0){forcedExtension=null}return new CubeTexture(url,scene,null,false,null,null,null,undefined,true,forcedExtension)};CubeTexture.prototype.delayLoad=function(){if(this.delayLoadState!==BABYLON.Engine.DELAYLOADSTATE_NOTLOADED){return}this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED;this._texture=this._getFromCache(this.url,this._noMipmap);if(!this._texture){if(this._prefiltered){this._texture=this.getScene().getEngine().createPrefilteredCubeTexture(this.url,this.getScene(),this.lodGenerationScale,this.lodGenerationOffset,undefined,undefined,this._format)}else{this._texture=this.getScene().getEngine().createCubeTexture(this.url,this.getScene(),this._files,this._noMipmap,undefined,undefined,this._format)}}};CubeTexture.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix};CubeTexture.prototype.setReflectionTextureMatrix=function(value){this._textureMatrix=value};CubeTexture.Parse=function(parsedTexture,scene,rootUrl){var texture=BABYLON.SerializationHelper.Parse(function(){return new BABYLON.CubeTexture(rootUrl+parsedTexture.name,scene,parsedTexture.extensions)},parsedTexture,scene);if(parsedTexture.animations){for(var animationIndex=0;animationIndex<parsedTexture.animations.length;animationIndex++){var parsedAnimation=parsedTexture.animations[animationIndex];texture.animations.push(BABYLON.Animation.Parse(parsedAnimation))}}return texture};CubeTexture.prototype.clone=function(){var _this=this;return BABYLON.SerializationHelper.Clone(function(){return new CubeTexture(_this.url,_this.getScene(),_this._extensions,_this._noMipmap,_this._files)},this)};return CubeTexture}(BABYLON.BaseTexture);BABYLON.CubeTexture=CubeTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var RenderTargetTexture=function(_super){__extends(RenderTargetTexture,_super);function RenderTargetTexture(name,size,scene,generateMipMaps,doNotChangeAspectRatio,type,isCube,samplingMode,generateDepthBuffer,generateStencilBuffer,isMulti){if(doNotChangeAspectRatio===void 0){doNotChangeAspectRatio=true}if(type===void 0){type=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}if(isCube===void 0){isCube=false}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}if(generateDepthBuffer===void 0){generateDepthBuffer=true}if(generateStencilBuffer===void 0){generateStencilBuffer=false}if(isMulti===void 0){isMulti=false}var _this=_super.call(this,null,scene,!generateMipMaps)||this;_this.isCube=isCube;_this.renderList=new Array;_this.renderParticles=true;_this.renderSprites=false;_this.coordinatesMode=BABYLON.Texture.PROJECTION_MODE;_this.ignoreCameraViewport=false;_this.onBeforeBindObservable=new BABYLON.Observable;_this.onAfterUnbindObservable=new BABYLON.Observable;_this.onBeforeRenderObservable=new BABYLON.Observable;_this.onAfterRenderObservable=new BABYLON.Observable;_this.onClearObservable=new BABYLON.Observable;_this._currentRefreshId=-1;_this._refreshRate=1;_this._samples=1;scene=_this.getScene();_this.name=name;_this.isRenderTarget=true;_this._size=size;_this._generateMipMaps=generateMipMaps;_this._doNotChangeAspectRatio=doNotChangeAspectRatio;_this._renderingManager=new BABYLON.RenderingManager(scene);if(isMulti){return _this}_this._renderTargetOptions={generateMipMaps:generateMipMaps,type:type,samplingMode:samplingMode,generateDepthBuffer:generateDepthBuffer,generateStencilBuffer:generateStencilBuffer};if(samplingMode===BABYLON.Texture.NEAREST_SAMPLINGMODE){_this.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;_this.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE}if(isCube){_this._texture=scene.getEngine().createRenderTargetCubeTexture(size,_this._renderTargetOptions);_this.coordinatesMode=BABYLON.Texture.INVCUBIC_MODE;_this._textureMatrix=BABYLON.Matrix.Identity()}else{_this._texture=scene.getEngine().createRenderTargetTexture(size,_this._renderTargetOptions)}return _this}Object.defineProperty(RenderTargetTexture,"REFRESHRATE_RENDER_ONCE",{get:function(){return RenderTargetTexture._REFRESHRATE_RENDER_ONCE},enumerable:true,configurable:true});Object.defineProperty(RenderTargetTexture,"REFRESHRATE_RENDER_ONEVERYFRAME",{get:function(){return RenderTargetTexture._REFRESHRATE_RENDER_ONEVERYFRAME},enumerable:true,configurable:true});Object.defineProperty(RenderTargetTexture,"REFRESHRATE_RENDER_ONEVERYTWOFRAMES",{get:function(){return RenderTargetTexture._REFRESHRATE_RENDER_ONEVERYTWOFRAMES},enumerable:true,configurable:true});Object.defineProperty(RenderTargetTexture.prototype,"onAfterUnbind",{set:function(callback){if(this._onAfterUnbindObserver){this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver)}this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(RenderTargetTexture.prototype,"onBeforeRender",{set:function(callback){if(this._onBeforeRenderObserver){this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver)}this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(RenderTargetTexture.prototype,"onAfterRender",{set:function(callback){if(this._onAfterRenderObserver){this.onAfterRenderObservable.remove(this._onAfterRenderObserver)}this._onAfterRenderObserver=this.onAfterRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(RenderTargetTexture.prototype,"onClear",{set:function(callback){if(this._onClearObserver){this.onClearObservable.remove(this._onClearObserver)}this._onClearObserver=this.onClearObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(RenderTargetTexture.prototype,"renderTargetOptions",{get:function(){return this._renderTargetOptions},enumerable:true,configurable:true});Object.defineProperty(RenderTargetTexture.prototype,"samples",{get:function(){return this._samples},set:function(value){if(this._samples===value){return}this._samples=this.getScene().getEngine().updateRenderTargetTextureSampleCount(this._texture,value)},enumerable:true,configurable:true});RenderTargetTexture.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1};Object.defineProperty(RenderTargetTexture.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(value){this._refreshRate=value;this.resetRefreshCounter()},enumerable:true,configurable:true});RenderTargetTexture.prototype.addPostProcess=function(postProcess){if(!this._postProcessManager){this._postProcessManager=new BABYLON.PostProcessManager(this.getScene());this._postProcesses=new Array}this._postProcesses.push(postProcess);this._postProcesses[0].autoClear=false};RenderTargetTexture.prototype.clearPostProcesses=function(dispose){if(!this._postProcesses){return}if(dispose){for(var _i=0,_a=this._postProcesses;_i<_a.length;_i++){var postProcess=_a[_i];postProcess.dispose();postProcess=null}}this._postProcesses=[]};RenderTargetTexture.prototype.removePostProcess=function(postProcess){if(!this._postProcesses){return}var index=this._postProcesses.indexOf(postProcess);if(index===-1){return}this._postProcesses.splice(index,1);if(this._postProcesses.length>0){this._postProcesses[0].autoClear=false}};RenderTargetTexture.prototype._shouldRender=function(){if(this._currentRefreshId===-1){this._currentRefreshId=1;return true}if(this.refreshRate===this._currentRefreshId){this._currentRefreshId=1;return true}this._currentRefreshId++;return false};RenderTargetTexture.prototype.getRenderSize=function(){return this._size};Object.defineProperty(RenderTargetTexture.prototype,"canRescale",{get:function(){return true},enumerable:true,configurable:true});RenderTargetTexture.prototype.scale=function(ratio){var newSize=this._size*ratio;this.resize(newSize)};RenderTargetTexture.prototype.getReflectionTextureMatrix=function(){if(this.isCube){return this._textureMatrix}return _super.prototype.getReflectionTextureMatrix.call(this)};RenderTargetTexture.prototype.resize=function(size){this.releaseInternalTexture();if(this.isCube){this._texture=this.getScene().getEngine().createRenderTargetCubeTexture(size,this._renderTargetOptions)}else{this._texture=this.getScene().getEngine().createRenderTargetTexture(size,this._renderTargetOptions)}this._size=size};RenderTargetTexture.prototype.render=function(useCameraPostProcess,dumpForDebug){var scene=this.getScene();var engine=scene.getEngine();if(this.useCameraPostProcesses!==undefined){useCameraPostProcess=this.useCameraPostProcesses}if(this._waitingRenderList){this.renderList=[];for(var index=0;index<this._waitingRenderList.length;index++){var id=this._waitingRenderList[index];this.renderList.push(scene.getMeshByID(id))}delete this._waitingRenderList}if(this.renderListPredicate){this.renderList.splice(0);var sceneMeshes=this.getScene().meshes;for(var index=0;index<sceneMeshes.length;index++){var mesh=sceneMeshes[index];if(this.renderListPredicate(mesh)){this.renderList.push(mesh)}}}this.onBeforeBindObservable.notifyObservers(this);var camera;if(this.activeCamera){camera=this.activeCamera;engine.setViewport(this.activeCamera.viewport,this._size,this._size);if(this.activeCamera!==scene.activeCamera){scene.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(true))}}else{camera=scene.activeCamera;engine.setViewport(scene.activeCamera.viewport,this._size,this._size)}this._renderingManager.reset();var currentRenderList=this.renderList?this.renderList:scene.getActiveMeshes().data;var currentRenderListLength=this.renderList?this.renderList.length:scene.getActiveMeshes().length;var sceneRenderId=scene.getRenderId();for(var meshIndex=0;meshIndex<currentRenderListLength;meshIndex++){var mesh=currentRenderList[meshIndex];if(mesh){if(!mesh.isReady()){this.resetRefreshCounter();continue}mesh._preActivateForIntermediateRendering(sceneRenderId);var isMasked=void 0;if(!this.renderList){isMasked=(mesh.layerMask&camera.layerMask)===0}else{isMasked=false}if(mesh.isEnabled()&&mesh.isVisible&&mesh.subMeshes&&!isMasked){mesh._activate(sceneRenderId);for(var subIndex=0;subIndex<mesh.subMeshes.length;subIndex++){var subMesh=mesh.subMeshes[subIndex];scene._activeIndices.addCount(subMesh.indexCount,false);this._renderingManager.dispatch(subMesh)}}}}for(var particleIndex=0;particleIndex<scene.particleSystems.length;particleIndex++){var particleSystem=scene.particleSystems[particleIndex];var emitter=particleSystem.emitter;if(!particleSystem.isStarted()||!emitter||!emitter.position||!emitter.isEnabled()){continue}if(currentRenderList.indexOf(emitter)>=0){this._renderingManager.dispatchParticles(particleSystem)}}if(this.isCube){for(var face=0;face<6;face++){this.renderToTarget(face,currentRenderList,currentRenderListLength,useCameraPostProcess,dumpForDebug);scene.incrementRenderId();scene.resetCachedMaterial()}}else{this.renderToTarget(0,currentRenderList,currentRenderListLength,useCameraPostProcess,dumpForDebug)}this.onAfterUnbindObservable.notifyObservers(this);if(this.activeCamera&&this.activeCamera!==scene.activeCamera){scene.setTransformMatrix(scene.activeCamera.getViewMatrix(),scene.activeCamera.getProjectionMatrix(true))}engine.setViewport(scene.activeCamera.viewport);scene.resetCachedMaterial()};RenderTargetTexture.prototype.renderToTarget=function(faceIndex,currentRenderList,currentRenderListLength,useCameraPostProcess,dumpForDebug){var _this=this;var scene=this.getScene();var engine=scene.getEngine();if(this._postProcessManager){this._postProcessManager._prepareFrame(this._texture,this._postProcesses)}else if(!useCameraPostProcess||!scene.postProcessManager._prepareFrame(this._texture)){engine.bindFramebuffer(this._texture,this.isCube?faceIndex:undefined,undefined,undefined,this.ignoreCameraViewport)}this.onBeforeRenderObservable.notifyObservers(faceIndex);if(this.onClearObservable.hasObservers()){this.onClearObservable.notifyObservers(engine)}else{engine.clear(this.clearColor||scene.clearColor,true,true,true)}if(!this._doNotChangeAspectRatio){scene.updateTransformMatrix(true)}this._renderingManager.render(this.customRenderFunction,currentRenderList,this.renderParticles,this.renderSprites);if(this._postProcessManager){this._postProcessManager._finalizeFrame(false,this._texture,faceIndex,this._postProcesses,this.ignoreCameraViewport)}else if(useCameraPostProcess){scene.postProcessManager._finalizeFrame(false,this._texture,faceIndex)}if(!this._doNotChangeAspectRatio){scene.updateTransformMatrix(true)}if(dumpForDebug){BABYLON.Tools.DumpFramebuffer(this._size,this._size,engine)}if(!this.isCube||faceIndex===5){if(this.isCube){if(faceIndex===5){engine.generateMipMapsForCubemap(this._texture)}}engine.unBindFramebuffer(this._texture,this.isCube,function(){_this.onAfterRenderObservable.notifyObservers(faceIndex)})}else{this.onAfterRenderObservable.notifyObservers(faceIndex)}};RenderTargetTexture.prototype.setRenderingOrder=function(renderingGroupId,opaqueSortCompareFn,alphaTestSortCompareFn,transparentSortCompareFn){if(opaqueSortCompareFn===void 0){opaqueSortCompareFn=null}if(alphaTestSortCompareFn===void 0){alphaTestSortCompareFn=null}if(transparentSortCompareFn===void 0){transparentSortCompareFn=null}this._renderingManager.setRenderingOrder(renderingGroupId,opaqueSortCompareFn,alphaTestSortCompareFn,transparentSortCompareFn)};RenderTargetTexture.prototype.setRenderingAutoClearDepthStencil=function(renderingGroupId,autoClearDepthStencil){this._renderingManager.setRenderingAutoClearDepthStencil(renderingGroupId,autoClearDepthStencil)};RenderTargetTexture.prototype.clone=function(){var textureSize=this.getSize();var newTexture=new RenderTargetTexture(this.name,textureSize.width,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer);newTexture.hasAlpha=this.hasAlpha;newTexture.level=this.level;newTexture.coordinatesMode=this.coordinatesMode;newTexture.renderList=this.renderList.slice(0);return newTexture};RenderTargetTexture.prototype.serialize=function(){if(!this.name){return null}var serializationObject=_super.prototype.serialize.call(this);serializationObject.renderTargetSize=this.getRenderSize();serializationObject.renderList=[];for(var index=0;index<this.renderList.length;index++){serializationObject.renderList.push(this.renderList[index].id)}return serializationObject};RenderTargetTexture.prototype.disposeFramebufferObjects=function(){this.getScene().getEngine()._releaseFramebufferObjects(this.getInternalTexture())};RenderTargetTexture.prototype.dispose=function(){if(this._postProcessManager){this._postProcessManager.dispose();this._postProcessManager=null}this.clearPostProcesses(true);this.renderList=null;var scene=this.getScene();var index=scene.customRenderTargets.indexOf(this);if(index>=0){scene.customRenderTargets.splice(index,1)}for(var _i=0,_a=scene.cameras;_i<_a.length;_i++){var camera=_a[_i];index=camera.customRenderTargets.indexOf(this);if(index>=0){camera.customRenderTargets.splice(index,1)}}_super.prototype.dispose.call(this)};RenderTargetTexture.prototype._rebuild=function(){if(this.refreshRate===RenderTargetTexture.REFRESHRATE_RENDER_ONCE){this.refreshRate=RenderTargetTexture.REFRESHRATE_RENDER_ONCE}if(this._postProcessManager){this._postProcessManager._rebuild()}};RenderTargetTexture._REFRESHRATE_RENDER_ONCE=0;RenderTargetTexture._REFRESHRATE_RENDER_ONEVERYFRAME=1;RenderTargetTexture._REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;return RenderTargetTexture}(BABYLON.Texture);BABYLON.RenderTargetTexture=RenderTargetTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MultiRenderTarget=function(_super){__extends(MultiRenderTarget,_super);function MultiRenderTarget(name,size,count,scene,options){var _this=this;options=options||{};var generateMipMaps=options.generateMipMaps?options.generateMipMaps:false;var generateDepthTexture=options.generateDepthTexture?options.generateDepthTexture:false;var doNotChangeAspectRatio=options.doNotChangeAspectRatio===undefined?true:options.doNotChangeAspectRatio;_this=_super.call(this,name,size,scene,generateMipMaps,doNotChangeAspectRatio)||this;if(!_this.isSupported){_this.dispose();return}var types=[];var samplingModes=[];for(var i=0;i<count;i++){if(options.types&&options.types[i]){types.push(options.types[i])}else{types.push(BABYLON.Engine.TEXTURETYPE_FLOAT)}if(options.samplingModes&&options.samplingModes[i]){samplingModes.push(options.samplingModes[i])}else{samplingModes.push(BABYLON.Texture.BILINEAR_SAMPLINGMODE)}}var generateDepthBuffer=options.generateDepthBuffer===undefined?true:options.generateDepthBuffer;var generateStencilBuffer=options.generateStencilBuffer===undefined?false:options.generateStencilBuffer;_this._count=count;_this._size=size;_this._multiRenderTargetOptions={samplingModes:samplingModes,generateMipMaps:generateMipMaps,generateDepthBuffer:generateDepthBuffer,generateStencilBuffer:generateStencilBuffer,generateDepthTexture:generateDepthTexture,types:types,textureCount:count};_this._createInternalTextures();_this._createTextures();return _this}Object.defineProperty(MultiRenderTarget.prototype,"isSupported",{get:function(){var engine=this.getScene().getEngine();return engine.webGLVersion>1||engine.getCaps().drawBuffersExtension},enumerable:true,configurable:true});Object.defineProperty(MultiRenderTarget.prototype,"textures",{get:function(){return this._textures},enumerable:true,configurable:true});Object.defineProperty(MultiRenderTarget.prototype,"depthTexture",{get:function(){return this._textures[this._textures.length-1]},enumerable:true,configurable:true});Object.defineProperty(MultiRenderTarget.prototype,"wrapU",{set:function(wrap){if(this._textures){for(var i=0;i<this._textures.length;i++){this._textures[i].wrapU=wrap}}},enumerable:true,configurable:true});Object.defineProperty(MultiRenderTarget.prototype,"wrapV",{set:function(wrap){if(this._textures){for(var i=0;i<this._textures.length;i++){this._textures[i].wrapV=wrap}}},enumerable:true,configurable:true});MultiRenderTarget.prototype._rebuild=function(){this.releaseInternalTextures();this._createInternalTextures();for(var i=0;i<this._internalTextures.length;i++){var texture=this._textures[i];texture._texture=this._internalTextures[i]}this._texture=this._internalTextures[0]};MultiRenderTarget.prototype._createInternalTextures=function(){this._internalTextures=this.getScene().getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions)};MultiRenderTarget.prototype._createTextures=function(){this._textures=[];for(var i=0;i<this._internalTextures.length;i++){var texture=new BABYLON.Texture(null,this.getScene());texture._texture=this._internalTextures[i];this._textures.push(texture)}this._texture=this._internalTextures[0]};Object.defineProperty(MultiRenderTarget.prototype,"samples",{get:function(){return this._samples},set:function(value){if(this._samples===value){return}for(var i=0;i<this._internalTextures.length;i++){this._samples=this.getScene().getEngine().updateRenderTargetTextureSampleCount(this._internalTextures[i],value)}},enumerable:true,configurable:true});MultiRenderTarget.prototype.resize=function(size){this.releaseInternalTextures();this._internalTextures=this.getScene().getEngine().createMultipleRenderTarget(size,this._multiRenderTargetOptions);this._createInternalTextures()};MultiRenderTarget.prototype.dispose=function(){this.releaseInternalTextures();_super.prototype.dispose.call(this)};MultiRenderTarget.prototype.releaseInternalTextures=function(){if(!this._internalTextures){return}for(var i=this._internalTextures.length-1;i>=0;i--){if(this._internalTextures[i]!==undefined){this._internalTextures[i].dispose();this._internalTextures.splice(i,1)}}};return MultiRenderTarget}(BABYLON.RenderTargetTexture);BABYLON.MultiRenderTarget=MultiRenderTarget})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MirrorTexture=function(_super){__extends(MirrorTexture,_super);function MirrorTexture(name,size,scene,generateMipMaps,type,samplingMode,generateDepthBuffer){if(type===void 0){type=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}if(samplingMode===void 0){samplingMode=BABYLON.Texture.BILINEAR_SAMPLINGMODE}if(generateDepthBuffer===void 0){generateDepthBuffer=true}var _this=_super.call(this,name,size,scene,generateMipMaps,true,type,false,samplingMode,generateDepthBuffer)||this;_this.mirrorPlane=new BABYLON.Plane(0,1,0,1);_this._transformMatrix=BABYLON.Matrix.Zero();_this._mirrorMatrix=BABYLON.Matrix.Zero();_this._blurKernelX=0;_this._blurKernelY=0;_this._blurRatio=1;_this.ignoreCameraViewport=true;_this.onBeforeRenderObservable.add(function(){BABYLON.Matrix.ReflectionToRef(_this.mirrorPlane,_this._mirrorMatrix);_this._savedViewMatrix=scene.getViewMatrix();_this._mirrorMatrix.multiplyToRef(_this._savedViewMatrix,_this._transformMatrix);scene.setTransformMatrix(_this._transformMatrix,scene.getProjectionMatrix());scene.clipPlane=_this.mirrorPlane;scene.getEngine().cullBackFaces=false;scene._mirroredCameraPosition=BABYLON.Vector3.TransformCoordinates(scene.activeCamera.globalPosition,_this._mirrorMatrix)});_this.onAfterRenderObservable.add(function(){scene.setTransformMatrix(_this._savedViewMatrix,scene.getProjectionMatrix());scene.getEngine().cullBackFaces=true;scene._mirroredCameraPosition=null;delete scene.clipPlane});return _this}Object.defineProperty(MirrorTexture.prototype,"blurRatio",{get:function(){return this._blurRatio},set:function(value){if(this._blurRatio===value){return}this._blurRatio=value;this._preparePostProcesses()},enumerable:true,configurable:true});Object.defineProperty(MirrorTexture.prototype,"blurKernel",{set:function(value){this.blurKernelX=value;this.blurKernelY=value},enumerable:true,configurable:true});Object.defineProperty(MirrorTexture.prototype,"blurKernelX",{get:function(){return this._blurKernelX},set:function(value){if(this._blurKernelX===value){return}this._blurKernelX=value;this._preparePostProcesses()},enumerable:true,configurable:true});Object.defineProperty(MirrorTexture.prototype,"blurKernelY",{get:function(){return this._blurKernelY},set:function(value){if(this._blurKernelY===value){return}this._blurKernelY=value;this._preparePostProcesses()},enumerable:true,configurable:true});MirrorTexture.prototype._preparePostProcesses=function(){this.clearPostProcesses(true);if(this._blurKernelX&&this._blurKernelY){var engine=this.getScene().getEngine();var textureType=engine.getCaps().textureFloatRender?BABYLON.Engine.TEXTURETYPE_FLOAT:BABYLON.Engine.TEXTURETYPE_HALF_FLOAT;this._blurX=new BABYLON.BlurPostProcess("horizontal blur",new BABYLON.Vector2(1,0),this._blurKernelX,this._blurRatio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,textureType);this._blurX.autoClear=false;if(this._blurRatio===1&&this.samples<2){this._blurX.outputTexture=this._texture}else{this._blurX.alwaysForcePOT=true}this._blurY=new BABYLON.BlurPostProcess("vertical blur",new BABYLON.Vector2(0,1),this._blurKernelY,this._blurRatio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,textureType);this._blurY.autoClear=false;this._blurY.alwaysForcePOT=this._blurRatio!==1;this.addPostProcess(this._blurX);this.addPostProcess(this._blurY)}};MirrorTexture.prototype.clone=function(){var textureSize=this.getSize();var newTexture=new MirrorTexture(this.name,textureSize.width,this.getScene(),this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);newTexture.hasAlpha=this.hasAlpha;newTexture.level=this.level;newTexture.mirrorPlane=this.mirrorPlane.clone();newTexture.renderList=this.renderList.slice(0);return newTexture};MirrorTexture.prototype.serialize=function(){if(!this.name){return null}var serializationObject=_super.prototype.serialize.call(this);serializationObject.mirrorPlane=this.mirrorPlane.asArray();return serializationObject};return MirrorTexture}(BABYLON.RenderTargetTexture);BABYLON.MirrorTexture=MirrorTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var RefractionTexture=function(_super){__extends(RefractionTexture,_super);function RefractionTexture(name,size,scene,generateMipMaps){var _this=_super.call(this,name,size,scene,generateMipMaps,true)||this;_this.refractionPlane=new BABYLON.Plane(0,1,0,1);_this.depth=2;_this.onBeforeRenderObservable.add(function(){scene.clipPlane=_this.refractionPlane});_this.onAfterRenderObservable.add(function(){delete scene.clipPlane});return _this}RefractionTexture.prototype.clone=function(){var textureSize=this.getSize();var newTexture=new RefractionTexture(this.name,textureSize.width,this.getScene(),this._generateMipMaps);newTexture.hasAlpha=this.hasAlpha;newTexture.level=this.level;newTexture.refractionPlane=this.refractionPlane.clone();newTexture.renderList=this.renderList.slice(0);newTexture.depth=this.depth;return newTexture};RefractionTexture.prototype.serialize=function(){if(!this.name){return null}var serializationObject=_super.prototype.serialize.call(this);serializationObject.mirrorPlane=this.refractionPlane.asArray();serializationObject.depth=this.depth;return serializationObject};return RefractionTexture}(BABYLON.RenderTargetTexture);BABYLON.RefractionTexture=RefractionTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DynamicTexture=function(_super){__extends(DynamicTexture,_super);function DynamicTexture(name,options,scene,generateMipMaps,samplingMode,format){if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}if(format===void 0){format=BABYLON.Engine.TEXTUREFORMAT_RGBA}var _this=_super.call(this,null,scene,!generateMipMaps,undefined,samplingMode,undefined,undefined,undefined,undefined,format)||this;_this.name=name;var engine=_this.getScene().getEngine();_this.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;_this.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;_this._generateMipMaps=generateMipMaps;if(options.getContext){_this._canvas=options;_this._texture=engine.createDynamicTexture(options.width,options.height,generateMipMaps,samplingMode)}else{_this._canvas=document.createElement("canvas");if(options.width){_this._texture=engine.createDynamicTexture(options.width,options.height,generateMipMaps,samplingMode)}else{_this._texture=engine.createDynamicTexture(options,options,generateMipMaps,samplingMode)}}var textureSize=_this.getSize();_this._canvas.width=textureSize.width;_this._canvas.height=textureSize.height;_this._context=_this._canvas.getContext("2d");return _this}Object.defineProperty(DynamicTexture.prototype,"canRescale",{get:function(){return true},enumerable:true,configurable:true});DynamicTexture.prototype._recreate=function(textureSize){this._canvas.width=textureSize.width;this._canvas.height=textureSize.height;this.releaseInternalTexture();this._texture=this.getScene().getEngine().createDynamicTexture(textureSize.width,textureSize.height,this._generateMipMaps,this._samplingMode)};DynamicTexture.prototype.scale=function(ratio){var textureSize=this.getSize();textureSize.width*=ratio;textureSize.height*=ratio;this._recreate(textureSize)};DynamicTexture.prototype.scaleTo=function(width,height){var textureSize=this.getSize();textureSize.width=width;textureSize.height=height;this._recreate(textureSize)};DynamicTexture.prototype.getContext=function(){return this._context};DynamicTexture.prototype.clear=function(){var size=this.getSize();this._context.fillRect(0,0,size.width,size.height)};DynamicTexture.prototype.update=function(invertY){this.getScene().getEngine().updateDynamicTexture(this._texture,this._canvas,invertY===undefined?true:invertY,undefined,this._format)};DynamicTexture.prototype.drawText=function(text,x,y,font,color,clearColor,invertY,update){if(update===void 0){update=true}var size=this.getSize();if(clearColor){this._context.fillStyle=clearColor;this._context.fillRect(0,0,size.width,size.height)}this._context.font=font;if(x===null||x===undefined){var textSize=this._context.measureText(text);x=(size.width-textSize.width)/2}if(y===null||y===undefined){var fontSize=parseInt(font.replace(/\D/g,""));y=size.height/2+fontSize/3.65}this._context.fillStyle=color;this._context.fillText(text,x,y);if(update){this.update(invertY)}};DynamicTexture.prototype.clone=function(){var textureSize=this.getSize();var newTexture=new DynamicTexture(this.name,textureSize,this.getScene(),this._generateMipMaps);newTexture.hasAlpha=this.hasAlpha;newTexture.level=this.level;newTexture.wrapU=this.wrapU;newTexture.wrapV=this.wrapV;return newTexture};DynamicTexture.prototype._rebuild=function(){this.update()};return DynamicTexture}(BABYLON.Texture);BABYLON.DynamicTexture=DynamicTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VideoTexture=function(_super){__extends(VideoTexture,_super);function VideoTexture(name,urlsOrVideo,scene,generateMipMaps,invertY,samplingMode){if(generateMipMaps===void 0){generateMipMaps=false}if(invertY===void 0){invertY=false}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}var _this=_super.call(this,null,scene,!generateMipMaps,invertY)||this;_this._autoLaunch=true;var urls;_this.name=name;if(urlsOrVideo instanceof HTMLVideoElement){_this.video=urlsOrVideo}else{urls=urlsOrVideo;_this.video=document.createElement("video");_this.video.autoplay=false;_this.video.loop=true}_this._generateMipMaps=generateMipMaps;_this._samplingMode=samplingMode;if(!_this.getScene().getEngine().needPOTTextures||BABYLON.Tools.IsExponentOfTwo(_this.video.videoWidth)&&BABYLON.Tools.IsExponentOfTwo(_this.video.videoHeight)){_this.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE;_this.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE}else{_this.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;_this.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;_this._generateMipMaps=false}if(urls){_this.video.addEventListener("canplay",function(){_this._createTexture()});urls.forEach(function(url){var source=document.createElement("source");source.src=url;_this.video.appendChild(source)})}else{_this._createTexture()}_this._lastUpdate=BABYLON.Tools.Now;return _this}VideoTexture.prototype.__setTextureReady=function(){this._texture.isReady=true};VideoTexture.prototype._createTexture=function(){this._texture=this.getScene().getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this._samplingMode);if(this._autoLaunch){this._autoLaunch=false;this.video.play()}this._setTextureReady=this.__setTextureReady.bind(this);this.video.addEventListener("playing",this._setTextureReady)};VideoTexture.prototype._rebuild=function(){this.update()};VideoTexture.prototype.update=function(){var now=BABYLON.Tools.Now;if(now-this._lastUpdate<15||this.video.readyState!==this.video.HAVE_ENOUGH_DATA){return false}this._lastUpdate=now;this.getScene().getEngine().updateVideoTexture(this._texture,this.video,this._invertY);return true};VideoTexture.prototype.dispose=function(){_super.prototype.dispose.call(this);this.video.removeEventListener("playing",this._setTextureReady)};VideoTexture.CreateFromWebCam=function(scene,onReady,constraints){var video=document.createElement("video");var constraintsDeviceId;if(constraints&&constraints.deviceId){constraintsDeviceId={exact:constraints.deviceId}}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;if(navigator.getUserMedia){navigator.getUserMedia({video:{deviceId:constraintsDeviceId,width:{min:constraints&&constraints.minWidth||256,max:constraints&&constraints.maxWidth||640},height:{min:constraints&&constraints.minHeight||256,max:constraints&&constraints.maxHeight||480}}},function(stream){if(video.mozSrcObject!==undefined){video.mozSrcObject=stream}else{video.src=window.URL&&window.URL.createObjectURL(stream)||stream}video.play();if(onReady){onReady(new BABYLON.VideoTexture("video",video,scene,true,true))}},function(e){BABYLON.Tools.Error(e.name)})}};return VideoTexture}(BABYLON.Texture);BABYLON.VideoTexture=VideoTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var RawTexture=function(_super){__extends(RawTexture,_super);function RawTexture(data,width,height,format,scene,generateMipMaps,invertY,samplingMode){if(generateMipMaps===void 0){generateMipMaps=true}if(invertY===void 0){invertY=false}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}var _this=_super.call(this,null,scene,!generateMipMaps,invertY)||this;_this.format=format;_this._texture=scene.getEngine().createRawTexture(data,width,height,format,generateMipMaps,invertY,samplingMode);_this.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;_this.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;return _this}RawTexture.prototype.update=function(data){this.getScene().getEngine().updateRawTexture(this._texture,data,this.format,this._invertY)};RawTexture.CreateLuminanceTexture=function(data,width,height,scene,generateMipMaps,invertY,samplingMode){if(generateMipMaps===void 0){generateMipMaps=true}if(invertY===void 0){invertY=false}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}return new RawTexture(data,width,height,BABYLON.Engine.TEXTUREFORMAT_LUMINANCE,scene,generateMipMaps,invertY,samplingMode)};RawTexture.CreateLuminanceAlphaTexture=function(data,width,height,scene,generateMipMaps,invertY,samplingMode){if(generateMipMaps===void 0){generateMipMaps=true}if(invertY===void 0){invertY=false}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}return new RawTexture(data,width,height,BABYLON.Engine.TEXTUREFORMAT_LUMINANCE_ALPHA,scene,generateMipMaps,invertY,samplingMode)};RawTexture.CreateAlphaTexture=function(data,width,height,scene,generateMipMaps,invertY,samplingMode){if(generateMipMaps===void 0){generateMipMaps=true}if(invertY===void 0){invertY=false}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}return new RawTexture(data,width,height,BABYLON.Engine.TEXTUREFORMAT_ALPHA,scene,generateMipMaps,invertY,samplingMode)};RawTexture.CreateRGBTexture=function(data,width,height,scene,generateMipMaps,invertY,samplingMode){if(generateMipMaps===void 0){generateMipMaps=true}if(invertY===void 0){invertY=false}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}return new RawTexture(data,width,height,BABYLON.Engine.TEXTUREFORMAT_RGB,scene,generateMipMaps,invertY,samplingMode)};RawTexture.CreateRGBATexture=function(data,width,height,scene,generateMipMaps,invertY,samplingMode){if(generateMipMaps===void 0){generateMipMaps=true}if(invertY===void 0){invertY=false}if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}return new RawTexture(data,width,height,BABYLON.Engine.TEXTUREFORMAT_RGBA,scene,generateMipMaps,invertY,samplingMode)};return RawTexture}(BABYLON.Texture);BABYLON.RawTexture=RawTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PostProcess=function(){function PostProcess(name,fragmentUrl,parameters,samplers,options,camera,samplingMode,engine,reusable,defines,textureType,vertexUrl,indexParameters,blockCompilation){if(samplingMode===void 0){samplingMode=BABYLON.Texture.NEAREST_SAMPLINGMODE}if(textureType===void 0){textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}if(vertexUrl===void 0){vertexUrl="postprocess"}if(blockCompilation===void 0){blockCompilation=false}this.name=name;this.width=-1;this.height=-1;this.autoClear=true;this.alphaMode=BABYLON.Engine.ALPHA_DISABLE;this.enablePixelPerfectMode=false;this.scaleMode=BABYLON.Engine.SCALEMODE_FLOOR;this.alwaysForcePOT=false;this.samples=1;this.adaptScaleToCurrentViewport=false;this._reusable=false;this._textures=new BABYLON.SmartArray(2);this._currentRenderTextureInd=0;this._scaleRatio=new BABYLON.Vector2(1,1);this._texelSize=BABYLON.Vector2.Zero();this.onActivateObservable=new BABYLON.Observable;this.onSizeChangedObservable=new BABYLON.Observable;this.onApplyObservable=new BABYLON.Observable;this.onBeforeRenderObservable=new BABYLON.Observable;this.onAfterRenderObservable=new BABYLON.Observable;if(camera!=null){this._camera=camera;this._scene=camera.getScene();camera.attachPostProcess(this);this._engine=this._scene.getEngine();this._scene.postProcesses.push(this)}else{this._engine=engine;this._engine.postProcesses.push(this)}this._options=options;this.renderTargetSamplingMode=samplingMode?samplingMode:BABYLON.Texture.NEAREST_SAMPLINGMODE;this._reusable=reusable||false;this._textureType=textureType;this._samplers=samplers||[];this._samplers.push("textureSampler");this._fragmentUrl=fragmentUrl;this._vertexUrl=vertexUrl;this._parameters=parameters||[];this._parameters.push("scale");this._indexParameters=indexParameters;if(!blockCompilation){this.updateEffect(defines)}}Object.defineProperty(PostProcess.prototype,"onActivate",{set:function(callback){if(this._onActivateObserver){this.onActivateObservable.remove(this._onActivateObserver)}this._onActivateObserver=this.onActivateObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(PostProcess.prototype,"onSizeChanged",{set:function(callback){if(this._onSizeChangedObserver){this.onSizeChangedObservable.remove(this._onSizeChangedObserver)}this._onSizeChangedObserver=this.onSizeChangedObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(PostProcess.prototype,"onApply",{set:function(callback){if(this._onApplyObserver){this.onApplyObservable.remove(this._onApplyObserver)}this._onApplyObserver=this.onApplyObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(PostProcess.prototype,"onBeforeRender",{set:function(callback){if(this._onBeforeRenderObserver){this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver)}this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(PostProcess.prototype,"onAfterRender",{set:function(callback){if(this._onAfterRenderObserver){this.onAfterRenderObservable.remove(this._onAfterRenderObserver)}this._onAfterRenderObserver=this.onAfterRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(PostProcess.prototype,"outputTexture",{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(value){this._forcedOutputTexture=value},enumerable:true,configurable:true});PostProcess.prototype.getCamera=function(){return this._camera};Object.defineProperty(PostProcess.prototype,"texelSize",{get:function(){if(this._shareOutputWithPostProcess){return this._shareOutputWithPostProcess.texelSize}if(this._forcedOutputTexture){this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height)}return this._texelSize},enumerable:true,configurable:true});PostProcess.prototype.getEngine=function(){return this._engine};PostProcess.prototype.getEffect=function(){return this._effect};PostProcess.prototype.shareOutputWith=function(postProcess){this._disposeTextures();this._shareOutputWithPostProcess=postProcess;return this};PostProcess.prototype.updateEffect=function(defines,uniforms,samplers,indexParameters,onCompiled,onError){this._effect=this._engine.createEffect({vertex:this._vertexUrl,fragment:this._fragmentUrl},["position"],uniforms||this._parameters,samplers||this._samplers,defines!==undefined?defines:"",null,onCompiled,onError,indexParameters||this._indexParameters)};PostProcess.prototype.isReusable=function(){return this._reusable};PostProcess.prototype.markTextureDirty=function(){this.width=-1};PostProcess.prototype.activate=function(camera,sourceTexture,forceDepthStencil){var _this=this;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){camera=camera||this._camera;var scene=camera.getScene();var engine=scene.getEngine();var maxSize=engine.getCaps().maxTextureSize;var requiredWidth=(sourceTexture?sourceTexture.width:this._engine.getRenderWidth(true))*this._options|0;var requiredHeight=(sourceTexture?sourceTexture.height:this._engine.getRenderHeight(true))*this._options|0;var desiredWidth=this._options.width||requiredWidth;var desiredHeight=this._options.height||requiredHeight;if(this.adaptScaleToCurrentViewport){var currentViewport=engine.currentViewport;if(currentViewport){desiredWidth*=currentViewport.width;desiredHeight*=currentViewport.height}}if(this.renderTargetSamplingMode===BABYLON.Texture.TRILINEAR_SAMPLINGMODE||this.alwaysForcePOT){if(!this._options.width){desiredWidth=engine.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(desiredWidth,maxSize,this.scaleMode):desiredWidth}if(!this._options.height){desiredHeight=engine.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(desiredHeight,maxSize,this.scaleMode):desiredHeight}}if(this.width!==desiredWidth||this.height!==desiredHeight){if(this._textures.length>0){for(var i=0;i<this._textures.length;i++){this._engine._releaseTexture(this._textures.data[i])}this._textures.reset()}this.width=desiredWidth;this.height=desiredHeight;var textureSize={width:this.width,height:this.height};var textureOptions={generateMipMaps:false,generateDepthBuffer:forceDepthStencil||camera._postProcesses.indexOf(this)===0,generateStencilBuffer:(forceDepthStencil||camera._postProcesses.indexOf(this)===0)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType};this._textures.push(this._engine.createRenderTargetTexture(textureSize,textureOptions));if(this._reusable){this._textures.push(this._engine.createRenderTargetTexture(textureSize,textureOptions))}this._texelSize.copyFromFloats(1/this.width,1/this.height);this.onSizeChangedObservable.notifyObservers(this)}this._textures.forEach(function(texture){if(texture.samples!==_this.samples){_this._engine.updateRenderTargetTextureSampleCount(texture,_this.samples)}})}var target;if(this._shareOutputWithPostProcess){target=this._shareOutputWithPostProcess.outputTexture}else if(this._forcedOutputTexture){target=this._forcedOutputTexture;this.width=this._forcedOutputTexture.width;this.height=this._forcedOutputTexture.height}else{target=this.outputTexture}if(this.enablePixelPerfectMode){this._scaleRatio.copyFromFloats(requiredWidth/desiredWidth,requiredHeight/desiredHeight);this._engine.bindFramebuffer(target,0,requiredWidth,requiredHeight,true)}else{this._scaleRatio.copyFromFloats(1,1);this._engine.bindFramebuffer(target,0,undefined,undefined,true)}this.onActivateObservable.notifyObservers(camera);if(this.autoClear&&this.alphaMode===BABYLON.Engine.ALPHA_DISABLE){this._engine.clear(this.clearColor?this.clearColor:scene.clearColor,true,true,true)}if(this._reusable){this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2}};Object.defineProperty(PostProcess.prototype,"isSupported",{get:function(){return this._effect.isSupported},enumerable:true,configurable:true});Object.defineProperty(PostProcess.prototype,"aspectRatio",{get:function(){if(this._shareOutputWithPostProcess){return this._shareOutputWithPostProcess.aspectRatio}if(this._forcedOutputTexture){return this._forcedOutputTexture.width/this._forcedOutputTexture.height}return this.width/this.height},enumerable:true,configurable:true});PostProcess.prototype.apply=function(){if(!this._effect||!this._effect.isReady())return null;this._engine.enableEffect(this._effect);this._engine.setState(false);this._engine.setDepthBuffer(false);this._engine.setDepthWrite(false);this._engine.setAlphaMode(this.alphaMode);if(this.alphaConstants){this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a)}var source;if(this._shareOutputWithPostProcess){source=this._shareOutputWithPostProcess.outputTexture}else if(this._forcedOutputTexture){source=this._forcedOutputTexture}else{source=this.outputTexture}this._effect._bindTexture("textureSampler",source);this._effect.setVector2("scale",this._scaleRatio);this.onApplyObservable.notifyObservers(this._effect);return this._effect};PostProcess.prototype._disposeTextures=function(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){return}if(this._textures.length>0){for(var i=0;i<this._textures.length;i++){this._engine._releaseTexture(this._textures.data[i])}}this._textures.dispose()};PostProcess.prototype.dispose=function(camera){camera=camera||this._camera;this._disposeTextures();if(this._scene){var index_1=this._scene.postProcesses.indexOf(this);if(index_1!==-1){this._scene.postProcesses.splice(index_1,1)}}else{var index_2=this._engine.postProcesses.indexOf(this);if(index_2!==-1){this._engine.postProcesses.splice(index_2,1)}}if(!camera){return}camera.detachPostProcess(this);var index=camera._postProcesses.indexOf(this);if(index===0&&camera._postProcesses.length>0){this._camera._postProcesses[0].markTextureDirty()}this.onActivateObservable.clear();this.onAfterRenderObservable.clear();this.onApplyObservable.clear();this.onBeforeRenderObservable.clear();this.onSizeChangedObservable.clear()};return PostProcess}();BABYLON.PostProcess=PostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PassPostProcess=function(_super){__extends(PassPostProcess,_super);function PassPostProcess(name,options,camera,samplingMode,engine,reusable,textureType){if(textureType===void 0){textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}return _super.call(this,name,"pass",null,null,options,camera,samplingMode,engine,reusable,null,textureType)||this}return PassPostProcess}(BABYLON.PostProcess);BABYLON.PassPostProcess=PassPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ShadowGenerator=function(){function ShadowGenerator(mapSize,light,useFullFloatFirst){this._bias=5e-5;this._blurBoxOffset=1;this._blurScale=2;this._blurKernel=1;this._useKernelBlur=false;this._filter=ShadowGenerator.FILTER_NONE;this._darkness=0;this._transparencyShadow=false;this.frustumEdgeFalloff=0;this.forceBackFacesOnly=false;this._lightDirection=BABYLON.Vector3.Zero();this._viewMatrix=BABYLON.Matrix.Zero();this._projectionMatrix=BABYLON.Matrix.Zero();this._transformMatrix=BABYLON.Matrix.Zero();this._currentFaceIndex=0;this._currentFaceIndexCache=0;this._defaultTextureMatrix=BABYLON.Matrix.Identity();this._mapSize=mapSize;this._light=light;this._scene=light.getScene();light._shadowGenerator=this;var caps=this._scene.getEngine().getCaps();if(!useFullFloatFirst){if(caps.textureHalfFloatRender&&caps.textureHalfFloatLinearFiltering){this._textureType=BABYLON.Engine.TEXTURETYPE_HALF_FLOAT}else if(caps.textureFloatRender&&caps.textureFloatLinearFiltering){this._textureType=BABYLON.Engine.TEXTURETYPE_FLOAT}else{this._textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}}else{if(caps.textureFloatRender&&caps.textureFloatLinearFiltering){this._textureType=BABYLON.Engine.TEXTURETYPE_FLOAT}else if(caps.textureHalfFloatRender&&caps.textureHalfFloatLinearFiltering){this._textureType=BABYLON.Engine.TEXTURETYPE_HALF_FLOAT}else{this._textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}}this._initializeGenerator()}Object.defineProperty(ShadowGenerator,"FILTER_NONE",{get:function(){return ShadowGenerator._FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator,"FILTER_POISSONSAMPLING",{get:function(){return ShadowGenerator._FILTER_POISSONSAMPLING},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator,"FILTER_EXPONENTIALSHADOWMAP",{get:function(){return ShadowGenerator._FILTER_EXPONENTIALSHADOWMAP},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator,"FILTER_BLUREXPONENTIALSHADOWMAP",{get:function(){return ShadowGenerator._FILTER_BLUREXPONENTIALSHADOWMAP},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator,"FILTER_CLOSEEXPONENTIALSHADOWMAP",{get:function(){return ShadowGenerator._FILTER_CLOSEEXPONENTIALSHADOWMAP},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator,"FILTER_BLURCLOSEEXPONENTIALSHADOWMAP",{get:function(){return ShadowGenerator._FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"bias",{get:function(){return this._bias},set:function(bias){this._bias=bias},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(value){if(this._blurBoxOffset===value){return}this._blurBoxOffset=value;this._disposeBlurPostProcesses()},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"blurScale",{get:function(){return this._blurScale},set:function(value){if(this._blurScale===value){return}this._blurScale=value;this._disposeBlurPostProcesses()},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"blurKernel",{get:function(){return this._blurKernel},set:function(value){if(this._blurKernel===value){return}this._blurKernel=value;this._disposeBlurPostProcesses()},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"useKernelBlur",{get:function(){return this._useKernelBlur},set:function(value){if(this._useKernelBlur===value){return}this._useKernelBlur=value;this._disposeBlurPostProcesses()},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"depthScale",{get:function(){return this._depthScale!==undefined?this._depthScale:this._light.getDepthScale()},set:function(value){this._depthScale=value},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"filter",{get:function(){return this._filter},set:function(value){if(this._light.needCube()){if(value===ShadowGenerator.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=true;return}else if(value===ShadowGenerator.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=true;return}}if(this._filter===value){return}this._filter=value;this._disposeBlurPostProcesses();this._applyFilterValues();this._light._markMeshesAsLightDirty()},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"usePoissonSampling",{get:function(){return this.filter===ShadowGenerator.FILTER_POISSONSAMPLING},set:function(value){if(!value&&this.filter!==ShadowGenerator.FILTER_POISSONSAMPLING){return}this.filter=value?ShadowGenerator.FILTER_POISSONSAMPLING:ShadowGenerator.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"useVarianceShadowMap",{get:function(){BABYLON.Tools.Warn("VSM are now replaced by ESM. Please use useExponentialShadowMap instead.");return this.useExponentialShadowMap},set:function(value){BABYLON.Tools.Warn("VSM are now replaced by ESM. Please use useExponentialShadowMap instead.");this.useExponentialShadowMap=value},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"useBlurVarianceShadowMap",{get:function(){BABYLON.Tools.Warn("VSM are now replaced by ESM. Please use useBlurExponentialShadowMap instead.");return this.useBlurExponentialShadowMap},set:function(value){BABYLON.Tools.Warn("VSM are now replaced by ESM. Please use useBlurExponentialShadowMap instead.");this.useBlurExponentialShadowMap=value},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"useExponentialShadowMap",{get:function(){return this.filter===ShadowGenerator.FILTER_EXPONENTIALSHADOWMAP},set:function(value){if(!value&&this.filter!==ShadowGenerator.FILTER_EXPONENTIALSHADOWMAP){return}this.filter=value?ShadowGenerator.FILTER_EXPONENTIALSHADOWMAP:ShadowGenerator.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"useBlurExponentialShadowMap",{get:function(){return this.filter===ShadowGenerator.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(value){if(!value&&this.filter!==ShadowGenerator.FILTER_BLUREXPONENTIALSHADOWMAP){return}this.filter=value?ShadowGenerator.FILTER_BLUREXPONENTIALSHADOWMAP:ShadowGenerator.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"useCloseExponentialShadowMap",{get:function(){return this.filter===ShadowGenerator.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(value){if(!value&&this.filter!==ShadowGenerator.FILTER_CLOSEEXPONENTIALSHADOWMAP){return}this.filter=value?ShadowGenerator.FILTER_CLOSEEXPONENTIALSHADOWMAP:ShadowGenerator.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(ShadowGenerator.prototype,"useBlurCloseExponentialShadowMap",{get:function(){return this.filter===ShadowGenerator.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(value){if(!value&&this.filter!==ShadowGenerator.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){return}this.filter=value?ShadowGenerator.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP:ShadowGenerator.FILTER_NONE},enumerable:true,configurable:true});ShadowGenerator.prototype.getDarkness=function(){return this._darkness};ShadowGenerator.prototype.setDarkness=function(darkness){if(darkness>=1)this._darkness=1;else if(darkness<=0)this._darkness=0;else this._darkness=darkness;return this};ShadowGenerator.prototype.setTransparencyShadow=function(hasShadow){this._transparencyShadow=hasShadow;return this};ShadowGenerator.prototype.getShadowMap=function(){return this._shadowMap};ShadowGenerator.prototype.getShadowMapForRendering=function(){if(this._shadowMap2){return this._shadowMap2}return this._shadowMap};ShadowGenerator.prototype.addShadowCaster=function(mesh,includeDescendants){if(includeDescendants===void 0){includeDescendants=true}this._shadowMap.renderList.push(mesh);if(includeDescendants){(_a=this._shadowMap.renderList).push.apply(_a,mesh.getChildMeshes())}return this;var _a};ShadowGenerator.prototype.removeShadowCaster=function(mesh,includeDescendants){if(includeDescendants===void 0){includeDescendants=true}var index=this._shadowMap.renderList.indexOf(mesh);if(index!==-1){this._shadowMap.renderList.splice(index,1)}if(includeDescendants){for(var _i=0,_a=mesh.getChildren();_i<_a.length;_i++){var child=_a[_i];this.removeShadowCaster(child)}}return this};ShadowGenerator.prototype.getLight=function(){return this._light};ShadowGenerator.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty();this._initializeShadowMap()};ShadowGenerator.prototype._initializeShadowMap=function(){var _this=this;this._shadowMap=new BABYLON.RenderTargetTexture(this._light.name+"_shadowMap",this._mapSize,this._scene,false,true,this._textureType,this._light.needCube());this._shadowMap.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;this._shadowMap.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;this._shadowMap.anisotropicFilteringLevel=1;this._shadowMap.updateSamplingMode(BABYLON.Texture.BILINEAR_SAMPLINGMODE);this._shadowMap.renderParticles=false;this._shadowMap.ignoreCameraViewport=true;this._shadowMap.onBeforeRenderObservable.add(function(faceIndex){_this._currentFaceIndex=faceIndex});this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this);this._shadowMap.onAfterUnbindObservable.add(function(){if(!_this.useBlurExponentialShadowMap&&!_this.useBlurCloseExponentialShadowMap){return}if(!_this._blurPostProcesses){_this._initializeBlurRTTAndPostProcesses()}_this._scene.postProcessManager.directRender(_this._blurPostProcesses,_this.getShadowMapForRendering().getInternalTexture(),true)});this._shadowMap.onClearObservable.add(function(engine){if(_this.useExponentialShadowMap||_this.useBlurExponentialShadowMap){engine.clear(new BABYLON.Color4(0,0,0,0),true,true,true)}else{engine.clear(new BABYLON.Color4(1,1,1,1),true,true,true)}})};ShadowGenerator.prototype._initializeBlurRTTAndPostProcesses=function(){var _this=this;var engine=this._scene.getEngine();var targetSize=this._mapSize/this.blurScale;if(!this.useKernelBlur||this.blurScale!==1){this._shadowMap2=new BABYLON.RenderTargetTexture(this._light.name+"_shadowMap2",targetSize,this._scene,false,true,this._textureType);this._shadowMap2.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;this._shadowMap2.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;this._shadowMap2.updateSamplingMode(BABYLON.Texture.BILINEAR_SAMPLINGMODE)}if(this.useKernelBlur){this._kernelBlurXPostprocess=new BABYLON.BlurPostProcess(this._light.name+"KernelBlurX",new BABYLON.Vector2(1,0),this.blurKernel,1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._textureType);this._kernelBlurXPostprocess.width=targetSize;this._kernelBlurXPostprocess.height=targetSize;this._kernelBlurXPostprocess.onApplyObservable.add(function(effect){effect.setTexture("textureSampler",_this._shadowMap)});this._kernelBlurYPostprocess=new BABYLON.BlurPostProcess(this._light.name+"KernelBlurY",new BABYLON.Vector2(0,1),this.blurKernel,1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._textureType);this._kernelBlurXPostprocess.autoClear=false;this._kernelBlurYPostprocess.autoClear=false;if(this._textureType===BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT){this._kernelBlurXPostprocess.packedFloat=true;this._kernelBlurYPostprocess.packedFloat=true}this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]}else{this._boxBlurPostprocess=new BABYLON.PostProcess(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,"#define OFFSET "+this._blurBoxOffset,this._textureType);this._boxBlurPostprocess.onApplyObservable.add(function(effect){effect.setFloat2("screenSize",targetSize,targetSize);effect.setTexture("textureSampler",_this._shadowMap)});this._boxBlurPostprocess.autoClear=false;this._blurPostProcesses=[this._boxBlurPostprocess]}};ShadowGenerator.prototype._renderForShadowMap=function(opaqueSubMeshes,alphaTestSubMeshes,transparentSubMeshes,depthOnlySubMeshes){var index;var engine=this._scene.getEngine();if(depthOnlySubMeshes.length){engine.setColorWrite(false);for(index=0;index<depthOnlySubMeshes.length;index++){this._renderSubMeshForShadowMap(depthOnlySubMeshes.data[index])}engine.setColorWrite(true)}for(index=0;index<opaqueSubMeshes.length;index++){this._renderSubMeshForShadowMap(opaqueSubMeshes.data[index])}for(index=0;index<alphaTestSubMeshes.length;index++){this._renderSubMeshForShadowMap(alphaTestSubMeshes.data[index])}if(this._transparencyShadow){for(index=0;index<transparentSubMeshes.length;index++){this._renderSubMeshForShadowMap(transparentSubMeshes.data[index])}}};ShadowGenerator.prototype._renderSubMeshForShadowMap=function(subMesh){var _this=this;var mesh=subMesh.getRenderingMesh();var scene=this._scene;var engine=scene.getEngine();engine.setState(subMesh.getMaterial().backFaceCulling);var batch=mesh._getInstancesRenderList(subMesh._id);if(batch.mustReturn){return}var hardwareInstancedRendering=engine.getCaps().instancedArrays&&batch.visibleInstances[subMesh._id]!==null&&batch.visibleInstances[subMesh._id]!==undefined;if(this.isReady(subMesh,hardwareInstancedRendering)){engine.enableEffect(this._effect);mesh._bind(subMesh,this._effect,BABYLON.Material.TriangleFillMode);var material=subMesh.getMaterial();this._effect.setFloat2("biasAndScale",this.bias,this.depthScale);this._effect.setMatrix("viewProjection",this.getTransformMatrix());this._effect.setVector3("lightPosition",this.getLight().position);this._effect.setFloat2("depthValues",this.getLight().getDepthMinZ(scene.activeCamera),this.getLight().getDepthMinZ(scene.activeCamera)+this.getLight().getDepthMaxZ(scene.activeCamera));if(material&&material.needAlphaTesting()){var alphaTexture=material.getAlphaTestTexture();if(alphaTexture){this._effect.setTexture("diffuseSampler",alphaTexture);this._effect.setMatrix("diffuseMatrix",alphaTexture.getTextureMatrix()||this._defaultTextureMatrix)}}if(mesh.useBones&&mesh.computeBonesUsingShaders){this._effect.setMatrices("mBones",mesh.skeleton.getTransformMatrices(mesh))}if(this.forceBackFacesOnly){engine.setState(true,0,false,true)}mesh._processRendering(subMesh,this._effect,BABYLON.Material.TriangleFillMode,batch,hardwareInstancedRendering,function(isInstance,world){return _this._effect.setMatrix("world",world)});if(this.forceBackFacesOnly){engine.setState(true,0,false,false)}}else{this._shadowMap.resetRefreshCounter()}};ShadowGenerator.prototype._applyFilterValues=function(){if(this.filter===ShadowGenerator.FILTER_NONE){this._shadowMap.updateSamplingMode(BABYLON.Texture.NEAREST_SAMPLINGMODE)}else{this._shadowMap.updateSamplingMode(BABYLON.Texture.BILINEAR_SAMPLINGMODE)}};ShadowGenerator.prototype.forceCompilation=function(onCompiled,options){var _this=this;var subMeshes=new Array;var currentIndex=0;for(var _i=0,_a=this.getShadowMap().renderList;_i<_a.length;_i++){var mesh=_a[_i];subMeshes.push.apply(subMeshes,mesh.subMeshes)}var checkReady=function(){if(!_this._scene||!_this._scene.getEngine()){return}var subMesh=subMeshes[currentIndex];if(_this.isReady(subMesh,options?options.useInstances:false)){currentIndex++;if(currentIndex>=subMeshes.length){if(onCompiled){onCompiled(_this)}return}}setTimeout(checkReady,16)};if(subMeshes.length>0){checkReady()}};ShadowGenerator.prototype.isReady=function(subMesh,useInstances){var defines=[];if(this._textureType!==BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT){defines.push("#define FLOAT")}if(this.useExponentialShadowMap||this.useBlurExponentialShadowMap){defines.push("#define ESM")}var attribs=[BABYLON.VertexBuffer.PositionKind];var mesh=subMesh.getMesh();var material=subMesh.getMaterial();if(material&&material.needAlphaTesting()){var alphaTexture=material.getAlphaTestTexture();if(alphaTexture){defines.push("#define ALPHATEST");if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){attribs.push(BABYLON.VertexBuffer.UVKind);defines.push("#define UV1")}if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)){if(alphaTexture.coordinatesIndex===1){attribs.push(BABYLON.VertexBuffer.UV2Kind);defines.push("#define UV2")}}}}if(mesh.useBones&&mesh.computeBonesUsingShaders){attribs.push(BABYLON.VertexBuffer.MatricesIndicesKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsKind);if(mesh.numBoneInfluencers>4){attribs.push(BABYLON.VertexBuffer.MatricesIndicesExtraKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsExtraKind)}defines.push("#define NUM_BONE_INFLUENCERS "+mesh.numBoneInfluencers);defines.push("#define BonesPerMesh "+(mesh.skeleton.bones.length+1))}else{defines.push("#define NUM_BONE_INFLUENCERS 0")}if(useInstances){defines.push("#define INSTANCES");attribs.push("world0");attribs.push("world1");attribs.push("world2");attribs.push("world3")}var join=defines.join("\n");if(this._cachedDefines!==join){this._cachedDefines=join;this._effect=this._scene.getEngine().createEffect("shadowMap",attribs,["world","mBones","viewProjection","diffuseMatrix","lightPosition","depthValues","biasAndScale"],["diffuseSampler"],join)}return this._effect.isReady()};ShadowGenerator.prototype.prepareDefines=function(defines,lightIndex){var scene=this._scene;var light=this._light;if(!scene.shadowsEnabled||!light.shadowEnabled){return}defines["SHADOW"+lightIndex]=true;if(this.usePoissonSampling){defines["SHADOWPCF"+lightIndex]=true}else if(this.useExponentialShadowMap||this.useBlurExponentialShadowMap){defines["SHADOWESM"+lightIndex]=true}else if(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap){defines["SHADOWCLOSEESM"+lightIndex]=true}if(light.needCube()){defines["SHADOWCUBE"+lightIndex]=true}};ShadowGenerator.prototype.bindShadowLight=function(lightIndex,effect){var light=this._light;var scene=this._scene;if(!scene.shadowsEnabled||!light.shadowEnabled){return}if(!light.needCube()){effect.setMatrix("lightMatrix"+lightIndex,this.getTransformMatrix())}effect.setTexture("shadowSampler"+lightIndex,this.getShadowMapForRendering());light._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/this.getShadowMap().getSize().width,this.depthScale,this.frustumEdgeFalloff,lightIndex);light._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(scene.activeCamera),this.getLight().getDepthMinZ(scene.activeCamera)+this.getLight().getDepthMaxZ(scene.activeCamera),lightIndex)};ShadowGenerator.prototype.getTransformMatrix=function(){var scene=this._scene;if(this._currentRenderID===scene.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex){return this._transformMatrix}this._currentRenderID=scene.getRenderId();this._currentFaceIndexCache=this._currentFaceIndex;var lightPosition=this._light.position;if(this._light.computeTransformedInformation()){lightPosition=this._light.transformedPosition}BABYLON.Vector3.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection);if(Math.abs(BABYLON.Vector3.Dot(this._lightDirection,BABYLON.Vector3.Up()))===1){this._lightDirection.z=1e-13}if(this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!lightPosition.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition=lightPosition.clone();this._cachedDirection=this._lightDirection.clone();BABYLON.Matrix.LookAtLHToRef(lightPosition,lightPosition.add(this._lightDirection),BABYLON.Vector3.Up(),this._viewMatrix);this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,this.getShadowMap().renderList);this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix};ShadowGenerator.prototype.recreateShadowMap=function(){var renderList=this._shadowMap.renderList;this._disposeRTTandPostProcesses();this._initializeGenerator();this.filter=this.filter;this._applyFilterValues();this._shadowMap.renderList=renderList};ShadowGenerator.prototype._disposeBlurPostProcesses=function(){if(this._shadowMap2){this._shadowMap2.dispose();this._shadowMap2=null}if(this._downSamplePostprocess){this._downSamplePostprocess.dispose();this._downSamplePostprocess=null}if(this._boxBlurPostprocess){this._boxBlurPostprocess.dispose();this._boxBlurPostprocess=null}if(this._kernelBlurXPostprocess){this._kernelBlurXPostprocess.dispose();this._kernelBlurXPostprocess=null}if(this._kernelBlurYPostprocess){this._kernelBlurYPostprocess.dispose();this._kernelBlurYPostprocess=null}this._blurPostProcesses=null};ShadowGenerator.prototype._disposeRTTandPostProcesses=function(){if(this._shadowMap){this._shadowMap.dispose();this._shadowMap=null}this._disposeBlurPostProcesses()};ShadowGenerator.prototype.dispose=function(){this._disposeRTTandPostProcesses();this._light._shadowGenerator=null;this._light._markMeshesAsLightDirty()};ShadowGenerator.prototype.serialize=function(){var serializationObject={};var shadowMap=this.getShadowMap();serializationObject.lightId=this._light.id;serializationObject.mapSize=shadowMap.getRenderSize();serializationObject.useExponentialShadowMap=this.useExponentialShadowMap;serializationObject.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap;serializationObject.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap;serializationObject.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap;serializationObject.usePoissonSampling=this.usePoissonSampling;serializationObject.forceBackFacesOnly=this.forceBackFacesOnly;serializationObject.depthScale=this.depthScale;serializationObject.darkness=this.getDarkness();serializationObject.blurBoxOffset=this.blurBoxOffset;serializationObject.blurKernel=this.blurKernel;serializationObject.blurScale=this.blurScale;serializationObject.useKernelBlur=this.useKernelBlur;serializationObject.transparencyShadow=this._transparencyShadow;serializationObject.renderList=[];for(var meshIndex=0;meshIndex<shadowMap.renderList.length;meshIndex++){var mesh=shadowMap.renderList[meshIndex];serializationObject.renderList.push(mesh.id)}return serializationObject};ShadowGenerator.Parse=function(parsedShadowGenerator,scene){var light=scene.getLightByID(parsedShadowGenerator.lightId);var shadowGenerator=new ShadowGenerator(parsedShadowGenerator.mapSize,light);var shadowMap=shadowGenerator.getShadowMap();for(var meshIndex=0;meshIndex<parsedShadowGenerator.renderList.length;meshIndex++){var meshes=scene.getMeshesByID(parsedShadowGenerator.renderList[meshIndex]);meshes.forEach(function(mesh){shadowMap.renderList.push(mesh)})}if(parsedShadowGenerator.usePoissonSampling){shadowGenerator.usePoissonSampling=true}else if(parsedShadowGenerator.useExponentialShadowMap){shadowGenerator.useExponentialShadowMap=true}else if(parsedShadowGenerator.useBlurExponentialShadowMap){shadowGenerator.useBlurExponentialShadowMap=true}else if(parsedShadowGenerator.useCloseExponentialShadowMap){shadowGenerator.useCloseExponentialShadowMap=true}else if(parsedShadowGenerator.useBlurCloseExponentialShadowMap){shadowGenerator.useBlurCloseExponentialShadowMap=true}else if(parsedShadowGenerator.useVarianceShadowMap){shadowGenerator.useExponentialShadowMap=true}else if(parsedShadowGenerator.useBlurVarianceShadowMap){shadowGenerator.useBlurExponentialShadowMap=true}if(parsedShadowGenerator.depthScale){shadowGenerator.depthScale=parsedShadowGenerator.depthScale}if(parsedShadowGenerator.blurScale){shadowGenerator.blurScale=parsedShadowGenerator.blurScale}if(parsedShadowGenerator.blurBoxOffset){shadowGenerator.blurBoxOffset=parsedShadowGenerator.blurBoxOffset}if(parsedShadowGenerator.useKernelBlur){shadowGenerator.useKernelBlur=parsedShadowGenerator.useKernelBlur}if(parsedShadowGenerator.blurKernel){shadowGenerator.blurKernel=parsedShadowGenerator.blurKernel}if(parsedShadowGenerator.bias!==undefined){shadowGenerator.bias=parsedShadowGenerator.bias}if(parsedShadowGenerator.darkness){shadowGenerator.setDarkness(parsedShadowGenerator.darkness)}if(parsedShadowGenerator.transparencyShadow){shadowGenerator.setTransparencyShadow(true)}shadowGenerator.forceBackFacesOnly=parsedShadowGenerator.forceBackFacesOnly;return shadowGenerator};ShadowGenerator._FILTER_NONE=0;ShadowGenerator._FILTER_EXPONENTIALSHADOWMAP=1;ShadowGenerator._FILTER_POISSONSAMPLING=2;ShadowGenerator._FILTER_BLUREXPONENTIALSHADOWMAP=3;ShadowGenerator._FILTER_CLOSEEXPONENTIALSHADOWMAP=4;ShadowGenerator._FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;return ShadowGenerator}();BABYLON.ShadowGenerator=ShadowGenerator})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DefaultLoadingScreen=function(){function DefaultLoadingScreen(_renderingCanvas,_loadingText,_loadingDivBackgroundColor){if(_loadingText===void 0){_loadingText=""}if(_loadingDivBackgroundColor===void 0){_loadingDivBackgroundColor="black"}var _this=this;this._renderingCanvas=_renderingCanvas;this._loadingText=_loadingText;this._loadingDivBackgroundColor=_loadingDivBackgroundColor;this._resizeLoadingUI=function(){var canvasRect=_this._renderingCanvas.getBoundingClientRect();var canvasPositioning=window.getComputedStyle(_this._renderingCanvas).position;_this._loadingDiv.style.position=canvasPositioning==="fixed"?"fixed":"absolute";_this._loadingDiv.style.left=canvasRect.left+"px";_this._loadingDiv.style.top=canvasRect.top+"px";_this._loadingDiv.style.width=canvasRect.width+"px";_this._loadingDiv.style.height=canvasRect.height+"px"}}DefaultLoadingScreen.prototype.displayLoadingUI=function(){if(this._loadingDiv){return}this._loadingDiv=document.createElement("div");this._loadingDiv.id="babylonjsLoadingDiv";this._loadingDiv.style.opacity="0";this._loadingDiv.style.transition="opacity 1.5s ease";this._loadingDiv.style.pointerEvents="none";this._loadingTextDiv=document.createElement("div");this._loadingTextDiv.style.position="absolute";this._loadingTextDiv.style.left="0";this._loadingTextDiv.style.top="50%";this._loadingTextDiv.style.marginTop="80px";this._loadingTextDiv.style.width="100%";this._loadingTextDiv.style.height="20px";this._loadingTextDiv.style.fontFamily="Arial";this._loadingTextDiv.style.fontSize="14px";this._loadingTextDiv.style.color="white";this._loadingTextDiv.style.textAlign="center";this._loadingTextDiv.innerHTML="Loading";this._loadingDiv.appendChild(this._loadingTextDiv);this._loadingTextDiv.innerHTML=this._loadingText;var style=document.createElement("style");style.type="text/css";var keyFrames="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }";style.innerHTML=keyFrames;document.getElementsByTagName("head")[0].appendChild(style);var imgBack=new Image;imgBack.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAYAAAA5ZDbSAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTZEaa/1AAAYq0lEQVR4Xu2dCZRcVZnHScAJUZSwjSOIbAJmEAZwQCCMoAInYRGIg8AwegQx7AFzUBBmzAFlE4EAwxz2GRk2w7AnAURZBiEOZgyEQDAQAjmEJqTpNd3V1V3Vmd+/6utKV7/1vnpVXd2p/zn3vOV+27vfu/fd/W3QQAPrBZqbm7fJZrN79vf3T+/r67uf4wO9vb37WXQDIwWtra0Tenp6voQTv5XP56/BkfcR3iLk1g6B7hEeI+zP5V+ZiAbqBZ2dnZ8lV+6Gg87CobfhpOc4byf0FjwYE9DneBkWcXrM2tmzNzTxDdQKJPyETCazI46YgiMuI9zJuXJltuChFIHsP/PSfIfTjU19A2mira1tcxy3ey6XO5vEnkV4kes11XBmENDVj97XOT2O03FmWgMuoNLzGRJva8IUnPkzjjcT/kLoKCZzfQB7XiX8M2G8md7AUJgzJ+Z6e88gZ1xGuj3HsY17PcVkrG9gp7CUF/F8PUvxqdZDrFq1ahNVfKjwTCYxZuDE2wjKlc2WViMePM+HPNsFPOdf22OPblD5OZQHvphnV65cjTMzxaQY3eA5V9OO/hmnm1lSjE7woFsQbiXki4++foHnXkW4mLC1JUl947333tsMY3emqfB9jtPJlXN5U0+bOXPmWCPxgOccSy4+AfqPio+9/oFnbyatbqVE28GSZfjQ1NT0KQzaHMcdyPfyaNoE12HcvdxT29K3Fkv8A2vWrPmcifAFZNtD91yRY+SBZ+9UsMtEgD+jTpeenp6JXI6xpKkuUDqRcA6Kr0Wpens+InQTnIpV6Fdi+BQT64ulS5eOIzefD62na7CeoGcnLCM8ykt5OWlzcPv772/BS/w3nP+K+xU11+DvQe5dcrQlTfWAwbNMb8XA8AyGX80xtLlA6TAJuteMbVhhia1v5VMcr+LWMeoZ4xiYw7q6urbhHbgG+paCkIRQehHu4pO3O5fVydEomF5Ulx548JfVD2wqfKE2I3R3ob/f2GoC1DWhdz7HG3i5j2pvb9+Z24m6HvVZQtYsZFWcowlzePEP4jJdR/OQhxTVpAs9NMXxmZxuZKo8IG4s+v8R2tUFphSBTBWzH+OAFwn/gS3TuN55xYoVqfc6dXd3fwHZ1xFaTX0iyGbwjJqXXAammxP00EXx6UMGEx7ram7+vKnzBZ/87Xiwp40tEdDTgYwlHG/CmadSjO7L+XiialOZAej7POFG2VK0Khngl6Pn8/LL0YEtlFh4n8oDAqvaAYH8tzH2iNDm1IIFn8Ax50G7xtgCAU07CfAG4RHOz+vLZL7e0dGxlYlKHaj8BHo25xgrsfV5wrYH4KmouxV+ZZDnCUdwmXxMGgFvFUVWD+jQuOot6rI0tb4gcfaG9v+MrcAn+wj38gL8C7cObmlp2ZRjOkWYD6ypuAf6zjFHLSJ0c/6YQ813DM/yZXgehreiVgP8cvSfsOeExYsXuzs6n8v9j8mqBRZQmdjXVPuira1NHSpn8UDf4Xu0vd2uCtDzacJOlDDf5ng94X8JTWarB8R1EK7ju7udiYgEz/v3pLFKm4oHUHhh3iZdfshpaEYpA4pvKLLXBujLYKRq71XLhUHg27z12rW9B6L/QhLrWWxRH7nzeDK8awi/5HRTEx0K6MZQ694LHk0DqrgfADkreIYz1q5c+UlTEQzesIuMryrggYQWjNL3RGO7p2tuFMeqjaOidgzyCz1yJMTJ6L6d66WEVCcHIO/dQkI75Chs2g97Hoc3jRz9Lge1ED5l4r0gckqRPB0gTw34t1B+h3IqxZkmrn2SULUa7ezZszdE5xfR9130Xsm5ilrnHrmkQOcKvrkncxqrIiY6wlewbw7BOUfDo/b84zzvj9C7J7eCS0NrUiRKCPjUE7ScMBdlF/B2HqBi0ERXBcuXL99YnQz9fX2ah3Up4UnsWGEmDRuUhoTn+Z5PfvbZZ2N/fuCZRJgnfhNVBu73EZoIKt7l0L2UBsYeDZg016nb5EUCWuXQewinUtTuyq2aTStF14a8SD+VDQVj6hDYxjuXf4Hjl83sSMCmTp8j4FtoMuRQ5dAZcii3kk/0s2bBhxIcBxjxUlib1hWInEDO/6qKV+y4geO5HAMntEE/pq+nZyo0ywsG1SmwL4Orf+0yqGCfmvR73LAn9lAeBjQTEhkA+1h49a08iRflcq4H5iuXFU9cz4lqihC/LXS/NZa6Bc+pz5gql5ub6VXD2tZWTSPeyS7XgeLhXrMnEhj6MSHSwaIhFGZH8oA/JzzFeexvJbRN2HW03moT6cEChx6w4QY2rurn85JWrxsiCy0FwjcIqos8w7GZNPulkawDEbFHlaBtjzODEDrVztuKXMmADPWA3RaljyJeNdKq98ilAez8iJdyGqfO31V4NoV/EvyaCqR54V2EshE5Lqcb+TrkstkTLD4WKB4PNNZQ8P05HAelMXNSPWChC8JsYvwthJo0jSoF6fIqjjqe08Aat+LIkd+AVjn09zxbZFqK3tjXAUbXUaWDjTUSyN4J45YZX2Igo4cEOVfFson2ALIxSjR0jog5YNgpfNHM90BxIjDyWIB8Z2NfB01HISJ20wPaw4w1FlavXq1v8aPGXhFw9JNRFTDItifU/RwwpfmKxYsDK180kU4x0lhAXvOSJUs+bezlIDL2N4xi4GpjK4MGCuzUA+SPxzn3m4iKgKyV2DCV08DeMWg0B+zHHOt2DpjS3Mz1BfFOM25C5ZH4LxldJBB0g7GVARkaXgv8VsKqZtIMPpN9RUnJgRzU5Wfp22vifcG3+2vQvmdsdQXsX2pm+oKX+GYjjQXkPWqsXshpRhcJ0RpbGShSHiSuheP37ZYHsGusVHOrU1lMxkO9od4eE+8LlSzQqfetpnPAooBN/2Um+gISp89MkF8K4G3RrMJYoOhbYGxlQEGhSOGogfoLwipExGtUZVVBYIVAluaAaUpuWA+YujlPF22Ra/iBLYEOsV6tV4w0FiitfmLsXiBMU0NiAVrfsp77Zd8MHPgbDoHtva6uLs1jiv1piAKy5tCG+4KJ9wVO/p6RDzvy+b5rzSwP9Okh/WKPERiCWzfk4K8bUSTiOljAyCdx5DZG4gE8W5Dov+NYUfsV/j50fUC4dmXIQDh0qQ6PVgJsOcLM8oA410Ggvo6Ojr81di+g2TKuQOiyJOKWxlpCJpM5zUjKAL3awTsamQfEbYhjtDGKa5tPsyn/wAuiURftlBO56h6aunEwCMxxvV1d+2Fr7Jce2vAu5LUtLeoGi/19gtbToCaR97BoD6BvUs+WkXqgbw6OuhC6wH5l4rRGaCFOvYnjYbyxnpcsCvDVhYOxo6+zszNwSNHVTtJEmSiwzlMAQmNPwIPW42Dds2hfEK/5WJo0Fth+5VNxFHSlkoTzFRh/N3wnq0OGWxXtdoO8enFwaI4jsyidYgNZTxhrMEjEJ4w+En65ESWRXZ7Q4K/COqDAPlhka87WedB8KawmngTIHREOJs5pMiRp+p/GGgxL1FiA9hxjK6G1tVVdhJGAV15+cPXq1f7dahVC20Wg4miCp0uTe3Xh4Hwu93rY1B7SR/t7xQbP5R1FGgpy8IlKe+MJhZ9Aa7u5jPm+pGLX2BMDOZ+hDXgQiXIJ5xoXHZg96anEEFcvOTi0SMUXS4w0FijSTzTWYEA3hkTSEtDI2qw6RoytDLA6jctCvzKqJ8oPFOO7kAhnYe9cZGiWiZ/N9ezguWaSL4h3TUfvKJIfoN0I4sjigYSdZyxlcDVMgEczEY41ER6oZFBOh2Yqegf2zYoziFC3DuZZrjSTPLDtMlxaNPmPP/54W2OPxksrVozP5fLPGr8vEOpbxJCr3jQSJyDvGRNRhv7iHh8vE5LMpKznHBz4zSTOaXwe+mXGGh9tbWvVQf+iyfCAON/ZlTj4v43ECfB94Le4CuMrWVpTtw7O9fZOM5M8oD7xVSOLBdLuNWN1g7bgJUF8+4qpBjf7Te9M6hD4tBDc0289Wh2MHbuaSR7gsHOMLBaQ9W/G6o5MJrNDPu9dcYdQ33Yc95I6OFV5hnp2cGCliDingX5KU+9MShd0dmqta/k8J4zwnV2JsuuNxAnI83VwNpO52kiSoC4djA255cuXBzYPycGzjTQWkPdNY00OfRcQVLafRnd39ySLLsG1i20AyPZ3cDb7AyNJgnp1cOhUHUhcFiL045v9jTUa8Gjlm29fsQQhb3DzJLUEhC+oiK7EISPOwapoEh+7JQJti5YfGXs0YNC62ouC1h9lsrlToClsjc/RM7uSe0kd3EmlzTO/Kqk8Q106mM/Yw2aOB9jnOg6sWTHxJ9FraSJMy6nGz7RbZUDYmN7e3BnQ5Gisez7u3J9c0JwA6Pb0aCFvNObgwKk6NoU59uJwaJ8y1viAT4vCtEFXYO8SFQGtCZpllyXQtNqL+4lmZ/BN/5qJKQFZozEHe9JtAGSaw4wsFnie4JmUQcjleh8yZq0Fnmq3y0D02IzPMgnonYqYIfA4pC+TcXrgIahLB+PEb5s5HrjaR0b7kbHGB0pK7TDO1/T39x1lUZGAPlUH0xTbz+KSoC4dDDx2DQCHzTCaWOB5zjbW+KCSpW0IS0BIJmy6zWCk7WDuxZ4r5oO6dHB7e/sBZo4H2OfUsYOv9jHW+ECJdkAtA/c6MpmMd+XaEKj7km9M4F5TEfBzSKovDLKG1cHobw+b6EDa3WOksYBPAhevBUJMxl8GJTRhFyMLBKSJFn5ls9nvmogS0DfaHOzb3h8AcUuNNBLQNiWa0gRv4MwMMyBwCqxAfCIH82JdYSJKQN+ocjA5NHD2I/e1aj/23iPyhbG6A+bAgXsZoUEII/UAkkQORu71JqIE7o22HBw4VaelpWU74mPPDc/39d1trO5Qb4vJ8QXxbwat06WofcTInMCzeToAtN4VXUn/l1AXDkan9tDSfmL6C81BZooHxDkN9CMveLFZFFAWWZtDwVta3G0sJcAbe3bmYEiniShBXabcL+wflQDD5mD0yKlvk0b/Tk33AG5F7idG+/ibRe54oEl1nLG6A+ZYe1jyAIuG/u2LB3MazxwAfL5vJFGJinxQUwcju6c/n3+FNPm5JhJyy2k/sQTp5nm+2HBJCGi1X1WpwzuBoQXAN+IcjDz8mdePKi/WhH1uxd7GcCjIVBcWpUYDfZ0VbclEJSr2akMBhVrdX6j+Jx3DpSh7vKB8CIiqKwcrcXGqdr05k3RKbU9ryTQVkUB3aHMrEshw7kGCXiv8xxG0h6Uzent6Fpn6MhA17A6GT/3yTxNO1coJbgWur3JFf1fXNuTes5AZe18xXobFHJKv04JZc3O7CtIcgGL9KW03u3QCfL4D4b292dhrpoYgsYOhEz4kaOuHqXKqiagYiN9QnUlyKgX84JUYsQFP9GKzMFRSe8XJb9upE9Dn62CK/KQT75wdTLz+NXgPNdrDuYzeUd0ByN4Wp07n+EdCRZuTY1/ymZQDwIjQye9pA32xdw6IiUgHc639mN8kzCLRjkxzQRzitUpkZ8LZBP1CILUd55EVvdgsCrzJl5i8mgCja+Zgjst4Pq3DUnMmtSWqyNIuQruRU3+CbO08n+pvBAZAjf1IU5kcGJc0YRMBfVV3MPd2RN4+YbvYukI/3sSpe+LUmbw0ryG/6ts1oSLeYrMw6C0xeaFAGc+Wq3hbfeRk582b55lrzf3UHJwWkD0Wp+6BQ3+BfXEXw6UCdHX4TVB0BoJi9Y1Cp59XbUWN8HW7lRjLli3zbINE+1hNiCRI1cGakIhT99ani/A6z1z1nDoUqNQfbO40kyqDfrCBwMg3E5rsCy+8sFlHR8dEnFzRTq/I8hQ9NFFOtGhXVOxgFeUqfknUK7Ctpjl1ANKJ/vmUkvrdwRZmWjpA4J9MTyja2toKY8TQa/ufxP/Whdd5c5cQJHIwfBsTvkKiaqd6/fRyOHKqavdL0H+V2sxmWvrQCAeKItfmQlNyDG/8SVwnetMHyxmA7lm0K2I7GFrlVBW/V6FPP9GqeU4V0Kt2+O2yhctUN6AJBEWD9ngMnessJxh5AfCoQe+8q+xQOYLuWbQrQh2MXP1XYh8S9DKC2sI1z6kCatW3/RCZ6Vj9fNPMqx2wQVNJQlcNEl/mGG5pv48bi7HxMVSOoHsW7QqPg5GlvnJtk6/B9+HMqYUfaXE6rampqWy4dVhgi8FfLprnBXEex+i/wCSkNiSNDSpUxxt7Ccj2nQQYAwUHc9yE3HEotuifDklnfFYMdGNC/lWCxotDf4PvB/jHZTs71c+f2n+ryqCPPcb5/pKdGrTvbH2MUjH4ByOLBDpON9YSFi5cuI1FOwFbbyTox5T6y+iwFL8CqvWvwVtolWgSv/N4sXbl5ZP3r8hRLT50d56KgYJDCYXVhYOhtqqReKDdZuGJtSQSOk8f67x581SspvH3lpoBe9Vefbg/lzveaXmnAf6tEDMNGRp3LnV3ch29o10lQIf+bOKZc+XnmMGARF2EK4vUwQiSw33n7ZlqDWwcaK9Ob29vd26vwj+OT8m3kKFxdd9tlILSJ1Wo8Y8RZT/YiKOY4le5P3SGZJAc7telg7FroL16Jc/n/a1cBBCxsSblwT8LOfofcCh4AQ4x1uoCXZtgVKnYDXLMUECnPSQD29VBcrhfVw7GHrVXb6WylGg0SvUZcrr+YPYuwWVfaE9ltmpA2Q6EQq2UY+yigzf2oqCH4v4MIysD94fdwdig9uqDnB4T5/d+gwHPGNVFcOopyJiPLOfmGTwa0Ek8qS8RKDKORLFWH95utwbDd94SRqqN/Cv4PDXbTFfXfUZWBvRUPJCRBJiIqfnnccy0Dz74wHkWoypY2D4ZGU8gK+kKjQKQ8RcTW1uQI2fmc7nH7LIMFEW+sw6xdyN4CgvNByNIDjp+ZyRVhzlV7dVLaZc7t1cRoW0w9of/No6ptbuRdZupqC3QPZY33HchMkbJiRPssgyaHkN82XaJXPtOJuN+JRuixQI6Cu1VXiZtJehcFGpeNPyXI6cqPWTIvsxU1R7o912akevre4OHfTHot3fEfRbD3y8+Qu0djO5Ce5UXNGl7dTt4z0RGqnOuhgLZgmcPk2FHrrd3jgwkAVQ58e1ioxjcHeMLPWQcq+5gZKm9+hJHjXo5z4xQBQsxxyDjEfir+nNq5GfQo/nYh6f9e4NUgGEFx3DEzvw1nPrOhSJ+kh6GUBUHw6//Kmls96dJ2qv6FxNF9z8g405kVLVXDfkaiFAd4JIkttYUGFpyDOf91Ch/YVEe8DA/gORpuywDfLNMjBOQt4qEupbTPTX4YeJig+/qrnoxkfMeIdH2UHGBfP0H6kFepElc1rY5lBQYXZbzuO7BWYH7b3V3d/+TX1FEG/JSExEJdOi7qsnrx3DuNM8Zdg2NqnN/BjK0EXlVhxORr56wP6Lv/DT+X1FzYLynaOWe2s1TjCQW4An9t6Jk4hBVdH6YpB9YNXoS+SRk/JaQZHd5J2CnesLuyGaze3KZ2hTemoNcpO+uB3pAQuzvC7SeJSfc0258Wo97aX9PT+TmMEMB73jsO0wJzXnVx4llL7pe5kWaFtSqGHHgu6rpPr5jsdx+hyI59G+hA4C25GDO1V69mbf/77h0+lZpzZX44B+Ye1X1cWKz92pKrYlcjtzc6gfN+ufhApd/ErcwTvuTRNI0m4c4Tg77u6gfbCHdTuQcrRFaRKiFU7Xl1O/RqX9RObevRxR43gmEBYUn9wEJIMeF/jk0yVKTta2tE0jg43kx1OatWifEYKDrHYKGDnfkMrU1xHUPaoh7k8i+030EvoV3c6i4aTCoc/9+9NVkFgh6BmZFaig08he3oxYkwBEkQGCzg7gfG6kzaDvuSyLfgIyqt1cF6SAspoS4iJf3c9xaf3JrGEgUzZcOGgvO4agzjTQUkI9V5z4851MuLhBvUUp1gR7tjXEHL+shXFZnduNIBomi6T73FVLLByQePu4N3CxMbVxyzfeQUTYZrdpA3yvoPVf/1jdTGggC6aXx0ieLSecFcWoj72vkhU4IcswU7gVORksb6FHnufbouJ4Xbv+gf1g0EADav9uSeO9YenpA3IfURFVZ0gqEms1rRg0qCzM4TuYy1T061jt0dXXpX0xJ96FMDXIqQXtJ3tSfze6OaY0KU1ogfTUgUJMK0lBIL06dS/F/LJeRe0k2kAAk7BgSWN2GVW/aCOjRuPCbBHVGBG6J3ECKIN3VlfjroguqA+RrMsFvCNqisf5mRox2qPlB4s8vuiMdIE/fVjVvLlRnhKlqYLig7QIpOiva40PAqR2E22neJFrN10AVgWMOIDgPuMOjmRFa+HVaR0fHliaugXoEOe80nBWrZg2dZkZoYffuaW5u1kCVkadmbT70AGdqJodWOhxHqP2eFg1UDvsLatnSFq41M+KKnp6eXbhsdB2OdGiCeX8+/2ecqgnmk/VXNYtqYLSAnNposzpjgw3+H/belpVa8J7TAAAAAElFTkSuQmCC";imgBack.style.position="absolute";imgBack.style.left="50%";imgBack.style.top="50%";imgBack.style.marginLeft="-60px";imgBack.style.marginTop="-60px";imgBack.style.animation="spin1 2s infinite ease-in-out";imgBack.style.webkitAnimation="spin1 2s infinite ease-in-out";imgBack.style.transformOrigin="50% 50%";imgBack.style.webkitTransformOrigin="50% 50%";this._loadingDiv.appendChild(imgBack);this._resizeLoadingUI();window.addEventListener("resize",this._resizeLoadingUI);this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor;document.body.appendChild(this._loadingDiv);this._loadingDiv.style.opacity="1"};DefaultLoadingScreen.prototype.hideLoadingUI=function(){var _this=this;if(!this._loadingDiv){return}var onTransitionEnd=function(){if(!_this._loadingDiv){return}document.body.removeChild(_this._loadingDiv);window.removeEventListener("resize",_this._resizeLoadingUI);_this._loadingDiv=null};this._loadingDiv.style.opacity="0";this._loadingDiv.addEventListener("transitionend",onTransitionEnd)};Object.defineProperty(DefaultLoadingScreen.prototype,"loadingUIText",{set:function(text){this._loadingText=text;if(this._loadingTextDiv){this._loadingTextDiv.innerHTML=this._loadingText}},enumerable:true,configurable:true});Object.defineProperty(DefaultLoadingScreen.prototype,"loadingUIBackgroundColor",{get:function(){return this._loadingDivBackgroundColor},set:function(color){this._loadingDivBackgroundColor=color;if(!this._loadingDiv){return}this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor},enumerable:true,configurable:true});return DefaultLoadingScreen}();BABYLON.DefaultLoadingScreen=DefaultLoadingScreen})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SceneLoader=function(){function SceneLoader(){}Object.defineProperty(SceneLoader,"NO_LOGGING",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(SceneLoader,"MINIMAL_LOGGING",{get:function(){return 1},enumerable:true,configurable:true});Object.defineProperty(SceneLoader,"SUMMARY_LOGGING",{get:function(){return 2},enumerable:true,configurable:true});Object.defineProperty(SceneLoader,"DETAILED_LOGGING",{get:function(){return 3},enumerable:true,configurable:true});Object.defineProperty(SceneLoader,"ForceFullSceneLoadingForIncremental",{get:function(){return SceneLoader._ForceFullSceneLoadingForIncremental},set:function(value){SceneLoader._ForceFullSceneLoadingForIncremental=value},enumerable:true,configurable:true});Object.defineProperty(SceneLoader,"ShowLoadingScreen",{get:function(){return SceneLoader._ShowLoadingScreen},set:function(value){SceneLoader._ShowLoadingScreen=value},enumerable:true,configurable:true});Object.defineProperty(SceneLoader,"loggingLevel",{get:function(){return SceneLoader._loggingLevel},set:function(value){SceneLoader._loggingLevel=value},enumerable:true,configurable:true});Object.defineProperty(SceneLoader,"CleanBoneMatrixWeights",{get:function(){return SceneLoader._CleanBoneMatrixWeights},set:function(value){SceneLoader._CleanBoneMatrixWeights=value},enumerable:true,configurable:true});SceneLoader._getDefaultPlugin=function(){return SceneLoader._registeredPlugins[".babylon"]};SceneLoader._getPluginForExtension=function(extension){var registeredPlugin=SceneLoader._registeredPlugins[extension];if(registeredPlugin){return registeredPlugin}return SceneLoader._getDefaultPlugin()};SceneLoader._getPluginForDirectLoad=function(data){for(var extension in SceneLoader._registeredPlugins){var plugin=SceneLoader._registeredPlugins[extension].plugin;if(plugin.canDirectLoad&&plugin.canDirectLoad(data)){return SceneLoader._registeredPlugins[extension]}}return SceneLoader._getDefaultPlugin()};SceneLoader._getPluginForFilename=function(sceneFilename){if(sceneFilename.name){sceneFilename=sceneFilename.name}var dotPosition=sceneFilename.lastIndexOf(".");var queryStringPosition=sceneFilename.indexOf("?");if(queryStringPosition===-1){queryStringPosition=sceneFilename.length}var extension=sceneFilename.substring(dotPosition,queryStringPosition).toLowerCase();return SceneLoader._getPluginForExtension(extension)};SceneLoader._getDirectLoad=function(sceneFilename){if(sceneFilename.substr&&sceneFilename.substr(0,5)==="data:"){return sceneFilename.substr(5)}return null};SceneLoader._loadData=function(rootUrl,sceneFilename,scene,onSuccess,onProgress,onError){var directLoad=SceneLoader._getDirectLoad(sceneFilename);var registeredPlugin=directLoad?SceneLoader._getPluginForDirectLoad(sceneFilename):SceneLoader._getPluginForFilename(sceneFilename);var plugin=registeredPlugin.plugin;var useArrayBuffer=registeredPlugin.isBinary;var database;SceneLoader.OnPluginActivatedObservable.notifyObservers(registeredPlugin.plugin);var dataCallback=function(data){if(scene.isDisposed){onError("Scene has been disposed");return}scene.database=database;try{onSuccess(plugin,data)}catch(e){onError(null,e)}};var manifestChecked=function(success){BABYLON.Tools.LoadFile(rootUrl+sceneFilename,dataCallback,onProgress,database,useArrayBuffer,function(request){onError(request.status+" "+request.statusText)})};if(directLoad){dataCallback(directLoad);return}if(rootUrl.indexOf("file:")===-1){if(scene.getEngine().enableOfflineSupport){database=new BABYLON.Database(rootUrl+sceneFilename,manifestChecked)}else{manifestChecked(true)}}else{var fileOrString=sceneFilename;if(fileOrString.name){BABYLON.Tools.ReadFile(fileOrString,dataCallback,onProgress,useArrayBuffer)}else if(BABYLON.FilesInput.FilesToLoad[sceneFilename]){BABYLON.Tools.ReadFile(BABYLON.FilesInput.FilesToLoad[sceneFilename],dataCallback,onProgress,useArrayBuffer)}else{onError("Unable to find file named "+sceneFilename);return}}};SceneLoader.GetPluginForExtension=function(extension){return SceneLoader._getPluginForExtension(extension).plugin};SceneLoader.RegisterPlugin=function(plugin){if(typeof plugin.extensions==="string"){var extension=plugin.extensions;SceneLoader._registeredPlugins[extension.toLowerCase()]={plugin:plugin,isBinary:false}}else{var extensions=plugin.extensions;Object.keys(extensions).forEach(function(extension){SceneLoader._registeredPlugins[extension.toLowerCase()]={plugin:plugin,isBinary:extensions[extension].isBinary}})}};SceneLoader.ImportMesh=function(meshNames,rootUrl,sceneFilename,scene,onSuccess,onProgress,onError){if(sceneFilename.substr&&sceneFilename.substr(0,1)==="/"){BABYLON.Tools.Error("Wrong sceneFilename parameter");return}var loadingToken={};scene._addPendingData(loadingToken);var errorHandler=function(message,exception){var errorMessage="Unable to import meshes from "+rootUrl+sceneFilename+(message?": "+message:"");if(onError){onError(scene,errorMessage,exception)}else{BABYLON.Tools.Error(errorMessage)}scene._removePendingData(loadingToken)};var progressHandler=function(event){if(onProgress){onProgress(event)}};SceneLoader._loadData(rootUrl,sceneFilename,scene,function(plugin,data){if(plugin.importMesh){var syncedPlugin=plugin;var meshes=new Array;var particleSystems=new Array;var skeletons=new Array;if(!syncedPlugin.importMesh(meshNames,scene,data,rootUrl,meshes,particleSystems,skeletons,errorHandler)){return}if(onSuccess){try{scene.importedMeshesFiles.push(rootUrl+sceneFilename);onSuccess(meshes,particleSystems,skeletons);scene._removePendingData(loadingToken)}catch(e){var message="Error in onSuccess callback.";errorHandler(message,e)}}}else{var asyncedPlugin=plugin;asyncedPlugin.importMeshAsync(meshNames,scene,data,rootUrl,function(meshes,particleSystems,skeletons){if(onSuccess){try{scene.importedMeshesFiles.push(rootUrl+sceneFilename);onSuccess(meshes,particleSystems,skeletons);scene._removePendingData(loadingToken)}catch(e){var message="Error in onSuccess callback.";errorHandler(message,e)}}},progressHandler,errorHandler)}},progressHandler,errorHandler)};SceneLoader.Load=function(rootUrl,sceneFilename,engine,onSuccess,onProgress,onError){SceneLoader.Append(rootUrl,sceneFilename,new BABYLON.Scene(engine),onSuccess,onProgress,onError)};SceneLoader.Append=function(rootUrl,sceneFilename,scene,onSuccess,onProgress,onError){if(sceneFilename.substr&&sceneFilename.substr(0,1)==="/"){BABYLON.Tools.Error("Wrong sceneFilename parameter");return}if(SceneLoader.ShowLoadingScreen){scene.getEngine().displayLoadingUI()}var loadingToken={};scene._addPendingData(loadingToken);var errorHandler=function(message,exception){var errorMessage="Unable to load from "+rootUrl+sceneFilename+(message?": "+message:"");if(onError){onError(scene,errorMessage,exception)}else{BABYLON.Tools.Error(errorMessage)}scene._removePendingData(loadingToken);scene.getEngine().hideLoadingUI()};var progressHandler=function(event){if(onProgress){onProgress(event)}};SceneLoader._loadData(rootUrl,sceneFilename,scene,function(plugin,data){if(plugin.load){var syncedPlugin=plugin;if(!syncedPlugin.load(scene,data,rootUrl,errorHandler)){return}if(onSuccess){try{onSuccess(scene)}catch(e){errorHandler("Error in onSuccess callback",e)}}scene.loadingPluginName=plugin.name;scene._removePendingData(loadingToken)}else{var asyncedPlugin=plugin;asyncedPlugin.loadAsync(scene,data,rootUrl,function(){if(onSuccess){onSuccess(scene)}scene.loadingPluginName=plugin.name;scene._removePendingData(loadingToken)},progressHandler,errorHandler)}if(SceneLoader.ShowLoadingScreen){scene.executeWhenReady(function(){scene.getEngine().hideLoadingUI()})}},progressHandler,errorHandler)};SceneLoader._ForceFullSceneLoadingForIncremental=false;SceneLoader._ShowLoadingScreen=true;SceneLoader._CleanBoneMatrixWeights=false;SceneLoader._loggingLevel=SceneLoader.NO_LOGGING;SceneLoader.OnPluginActivatedObservable=new BABYLON.Observable;SceneLoader._registeredPlugins={};return SceneLoader}();BABYLON.SceneLoader=SceneLoader})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var parseMaterialById=function(id,parsedData,scene,rootUrl){for(var index=0,cache=parsedData.materials.length;index<cache;index++){var parsedMaterial=parsedData.materials[index];if(parsedMaterial.id===id){return BABYLON.Material.Parse(parsedMaterial,scene,rootUrl)}}return null};var isDescendantOf=function(mesh,names,hierarchyIds){for(var i in names){if(mesh.name===names[i]){hierarchyIds.push(mesh.id);return true}}if(mesh.parentId&&hierarchyIds.indexOf(mesh.parentId)!==-1){hierarchyIds.push(mesh.id);return true}return false};var logOperation=function(operation,producer){return operation+" of "+(producer?producer.file+" from "+producer.name+" version: "+producer.version+", exporter version: "+producer.exporter_version:"unknown")};BABYLON.SceneLoader.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:function(data){if(data.indexOf("babylon")!==-1){return true}return false},importMesh:function(meshesNames,scene,data,rootUrl,meshes,particleSystems,skeletons,onError){var log="importMesh has failed JSON parse";try{var parsedData=JSON.parse(data);log="";var fullDetails=BABYLON.SceneLoader.loggingLevel===BABYLON.SceneLoader.DETAILED_LOGGING;if(!meshesNames){meshesNames=null}else if(!Array.isArray(meshesNames)){meshesNames=[meshesNames]}if(parsedData.meshes!==undefined&&parsedData.meshes!==null){var loadedSkeletonsIds=[];var loadedMaterialsIds=[];var hierarchyIds=new Array;var index;var cache;for(index=0,cache=parsedData.meshes.length;index<cache;index++){var parsedMesh=parsedData.meshes[index];if(meshesNames===null||isDescendantOf(parsedMesh,meshesNames,hierarchyIds)){if(meshesNames!==null){delete meshesNames[meshesNames.indexOf(parsedMesh.name)]}if(parsedMesh.geometryId!==undefined&&parsedMesh.geometryId!==null){if(parsedData.geometries!==undefined&&parsedData.geometries!==null){var found=false;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(function(geometryType){if(found===true||!parsedData.geometries[geometryType]||!Array.isArray(parsedData.geometries[geometryType])){return}else{parsedData.geometries[geometryType].forEach(function(parsedGeometryData){if(parsedGeometryData.id===parsedMesh.geometryId){switch(geometryType){case"boxes":BABYLON.Geometry.Primitives.Box.Parse(parsedGeometryData,scene);break;case"spheres":BABYLON.Geometry.Primitives.Sphere.Parse(parsedGeometryData,scene);break;case"cylinders":BABYLON.Geometry.Primitives.Cylinder.Parse(parsedGeometryData,scene);break;case"toruses":BABYLON.Geometry.Primitives.Torus.Parse(parsedGeometryData,scene);break;case"grounds":BABYLON.Geometry.Primitives.Ground.Parse(parsedGeometryData,scene);break;case"planes":BABYLON.Geometry.Primitives.Plane.Parse(parsedGeometryData,scene);break;case"torusKnots":BABYLON.Geometry.Primitives.TorusKnot.Parse(parsedGeometryData,scene);break;case"vertexData":BABYLON.Geometry.Parse(parsedGeometryData,scene,rootUrl);break}found=true}})}});if(found===false){BABYLON.Tools.Warn("Geometry not found for mesh "+parsedMesh.id)}}}if(parsedMesh.materialId){var materialFound=loadedMaterialsIds.indexOf(parsedMesh.materialId)!==-1;if(materialFound===false&&parsedData.multiMaterials!==undefined&&parsedData.multiMaterials!==null){for(var multimatIndex=0,multimatCache=parsedData.multiMaterials.length;multimatIndex<multimatCache;multimatIndex++){var parsedMultiMaterial=parsedData.multiMaterials[multimatIndex];if(parsedMultiMaterial.id===parsedMesh.materialId){for(var matIndex=0,matCache=parsedMultiMaterial.materials.length;matIndex<matCache;matIndex++){var subMatId=parsedMultiMaterial.materials[matIndex];loadedMaterialsIds.push(subMatId);var mat=parseMaterialById(subMatId,parsedData,scene,rootUrl);log+="\n\tMaterial "+mat.toString(fullDetails)}loadedMaterialsIds.push(parsedMultiMaterial.id);var mmat=BABYLON.Material.ParseMultiMaterial(parsedMultiMaterial,scene);materialFound=true;log+="\n\tMulti-Material "+mmat.toString(fullDetails);break}}}if(materialFound===false){loadedMaterialsIds.push(parsedMesh.materialId);var mat=parseMaterialById(parsedMesh.materialId,parsedData,scene,rootUrl);if(!mat){BABYLON.Tools.Warn("Material not found for mesh "+parsedMesh.id)}else{log+="\n\tMaterial "+mat.toString(fullDetails)}}}if(parsedMesh.skeletonId>-1&&parsedData.skeletons!==undefined&&parsedData.skeletons!==null){var skeletonAlreadyLoaded=loadedSkeletonsIds.indexOf(parsedMesh.skeletonId)>-1;if(skeletonAlreadyLoaded===false){for(var skeletonIndex=0,skeletonCache=parsedData.skeletons.length;skeletonIndex<skeletonCache;skeletonIndex++){var parsedSkeleton=parsedData.skeletons[skeletonIndex];if(parsedSkeleton.id===parsedMesh.skeletonId){var skeleton=BABYLON.Skeleton.Parse(parsedSkeleton,scene);skeletons.push(skeleton);loadedSkeletonsIds.push(parsedSkeleton.id);log+="\n\tSkeleton "+skeleton.toString(fullDetails)}}}}var mesh=BABYLON.Mesh.Parse(parsedMesh,scene,rootUrl);meshes.push(mesh);log+="\n\tMesh "+mesh.toString(fullDetails)}}var currentMesh;for(index=0,cache=scene.meshes.length;index<cache;index++){currentMesh=scene.meshes[index];if(currentMesh._waitingParentId){currentMesh.parent=scene.getLastEntryByID(currentMesh._waitingParentId);currentMesh._waitingParentId=undefined}}for(index=0,cache=scene.meshes.length;index<cache;index++){currentMesh=scene.meshes[index];if(currentMesh._waitingFreezeWorldMatrix){currentMesh.freezeWorldMatrix();currentMesh._waitingFreezeWorldMatrix=undefined}else{currentMesh.computeWorldMatrix(true)}}}if(parsedData.particleSystems!==undefined&&parsedData.particleSystems!==null){for(index=0,cache=parsedData.particleSystems.length;index<cache;index++){var parsedParticleSystem=parsedData.particleSystems[index];if(hierarchyIds.indexOf(parsedParticleSystem.emitterId)!==-1){particleSystems.push(BABYLON.ParticleSystem.Parse(parsedParticleSystem,scene,rootUrl))}}}return true}catch(err){var msg=logOperation("importMesh",parsedData?parsedData.producer:"Unknown")+log;if(onError){onError(msg,err)}else{BABYLON.Tools.Log(msg);log=null;throw err}}finally{if(log!==null&&BABYLON.SceneLoader.loggingLevel!==BABYLON.SceneLoader.NO_LOGGING){BABYLON.Tools.Log(logOperation("importMesh",parsedData?parsedData.producer:"Unknown")+(BABYLON.SceneLoader.loggingLevel!==BABYLON.SceneLoader.MINIMAL_LOGGING?log:""))}}return false},load:function(scene,data,rootUrl,onError){var log="importScene has failed JSON parse";try{var parsedData=JSON.parse(data);log="";var fullDetails=BABYLON.SceneLoader.loggingLevel===BABYLON.SceneLoader.DETAILED_LOGGING;if(parsedData.useDelayedTextureLoading!==undefined&&parsedData.useDelayedTextureLoading!==null){scene.useDelayedTextureLoading=parsedData.useDelayedTextureLoading&&!BABYLON.SceneLoader.ForceFullSceneLoadingForIncremental}if(parsedData.autoClear!==undefined&&parsedData.autoClear!==null){scene.autoClear=parsedData.autoClear}if(parsedData.clearColor!==undefined&&parsedData.clearColor!==null){scene.clearColor=BABYLON.Color4.FromArray(parsedData.clearColor)}if(parsedData.ambientColor!==undefined&&parsedData.ambientColor!==null){scene.ambientColor=BABYLON.Color3.FromArray(parsedData.ambientColor)}if(parsedData.gravity!==undefined&&parsedData.gravity!==null){scene.gravity=BABYLON.Vector3.FromArray(parsedData.gravity)}if(parsedData.fogMode&&parsedData.fogMode!==0){scene.fogMode=parsedData.fogMode;scene.fogColor=BABYLON.Color3.FromArray(parsedData.fogColor);scene.fogStart=parsedData.fogStart;scene.fogEnd=parsedData.fogEnd;scene.fogDensity=parsedData.fogDensity;log+="\tFog mode for scene:  ";switch(scene.fogMode){case 1:log+="exp\n";break;case 2:log+="exp2\n";break;case 3:log+="linear\n";break}}if(parsedData.physicsEnabled){var physicsPlugin;if(parsedData.physicsEngine==="cannon"){physicsPlugin=new BABYLON.CannonJSPlugin}else if(parsedData.physicsEngine==="oimo"){physicsPlugin=new BABYLON.OimoJSPlugin}log="\tPhysics engine "+(parsedData.physicsEngine?parsedData.physicsEngine:"oimo")+" enabled\n";var physicsGravity=parsedData.physicsGravity?BABYLON.Vector3.FromArray(parsedData.physicsGravity):null;scene.enablePhysics(physicsGravity,physicsPlugin)}if(parsedData.metadata!==undefined&&parsedData.metadata!==null){scene.metadata=parsedData.metadata}if(parsedData.collisionsEnabled!==undefined&&parsedData.collisionsEnabled!==null){scene.collisionsEnabled=parsedData.collisionsEnabled}scene.workerCollisions=!!parsedData.workerCollisions;var index;var cache;if(parsedData.lights!==undefined&&parsedData.lights!==null){for(index=0,cache=parsedData.lights.length;index<cache;index++){var parsedLight=parsedData.lights[index];var light=BABYLON.Light.Parse(parsedLight,scene);log+=index===0?"\n\tLights:":"";log+="\n\t\t"+light.toString(fullDetails)}}if(parsedData.animations!==undefined&&parsedData.animations!==null){for(index=0,cache=parsedData.animations.length;index<cache;index++){var parsedAnimation=parsedData.animations[index];var animation=BABYLON.Animation.Parse(parsedAnimation);scene.animations.push(animation);log+=index===0?"\n\tAnimations:":"";log+="\n\t\t"+animation.toString(fullDetails)}}if(parsedData.autoAnimate){scene.beginAnimation(scene,parsedData.autoAnimateFrom,parsedData.autoAnimateTo,parsedData.autoAnimateLoop,parsedData.autoAnimateSpeed||1)}if(parsedData.materials!==undefined&&parsedData.materials!==null){for(index=0,cache=parsedData.materials.length;index<cache;index++){var parsedMaterial=parsedData.materials[index];var mat=BABYLON.Material.Parse(parsedMaterial,scene,rootUrl);log+=index===0?"\n\tMaterials:":"";log+="\n\t\t"+mat.toString(fullDetails)}}if(parsedData.multiMaterials!==undefined&&parsedData.multiMaterials!==null){for(index=0,cache=parsedData.multiMaterials.length;index<cache;index++){var parsedMultiMaterial=parsedData.multiMaterials[index];var mmat=BABYLON.Material.ParseMultiMaterial(parsedMultiMaterial,scene);log+=index===0?"\n\tMultiMaterials:":"";log+="\n\t\t"+mmat.toString(fullDetails)}}if(parsedData.morphTargetManagers!==undefined&&parsedData.morphTargetManagers!==null){for(var _i=0,_a=parsedData.morphTargetManagers;_i<_a.length;_i++){var managerData=_a[_i];BABYLON.MorphTargetManager.Parse(managerData,scene)}}if(parsedData.skeletons!==undefined&&parsedData.skeletons!==null){for(index=0,cache=parsedData.skeletons.length;index<cache;index++){var parsedSkeleton=parsedData.skeletons[index];var skeleton=BABYLON.Skeleton.Parse(parsedSkeleton,scene);log+=index===0?"\n\tSkeletons:":"";log+="\n\t\t"+skeleton.toString(fullDetails)}}var geometries=parsedData.geometries;if(geometries!==undefined&&geometries!==null){var boxes=geometries.boxes;if(boxes!==undefined&&boxes!==null){for(index=0,cache=boxes.length;index<cache;index++){var parsedBox=boxes[index];BABYLON.Geometry.Primitives.Box.Parse(parsedBox,scene)}}var spheres=geometries.spheres;if(spheres!==undefined&&spheres!==null){for(index=0,cache=spheres.length;index<cache;index++){var parsedSphere=spheres[index];BABYLON.Geometry.Primitives.Sphere.Parse(parsedSphere,scene)}}var cylinders=geometries.cylinders;if(cylinders!==undefined&&cylinders!==null){for(index=0,cache=cylinders.length;index<cache;index++){var parsedCylinder=cylinders[index];BABYLON.Geometry.Primitives.Cylinder.Parse(parsedCylinder,scene)}}var toruses=geometries.toruses;if(toruses!==undefined&&toruses!==null){for(index=0,cache=toruses.length;index<cache;index++){var parsedTorus=toruses[index];BABYLON.Geometry.Primitives.Torus.Parse(parsedTorus,scene)}}var grounds=geometries.grounds;if(grounds!==undefined&&grounds!==null){for(index=0,cache=grounds.length;index<cache;index++){var parsedGround=grounds[index];BABYLON.Geometry.Primitives.Ground.Parse(parsedGround,scene)}}var planes=geometries.planes;if(planes!==undefined&&planes!==null){for(index=0,cache=planes.length;index<cache;index++){var parsedPlane=planes[index];BABYLON.Geometry.Primitives.Plane.Parse(parsedPlane,scene)}}var torusKnots=geometries.torusKnots;if(torusKnots!==undefined&&torusKnots!==null){for(index=0,cache=torusKnots.length;index<cache;index++){var parsedTorusKnot=torusKnots[index];BABYLON.Geometry.Primitives.TorusKnot.Parse(parsedTorusKnot,scene)}}var vertexData=geometries.vertexData;if(vertexData!==undefined&&vertexData!==null){for(index=0,cache=vertexData.length;index<cache;index++){var parsedVertexData=vertexData[index];BABYLON.Geometry.Parse(parsedVertexData,scene,rootUrl)}}}if(parsedData.meshes!==undefined&&parsedData.meshes!==null){for(index=0,cache=parsedData.meshes.length;index<cache;index++){var parsedMesh=parsedData.meshes[index];var mesh=BABYLON.Mesh.Parse(parsedMesh,scene,rootUrl);log+=index===0?"\n\tMeshes:":"";log+="\n\t\t"+mesh.toString(fullDetails)}}if(parsedData.cameras!==undefined&&parsedData.cameras!==null){for(index=0,cache=parsedData.cameras.length;index<cache;index++){var parsedCamera=parsedData.cameras[index];var camera=BABYLON.Camera.Parse(parsedCamera,scene);log+=index===0?"\n\tCameras:":"";log+="\n\t\t"+camera.toString(fullDetails)}}if(parsedData.activeCameraID!==undefined&&parsedData.activeCameraID!==null){scene.setActiveCameraByID(parsedData.activeCameraID)}for(index=0,cache=scene.cameras.length;index<cache;index++){var camera=scene.cameras[index];if(camera._waitingParentId){camera.parent=scene.getLastEntryByID(camera._waitingParentId);camera._waitingParentId=undefined}}for(index=0,cache=scene.lights.length;index<cache;index++){var light=scene.lights[index];if(light._waitingParentId){light.parent=scene.getLastEntryByID(light._waitingParentId);light._waitingParentId=undefined}}var loadedSounds=[];var loadedSound;if(BABYLON.AudioEngine&&parsedData.sounds!==undefined&&parsedData.sounds!==null){for(index=0,cache=parsedData.sounds.length;index<cache;index++){var parsedSound=parsedData.sounds[index];if(BABYLON.Engine.audioEngine.canUseWebAudio){if(!parsedSound.url)parsedSound.url=parsedSound.name;if(!loadedSounds[parsedSound.url]){loadedSound=BABYLON.Sound.Parse(parsedSound,scene,rootUrl);loadedSounds[parsedSound.url]=loadedSound}else{BABYLON.Sound.Parse(parsedSound,scene,rootUrl,loadedSounds[parsedSound.url])}}else{new BABYLON.Sound(parsedSound.name,null,scene)}}}loadedSounds=[];for(index=0,cache=scene.meshes.length;index<cache;index++){var mesh=scene.meshes[index];if(mesh._waitingParentId){mesh.parent=scene.getLastEntryByID(mesh._waitingParentId);mesh._waitingParentId=undefined}if(mesh._waitingActions){BABYLON.ActionManager.Parse(mesh._waitingActions,mesh,scene);mesh._waitingActions=undefined}}for(index=0,cache=scene.meshes.length;index<cache;index++){var currentMesh=scene.meshes[index];if(currentMesh._waitingFreezeWorldMatrix){currentMesh.freezeWorldMatrix();currentMesh._waitingFreezeWorldMatrix=undefined}else{currentMesh.computeWorldMatrix(true)}}if(parsedData.particleSystems!==undefined&&parsedData.particleSystems!==null){for(index=0,cache=parsedData.particleSystems.length;index<cache;index++){var parsedParticleSystem=parsedData.particleSystems[index];BABYLON.ParticleSystem.Parse(parsedParticleSystem,scene,rootUrl)}}if(parsedData.lensFlareSystems!==undefined&&parsedData.lensFlareSystems!==null){for(index=0,cache=parsedData.lensFlareSystems.length;index<cache;index++){var parsedLensFlareSystem=parsedData.lensFlareSystems[index];BABYLON.LensFlareSystem.Parse(parsedLensFlareSystem,scene,rootUrl)}}if(parsedData.shadowGenerators!==undefined&&parsedData.shadowGenerators!==null){for(index=0,cache=parsedData.shadowGenerators.length;index<cache;index++){var parsedShadowGenerator=parsedData.shadowGenerators[index];BABYLON.ShadowGenerator.Parse(parsedShadowGenerator,scene)}}for(index=0,cache=scene.lights.length;index<cache;index++){var light=scene.lights[index];if(light._excludedMeshesIds.length>0){for(var excludedIndex=0;excludedIndex<light._excludedMeshesIds.length;excludedIndex++){var excludedMesh=scene.getMeshByID(light._excludedMeshesIds[excludedIndex]);if(excludedMesh){light.excludedMeshes.push(excludedMesh)}}light._excludedMeshesIds=[]}if(light._includedOnlyMeshesIds.length>0){for(var includedOnlyIndex=0;includedOnlyIndex<light._includedOnlyMeshesIds.length;includedOnlyIndex++){var includedOnlyMesh=scene.getMeshByID(light._includedOnlyMeshesIds[includedOnlyIndex]);if(includedOnlyMesh){light.includedOnlyMeshes.push(includedOnlyMesh)}}light._includedOnlyMeshesIds=[]}}if(parsedData.actions!==undefined&&parsedData.actions!==null){BABYLON.ActionManager.Parse(parsedData.actions,null,scene)}return true}catch(err){var msg=logOperation("importScene",parsedData?parsedData.producer:"Unknown")+log;if(onError){onError(msg,err)}else{BABYLON.Tools.Log(msg);log=null;throw err}}finally{if(log!==null&&BABYLON.SceneLoader.loggingLevel!==BABYLON.SceneLoader.NO_LOGGING){BABYLON.Tools.Log(logOperation("importScene",parsedData?parsedData.producer:"Unknown")+(BABYLON.SceneLoader.loggingLevel!==BABYLON.SceneLoader.MINIMAL_LOGGING?log:""))}}return false}})})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FilesInput=function(){function FilesInput(engine,scene,sceneLoadedCallback,progressCallback,additionalRenderLoopLogicCallback,textureLoadingCallback,startingProcessingFilesCallback,onReloadCallback,errorCallback){this.onProcessFileCallback=function(){return true};this._engine=engine;this._currentScene=scene;this._sceneLoadedCallback=sceneLoadedCallback;this._progressCallback=progressCallback;this._additionalRenderLoopLogicCallback=additionalRenderLoopLogicCallback;this._textureLoadingCallback=textureLoadingCallback;this._startingProcessingFilesCallback=startingProcessingFilesCallback;this._onReloadCallback=onReloadCallback;this._errorCallback=errorCallback}FilesInput.prototype.monitorElementForDragNDrop=function(elementToMonitor){var _this=this;if(elementToMonitor){this._elementToMonitor=elementToMonitor;this._dragEnterHandler=function(e){_this.drag(e)};this._dragOverHandler=function(e){_this.drag(e)};this._dropHandler=function(e){_this.drop(e)};this._elementToMonitor.addEventListener("dragenter",this._dragEnterHandler,false);this._elementToMonitor.addEventListener("dragover",this._dragOverHandler,false);this._elementToMonitor.addEventListener("drop",this._dropHandler,false)}};FilesInput.prototype.dispose=function(){if(!this._elementToMonitor){return}this._elementToMonitor.removeEventListener("dragenter",this._dragEnterHandler);this._elementToMonitor.removeEventListener("dragover",this._dragOverHandler);this._elementToMonitor.removeEventListener("drop",this._dropHandler)};FilesInput.prototype.renderFunction=function(){if(this._additionalRenderLoopLogicCallback){this._additionalRenderLoopLogicCallback()}if(this._currentScene){if(this._textureLoadingCallback){var remaining=this._currentScene.getWaitingItemsCount();if(remaining>0){this._textureLoadingCallback(remaining)}}this._currentScene.render()}};FilesInput.prototype.drag=function(e){e.stopPropagation();e.preventDefault()};FilesInput.prototype.drop=function(eventDrop){eventDrop.stopPropagation();eventDrop.preventDefault();this.loadFiles(eventDrop)};FilesInput.prototype._traverseFolder=function(folder,files,remaining,callback){var _this=this;var reader=folder.createReader();var relativePath=folder.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,"$1/");reader.readEntries(function(entries){remaining.count+=entries.length;for(var _i=0,entries_1=entries;_i<entries_1.length;_i++){var entry=entries_1[_i];if(entry.isFile){entry.file(function(file){file.correctName=relativePath+file.name;files.push(file);if(--remaining.count===0){callback()}})}else if(entry.isDirectory){_this._traverseFolder(entry,files,remaining,callback)}}if(--remaining.count){callback()}})};FilesInput.prototype._processFiles=function(files){var skippedFiles=0;for(var i=0;i<files.length;i++){var name=files[i].correctName.toLowerCase();var extension=name.split(".").pop();if(!this.onProcessFileCallback(files[i],name,extension)){skippedFiles++;continue}if((extension==="babylon"||extension==="stl"||extension==="obj"||extension==="gltf"||extension==="glb")&&name.indexOf(".binary.babylon")===-1&&name.indexOf(".incremental.babylon")===-1){this._sceneFileToLoad=files[i]}else{FilesInput.FilesToLoad[name]=files[i]}}if(this._onReloadCallback){this._onReloadCallback(this._sceneFileToLoad)}else if(skippedFiles<files.length){this.reload()}};FilesInput.prototype.loadFiles=function(event){var _this=this;if(this._startingProcessingFilesCallback)this._startingProcessingFilesCallback();if(event&&event.dataTransfer&&event.dataTransfer.files){this._filesToLoad=event.dataTransfer.files}if(event&&event.target&&event.target.files){this._filesToLoad=event.target.files}if(this._filesToLoad&&this._filesToLoad.length>0){var files_1=new Array;var folders=[];var items=event.dataTransfer?event.dataTransfer.items:null;for(var i=0;i<this._filesToLoad.length;i++){var fileToLoad=this._filesToLoad[i];var name_1=fileToLoad.name.toLowerCase();var entry=void 0;fileToLoad.correctName=name_1;if(items){var item=items[i];if(item.getAsEntry){entry=item.getAsEntry()}else if(item.webkitGetAsEntry){entry=item.webkitGetAsEntry()}}if(!entry){files_1.push(fileToLoad)}else{if(entry.isDirectory){folders.push(entry)}else{files_1.push(fileToLoad)}}}if(folders.length===0){this._processFiles(files_1)}else{var remaining={count:folders.length};for(var _i=0,folders_1=folders;_i<folders_1.length;_i++){var folder=folders_1[_i];this._traverseFolder(folder,files_1,remaining,function(){_this._processFiles(files_1)})}}}};FilesInput.prototype.reload=function(){var _this=this;if(this._sceneFileToLoad){if(this._currentScene){if(BABYLON.Tools.errorsCount>0){BABYLON.Tools.ClearLogCache();BABYLON.Tools.Log("Babylon.js engine (v"+BABYLON.Engine.Version+") launched")}this._engine.stopRenderLoop();this._currentScene.dispose()}BABYLON.SceneLoader.Load("file:",this._sceneFileToLoad,this._engine,function(newScene){_this._currentScene=newScene;if(_this._sceneLoadedCallback){_this._sceneLoadedCallback(_this._sceneFileToLoad,_this._currentScene)}_this._currentScene.executeWhenReady(function(){_this._engine.runRenderLoop(function(){_this.renderFunction()})})},function(progress){if(_this._progressCallback){_this._progressCallback(progress)}},function(scene,message){_this._currentScene=scene;if(_this._errorCallback){_this._errorCallback(_this._sceneFileToLoad,_this._currentScene,message)}})}else{BABYLON.Tools.Error("Please provide a valid .babylon file.")}};FilesInput.FilesToLoad={};return FilesInput}();BABYLON.FilesInput=FilesInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var StringDictionary=function(){function StringDictionary(){this._count=0;this._data={}}StringDictionary.prototype.copyFrom=function(source){var _this=this;this.clear();source.forEach(function(t,v){return _this.add(t,v)})};StringDictionary.prototype.get=function(key){var val=this._data[key];if(val!==undefined){return val}return undefined};StringDictionary.prototype.getOrAddWithFactory=function(key,factory){var val=this.get(key);if(val!==undefined){return val}val=factory(key);if(val){this.add(key,val)}return val};StringDictionary.prototype.getOrAdd=function(key,val){var curVal=this.get(key);if(curVal!==undefined){return curVal}this.add(key,val);return val};StringDictionary.prototype.contains=function(key){return this._data[key]!==undefined};StringDictionary.prototype.add=function(key,value){if(this._data[key]!==undefined){return false}this._data[key]=value;++this._count;return true};StringDictionary.prototype.set=function(key,value){if(this._data[key]===undefined){return false}this._data[key]=value;return true};StringDictionary.prototype.getAndRemove=function(key){var val=this.get(key);if(val!==undefined){delete this._data[key];--this._count;return val}return null};StringDictionary.prototype.remove=function(key){if(this.contains(key)){delete this._data[key];--this._count;return true}return false};StringDictionary.prototype.clear=function(){this._data={};this._count=0};Object.defineProperty(StringDictionary.prototype,"count",{get:function(){return this._count},enumerable:true,configurable:true});StringDictionary.prototype.forEach=function(callback){for(var cur in this._data){var val=this._data[cur];callback(cur,val)}};StringDictionary.prototype.first=function(callback){for(var cur in this._data){var val=this._data[cur];var res=callback(cur,val);if(res){return res}}return null};return StringDictionary}();BABYLON.StringDictionary=StringDictionary})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Tags=function(){function Tags(){}Tags.EnableFor=function(obj){obj._tags=obj._tags||{};obj.hasTags=function(){return Tags.HasTags(obj)};obj.addTags=function(tagsString){return Tags.AddTagsTo(obj,tagsString)};obj.removeTags=function(tagsString){return Tags.RemoveTagsFrom(obj,tagsString)};obj.matchesTagsQuery=function(tagsQuery){return Tags.MatchesQuery(obj,tagsQuery)}};Tags.DisableFor=function(obj){delete obj._tags;delete obj.hasTags;delete obj.addTags;delete obj.removeTags;delete obj.matchesTagsQuery};Tags.HasTags=function(obj){if(!obj._tags){return false}return!BABYLON.Tools.IsEmpty(obj._tags)};Tags.GetTags=function(obj,asString){if(asString===void 0){asString=true}if(!obj._tags){return null}if(asString){var tagsArray=[];for(var tag in obj._tags){if(obj._tags.hasOwnProperty(tag)&&obj._tags[tag]===true){tagsArray.push(tag)}}return tagsArray.join(" ")}else{return obj._tags}};Tags.AddTagsTo=function(obj,tagsString){if(!tagsString){return}if(typeof tagsString!=="string"){return}var tags=tagsString.split(" ");tags.forEach(function(tag,index,array){Tags._AddTagTo(obj,tag)})};Tags._AddTagTo=function(obj,tag){tag=tag.trim();if(tag===""||tag==="true"||tag==="false"){return}if(tag.match(/[\s]/)||tag.match(/^([!]|([|]|[&]){2})/)){return}Tags.EnableFor(obj);obj._tags[tag]=true};Tags.RemoveTagsFrom=function(obj,tagsString){if(!Tags.HasTags(obj)){return}var tags=tagsString.split(" ");for(var t in tags){Tags._RemoveTagFrom(obj,tags[t])}};Tags._RemoveTagFrom=function(obj,tag){delete obj._tags[tag]};Tags.MatchesQuery=function(obj,tagsQuery){if(tagsQuery===undefined){return true}if(tagsQuery===""){return Tags.HasTags(obj)}return BABYLON.Internals.AndOrNotEvaluator.Eval(tagsQuery,function(r){return Tags.HasTags(obj)&&obj._tags[r]})};return Tags}();BABYLON.Tags=Tags})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var AndOrNotEvaluator=function(){function AndOrNotEvaluator(){}AndOrNotEvaluator.Eval=function(query,evaluateCallback){if(!query.match(/\([^\(\)]*\)/g)){query=AndOrNotEvaluator._HandleParenthesisContent(query,evaluateCallback)}else{query=query.replace(/\([^\(\)]*\)/g,function(r){r=r.slice(1,r.length-1);return AndOrNotEvaluator._HandleParenthesisContent(r,evaluateCallback)})}if(query==="true"){return true}if(query==="false"){return false}return AndOrNotEvaluator.Eval(query,evaluateCallback)};AndOrNotEvaluator._HandleParenthesisContent=function(parenthesisContent,evaluateCallback){evaluateCallback=evaluateCallback||function(r){return r==="true"?true:false};var result;var or=parenthesisContent.split("||");for(var i in or){if(or.hasOwnProperty(i)){var ori=AndOrNotEvaluator._SimplifyNegation(or[i].trim());var and=ori.split("&&");if(and.length>1){for(var j=0;j<and.length;++j){var andj=AndOrNotEvaluator._SimplifyNegation(and[j].trim());if(andj!=="true"&&andj!=="false"){if(andj[0]==="!"){result=!evaluateCallback(andj.substring(1))}else{result=evaluateCallback(andj)}}else{result=andj==="true"?true:false}if(!result){ori="false";break}}}if(result||ori==="true"){result=true;break}if(ori!=="true"&&ori!=="false"){if(ori[0]==="!"){result=!evaluateCallback(ori.substring(1))}else{result=evaluateCallback(ori)}}else{result=ori==="true"?true:false}}}return result?"true":"false"};AndOrNotEvaluator._SimplifyNegation=function(booleanString){booleanString=booleanString.replace(/^[\s!]+/,function(r){r=r.replace(/[\s]/g,function(){return""});return r.length%2?"!":""});booleanString=booleanString.trim();if(booleanString==="!true"){booleanString="false"}else if(booleanString==="!false"){booleanString="true"}return booleanString};return AndOrNotEvaluator}();Internals.AndOrNotEvaluator=AndOrNotEvaluator})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Database=function(){function Database(urlToScene,callbackManifestChecked){this.idbFactory=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;this.callbackManifestChecked=callbackManifestChecked;this.currentSceneUrl=Database.ReturnFullUrlLocation(urlToScene);this.db=null;this._enableSceneOffline=false;this._enableTexturesOffline=false;this.manifestVersionFound=0;this.mustUpdateRessources=false;this.hasReachedQuota=false;if(!Database.IDBStorageEnabled){this.callbackManifestChecked(true)}else{this.checkManifestFile()}}Object.defineProperty(Database.prototype,"enableSceneOffline",{get:function(){return this._enableSceneOffline},enumerable:true,configurable:true});Object.defineProperty(Database.prototype,"enableTexturesOffline",{get:function(){return this._enableTexturesOffline},enumerable:true,configurable:true});Database.prototype.checkManifestFile=function(){var _this=this;var noManifestFile=function(){_this._enableSceneOffline=false;_this._enableTexturesOffline=false;_this.callbackManifestChecked(false)};var timeStampUsed=false;var manifestURL=this.currentSceneUrl+".manifest";var xhr=new XMLHttpRequest;if(navigator.onLine){timeStampUsed=true;manifestURL=manifestURL+(manifestURL.match(/\?/)==null?"?":"&")+(new Date).getTime()}xhr.open("GET",manifestURL,true);xhr.addEventListener("load",function(){if(xhr.status===200||BABYLON.Tools.ValidateXHRData(xhr,1)){try{var manifestFile=JSON.parse(xhr.response);_this._enableSceneOffline=manifestFile.enableSceneOffline;_this._enableTexturesOffline=manifestFile.enableTexturesOffline;if(manifestFile.version&&!isNaN(parseInt(manifestFile.version))){_this.manifestVersionFound=manifestFile.version}if(_this.callbackManifestChecked){_this.callbackManifestChecked(true)}}catch(ex){noManifestFile()}}else{noManifestFile()}},false);xhr.addEventListener("error",function(event){if(timeStampUsed){timeStampUsed=false;var retryManifestURL=_this.currentSceneUrl+".manifest";xhr.open("GET",retryManifestURL,true);xhr.send()}else{noManifestFile()}},false);try{xhr.send()}catch(ex){BABYLON.Tools.Error("Error on XHR send request.");this.callbackManifestChecked(false)}};Database.prototype.openAsync=function(successCallback,errorCallback){var _this=this;function handleError(){that.isSupported=false;if(errorCallback)errorCallback()}var that=this;if(!this.idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline)){this.isSupported=false;if(errorCallback)errorCallback()}else{if(!this.db){this.hasReachedQuota=false;this.isSupported=true;var request=this.idbFactory.open("babylonjs",1);request.onerror=function(event){handleError()};request.onblocked=function(event){BABYLON.Tools.Error("IDB request blocked. Please reload the page.");handleError()};request.onsuccess=function(event){_this.db=request.result;successCallback()};request.onupgradeneeded=function(event){_this.db=event.target.result;try{_this.db.createObjectStore("scenes",{keyPath:"sceneUrl"});_this.db.createObjectStore("versions",{keyPath:"sceneUrl"});_this.db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(ex){BABYLON.Tools.Error("Error while creating object stores. Exception: "+ex.message);handleError()}}}else{if(successCallback)successCallback()}}};Database.prototype.loadImageFromDB=function(url,image){var _this=this;var completeURL=Database.ReturnFullUrlLocation(url);var saveAndLoadImage=function(){if(!_this.hasReachedQuota&&_this.db!==null){_this._saveImageIntoDBAsync(completeURL,image)}else{image.src=url}};if(!this.mustUpdateRessources){this._loadImageFromDBAsync(completeURL,image,saveAndLoadImage)}else{saveAndLoadImage()}};Database.prototype._loadImageFromDBAsync=function(url,image,notInDBCallback){if(this.isSupported&&this.db!==null){var texture;var transaction=this.db.transaction(["textures"]);transaction.onabort=function(event){image.src=url};transaction.oncomplete=function(event){var blobTextureURL;if(texture){var URL=window.URL||window.webkitURL;blobTextureURL=URL.createObjectURL(texture.data,{oneTimeOnly:true});image.onerror=function(){BABYLON.Tools.Error("Error loading image from blob URL: "+blobTextureURL+" switching back to web url: "+url);image.src=url};image.src=blobTextureURL}else{notInDBCallback()}};var getRequest=transaction.objectStore("textures").get(url);getRequest.onsuccess=function(event){texture=event.target.result};getRequest.onerror=function(event){BABYLON.Tools.Error("Error loading texture "+url+" from DB.");image.src=url}}else{BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");image.src=url}};Database.prototype._saveImageIntoDBAsync=function(url,image){var _this=this;if(this.isSupported){var generateBlobUrl=function(){var blobTextureURL;if(blob){var URL=window.URL||window.webkitURL;try{blobTextureURL=URL.createObjectURL(blob,{oneTimeOnly:true})}catch(ex){blobTextureURL=URL.createObjectURL(blob)}}image.src=blobTextureURL};if(Database.IsUASupportingBlobStorage){var xhr=new XMLHttpRequest,blob;xhr.open("GET",url,true);xhr.responseType="blob";xhr.addEventListener("load",function(){if(xhr.status===200){blob=xhr.response;var transaction=_this.db.transaction(["textures"],"readwrite");transaction.onabort=function(event){try{var error=event.srcElement["error"];if(error&&error.name==="QuotaExceededError"){_this.hasReachedQuota=true}}catch(ex){}generateBlobUrl()};transaction.oncomplete=function(event){generateBlobUrl()};var newTexture={textureUrl:url,data:blob};try{var addRequest=transaction.objectStore("textures").put(newTexture);addRequest.onsuccess=function(event){};addRequest.onerror=function(event){generateBlobUrl()}}catch(ex){if(ex.code===25){Database.IsUASupportingBlobStorage=false}image.src=url}}else{image.src=url}},false);xhr.addEventListener("error",function(event){BABYLON.Tools.Error("Error in XHR request in BABYLON.Database.");image.src=url},false);xhr.send()}else{image.src=url}}else{BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");image.src=url}};Database.prototype._checkVersionFromDB=function(url,versionLoaded){var _this=this;var updateVersion=function(){_this._saveVersionIntoDBAsync(url,versionLoaded)};this._loadVersionFromDBAsync(url,versionLoaded,updateVersion)};Database.prototype._loadVersionFromDBAsync=function(url,callback,updateInDBCallback){var _this=this;if(this.isSupported){var version;try{var transaction=this.db.transaction(["versions"]);transaction.oncomplete=function(event){if(version){if(_this.manifestVersionFound>version.data){_this.mustUpdateRessources=true;updateInDBCallback()}else{callback(version.data)}}else{_this.mustUpdateRessources=true;updateInDBCallback()}};transaction.onabort=function(event){callback(-1)};var getRequest=transaction.objectStore("versions").get(url);getRequest.onsuccess=function(event){version=event.target.result};getRequest.onerror=function(event){BABYLON.Tools.Error("Error loading version for scene "+url+" from DB.");callback(-1)}}catch(ex){BABYLON.Tools.Error("Error while accessing 'versions' object store (READ OP). Exception: "+ex.message);callback(-1)}}else{BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");callback(-1)}};Database.prototype._saveVersionIntoDBAsync=function(url,callback){var _this=this;if(this.isSupported&&!this.hasReachedQuota){try{var transaction=this.db.transaction(["versions"],"readwrite");transaction.onabort=function(event){try{var error=event.srcElement["error"];if(error&&error.name==="QuotaExceededError"){_this.hasReachedQuota=true}}catch(ex){}callback(-1)};transaction.oncomplete=function(event){callback(_this.manifestVersionFound)};var newVersion={sceneUrl:url,data:this.manifestVersionFound};var addRequest=transaction.objectStore("versions").put(newVersion);addRequest.onsuccess=function(event){};addRequest.onerror=function(event){BABYLON.Tools.Error("Error in DB add version request in BABYLON.Database.")}}catch(ex){BABYLON.Tools.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+ex.message);callback(-1)}}else{callback(-1)}};Database.prototype.loadFileFromDB=function(url,sceneLoaded,progressCallBack,errorCallback,useArrayBuffer){var _this=this;var completeUrl=Database.ReturnFullUrlLocation(url);var saveAndLoadFile=function(){_this._saveFileIntoDBAsync(completeUrl,sceneLoaded,progressCallBack)};this._checkVersionFromDB(completeUrl,function(version){if(version!==-1){if(!_this.mustUpdateRessources){_this._loadFileFromDBAsync(completeUrl,sceneLoaded,saveAndLoadFile,useArrayBuffer)}else{_this._saveFileIntoDBAsync(completeUrl,sceneLoaded,progressCallBack,useArrayBuffer)}}else{errorCallback()}})};Database.prototype._loadFileFromDBAsync=function(url,callback,notInDBCallback,useArrayBuffer){if(this.isSupported){var targetStore;if(url.indexOf(".babylon")!==-1){targetStore="scenes"}else{targetStore="textures"}var file;var transaction=this.db.transaction([targetStore]);transaction.oncomplete=function(event){if(file){callback(file.data)}else{notInDBCallback()}};transaction.onabort=function(event){notInDBCallback()};var getRequest=transaction.objectStore(targetStore).get(url);getRequest.onsuccess=function(event){file=event.target.result};getRequest.onerror=function(event){BABYLON.Tools.Error("Error loading file "+url+" from DB.");notInDBCallback()}}else{BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");callback()}};Database.prototype._saveFileIntoDBAsync=function(url,callback,progressCallback,useArrayBuffer){var _this=this;if(this.isSupported){var targetStore;if(url.indexOf(".babylon")!==-1){targetStore="scenes"}else{targetStore="textures"}var xhr=new XMLHttpRequest;var fileData;xhr.open("GET",url,true);if(useArrayBuffer){xhr.responseType="arraybuffer"}xhr.onprogress=progressCallback;xhr.addEventListener("load",function(){if(xhr.status===200||BABYLON.Tools.ValidateXHRData(xhr,!useArrayBuffer?1:6)){fileData=!useArrayBuffer?xhr.responseText:xhr.response;if(!_this.hasReachedQuota){var transaction=_this.db.transaction([targetStore],"readwrite");transaction.onabort=function(event){try{var error=event.srcElement["error"];if(error&&error.name==="QuotaExceededError"){_this.hasReachedQuota=true}}catch(ex){}callback(fileData)};transaction.oncomplete=function(event){callback(fileData)};var newFile;if(targetStore==="scenes"){newFile={sceneUrl:url,data:fileData,version:_this.manifestVersionFound}}else{newFile={textureUrl:url,data:fileData}}try{var addRequest=transaction.objectStore(targetStore).put(newFile);addRequest.onsuccess=function(event){};addRequest.onerror=function(event){BABYLON.Tools.Error("Error in DB add file request in BABYLON.Database.")}}catch(ex){callback(fileData)}}else{callback(fileData)}}else{callback()}},false);xhr.addEventListener("error",function(event){BABYLON.Tools.Error("error on XHR request.");callback()},false);xhr.send()}else{BABYLON.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");callback()}};Database.IsUASupportingBlobStorage=true;Database.IDBStorageEnabled=true;Database.parseURL=function(url){var a=document.createElement("a");a.href=url;var urlWithoutHash=url.substring(0,url.lastIndexOf("#"));var fileName=url.substring(urlWithoutHash.lastIndexOf("/")+1,url.length);var absLocation=url.substring(0,url.indexOf(fileName,0));return absLocation};Database.ReturnFullUrlLocation=function(url){if(url.indexOf("http:/")===-1&&url.indexOf("https:/")===-1){return Database.parseURL(window.location.href)+url}else{return url}};return Database}();BABYLON.Database=Database})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FresnelParameters=function(){function FresnelParameters(){this._isEnabled=true;this.leftColor=BABYLON.Color3.White();this.rightColor=BABYLON.Color3.Black();this.bias=0;this.power=1}Object.defineProperty(FresnelParameters.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(value){if(this._isEnabled===value){return}this._isEnabled=value;BABYLON.Engine.MarkAllMaterialsAsDirty(BABYLON.Material.FresnelDirtyFlag)},enumerable:true,configurable:true});FresnelParameters.prototype.clone=function(){var newFresnelParameters=new FresnelParameters;BABYLON.Tools.DeepCopy(this,newFresnelParameters);return newFresnelParameters};FresnelParameters.prototype.serialize=function(){var serializationObject={};serializationObject.isEnabled=this.isEnabled;serializationObject.leftColor=this.leftColor;serializationObject.rightColor=this.rightColor;serializationObject.bias=this.bias;serializationObject.power=this.power;return serializationObject};FresnelParameters.Parse=function(parsedFresnelParameters){var fresnelParameters=new FresnelParameters;fresnelParameters.isEnabled=parsedFresnelParameters.isEnabled;fresnelParameters.leftColor=BABYLON.Color3.FromArray(parsedFresnelParameters.leftColor);fresnelParameters.rightColor=BABYLON.Color3.FromArray(parsedFresnelParameters.rightColor);fresnelParameters.bias=parsedFresnelParameters.bias;fresnelParameters.power=parsedFresnelParameters.power||1;return fresnelParameters};return FresnelParameters}();BABYLON.FresnelParameters=FresnelParameters})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MultiMaterial=function(_super){__extends(MultiMaterial,_super);function MultiMaterial(name,scene){var _this=_super.call(this,name,scene,true)||this;scene.multiMaterials.push(_this);_this.subMaterials=new Array;_this.storeEffectOnSubMeshes=true;return _this}Object.defineProperty(MultiMaterial.prototype,"subMaterials",{get:function(){return this._subMaterials},set:function(value){this._subMaterials=value;this._hookArray(value)},enumerable:true,configurable:true});MultiMaterial.prototype._hookArray=function(array){var _this=this;var oldPush=array.push;array.push=function(){var items=[];for(var _i=0;_i<arguments.length;_i++){items[_i]=arguments[_i]}var result=oldPush.apply(array,items);_this._markAllSubMeshesAsTexturesDirty();return result};var oldSplice=array.splice;array.splice=function(index,deleteCount){var deleted=oldSplice.apply(array,[index,deleteCount]);_this._markAllSubMeshesAsTexturesDirty();return deleted}};MultiMaterial.prototype.getSubMaterial=function(index){if(index<0||index>=this.subMaterials.length){return this.getScene().defaultMaterial}return this.subMaterials[index]};MultiMaterial.prototype.getActiveTextures=function(){return(_a=_super.prototype.getActiveTextures.call(this)).concat.apply(_a,this.subMaterials.map(function(subMaterial){return subMaterial.getActiveTextures()}));var _a};MultiMaterial.prototype.getClassName=function(){return"MultiMaterial"};MultiMaterial.prototype.isReadyForSubMesh=function(mesh,subMesh,useInstances){for(var index=0;index<this.subMaterials.length;index++){var subMaterial=this.subMaterials[index];if(subMaterial){if(this.subMaterials[index].storeEffectOnSubMeshes){if(!this.subMaterials[index].isReadyForSubMesh(mesh,subMesh,useInstances)){return false}continue}if(!this.subMaterials[index].isReady(mesh)){return false}}}return true};MultiMaterial.prototype.clone=function(name,cloneChildren){var newMultiMaterial=new MultiMaterial(name,this.getScene());for(var index=0;index<this.subMaterials.length;index++){var subMaterial=null;if(cloneChildren){subMaterial=this.subMaterials[index].clone(name+"-"+this.subMaterials[index].name)}else{subMaterial=this.subMaterials[index]}newMultiMaterial.subMaterials.push(subMaterial)}return newMultiMaterial};MultiMaterial.prototype.serialize=function(){var serializationObject={};serializationObject.name=this.name;serializationObject.id=this.id;serializationObject.tags=BABYLON.Tags.GetTags(this);serializationObject.materials=[];for(var matIndex=0;matIndex<this.subMaterials.length;matIndex++){var subMat=this.subMaterials[matIndex];if(subMat){serializationObject.materials.push(subMat.id)}else{serializationObject.materials.push(null)}}return serializationObject};MultiMaterial.prototype.dispose=function(forceDisposeEffect,forceDisposeTextures){var scene=this.getScene();if(!scene){return}var index=scene.multiMaterials.indexOf(this);if(index>=0){scene.multiMaterials.splice(index,1)}_super.prototype.dispose.call(this,forceDisposeEffect,forceDisposeTextures)};return MultiMaterial}(BABYLON.Material);BABYLON.MultiMaterial=MultiMaterial})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FreeCameraTouchInput=function(){function FreeCameraTouchInput(){this._offsetX=null;this._offsetY=null;this._pointerCount=0;this._pointerPressed=new Array;this.touchAngularSensibility=2e5;this.touchMoveSensibility=250}FreeCameraTouchInput.prototype.attachControl=function(element,noPreventDefault){var _this=this;var previousPosition;if(this._pointerInput===undefined){this._onLostFocus=function(evt){_this._offsetX=null;_this._offsetY=null};this._pointerInput=function(p,s){var evt=p.event;if(evt.pointerType==="mouse"){return}if(p.type===BABYLON.PointerEventTypes.POINTERDOWN){if(!noPreventDefault){evt.preventDefault()}_this._pointerPressed.push(evt.pointerId);if(_this._pointerPressed.length!==1){return}previousPosition={x:evt.clientX,y:evt.clientY}}else if(p.type===BABYLON.PointerEventTypes.POINTERUP){if(!noPreventDefault){evt.preventDefault()}var index=_this._pointerPressed.indexOf(evt.pointerId);if(index===-1){return}_this._pointerPressed.splice(index,1);if(index!=0){return}previousPosition=null;_this._offsetX=null;_this._offsetY=null}else if(p.type===BABYLON.PointerEventTypes.POINTERMOVE){if(!noPreventDefault){evt.preventDefault()}if(!previousPosition){return}var index=_this._pointerPressed.indexOf(evt.pointerId);if(index!=0){return}_this._offsetX=evt.clientX-previousPosition.x;_this._offsetY=-(evt.clientY-previousPosition.y)}}}this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,BABYLON.PointerEventTypes.POINTERDOWN|BABYLON.PointerEventTypes.POINTERUP|BABYLON.PointerEventTypes.POINTERMOVE);element.addEventListener("blur",this._onLostFocus)};FreeCameraTouchInput.prototype.detachControl=function(element){if(this._pointerInput&&element){this.camera.getScene().onPointerObservable.remove(this._observer);this._observer=null;element.removeEventListener("blur",this._onLostFocus);this._onLostFocus=null;this._pointerPressed=[];this._offsetX=null;this._offsetY=null;this._pointerCount=0}};FreeCameraTouchInput.prototype.checkInputs=function(){if(this._offsetX){var camera=this.camera;camera.cameraRotation.y+=this._offsetX/this.touchAngularSensibility;if(this._pointerPressed.length>1){camera.cameraRotation.x+=-this._offsetY/this.touchAngularSensibility}else{var speed=camera._computeLocalCameraSpeed();var direction=new BABYLON.Vector3(0,0,speed*this._offsetY/this.touchMoveSensibility);BABYLON.Matrix.RotationYawPitchRollToRef(camera.rotation.y,camera.rotation.x,0,camera._cameraRotationMatrix);camera.cameraDirection.addInPlace(BABYLON.Vector3.TransformCoordinates(direction,camera._cameraRotationMatrix))}}};FreeCameraTouchInput.prototype.getClassName=function(){return"FreeCameraTouchInput"};FreeCameraTouchInput.prototype.getSimpleName=function(){return"touch"};__decorate([BABYLON.serialize()],FreeCameraTouchInput.prototype,"touchAngularSensibility",void 0);__decorate([BABYLON.serialize()],FreeCameraTouchInput.prototype,"touchMoveSensibility",void 0);return FreeCameraTouchInput}();BABYLON.FreeCameraTouchInput=FreeCameraTouchInput;BABYLON.CameraInputTypes["FreeCameraTouchInput"]=FreeCameraTouchInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var TouchCamera=function(_super){__extends(TouchCamera,_super);function TouchCamera(name,position,scene){var _this=_super.call(this,name,position,scene)||this;_this.inputs.addTouch();_this._setupInputs();return _this}Object.defineProperty(TouchCamera.prototype,"touchAngularSensibility",{get:function(){var touch=this.inputs.attached["touch"];if(touch)return touch.touchAngularSensibility;return null},set:function(value){var touch=this.inputs.attached["touch"];if(touch)touch.touchAngularSensibility=value},enumerable:true,configurable:true});Object.defineProperty(TouchCamera.prototype,"touchMoveSensibility",{get:function(){var touch=this.inputs.attached["touch"];if(touch)return touch.touchMoveSensibility;return null},set:function(value){var touch=this.inputs.attached["touch"];if(touch)touch.touchMoveSensibility=value},enumerable:true,configurable:true});TouchCamera.prototype.getClassName=function(){return"TouchCamera"};TouchCamera.prototype._setupInputs=function(){var mouse=this.inputs.attached["mouse"];if(mouse){mouse.touchEnabled=false}};return TouchCamera}(BABYLON.FreeCamera);BABYLON.TouchCamera=TouchCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ProceduralTexture=function(_super){__extends(ProceduralTexture,_super);function ProceduralTexture(name,size,fragment,scene,fallbackTexture,generateMipMaps,isCube){if(generateMipMaps===void 0){generateMipMaps=true}if(isCube===void 0){isCube=false}var _this=_super.call(this,null,scene,!generateMipMaps)||this;_this.isCube=isCube;_this.isEnabled=true;_this._currentRefreshId=-1;_this._refreshRate=1;_this._vertexBuffers={};_this._uniforms=new Array;_this._samplers=new Array;_this._textures={};_this._floats={};_this._floatsArrays={};_this._colors3={};_this._colors4={};_this._vectors2={};_this._vectors3={};_this._matrices={};_this._fallbackTextureUsed=false;scene._proceduralTextures.push(_this);_this.name=name;_this.isRenderTarget=true;_this._size=size;_this._generateMipMaps=generateMipMaps;_this.setFragment(fragment);_this._fallbackTexture=fallbackTexture;var engine=scene.getEngine();if(isCube){_this._texture=engine.createRenderTargetCubeTexture(size,{generateMipMaps:generateMipMaps});_this.setFloat("face",0)}else{_this._texture=engine.createRenderTargetTexture(size,generateMipMaps)}var vertices=[];vertices.push(1,1);vertices.push(-1,1);vertices.push(-1,-1);vertices.push(1,-1);_this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=new BABYLON.VertexBuffer(engine,vertices,BABYLON.VertexBuffer.PositionKind,false,false,2);_this._createIndexBuffer();return _this}ProceduralTexture.prototype._createIndexBuffer=function(){var engine=this.getScene().getEngine();var indices=[];indices.push(0);indices.push(1);indices.push(2);indices.push(0);indices.push(2);indices.push(3);this._indexBuffer=engine.createIndexBuffer(indices)};ProceduralTexture.prototype._rebuild=function(){this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]._rebuild();this._createIndexBuffer();if(this.refreshRate===BABYLON.RenderTargetTexture.REFRESHRATE_RENDER_ONCE){this.refreshRate=BABYLON.RenderTargetTexture.REFRESHRATE_RENDER_ONCE}};ProceduralTexture.prototype.reset=function(){if(this._effect===undefined){return}var engine=this.getScene().getEngine();engine._releaseEffect(this._effect)};ProceduralTexture.prototype.isReady=function(){var _this=this;var engine=this.getScene().getEngine();var shaders;if(!this._fragment){return false}if(this._fallbackTextureUsed){return true}if(this._fragment.fragmentElement!==undefined){shaders={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}}else{shaders={vertex:"procedural",fragment:this._fragment}}this._effect=engine.createEffect(shaders,[BABYLON.VertexBuffer.PositionKind],this._uniforms,this._samplers,"",null,null,function(){_this.releaseInternalTexture();if(_this._fallbackTexture){_this._texture=_this._fallbackTexture._texture;_this._texture.incrementReferences()}_this._fallbackTextureUsed=true});return this._effect.isReady()};ProceduralTexture.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1};ProceduralTexture.prototype.setFragment=function(fragment){this._fragment=fragment};Object.defineProperty(ProceduralTexture.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(value){this._refreshRate=value;this.resetRefreshCounter()},enumerable:true,configurable:true});ProceduralTexture.prototype._shouldRender=function(){if(!this.isEnabled||!this.isReady()||!this._texture){return false}if(this._fallbackTextureUsed){return false}if(this._currentRefreshId===-1){this._currentRefreshId=1;return true}if(this.refreshRate===this._currentRefreshId){this._currentRefreshId=1;return true}this._currentRefreshId++;return false};ProceduralTexture.prototype.getRenderSize=function(){return this._size};ProceduralTexture.prototype.resize=function(size,generateMipMaps){if(this._fallbackTextureUsed){return}this.releaseInternalTexture();this._texture=this.getScene().getEngine().createRenderTargetTexture(size,generateMipMaps)};ProceduralTexture.prototype._checkUniform=function(uniformName){if(this._uniforms.indexOf(uniformName)===-1){this._uniforms.push(uniformName)}};ProceduralTexture.prototype.setTexture=function(name,texture){if(this._samplers.indexOf(name)===-1){this._samplers.push(name)}this._textures[name]=texture;return this};ProceduralTexture.prototype.setFloat=function(name,value){this._checkUniform(name);this._floats[name]=value;return this};ProceduralTexture.prototype.setFloats=function(name,value){this._checkUniform(name);this._floatsArrays[name]=value;return this};ProceduralTexture.prototype.setColor3=function(name,value){this._checkUniform(name);this._colors3[name]=value;return this};ProceduralTexture.prototype.setColor4=function(name,value){this._checkUniform(name);this._colors4[name]=value;return this};ProceduralTexture.prototype.setVector2=function(name,value){this._checkUniform(name);this._vectors2[name]=value;return this};ProceduralTexture.prototype.setVector3=function(name,value){this._checkUniform(name);this._vectors3[name]=value;return this};ProceduralTexture.prototype.setMatrix=function(name,value){this._checkUniform(name);this._matrices[name]=value;return this};ProceduralTexture.prototype.render=function(useCameraPostProcess){var scene=this.getScene();var engine=scene.getEngine();engine.enableEffect(this._effect);engine.setState(false);for(var name in this._textures){this._effect.setTexture(name,this._textures[name])}for(name in this._floats){this._effect.setFloat(name,this._floats[name])}for(name in this._floatsArrays){this._effect.setArray(name,this._floatsArrays[name])}for(name in this._colors3){this._effect.setColor3(name,this._colors3[name])}for(name in this._colors4){var color=this._colors4[name];this._effect.setFloat4(name,color.r,color.g,color.b,color.a)}for(name in this._vectors2){this._effect.setVector2(name,this._vectors2[name])}for(name in this._vectors3){this._effect.setVector3(name,this._vectors3[name])}for(name in this._matrices){this._effect.setMatrix(name,this._matrices[name])}if(this.isCube){for(var face=0;face<6;face++){engine.bindFramebuffer(this._texture,face,undefined,undefined,true);engine.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);this._effect.setFloat("face",face);engine.clear(scene.clearColor,true,true,true);engine.draw(true,0,6);if(face===5){engine.generateMipMapsForCubemap(this._texture)}}}else{engine.bindFramebuffer(this._texture,0,undefined,undefined,true);engine.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);engine.clear(scene.clearColor,true,true,true);engine.draw(true,0,6)}engine.unBindFramebuffer(this._texture,this.isCube);if(this.onGenerated){this.onGenerated()}};ProceduralTexture.prototype.clone=function(){var textureSize=this.getSize();var newTexture=new ProceduralTexture(this.name,textureSize.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);newTexture.hasAlpha=this.hasAlpha;newTexture.level=this.level;newTexture.coordinatesMode=this.coordinatesMode;return newTexture};ProceduralTexture.prototype.dispose=function(){var index=this.getScene()._proceduralTextures.indexOf(this);if(index>=0){this.getScene()._proceduralTextures.splice(index,1)}var vertexBuffer=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind];if(vertexBuffer){vertexBuffer.dispose();this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=null}if(this._indexBuffer&&this.getScene().getEngine()._releaseBuffer(this._indexBuffer)){this._indexBuffer=null}_super.prototype.dispose.call(this)};return ProceduralTexture}(BABYLON.Texture);BABYLON.ProceduralTexture=ProceduralTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var CustomProceduralTexture=function(_super){__extends(CustomProceduralTexture,_super);function CustomProceduralTexture(name,texturePath,size,scene,fallbackTexture,generateMipMaps){var _this=_super.call(this,name,size,null,scene,fallbackTexture,generateMipMaps)||this;_this._animate=true;_this._time=0;_this._texturePath=texturePath;_this.loadJson(texturePath);_this.refreshRate=1;return _this}CustomProceduralTexture.prototype.loadJson=function(jsonUrl){var _this=this;var that=this;function noConfigFile(){BABYLON.Tools.Log("No config file found in "+jsonUrl+" trying to use ShadersStore or DOM element");try{that.setFragment(that._texturePath)}catch(ex){BABYLON.Tools.Error("No json or ShaderStore or DOM element found for CustomProceduralTexture")}}var configFileUrl=jsonUrl+"/config.json";var xhr=new XMLHttpRequest;xhr.open("GET",configFileUrl,true);xhr.addEventListener("load",function(){if(xhr.status===200||BABYLON.Tools.ValidateXHRData(xhr,1)){try{_this._config=JSON.parse(xhr.response);_this.updateShaderUniforms();_this.updateTextures();_this.setFragment(_this._texturePath+"/custom");_this._animate=_this._config.animate;_this.refreshRate=_this._config.refreshrate}catch(ex){noConfigFile()}}else{noConfigFile()}},false);xhr.addEventListener("error",function(){noConfigFile()},false);try{xhr.send()}catch(ex){BABYLON.Tools.Error("CustomProceduralTexture: Error on XHR send request.")}};CustomProceduralTexture.prototype.isReady=function(){if(!_super.prototype.isReady.call(this)){return false}for(var name in this._textures){var texture=this._textures[name];if(!texture.isReady()){return false}}return true};CustomProceduralTexture.prototype.render=function(useCameraPostProcess){if(this._animate){this._time+=this.getScene().getAnimationRatio()*.03;this.updateShaderUniforms()}_super.prototype.render.call(this,useCameraPostProcess)};CustomProceduralTexture.prototype.updateTextures=function(){for(var i=0;i<this._config.sampler2Ds.length;i++){this.setTexture(this._config.sampler2Ds[i].sample2Dname,new BABYLON.Texture(this._texturePath+"/"+this._config.sampler2Ds[i].textureRelativeUrl,this.getScene()))}};CustomProceduralTexture.prototype.updateShaderUniforms=function(){if(this._config){for(var j=0;j<this._config.uniforms.length;j++){var uniform=this._config.uniforms[j];switch(uniform.type){case"float":this.setFloat(uniform.name,uniform.value);break;case"color3":this.setColor3(uniform.name,new BABYLON.Color3(uniform.r,uniform.g,uniform.b));break;case"color4":this.setColor4(uniform.name,new BABYLON.Color4(uniform.r,uniform.g,uniform.b,uniform.a));break;case"vector2":this.setVector2(uniform.name,new BABYLON.Vector2(uniform.x,uniform.y));break;case"vector3":this.setVector3(uniform.name,new BABYLON.Vector3(uniform.x,uniform.y,uniform.z));break}}}this.setFloat("time",this._time)};Object.defineProperty(CustomProceduralTexture.prototype,"animate",{get:function(){return this._animate},set:function(value){this._animate=value},enumerable:true,configurable:true});return CustomProceduralTexture}(BABYLON.ProceduralTexture);BABYLON.CustomProceduralTexture=CustomProceduralTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FreeCameraGamepadInput=function(){function FreeCameraGamepadInput(){this.gamepadAngularSensibility=200;this.gamepadMoveSensibility=40;this._cameraTransform=BABYLON.Matrix.Identity();this._deltaTransform=BABYLON.Vector3.Zero();this._vector3=BABYLON.Vector3.Zero();this._vector2=BABYLON.Vector2.Zero()}FreeCameraGamepadInput.prototype.attachControl=function(element,noPreventDefault){var _this=this;var manager=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=manager.onGamepadConnectedObservable.add(function(gamepad){if(gamepad.type!==BABYLON.Gamepad.POSE_ENABLED){if(!_this.gamepad||gamepad.type===BABYLON.Gamepad.XBOX){_this.gamepad=gamepad}}});this._onGamepadDisconnectedObserver=manager.onGamepadDisconnectedObservable.add(function(gamepad){if(_this.gamepad===gamepad){_this.gamepad=null}});this.gamepad=manager.getGamepadByType(BABYLON.Gamepad.XBOX)};FreeCameraGamepadInput.prototype.detachControl=function(element){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver);this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver);this.gamepad=null};FreeCameraGamepadInput.prototype.checkInputs=function(){if(this.gamepad&&this.gamepad.leftStick){var camera=this.camera;var LSValues=this.gamepad.leftStick;var normalizedLX=LSValues.x/this.gamepadMoveSensibility;var normalizedLY=LSValues.y/this.gamepadMoveSensibility;LSValues.x=Math.abs(normalizedLX)>.005?0+normalizedLX:0;LSValues.y=Math.abs(normalizedLY)>.005?0+normalizedLY:0;var RSValues=this.gamepad.rightStick;if(RSValues){var normalizedRX=RSValues.x/this.gamepadAngularSensibility;var normalizedRY=RSValues.y/this.gamepadAngularSensibility;RSValues.x=Math.abs(normalizedRX)>.001?0+normalizedRX:0;RSValues.y=Math.abs(normalizedRY)>.001?0+normalizedRY:0}else{RSValues={x:0,y:0}}if(!camera.rotationQuaternion){BABYLON.Matrix.RotationYawPitchRollToRef(camera.rotation.y,camera.rotation.x,0,this._cameraTransform)}else{camera.rotationQuaternion.toRotationMatrix(this._cameraTransform)}var speed=camera._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(LSValues.x*speed,0,-LSValues.y*speed);BABYLON.Vector3.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform);camera.cameraDirection.addInPlace(this._deltaTransform);this._vector2.copyFromFloats(RSValues.y,RSValues.x);camera.cameraRotation.addInPlace(this._vector2)}};FreeCameraGamepadInput.prototype.getClassName=function(){return"FreeCameraGamepadInput"};FreeCameraGamepadInput.prototype.getSimpleName=function(){return"gamepad"};__decorate([BABYLON.serialize()],FreeCameraGamepadInput.prototype,"gamepadAngularSensibility",void 0);__decorate([BABYLON.serialize()],FreeCameraGamepadInput.prototype,"gamepadMoveSensibility",void 0);return FreeCameraGamepadInput}();BABYLON.FreeCameraGamepadInput=FreeCameraGamepadInput;BABYLON.CameraInputTypes["FreeCameraGamepadInput"]=FreeCameraGamepadInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ArcRotateCameraGamepadInput=function(){function ArcRotateCameraGamepadInput(){this.gamepadRotationSensibility=80;this.gamepadMoveSensibility=40}ArcRotateCameraGamepadInput.prototype.attachControl=function(element,noPreventDefault){var _this=this;var manager=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=manager.onGamepadConnectedObservable.add(function(gamepad){if(gamepad.type!==BABYLON.Gamepad.POSE_ENABLED){if(!_this.gamepad||gamepad.type===BABYLON.Gamepad.XBOX){_this.gamepad=gamepad}}});this._onGamepadDisconnectedObserver=manager.onGamepadDisconnectedObservable.add(function(gamepad){if(_this.gamepad===gamepad){_this.gamepad=null}});this.gamepad=manager.getGamepadByType(BABYLON.Gamepad.XBOX)};ArcRotateCameraGamepadInput.prototype.detachControl=function(element){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver);this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver);this.gamepad=null};ArcRotateCameraGamepadInput.prototype.checkInputs=function(){if(this.gamepad){var camera=this.camera;var RSValues=this.gamepad.rightStick;if(RSValues){if(RSValues.x!=0){var normalizedRX=RSValues.x/this.gamepadRotationSensibility;if(normalizedRX!=0&&Math.abs(normalizedRX)>.005){camera.inertialAlphaOffset+=normalizedRX}}if(RSValues.y!=0){var normalizedRY=RSValues.y/this.gamepadRotationSensibility;if(normalizedRY!=0&&Math.abs(normalizedRY)>.005){camera.inertialBetaOffset+=normalizedRY}}}var LSValues=this.gamepad.leftStick;if(LSValues&&LSValues.y!=0){var normalizedLY=LSValues.y/this.gamepadMoveSensibility;if(normalizedLY!=0&&Math.abs(normalizedLY)>.005){this.camera.inertialRadiusOffset-=normalizedLY}}}};ArcRotateCameraGamepadInput.prototype.getClassName=function(){return"ArcRotateCameraGamepadInput"};ArcRotateCameraGamepadInput.prototype.getSimpleName=function(){return"gamepad"};__decorate([BABYLON.serialize()],ArcRotateCameraGamepadInput.prototype,"gamepadRotationSensibility",void 0);__decorate([BABYLON.serialize()],ArcRotateCameraGamepadInput.prototype,"gamepadMoveSensibility",void 0);return ArcRotateCameraGamepadInput}();BABYLON.ArcRotateCameraGamepadInput=ArcRotateCameraGamepadInput;BABYLON.CameraInputTypes["ArcRotateCameraGamepadInput"]=ArcRotateCameraGamepadInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var GamepadManager=function(){function GamepadManager(){var _this=this;this._babylonGamepads=[];this._oneGamepadConnected=false;this._isMonitoring=false;this.onGamepadDisconnectedObservable=new BABYLON.Observable;if(!BABYLON.Tools.IsWindowObjectExist()){this._gamepadEventSupported=false}else{this._gamepadEventSupported="GamepadEvent"in window;this._gamepadSupport=navigator.getGamepads||navigator.webkitGetGamepads||navigator.msGetGamepads||navigator.webkitGamepads}this.onGamepadConnectedObservable=new BABYLON.Observable(function(observer){for(var i in _this._babylonGamepads){var gamepad=_this._babylonGamepads[i];if(gamepad&&gamepad._isConnected){_this.onGamepadConnectedObservable.notifyObserver(observer,gamepad)}}});this._onGamepadConnectedEvent=function(evt){var gamepad=evt.gamepad;if(gamepad.index in _this._babylonGamepads){if(_this._babylonGamepads[gamepad.index].isConnected){return}}var newGamepad;if(_this._babylonGamepads[gamepad.index]){newGamepad=_this._babylonGamepads[gamepad.index];newGamepad.browserGamepad=gamepad;newGamepad._isConnected=true}else{newGamepad=_this._addNewGamepad(gamepad)}_this.onGamepadConnectedObservable.notifyObservers(newGamepad);_this._startMonitoringGamepads()};this._onGamepadDisconnectedEvent=function(evt){var gamepad=evt.gamepad;for(var i in _this._babylonGamepads){if(_this._babylonGamepads[i].index===gamepad.index){var disconnectedGamepad=_this._babylonGamepads[i];disconnectedGamepad._isConnected=false;_this.onGamepadDisconnectedObservable.notifyObservers(disconnectedGamepad);break}}};if(this._gamepadSupport){this._updateGamepadObjects();if(this._babylonGamepads.length){this._startMonitoringGamepads()}if(this._gamepadEventSupported){window.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,false);window.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,false)}else{this._startMonitoringGamepads()}}}Object.defineProperty(GamepadManager.prototype,"gamepads",{get:function(){return this._babylonGamepads},enumerable:true,configurable:true});GamepadManager.prototype.getGamepadByType=function(type){if(type===void 0){type=BABYLON.Gamepad.XBOX}for(var _i=0,_a=this._babylonGamepads;_i<_a.length;_i++){var gamepad=_a[_i];if(gamepad&&gamepad.type===type){return gamepad}}return null};GamepadManager.prototype.dispose=function(){if(this._gamepadEventSupported){window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent);window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent);this._onGamepadConnectedEvent=null;this._onGamepadDisconnectedEvent=null}this._babylonGamepads.forEach(function(gamepad){gamepad.dispose()});this.onGamepadConnectedObservable.clear();this.onGamepadDisconnectedObservable.clear();this._oneGamepadConnected=false;this._stopMonitoringGamepads();this._babylonGamepads=[]};GamepadManager.prototype._addNewGamepad=function(gamepad){if(!this._oneGamepadConnected){this._oneGamepadConnected=true}var newGamepad;var xboxOne=gamepad.id.search("Xbox One")!==-1;if(xboxOne||gamepad.id.search("Xbox 360")!==-1||gamepad.id.search("xinput")!==-1){newGamepad=new BABYLON.Xbox360Pad(gamepad.id,gamepad.index,gamepad,xboxOne)}else if(gamepad.pose){newGamepad=BABYLON.PoseEnabledControllerHelper.InitiateController(gamepad)}else{newGamepad=new BABYLON.GenericPad(gamepad.id,gamepad.index,gamepad)}this._babylonGamepads[newGamepad.index]=newGamepad;return newGamepad};GamepadManager.prototype._startMonitoringGamepads=function(){if(!this._isMonitoring){this._isMonitoring=true;this._checkGamepadsStatus()}};GamepadManager.prototype._stopMonitoringGamepads=function(){this._isMonitoring=false};GamepadManager.prototype._checkGamepadsStatus=function(){var _this=this;this._updateGamepadObjects();for(var i in this._babylonGamepads){var gamepad=this._babylonGamepads[i];if(!gamepad||!gamepad.isConnected){continue}gamepad.update()}if(this._isMonitoring){BABYLON.Tools.QueueNewFrame(function(){_this._checkGamepadsStatus()})}};GamepadManager.prototype._updateGamepadObjects=function(){var gamepads=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(var i=0;i<gamepads.length;i++){if(gamepads[i]){if(!this._babylonGamepads[gamepads[i].index]){var newGamepad=this._addNewGamepad(gamepads[i]);this.onGamepadConnectedObservable.notifyObservers(newGamepad)}else{this._babylonGamepads[i].browserGamepad=gamepads[i];if(!this._babylonGamepads[i].isConnected){this._babylonGamepads[i]._isConnected=true;this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[i])}}}}};return GamepadManager}();BABYLON.GamepadManager=GamepadManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var StickValues=function(){function StickValues(x,y){this.x=x;this.y=y}return StickValues}();BABYLON.StickValues=StickValues;var Gamepad=function(){function Gamepad(id,index,browserGamepad,leftStickX,leftStickY,rightStickX,rightStickY){if(leftStickX===void 0){leftStickX=0}if(leftStickY===void 0){leftStickY=1}if(rightStickX===void 0){rightStickX=2}if(rightStickY===void 0){rightStickY=3}this.id=id;this.index=index;this.browserGamepad=browserGamepad;this._isConnected=true;this.type=Gamepad.GAMEPAD;this._leftStickAxisX=leftStickX;this._leftStickAxisY=leftStickY;this._rightStickAxisX=rightStickX;this._rightStickAxisY=rightStickY;if(this.browserGamepad.axes.length>=2){this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}}if(this.browserGamepad.axes.length>=4){this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]}}}Object.defineProperty(Gamepad.prototype,"isConnected",{get:function(){return this._isConnected},enumerable:true,configurable:true});Gamepad.prototype.onleftstickchanged=function(callback){this._onleftstickchanged=callback};Gamepad.prototype.onrightstickchanged=function(callback){this._onrightstickchanged=callback};Object.defineProperty(Gamepad.prototype,"leftStick",{get:function(){return this._leftStick},set:function(newValues){if(this._onleftstickchanged&&(this._leftStick.x!==newValues.x||this._leftStick.y!==newValues.y)){this._onleftstickchanged(newValues)}this._leftStick=newValues},enumerable:true,configurable:true});Object.defineProperty(Gamepad.prototype,"rightStick",{get:function(){return this._rightStick},set:function(newValues){if(this._onrightstickchanged&&(this._rightStick.x!==newValues.x||this._rightStick.y!==newValues.y)){this._onrightstickchanged(newValues)}this._rightStick=newValues},enumerable:true,configurable:true});Gamepad.prototype.update=function(){if(this._leftStick){this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}}if(this._rightStick){this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]}}};Gamepad.prototype.dispose=function(){};Gamepad.GAMEPAD=0;Gamepad.GENERIC=1;Gamepad.XBOX=2;Gamepad.POSE_ENABLED=3;return Gamepad}();BABYLON.Gamepad=Gamepad;var GenericPad=function(_super){__extends(GenericPad,_super);function GenericPad(id,index,browserGamepad){var _this=_super.call(this,id,index,browserGamepad)||this;_this.onButtonDownObservable=new BABYLON.Observable;_this.onButtonUpObservable=new BABYLON.Observable;_this.type=Gamepad.GENERIC;_this._buttons=new Array(browserGamepad.buttons.length);return _this}GenericPad.prototype.onbuttondown=function(callback){this._onbuttondown=callback};GenericPad.prototype.onbuttonup=function(callback){this._onbuttonup=callback};GenericPad.prototype._setButtonValue=function(newValue,currentValue,buttonIndex){if(newValue!==currentValue){if(newValue===1){if(this._onbuttondown){this._onbuttondown(buttonIndex)}this.onButtonDownObservable.notifyObservers(buttonIndex)}if(newValue===0){if(this._onbuttonup){this._onbuttonup(buttonIndex)}this.onButtonUpObservable.notifyObservers(buttonIndex)}}return newValue};GenericPad.prototype.update=function(){_super.prototype.update.call(this);for(var index=0;index<this._buttons.length;index++){this._buttons[index]=this._setButtonValue(this.browserGamepad.buttons[index].value,this._buttons[index],index)}};return GenericPad}(Gamepad);BABYLON.GenericPad=GenericPad})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Xbox360Button;(function(Xbox360Button){Xbox360Button[Xbox360Button["A"]=0]="A";Xbox360Button[Xbox360Button["B"]=1]="B";Xbox360Button[Xbox360Button["X"]=2]="X";Xbox360Button[Xbox360Button["Y"]=3]="Y";Xbox360Button[Xbox360Button["Start"]=4]="Start";Xbox360Button[Xbox360Button["Back"]=5]="Back";Xbox360Button[Xbox360Button["LB"]=6]="LB";Xbox360Button[Xbox360Button["RB"]=7]="RB";Xbox360Button[Xbox360Button["LeftStick"]=8]="LeftStick";Xbox360Button[Xbox360Button["RightStick"]=9]="RightStick"})(Xbox360Button=BABYLON.Xbox360Button||(BABYLON.Xbox360Button={}));var Xbox360Dpad;(function(Xbox360Dpad){Xbox360Dpad[Xbox360Dpad["Up"]=0]="Up";Xbox360Dpad[Xbox360Dpad["Down"]=1]="Down";Xbox360Dpad[Xbox360Dpad["Left"]=2]="Left";Xbox360Dpad[Xbox360Dpad["Right"]=3]="Right"})(Xbox360Dpad=BABYLON.Xbox360Dpad||(BABYLON.Xbox360Dpad={}));var Xbox360Pad=function(_super){__extends(Xbox360Pad,_super);function Xbox360Pad(id,index,gamepad,xboxOne){if(xboxOne===void 0){xboxOne=false}var _this=_super.call(this,id,index,gamepad,0,1,2,3)||this;_this._leftTrigger=0;_this._rightTrigger=0;_this.onButtonDownObservable=new BABYLON.Observable;_this.onButtonUpObservable=new BABYLON.Observable;_this.onPadDownObservable=new BABYLON.Observable;_this.onPadUpObservable=new BABYLON.Observable;_this._buttonA=0;_this._buttonB=0;_this._buttonX=0;_this._buttonY=0;_this._buttonBack=0;_this._buttonStart=0;_this._buttonLB=0;_this._buttonRB=0;_this._buttonLeftStick=0;_this._buttonRightStick=0;_this._dPadUp=0;_this._dPadDown=0;_this._dPadLeft=0;_this._dPadRight=0;_this._isXboxOnePad=false;_this.type=BABYLON.Gamepad.XBOX;_this._isXboxOnePad=xboxOne;return _this}Xbox360Pad.prototype.onlefttriggerchanged=function(callback){this._onlefttriggerchanged=callback};Xbox360Pad.prototype.onrighttriggerchanged=function(callback){this._onrighttriggerchanged=callback};Object.defineProperty(Xbox360Pad.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(newValue){if(this._onlefttriggerchanged&&this._leftTrigger!==newValue){this._onlefttriggerchanged(newValue)}this._leftTrigger=newValue},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(newValue){if(this._onrighttriggerchanged&&this._rightTrigger!==newValue){this._onrighttriggerchanged(newValue)}this._rightTrigger=newValue},enumerable:true,configurable:true});Xbox360Pad.prototype.onbuttondown=function(callback){this._onbuttondown=callback};Xbox360Pad.prototype.onbuttonup=function(callback){this._onbuttonup=callback};Xbox360Pad.prototype.ondpaddown=function(callback){this._ondpaddown=callback};Xbox360Pad.prototype.ondpadup=function(callback){this._ondpadup=callback};Xbox360Pad.prototype._setButtonValue=function(newValue,currentValue,buttonType){if(newValue!==currentValue){if(newValue===1){if(this._onbuttondown){this._onbuttondown(buttonType)}this.onButtonDownObservable.notifyObservers(buttonType)}if(newValue===0){if(this._onbuttonup){this._onbuttonup(buttonType)}this.onButtonUpObservable.notifyObservers(buttonType)}}return newValue};Xbox360Pad.prototype._setDPadValue=function(newValue,currentValue,buttonType){if(newValue!==currentValue){if(newValue===1){if(this._ondpaddown){this._ondpaddown(buttonType)}this.onPadDownObservable.notifyObservers(buttonType)}if(newValue===0){if(this._ondpadup){this._ondpadup(buttonType)}this.onPadUpObservable.notifyObservers(buttonType)}}return newValue};Object.defineProperty(Xbox360Pad.prototype,"buttonA",{get:function(){return this._buttonA},set:function(value){this._buttonA=this._setButtonValue(value,this._buttonA,Xbox360Button.A)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonB",{get:function(){return this._buttonB},set:function(value){this._buttonB=this._setButtonValue(value,this._buttonB,Xbox360Button.B)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonX",{get:function(){return this._buttonX},set:function(value){this._buttonX=this._setButtonValue(value,this._buttonX,Xbox360Button.X)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonY",{get:function(){return this._buttonY},set:function(value){this._buttonY=this._setButtonValue(value,this._buttonY,Xbox360Button.Y)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(value){this._buttonStart=this._setButtonValue(value,this._buttonStart,Xbox360Button.Start)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(value){this._buttonBack=this._setButtonValue(value,this._buttonBack,Xbox360Button.Back)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(value){this._buttonLB=this._setButtonValue(value,this._buttonLB,Xbox360Button.LB)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(value){this._buttonRB=this._setButtonValue(value,this._buttonRB,Xbox360Button.RB)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(value){this._buttonLeftStick=this._setButtonValue(value,this._buttonLeftStick,Xbox360Button.LeftStick)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(value){this._buttonRightStick=this._setButtonValue(value,this._buttonRightStick,Xbox360Button.RightStick)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(value){this._dPadUp=this._setDPadValue(value,this._dPadUp,Xbox360Dpad.Up)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(value){this._dPadDown=this._setDPadValue(value,this._dPadDown,Xbox360Dpad.Down)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(value){this._dPadLeft=this._setDPadValue(value,this._dPadLeft,Xbox360Dpad.Left)},enumerable:true,configurable:true});Object.defineProperty(Xbox360Pad.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(value){this._dPadRight=this._setDPadValue(value,this._dPadRight,Xbox360Dpad.Right)},enumerable:true,configurable:true});Xbox360Pad.prototype.update=function(){_super.prototype.update.call(this);if(this._isXboxOnePad){this.buttonA=this.browserGamepad.buttons[0].value;this.buttonB=this.browserGamepad.buttons[1].value;this.buttonX=this.browserGamepad.buttons[2].value;this.buttonY=this.browserGamepad.buttons[3].value;this.buttonLB=this.browserGamepad.buttons[4].value;this.buttonRB=this.browserGamepad.buttons[5].value;this.leftTrigger=this.browserGamepad.axes[2];this.rightTrigger=this.browserGamepad.axes[5];this.buttonBack=this.browserGamepad.buttons[9].value;this.buttonStart=this.browserGamepad.buttons[8].value;this.buttonLeftStick=this.browserGamepad.buttons[6].value;this.buttonRightStick=this.browserGamepad.buttons[7].value;this.dPadUp=this.browserGamepad.buttons[11].value;this.dPadDown=this.browserGamepad.buttons[12].value;this.dPadLeft=this.browserGamepad.buttons[13].value;this.dPadRight=this.browserGamepad.buttons[14].value}else{this.buttonA=this.browserGamepad.buttons[0].value;this.buttonB=this.browserGamepad.buttons[1].value;this.buttonX=this.browserGamepad.buttons[2].value;this.buttonY=this.browserGamepad.buttons[3].value;this.buttonLB=this.browserGamepad.buttons[4].value;this.buttonRB=this.browserGamepad.buttons[5].value;this.leftTrigger=this.browserGamepad.buttons[6].value;this.rightTrigger=this.browserGamepad.buttons[7].value;this.buttonBack=this.browserGamepad.buttons[8].value;this.buttonStart=this.browserGamepad.buttons[9].value;this.buttonLeftStick=this.browserGamepad.buttons[10].value;this.buttonRightStick=this.browserGamepad.buttons[11].value;this.dPadUp=this.browserGamepad.buttons[12].value;this.dPadDown=this.browserGamepad.buttons[13].value;this.dPadLeft=this.browserGamepad.buttons[14].value;this.dPadRight=this.browserGamepad.buttons[15].value}};return Xbox360Pad}(BABYLON.Gamepad);BABYLON.Xbox360Pad=Xbox360Pad})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PoseEnabledControllerType;(function(PoseEnabledControllerType){PoseEnabledControllerType[PoseEnabledControllerType["VIVE"]=0]="VIVE";PoseEnabledControllerType[PoseEnabledControllerType["OCULUS"]=1]="OCULUS";PoseEnabledControllerType[PoseEnabledControllerType["WINDOWS"]=2]="WINDOWS";PoseEnabledControllerType[PoseEnabledControllerType["GENERIC"]=3]="GENERIC"})(PoseEnabledControllerType=BABYLON.PoseEnabledControllerType||(BABYLON.PoseEnabledControllerType={}));var PoseEnabledControllerHelper=function(){function PoseEnabledControllerHelper(){}PoseEnabledControllerHelper.InitiateController=function(vrGamepad){if(vrGamepad.id.indexOf("Oculus Touch")!==-1){return new BABYLON.OculusTouchController(vrGamepad)}else if(vrGamepad.id.indexOf(BABYLON.WindowsMotionController.GAMEPAD_ID_PREFIX)===0){return new BABYLON.WindowsMotionController(vrGamepad)}else if(vrGamepad.id.toLowerCase().indexOf("openvr")!==-1){return new BABYLON.ViveController(vrGamepad)}else{return new BABYLON.GenericController(vrGamepad)}};return PoseEnabledControllerHelper}();BABYLON.PoseEnabledControllerHelper=PoseEnabledControllerHelper;var PoseEnabledController=function(_super){__extends(PoseEnabledController,_super);function PoseEnabledController(browserGamepad){var _this=_super.call(this,browserGamepad.id,browserGamepad.index,browserGamepad)||this;_this.deviceScaleFactor=1;_this._leftHandSystemQuaternion=new BABYLON.Quaternion;_this.type=BABYLON.Gamepad.POSE_ENABLED;_this.controllerType=PoseEnabledControllerType.GENERIC;_this.position=BABYLON.Vector3.Zero();_this.rotationQuaternion=new BABYLON.Quaternion;_this.devicePosition=BABYLON.Vector3.Zero();_this.deviceRotationQuaternion=new BABYLON.Quaternion;_this._calculatedPosition=BABYLON.Vector3.Zero();_this._calculatedRotation=new BABYLON.Quaternion;BABYLON.Quaternion.RotationYawPitchRollToRef(Math.PI,0,0,_this._leftHandSystemQuaternion);return _this}PoseEnabledController.prototype.update=function(){_super.prototype.update.call(this);var pose=this.browserGamepad.pose;this.updateFromDevice(pose);if(this._mesh){this._mesh.position.copyFrom(this._calculatedPosition);this._mesh.rotationQuaternion.copyFrom(this._calculatedRotation)}};PoseEnabledController.prototype.updateFromDevice=function(poseData){if(poseData){this.rawPose=poseData;if(poseData.position){this.devicePosition.copyFromFloats(poseData.position[0],poseData.position[1],-poseData.position[2]);if(this._mesh&&this._mesh.getScene().useRightHandedSystem){this.devicePosition.z*=-1}this.devicePosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition);this._calculatedPosition.addInPlace(this.position)}if(poseData.orientation){this.deviceRotationQuaternion.copyFromFloats(this.rawPose.orientation[0],this.rawPose.orientation[1],-this.rawPose.orientation[2],-this.rawPose.orientation[3]);if(this._mesh){if(this._mesh.getScene().useRightHandedSystem){this.deviceRotationQuaternion.z*=-1;this.deviceRotationQuaternion.w*=-1}else{this.deviceRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this.deviceRotationQuaternion)}}this.deviceRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation)}}};PoseEnabledController.prototype.attachToMesh=function(mesh){if(this._mesh){this._mesh.parent=undefined}this._mesh=mesh;if(this._poseControlledCamera){this._mesh.parent=this._poseControlledCamera}if(!this._mesh.rotationQuaternion){this._mesh.rotationQuaternion=new BABYLON.Quaternion}};PoseEnabledController.prototype.attachToPoseControlledCamera=function(camera){this._poseControlledCamera=camera;if(this._mesh){this._mesh.parent=this._poseControlledCamera}};PoseEnabledController.prototype.dispose=function(){if(this._mesh){this._mesh.dispose()}this._mesh=undefined;_super.prototype.dispose.call(this)};Object.defineProperty(PoseEnabledController.prototype,"mesh",{get:function(){return this._mesh},enumerable:true,configurable:true});PoseEnabledController.prototype.getForwardRay=function(length){if(length===void 0){length=100}if(!this.mesh){return new BABYLON.Ray(BABYLON.Vector3.Zero(),new BABYLON.Vector3(0,0,1),length)}var m=this.mesh.getWorldMatrix();var origin=m.getTranslation();var forward=new BABYLON.Vector3(0,0,-1);var forwardWorld=BABYLON.Vector3.TransformNormal(forward,m);var direction=BABYLON.Vector3.Normalize(forwardWorld);return new BABYLON.Ray(origin,direction,length)};return PoseEnabledController}(BABYLON.Gamepad);BABYLON.PoseEnabledController=PoseEnabledController})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var WebVRController=function(_super){__extends(WebVRController,_super);function WebVRController(vrGamepad){var _this=_super.call(this,vrGamepad)||this;_this.onTriggerStateChangedObservable=new BABYLON.Observable;_this.onMainButtonStateChangedObservable=new BABYLON.Observable;_this.onSecondaryButtonStateChangedObservable=new BABYLON.Observable;_this.onPadStateChangedObservable=new BABYLON.Observable;_this.onPadValuesChangedObservable=new BABYLON.Observable;_this.pad={x:0,y:0};_this._changes={pressChanged:false,touchChanged:false,valueChanged:false,changed:false};_this._buttons=new Array(vrGamepad.buttons.length);_this.hand=vrGamepad.hand;return _this}WebVRController.prototype.onButtonStateChange=function(callback){this._onButtonStateChange=callback};Object.defineProperty(WebVRController.prototype,"defaultModel",{get:function(){return this._defaultModel},enumerable:true,configurable:true});WebVRController.prototype.update=function(){_super.prototype.update.call(this);for(var index=0;index<this._buttons.length;index++){this._setButtonValue(this.browserGamepad.buttons[index],this._buttons[index],index)}if(this.leftStick.x!==this.pad.x||this.leftStick.y!==this.pad.y){this.pad.x=this.leftStick.x;this.pad.y=this.leftStick.y;this.onPadValuesChangedObservable.notifyObservers(this.pad)}};WebVRController.prototype._setButtonValue=function(newState,currentState,buttonIndex){if(!newState){newState={pressed:false,touched:false,value:0}}if(!currentState){this._buttons[buttonIndex]={pressed:newState.pressed,touched:newState.touched,value:newState.value};return}this._checkChanges(newState,currentState);if(this._changes.changed){this._onButtonStateChange&&this._onButtonStateChange(this.index,buttonIndex,newState);this.handleButtonChange(buttonIndex,newState,this._changes)}this._buttons[buttonIndex].pressed=newState.pressed;this._buttons[buttonIndex].touched=newState.touched;this._buttons[buttonIndex].value=newState.value<1e-8?0:newState.value};WebVRController.prototype._checkChanges=function(newState,currentState){this._changes.pressChanged=newState.pressed!==currentState.pressed;this._changes.touchChanged=newState.touched!==currentState.touched;this._changes.valueChanged=newState.value!==currentState.value;this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged;return this._changes};WebVRController.prototype.dispose=function(){_super.prototype.dispose.call(this);this.onTriggerStateChangedObservable.clear();this.onMainButtonStateChangedObservable.clear();this.onSecondaryButtonStateChangedObservable.clear();this.onPadStateChangedObservable.clear();this.onPadValuesChangedObservable.clear()};return WebVRController}(BABYLON.PoseEnabledController);BABYLON.WebVRController=WebVRController})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var OculusTouchController=function(_super){__extends(OculusTouchController,_super);function OculusTouchController(vrGamepad){var _this=_super.call(this,vrGamepad)||this;_this.onSecondaryTriggerStateChangedObservable=new BABYLON.Observable;_this.onThumbRestChangedObservable=new BABYLON.Observable;_this.controllerType=BABYLON.PoseEnabledControllerType.OCULUS;return _this}OculusTouchController.prototype.initControllerMesh=function(scene,meshLoaded){var _this=this;var meshName;if(this.hand==="left"){meshName=OculusTouchController.MODEL_LEFT_FILENAME}else{meshName=OculusTouchController.MODEL_RIGHT_FILENAME}BABYLON.SceneLoader.ImportMesh("",OculusTouchController.MODEL_BASE_URL,meshName,scene,function(newMeshes){_this._defaultModel=newMeshes[1];if(meshLoaded){meshLoaded(_this._defaultModel)}_this.attachToMesh(_this._defaultModel)})};Object.defineProperty(OculusTouchController.prototype,"onAButtonStateChangedObservable",{get:function(){if(this.hand==="right"){return this.onMainButtonStateChangedObservable}else{throw new Error("No A button on left hand")}},enumerable:true,configurable:true});Object.defineProperty(OculusTouchController.prototype,"onBButtonStateChangedObservable",{get:function(){if(this.hand==="right"){return this.onSecondaryButtonStateChangedObservable}else{throw new Error("No B button on left hand")}},enumerable:true,configurable:true});Object.defineProperty(OculusTouchController.prototype,"onXButtonStateChangedObservable",{get:function(){if(this.hand==="left"){return this.onMainButtonStateChangedObservable}else{throw new Error("No X button on right hand")}},enumerable:true,configurable:true});Object.defineProperty(OculusTouchController.prototype,"onYButtonStateChangedObservable",{get:function(){if(this.hand==="left"){return this.onSecondaryButtonStateChangedObservable}else{throw new Error("No Y button on right hand")}},enumerable:true,configurable:true});OculusTouchController.prototype.handleButtonChange=function(buttonIdx,state,changes){var notifyObject=state;var triggerDirection=this.hand==="right"?-1:1;switch(buttonIdx){case 0:this.onPadStateChangedObservable.notifyObservers(notifyObject);return;case 1:if(this._defaultModel){this._defaultModel.getChildren()[3].rotation.x=-notifyObject.value*.2;this._defaultModel.getChildren()[3].position.y=-notifyObject.value*.005;this._defaultModel.getChildren()[3].position.z=-notifyObject.value*.005}this.onTriggerStateChangedObservable.notifyObservers(notifyObject);return;case 2:if(this._defaultModel){this._defaultModel.getChildren()[4].position.x=triggerDirection*notifyObject.value*.0035}this.onSecondaryTriggerStateChangedObservable.notifyObservers(notifyObject);return;case 3:if(this._defaultModel){if(notifyObject.pressed){this._defaultModel.getChildren()[1].position.y=-.001}else{this._defaultModel.getChildren()[1].position.y=0}}this.onMainButtonStateChangedObservable.notifyObservers(notifyObject);return;case 4:if(this._defaultModel){if(notifyObject.pressed){this._defaultModel.getChildren()[2].position.y=-.001}else{this._defaultModel.getChildren()[2].position.y=0}}this.onSecondaryButtonStateChangedObservable.notifyObservers(notifyObject);return;case 5:this.onThumbRestChangedObservable.notifyObservers(notifyObject);return}};OculusTouchController.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/";OculusTouchController.MODEL_LEFT_FILENAME="left.babylon";OculusTouchController.MODEL_RIGHT_FILENAME="right.babylon";return OculusTouchController}(BABYLON.WebVRController);BABYLON.OculusTouchController=OculusTouchController})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ViveController=function(_super){__extends(ViveController,_super);function ViveController(vrGamepad){var _this=_super.call(this,vrGamepad)||this;_this.controllerType=BABYLON.PoseEnabledControllerType.VIVE;return _this}ViveController.prototype.initControllerMesh=function(scene,meshLoaded){var _this=this;BABYLON.SceneLoader.ImportMesh("",ViveController.MODEL_BASE_URL,ViveController.MODEL_FILENAME,scene,function(newMeshes){_this._defaultModel=newMeshes[1];if(meshLoaded){meshLoaded(_this._defaultModel)}_this.attachToMesh(_this._defaultModel)})};Object.defineProperty(ViveController.prototype,"onLeftButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(ViveController.prototype,"onRightButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(ViveController.prototype,"onMenuButtonStateChangedObservable",{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:true,configurable:true});ViveController.prototype.handleButtonChange=function(buttonIdx,state,changes){var notifyObject=state;switch(buttonIdx){case 0:this.onPadStateChangedObservable.notifyObservers(notifyObject);return;case 1:if(this._defaultModel){this._defaultModel.getChildren()[6].rotation.x=-notifyObject.value*.15}this.onTriggerStateChangedObservable.notifyObservers(notifyObject);return;case 2:this.onMainButtonStateChangedObservable.notifyObservers(notifyObject);return;case 3:if(this._defaultModel){if(notifyObject.pressed){this._defaultModel.getChildren()[2].position.y=-.001}else{this._defaultModel.getChildren()[2].position.y=0}}this.onSecondaryButtonStateChangedObservable.notifyObservers(notifyObject);return}};ViveController.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/";ViveController.MODEL_FILENAME="wand.babylon";return ViveController}(BABYLON.WebVRController);BABYLON.ViveController=ViveController})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var GenericController=function(_super){__extends(GenericController,_super);function GenericController(vrGamepad){return _super.call(this,vrGamepad)||this}GenericController.prototype.initControllerMesh=function(scene,meshLoaded){var _this=this;BABYLON.SceneLoader.ImportMesh("",GenericController.MODEL_BASE_URL,GenericController.MODEL_FILENAME,scene,function(newMeshes){_this._defaultModel=newMeshes[1];if(meshLoaded){meshLoaded(_this._defaultModel)}_this.attachToMesh(_this._defaultModel)})};GenericController.prototype.handleButtonChange=function(buttonIdx,state,changes){console.log("Button id: "+buttonIdx+"state: ");console.dir(state)};GenericController.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";GenericController.MODEL_FILENAME="generic.babylon";return GenericController}(BABYLON.WebVRController);BABYLON.GenericController=GenericController})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var LoadedMeshInfo=function(){function LoadedMeshInfo(){this.buttonMeshes={};this.axisMeshes={}}return LoadedMeshInfo}();var WindowsMotionController=function(_super){__extends(WindowsMotionController,_super);function WindowsMotionController(vrGamepad){var _this=_super.call(this,vrGamepad)||this;_this._mapping={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:"POINTING_POSE"};_this.onTrackpadChangedObservable=new BABYLON.Observable;_this.controllerType=BABYLON.PoseEnabledControllerType.WINDOWS;_this._loadedMeshInfo=null;return _this}Object.defineProperty(WindowsMotionController.prototype,"onTriggerButtonStateChangedObservable",{get:function(){return this.onTriggerStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(WindowsMotionController.prototype,"onMenuButtonStateChangedObservable",{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(WindowsMotionController.prototype,"onGripButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(WindowsMotionController.prototype,"onThumbstickButtonStateChangedObservable",{get:function(){return this.onPadStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(WindowsMotionController.prototype,"onTouchpadButtonStateChangedObservable",{get:function(){return this.onTrackpadChangedObservable},enumerable:true,configurable:true});WindowsMotionController.prototype.update=function(){_super.prototype.update.call(this);if(this._loadedMeshInfo){if(this.browserGamepad.axes){for(var axis=0;axis<this._mapping.axisMeshNames.length;axis++){this.lerpAxisTransform(axis,this.browserGamepad.axes[axis])}}}};WindowsMotionController.prototype.handleButtonChange=function(buttonIdx,state,changes){var buttonName=this._mapping.buttons[buttonIdx];if(!buttonName){return}var observable=this[this._mapping.buttonObservableNames[buttonName]];if(observable){observable.notifyObservers(state)}this.lerpButtonTransform(buttonName,state.value)};WindowsMotionController.prototype.lerpButtonTransform=function(buttonName,buttonValue){if(!this._loadedMeshInfo){return}var meshInfo=this._loadedMeshInfo.buttonMeshes[buttonName];BABYLON.Quaternion.SlerpToRef(meshInfo.unpressed.rotationQuaternion,meshInfo.pressed.rotationQuaternion,buttonValue,meshInfo.value.rotationQuaternion);BABYLON.Vector3.LerpToRef(meshInfo.unpressed.position,meshInfo.pressed.position,buttonValue,meshInfo.value.position)};WindowsMotionController.prototype.lerpAxisTransform=function(axis,axisValue){var meshInfo=this._loadedMeshInfo.axisMeshes[axis];if(!meshInfo){return}var lerpValue=axisValue*.5+.5;BABYLON.Quaternion.SlerpToRef(meshInfo.min.rotationQuaternion,meshInfo.max.rotationQuaternion,lerpValue,meshInfo.value.rotationQuaternion);BABYLON.Vector3.LerpToRef(meshInfo.min.position,meshInfo.max.position,lerpValue,meshInfo.value.position)};WindowsMotionController.prototype.initControllerMesh=function(scene,meshLoaded,forceDefault){var _this=this;if(forceDefault===void 0){forceDefault=false}var path;var filename;if(BABYLON.SceneLoader.GetPluginForExtension("glb")){var device="default";if(this.id&&!forceDefault){var match=this.id.match(WindowsMotionController.GAMEPAD_ID_PATTERN);device=match&&match[0]||device}if(this.hand==="left"){filename=WindowsMotionController.MODEL_LEFT_FILENAME}else{filename=WindowsMotionController.MODEL_RIGHT_FILENAME}path=WindowsMotionController.MODEL_BASE_URL+device+"/"}else{BABYLON.Tools.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models");path=BABYLON.GenericController.MODEL_BASE_URL;filename=BABYLON.GenericController.MODEL_FILENAME}BABYLON.SceneLoader.ImportMesh("",path,filename,scene,function(meshes){_this._loadedMeshInfo=_this.processModel(scene,meshes);if(!_this._loadedMeshInfo){return}_this._defaultModel=_this._loadedMeshInfo.rootNode;_this.attachToMesh(_this._defaultModel);if(meshLoaded){meshLoaded(_this._defaultModel)}},null,function(scene,message){BABYLON.Tools.Log(message);BABYLON.Tools.Warn("Failed to retrieve controller model from the remote server: "+path+filename);if(!forceDefault){_this.initControllerMesh(scene,meshLoaded,true)}})};WindowsMotionController.prototype.processModel=function(scene,meshes){var loadedMeshInfo=null;var parentMesh=new BABYLON.Mesh(this.id+" "+this.hand,scene);var childMesh=null;for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(!mesh.parent){mesh.isPickable=false;childMesh=mesh;break}}if(childMesh){childMesh.setParent(parentMesh);loadedMeshInfo=this.createMeshInfo(parentMesh)}else{BABYLON.Tools.Warn("Could not find root node in model file.")}return loadedMeshInfo};WindowsMotionController.prototype.createMeshInfo=function(rootNode){var loadedMeshInfo=new LoadedMeshInfo;var i;loadedMeshInfo.rootNode=rootNode;loadedMeshInfo.buttonMeshes={};loadedMeshInfo.axisMeshes={};for(i=0;i<this._mapping.buttons.length;i++){var buttonMeshName=this._mapping.buttonMeshNames[this._mapping.buttons[i]];if(!buttonMeshName){BABYLON.Tools.Log("Skipping unknown button at index: "+i+" with mapped name: "+this._mapping.buttons[i]);continue}var buttonMesh=getChildByName(rootNode,buttonMeshName);if(!buttonMesh){BABYLON.Tools.Warn("Missing button mesh with name: "+buttonMeshName);continue}var buttonMeshInfo={index:i,value:getImmediateChildByName(buttonMesh,"VALUE"),pressed:getImmediateChildByName(buttonMesh,"PRESSED"),unpressed:getImmediateChildByName(buttonMesh,"UNPRESSED")};if(buttonMeshInfo.value&&buttonMeshInfo.pressed&&buttonMeshInfo.unpressed){loadedMeshInfo.buttonMeshes[this._mapping.buttons[i]]=buttonMeshInfo}else{BABYLON.Tools.Warn("Missing button submesh under mesh with name: "+buttonMeshName+"(VALUE: "+!!buttonMeshInfo.value+", PRESSED: "+!!buttonMeshInfo.pressed+", UNPRESSED:"+!!buttonMeshInfo.unpressed+")")}}for(i=0;i<this._mapping.axisMeshNames.length;i++){var axisMeshName=this._mapping.axisMeshNames[i];if(!axisMeshName){BABYLON.Tools.Log("Skipping unknown axis at index: "+i);continue}var axisMesh=getChildByName(rootNode,axisMeshName);if(!axisMesh){BABYLON.Tools.Warn("Missing axis mesh with name: "+axisMeshName);continue}var axisMeshInfo={index:i,value:getImmediateChildByName(axisMesh,"VALUE"),min:getImmediateChildByName(axisMesh,"MIN"),max:getImmediateChildByName(axisMesh,"MAX")};if(axisMeshInfo.value&&axisMeshInfo.min&&axisMeshInfo.max){loadedMeshInfo.axisMeshes[i]=axisMeshInfo}else{BABYLON.Tools.Warn("Missing axis submesh under mesh with name: "+axisMeshName+"(VALUE: "+!!axisMeshInfo.value+", MIN: "+!!axisMeshInfo.min+", MAX:"+!!axisMeshInfo.max+")")}}loadedMeshInfo.pointingPoseNode=getChildByName(rootNode,this._mapping.pointingPoseMeshName);if(!loadedMeshInfo.pointingPoseNode){BABYLON.Tools.Warn("Missing pointing pose mesh with name: "+this._mapping.pointingPoseMeshName)}return loadedMeshInfo;function getChildByName(node,name){return node.getChildMeshes(false,function(n){return n.name===name})[0]}function getImmediateChildByName(node,name){return node.getChildMeshes(true,function(n){return n.name==name})[0]}};WindowsMotionController.prototype.getForwardRay=function(length){if(length===void 0){length=100}if(!(this._loadedMeshInfo&&this._loadedMeshInfo.pointingPoseNode)){return _super.prototype.getForwardRay.call(this,length)}var m=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix();var origin=m.getTranslation();var forward=new BABYLON.Vector3(0,0,-1);var forwardWorld=BABYLON.Vector3.TransformNormal(forward,m);var direction=BABYLON.Vector3.Normalize(forwardWorld);return new BABYLON.Ray(origin,direction,length)};WindowsMotionController.prototype.dispose=function(){_super.prototype.dispose.call(this);this.onTrackpadChangedObservable.clear()};WindowsMotionController.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/";WindowsMotionController.MODEL_LEFT_FILENAME="left.glb";WindowsMotionController.MODEL_RIGHT_FILENAME="right.glb";WindowsMotionController.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ";WindowsMotionController.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/;return WindowsMotionController}(BABYLON.WebVRController);BABYLON.WindowsMotionController=WindowsMotionController})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FollowCamera=function(_super){__extends(FollowCamera,_super);function FollowCamera(name,position,scene,lockedTarget){var _this=_super.call(this,name,position,scene)||this;_this.radius=12;_this.rotationOffset=0;_this.heightOffset=4;_this.cameraAcceleration=.05;_this.maxCameraSpeed=20;_this.lockedTarget=lockedTarget;return _this}FollowCamera.prototype.getRadians=function(degrees){return degrees*Math.PI/180};FollowCamera.prototype.follow=function(cameraTarget){if(!cameraTarget)return;var yRotation;if(cameraTarget.rotationQuaternion){var rotMatrix=new BABYLON.Matrix;cameraTarget.rotationQuaternion.toRotationMatrix(rotMatrix);yRotation=Math.atan2(rotMatrix.m[8],rotMatrix.m[10])}else{yRotation=cameraTarget.rotation.y}var radians=this.getRadians(this.rotationOffset)+yRotation;var targetPosition=cameraTarget.getAbsolutePosition();var targetX=targetPosition.x+Math.sin(radians)*this.radius;var targetZ=targetPosition.z+Math.cos(radians)*this.radius;var dx=targetX-this.position.x;var dy=targetPosition.y+this.heightOffset-this.position.y;var dz=targetZ-this.position.z;var vx=dx*this.cameraAcceleration*2;var vy=dy*this.cameraAcceleration;var vz=dz*this.cameraAcceleration*2;if(vx>this.maxCameraSpeed||vx<-this.maxCameraSpeed){vx=vx<1?-this.maxCameraSpeed:this.maxCameraSpeed}if(vy>this.maxCameraSpeed||vy<-this.maxCameraSpeed){vy=vy<1?-this.maxCameraSpeed:this.maxCameraSpeed}if(vz>this.maxCameraSpeed||vz<-this.maxCameraSpeed){vz=vz<1?-this.maxCameraSpeed:this.maxCameraSpeed}this.position=new BABYLON.Vector3(this.position.x+vx,this.position.y+vy,this.position.z+vz);this.setTarget(targetPosition)};FollowCamera.prototype._checkInputs=function(){_super.prototype._checkInputs.call(this);this.follow(this.lockedTarget)};FollowCamera.prototype.getClassName=function(){return"FollowCamera"};__decorate([BABYLON.serialize()],FollowCamera.prototype,"radius",void 0);__decorate([BABYLON.serialize()],FollowCamera.prototype,"rotationOffset",void 0);__decorate([BABYLON.serialize()],FollowCamera.prototype,"heightOffset",void 0);__decorate([BABYLON.serialize()],FollowCamera.prototype,"cameraAcceleration",void 0);__decorate([BABYLON.serialize()],FollowCamera.prototype,"maxCameraSpeed",void 0);__decorate([BABYLON.serializeAsMeshReference("lockedTargetId")],FollowCamera.prototype,"lockedTarget",void 0);return FollowCamera}(BABYLON.TargetCamera);BABYLON.FollowCamera=FollowCamera;var ArcFollowCamera=function(_super){__extends(ArcFollowCamera,_super);function ArcFollowCamera(name,alpha,beta,radius,target,scene){var _this=_super.call(this,name,BABYLON.Vector3.Zero(),scene)||this;_this.alpha=alpha;_this.beta=beta;_this.radius=radius;_this.target=target;_this._cartesianCoordinates=BABYLON.Vector3.Zero();_this.follow();return _this}ArcFollowCamera.prototype.follow=function(){this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta);this._cartesianCoordinates.y=this.radius*Math.sin(this.beta);this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);var targetPosition=this.target.getAbsolutePosition();this.position=targetPosition.add(this._cartesianCoordinates);this.setTarget(targetPosition)};ArcFollowCamera.prototype._checkInputs=function(){_super.prototype._checkInputs.call(this);this.follow()};ArcFollowCamera.prototype.getClassName=function(){return"ArcFollowCamera"};return ArcFollowCamera}(BABYLON.TargetCamera);BABYLON.ArcFollowCamera=ArcFollowCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var UniversalCamera=function(_super){__extends(UniversalCamera,_super);function UniversalCamera(name,position,scene){var _this=_super.call(this,name,position,scene)||this;_this.inputs.addGamepad();return _this}Object.defineProperty(UniversalCamera.prototype,"gamepadAngularSensibility",{get:function(){var gamepad=this.inputs.attached["gamepad"];if(gamepad)return gamepad.gamepadAngularSensibility;return null},set:function(value){var gamepad=this.inputs.attached["gamepad"];if(gamepad)gamepad.gamepadAngularSensibility=value},enumerable:true,configurable:true});Object.defineProperty(UniversalCamera.prototype,"gamepadMoveSensibility",{get:function(){var gamepad=this.inputs.attached["gamepad"];if(gamepad)return gamepad.gamepadMoveSensibility;return null},set:function(value){var gamepad=this.inputs.attached["gamepad"];if(gamepad)gamepad.gamepadMoveSensibility=value},enumerable:true,configurable:true});UniversalCamera.prototype.getClassName=function(){return"UniversalCamera"};return UniversalCamera}(BABYLON.TouchCamera);BABYLON.UniversalCamera=UniversalCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var GamepadCamera=function(_super){__extends(GamepadCamera,_super);function GamepadCamera(name,position,scene){return _super.call(this,name,position,scene)||this}Object.defineProperty(GamepadCamera.prototype,"gamepadAngularSensibility",{get:function(){var gamepad=this.inputs.attached["gamepad"];if(gamepad)return gamepad.gamepadAngularSensibility;return null},set:function(value){var gamepad=this.inputs.attached["gamepad"];if(gamepad)gamepad.gamepadAngularSensibility=value},enumerable:true,configurable:true});Object.defineProperty(GamepadCamera.prototype,"gamepadMoveSensibility",{get:function(){var gamepad=this.inputs.attached["gamepad"];if(gamepad)return gamepad.gamepadMoveSensibility;return null},set:function(value){var gamepad=this.inputs.attached["gamepad"];if(gamepad)gamepad.gamepadMoveSensibility=value},enumerable:true,configurable:true});GamepadCamera.prototype.getClassName=function(){return"GamepadCamera"};return GamepadCamera}(BABYLON.UniversalCamera);BABYLON.GamepadCamera=GamepadCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PostProcessRenderPipelineManager=function(){function PostProcessRenderPipelineManager(){this._renderPipelines={}}PostProcessRenderPipelineManager.prototype.addPipeline=function(renderPipeline){this._renderPipelines[renderPipeline._name]=renderPipeline};PostProcessRenderPipelineManager.prototype.attachCamerasToRenderPipeline=function(renderPipelineName,cameras,unique){var renderPipeline=this._renderPipelines[renderPipelineName];if(!renderPipeline){return}renderPipeline._attachCameras(cameras,unique)};PostProcessRenderPipelineManager.prototype.detachCamerasFromRenderPipeline=function(renderPipelineName,cameras){var renderPipeline=this._renderPipelines[renderPipelineName];if(!renderPipeline){return}renderPipeline._detachCameras(cameras)};PostProcessRenderPipelineManager.prototype.enableEffectInPipeline=function(renderPipelineName,renderEffectName,cameras){var renderPipeline=this._renderPipelines[renderPipelineName];if(!renderPipeline){return}renderPipeline._enableEffect(renderEffectName,cameras)};PostProcessRenderPipelineManager.prototype.disableEffectInPipeline=function(renderPipelineName,renderEffectName,cameras){var renderPipeline=this._renderPipelines[renderPipelineName];if(!renderPipeline){return}renderPipeline._disableEffect(renderEffectName,cameras)};PostProcessRenderPipelineManager.prototype.enableDisplayOnlyPassInPipeline=function(renderPipelineName,passName,cameras){var renderPipeline=this._renderPipelines[renderPipelineName];if(!renderPipeline){return}renderPipeline._enableDisplayOnlyPass(passName,cameras)};PostProcessRenderPipelineManager.prototype.disableDisplayOnlyPassInPipeline=function(renderPipelineName,cameras){var renderPipeline=this._renderPipelines[renderPipelineName];if(!renderPipeline){return}renderPipeline._disableDisplayOnlyPass(cameras)};PostProcessRenderPipelineManager.prototype.update=function(){for(var renderPipelineName in this._renderPipelines){if(this._renderPipelines.hasOwnProperty(renderPipelineName)){var pipeline=this._renderPipelines[renderPipelineName];if(!pipeline.isSupported){pipeline.dispose();delete this._renderPipelines[renderPipelineName]}else{pipeline._update()}}}};PostProcessRenderPipelineManager.prototype._rebuild=function(){for(var renderPipelineName in this._renderPipelines){if(this._renderPipelines.hasOwnProperty(renderPipelineName)){var pipeline=this._renderPipelines[renderPipelineName];pipeline._rebuild()}}};PostProcessRenderPipelineManager.prototype.dispose=function(){for(var renderPipelineName in this._renderPipelines){if(this._renderPipelines.hasOwnProperty(renderPipelineName)){var pipeline=this._renderPipelines[renderPipelineName];pipeline.dispose()}}};return PostProcessRenderPipelineManager}();BABYLON.PostProcessRenderPipelineManager=PostProcessRenderPipelineManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PostProcessRenderPass=function(){function PostProcessRenderPass(scene,name,size,renderList,beforeRender,afterRender){this._refCount=0;this._name=name;this._renderTexture=new BABYLON.RenderTargetTexture(name,size,scene);this.setRenderList(renderList);this._renderTexture.onBeforeRenderObservable.add(beforeRender);this._renderTexture.onAfterRenderObservable.add(afterRender);this._scene=scene;this._renderList=renderList}PostProcessRenderPass.prototype._incRefCount=function(){if(this._refCount===0){this._scene.customRenderTargets.push(this._renderTexture)}return++this._refCount};PostProcessRenderPass.prototype._decRefCount=function(){this._refCount--;if(this._refCount<=0){this._scene.customRenderTargets.splice(this._scene.customRenderTargets.indexOf(this._renderTexture),1)}return this._refCount};PostProcessRenderPass.prototype._update=function(){this.setRenderList(this._renderList)};PostProcessRenderPass.prototype.setRenderList=function(renderList){this._renderTexture.renderList=renderList};PostProcessRenderPass.prototype.getRenderTexture=function(){return this._renderTexture};return PostProcessRenderPass}();BABYLON.PostProcessRenderPass=PostProcessRenderPass})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PostProcessRenderEffect=function(){function PostProcessRenderEffect(engine,name,getPostProcess,singleInstance){this._engine=engine;this._name=name;this._singleInstance=singleInstance||true;this._getPostProcess=getPostProcess;this._cameras=[];this._indicesForCamera=[];this._postProcesses={};this._renderPasses={};this._renderEffectAsPasses={}}Object.defineProperty(PostProcessRenderEffect.prototype,"isSupported",{get:function(){for(var index in this._postProcesses){if(!this._postProcesses[index].isSupported){return false}}return true},enumerable:true,configurable:true});PostProcessRenderEffect.prototype._update=function(){for(var renderPassName in this._renderPasses){this._renderPasses[renderPassName]._update()}};PostProcessRenderEffect.prototype.addPass=function(renderPass){this._renderPasses[renderPass._name]=renderPass;this._linkParameters()};PostProcessRenderEffect.prototype.removePass=function(renderPass){delete this._renderPasses[renderPass._name];this._linkParameters()};PostProcessRenderEffect.prototype.addRenderEffectAsPass=function(renderEffect){this._renderEffectAsPasses[renderEffect._name]=renderEffect;this._linkParameters()};PostProcessRenderEffect.prototype.getPass=function(passName){for(var renderPassName in this._renderPasses){if(renderPassName===passName){return this._renderPasses[passName]}}return null};PostProcessRenderEffect.prototype.emptyPasses=function(){this._renderPasses={};this._linkParameters()};PostProcessRenderEffect.prototype._attachCameras=function(cameras){var cameraKey;var _cam=BABYLON.Tools.MakeArray(cameras||this._cameras);for(var i=0;i<_cam.length;i++){var camera=_cam[i];var cameraName=camera.name;if(this._singleInstance){cameraKey=0}else{cameraKey=cameraName}this._postProcesses[cameraKey]=this._postProcesses[cameraKey]||this._getPostProcess();var index=camera.attachPostProcess(this._postProcesses[cameraKey]);if(!this._indicesForCamera[cameraName]){this._indicesForCamera[cameraName]=[]}this._indicesForCamera[cameraName].push(index);if(this._cameras.indexOf(camera)===-1){this._cameras[cameraName]=camera}for(var passName in this._renderPasses){this._renderPasses[passName]._incRefCount()}}this._linkParameters()};PostProcessRenderEffect.prototype._detachCameras=function(cameras){var _cam=BABYLON.Tools.MakeArray(cameras||this._cameras);for(var i=0;i<_cam.length;i++){var camera=_cam[i];var cameraName=camera.name;camera.detachPostProcess(this._postProcesses[this._singleInstance?0:cameraName],this._indicesForCamera[cameraName]);var index=this._cameras.indexOf(cameraName);this._indicesForCamera.splice(index,1);this._cameras.splice(index,1);for(var passName in this._renderPasses){this._renderPasses[passName]._decRefCount()}}};PostProcessRenderEffect.prototype._enable=function(cameras){var _cam=BABYLON.Tools.MakeArray(cameras||this._cameras);for(var i=0;i<_cam.length;i++){var camera=_cam[i];var cameraName=camera.name;for(var j=0;j<this._indicesForCamera[cameraName].length;j++){if(camera._postProcesses[this._indicesForCamera[cameraName][j]]===undefined){cameras[i].attachPostProcess(this._postProcesses[this._singleInstance?0:cameraName],this._indicesForCamera[cameraName][j])}}for(var passName in this._renderPasses){this._renderPasses[passName]._incRefCount()}}};PostProcessRenderEffect.prototype._disable=function(cameras){var _cam=BABYLON.Tools.MakeArray(cameras||this._cameras);for(var i=0;i<_cam.length;i++){var camera=_cam[i];var cameraName=camera.Name;camera.detachPostProcess(this._postProcesses[this._singleInstance?0:cameraName],this._indicesForCamera[cameraName]);for(var passName in this._renderPasses){this._renderPasses[passName]._decRefCount()}}};PostProcessRenderEffect.prototype.getPostProcess=function(camera){if(this._singleInstance){return this._postProcesses[0]}else{return this._postProcesses[camera.name]}};PostProcessRenderEffect.prototype._linkParameters=function(){var _this=this;for(var index in this._postProcesses){if(this.applyParameters){this.applyParameters(this._postProcesses[index])}this._postProcesses[index].onBeforeRenderObservable.add(function(effect){_this._linkTextures(effect)})}};PostProcessRenderEffect.prototype._linkTextures=function(effect){for(var renderPassName in this._renderPasses){effect.setTexture(renderPassName,this._renderPasses[renderPassName].getRenderTexture())}for(var renderEffectName in this._renderEffectAsPasses){effect.setTextureFromPostProcess(renderEffectName+"Sampler",this._renderEffectAsPasses[renderEffectName].getPostProcess())}};return PostProcessRenderEffect}();BABYLON.PostProcessRenderEffect=PostProcessRenderEffect})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PostProcessRenderPipeline=function(){function PostProcessRenderPipeline(engine,name){this._engine=engine;this._name=name;this._renderEffects=new Array;this._renderEffectsForIsolatedPass=new Array;this._cameras=[]}PostProcessRenderPipeline.prototype.getClassName=function(){return"PostProcessRenderPipeline"};Object.defineProperty(PostProcessRenderPipeline.prototype,"isSupported",{get:function(){for(var renderEffectName in this._renderEffects){if(this._renderEffects.hasOwnProperty(renderEffectName)){if(!this._renderEffects[renderEffectName].isSupported){return false}}}return true},enumerable:true,configurable:true});PostProcessRenderPipeline.prototype.addEffect=function(renderEffect){this._renderEffects[renderEffect._name]=renderEffect};PostProcessRenderPipeline.prototype._rebuild=function(){};PostProcessRenderPipeline.prototype._enableEffect=function(renderEffectName,cameras){var renderEffects=this._renderEffects[renderEffectName];if(!renderEffects){return}renderEffects._enable(BABYLON.Tools.MakeArray(cameras||this._cameras))};PostProcessRenderPipeline.prototype._disableEffect=function(renderEffectName,cameras){var renderEffects=this._renderEffects[renderEffectName];if(!renderEffects){return}renderEffects._disable(BABYLON.Tools.MakeArray(cameras||this._cameras))};PostProcessRenderPipeline.prototype._attachCameras=function(cameras,unique){var _cam=BABYLON.Tools.MakeArray(cameras||this._cameras);var indicesToDelete=[];var i;for(i=0;i<_cam.length;i++){var camera=_cam[i];var cameraName=camera.name;if(this._cameras.indexOf(camera)===-1){this._cameras[cameraName]=camera}else if(unique){indicesToDelete.push(i)}}for(i=0;i<indicesToDelete.length;i++){cameras.splice(indicesToDelete[i],1)}for(var renderEffectName in this._renderEffects){if(this._renderEffects.hasOwnProperty(renderEffectName)){this._renderEffects[renderEffectName]._attachCameras(_cam)}}};PostProcessRenderPipeline.prototype._detachCameras=function(cameras){var _cam=BABYLON.Tools.MakeArray(cameras||this._cameras);for(var renderEffectName in this._renderEffects){if(this._renderEffects.hasOwnProperty(renderEffectName)){this._renderEffects[renderEffectName]._detachCameras(_cam)}}for(var i=0;i<_cam.length;i++){this._cameras.splice(this._cameras.indexOf(_cam[i]),1)}};PostProcessRenderPipeline.prototype._enableDisplayOnlyPass=function(passName,cameras){var _this=this;var _cam=BABYLON.Tools.MakeArray(cameras||this._cameras);var pass=null;var renderEffectName;for(renderEffectName in this._renderEffects){if(this._renderEffects.hasOwnProperty(renderEffectName)){pass=this._renderEffects[renderEffectName].getPass(passName);if(pass!=null){break}}}if(pass===null){return}for(renderEffectName in this._renderEffects){if(this._renderEffects.hasOwnProperty(renderEffectName)){this._renderEffects[renderEffectName]._disable(_cam)}}pass._name=PostProcessRenderPipeline.PASS_SAMPLER_NAME;for(var i=0;i<_cam.length;i++){var camera=_cam[i];var cameraName=camera.name;this._renderEffectsForIsolatedPass[cameraName]=this._renderEffectsForIsolatedPass[cameraName]||new BABYLON.PostProcessRenderEffect(this._engine,PostProcessRenderPipeline.PASS_EFFECT_NAME,function(){return new BABYLON.DisplayPassPostProcess(PostProcessRenderPipeline.PASS_EFFECT_NAME,1,null,null,_this._engine,true)});this._renderEffectsForIsolatedPass[cameraName].emptyPasses();this._renderEffectsForIsolatedPass[cameraName].addPass(pass);this._renderEffectsForIsolatedPass[cameraName]._attachCameras(camera)}};PostProcessRenderPipeline.prototype._disableDisplayOnlyPass=function(cameras){var _this=this;var _cam=BABYLON.Tools.MakeArray(cameras||this._cameras);for(var i=0;i<_cam.length;i++){var camera=_cam[i];var cameraName=camera.name;this._renderEffectsForIsolatedPass[cameraName]=this._renderEffectsForIsolatedPass[cameraName]||new BABYLON.PostProcessRenderEffect(this._engine,PostProcessRenderPipeline.PASS_EFFECT_NAME,function(){return new BABYLON.DisplayPassPostProcess(PostProcessRenderPipeline.PASS_EFFECT_NAME,1,null,null,_this._engine,true)});this._renderEffectsForIsolatedPass[cameraName]._disable(camera)}for(var renderEffectName in this._renderEffects){if(this._renderEffects.hasOwnProperty(renderEffectName)){this._renderEffects[renderEffectName]._enable(_cam)}}};PostProcessRenderPipeline.prototype._update=function(){for(var renderEffectName in this._renderEffects){if(this._renderEffects.hasOwnProperty(renderEffectName)){this._renderEffects[renderEffectName]._update()}}for(var i=0;i<this._cameras.length;i++){var cameraName=this._cameras[i].name;if(this._renderEffectsForIsolatedPass[cameraName]){this._renderEffectsForIsolatedPass[cameraName]._update()}}};PostProcessRenderPipeline.prototype._reset=function(){this._renderEffects=new Array;this._renderEffectsForIsolatedPass=new Array};PostProcessRenderPipeline.prototype.dispose=function(){};PostProcessRenderPipeline.PASS_EFFECT_NAME="passEffect";PostProcessRenderPipeline.PASS_SAMPLER_NAME="passSampler";__decorate([BABYLON.serialize()],PostProcessRenderPipeline.prototype,"_name",void 0);return PostProcessRenderPipeline}();BABYLON.PostProcessRenderPipeline=PostProcessRenderPipeline})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DepthRenderer=function(){function DepthRenderer(scene,type){if(type===void 0){type=BABYLON.Engine.TEXTURETYPE_FLOAT}var _this=this;this._scene=scene;var engine=scene.getEngine();this._depthMap=new BABYLON.RenderTargetTexture("depthMap",{width:engine.getRenderWidth(),height:engine.getRenderHeight()},this._scene,false,true,type);this._depthMap.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;this._depthMap.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;this._depthMap.refreshRate=1;this._depthMap.renderParticles=false;this._depthMap.renderList=null;this._depthMap.onClearObservable.add(function(engine){engine.clear(new BABYLON.Color4(1,1,1,1),true,true,true)});var renderSubMesh=function(subMesh){var mesh=subMesh.getRenderingMesh();var scene=_this._scene;var engine=scene.getEngine();engine.setState(subMesh.getMaterial().backFaceCulling);var batch=mesh._getInstancesRenderList(subMesh._id);if(batch.mustReturn){return}var hardwareInstancedRendering=engine.getCaps().instancedArrays&&batch.visibleInstances[subMesh._id]!==null;if(_this.isReady(subMesh,hardwareInstancedRendering)){engine.enableEffect(_this._effect);mesh._bind(subMesh,_this._effect,BABYLON.Material.TriangleFillMode);var material=subMesh.getMaterial();_this._effect.setMatrix("viewProjection",scene.getTransformMatrix());_this._effect.setFloat2("depthValues",scene.activeCamera.minZ,scene.activeCamera.minZ+scene.activeCamera.maxZ);if(material&&material.needAlphaTesting()){var alphaTexture=material.getAlphaTestTexture();_this._effect.setTexture("diffuseSampler",alphaTexture);_this._effect.setMatrix("diffuseMatrix",alphaTexture.getTextureMatrix())}if(mesh.useBones&&mesh.computeBonesUsingShaders){_this._effect.setMatrices("mBones",mesh.skeleton.getTransformMatrices(mesh))}mesh._processRendering(subMesh,_this._effect,BABYLON.Material.TriangleFillMode,batch,hardwareInstancedRendering,function(isInstance,world){return _this._effect.setMatrix("world",world)})}};this._depthMap.customRenderFunction=function(opaqueSubMeshes,alphaTestSubMeshes,transparentSubMeshes,depthOnlySubMeshes){var index;if(depthOnlySubMeshes.length){engine.setColorWrite(false);for(index=0;index<depthOnlySubMeshes.length;index++){renderSubMesh(depthOnlySubMeshes.data[index])}engine.setColorWrite(true)}for(index=0;index<opaqueSubMeshes.length;index++){renderSubMesh(opaqueSubMeshes.data[index])}for(index=0;index<alphaTestSubMeshes.length;index++){renderSubMesh(alphaTestSubMeshes.data[index])}}}DepthRenderer.prototype.isReady=function(subMesh,useInstances){var material=subMesh.getMaterial();if(material.disableDepthWrite){return false}var defines=[];var attribs=[BABYLON.VertexBuffer.PositionKind];var mesh=subMesh.getMesh();if(material&&material.needAlphaTesting()){defines.push("#define ALPHATEST");if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){attribs.push(BABYLON.VertexBuffer.UVKind);defines.push("#define UV1")}if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)){attribs.push(BABYLON.VertexBuffer.UV2Kind);defines.push("#define UV2")}}if(mesh.useBones&&mesh.computeBonesUsingShaders){attribs.push(BABYLON.VertexBuffer.MatricesIndicesKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsKind);if(mesh.numBoneInfluencers>4){attribs.push(BABYLON.VertexBuffer.MatricesIndicesExtraKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsExtraKind)}defines.push("#define NUM_BONE_INFLUENCERS "+mesh.numBoneInfluencers);defines.push("#define BonesPerMesh "+(mesh.skeleton.bones.length+1))}else{defines.push("#define NUM_BONE_INFLUENCERS 0")}if(useInstances){defines.push("#define INSTANCES");attribs.push("world0");attribs.push("world1");attribs.push("world2");attribs.push("world3")}var join=defines.join("\n");if(this._cachedDefines!==join){this._cachedDefines=join;this._effect=this._scene.getEngine().createEffect("depth",attribs,["world","mBones","viewProjection","diffuseMatrix","depthValues"],["diffuseSampler"],join)}return this._effect.isReady()};DepthRenderer.prototype.getDepthMap=function(){return this._depthMap};DepthRenderer.prototype.dispose=function(){this._depthMap.dispose()};return DepthRenderer}();BABYLON.DepthRenderer=DepthRenderer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SSAORenderingPipeline=function(_super){__extends(SSAORenderingPipeline,_super);function SSAORenderingPipeline(name,scene,ratio,cameras){var _this=_super.call(this,scene.getEngine(),name)||this;_this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect";_this.SSAORenderEffect="SSAORenderEffect";_this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect";_this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect";_this.SSAOCombineRenderEffect="SSAOCombineRenderEffect";_this.totalStrength=1;_this.radius=1e-4;_this.area=.0075;_this.fallOff=1e-6;_this.base=.5;_this._firstUpdate=true;_this._scene=scene;_this._createRandomTexture();_this._depthTexture=scene.enableDepthRenderer().getDepthMap();var ssaoRatio=ratio.ssaoRatio||ratio;var combineRatio=ratio.combineRatio||ratio;_this._ratio={ssaoRatio:ssaoRatio,combineRatio:combineRatio};_this._originalColorPostProcess=new BABYLON.PassPostProcess("SSAOOriginalSceneColor",combineRatio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false);_this._createSSAOPostProcess(ssaoRatio);_this._createBlurPostProcess(ssaoRatio);_this._createSSAOCombinePostProcess(combineRatio);_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAOOriginalSceneColorEffect,function(){return _this._originalColorPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAORenderEffect,function(){return _this._ssaoPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAOBlurHRenderEffect,function(){return _this._blurHPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAOBlurVRenderEffect,function(){return _this._blurVPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAOCombineRenderEffect,function(){return _this._ssaoCombinePostProcess},true));scene.postProcessRenderPipelineManager.addPipeline(_this);if(cameras)scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(name,cameras);return _this}SSAORenderingPipeline.prototype.dispose=function(disableDepthRender){if(disableDepthRender===void 0){disableDepthRender=false}for(var i=0;i<this._scene.cameras.length;i++){var camera=this._scene.cameras[i];this._originalColorPostProcess.dispose(camera);this._ssaoPostProcess.dispose(camera);this._blurHPostProcess.dispose(camera);this._blurVPostProcess.dispose(camera);this._ssaoCombinePostProcess.dispose(camera)}this._randomTexture.dispose();if(disableDepthRender)this._scene.disableDepthRenderer();this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras);_super.prototype.dispose.call(this)};SSAORenderingPipeline.prototype._createBlurPostProcess=function(ratio){var _this=this;var samplerOffsets=new Array;for(var i=-8;i<8;i++){samplerOffsets.push(i*2)}this._blurHPostProcess=new BABYLON.PostProcess("BlurH","ssao",["outSize","samplerOffsets"],["depthSampler"],ratio,null,BABYLON.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16");this._blurHPostProcess.onApply=function(effect){effect.setFloat("outSize",_this._ssaoCombinePostProcess.width);effect.setTexture("depthSampler",_this._depthTexture);if(_this._firstUpdate){effect.setArray("samplerOffsets",samplerOffsets)}};this._blurVPostProcess=new BABYLON.PostProcess("BlurV","ssao",["outSize","samplerOffsets"],["depthSampler"],ratio,null,BABYLON.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define BILATERAL_BLUR\n#define SAMPLES 16");this._blurVPostProcess.onApply=function(effect){effect.setFloat("outSize",_this._ssaoCombinePostProcess.height);effect.setTexture("depthSampler",_this._depthTexture);if(_this._firstUpdate){effect.setArray("samplerOffsets",samplerOffsets);_this._firstUpdate=false}}};SSAORenderingPipeline.prototype._rebuild=function(){this._firstUpdate=true;_super.prototype._rebuild.call(this)};SSAORenderingPipeline.prototype._createSSAOPostProcess=function(ratio){var _this=this;var numSamples=16;var sampleSphere=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];var samplesFactor=1/numSamples;this._ssaoPostProcess=new BABYLON.PostProcess("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define SAMPLES "+numSamples+"\n#define SSAO");this._ssaoPostProcess.onApply=function(effect){if(_this._firstUpdate){effect.setArray3("sampleSphere",sampleSphere);effect.setFloat("samplesFactor",samplesFactor);effect.setFloat("randTextureTiles",4)}effect.setFloat("totalStrength",_this.totalStrength);effect.setFloat("radius",_this.radius);effect.setFloat("area",_this.area);effect.setFloat("fallOff",_this.fallOff);effect.setFloat("base",_this.base);effect.setTexture("textureSampler",_this._depthTexture);effect.setTexture("randomSampler",_this._randomTexture)}};SSAORenderingPipeline.prototype._createSSAOCombinePostProcess=function(ratio){var _this=this;this._ssaoCombinePostProcess=new BABYLON.PostProcess("ssaoCombine","ssaoCombine",[],["originalColor"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false);this._ssaoCombinePostProcess.onApply=function(effect){effect.setTextureFromPostProcess("originalColor",_this._originalColorPostProcess)}};SSAORenderingPipeline.prototype._createRandomTexture=function(){var size=512;this._randomTexture=new BABYLON.DynamicTexture("SSAORandomTexture",size,this._scene,false,BABYLON.Texture.TRILINEAR_SAMPLINGMODE);this._randomTexture.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE;this._randomTexture.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE;var context=this._randomTexture.getContext();var rand=function(min,max){return Math.random()*(max-min)+min};var randVector=BABYLON.Vector3.Zero();for(var x=0;x<size;x++){for(var y=0;y<size;y++){randVector.x=Math.floor(rand(-1,1)*255);randVector.y=Math.floor(rand(-1,1)*255);randVector.z=Math.floor(rand(-1,1)*255);context.fillStyle="rgb("+randVector.x+", "+randVector.y+", "+randVector.z+")";context.fillRect(x,y,1,1)}}this._randomTexture.update(false)};__decorate([BABYLON.serialize()],SSAORenderingPipeline.prototype,"totalStrength",void 0);__decorate([BABYLON.serialize()],SSAORenderingPipeline.prototype,"radius",void 0);__decorate([BABYLON.serialize()],SSAORenderingPipeline.prototype,"area",void 0);__decorate([BABYLON.serialize()],SSAORenderingPipeline.prototype,"fallOff",void 0);__decorate([BABYLON.serialize()],SSAORenderingPipeline.prototype,"base",void 0);__decorate([BABYLON.serialize()],SSAORenderingPipeline.prototype,"_ratio",void 0);return SSAORenderingPipeline}(BABYLON.PostProcessRenderPipeline);BABYLON.SSAORenderingPipeline=SSAORenderingPipeline})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SSAO2RenderingPipeline=function(_super){__extends(SSAO2RenderingPipeline,_super);function SSAO2RenderingPipeline(name,scene,ratio,cameras){var _this=_super.call(this,scene.getEngine(),name)||this;_this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect";_this.SSAORenderEffect="SSAORenderEffect";_this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect";_this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect";_this.SSAOCombineRenderEffect="SSAOCombineRenderEffect";_this.totalStrength=1;_this.maxZ=100;_this.minZAspect=.2;_this._samples=8;_this._expensiveBlur=true;_this.radius=2;_this.base=.1;_this._firstUpdate=true;_this._scene=scene;if(!_this.isSupported){BABYLON.Tools.Error("SSAO 2 needs WebGL 2 support.");return _this}var ssaoRatio=ratio.ssaoRatio||ratio;var blurRatio=ratio.blurRatio||ratio;_this._ratio={ssaoRatio:ssaoRatio,blurRatio:blurRatio};_this._createRandomTexture();_this._depthTexture=scene.enableGeometryBufferRenderer().getGBuffer().textures[0];_this._normalTexture=scene.enableGeometryBufferRenderer().getGBuffer().textures[1];_this._originalColorPostProcess=new BABYLON.PassPostProcess("SSAOOriginalSceneColor",1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false);_this._createSSAOPostProcess(1);_this._createBlurPostProcess(ssaoRatio,blurRatio);_this._createSSAOCombinePostProcess(blurRatio);_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAOOriginalSceneColorEffect,function(){return _this._originalColorPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAORenderEffect,function(){return _this._ssaoPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAOBlurHRenderEffect,function(){return _this._blurHPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAOBlurVRenderEffect,function(){return _this._blurVPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.SSAOCombineRenderEffect,function(){return _this._ssaoCombinePostProcess},true));scene.postProcessRenderPipelineManager.addPipeline(_this);if(cameras)scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(name,cameras);return _this}Object.defineProperty(SSAO2RenderingPipeline.prototype,"samples",{get:function(){return this._samples},set:function(n){this._ssaoPostProcess.updateEffect("#define SAMPLES "+n+"\n#define SSAO");this._samples=n;this._sampleSphere=this._generateHemisphere();this._firstUpdate=true},enumerable:true,configurable:true});Object.defineProperty(SSAO2RenderingPipeline.prototype,"expensiveBlur",{get:function(){return this._expensiveBlur},set:function(b){this._blurHPostProcess.updateEffect("#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(b?"1":"0")+"\n",null,["textureSampler","depthSampler"]);this._blurVPostProcess.updateEffect("#define BILATERAL_BLUR\n#define SAMPLES 16\n#define EXPENSIVE "+(b?"1":"0")+"\n",null,["textureSampler","depthSampler"]);this._expensiveBlur=b;this._firstUpdate=true},enumerable:true,configurable:true});Object.defineProperty(SSAO2RenderingPipeline,"IsSupported",{get:function(){var engine=BABYLON.Engine.LastCreatedEngine;return engine.getCaps().drawBuffersExtension},enumerable:true,configurable:true});SSAO2RenderingPipeline.prototype.dispose=function(disableGeometryBufferRenderer){if(disableGeometryBufferRenderer===void 0){disableGeometryBufferRenderer=false}for(var i=0;i<this._scene.cameras.length;i++){var camera=this._scene.cameras[i];this._originalColorPostProcess.dispose(camera);this._ssaoPostProcess.dispose(camera);this._blurHPostProcess.dispose(camera);this._blurVPostProcess.dispose(camera);this._ssaoCombinePostProcess.dispose(camera)}this._randomTexture.dispose();if(disableGeometryBufferRenderer)this._scene.disableGeometryBufferRenderer();this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras);_super.prototype.dispose.call(this)};SSAO2RenderingPipeline.prototype._createBlurPostProcess=function(ssaoRatio,blurRatio){var _this=this;this._samplerOffsets=[];var expensive=this.expensiveBlur;for(var i=-8;i<8;i++){this._samplerOffsets.push(i*2+.5)}this._blurHPostProcess=new BABYLON.PostProcess("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],ssaoRatio,null,BABYLON.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(expensive?"1":"0")+"\n");this._blurHPostProcess.onApply=function(effect){effect.setFloat("outSize",_this._ssaoCombinePostProcess.width);effect.setFloat("near",_this._scene.activeCamera.minZ);effect.setFloat("far",_this._scene.activeCamera.maxZ);effect.setFloat("radius",_this.radius);effect.setTexture("depthSampler",_this._depthTexture);if(_this._firstUpdate){effect.setArray("samplerOffsets",_this._samplerOffsets)}};this._blurVPostProcess=new BABYLON.PostProcess("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],blurRatio,null,BABYLON.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_V\n#define SAMPLES 16\n#define EXPENSIVE "+(expensive?"1":"0")+"\n");this._blurVPostProcess.onApply=function(effect){effect.setFloat("outSize",_this._ssaoCombinePostProcess.height);effect.setFloat("near",_this._scene.activeCamera.minZ);effect.setFloat("far",_this._scene.activeCamera.maxZ);effect.setFloat("radius",_this.radius);effect.setTexture("depthSampler",_this._depthTexture);if(_this._firstUpdate){effect.setArray("samplerOffsets",_this._samplerOffsets);_this._firstUpdate=false}}};SSAO2RenderingPipeline.prototype._rebuild=function(){this._firstUpdate=true;_super.prototype._rebuild.call(this)};SSAO2RenderingPipeline.prototype._generateHemisphere=function(){var numSamples=this.samples;var result=[];var vector,scale;var rand=function(min,max){return Math.random()*(max-min)+min};var i=0;while(i<numSamples){vector=new BABYLON.Vector3(rand(-1,1),rand(-1,1),rand(.3,1));vector.normalize();scale=i/numSamples;scale=BABYLON.Scalar.Lerp(.1,1,scale*scale);vector.scaleInPlace(scale);result.push(vector.x,vector.y,vector.z);i++}return result};SSAO2RenderingPipeline.prototype._createSSAOPostProcess=function(ratio){var _this=this;var numSamples=this.samples;this._sampleSphere=this._generateHemisphere();this._ssaoPostProcess=new BABYLON.PostProcess("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect"],["randomSampler","normalSampler"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define SAMPLES "+numSamples+"\n#define SSAO");this._ssaoPostProcess.onApply=function(effect){if(_this._firstUpdate){effect.setArray3("sampleSphere",_this._sampleSphere);effect.setFloat("randTextureTiles",4)}effect.setFloat("samplesFactor",1/_this.samples);effect.setFloat("totalStrength",_this.totalStrength);effect.setFloat2("texelSize",1/_this._ssaoPostProcess.width,1/_this._ssaoPostProcess.height);effect.setFloat("radius",_this.radius);effect.setFloat("maxZ",_this.maxZ);effect.setFloat("minZAspect",_this.minZAspect);effect.setFloat("base",_this.base);effect.setFloat("near",_this._scene.activeCamera.minZ);effect.setFloat("far",_this._scene.activeCamera.maxZ);effect.setFloat("xViewport",Math.tan(_this._scene.activeCamera.fov/2)*_this._scene.getEngine().getAspectRatio(_this._scene.activeCamera,true));effect.setFloat("yViewport",Math.tan(_this._scene.activeCamera.fov/2));effect.setMatrix("projection",_this._scene.getProjectionMatrix());effect.setTexture("textureSampler",_this._depthTexture);effect.setTexture("normalSampler",_this._normalTexture);effect.setTexture("randomSampler",_this._randomTexture)}};SSAO2RenderingPipeline.prototype._createSSAOCombinePostProcess=function(ratio){var _this=this;this._ssaoCombinePostProcess=new BABYLON.PostProcess("ssaoCombine","ssaoCombine",[],["originalColor"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false);this._ssaoCombinePostProcess.onApply=function(effect){effect.setTextureFromPostProcess("originalColor",_this._originalColorPostProcess)}};SSAO2RenderingPipeline.prototype._createRandomTexture=function(){var size=512;this._randomTexture=new BABYLON.DynamicTexture("SSAORandomTexture",size,this._scene,false,BABYLON.Texture.TRILINEAR_SAMPLINGMODE);this._randomTexture.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE;this._randomTexture.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE;var context=this._randomTexture.getContext();var rand=function(min,max){return Math.random()*(max-min)+min};var randVector=BABYLON.Vector3.Zero();for(var x=0;x<size;x++){for(var y=0;y<size;y++){randVector.x=rand(0,1);randVector.y=rand(0,1);randVector.z=0;randVector.normalize();randVector.scaleInPlace(255);randVector.x=Math.floor(randVector.x);randVector.y=Math.floor(randVector.y);context.fillStyle="rgb("+randVector.x+", "+randVector.y+", "+randVector.z+")";context.fillRect(x,y,1,1)}}this._randomTexture.update(false)};__decorate([BABYLON.serialize()],SSAO2RenderingPipeline.prototype,"totalStrength",void 0);__decorate([BABYLON.serialize()],SSAO2RenderingPipeline.prototype,"maxZ",void 0);__decorate([BABYLON.serialize()],SSAO2RenderingPipeline.prototype,"minZAspect",void 0);__decorate([BABYLON.serialize("samples")],SSAO2RenderingPipeline.prototype,"_samples",void 0);__decorate([BABYLON.serialize("expensiveBlur")],SSAO2RenderingPipeline.prototype,"_expensiveBlur",void 0);__decorate([BABYLON.serialize()],SSAO2RenderingPipeline.prototype,"radius",void 0);__decorate([BABYLON.serialize()],SSAO2RenderingPipeline.prototype,"base",void 0);__decorate([BABYLON.serialize()],SSAO2RenderingPipeline.prototype,"_ratio",void 0);return SSAO2RenderingPipeline}(BABYLON.PostProcessRenderPipeline);BABYLON.SSAO2RenderingPipeline=SSAO2RenderingPipeline})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var LensRenderingPipeline=function(_super){__extends(LensRenderingPipeline,_super);function LensRenderingPipeline(name,parameters,scene,ratio,cameras){if(ratio===void 0){ratio=1}var _this=_super.call(this,scene.getEngine(),name)||this;_this.LensChromaticAberrationEffect="LensChromaticAberrationEffect";_this.HighlightsEnhancingEffect="HighlightsEnhancingEffect";_this.LensDepthOfFieldEffect="LensDepthOfFieldEffect";_this._scene=scene;_this._depthTexture=scene.enableDepthRenderer().getDepthMap();if(parameters.grain_texture){_this._grainTexture=parameters.grain_texture}else{_this._createGrainTexture()}_this._edgeBlur=parameters.edge_blur?parameters.edge_blur:0;_this._grainAmount=parameters.grain_amount?parameters.grain_amount:0;_this._chromaticAberration=parameters.chromatic_aberration?parameters.chromatic_aberration:0;_this._distortion=parameters.distortion?parameters.distortion:0;_this._highlightsGain=parameters.dof_gain!==undefined?parameters.dof_gain:-1;_this._highlightsThreshold=parameters.dof_threshold?parameters.dof_threshold:1;_this._dofDistance=parameters.dof_focus_distance!==undefined?parameters.dof_focus_distance:-1;_this._dofAperture=parameters.dof_aperture?parameters.dof_aperture:1;_this._dofDarken=parameters.dof_darken?parameters.dof_darken:0;_this._dofPentagon=parameters.dof_pentagon!==undefined?parameters.dof_pentagon:true;_this._blurNoise=parameters.blur_noise!==undefined?parameters.blur_noise:true;_this._createChromaticAberrationPostProcess(ratio);_this._createHighlightsPostProcess(ratio);_this._createDepthOfFieldPostProcess(ratio/4);_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.LensChromaticAberrationEffect,function(){return _this._chromaticAberrationPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.HighlightsEnhancingEffect,function(){return _this._highlightsPostProcess},true));_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),_this.LensDepthOfFieldEffect,function(){return _this._depthOfFieldPostProcess},true));if(_this._highlightsGain===-1){_this._disableEffect(_this.HighlightsEnhancingEffect,null)}scene.postProcessRenderPipelineManager.addPipeline(_this);if(cameras){scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(name,cameras)}return _this}LensRenderingPipeline.prototype.setEdgeBlur=function(amount){this._edgeBlur=amount};LensRenderingPipeline.prototype.disableEdgeBlur=function(){this._edgeBlur=0};LensRenderingPipeline.prototype.setGrainAmount=function(amount){this._grainAmount=amount};LensRenderingPipeline.prototype.disableGrain=function(){this._grainAmount=0};LensRenderingPipeline.prototype.setChromaticAberration=function(amount){this._chromaticAberration=amount};LensRenderingPipeline.prototype.disableChromaticAberration=function(){this._chromaticAberration=0};LensRenderingPipeline.prototype.setEdgeDistortion=function(amount){this._distortion=amount};LensRenderingPipeline.prototype.disableEdgeDistortion=function(){this._distortion=0};LensRenderingPipeline.prototype.setFocusDistance=function(amount){this._dofDistance=amount};LensRenderingPipeline.prototype.disableDepthOfField=function(){this._dofDistance=-1};LensRenderingPipeline.prototype.setAperture=function(amount){this._dofAperture=amount};LensRenderingPipeline.prototype.setDarkenOutOfFocus=function(amount){this._dofDarken=amount};LensRenderingPipeline.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect("#define PENTAGON\n")};LensRenderingPipeline.prototype.disablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect()};LensRenderingPipeline.prototype.enableNoiseBlur=function(){this._blurNoise=true};LensRenderingPipeline.prototype.disableNoiseBlur=function(){this._blurNoise=false};LensRenderingPipeline.prototype.setHighlightsGain=function(amount){this._highlightsGain=amount};LensRenderingPipeline.prototype.setHighlightsThreshold=function(amount){if(this._highlightsGain===-1){this._highlightsGain=1}this._highlightsThreshold=amount};LensRenderingPipeline.prototype.disableHighlights=function(){this._highlightsGain=-1};LensRenderingPipeline.prototype.dispose=function(disableDepthRender){if(disableDepthRender===void 0){disableDepthRender=false}this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras);this._chromaticAberrationPostProcess=undefined;this._highlightsPostProcess=undefined;this._depthOfFieldPostProcess=undefined;this._grainTexture.dispose();if(disableDepthRender)this._scene.disableDepthRenderer()};LensRenderingPipeline.prototype._createChromaticAberrationPostProcess=function(ratio){var _this=this;this._chromaticAberrationPostProcess=new BABYLON.PostProcess("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height"],[],ratio,null,BABYLON.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false);this._chromaticAberrationPostProcess.onApply=function(effect){effect.setFloat("chromatic_aberration",_this._chromaticAberration);effect.setFloat("screen_width",_this._scene.getEngine().getRenderingCanvas().width);effect.setFloat("screen_height",_this._scene.getEngine().getRenderingCanvas().height)}};LensRenderingPipeline.prototype._createHighlightsPostProcess=function(ratio){var _this=this;this._highlightsPostProcess=new BABYLON.PostProcess("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],ratio,null,BABYLON.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,this._dofPentagon?"#define PENTAGON\n":"");this._highlightsPostProcess.onApply=function(effect){effect.setFloat("gain",_this._highlightsGain);effect.setFloat("threshold",_this._highlightsThreshold);effect.setTextureFromPostProcess("textureSampler",_this._chromaticAberrationPostProcess);effect.setFloat("screen_width",_this._scene.getEngine().getRenderingCanvas().width);effect.setFloat("screen_height",_this._scene.getEngine().getRenderingCanvas().height)}};LensRenderingPipeline.prototype._createDepthOfFieldPostProcess=function(ratio){var _this=this;this._depthOfFieldPostProcess=new BABYLON.PostProcess("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],ratio,null,BABYLON.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false);this._depthOfFieldPostProcess.onApply=function(effect){effect.setTexture("depthSampler",_this._depthTexture);effect.setTexture("grainSampler",_this._grainTexture);effect.setTextureFromPostProcess("textureSampler",_this._highlightsPostProcess);effect.setTextureFromPostProcess("highlightsSampler",_this._depthOfFieldPostProcess);effect.setFloat("grain_amount",_this._grainAmount);effect.setBool("blur_noise",_this._blurNoise);effect.setFloat("screen_width",_this._scene.getEngine().getRenderingCanvas().width);effect.setFloat("screen_height",_this._scene.getEngine().getRenderingCanvas().height);effect.setFloat("distortion",_this._distortion);effect.setBool("dof_enabled",_this._dofDistance!==-1);effect.setFloat("screen_distance",1/(.1-1/_this._dofDistance));effect.setFloat("aperture",_this._dofAperture);effect.setFloat("darken",_this._dofDarken);effect.setFloat("edge_blur",_this._edgeBlur);effect.setBool("highlights",_this._highlightsGain!==-1);effect.setFloat("near",_this._scene.activeCamera.minZ);effect.setFloat("far",_this._scene.activeCamera.maxZ)}};LensRenderingPipeline.prototype._createGrainTexture=function(){var size=512;this._grainTexture=new BABYLON.DynamicTexture("LensNoiseTexture",size,this._scene,false,BABYLON.Texture.BILINEAR_SAMPLINGMODE);this._grainTexture.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE;this._grainTexture.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE;var context=this._grainTexture.getContext();var rand=function(min,max){return Math.random()*(max-min)+min};var value;for(var x=0;x<size;x++){for(var y=0;y<size;y++){value=Math.floor(rand(.42,.58)*255);context.fillStyle="rgb("+value+", "+value+", "+value+")";context.fillRect(x,y,1,1)}}this._grainTexture.update(false)};return LensRenderingPipeline}(BABYLON.PostProcessRenderPipeline);BABYLON.LensRenderingPipeline=LensRenderingPipeline})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var StandardRenderingPipeline=function(_super){__extends(StandardRenderingPipeline,_super);function StandardRenderingPipeline(name,scene,ratio,originalPostProcess,cameras){if(originalPostProcess===void 0){originalPostProcess=null}var _this=_super.call(this,scene.getEngine(),name)||this;_this.downSampleX4PostProcess=null;_this.brightPassPostProcess=null;_this.blurHPostProcesses=[];_this.blurVPostProcesses=[];_this.textureAdderPostProcess=null;_this.volumetricLightPostProcess=null;_this.volumetricLightSmoothXPostProcess=null;_this.volumetricLightSmoothYPostProcess=null;_this.volumetricLightMergePostProces=null;_this.volumetricLightFinalPostProcess=null;_this.luminancePostProcess=null;_this.luminanceDownSamplePostProcesses=[];_this.hdrPostProcess=null;_this.textureAdderFinalPostProcess=null;_this.lensFlareFinalPostProcess=null;_this.hdrFinalPostProcess=null;_this.lensFlarePostProcess=null;_this.lensFlareComposePostProcess=null;_this.motionBlurPostProcess=null;_this.depthOfFieldPostProcess=null;_this.brightThreshold=1;_this.blurWidth=512;_this.horizontalBlur=false;_this.exposure=1;_this.lensTexture=null;_this.volumetricLightCoefficient=.2;_this.volumetricLightPower=4;_this.volumetricLightBlurScale=64;_this.sourceLight=null;_this.hdrMinimumLuminance=1;_this.hdrDecreaseRate=.5;_this.hdrIncreaseRate=.5;_this.lensColorTexture=null;_this.lensFlareStrength=20;_this.lensFlareGhostDispersal=1.4;_this.lensFlareHaloWidth=.7;_this.lensFlareDistortionStrength=16;_this.lensStarTexture=null;_this.lensFlareDirtTexture=null;_this.depthOfFieldDistance=10;_this.depthOfFieldBlurWidth=64;_this.motionStrength=1;_this.animations=[];_this._currentDepthOfFieldSource=null;_this._hdrCurrentLuminance=1;_this._bloomEnabled=true;_this._depthOfFieldEnabled=false;_this._vlsEnabled=false;_this._lensFlareEnabled=false;_this._hdrEnabled=false;_this._motionBlurEnabled=false;_this._motionBlurSamples=64;_this._volumetricLightStepsCount=50;_this._cameras=cameras||[];_this._scene=scene;_this._basePostProcess=originalPostProcess;_this._ratio=ratio;_this._floatTextureType=scene.getEngine().getCaps().textureFloatRender?BABYLON.Engine.TEXTURETYPE_FLOAT:BABYLON.Engine.TEXTURETYPE_HALF_FLOAT;scene.postProcessRenderPipelineManager.addPipeline(_this);_this._buildPipeline();return _this}Object.defineProperty(StandardRenderingPipeline.prototype,"BloomEnabled",{get:function(){return this._bloomEnabled},set:function(enabled){if(this._bloomEnabled===enabled){return}this._bloomEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(StandardRenderingPipeline.prototype,"DepthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(enabled){if(this._depthOfFieldEnabled===enabled){return}this._depthOfFieldEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(StandardRenderingPipeline.prototype,"LensFlareEnabled",{get:function(){return this._lensFlareEnabled},set:function(enabled){if(this._lensFlareEnabled===enabled){return}this._lensFlareEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(StandardRenderingPipeline.prototype,"HDREnabled",{get:function(){return this._hdrEnabled},set:function(enabled){if(this._hdrEnabled===enabled){return}this._hdrEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(StandardRenderingPipeline.prototype,"VLSEnabled",{get:function(){return this._vlsEnabled},set:function(enabled){if(this._vlsEnabled===enabled){return}if(enabled){var geometry=this._scene.enableGeometryBufferRenderer();if(!geometry){BABYLON.Tools.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}}this._vlsEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(StandardRenderingPipeline.prototype,"MotionBlurEnabled",{get:function(){return this._motionBlurEnabled},set:function(enabled){if(this._motionBlurEnabled===enabled){return}this._motionBlurEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(StandardRenderingPipeline.prototype,"volumetricLightStepsCount",{get:function(){return this._volumetricLightStepsCount},set:function(count){if(this.volumetricLightPostProcess){this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+count.toFixed(1))}this._volumetricLightStepsCount=count},enumerable:true,configurable:true});Object.defineProperty(StandardRenderingPipeline.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(samples){if(this.motionBlurPostProcess){this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+samples.toFixed(1))}this._motionBlurSamples=samples},enumerable:true,configurable:true});StandardRenderingPipeline.prototype._buildPipeline=function(){var _this=this;var ratio=this._ratio;var scene=this._scene;this._disposePostProcesses();this._reset();if(!this._basePostProcess){this.originalPostProcess=new BABYLON.PostProcess("HDRPass","standard",[],[],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define PASS_POST_PROCESS",this._floatTextureType);this.originalPostProcess.onApply=function(effect){_this._currentDepthOfFieldSource=_this.originalPostProcess}}else{this.originalPostProcess=this._basePostProcess}this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRPassPostProcess",function(){return _this.originalPostProcess},true));this._currentDepthOfFieldSource=this.originalPostProcess;if(this._vlsEnabled){this._createVolumetricLightPostProcess(scene,ratio);this.volumetricLightFinalPostProcess=new BABYLON.PostProcess("HDRVLSFinal","standard",[],[],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define PASS_POST_PROCESS",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRVLSFinal",function(){return _this.volumetricLightFinalPostProcess},true))}if(this._bloomEnabled){this._createDownSampleX4PostProcess(scene,ratio/2);this._createBrightPassPostProcess(scene,ratio/2);this._createBlurPostProcesses(scene,ratio/4,1);this._createTextureAdderPostProcess(scene,ratio);this.textureAdderFinalPostProcess=new BABYLON.PostProcess("HDRDepthOfFieldSource","standard",[],[],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define PASS_POST_PROCESS",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRBaseDepthOfFieldSource",function(){return _this.textureAdderFinalPostProcess},true))}if(this._lensFlareEnabled){this._createLensFlarePostProcess(scene,ratio);this.lensFlareFinalPostProcess=new BABYLON.PostProcess("HDRPostLensFlareDepthOfFieldSource","standard",[],[],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define PASS_POST_PROCESS",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRPostLensFlareDepthOfFieldSource",function(){return _this.lensFlareFinalPostProcess},true))}if(this._hdrEnabled){this._createLuminancePostProcesses(scene,this._floatTextureType);this._createHdrPostProcess(scene,ratio);this.hdrFinalPostProcess=new BABYLON.PostProcess("HDRPostHDReDepthOfFieldSource","standard",[],[],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define PASS_POST_PROCESS",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRPostHDReDepthOfFieldSource",function(){return _this.hdrFinalPostProcess},true))}if(this._depthOfFieldEnabled){this._createBlurPostProcesses(scene,ratio/2,3,"depthOfFieldBlurWidth");this._createDepthOfFieldPostProcess(scene,ratio)}if(this._motionBlurEnabled){this._createMotionBlurPostProcess(scene,ratio)}if(this._cameras!==null){this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}};StandardRenderingPipeline.prototype._createDownSampleX4PostProcess=function(scene,ratio){var _this=this;var downSampleX4Offsets=new Array(32);this.downSampleX4PostProcess=new BABYLON.PostProcess("HDRDownSampleX4","standard",["dsOffsets"],[],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define DOWN_SAMPLE_X4",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.downSampleX4PostProcess.onApply=function(effect){var id=0;for(var i=-2;i<2;i++){for(var j=-2;j<2;j++){downSampleX4Offsets[id]=(i+.5)*(1/_this.downSampleX4PostProcess.width);downSampleX4Offsets[id+1]=(j+.5)*(1/_this.downSampleX4PostProcess.height);id+=2}}effect.setArray2("dsOffsets",downSampleX4Offsets)};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRDownSampleX4",function(){return _this.downSampleX4PostProcess},true))};StandardRenderingPipeline.prototype._createBrightPassPostProcess=function(scene,ratio){var _this=this;var brightOffsets=new Array(8);this.brightPassPostProcess=new BABYLON.PostProcess("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define BRIGHT_PASS",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.brightPassPostProcess.onApply=function(effect){var sU=1/_this.brightPassPostProcess.width;var sV=1/_this.brightPassPostProcess.height;brightOffsets[0]=-.5*sU;brightOffsets[1]=.5*sV;brightOffsets[2]=.5*sU;brightOffsets[3]=.5*sV;brightOffsets[4]=-.5*sU;brightOffsets[5]=-.5*sV;brightOffsets[6]=.5*sU;brightOffsets[7]=-.5*sV;effect.setArray2("dsOffsets",brightOffsets);effect.setFloat("brightThreshold",_this.brightThreshold)};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRBrightPass",function(){return _this.brightPassPostProcess},true))};StandardRenderingPipeline.prototype._createBlurPostProcesses=function(scene,ratio,indice,blurWidthKey){var _this=this;if(blurWidthKey===void 0){blurWidthKey="blurWidth"}var engine=scene.getEngine();var blurX=new BABYLON.BlurPostProcess("HDRBlurH"+"_"+indice,new BABYLON.Vector2(1,0),this[blurWidthKey],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);var blurY=new BABYLON.BlurPostProcess("HDRBlurV"+"_"+indice,new BABYLON.Vector2(0,1),this[blurWidthKey],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);blurX.onActivateObservable.add(function(){var dw=blurX.width/engine.getRenderingCanvas().width;blurX.kernel=_this[blurWidthKey]*dw});blurY.onActivateObservable.add(function(){var dw=blurY.height/engine.getRenderingCanvas().height;blurY.kernel=_this.horizontalBlur?64*dw:_this[blurWidthKey]*dw});this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRBlurH"+indice,function(){return blurX},true));this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRBlurV"+indice,function(){return blurY},true));this.blurHPostProcesses.push(blurX);this.blurVPostProcesses.push(blurY)};StandardRenderingPipeline.prototype._createTextureAdderPostProcess=function(scene,ratio){var _this=this;this.textureAdderPostProcess=new BABYLON.PostProcess("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define TEXTURE_ADDER",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.textureAdderPostProcess.onApply=function(effect){effect.setTextureFromPostProcess("otherSampler",_this._vlsEnabled?_this._currentDepthOfFieldSource:_this.originalPostProcess);effect.setTexture("lensSampler",_this.lensTexture);effect.setFloat("exposure",_this.exposure);_this._currentDepthOfFieldSource=_this.textureAdderFinalPostProcess};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRTextureAdder",function(){return _this.textureAdderPostProcess},true))};StandardRenderingPipeline.prototype._createVolumetricLightPostProcess=function(scene,ratio){var _this=this;var geometryRenderer=scene.enableGeometryBufferRenderer();geometryRenderer.enablePosition=true;var geometry=geometryRenderer.getGBuffer();this.volumetricLightPostProcess=new BABYLON.PostProcess("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],ratio/8,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));var depthValues=BABYLON.Vector2.Zero();this.volumetricLightPostProcess.onApply=function(effect){if(_this.sourceLight&&_this.sourceLight.getShadowGenerator()){var generator=_this.sourceLight.getShadowGenerator();effect.setTexture("shadowMapSampler",generator.getShadowMap());effect.setTexture("positionSampler",geometry.textures[2]);effect.setColor3("sunColor",_this.sourceLight.diffuse);effect.setVector3("sunDirection",_this.sourceLight.getShadowDirection());effect.setVector3("cameraPosition",scene.activeCamera.globalPosition);effect.setMatrix("shadowViewProjection",generator.getTransformMatrix());effect.setFloat("scatteringCoefficient",_this.volumetricLightCoefficient);effect.setFloat("scatteringPower",_this.volumetricLightPower);depthValues.x=generator.getLight().getDepthMinZ(_this._scene.activeCamera);depthValues.y=generator.getLight().getDepthMaxZ(_this._scene.activeCamera);effect.setVector2("depthValues",depthValues)}};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRVLS",function(){return _this.volumetricLightPostProcess},true));this._createBlurPostProcesses(scene,ratio/4,0,"volumetricLightBlurScale");this.volumetricLightMergePostProces=new BABYLON.PostProcess("HDRVLSMerge","standard",[],["originalSampler"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define VLSMERGE");this.volumetricLightMergePostProces.onApply=function(effect){effect.setTextureFromPostProcess("originalSampler",_this.originalPostProcess);_this._currentDepthOfFieldSource=_this.volumetricLightFinalPostProcess};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRVLSMerge",function(){return _this.volumetricLightMergePostProces},true))};StandardRenderingPipeline.prototype._createLuminancePostProcesses=function(scene,textureType){var _this=this;var size=Math.pow(3,StandardRenderingPipeline.LuminanceSteps);this.luminancePostProcess=new BABYLON.PostProcess("HDRLuminance","standard",["lumOffsets"],[],{width:size,height:size},null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define LUMINANCE",textureType);var offsets=[];this.luminancePostProcess.onApply=function(effect){var sU=1/_this.luminancePostProcess.width;var sV=1/_this.luminancePostProcess.height;offsets[0]=-.5*sU;offsets[1]=.5*sV;offsets[2]=.5*sU;offsets[3]=.5*sV;offsets[4]=-.5*sU;offsets[5]=-.5*sV;offsets[6]=.5*sU;offsets[7]=-.5*sV;effect.setArray2("lumOffsets",offsets)};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRLuminance",function(){return _this.luminancePostProcess},true));for(var i=StandardRenderingPipeline.LuminanceSteps-1;i>=0;i--){var size=Math.pow(3,i);var defines="#define LUMINANCE_DOWN_SAMPLE\n";if(i===0){defines+="#define FINAL_DOWN_SAMPLER"}var postProcess=new BABYLON.PostProcess("HDRLuminanceDownSample"+i,"standard",["dsOffsets","halfDestPixelSize"],[],{width:size,height:size},null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,defines,textureType);this.luminanceDownSamplePostProcesses.push(postProcess)}var lastLuminance=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(function(pp,index){var downSampleOffsets=new Array(18);pp.onApply=function(effect){var id=0;for(var x=-1;x<2;x++){for(var y=-1;y<2;y++){downSampleOffsets[id]=x/lastLuminance.width;downSampleOffsets[id+1]=y/lastLuminance.height;id+=2}}effect.setArray2("dsOffsets",downSampleOffsets);effect.setFloat("halfDestPixelSize",.5/lastLuminance.width);if(index===_this.luminanceDownSamplePostProcesses.length-1){lastLuminance=_this.luminancePostProcess}else{lastLuminance=pp}};if(index===_this.luminanceDownSamplePostProcesses.length-1){pp.onAfterRender=function(effect){var pixel=scene.getEngine().readPixels(0,0,1,1);var bit_shift=new BABYLON.Vector4(1/(255*255*255),1/(255*255),1/255,1);_this._hdrCurrentLuminance=(pixel[0]*bit_shift.x+pixel[1]*bit_shift.y+pixel[2]*bit_shift.z+pixel[3]*bit_shift.w)/100}}_this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRLuminanceDownSample"+index,function(){return pp},true))})};StandardRenderingPipeline.prototype._createHdrPostProcess=function(scene,ratio){var _this=this;this.hdrPostProcess=new BABYLON.PostProcess("HDR","standard",["averageLuminance"],["textureAdderSampler"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define HDR",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);var outputLiminance=1;var time=0;var lastTime=0;this.hdrPostProcess.onApply=function(effect){effect.setTextureFromPostProcess("textureAdderSampler",_this._currentDepthOfFieldSource);time+=scene.getEngine().getDeltaTime();if(outputLiminance<0){outputLiminance=_this._hdrCurrentLuminance}else{var dt=(lastTime-time)/1e3;if(_this._hdrCurrentLuminance<outputLiminance+_this.hdrDecreaseRate*dt){outputLiminance+=_this.hdrDecreaseRate*dt}else if(_this._hdrCurrentLuminance>outputLiminance-_this.hdrIncreaseRate*dt){outputLiminance-=_this.hdrIncreaseRate*dt}else{outputLiminance=_this._hdrCurrentLuminance}}outputLiminance=BABYLON.Scalar.Clamp(outputLiminance,_this.hdrMinimumLuminance,1e20);effect.setFloat("averageLuminance",outputLiminance);lastTime=time;_this._currentDepthOfFieldSource=_this.hdrFinalPostProcess};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDR",function(){return _this.hdrPostProcess},true))};StandardRenderingPipeline.prototype._createLensFlarePostProcess=function(scene,ratio){var _this=this;this.lensFlarePostProcess=new BABYLON.PostProcess("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],ratio/2,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define LENS_FLARE",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRLensFlare",function(){return _this.lensFlarePostProcess},true));this._createBlurPostProcesses(scene,ratio/4,2);this.lensFlareComposePostProcess=new BABYLON.PostProcess("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define LENS_FLARE_COMPOSE",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRLensFlareCompose",function(){return _this.lensFlareComposePostProcess},true));var resolution=new BABYLON.Vector2(0,0);this.lensFlarePostProcess.onApply=function(effect){effect.setTextureFromPostProcess("textureSampler",_this._bloomEnabled?_this.blurHPostProcesses[0]:_this.originalPostProcess);effect.setTexture("lensColorSampler",_this.lensColorTexture);effect.setFloat("strength",_this.lensFlareStrength);effect.setFloat("ghostDispersal",_this.lensFlareGhostDispersal);effect.setFloat("haloWidth",_this.lensFlareHaloWidth);resolution.x=_this.lensFlarePostProcess.width;resolution.y=_this.lensFlarePostProcess.height;effect.setVector2("resolution",resolution);effect.setFloat("distortionStrength",_this.lensFlareDistortionStrength)};var scaleBias1=BABYLON.Matrix.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1);var scaleBias2=BABYLON.Matrix.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(effect){effect.setTextureFromPostProcess("otherSampler",_this._currentDepthOfFieldSource);effect.setTexture("lensDirtSampler",_this.lensFlareDirtTexture);effect.setTexture("lensStarSampler",_this.lensStarTexture);var camerax=_this._scene.activeCamera.getViewMatrix().getRow(0);var cameraz=_this._scene.activeCamera.getViewMatrix().getRow(2);var camRot=BABYLON.Vector3.Dot(camerax.toVector3(),new BABYLON.Vector3(1,0,0))+BABYLON.Vector3.Dot(cameraz.toVector3(),new BABYLON.Vector3(0,0,1));camRot*=4;var starRotation=BABYLON.Matrix.FromValues(Math.cos(camRot)*.5,-Math.sin(camRot),0,0,Math.sin(camRot),Math.cos(camRot)*.5,0,0,0,0,1,0,0,0,0,1);var lensStarMatrix=scaleBias2.multiply(starRotation).multiply(scaleBias1);effect.setMatrix("lensStarMatrix",lensStarMatrix);_this._currentDepthOfFieldSource=_this.lensFlareFinalPostProcess}};StandardRenderingPipeline.prototype._createDepthOfFieldPostProcess=function(scene,ratio){var _this=this;this.depthOfFieldPostProcess=new BABYLON.PostProcess("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define DEPTH_OF_FIELD",BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this.depthOfFieldPostProcess.onApply=function(effect){effect.setTextureFromPostProcess("otherSampler",_this._currentDepthOfFieldSource);effect.setTexture("depthSampler",_this._getDepthTexture());effect.setFloat("distance",_this.depthOfFieldDistance)};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRDepthOfField",function(){return _this.depthOfFieldPostProcess},true))};StandardRenderingPipeline.prototype._createMotionBlurPostProcess=function(scene,ratio){var _this=this;this.motionBlurPostProcess=new BABYLON.PostProcess("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],ratio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,scene.getEngine(),false,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);var motionScale=0;var prevViewProjection=BABYLON.Matrix.Identity();var invViewProjection=BABYLON.Matrix.Identity();var viewProjection=BABYLON.Matrix.Identity();var screenSize=BABYLON.Vector2.Zero();this.motionBlurPostProcess.onApply=function(effect){viewProjection=scene.getProjectionMatrix().multiply(scene.getViewMatrix());viewProjection.invertToRef(invViewProjection);effect.setMatrix("inverseViewProjection",invViewProjection);effect.setMatrix("prevViewProjection",prevViewProjection);prevViewProjection=viewProjection;screenSize.x=_this.motionBlurPostProcess.width;screenSize.y=_this.motionBlurPostProcess.height;effect.setVector2("screenSize",screenSize);motionScale=scene.getEngine().getFps()/60;effect.setFloat("motionScale",motionScale);effect.setFloat("motionStrength",_this.motionStrength);effect.setTexture("depthSampler",_this._getDepthTexture())};this.addEffect(new BABYLON.PostProcessRenderEffect(scene.getEngine(),"HDRMotionBlur",function(){return _this.motionBlurPostProcess},true))};StandardRenderingPipeline.prototype._getDepthTexture=function(){if(this._scene.getEngine().getCaps().drawBuffersExtension){return this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]}return this._scene.enableDepthRenderer().getDepthMap()};StandardRenderingPipeline.prototype._disposePostProcesses=function(){for(var i=0;i<this._cameras.length;i++){var camera=this._cameras[i];if(this.originalPostProcess){this.originalPostProcess.dispose(camera)}if(this.downSampleX4PostProcess){this.downSampleX4PostProcess.dispose(camera)}if(this.brightPassPostProcess){this.brightPassPostProcess.dispose(camera)}if(this.textureAdderPostProcess){this.textureAdderPostProcess.dispose(camera)}if(this.textureAdderFinalPostProcess){this.textureAdderFinalPostProcess.dispose(camera)}if(this.volumetricLightPostProcess){this.volumetricLightPostProcess.dispose(camera)}if(this.volumetricLightSmoothXPostProcess){this.volumetricLightSmoothXPostProcess.dispose(camera)}if(this.volumetricLightSmoothYPostProcess){this.volumetricLightSmoothYPostProcess.dispose(camera)}if(this.volumetricLightMergePostProces){this.volumetricLightMergePostProces.dispose(camera)}if(this.volumetricLightFinalPostProcess){this.volumetricLightFinalPostProcess.dispose(camera)}if(this.lensFlarePostProcess){this.lensFlarePostProcess.dispose(camera)}if(this.lensFlareComposePostProcess){this.lensFlareComposePostProcess.dispose(camera)}for(var j=0;j<this.luminanceDownSamplePostProcesses.length;j++){this.luminanceDownSamplePostProcesses[j].dispose(camera)}if(this.luminancePostProcess){this.luminancePostProcess.dispose(camera)}if(this.hdrPostProcess){this.hdrPostProcess.dispose(camera)}if(this.hdrFinalPostProcess){this.hdrFinalPostProcess.dispose(camera)}if(this.depthOfFieldPostProcess){this.depthOfFieldPostProcess.dispose(camera)}if(this.motionBlurPostProcess){this.motionBlurPostProcess.dispose(camera)}for(var j=0;j<this.blurHPostProcesses.length;j++){this.blurHPostProcesses[j].dispose(camera)}for(var j=0;j<this.blurVPostProcesses.length;j++){this.blurVPostProcesses[j].dispose(camera)}}this.originalPostProcess=null;this.downSampleX4PostProcess=null;this.brightPassPostProcess=null;this.textureAdderPostProcess=null;this.textureAdderFinalPostProcess=null;this.volumetricLightPostProcess=null;this.volumetricLightSmoothXPostProcess=null;this.volumetricLightSmoothYPostProcess=null;this.volumetricLightMergePostProces=null;this.volumetricLightFinalPostProcess=null;this.lensFlarePostProcess=null;this.lensFlareComposePostProcess=null;this.luminancePostProcess=null;this.hdrPostProcess=null;this.hdrFinalPostProcess=null;this.depthOfFieldPostProcess=null;this.motionBlurPostProcess=null;this.luminanceDownSamplePostProcesses=[];this.blurHPostProcesses=[];this.blurVPostProcesses=[]};StandardRenderingPipeline.prototype.dispose=function(){this._disposePostProcesses();this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras);_super.prototype.dispose.call(this)};StandardRenderingPipeline.prototype.serialize=function(){var serializationObject=BABYLON.SerializationHelper.Serialize(this);serializationObject.customType="StandardRenderingPipeline";return serializationObject};StandardRenderingPipeline.Parse=function(source,scene,rootUrl){return BABYLON.SerializationHelper.Parse(function(){return new StandardRenderingPipeline(source._name,scene,source._ratio)},source,scene,rootUrl)};StandardRenderingPipeline.LuminanceSteps=6;__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"brightThreshold",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"blurWidth",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"horizontalBlur",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"exposure",void 0);__decorate([BABYLON.serializeAsTexture("lensTexture")],StandardRenderingPipeline.prototype,"lensTexture",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"volumetricLightCoefficient",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"volumetricLightPower",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"volumetricLightBlurScale",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"hdrMinimumLuminance",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"hdrDecreaseRate",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"hdrIncreaseRate",void 0);__decorate([BABYLON.serializeAsTexture("lensColorTexture")],StandardRenderingPipeline.prototype,"lensColorTexture",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"lensFlareStrength",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"lensFlareGhostDispersal",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"lensFlareHaloWidth",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"lensFlareDistortionStrength",void 0);__decorate([BABYLON.serializeAsTexture("lensStarTexture")],StandardRenderingPipeline.prototype,"lensStarTexture",void 0);__decorate([BABYLON.serializeAsTexture("lensFlareDirtTexture")],StandardRenderingPipeline.prototype,"lensFlareDirtTexture",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"depthOfFieldDistance",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"depthOfFieldBlurWidth",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"motionStrength",void 0);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"BloomEnabled",null);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"DepthOfFieldEnabled",null);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"LensFlareEnabled",null);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"HDREnabled",null);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"VLSEnabled",null);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"MotionBlurEnabled",null);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"volumetricLightStepsCount",null);__decorate([BABYLON.serialize()],StandardRenderingPipeline.prototype,"motionBlurSamples",null);return StandardRenderingPipeline}(BABYLON.PostProcessRenderPipeline);BABYLON.StandardRenderingPipeline=StandardRenderingPipeline})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FxaaPostProcess=function(_super){__extends(FxaaPostProcess,_super);function FxaaPostProcess(name,options,camera,samplingMode,engine,reusable,textureType){if(textureType===void 0){textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}var _this=_super.call(this,name,"fxaa",["texelSize"],null,options,camera,samplingMode||BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,reusable,null,textureType,"fxaa")||this;_this.onApplyObservable.add(function(effect){var texelSize=_this.texelSize;effect.setFloat2("texelSize",texelSize.x,texelSize.y)});return _this}return FxaaPostProcess}(BABYLON.PostProcess);BABYLON.FxaaPostProcess=FxaaPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DefaultRenderingPipeline=function(_super){__extends(DefaultRenderingPipeline,_super);function DefaultRenderingPipeline(name,hdr,scene,cameras,automaticBuild){if(automaticBuild===void 0){automaticBuild=true}var _this=_super.call(this,scene.getEngine(),name)||this;_this.PassPostProcessId="PassPostProcessEffect";_this.HighLightsPostProcessId="HighLightsPostProcessEffect";_this.BlurXPostProcessId="BlurXPostProcessEffect";_this.BlurYPostProcessId="BlurYPostProcessEffect";_this.CopyBackPostProcessId="CopyBackPostProcessEffect";_this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect";_this.FxaaPostProcessId="FxaaPostProcessEffect";_this.FinalMergePostProcessId="FinalMergePostProcessEffect";_this.animations=[];_this._bloomEnabled=false;_this._fxaaEnabled=false;_this._imageProcessingEnabled=true;_this._bloomScale=.6;_this._buildAllowed=true;_this.bloomKernel=64;_this._bloomWeight=.15;_this._cameras=cameras||[];_this._buildAllowed=automaticBuild;_this._scene=scene;var caps=_this._scene.getEngine().getCaps();_this._hdr=hdr&&(caps.textureHalfFloatRender||caps.textureFloatRender);if(_this._hdr){if(caps.textureHalfFloatRender){_this._defaultPipelineTextureType=BABYLON.Engine.TEXTURETYPE_HALF_FLOAT}else if(caps.textureFloatRender){_this._defaultPipelineTextureType=BABYLON.Engine.TEXTURETYPE_FLOAT}}else{_this._defaultPipelineTextureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}scene.postProcessRenderPipelineManager.addPipeline(_this);_this._buildPipeline();return _this}Object.defineProperty(DefaultRenderingPipeline.prototype,"bloomWeight",{get:function(){return this._bloomWeight},set:function(value){if(this._bloomWeight===value){return}this._bloomWeight=value;if(this._hdr&&this.copyBack){this.copyBack.alphaConstants=new BABYLON.Color4(value,value,value,value)}},enumerable:true,configurable:true});Object.defineProperty(DefaultRenderingPipeline.prototype,"bloomScale",{get:function(){return this._bloomScale},set:function(value){if(this._bloomScale===value){return}this._bloomScale=value;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(DefaultRenderingPipeline.prototype,"bloomEnabled",{get:function(){return this._bloomEnabled},set:function(enabled){if(this._bloomEnabled===enabled){return}this._bloomEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(DefaultRenderingPipeline.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(enabled){if(this._fxaaEnabled===enabled){return}this._fxaaEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(DefaultRenderingPipeline.prototype,"imageProcessingEnabled",{get:function(){return this._imageProcessingEnabled},set:function(enabled){if(this._imageProcessingEnabled===enabled){return}this._imageProcessingEnabled=enabled;this._buildPipeline()},enumerable:true,configurable:true});DefaultRenderingPipeline.prototype.prepare=function(){var previousState=this._buildAllowed;this._buildAllowed=true;this._buildPipeline();this._buildAllowed=previousState};DefaultRenderingPipeline.prototype._buildPipeline=function(){var _this=this;if(!this._buildAllowed){return}var engine=this._scene.getEngine();this._disposePostProcesses();this._reset();if(this.bloomEnabled){this.pass=new BABYLON.PassPostProcess("sceneRenderTarget",1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._defaultPipelineTextureType);this.addEffect(new BABYLON.PostProcessRenderEffect(engine,this.PassPostProcessId,function(){return _this.pass},true));if(!this._hdr){this.highlights=new BABYLON.HighlightsPostProcess("highlights",this.bloomScale,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._defaultPipelineTextureType);this.addEffect(new BABYLON.PostProcessRenderEffect(engine,this.HighLightsPostProcessId,function(){return _this.highlights},true));this.highlights.autoClear=false;this.highlights.alwaysForcePOT=true}this.blurX=new BABYLON.BlurPostProcess("horizontal blur",new BABYLON.Vector2(1,0),10,this.bloomScale,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._defaultPipelineTextureType);this.addEffect(new BABYLON.PostProcessRenderEffect(engine,this.BlurXPostProcessId,function(){return _this.blurX},true));this.blurX.alwaysForcePOT=true;this.blurX.autoClear=false;this.blurX.onActivateObservable.add(function(){var dw=_this.blurX.width/engine.getRenderingCanvas().width;_this.blurX.kernel=_this.bloomKernel*dw});this.blurY=new BABYLON.BlurPostProcess("vertical blur",new BABYLON.Vector2(0,1),10,this.bloomScale,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._defaultPipelineTextureType);this.addEffect(new BABYLON.PostProcessRenderEffect(engine,this.BlurYPostProcessId,function(){return _this.blurY},true));this.blurY.alwaysForcePOT=true;this.blurY.autoClear=false;this.blurY.onActivateObservable.add(function(){var dh=_this.blurY.height/engine.getRenderingCanvas().height;_this.blurY.kernel=_this.bloomKernel*dh});this.copyBack=new BABYLON.PassPostProcess("bloomBlendBlit",this.bloomScale,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._defaultPipelineTextureType);this.addEffect(new BABYLON.PostProcessRenderEffect(engine,this.CopyBackPostProcessId,function(){return _this.copyBack},true));this.copyBack.alwaysForcePOT=true;if(this._hdr){this.copyBack.alphaMode=BABYLON.Engine.ALPHA_INTERPOLATE;var w=this.bloomWeight;this.copyBack.alphaConstants=new BABYLON.Color4(w,w,w,w)}else{this.copyBack.alphaMode=BABYLON.Engine.ALPHA_SCREENMODE}this.copyBack.autoClear=false}if(this._imageProcessingEnabled){this.imageProcessing=new BABYLON.ImageProcessingPostProcess("imageProcessing",1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._defaultPipelineTextureType);if(this._hdr){this.addEffect(new BABYLON.PostProcessRenderEffect(engine,this.ImageProcessingPostProcessId,function(){return _this.imageProcessing},true))}else{this._scene.imageProcessingConfiguration.applyByPostProcess=false}}if(this.fxaaEnabled){this.fxaa=new BABYLON.FxaaPostProcess("fxaa",1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._defaultPipelineTextureType);this.addEffect(new BABYLON.PostProcessRenderEffect(engine,this.FxaaPostProcessId,function(){return _this.fxaa},true));this.fxaa.autoClear=!this.bloomEnabled&&(!this._hdr||!this.imageProcessing)}else{this.finalMerge=new BABYLON.PassPostProcess("finalMerge",1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,engine,false,this._defaultPipelineTextureType);this.addEffect(new BABYLON.PostProcessRenderEffect(engine,this.FinalMergePostProcessId,function(){return _this.finalMerge},true));this.finalMerge.autoClear=!this.bloomEnabled&&(!this._hdr||!this.imageProcessing)}if(this.bloomEnabled){if(this._hdr){this.copyBack.shareOutputWith(this.blurX);if(this.imageProcessing){this.imageProcessing.shareOutputWith(this.pass);this.imageProcessing.autoClear=false}else if(this.fxaa){this.fxaa.shareOutputWith(this.pass)}else{this.finalMerge.shareOutputWith(this.pass)}}else{if(this.fxaa){this.fxaa.shareOutputWith(this.pass)}else{this.finalMerge.shareOutputWith(this.pass)}}}if(this._cameras!==null){this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}};DefaultRenderingPipeline.prototype._disposePostProcesses=function(){for(var i=0;i<this._cameras.length;i++){var camera=this._cameras[i];if(this.pass){this.pass.dispose(camera)}if(this.highlights){this.highlights.dispose(camera)}if(this.blurX){this.blurX.dispose(camera)}if(this.blurY){this.blurY.dispose(camera)}if(this.copyBack){this.copyBack.dispose(camera)}if(this.imageProcessing){this.imageProcessing.dispose(camera)}if(this.fxaa){this.fxaa.dispose(camera)}if(this.finalMerge){this.finalMerge.dispose(camera)}}this.pass=null;this.highlights=null;this.blurX=null;this.blurY=null;this.copyBack=null;this.imageProcessing=null;this.fxaa=null;this.finalMerge=null};DefaultRenderingPipeline.prototype.dispose=function(){this._disposePostProcesses();this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras);_super.prototype.dispose.call(this)};DefaultRenderingPipeline.prototype.serialize=function(){var serializationObject=BABYLON.SerializationHelper.Serialize(this);serializationObject.customType="DefaultRenderingPipeline";return serializationObject};DefaultRenderingPipeline.Parse=function(source,scene,rootUrl){return BABYLON.SerializationHelper.Parse(function(){return new DefaultRenderingPipeline(source._name,source._name._hdr,scene)},source,scene,rootUrl)};__decorate([BABYLON.serialize()],DefaultRenderingPipeline.prototype,"bloomKernel",void 0);__decorate([BABYLON.serialize()],DefaultRenderingPipeline.prototype,"_bloomWeight",void 0);__decorate([BABYLON.serialize()],DefaultRenderingPipeline.prototype,"_hdr",void 0);__decorate([BABYLON.serialize()],DefaultRenderingPipeline.prototype,"bloomWeight",null);__decorate([BABYLON.serialize()],DefaultRenderingPipeline.prototype,"bloomScale",null);__decorate([BABYLON.serialize()],DefaultRenderingPipeline.prototype,"bloomEnabled",null);__decorate([BABYLON.serialize()],DefaultRenderingPipeline.prototype,"fxaaEnabled",null);__decorate([BABYLON.serialize()],DefaultRenderingPipeline.prototype,"imageProcessingEnabled",null);return DefaultRenderingPipeline}(BABYLON.PostProcessRenderPipeline);BABYLON.DefaultRenderingPipeline=DefaultRenderingPipeline})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var GeometryBufferRenderer=function(){function GeometryBufferRenderer(scene,ratio){if(ratio===void 0){ratio=1}this._enablePosition=false;this._scene=scene;this._ratio=ratio;this._createRenderTargets()}Object.defineProperty(GeometryBufferRenderer.prototype,"renderList",{set:function(meshes){this._multiRenderTarget.renderList=meshes},enumerable:true,configurable:true});Object.defineProperty(GeometryBufferRenderer.prototype,"isSupported",{get:function(){return this._multiRenderTarget.isSupported},enumerable:true,configurable:true});Object.defineProperty(GeometryBufferRenderer.prototype,"enablePosition",{get:function(){return this._enablePosition},set:function(enable){this._enablePosition=enable;this.dispose();this._createRenderTargets()},enumerable:true,configurable:true});GeometryBufferRenderer.prototype.isReady=function(subMesh,useInstances){var material=subMesh.getMaterial();if(material&&material.disableDepthWrite){return false}var defines=[];var attribs=[BABYLON.VertexBuffer.PositionKind,BABYLON.VertexBuffer.NormalKind];var mesh=subMesh.getMesh();if(material&&material.needAlphaTesting()){defines.push("#define ALPHATEST");if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){attribs.push(BABYLON.VertexBuffer.UVKind);defines.push("#define UV1")}if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)){attribs.push(BABYLON.VertexBuffer.UV2Kind);defines.push("#define UV2")}}if(this._enablePosition){defines.push("#define POSITION")}if(mesh.useBones&&mesh.computeBonesUsingShaders){attribs.push(BABYLON.VertexBuffer.MatricesIndicesKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsKind);if(mesh.numBoneInfluencers>4){attribs.push(BABYLON.VertexBuffer.MatricesIndicesExtraKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsExtraKind)}defines.push("#define NUM_BONE_INFLUENCERS "+mesh.numBoneInfluencers);defines.push("#define BonesPerMesh "+(mesh.skeleton.bones.length+1))}else{defines.push("#define NUM_BONE_INFLUENCERS 0")}if(useInstances){defines.push("#define INSTANCES");attribs.push("world0");attribs.push("world1");attribs.push("world2");attribs.push("world3")}var join=defines.join("\n");if(this._cachedDefines!==join){this._cachedDefines=join;this._effect=this._scene.getEngine().createEffect("geometry",attribs,["world","mBones","viewProjection","diffuseMatrix","view"],["diffuseSampler"],join,null,null,null,{buffersCount:this._enablePosition?3:2})}return this._effect.isReady()};GeometryBufferRenderer.prototype.getGBuffer=function(){return this._multiRenderTarget};GeometryBufferRenderer.prototype.dispose=function(){this.getGBuffer().dispose()};GeometryBufferRenderer.prototype._createRenderTargets=function(){var _this=this;var engine=this._scene.getEngine();var count=this._enablePosition?3:2;this._multiRenderTarget=new BABYLON.MultiRenderTarget("gBuffer",{width:engine.getRenderWidth()*this._ratio,height:engine.getRenderHeight()*this._ratio},count,this._scene,{generateMipMaps:false,generateDepthTexture:true});if(!this.isSupported){return null}this._multiRenderTarget.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;this._multiRenderTarget.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;this._multiRenderTarget.refreshRate=1;this._multiRenderTarget.renderParticles=false;this._multiRenderTarget.renderList=null;this._multiRenderTarget.onClearObservable.add(function(engine){engine.clear(new BABYLON.Color4(0,0,0,1),true,true,true)});var renderSubMesh=function(subMesh){var mesh=subMesh.getRenderingMesh();var scene=_this._scene;var engine=scene.getEngine();engine.setState(subMesh.getMaterial().backFaceCulling);var batch=mesh._getInstancesRenderList(subMesh._id);if(batch.mustReturn){return}var hardwareInstancedRendering=engine.getCaps().instancedArrays&&batch.visibleInstances[subMesh._id]!==null;if(_this.isReady(subMesh,hardwareInstancedRendering)){engine.enableEffect(_this._effect);mesh._bind(subMesh,_this._effect,BABYLON.Material.TriangleFillMode);var material=subMesh.getMaterial();_this._effect.setMatrix("viewProjection",scene.getTransformMatrix());_this._effect.setMatrix("view",scene.getViewMatrix());if(material&&material.needAlphaTesting()){var alphaTexture=material.getAlphaTestTexture();_this._effect.setTexture("diffuseSampler",alphaTexture);_this._effect.setMatrix("diffuseMatrix",alphaTexture.getTextureMatrix())}if(mesh.useBones&&mesh.computeBonesUsingShaders){_this._effect.setMatrices("mBones",mesh.skeleton.getTransformMatrices(mesh))}mesh._processRendering(subMesh,_this._effect,BABYLON.Material.TriangleFillMode,batch,hardwareInstancedRendering,function(isInstance,world){return _this._effect.setMatrix("world",world)})}};this._multiRenderTarget.customRenderFunction=function(opaqueSubMeshes,alphaTestSubMeshes,transparentSubMeshes,depthOnlySubMeshes){var index;if(depthOnlySubMeshes.length){engine.setColorWrite(false);for(index=0;index<depthOnlySubMeshes.length;index++){renderSubMesh(depthOnlySubMeshes.data[index])}engine.setColorWrite(true)}for(index=0;index<opaqueSubMeshes.length;index++){renderSubMesh(opaqueSubMeshes.data[index])}for(index=0;index<alphaTestSubMeshes.length;index++){renderSubMesh(alphaTestSubMeshes.data[index])}}};return GeometryBufferRenderer}();BABYLON.GeometryBufferRenderer=GeometryBufferRenderer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var RefractionPostProcess=function(_super){__extends(RefractionPostProcess,_super);function RefractionPostProcess(name,refractionTextureUrl,color,depth,colorLevel,options,camera,samplingMode,engine,reusable){var _this=_super.call(this,name,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],options,camera,samplingMode,engine,reusable)||this;_this.color=color;_this.depth=depth;_this.colorLevel=colorLevel;_this.onActivateObservable.add(function(cam){_this._refRexture=_this._refRexture||new BABYLON.Texture(refractionTextureUrl,cam.getScene())});_this.onApplyObservable.add(function(effect){effect.setColor3("baseColor",_this.color);effect.setFloat("depth",_this.depth);effect.setFloat("colorLevel",_this.colorLevel);effect.setTexture("refractionSampler",_this._refRexture)});return _this}RefractionPostProcess.prototype.dispose=function(camera){if(this._refRexture){this._refRexture.dispose()}_super.prototype.dispose.call(this,camera)};return RefractionPostProcess}(BABYLON.PostProcess);BABYLON.RefractionPostProcess=RefractionPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BlackAndWhitePostProcess=function(_super){__extends(BlackAndWhitePostProcess,_super);function BlackAndWhitePostProcess(name,options,camera,samplingMode,engine,reusable){var _this=_super.call(this,name,"blackAndWhite",["degree"],null,options,camera,samplingMode,engine,reusable)||this;_this.degree=1;_this.onApplyObservable.add(function(effect){effect.setFloat("degree",_this.degree)});return _this}return BlackAndWhitePostProcess}(BABYLON.PostProcess);BABYLON.BlackAndWhitePostProcess=BlackAndWhitePostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ConvolutionPostProcess=function(_super){__extends(ConvolutionPostProcess,_super);function ConvolutionPostProcess(name,kernel,options,camera,samplingMode,engine,reusable){var _this=_super.call(this,name,"convolution",["kernel","screenSize"],null,options,camera,samplingMode,engine,reusable)||this;_this.kernel=kernel;_this.onApply=function(effect){effect.setFloat2("screenSize",_this.width,_this.height);effect.setArray("kernel",_this.kernel)};return _this}ConvolutionPostProcess.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1];ConvolutionPostProcess.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0];ConvolutionPostProcess.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1];ConvolutionPostProcess.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0];ConvolutionPostProcess.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2];ConvolutionPostProcess.GaussianKernel=[0,1,0,1,1,1,0,1,0];return ConvolutionPostProcess}(BABYLON.PostProcess);BABYLON.ConvolutionPostProcess=ConvolutionPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FilterPostProcess=function(_super){__extends(FilterPostProcess,_super);function FilterPostProcess(name,kernelMatrix,options,camera,samplingMode,engine,reusable){var _this=_super.call(this,name,"filter",["kernelMatrix"],null,options,camera,samplingMode,engine,reusable)||this;_this.kernelMatrix=kernelMatrix;_this.onApply=function(effect){effect.setMatrix("kernelMatrix",_this.kernelMatrix)};return _this}return FilterPostProcess}(BABYLON.PostProcess);BABYLON.FilterPostProcess=FilterPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VolumetricLightScatteringPostProcess=function(_super){__extends(VolumetricLightScatteringPostProcess,_super);function VolumetricLightScatteringPostProcess(name,ratio,camera,mesh,samples,samplingMode,engine,reusable,scene){if(samples===void 0){samples=100}if(samplingMode===void 0){samplingMode=BABYLON.Texture.BILINEAR_SAMPLINGMODE}var _this=_super.call(this,name,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],ratio.postProcessRatio||ratio,camera,samplingMode,engine,reusable,"#define NUM_SAMPLES "+samples)||this;_this._screenCoordinates=BABYLON.Vector2.Zero();_this.customMeshPosition=BABYLON.Vector3.Zero();_this.useCustomMeshPosition=false;_this.invert=true;_this.excludedMeshes=new Array;_this.exposure=.3;_this.decay=.96815;_this.weight=.58767;_this.density=.926;scene=camera===null?scene:camera.getScene();var engine=scene.getEngine();_this._viewPort=new BABYLON.Viewport(0,0,1,1).toGlobal(engine.getRenderWidth(),engine.getRenderHeight());_this.mesh=mesh!==null?mesh:VolumetricLightScatteringPostProcess.CreateDefaultMesh("VolumetricLightScatteringMesh",scene);_this._createPass(scene,ratio.passRatio||ratio);_this.onActivate=function(camera){if(!_this.isSupported){_this.dispose(camera)}_this.onActivate=null};_this.onApplyObservable.add(function(effect){_this._updateMeshScreenCoordinates(scene);effect.setTexture("lightScatteringSampler",_this._volumetricLightScatteringRTT);effect.setFloat("exposure",_this.exposure);effect.setFloat("decay",_this.decay);effect.setFloat("weight",_this.weight);effect.setFloat("density",_this.density);effect.setVector2("meshPositionOnScreen",_this._screenCoordinates)});return _this}Object.defineProperty(VolumetricLightScatteringPostProcess.prototype,"useDiffuseColor",{get:function(){BABYLON.Tools.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead");return false},set:function(useDiffuseColor){BABYLON.Tools.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")},enumerable:true,configurable:true});VolumetricLightScatteringPostProcess.prototype.getClassName=function(){return"VolumetricLightScatteringPostProcess"};VolumetricLightScatteringPostProcess.prototype.isReady=function(subMesh,useInstances){var mesh=subMesh.getMesh();if(mesh===this.mesh){return mesh.material.isReady(mesh)}var defines=[];var attribs=[BABYLON.VertexBuffer.PositionKind];var material=subMesh.getMaterial();if(material){if(material.needAlphaTesting()){defines.push("#define ALPHATEST")}if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){attribs.push(BABYLON.VertexBuffer.UVKind);defines.push("#define UV1")}if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)){attribs.push(BABYLON.VertexBuffer.UV2Kind);defines.push("#define UV2")}}if(mesh.useBones&&mesh.computeBonesUsingShaders){attribs.push(BABYLON.VertexBuffer.MatricesIndicesKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsKind);defines.push("#define NUM_BONE_INFLUENCERS "+mesh.numBoneInfluencers);defines.push("#define BonesPerMesh "+(mesh.skeleton.bones.length+1))}else{defines.push("#define NUM_BONE_INFLUENCERS 0")}if(useInstances){defines.push("#define INSTANCES");attribs.push("world0");attribs.push("world1");attribs.push("world2");attribs.push("world3")}var join=defines.join("\n");if(this._cachedDefines!==join){this._cachedDefines=join;this._volumetricLightScatteringPass=mesh.getScene().getEngine().createEffect({vertexElement:"depth",fragmentElement:"volumetricLightScatteringPass"},attribs,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],join)}return this._volumetricLightScatteringPass.isReady()};VolumetricLightScatteringPostProcess.prototype.setCustomMeshPosition=function(position){this.customMeshPosition=position};VolumetricLightScatteringPostProcess.prototype.getCustomMeshPosition=function(){return this.customMeshPosition};VolumetricLightScatteringPostProcess.prototype.dispose=function(camera){var rttIndex=camera.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);if(rttIndex!==-1){camera.getScene().customRenderTargets.splice(rttIndex,1)}this._volumetricLightScatteringRTT.dispose();_super.prototype.dispose.call(this,camera)};VolumetricLightScatteringPostProcess.prototype.getPass=function(){return this._volumetricLightScatteringRTT};VolumetricLightScatteringPostProcess.prototype._meshExcluded=function(mesh){if(this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(mesh)!==-1){return true}return false};VolumetricLightScatteringPostProcess.prototype._createPass=function(scene,ratio){var _this=this;var engine=scene.getEngine();this._volumetricLightScatteringRTT=new BABYLON.RenderTargetTexture("volumetricLightScatteringMap",{width:engine.getRenderWidth()*ratio,height:engine.getRenderHeight()*ratio},scene,false,true,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this._volumetricLightScatteringRTT.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;this._volumetricLightScatteringRTT.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;this._volumetricLightScatteringRTT.renderList=null;this._volumetricLightScatteringRTT.renderParticles=false;var camera=this.getCamera();if(camera){camera.customRenderTargets.push(this._volumetricLightScatteringRTT)}else{scene.customRenderTargets.push(this._volumetricLightScatteringRTT)}var renderSubMesh=function(subMesh){var mesh=subMesh.getRenderingMesh();if(_this._meshExcluded(mesh)){return}var scene=mesh.getScene();var engine=scene.getEngine();engine.setState(subMesh.getMaterial().backFaceCulling);var batch=mesh._getInstancesRenderList(subMesh._id);if(batch.mustReturn){return}var hardwareInstancedRendering=engine.getCaps().instancedArrays&&batch.visibleInstances[subMesh._id]!==null;if(_this.isReady(subMesh,hardwareInstancedRendering)){var effect=_this._volumetricLightScatteringPass;if(mesh===_this.mesh){if(subMesh.effect){effect=subMesh.effect}else{effect=subMesh.getMaterial().getEffect()}}engine.enableEffect(effect);mesh._bind(subMesh,effect,BABYLON.Material.TriangleFillMode);if(mesh===_this.mesh){subMesh.getMaterial().bind(mesh.getWorldMatrix(),mesh)}else{var material=subMesh.getMaterial();_this._volumetricLightScatteringPass.setMatrix("viewProjection",scene.getTransformMatrix());if(material&&material.needAlphaTesting()){var alphaTexture=material.getAlphaTestTexture();_this._volumetricLightScatteringPass.setTexture("diffuseSampler",alphaTexture);if(alphaTexture){_this._volumetricLightScatteringPass.setMatrix("diffuseMatrix",alphaTexture.getTextureMatrix())}}if(mesh.useBones&&mesh.computeBonesUsingShaders){_this._volumetricLightScatteringPass.setMatrices("mBones",mesh.skeleton.getTransformMatrices(mesh))}}mesh._processRendering(subMesh,_this._volumetricLightScatteringPass,BABYLON.Material.TriangleFillMode,batch,hardwareInstancedRendering,function(isInstance,world){return effect.setMatrix("world",world)})}};var savedSceneClearColor;var sceneClearColor=new BABYLON.Color4(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){savedSceneClearColor=scene.clearColor;scene.clearColor=sceneClearColor});this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){scene.clearColor=savedSceneClearColor});this._volumetricLightScatteringRTT.customRenderFunction=function(opaqueSubMeshes,alphaTestSubMeshes,transparentSubMeshes,depthOnlySubMeshes){var engine=scene.getEngine();var index;if(depthOnlySubMeshes.length){engine.setColorWrite(false);for(index=0;index<depthOnlySubMeshes.length;index++){renderSubMesh(depthOnlySubMeshes.data[index])}engine.setColorWrite(true)}for(index=0;index<opaqueSubMeshes.length;index++){renderSubMesh(opaqueSubMeshes.data[index])}engine.setAlphaTesting(true);for(index=0;index<alphaTestSubMeshes.length;index++){renderSubMesh(alphaTestSubMeshes.data[index])}engine.setAlphaTesting(false);if(transparentSubMeshes.length){for(index=0;index<transparentSubMeshes.length;index++){var submesh=transparentSubMeshes.data[index];submesh._alphaIndex=submesh.getMesh().alphaIndex;submesh._distanceToCamera=submesh.getBoundingInfo().boundingSphere.centerWorld.subtract(scene.activeCamera.position).length()}var sortedArray=transparentSubMeshes.data.slice(0,transparentSubMeshes.length);sortedArray.sort(function(a,b){if(a._alphaIndex>b._alphaIndex){return 1}if(a._alphaIndex<b._alphaIndex){return-1}if(a._distanceToCamera<b._distanceToCamera){return 1}if(a._distanceToCamera>b._distanceToCamera){return-1}return 0});engine.setAlphaMode(BABYLON.Engine.ALPHA_COMBINE);for(index=0;index<sortedArray.length;index++){renderSubMesh(sortedArray[index])}engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE)}}};VolumetricLightScatteringPostProcess.prototype._updateMeshScreenCoordinates=function(scene){var transform=scene.getTransformMatrix();var meshPosition;if(this.useCustomMeshPosition){meshPosition=this.customMeshPosition}else if(this.attachedNode){meshPosition=this.attachedNode.position}else{meshPosition=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position}var pos=BABYLON.Vector3.Project(meshPosition,BABYLON.Matrix.Identity(),transform,this._viewPort);this._screenCoordinates.x=pos.x/this._viewPort.width;this._screenCoordinates.y=pos.y/this._viewPort.height;if(this.invert)this._screenCoordinates.y=1-this._screenCoordinates.y};VolumetricLightScatteringPostProcess.CreateDefaultMesh=function(name,scene){var mesh=BABYLON.Mesh.CreatePlane(name,1,scene);mesh.billboardMode=BABYLON.AbstractMesh.BILLBOARDMODE_ALL;var material=new BABYLON.StandardMaterial(name+"Material",scene);material.emissiveColor=new BABYLON.Color3(1,1,1);mesh.material=material;return mesh};__decorate([BABYLON.serializeAsVector3()],VolumetricLightScatteringPostProcess.prototype,"customMeshPosition",void 0);__decorate([BABYLON.serialize()],VolumetricLightScatteringPostProcess.prototype,"useCustomMeshPosition",void 0);__decorate([BABYLON.serialize()],VolumetricLightScatteringPostProcess.prototype,"invert",void 0);__decorate([BABYLON.serializeAsMeshReference()],VolumetricLightScatteringPostProcess.prototype,"mesh",void 0);__decorate([BABYLON.serialize()],VolumetricLightScatteringPostProcess.prototype,"excludedMeshes",void 0);__decorate([BABYLON.serialize()],VolumetricLightScatteringPostProcess.prototype,"exposure",void 0);__decorate([BABYLON.serialize()],VolumetricLightScatteringPostProcess.prototype,"decay",void 0);__decorate([BABYLON.serialize()],VolumetricLightScatteringPostProcess.prototype,"weight",void 0);__decorate([BABYLON.serialize()],VolumetricLightScatteringPostProcess.prototype,"density",void 0);return VolumetricLightScatteringPostProcess}(BABYLON.PostProcess);BABYLON.VolumetricLightScatteringPostProcess=VolumetricLightScatteringPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ColorCorrectionPostProcess=function(_super){__extends(ColorCorrectionPostProcess,_super);function ColorCorrectionPostProcess(name,colorTableUrl,options,camera,samplingMode,engine,reusable){var _this=_super.call(this,name,"colorCorrection",null,["colorTable"],options,camera,samplingMode,engine,reusable)||this;_this._colorTableTexture=new BABYLON.Texture(colorTableUrl,camera.getScene(),true,false,BABYLON.Texture.TRILINEAR_SAMPLINGMODE);_this._colorTableTexture.anisotropicFilteringLevel=1;_this._colorTableTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;_this._colorTableTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;_this.onApply=function(effect){effect.setTexture("colorTable",_this._colorTableTexture)};return _this}return ColorCorrectionPostProcess}(BABYLON.PostProcess);BABYLON.ColorCorrectionPostProcess=ColorCorrectionPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var TonemappingOperator;(function(TonemappingOperator){TonemappingOperator[TonemappingOperator["Hable"]=0]="Hable";TonemappingOperator[TonemappingOperator["Reinhard"]=1]="Reinhard";TonemappingOperator[TonemappingOperator["HejiDawson"]=2]="HejiDawson";TonemappingOperator[TonemappingOperator["Photographic"]=3]="Photographic"})(TonemappingOperator=BABYLON.TonemappingOperator||(BABYLON.TonemappingOperator={}));var TonemapPostProcess=function(_super){__extends(TonemapPostProcess,_super);function TonemapPostProcess(name,_operator,exposureAdjustment,camera,samplingMode,engine,textureFormat){if(samplingMode===void 0){samplingMode=BABYLON.Texture.BILINEAR_SAMPLINGMODE}if(textureFormat===void 0){textureFormat=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}var _this=_super.call(this,name,"tonemap",["_ExposureAdjustment"],null,1,camera,samplingMode,engine,true,defines,textureFormat)||this;_this._operator=_operator;_this.exposureAdjustment=exposureAdjustment;var defines="#define ";if(_this._operator===TonemappingOperator.Hable)defines+="HABLE_TONEMAPPING";else if(_this._operator===TonemappingOperator.Reinhard)defines+="REINHARD_TONEMAPPING";else if(_this._operator===TonemappingOperator.HejiDawson)defines+="OPTIMIZED_HEJIDAWSON_TONEMAPPING";else if(_this._operator===TonemappingOperator.Photographic)defines+="PHOTOGRAPHIC_TONEMAPPING";_this.updateEffect(defines);_this.onApply=function(effect){effect.setFloat("_ExposureAdjustment",_this.exposureAdjustment)};return _this}return TonemapPostProcess}(BABYLON.PostProcess);BABYLON.TonemapPostProcess=TonemapPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DisplayPassPostProcess=function(_super){__extends(DisplayPassPostProcess,_super);function DisplayPassPostProcess(name,options,camera,samplingMode,engine,reusable){return _super.call(this,name,"displayPass",["passSampler"],["passSampler"],options,camera,samplingMode,engine,reusable)||this}return DisplayPassPostProcess}(BABYLON.PostProcess);BABYLON.DisplayPassPostProcess=DisplayPassPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var HighlightsPostProcess=function(_super){__extends(HighlightsPostProcess,_super);function HighlightsPostProcess(name,options,camera,samplingMode,engine,reusable,textureType){if(textureType===void 0){textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}return _super.call(this,name,"highlights",null,null,options,camera,samplingMode,engine,reusable,null,textureType)||this}return HighlightsPostProcess}(BABYLON.PostProcess);BABYLON.HighlightsPostProcess=HighlightsPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ImageProcessingPostProcess=function(_super){__extends(ImageProcessingPostProcess,_super);function ImageProcessingPostProcess(name,options,camera,samplingMode,engine,reusable,textureType){if(textureType===void 0){textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}var _this=_super.call(this,name,"imageProcessing",[],[],options,camera,samplingMode,engine,reusable,null,textureType,"postprocess",null,true)||this;_this._fromLinearSpace=true;_this._defines={IMAGEPROCESSING:false,VIGNETTE:false,VIGNETTEBLENDMODEMULTIPLY:false,VIGNETTEBLENDMODEOPAQUE:false,TONEMAPPING:false,CONTRAST:false,COLORCURVES:false,COLORGRADING:false,FROMLINEARSPACE:false,SAMPLER3DGREENDEPTH:false,SAMPLER3DBGRMAP:false,IMAGEPROCESSINGPOSTPROCESS:false,EXPOSURE:false};_this._attachImageProcessingConfiguration(null,true);_this.imageProcessingConfiguration.applyByPostProcess=true;_this.onApply=function(effect){_this.imageProcessingConfiguration.bind(effect,_this.aspectRatio)};return _this}Object.defineProperty(ImageProcessingPostProcess.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(value){this._attachImageProcessingConfiguration(value)},enumerable:true,configurable:true});ImageProcessingPostProcess.prototype._attachImageProcessingConfiguration=function(configuration,doNotBuild){var _this=this;if(doNotBuild===void 0){doNotBuild=false}if(configuration===this._imageProcessingConfiguration){return}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}if(!configuration){var scene=null;var engine=this.getEngine();var camera=this.getCamera();if(camera){scene=camera.getScene()}else if(engine&&engine.scenes){var scenes=engine.scenes;scene=scenes[scenes.length-1]}else{scene=BABYLON.Engine.LastCreatedScene}this._imageProcessingConfiguration=scene.imageProcessingConfiguration}else{this._imageProcessingConfiguration=configuration}this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(conf){_this._updateParameters()});if(!doNotBuild){this._updateParameters()}};Object.defineProperty(ImageProcessingPostProcess.prototype,"colorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(value){this.imageProcessingConfiguration.colorCurves=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"colorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(value){this.imageProcessingConfiguration.colorCurvesEnabled=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"colorGradingTexture",{get:function(){return this.imageProcessingConfiguration.colorGradingTexture},set:function(value){this.imageProcessingConfiguration.colorGradingTexture=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"colorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(value){this.imageProcessingConfiguration.colorGradingEnabled=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"exposure",{get:function(){return this.imageProcessingConfiguration.exposure},set:function(value){this.imageProcessingConfiguration.exposure=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"toneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(value){this._imageProcessingConfiguration.toneMappingEnabled=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"contrast",{get:function(){return this.imageProcessingConfiguration.contrast},set:function(value){this.imageProcessingConfiguration.contrast=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"vignetteStretch",{get:function(){return this.imageProcessingConfiguration.vignetteStretch},set:function(value){this.imageProcessingConfiguration.vignetteStretch=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"vignetteCentreX",{get:function(){return this.imageProcessingConfiguration.vignetteCentreX},set:function(value){this.imageProcessingConfiguration.vignetteCentreX=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"vignetteCentreY",{get:function(){return this.imageProcessingConfiguration.vignetteCentreY},set:function(value){this.imageProcessingConfiguration.vignetteCentreY=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"vignetteWeight",{get:function(){return this.imageProcessingConfiguration.vignetteWeight},set:function(value){this.imageProcessingConfiguration.vignetteWeight=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"vignetteColor",{get:function(){return this.imageProcessingConfiguration.vignetteColor},set:function(value){this.imageProcessingConfiguration.vignetteColor=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"vignetteCameraFov",{get:function(){return this.imageProcessingConfiguration.vignetteCameraFov},set:function(value){this.imageProcessingConfiguration.vignetteCameraFov=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"vignetteBlendMode",{get:function(){return this.imageProcessingConfiguration.vignetteBlendMode},set:function(value){this.imageProcessingConfiguration.vignetteBlendMode=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"vignetteEnabled",{get:function(){return this.imageProcessingConfiguration.vignetteEnabled},set:function(value){this.imageProcessingConfiguration.vignetteEnabled=value},enumerable:true,configurable:true});Object.defineProperty(ImageProcessingPostProcess.prototype,"fromLinearSpace",{get:function(){return this._fromLinearSpace},set:function(value){if(this._fromLinearSpace===value){return}this._fromLinearSpace=value;this._updateParameters()},enumerable:true,configurable:true});ImageProcessingPostProcess.prototype.getClassName=function(){return"ImageProcessingPostProcess"};ImageProcessingPostProcess.prototype._updateParameters=function(){this._defines.FROMLINEARSPACE=this._fromLinearSpace;this.imageProcessingConfiguration.prepareDefines(this._defines,true);var defines="";for(var define in this._defines){if(this._defines[define]){defines+="#define "+define+";\r\n"}}var samplers=["textureSampler"];BABYLON.ImageProcessingConfiguration.PrepareSamplers(samplers,this._defines);var uniforms=["scale"];BABYLON.ImageProcessingConfiguration.PrepareUniforms(uniforms,this._defines);this.updateEffect(defines,uniforms,samplers)};ImageProcessingPostProcess.prototype.dispose=function(camera){_super.prototype.dispose.call(this,camera);if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}this.imageProcessingConfiguration.applyByPostProcess=false};__decorate([BABYLON.serialize()],ImageProcessingPostProcess.prototype,"_fromLinearSpace",void 0);return ImageProcessingPostProcess}(BABYLON.PostProcess);BABYLON.ImageProcessingPostProcess=ImageProcessingPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BlurPostProcess=function(_super){__extends(BlurPostProcess,_super);function BlurPostProcess(name,direction,kernel,options,camera,samplingMode,engine,reusable,textureType){if(samplingMode===void 0){samplingMode=BABYLON.Texture.BILINEAR_SAMPLINGMODE}if(textureType===void 0){textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT}var _this=_super.call(this,name,"kernelBlur",["delta","direction"],null,options,camera,samplingMode,engine,reusable,null,textureType,"kernelBlur",{varyingCount:0,depCount:0},true)||this;_this.direction=direction;_this._packedFloat=false;_this.onApplyObservable.add(function(effect){effect.setFloat2("delta",1/_this.width*_this.direction.x,1/_this.height*_this.direction.y)});_this.kernel=kernel;return _this}Object.defineProperty(BlurPostProcess.prototype,"kernel",{get:function(){return this._idealKernel},set:function(v){if(this._idealKernel===v){return}v=Math.max(v,1);this._idealKernel=v;this._kernel=this._nearestBestKernel(v);this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(BlurPostProcess.prototype,"packedFloat",{get:function(){return this._packedFloat},set:function(v){if(this._packedFloat===v){return}this._packedFloat=v;this._updateParameters()},enumerable:true,configurable:true});BlurPostProcess.prototype._updateParameters=function(){var N=this._kernel;var centerIndex=(N-1)/2;var offsets=[];var weights=[];var totalWeight=0;for(var i=0;i<N;i++){var u=i/(N-1);var w=this._gaussianWeight(u*2-1);offsets[i]=i-centerIndex;weights[i]=w;totalWeight+=w}for(var i=0;i<weights.length;i++){weights[i]/=totalWeight}var linearSamplingWeights=[];var linearSamplingOffsets=[];var linearSamplingMap=[];for(var i=0;i<=centerIndex;i+=2){var j=Math.min(i+1,Math.floor(centerIndex));var singleCenterSample=i===j;if(singleCenterSample){linearSamplingMap.push({o:offsets[i],w:weights[i]})}else{var sharedCell=j===centerIndex;var weightLinear=weights[i]+weights[j]*(sharedCell?.5:1);var offsetLinear=offsets[i]+1/(1+weights[i]/weights[j]);if(offsetLinear===0){linearSamplingMap.push({o:offsets[i],w:weights[i]});linearSamplingMap.push({o:offsets[i+1],w:weights[i+1]})}else{linearSamplingMap.push({o:offsetLinear,w:weightLinear});linearSamplingMap.push({o:-offsetLinear,w:weightLinear})}}}for(var i=0;i<linearSamplingMap.length;i++){linearSamplingOffsets[i]=linearSamplingMap[i].o;linearSamplingWeights[i]=linearSamplingMap[i].w}offsets=linearSamplingOffsets;weights=linearSamplingWeights;var maxVaryingRows=this.getEngine().getCaps().maxVaryingVectors;var freeVaryingVec2=Math.max(maxVaryingRows,0)-1;var varyingCount=Math.min(offsets.length,freeVaryingVec2);var defines="";for(var i=0;i<varyingCount;i++){defines+="#define KERNEL_OFFSET"+i+" "+this._glslFloat(offsets[i])+"\r\n";defines+="#define KERNEL_WEIGHT"+i+" "+this._glslFloat(weights[i])+"\r\n"}var depCount=0;for(var i=freeVaryingVec2;i<offsets.length;i++){defines+="#define KERNEL_DEP_OFFSET"+depCount+" "+this._glslFloat(offsets[i])+"\r\n";defines+="#define KERNEL_DEP_WEIGHT"+depCount+" "+this._glslFloat(weights[i])+"\r\n";depCount++}if(this.packedFloat){defines+="#define PACKEDFLOAT 1"}this.updateEffect(defines,null,null,{varyingCount:varyingCount,depCount:depCount})};BlurPostProcess.prototype._nearestBestKernel=function(idealKernel){var v=Math.round(idealKernel);for(var _i=0,_a=[v,v-1,v+1,v-2,v+2];_i<_a.length;_i++){var k=_a[_i];if(k%2!==0&&Math.floor(k/2)%2===0&&k>0){return Math.max(k,3)}}return Math.max(v,3)};BlurPostProcess.prototype._gaussianWeight=function(x){var sigma=1/3;var denominator=Math.sqrt(2*Math.PI)*sigma;var exponent=-(x*x/(2*sigma*sigma));var weight=1/denominator*Math.exp(exponent);return weight};BlurPostProcess.prototype._glslFloat=function(x,decimalFigures){if(decimalFigures===void 0){decimalFigures=8}return x.toFixed(decimalFigures).replace(/0+$/,"")};return BlurPostProcess}(BABYLON.PostProcess);BABYLON.BlurPostProcess=BlurPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Bone=function(_super){__extends(Bone,_super);function Bone(name,skeleton,parentBone,localMatrix,restPose,baseMatrix,index){if(parentBone===void 0){parentBone=null}var _this=_super.call(this,name,skeleton.getScene())||this;_this.name=name;_this.children=new Array;_this.animations=new Array;_this._worldTransform=new BABYLON.Matrix;_this._absoluteTransform=new BABYLON.Matrix;_this._invertedAbsoluteTransform=new BABYLON.Matrix;_this._scaleMatrix=BABYLON.Matrix.Identity();_this._scaleVector=BABYLON.Vector3.One();_this._negateScaleChildren=BABYLON.Vector3.One();_this._scalingDeterminant=1;_this._skeleton=skeleton;_this._localMatrix=localMatrix?localMatrix:BABYLON.Matrix.Identity();_this._restPose=restPose?restPose:_this._localMatrix.clone();_this._baseMatrix=baseMatrix?baseMatrix:_this._localMatrix.clone();_this._index=index;skeleton.bones.push(_this);_this.setParent(parentBone,false);_this._updateDifferenceMatrix();return _this}Object.defineProperty(Bone.prototype,"_matrix",{get:function(){return this._localMatrix},set:function(val){if(this._localMatrix){this._localMatrix.copyFrom(val)}else{this._localMatrix=val}},enumerable:true,configurable:true});Bone.prototype.getSkeleton=function(){return this._skeleton};Bone.prototype.getParent=function(){return this._parent};Bone.prototype.setParent=function(parent,updateDifferenceMatrix){if(updateDifferenceMatrix===void 0){updateDifferenceMatrix=true}if(this._parent===parent){return}if(this._parent){var index=this._parent.children.indexOf(this);if(index!==-1){this._parent.children.splice(index)}}this._parent=parent;if(this._parent){this._parent.children.push(this)}if(updateDifferenceMatrix){this._updateDifferenceMatrix()}};Bone.prototype.getLocalMatrix=function(){return this._localMatrix};Bone.prototype.getBaseMatrix=function(){return this._baseMatrix};Bone.prototype.getRestPose=function(){return this._restPose};Bone.prototype.returnToRest=function(){this.updateMatrix(this._restPose.clone())};Bone.prototype.getWorldMatrix=function(){return this._worldTransform};Bone.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform};Bone.prototype.getAbsoluteTransform=function(){return this._absoluteTransform};Object.defineProperty(Bone.prototype,"position",{get:function(){return this.getPosition()},set:function(newPosition){this.setPosition(newPosition)},enumerable:true,configurable:true});Object.defineProperty(Bone.prototype,"rotation",{get:function(){return this.getRotation()},set:function(newRotation){this.setRotation(newRotation)},enumerable:true,configurable:true});Object.defineProperty(Bone.prototype,"rotationQuaternion",{get:function(){return this.getRotationQuaternion()},set:function(newRotation){this.setRotationQuaternion(newRotation)},enumerable:true,configurable:true});Object.defineProperty(Bone.prototype,"scaling",{get:function(){return this.getScale()},set:function(newScaling){this.setScale(newScaling.x,newScaling.y,newScaling.z)},enumerable:true,configurable:true});Bone.prototype.updateMatrix=function(matrix,updateDifferenceMatrix){if(updateDifferenceMatrix===void 0){updateDifferenceMatrix=true}this._baseMatrix=matrix.clone();this._localMatrix=matrix.clone();this._skeleton._markAsDirty();if(updateDifferenceMatrix){this._updateDifferenceMatrix()}};Bone.prototype._updateDifferenceMatrix=function(rootMatrix){if(!rootMatrix){rootMatrix=this._baseMatrix}if(this._parent){rootMatrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform)}else{this._absoluteTransform.copyFrom(rootMatrix)}this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform);for(var index=0;index<this.children.length;index++){this.children[index]._updateDifferenceMatrix()}this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1};Bone.prototype.markAsDirty=function(){this._currentRenderId++;this._skeleton._markAsDirty()};Bone.prototype.copyAnimationRange=function(source,rangeName,frameOffset,rescaleAsRequired,skelDimensionsRatio){if(rescaleAsRequired===void 0){rescaleAsRequired=false}if(skelDimensionsRatio===void 0){skelDimensionsRatio=null}if(this.animations.length===0){this.animations.push(new BABYLON.Animation(this.name,"_matrix",source.animations[0].framePerSecond,BABYLON.Animation.ANIMATIONTYPE_MATRIX,0));this.animations[0].setKeys([])}var sourceRange=source.animations[0].getRange(rangeName);if(!sourceRange){return false}var from=sourceRange.from;var to=sourceRange.to;var sourceKeys=source.animations[0].getKeys();var sourceBoneLength=source.length;var sourceParent=source.getParent();var parent=this.getParent();var parentScalingReqd=rescaleAsRequired&&sourceParent&&sourceBoneLength&&this.length&&sourceBoneLength!==this.length;var parentRatio=parentScalingReqd?parent.length/sourceParent.length:null;var dimensionsScalingReqd=rescaleAsRequired&&!parent&&skelDimensionsRatio&&(skelDimensionsRatio.x!==1||skelDimensionsRatio.y!==1||skelDimensionsRatio.z!==1);var destKeys=this.animations[0].getKeys();var orig;var origTranslation;var mat;for(var key=0,nKeys=sourceKeys.length;key<nKeys;key++){orig=sourceKeys[key];if(orig.frame>=from&&orig.frame<=to){if(rescaleAsRequired){mat=orig.value.clone();if(parentScalingReqd){origTranslation=mat.getTranslation();mat.setTranslation(origTranslation.scaleInPlace(parentRatio))}else if(dimensionsScalingReqd){origTranslation=mat.getTranslation();mat.setTranslation(origTranslation.multiplyInPlace(skelDimensionsRatio))}else{mat=orig.value}}else{mat=orig.value}destKeys.push({frame:orig.frame+frameOffset,value:mat})}}this.animations[0].createRange(rangeName,from+frameOffset,to+frameOffset);return true};Bone.prototype.translate=function(vec,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var lm=this.getLocalMatrix();if(space==BABYLON.Space.LOCAL){lm.m[12]+=vec.x;lm.m[13]+=vec.y;lm.m[14]+=vec.z}else{var wm;if(mesh){wm=mesh.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var tmat=Bone._tmpMats[0];var tvec=Bone._tmpVecs[0];if(mesh){tmat.copyFrom(this._parent.getAbsoluteTransform());tmat.multiplyToRef(wm,tmat)}else{tmat.copyFrom(this._parent.getAbsoluteTransform())}tmat.m[12]=0;tmat.m[13]=0;tmat.m[14]=0;tmat.invert();BABYLON.Vector3.TransformCoordinatesToRef(vec,tmat,tvec);lm.m[12]+=tvec.x;lm.m[13]+=tvec.y;lm.m[14]+=tvec.z}this.markAsDirty()};Bone.prototype.setPosition=function(position,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var lm=this.getLocalMatrix();if(space==BABYLON.Space.LOCAL){lm.m[12]=position.x;lm.m[13]=position.y;lm.m[14]=position.z}else{var wm;if(mesh){wm=mesh.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var tmat=Bone._tmpMats[0];var vec=Bone._tmpVecs[0];if(mesh){tmat.copyFrom(this._parent.getAbsoluteTransform());tmat.multiplyToRef(wm,tmat)}else{tmat.copyFrom(this._parent.getAbsoluteTransform())}tmat.invert();BABYLON.Vector3.TransformCoordinatesToRef(position,tmat,vec);lm.m[12]=vec.x;lm.m[13]=vec.y;lm.m[14]=vec.z}this.markAsDirty()};Bone.prototype.setAbsolutePosition=function(position,mesh){this.setPosition(position,BABYLON.Space.WORLD,mesh)};Bone.prototype.setScale=function(x,y,z,scaleChildren){if(scaleChildren===void 0){scaleChildren=false}if(this.animations[0]&&!this.animations[0].hasRunningRuntimeAnimations){if(!scaleChildren){this._negateScaleChildren.x=1/x;this._negateScaleChildren.y=1/y;this._negateScaleChildren.z=1/z}this._syncScaleVector()}this.scale(x/this._scaleVector.x,y/this._scaleVector.y,z/this._scaleVector.z,scaleChildren)};Bone.prototype.scale=function(x,y,z,scaleChildren){if(scaleChildren===void 0){scaleChildren=false}var locMat=this.getLocalMatrix();var origLocMat=Bone._tmpMats[0];origLocMat.copyFrom(locMat);var origLocMatInv=Bone._tmpMats[1];origLocMatInv.copyFrom(origLocMat);origLocMatInv.invert();var scaleMat=Bone._tmpMats[2];BABYLON.Matrix.FromValuesToRef(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1,scaleMat);this._scaleMatrix.multiplyToRef(scaleMat,this._scaleMatrix);this._scaleVector.x*=x;this._scaleVector.y*=y;this._scaleVector.z*=z;locMat.multiplyToRef(origLocMatInv,locMat);locMat.multiplyToRef(scaleMat,locMat);locMat.multiplyToRef(origLocMat,locMat);var parent=this.getParent();if(parent){locMat.multiplyToRef(parent.getAbsoluteTransform(),this.getAbsoluteTransform())}else{this.getAbsoluteTransform().copyFrom(locMat)}var len=this.children.length;scaleMat.invert();for(var i=0;i<len;i++){var child=this.children[i];var cm=child.getLocalMatrix();cm.multiplyToRef(scaleMat,cm);var lm=child.getLocalMatrix();lm.m[12]*=x;lm.m[13]*=y;lm.m[14]*=z}this.computeAbsoluteTransforms();if(scaleChildren){for(var i=0;i<len;i++){this.children[i].scale(x,y,z,scaleChildren)}}this.markAsDirty()};Bone.prototype.setYawPitchRoll=function(yaw,pitch,roll,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var rotMat=Bone._tmpMats[0];BABYLON.Matrix.RotationYawPitchRollToRef(yaw,pitch,roll,rotMat);var rotMatInv=Bone._tmpMats[1];this._getNegativeRotationToRef(rotMatInv,space,mesh);rotMatInv.multiplyToRef(rotMat,rotMat);this._rotateWithMatrix(rotMat,space,mesh)};Bone.prototype.rotate=function(axis,amount,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var rmat=Bone._tmpMats[0];rmat.m[12]=0;rmat.m[13]=0;rmat.m[14]=0;BABYLON.Matrix.RotationAxisToRef(axis,amount,rmat);this._rotateWithMatrix(rmat,space,mesh)};Bone.prototype.setAxisAngle=function(axis,angle,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var rotMat=Bone._tmpMats[0];BABYLON.Matrix.RotationAxisToRef(axis,angle,rotMat);var rotMatInv=Bone._tmpMats[1];this._getNegativeRotationToRef(rotMatInv,space,mesh);rotMatInv.multiplyToRef(rotMat,rotMat);this._rotateWithMatrix(rotMat,space,mesh)};Bone.prototype.setRotation=function(rotation,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}this.setYawPitchRoll(rotation.y,rotation.x,rotation.z,space,mesh)};Bone.prototype.setRotationQuaternion=function(quat,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var rotMatInv=Bone._tmpMats[0];this._getNegativeRotationToRef(rotMatInv,space,mesh);var rotMat=Bone._tmpMats[1];BABYLON.Matrix.FromQuaternionToRef(quat,rotMat);rotMatInv.multiplyToRef(rotMat,rotMat);this._rotateWithMatrix(rotMat,space,mesh)};Bone.prototype.setRotationMatrix=function(rotMat,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var rotMatInv=Bone._tmpMats[0];this._getNegativeRotationToRef(rotMatInv,space,mesh);var rotMat2=Bone._tmpMats[1];rotMat2.copyFrom(rotMat);rotMatInv.multiplyToRef(rotMat,rotMat2);this._rotateWithMatrix(rotMat2,space,mesh)};Bone.prototype._rotateWithMatrix=function(rmat,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var lmat=this.getLocalMatrix();var lx=lmat.m[12];var ly=lmat.m[13];var lz=lmat.m[14];var parent=this.getParent();var parentScale=Bone._tmpMats[3];var parentScaleInv=Bone._tmpMats[4];if(parent){if(space==BABYLON.Space.WORLD){if(mesh){parentScale.copyFrom(mesh.getWorldMatrix());parent.getAbsoluteTransform().multiplyToRef(parentScale,parentScale)}else{parentScale.copyFrom(parent.getAbsoluteTransform())}}else{parentScale=parent._scaleMatrix}parentScaleInv.copyFrom(parentScale);parentScaleInv.invert();lmat.multiplyToRef(parentScale,lmat);lmat.multiplyToRef(rmat,lmat);lmat.multiplyToRef(parentScaleInv,lmat)}else{if(space==BABYLON.Space.WORLD&&mesh){parentScale.copyFrom(mesh.getWorldMatrix());parentScaleInv.copyFrom(parentScale);parentScaleInv.invert();lmat.multiplyToRef(parentScale,lmat);lmat.multiplyToRef(rmat,lmat);lmat.multiplyToRef(parentScaleInv,lmat)}else{lmat.multiplyToRef(rmat,lmat)}}lmat.m[12]=lx;lmat.m[13]=ly;lmat.m[14]=lz;this.computeAbsoluteTransforms();this.markAsDirty()};Bone.prototype._getNegativeRotationToRef=function(rotMatInv,space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}if(space==BABYLON.Space.WORLD){var scaleMatrix=Bone._tmpMats[2];scaleMatrix.copyFrom(this._scaleMatrix);rotMatInv.copyFrom(this.getAbsoluteTransform());if(mesh){rotMatInv.multiplyToRef(mesh.getWorldMatrix(),rotMatInv);var meshScale=Bone._tmpMats[3];BABYLON.Matrix.ScalingToRef(mesh.scaling.x,mesh.scaling.y,mesh.scaling.z,meshScale);scaleMatrix.multiplyToRef(meshScale,scaleMatrix)}rotMatInv.invert();scaleMatrix.m[0]*=this._scalingDeterminant;rotMatInv.multiplyToRef(scaleMatrix,rotMatInv)}else{rotMatInv.copyFrom(this.getLocalMatrix());rotMatInv.invert();var scaleMatrix=Bone._tmpMats[2];scaleMatrix.copyFrom(this._scaleMatrix);if(this._parent){var pscaleMatrix=Bone._tmpMats[3];pscaleMatrix.copyFrom(this._parent._scaleMatrix);pscaleMatrix.invert();pscaleMatrix.multiplyToRef(rotMatInv,rotMatInv)}else{scaleMatrix.m[0]*=this._scalingDeterminant}rotMatInv.multiplyToRef(scaleMatrix,rotMatInv)}};Bone.prototype.getScale=function(){return this._scaleVector.clone()};Bone.prototype.getScaleToRef=function(result){result.copyFrom(this._scaleVector)};Bone.prototype.getPosition=function(space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var pos=BABYLON.Vector3.Zero();this.getPositionToRef(space,mesh,pos);return pos};Bone.prototype.getPositionToRef=function(space,mesh,result){if(space===void 0){space=BABYLON.Space.LOCAL}if(space==BABYLON.Space.LOCAL){var lm=this.getLocalMatrix();result.x=lm.m[12];result.y=lm.m[13];result.z=lm.m[14]}else{var wm;if(mesh){wm=mesh.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var tmat=Bone._tmpMats[0];if(mesh){tmat.copyFrom(this.getAbsoluteTransform());tmat.multiplyToRef(wm,tmat)}else{tmat=this.getAbsoluteTransform()}result.x=tmat.m[12];result.y=tmat.m[13];result.z=tmat.m[14]}};Bone.prototype.getAbsolutePosition=function(mesh){var pos=BABYLON.Vector3.Zero();this.getPositionToRef(BABYLON.Space.WORLD,mesh,pos);return pos};Bone.prototype.getAbsolutePositionToRef=function(mesh,result){this.getPositionToRef(BABYLON.Space.WORLD,mesh,result)};Bone.prototype.computeAbsoluteTransforms=function(){if(this._parent){this._localMatrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform)}else{this._absoluteTransform.copyFrom(this._localMatrix);var poseMatrix=this._skeleton.getPoseMatrix();if(poseMatrix){this._absoluteTransform.multiplyToRef(poseMatrix,this._absoluteTransform)}}var children=this.children;var len=children.length;for(var i=0;i<len;i++){children[i].computeAbsoluteTransforms()}};Bone.prototype._syncScaleVector=function(){var lm=this.getLocalMatrix();var xsq=lm.m[0]*lm.m[0]+lm.m[1]*lm.m[1]+lm.m[2]*lm.m[2];var ysq=lm.m[4]*lm.m[4]+lm.m[5]*lm.m[5]+lm.m[6]*lm.m[6];var zsq=lm.m[8]*lm.m[8]+lm.m[9]*lm.m[9]+lm.m[10]*lm.m[10];var xs=lm.m[0]*lm.m[1]*lm.m[2]*lm.m[3]<0?-1:1;var ys=lm.m[4]*lm.m[5]*lm.m[6]*lm.m[7]<0?-1:1;var zs=lm.m[8]*lm.m[9]*lm.m[10]*lm.m[11]<0?-1:1;this._scaleVector.x=xs*Math.sqrt(xsq);this._scaleVector.y=ys*Math.sqrt(ysq);this._scaleVector.z=zs*Math.sqrt(zsq);if(this._parent){this._scaleVector.x/=this._parent._negateScaleChildren.x;this._scaleVector.y/=this._parent._negateScaleChildren.y;this._scaleVector.z/=this._parent._negateScaleChildren.z}BABYLON.Matrix.FromValuesToRef(this._scaleVector.x,0,0,0,0,this._scaleVector.y,0,0,0,0,this._scaleVector.z,0,0,0,0,1,this._scaleMatrix)};Bone.prototype.getDirection=function(localAxis,mesh){var result=BABYLON.Vector3.Zero();this.getDirectionToRef(localAxis,mesh,result);return result};Bone.prototype.getDirectionToRef=function(localAxis,mesh,result){var wm;if(mesh){wm=mesh.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var mat=Bone._tmpMats[0];mat.copyFrom(this.getAbsoluteTransform());if(mesh){mat.multiplyToRef(wm,mat)}BABYLON.Vector3.TransformNormalToRef(localAxis,mat,result);result.normalize()};Bone.prototype.getRotation=function(space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var result=BABYLON.Vector3.Zero();this.getRotationToRef(space,mesh,result);return result};Bone.prototype.getRotationToRef=function(space,mesh,result){if(space===void 0){space=BABYLON.Space.LOCAL}var quat=Bone._tmpQuat;this.getRotationQuaternionToRef(space,mesh,quat);quat.toEulerAnglesToRef(result)};Bone.prototype.getRotationQuaternion=function(space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var result=BABYLON.Quaternion.Identity();this.getRotationQuaternionToRef(space,mesh,result);return result};Bone.prototype.getRotationQuaternionToRef=function(space,mesh,result){if(space===void 0){space=BABYLON.Space.LOCAL}if(space==BABYLON.Space.LOCAL){this.getLocalMatrix().decompose(Bone._tmpVecs[0],result,Bone._tmpVecs[1])}else{var mat=Bone._tmpMats[0];var amat=this.getAbsoluteTransform();if(mesh){amat.multiplyToRef(mesh.getWorldMatrix(),mat)}else{mat.copyFrom(amat)}mat.m[0]*=this._scalingDeterminant;mat.m[1]*=this._scalingDeterminant;mat.m[2]*=this._scalingDeterminant;mat.decompose(Bone._tmpVecs[0],result,Bone._tmpVecs[1])}};Bone.prototype.getRotationMatrix=function(space,mesh){if(space===void 0){space=BABYLON.Space.LOCAL}var result=BABYLON.Matrix.Identity();this.getRotationMatrixToRef(space,mesh,result);return result};Bone.prototype.getRotationMatrixToRef=function(space,mesh,result){if(space===void 0){space=BABYLON.Space.LOCAL}if(space==BABYLON.Space.LOCAL){this.getLocalMatrix().getRotationMatrixToRef(result)}else{var mat=Bone._tmpMats[0];var amat=this.getAbsoluteTransform();if(mesh){amat.multiplyToRef(mesh.getWorldMatrix(),mat)}else{mat.copyFrom(amat)}mat.m[0]*=this._scalingDeterminant;mat.m[1]*=this._scalingDeterminant;mat.m[2]*=this._scalingDeterminant;mat.getRotationMatrixToRef(result)}};Bone.prototype.getAbsolutePositionFromLocal=function(position,mesh){var result=BABYLON.Vector3.Zero();this.getAbsolutePositionFromLocalToRef(position,mesh,result);return result};Bone.prototype.getAbsolutePositionFromLocalToRef=function(position,mesh,result){var wm;if(mesh){wm=mesh.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var tmat=Bone._tmpMats[0];if(mesh){tmat.copyFrom(this.getAbsoluteTransform());tmat.multiplyToRef(wm,tmat)}else{tmat=this.getAbsoluteTransform()}BABYLON.Vector3.TransformCoordinatesToRef(position,tmat,result)};Bone.prototype.getLocalPositionFromAbsolute=function(position,mesh){var result=BABYLON.Vector3.Zero();this.getLocalPositionFromAbsoluteToRef(position,mesh,result);return result};Bone.prototype.getLocalPositionFromAbsoluteToRef=function(position,mesh,result){var wm;if(mesh){wm=mesh.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var tmat=Bone._tmpMats[0];tmat.copyFrom(this.getAbsoluteTransform());if(mesh){tmat.multiplyToRef(wm,tmat)}tmat.invert();BABYLON.Vector3.TransformCoordinatesToRef(position,tmat,result)};Bone._tmpVecs=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];Bone._tmpQuat=BABYLON.Quaternion.Identity();Bone._tmpMats=[BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity()];return Bone}(BABYLON.Node);BABYLON.Bone=Bone})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BoneIKController=function(){function BoneIKController(mesh,bone,options){this.targetPosition=BABYLON.Vector3.Zero();this.poleTargetPosition=BABYLON.Vector3.Zero();this.poleTargetLocalOffset=BABYLON.Vector3.Zero();this.poleAngle=0;this.slerpAmount=1;this._bone1Quat=BABYLON.Quaternion.Identity();this._bone1Mat=BABYLON.Matrix.Identity();this._bone2Ang=Math.PI;this._maxAngle=Math.PI;this._rightHandedSystem=false;this._bendAxis=BABYLON.Vector3.Right();this._slerping=false;this._adjustRoll=0;this._bone2=bone;this._bone1=bone.getParent();this.mesh=mesh;var bonePos=bone.getPosition();if(bone.getAbsoluteTransform().determinant()>0){this._rightHandedSystem=true;this._bendAxis.x=0;this._bendAxis.y=0;this._bendAxis.z=-1;if(bonePos.x>bonePos.y&&bonePos.x>bonePos.z){this._adjustRoll=Math.PI*.5;this._bendAxis.z=1}}if(this._bone1.length){var boneScale1=this._bone1.getScale();var boneScale2=this._bone2.getScale();this._bone1Length=this._bone1.length*boneScale1.y*this.mesh.scaling.y;this._bone2Length=this._bone2.length*boneScale2.y*this.mesh.scaling.y}else if(this._bone1.children[0]){mesh.computeWorldMatrix(true);var pos1=this._bone2.children[0].getAbsolutePosition(mesh);var pos2=this._bone2.getAbsolutePosition(mesh);var pos3=this._bone1.getAbsolutePosition(mesh);this._bone1Length=BABYLON.Vector3.Distance(pos1,pos2);this._bone2Length=BABYLON.Vector3.Distance(pos2,pos3)}this._bone1.getRotationMatrixToRef(BABYLON.Space.WORLD,mesh,this._bone1Mat);this.maxAngle=Math.PI;if(options){if(options.targetMesh){this.targetMesh=options.targetMesh;this.targetMesh.computeWorldMatrix(true)}if(options.poleTargetMesh){this.poleTargetMesh=options.poleTargetMesh;this.poleTargetMesh.computeWorldMatrix(true)}else if(options.poleTargetBone){this.poleTargetBone=options.poleTargetBone}else if(this._bone1.getParent()){this.poleTargetBone=this._bone1.getParent()}if(options.poleTargetLocalOffset){this.poleTargetLocalOffset.copyFrom(options.poleTargetLocalOffset)}if(options.poleAngle){this.poleAngle=options.poleAngle}if(options.bendAxis){this._bendAxis.copyFrom(options.bendAxis)}if(options.maxAngle){this.maxAngle=options.maxAngle}if(options.slerpAmount){this.slerpAmount=options.slerpAmount}}}Object.defineProperty(BoneIKController.prototype,"maxAngle",{get:function(){return this._maxAngle},set:function(value){this._setMaxAngle(value)},enumerable:true,configurable:true});BoneIKController.prototype._setMaxAngle=function(ang){if(ang<0){ang=0}if(ang>Math.PI||ang==undefined){ang=Math.PI}this._maxAngle=ang;var a=this._bone1Length;var b=this._bone2Length;this._maxReach=Math.sqrt(a*a+b*b-2*a*b*Math.cos(ang))};BoneIKController.prototype.update=function(){var bone1=this._bone1;var target=this.targetPosition;var poleTarget=this.poleTargetPosition;var mat1=BoneIKController._tmpMats[0];var mat2=BoneIKController._tmpMats[1];if(this.targetMesh){target.copyFrom(this.targetMesh.getAbsolutePosition())}if(this.poleTargetBone){this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,poleTarget)}else if(this.poleTargetMesh){BABYLON.Vector3.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),poleTarget)}var bonePos=BoneIKController._tmpVecs[0];var zaxis=BoneIKController._tmpVecs[1];var xaxis=BoneIKController._tmpVecs[2];var yaxis=BoneIKController._tmpVecs[3];var upAxis=BoneIKController._tmpVecs[4];var _tmpQuat=BoneIKController._tmpQuat;bone1.getAbsolutePositionToRef(this.mesh,bonePos);poleTarget.subtractToRef(bonePos,upAxis);if(upAxis.x==0&&upAxis.y==0&&upAxis.z==0){upAxis.y=1}else{upAxis.normalize()}target.subtractToRef(bonePos,yaxis);yaxis.normalize();BABYLON.Vector3.CrossToRef(yaxis,upAxis,zaxis);zaxis.normalize();BABYLON.Vector3.CrossToRef(yaxis,zaxis,xaxis);xaxis.normalize();BABYLON.Matrix.FromXYZAxesToRef(xaxis,yaxis,zaxis,mat1);var a=this._bone1Length;var b=this._bone2Length;var c=BABYLON.Vector3.Distance(bonePos,target);if(this._maxReach>0){c=Math.min(this._maxReach,c)}var acosa=(b*b+c*c-a*a)/(2*b*c);var acosb=(c*c+a*a-b*b)/(2*c*a);if(acosa>1){acosa=1}if(acosb>1){acosb=1}if(acosa<-1){acosa=-1}if(acosb<-1){acosb=-1}var angA=Math.acos(acosa);var angB=Math.acos(acosb);var angC=-angA-angB;if(this._rightHandedSystem){BABYLON.Matrix.RotationYawPitchRollToRef(0,0,this._adjustRoll,mat2);mat2.multiplyToRef(mat1,mat1);BABYLON.Matrix.RotationAxisToRef(this._bendAxis,angB,mat2);mat2.multiplyToRef(mat1,mat1)}else{var _tmpVec=BoneIKController._tmpVecs[5];_tmpVec.copyFrom(this._bendAxis);_tmpVec.x*=-1;BABYLON.Matrix.RotationAxisToRef(_tmpVec,-angB,mat2);mat2.multiplyToRef(mat1,mat1)}if(this.poleAngle){BABYLON.Matrix.RotationAxisToRef(yaxis,this.poleAngle,mat2);mat1.multiplyToRef(mat2,mat1)}if(this.slerpAmount<1){if(!this._slerping){BABYLON.Quaternion.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat)}BABYLON.Quaternion.FromRotationMatrixToRef(mat1,_tmpQuat);BABYLON.Quaternion.SlerpToRef(this._bone1Quat,_tmpQuat,this.slerpAmount,this._bone1Quat);angC=this._bone2Ang*(1-this.slerpAmount)+angC*this.slerpAmount;this._bone1.setRotationQuaternion(this._bone1Quat,BABYLON.Space.WORLD,this.mesh);this._slerping=true}else{this._bone1.setRotationMatrix(mat1,BABYLON.Space.WORLD,this.mesh);this._bone1Mat.copyFrom(mat1);this._slerping=false}this._bone2.setAxisAngle(this._bendAxis,angC,BABYLON.Space.LOCAL);this._bone2Ang=angC};BoneIKController._tmpVecs=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];BoneIKController._tmpQuat=BABYLON.Quaternion.Identity();BoneIKController._tmpMats=[BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity()];return BoneIKController}();BABYLON.BoneIKController=BoneIKController})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BoneLookController=function(){function BoneLookController(mesh,bone,target,options){this.upAxis=BABYLON.Vector3.Up();this.upAxisSpace=BABYLON.Space.LOCAL;this.adjustYaw=0;this.adjustPitch=0;this.adjustRoll=0;this.slerpAmount=1;this._boneQuat=BABYLON.Quaternion.Identity();this._slerping=false;this._firstFrameSkipped=false;this._fowardAxis=BABYLON.Vector3.Forward();this.mesh=mesh;this.bone=bone;this.target=target;if(options){if(options.adjustYaw){this.adjustYaw=options.adjustYaw}if(options.adjustPitch){this.adjustPitch=options.adjustPitch}if(options.adjustRoll){this.adjustRoll=options.adjustRoll}if(options.maxYaw!=null){this.maxYaw=options.maxYaw}else{this.maxYaw=Math.PI}if(options.minYaw!=null){this.minYaw=options.minYaw}else{this.minYaw=-Math.PI}if(options.maxPitch!=null){this.maxPitch=options.maxPitch}else{this.maxPitch=Math.PI}if(options.minPitch!=null){this.minPitch=options.minPitch}else{this.minPitch=-Math.PI}if(options.slerpAmount!=null){this.slerpAmount=options.slerpAmount}if(options.upAxis!=null){this.upAxis=options.upAxis}if(options.upAxisSpace!=null){this.upAxisSpace=options.upAxisSpace}if(options.yawAxis!=null||options.pitchAxis!=null){var newYawAxis=BABYLON.Axis.Y;var newPitchAxis=BABYLON.Axis.X;if(options.yawAxis!=null){newYawAxis=options.yawAxis.clone();newYawAxis.normalize()}if(options.pitchAxis!=null){newPitchAxis=options.pitchAxis.clone();newPitchAxis.normalize()}var newRollAxis=BABYLON.Vector3.Cross(newPitchAxis,newYawAxis);this._transformYawPitch=BABYLON.Matrix.Identity();BABYLON.Matrix.FromXYZAxesToRef(newPitchAxis,newYawAxis,newRollAxis,this._transformYawPitch);this._transformYawPitchInv=this._transformYawPitch.clone();this._transformYawPitch.invert()}}if(!bone.getParent()&&this.upAxisSpace==BABYLON.Space.BONE){this.upAxisSpace=BABYLON.Space.LOCAL}}Object.defineProperty(BoneLookController.prototype,"minYaw",{get:function(){return this._minYaw},set:function(value){this._minYaw=value;this._minYawSin=Math.sin(value);this._minYawCos=Math.cos(value);if(this._maxYaw!=null){this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw;this._yawRange=this._maxYaw-this._minYaw}},enumerable:true,configurable:true});Object.defineProperty(BoneLookController.prototype,"maxYaw",{get:function(){return this._maxYaw},set:function(value){this._maxYaw=value;this._maxYawSin=Math.sin(value);this._maxYawCos=Math.cos(value);if(this._minYaw!=null){this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw;this._yawRange=this._maxYaw-this._minYaw}},enumerable:true,configurable:true});Object.defineProperty(BoneLookController.prototype,"minPitch",{get:function(){return this._minPitch},set:function(value){this._minPitch=value;this._minPitchTan=Math.tan(value)},enumerable:true,configurable:true});Object.defineProperty(BoneLookController.prototype,"maxPitch",{get:function(){return this._maxPitch},set:function(value){this._maxPitch=value;this._maxPitchTan=Math.tan(value)},enumerable:true,configurable:true});BoneLookController.prototype.update=function(){if(this.slerpAmount<1&&!this._firstFrameSkipped){this._firstFrameSkipped=true;return}var bone=this.bone;var bonePos=BoneLookController._tmpVecs[0];bone.getAbsolutePositionToRef(this.mesh,bonePos);var target=this.target;var _tmpMat1=BoneLookController._tmpMats[0];var _tmpMat2=BoneLookController._tmpMats[1];var mesh=this.mesh;var parentBone=bone.getParent();var upAxis=BoneLookController._tmpVecs[1];upAxis.copyFrom(this.upAxis);if(this.upAxisSpace==BABYLON.Space.BONE){if(this._transformYawPitch){BABYLON.Vector3.TransformCoordinatesToRef(upAxis,this._transformYawPitchInv,upAxis)}parentBone.getDirectionToRef(upAxis,this.mesh,upAxis)}else if(this.upAxisSpace==BABYLON.Space.LOCAL){mesh.getDirectionToRef(upAxis,upAxis);if(mesh.scaling.x!=1||mesh.scaling.y!=1||mesh.scaling.z!=1){upAxis.normalize()}}var checkYaw=false;var checkPitch=false;if(this._maxYaw!=Math.PI||this._minYaw!=-Math.PI){checkYaw=true}if(this._maxPitch!=Math.PI||this._minPitch!=-Math.PI){checkPitch=true}if(checkYaw||checkPitch){var spaceMat=BoneLookController._tmpMats[2];var spaceMatInv=BoneLookController._tmpMats[3];if(this.upAxisSpace==BABYLON.Space.BONE&&upAxis.y==1){parentBone.getRotationMatrixToRef(BABYLON.Space.WORLD,this.mesh,spaceMat)}else if(this.upAxisSpace==BABYLON.Space.LOCAL&&upAxis.y==1&&!parentBone){spaceMat.copyFrom(mesh.getWorldMatrix())}else{var forwardAxis=BoneLookController._tmpVecs[2];forwardAxis.copyFrom(this._fowardAxis);if(this._transformYawPitch){BABYLON.Vector3.TransformCoordinatesToRef(forwardAxis,this._transformYawPitchInv,forwardAxis)}if(parentBone){parentBone.getDirectionToRef(forwardAxis,this.mesh,forwardAxis)}else{mesh.getDirectionToRef(forwardAxis,forwardAxis)}var rightAxis=BABYLON.Vector3.Cross(upAxis,forwardAxis);rightAxis.normalize();var forwardAxis=BABYLON.Vector3.Cross(rightAxis,upAxis);BABYLON.Matrix.FromXYZAxesToRef(rightAxis,upAxis,forwardAxis,spaceMat)}spaceMat.invertToRef(spaceMatInv);var xzlen;if(checkPitch){var localTarget=BoneLookController._tmpVecs[3];target.subtractToRef(bonePos,localTarget);BABYLON.Vector3.TransformCoordinatesToRef(localTarget,spaceMatInv,localTarget);var xzlen=Math.sqrt(localTarget.x*localTarget.x+localTarget.z*localTarget.z);var pitch=Math.atan2(localTarget.y,xzlen);var newPitch=pitch;if(pitch>this._maxPitch){localTarget.y=this._maxPitchTan*xzlen;newPitch=this._maxPitch}else if(pitch<this._minPitch){localTarget.y=this._minPitchTan*xzlen;newPitch=this._minPitch}if(pitch!=newPitch){BABYLON.Vector3.TransformCoordinatesToRef(localTarget,spaceMat,localTarget);localTarget.addInPlace(bonePos);target=localTarget}}if(checkYaw){var localTarget=BoneLookController._tmpVecs[4];target.subtractToRef(bonePos,localTarget);BABYLON.Vector3.TransformCoordinatesToRef(localTarget,spaceMatInv,localTarget);var yaw=Math.atan2(localTarget.x,localTarget.z);var newYaw=yaw;if(yaw>this._maxYaw||yaw<this._minYaw){if(xzlen==null){xzlen=Math.sqrt(localTarget.x*localTarget.x+localTarget.z*localTarget.z)}if(this._yawRange>Math.PI){if(this._isAngleBetween(yaw,this._maxYaw,this._midYawConstraint)){localTarget.z=this._maxYawCos*xzlen;localTarget.x=this._maxYawSin*xzlen;newYaw=this._maxYaw}else if(this._isAngleBetween(yaw,this._midYawConstraint,this._minYaw)){localTarget.z=this._minYawCos*xzlen;localTarget.x=this._minYawSin*xzlen;newYaw=this._minYaw}}else{if(yaw>this._maxYaw){localTarget.z=this._maxYawCos*xzlen;localTarget.x=this._maxYawSin*xzlen;newYaw=this._maxYaw}else if(yaw<this._minYaw){localTarget.z=this._minYawCos*xzlen;localTarget.x=this._minYawSin*xzlen;newYaw=this._minYaw}}}if(this._slerping&&this._yawRange>Math.PI){var boneFwd=BoneLookController._tmpVecs[8];boneFwd.copyFrom(BABYLON.Axis.Z);if(this._transformYawPitch){BABYLON.Vector3.TransformCoordinatesToRef(boneFwd,this._transformYawPitchInv,boneFwd)}var boneRotMat=BABYLON.BoneLookController._tmpMats[4];this._boneQuat.toRotationMatrix(boneRotMat);this.mesh.getWorldMatrix().multiplyToRef(boneRotMat,boneRotMat);BABYLON.Vector3.TransformCoordinatesToRef(boneFwd,boneRotMat,boneFwd);BABYLON.Vector3.TransformCoordinatesToRef(boneFwd,spaceMatInv,boneFwd);var boneYaw=Math.atan2(boneFwd.x,boneFwd.z);var angBtwTar=this._getAngleBetween(boneYaw,yaw);var angBtwMidYaw=this._getAngleBetween(boneYaw,this._midYawConstraint);if(angBtwTar>angBtwMidYaw){if(xzlen==null){xzlen=Math.sqrt(localTarget.x*localTarget.x+localTarget.z*localTarget.z)}var angBtwMax=this._getAngleBetween(boneYaw,this._maxYaw);var angBtwMin=this._getAngleBetween(boneYaw,this._minYaw);if(angBtwMin<angBtwMax){newYaw=boneYaw+Math.PI*.75;localTarget.z=Math.cos(newYaw)*xzlen;localTarget.x=Math.sin(newYaw)*xzlen}else{newYaw=boneYaw-Math.PI*.75;localTarget.z=Math.cos(newYaw)*xzlen;localTarget.x=Math.sin(newYaw)*xzlen}}}if(yaw!=newYaw){BABYLON.Vector3.TransformCoordinatesToRef(localTarget,spaceMat,localTarget);localTarget.addInPlace(bonePos);target=localTarget}}}var zaxis=BoneLookController._tmpVecs[5];var xaxis=BoneLookController._tmpVecs[6];var yaxis=BoneLookController._tmpVecs[7];var _tmpQuat=BoneLookController._tmpQuat;target.subtractToRef(bonePos,zaxis);zaxis.normalize();BABYLON.Vector3.CrossToRef(upAxis,zaxis,xaxis);xaxis.normalize();BABYLON.Vector3.CrossToRef(zaxis,xaxis,yaxis);yaxis.normalize();BABYLON.Matrix.FromXYZAxesToRef(xaxis,yaxis,zaxis,_tmpMat1);if(xaxis.x===0&&xaxis.y===0&&xaxis.z===0){return}if(yaxis.x===0&&yaxis.y===0&&yaxis.z===0){return}if(zaxis.x===0&&zaxis.y===0&&zaxis.z===0){return}if(this.adjustYaw||this.adjustPitch||this.adjustRoll){BABYLON.Matrix.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,_tmpMat2);_tmpMat2.multiplyToRef(_tmpMat1,_tmpMat1)}if(this.slerpAmount<1){if(!this._slerping){this.bone.getRotationQuaternionToRef(BABYLON.Space.WORLD,this.mesh,this._boneQuat)}if(this._transformYawPitch){this._transformYawPitch.multiplyToRef(_tmpMat1,_tmpMat1)}BABYLON.Quaternion.FromRotationMatrixToRef(_tmpMat1,_tmpQuat);BABYLON.Quaternion.SlerpToRef(this._boneQuat,_tmpQuat,this.slerpAmount,this._boneQuat);this.bone.setRotationQuaternion(this._boneQuat,BABYLON.Space.WORLD,this.mesh);this._slerping=true}else{if(this._transformYawPitch){this._transformYawPitch.multiplyToRef(_tmpMat1,_tmpMat1)}this.bone.setRotationMatrix(_tmpMat1,BABYLON.Space.WORLD,this.mesh);this._slerping=false}};BoneLookController.prototype._getAngleDiff=function(ang1,ang2){var angDiff=ang2-ang1;angDiff%=Math.PI*2;if(angDiff>Math.PI){angDiff-=Math.PI*2}else if(angDiff<-Math.PI){angDiff+=Math.PI*2}return angDiff};BoneLookController.prototype._getAngleBetween=function(ang1,ang2){ang1%=2*Math.PI;ang1=ang1<0?ang1+2*Math.PI:ang1;ang2%=2*Math.PI;ang2=ang2<0?ang2+2*Math.PI:ang2;var ab=0;if(ang1<ang2){ab=ang2-ang1}else{ab=ang1-ang2}if(ab>Math.PI){ab=Math.PI*2-ab}return ab};BoneLookController.prototype._isAngleBetween=function(ang,ang1,ang2){ang%=2*Math.PI;ang=ang<0?ang+2*Math.PI:ang;ang1%=2*Math.PI;ang1=ang1<0?ang1+2*Math.PI:ang1;ang2%=2*Math.PI;ang2=ang2<0?ang2+2*Math.PI:ang2;if(ang1<ang2){if(ang>ang1&&ang<ang2){return true}}else{if(ang>ang2&&ang<ang1){return true}}return false};BoneLookController._tmpVecs=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];BoneLookController._tmpQuat=BABYLON.Quaternion.Identity();BoneLookController._tmpMats=[BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity(),BABYLON.Matrix.Identity()];return BoneLookController}();BABYLON.BoneLookController=BoneLookController})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Skeleton=function(){function Skeleton(name,id,scene){this.name=name;this.id=id;this.bones=new Array;this.needInitialSkinMatrix=false;this._isDirty=true;this._meshesWithPoseMatrix=new Array;this._identity=BABYLON.Matrix.Identity();this._ranges={};this._lastAbsoluteTransformsUpdateId=-1;this.onBeforeComputeObservable=new BABYLON.Observable;this.bones=[];this._scene=scene||BABYLON.Engine.LastCreatedScene;scene.skeletons.push(this);this._isDirty=true}Skeleton.prototype.getTransformMatrices=function(mesh){if(this.needInitialSkinMatrix&&mesh._bonesTransformMatrices){return mesh._bonesTransformMatrices}if(!this._transformMatrices){this.prepare()}return this._transformMatrices};Skeleton.prototype.getScene=function(){return this._scene};Skeleton.prototype.toString=function(fullDetails){var ret="Name: "+this.name+", nBones: "+this.bones.length;ret+=", nAnimationRanges: "+(this._ranges?Object.keys(this._ranges).length:"none");if(fullDetails){ret+=", Ranges: {";var first=true;for(var name_1 in this._ranges){if(first){ret+=", ";first=false}ret+=name_1}ret+="}"}return ret};Skeleton.prototype.getBoneIndexByName=function(name){for(var boneIndex=0,cache=this.bones.length;boneIndex<cache;boneIndex++){if(this.bones[boneIndex].name===name){return boneIndex}}return-1};Skeleton.prototype.createAnimationRange=function(name,from,to){if(!this._ranges[name]){this._ranges[name]=new BABYLON.AnimationRange(name,from,to);for(var i=0,nBones=this.bones.length;i<nBones;i++){if(this.bones[i].animations[0]){this.bones[i].animations[0].createRange(name,from,to)}}}};Skeleton.prototype.deleteAnimationRange=function(name,deleteFrames){if(deleteFrames===void 0){deleteFrames=true}for(var i=0,nBones=this.bones.length;i<nBones;i++){if(this.bones[i].animations[0]){this.bones[i].animations[0].deleteRange(name,deleteFrames)}}this._ranges[name]=undefined};Skeleton.prototype.getAnimationRange=function(name){return this._ranges[name]};Skeleton.prototype.getAnimationRanges=function(){var animationRanges=[];var name;var i=0;for(name in this._ranges){animationRanges[i]=this._ranges[name];i++}return animationRanges};Skeleton.prototype.copyAnimationRange=function(source,name,rescaleAsRequired){if(rescaleAsRequired===void 0){rescaleAsRequired=false}if(this._ranges[name]||!source.getAnimationRange(name)){return false}var ret=true;var frameOffset=this._getHighestAnimationFrame()+1;var boneDict={};var sourceBones=source.bones;var nBones;var i;for(i=0,nBones=sourceBones.length;i<nBones;i++){boneDict[sourceBones[i].name]=sourceBones[i]}if(this.bones.length!==sourceBones.length){BABYLON.Tools.Warn("copyAnimationRange: this rig has "+this.bones.length+" bones, while source as "+sourceBones.length);ret=false}var skelDimensionsRatio=rescaleAsRequired&&this.dimensionsAtRest&&source.dimensionsAtRest?this.dimensionsAtRest.divide(source.dimensionsAtRest):null;for(i=0,nBones=this.bones.length;i<nBones;i++){var boneName=this.bones[i].name;var sourceBone=boneDict[boneName];if(sourceBone){ret=ret&&this.bones[i].copyAnimationRange(sourceBone,name,frameOffset,rescaleAsRequired,skelDimensionsRatio)}else{BABYLON.Tools.Warn("copyAnimationRange: not same rig, missing source bone "+boneName);ret=false}}var range=source.getAnimationRange(name);this._ranges[name]=new BABYLON.AnimationRange(name,range.from+frameOffset,range.to+frameOffset);return ret};Skeleton.prototype.returnToRest=function(){for(var index=0;index<this.bones.length;index++){this.bones[index].returnToRest()}};Skeleton.prototype._getHighestAnimationFrame=function(){var ret=0;for(var i=0,nBones=this.bones.length;i<nBones;i++){if(this.bones[i].animations[0]){var highest=this.bones[i].animations[0].getHighestFrame();if(ret<highest){ret=highest}}}return ret};Skeleton.prototype.beginAnimation=function(name,loop,speedRatio,onAnimationEnd){var range=this.getAnimationRange(name);if(!range){return null}return this._scene.beginAnimation(this,range.from,range.to,loop,speedRatio,onAnimationEnd)};Skeleton.prototype._markAsDirty=function(){this._isDirty=true};Skeleton.prototype._registerMeshWithPoseMatrix=function(mesh){this._meshesWithPoseMatrix.push(mesh)};Skeleton.prototype._unregisterMeshWithPoseMatrix=function(mesh){var index=this._meshesWithPoseMatrix.indexOf(mesh);if(index>-1){this._meshesWithPoseMatrix.splice(index,1)}};Skeleton.prototype._computeTransformMatrices=function(targetMatrix,initialSkinMatrix){this.onBeforeComputeObservable.notifyObservers(this);for(var index=0;index<this.bones.length;index++){var bone=this.bones[index];var parentBone=bone.getParent();if(parentBone){bone.getLocalMatrix().multiplyToRef(parentBone.getWorldMatrix(),bone.getWorldMatrix())}else{if(initialSkinMatrix){bone.getLocalMatrix().multiplyToRef(initialSkinMatrix,bone.getWorldMatrix())}else{bone.getWorldMatrix().copyFrom(bone.getLocalMatrix())}}if(bone._index!==-1){var mappedIndex=bone._index===undefined?index:bone._index;bone.getInvertedAbsoluteTransform().multiplyToArray(bone.getWorldMatrix(),targetMatrix,mappedIndex*16)}}this._identity.copyToArray(targetMatrix,this.bones.length*16)};Skeleton.prototype.prepare=function(){if(!this._isDirty){return}if(this.needInitialSkinMatrix){for(var index=0;index<this._meshesWithPoseMatrix.length;index++){var mesh=this._meshesWithPoseMatrix[index];var poseMatrix=mesh.getPoseMatrix();if(!mesh._bonesTransformMatrices||mesh._bonesTransformMatrices.length!==16*(this.bones.length+1)){mesh._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1))}if(this._synchronizedWithMesh!==mesh){this._synchronizedWithMesh=mesh;for(var boneIndex=0;boneIndex<this.bones.length;boneIndex++){var bone=this.bones[boneIndex];if(!bone.getParent()){var matrix=bone.getBaseMatrix();matrix.multiplyToRef(poseMatrix,BABYLON.Tmp.Matrix[1]);bone._updateDifferenceMatrix(BABYLON.Tmp.Matrix[1])}}}this._computeTransformMatrices(mesh._bonesTransformMatrices,poseMatrix)}}else{if(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1)){this._transformMatrices=new Float32Array(16*(this.bones.length+1))}this._computeTransformMatrices(this._transformMatrices,null)}this._isDirty=false;this._scene._activeBones.addCount(this.bones.length,false)};Skeleton.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var index=0;index<this.bones.length;index++){this._animatables.push(this.bones[index])}}return this._animatables};Skeleton.prototype.clone=function(name,id){var result=new Skeleton(name,id||name,this._scene);result.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var index=0;index<this.bones.length;index++){var source=this.bones[index];var parentBone=null;if(source.getParent()){var parentIndex=this.bones.indexOf(source.getParent());parentBone=result.bones[parentIndex]}var bone=new BABYLON.Bone(source.name,result,parentBone,source.getBaseMatrix().clone(),source.getRestPose().clone());BABYLON.Tools.DeepCopy(source.animations,bone.animations)}if(this._ranges){result._ranges={};for(var rangeName in this._ranges){result._ranges[rangeName]=this._ranges[rangeName].clone()}}this._isDirty=true;return result};Skeleton.prototype.enableBlending=function(blendingSpeed){if(blendingSpeed===void 0){blendingSpeed=.01}this.bones.forEach(function(bone){bone.animations.forEach(function(animation){animation.enableBlending=true;animation.blendingSpeed=blendingSpeed})})};Skeleton.prototype.dispose=function(){this._meshesWithPoseMatrix=[];this.getScene().stopAnimation(this);this.getScene().removeSkeleton(this)};Skeleton.prototype.serialize=function(){var serializationObject={};serializationObject.name=this.name;serializationObject.id=this.id;serializationObject.dimensionsAtRest=this.dimensionsAtRest;serializationObject.bones=[];serializationObject.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var index=0;index<this.bones.length;index++){var bone=this.bones[index];var serializedBone={parentBoneIndex:bone.getParent()?this.bones.indexOf(bone.getParent()):-1,name:bone.name,matrix:bone.getBaseMatrix().toArray(),rest:bone.getRestPose().toArray()};serializationObject.bones.push(serializedBone);if(bone.length){serializedBone.length=bone.length}if(bone.animations&&bone.animations.length>0){serializedBone.animation=bone.animations[0].serialize()}serializationObject.ranges=[];for(var name in this._ranges){var range={};range.name=name;range.from=this._ranges[name].from;range.to=this._ranges[name].to;serializationObject.ranges.push(range)}}return serializationObject};Skeleton.Parse=function(parsedSkeleton,scene){var skeleton=new Skeleton(parsedSkeleton.name,parsedSkeleton.id,scene);if(parsedSkeleton.dimensionsAtRest){skeleton.dimensionsAtRest=BABYLON.Vector3.FromArray(parsedSkeleton.dimensionsAtRest)}skeleton.needInitialSkinMatrix=parsedSkeleton.needInitialSkinMatrix;var index;for(index=0;index<parsedSkeleton.bones.length;index++){var parsedBone=parsedSkeleton.bones[index];var parentBone=null;if(parsedBone.parentBoneIndex>-1){parentBone=skeleton.bones[parsedBone.parentBoneIndex]}var rest=parsedBone.rest?BABYLON.Matrix.FromArray(parsedBone.rest):null;var bone=new BABYLON.Bone(parsedBone.name,skeleton,parentBone,BABYLON.Matrix.FromArray(parsedBone.matrix),rest);if(parsedBone.length){bone.length=parsedBone.length}if(parsedBone.animation){bone.animations.push(BABYLON.Animation.Parse(parsedBone.animation))}}if(parsedSkeleton.ranges){for(index=0;index<parsedSkeleton.ranges.length;index++){var data=parsedSkeleton.ranges[index];skeleton.createAnimationRange(data.name,data.from,data.to)}}return skeleton};Skeleton.prototype.computeAbsoluteTransforms=function(forceUpdate){if(forceUpdate===void 0){forceUpdate=false}var renderId=this._scene.getRenderId();if(this._lastAbsoluteTransformsUpdateId!=renderId||forceUpdate){this.bones[0].computeAbsoluteTransforms();this._lastAbsoluteTransformsUpdateId=renderId}};Skeleton.prototype.getPoseMatrix=function(){var poseMatrix;if(this._meshesWithPoseMatrix.length>0){poseMatrix=this._meshesWithPoseMatrix[0].getPoseMatrix()}return poseMatrix};Skeleton.prototype.sortBones=function(){var bones=new Array;var visited=new Array(this.bones.length);for(var index=0;index<this.bones.length;index++){this._sortBones(index,bones,visited)}this.bones=bones};Skeleton.prototype._sortBones=function(index,bones,visited){if(visited[index]){return}visited[index]=true;var bone=this.bones[index];if(bone._index===undefined){bone._index=index}var parentBone=bone.getParent();if(parentBone){this._sortBones(this.bones.indexOf(parentBone),bones,visited)}bones.push(bone)};return Skeleton}();BABYLON.Skeleton=Skeleton})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SphericalPolynomial=function(){function SphericalPolynomial(){this.x=BABYLON.Vector3.Zero();this.y=BABYLON.Vector3.Zero();this.z=BABYLON.Vector3.Zero();this.xx=BABYLON.Vector3.Zero();this.yy=BABYLON.Vector3.Zero();this.zz=BABYLON.Vector3.Zero();this.xy=BABYLON.Vector3.Zero();this.yz=BABYLON.Vector3.Zero();this.zx=BABYLON.Vector3.Zero()}SphericalPolynomial.prototype.addAmbient=function(color){var colorVector=new BABYLON.Vector3(color.r,color.g,color.b);this.xx=this.xx.add(colorVector);this.yy=this.yy.add(colorVector);this.zz=this.zz.add(colorVector)};SphericalPolynomial.getSphericalPolynomialFromHarmonics=function(harmonics){var result=new SphericalPolynomial;result.x=harmonics.L11.scale(1.02333);result.y=harmonics.L1_1.scale(1.02333);result.z=harmonics.L10.scale(1.02333);result.xx=harmonics.L00.scale(.886277).subtract(harmonics.L20.scale(.247708)).add(harmonics.L22.scale(.429043));result.yy=harmonics.L00.scale(.886277).subtract(harmonics.L20.scale(.247708)).subtract(harmonics.L22.scale(.429043));result.zz=harmonics.L00.scale(.886277).add(harmonics.L20.scale(.495417));result.yz=harmonics.L2_1.scale(.858086);result.zx=harmonics.L21.scale(.858086);result.xy=harmonics.L2_2.scale(.858086);result.scale(1/Math.PI);return result};SphericalPolynomial.prototype.scale=function(scale){this.x=this.x.scale(scale);this.y=this.y.scale(scale);this.z=this.z.scale(scale);this.xx=this.xx.scale(scale);this.yy=this.yy.scale(scale);this.zz=this.zz.scale(scale);this.yz=this.yz.scale(scale);this.zx=this.zx.scale(scale);this.xy=this.xy.scale(scale)};return SphericalPolynomial}();BABYLON.SphericalPolynomial=SphericalPolynomial;var SphericalHarmonics=function(){function SphericalHarmonics(){this.L00=BABYLON.Vector3.Zero();this.L1_1=BABYLON.Vector3.Zero();this.L10=BABYLON.Vector3.Zero();this.L11=BABYLON.Vector3.Zero();this.L2_2=BABYLON.Vector3.Zero();this.L2_1=BABYLON.Vector3.Zero();this.L20=BABYLON.Vector3.Zero();this.L21=BABYLON.Vector3.Zero();this.L22=BABYLON.Vector3.Zero()}SphericalHarmonics.prototype.addLight=function(direction,color,deltaSolidAngle){var colorVector=new BABYLON.Vector3(color.r,color.g,color.b);var c=colorVector.scale(deltaSolidAngle);this.L00=this.L00.add(c.scale(.282095));this.L1_1=this.L1_1.add(c.scale(.488603*direction.y));this.L10=this.L10.add(c.scale(.488603*direction.z));this.L11=this.L11.add(c.scale(.488603*direction.x));this.L2_2=this.L2_2.add(c.scale(1.092548*direction.x*direction.y));this.L2_1=this.L2_1.add(c.scale(1.092548*direction.y*direction.z));this.L21=this.L21.add(c.scale(1.092548*direction.x*direction.z));this.L20=this.L20.add(c.scale(.315392*(3*direction.z*direction.z-1)));this.L22=this.L22.add(c.scale(.546274*(direction.x*direction.x-direction.y*direction.y)))};SphericalHarmonics.prototype.scale=function(scale){this.L00=this.L00.scale(scale);this.L1_1=this.L1_1.scale(scale);this.L10=this.L10.scale(scale);this.L11=this.L11.scale(scale);this.L2_2=this.L2_2.scale(scale);this.L2_1=this.L2_1.scale(scale);this.L20=this.L20.scale(scale);this.L21=this.L21.scale(scale);this.L22=this.L22.scale(scale)};SphericalHarmonics.prototype.convertIncidentRadianceToIrradiance=function(){this.L00=this.L00.scale(3.141593);this.L1_1=this.L1_1.scale(2.094395);this.L10=this.L10.scale(2.094395);this.L11=this.L11.scale(2.094395);this.L2_2=this.L2_2.scale(.785398);this.L2_1=this.L2_1.scale(.785398);this.L20=this.L20.scale(.785398);this.L21=this.L21.scale(.785398);this.L22=this.L22.scale(.785398)};SphericalHarmonics.prototype.convertIrradianceToLambertianRadiance=function(){this.scale(1/Math.PI)};SphericalHarmonics.getsphericalHarmonicsFromPolynomial=function(polynomial){var result=new SphericalHarmonics;result.L00=polynomial.xx.scale(.376127).add(polynomial.yy.scale(.376127)).add(polynomial.zz.scale(.376126));result.L1_1=polynomial.y.scale(.977204);result.L10=polynomial.z.scale(.977204);result.L11=polynomial.x.scale(.977204);result.L2_2=polynomial.xy.scale(1.16538);result.L2_1=polynomial.yz.scale(1.16538);result.L20=polynomial.zz.scale(1.34567).subtract(polynomial.xx.scale(.672834)).subtract(polynomial.yy.scale(.672834));result.L21=polynomial.zx.scale(1.16538);result.L22=polynomial.xx.scale(1.16538).subtract(polynomial.yy.scale(1.16538));result.scale(Math.PI);return result};return SphericalHarmonics}();BABYLON.SphericalHarmonics=SphericalHarmonics})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var FileFaceOrientation=function(){function FileFaceOrientation(name,worldAxisForNormal,worldAxisForFileX,worldAxisForFileY){this.name=name;this.worldAxisForNormal=worldAxisForNormal;this.worldAxisForFileX=worldAxisForFileX;this.worldAxisForFileY=worldAxisForFileY}return FileFaceOrientation}();var CubeMapToSphericalPolynomialTools=function(){function CubeMapToSphericalPolynomialTools(){}CubeMapToSphericalPolynomialTools.ConvertCubeMapTextureToSphericalPolynomial=function(texture){if(!texture.isCube){return null}var size=texture.getSize().width;var right=texture.readPixels(0);var left=texture.readPixels(1);var up;var down;if(texture.isRenderTarget){up=texture.readPixels(3);down=texture.readPixels(2)}else{up=texture.readPixels(2);down=texture.readPixels(3)}var front=texture.readPixels(4);var back=texture.readPixels(5);var gammaSpace=texture.gammaSpace;var format=BABYLON.Engine.TEXTUREFORMAT_RGBA;var type=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT;if(texture.textureType&&texture.textureType!==BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT){type=BABYLON.Engine.TEXTURETYPE_FLOAT}var cubeInfo={size:size,right:right,left:left,up:up,down:down,front:front,back:back,format:format,type:type,gammaSpace:gammaSpace};return this.ConvertCubeMapToSphericalPolynomial(cubeInfo)};CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial=function(cubeInfo){var sphericalHarmonics=new BABYLON.SphericalHarmonics;var totalSolidAngle=0;var du=2/cubeInfo.size;var dv=du;var minUV=du*.5-1;for(var faceIndex=0;faceIndex<6;faceIndex++){var fileFace=this.FileFaces[faceIndex];var dataArray=cubeInfo[fileFace.name];var v=minUV;var stride=cubeInfo.format===BABYLON.Engine.TEXTUREFORMAT_RGBA?4:3;for(var y=0;y<cubeInfo.size;y++){var u=minUV;for(var x=0;x<cubeInfo.size;x++){var worldDirection=fileFace.worldAxisForFileX.scale(u).add(fileFace.worldAxisForFileY.scale(v)).add(fileFace.worldAxisForNormal);worldDirection.normalize();var deltaSolidAngle=Math.pow(1+u*u+v*v,-3/2);var r=dataArray[y*cubeInfo.size*stride+x*stride+0];var g=dataArray[y*cubeInfo.size*stride+x*stride+1];var b=dataArray[y*cubeInfo.size*stride+x*stride+2];if(cubeInfo.type===BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT){r/=255;g/=255;b/=255}if(cubeInfo.gammaSpace){r=Math.pow(BABYLON.Scalar.Clamp(r),BABYLON.ToLinearSpace);g=Math.pow(BABYLON.Scalar.Clamp(g),BABYLON.ToLinearSpace);b=Math.pow(BABYLON.Scalar.Clamp(b),BABYLON.ToLinearSpace)}var color=new BABYLON.Color3(r,g,b);sphericalHarmonics.addLight(worldDirection,color,deltaSolidAngle);totalSolidAngle+=deltaSolidAngle;u+=du}v+=dv}}var sphereSolidAngle=4*Math.PI;var facesProcessed=6;var expectedSolidAngle=sphereSolidAngle*facesProcessed/6;var correctionFactor=expectedSolidAngle/totalSolidAngle;sphericalHarmonics.scale(correctionFactor);sphericalHarmonics.convertIncidentRadianceToIrradiance();sphericalHarmonics.convertIrradianceToLambertianRadiance();return BABYLON.SphericalPolynomial.getSphericalPolynomialFromHarmonics(sphericalHarmonics)};CubeMapToSphericalPolynomialTools.FileFaces=[new FileFaceOrientation("right",new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,0,-1),new BABYLON.Vector3(0,-1,0)),new FileFaceOrientation("left",new BABYLON.Vector3(-1,0,0),new BABYLON.Vector3(0,0,1),new BABYLON.Vector3(0,-1,0)),new FileFaceOrientation("up",new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,0,1)),new FileFaceOrientation("down",new BABYLON.Vector3(0,-1,0),new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,0,-1)),new FileFaceOrientation("front",new BABYLON.Vector3(0,0,1),new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,-1,0)),new FileFaceOrientation("back",new BABYLON.Vector3(0,0,-1),new BABYLON.Vector3(-1,0,0),new BABYLON.Vector3(0,-1,0))];return CubeMapToSphericalPolynomialTools}();Internals.CubeMapToSphericalPolynomialTools=CubeMapToSphericalPolynomialTools})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var PanoramaToCubeMapTools=function(){function PanoramaToCubeMapTools(){}PanoramaToCubeMapTools.ConvertPanoramaToCubemap=function(float32Array,inputWidth,inputHeight,size){if(!float32Array){throw"ConvertPanoramaToCubemap: input cannot be null"}if(float32Array.length!=inputWidth*inputHeight*3){throw"ConvertPanoramaToCubemap: input size is wrong"}var textureFront=this.CreateCubemapTexture(size,this.FACE_FRONT,float32Array,inputWidth,inputHeight);var textureBack=this.CreateCubemapTexture(size,this.FACE_BACK,float32Array,inputWidth,inputHeight);var textureLeft=this.CreateCubemapTexture(size,this.FACE_LEFT,float32Array,inputWidth,inputHeight);var textureRight=this.CreateCubemapTexture(size,this.FACE_RIGHT,float32Array,inputWidth,inputHeight);var textureUp=this.CreateCubemapTexture(size,this.FACE_UP,float32Array,inputWidth,inputHeight);var textureDown=this.CreateCubemapTexture(size,this.FACE_DOWN,float32Array,inputWidth,inputHeight);return{front:textureFront,back:textureBack,left:textureLeft,right:textureRight,up:textureUp,down:textureDown,size:size,type:BABYLON.Engine.TEXTURETYPE_FLOAT,format:BABYLON.Engine.TEXTUREFORMAT_RGB,gammaSpace:false}};PanoramaToCubeMapTools.CreateCubemapTexture=function(texSize,faceData,float32Array,inputWidth,inputHeight){var buffer=new ArrayBuffer(texSize*texSize*4*3);var textureArray=new Float32Array(buffer);var rotDX1=faceData[1].subtract(faceData[0]).scale(1/texSize);var rotDX2=faceData[3].subtract(faceData[2]).scale(1/texSize);var dy=1/texSize;var fy=0;for(var y=0;y<texSize;y++){var xv1=faceData[0];var xv2=faceData[2];for(var x=0;x<texSize;x++){var v=xv2.subtract(xv1).scale(fy).add(xv1);v.normalize();var color=this.CalcProjectionSpherical(v,float32Array,inputWidth,inputHeight);textureArray[y*texSize*3+x*3+0]=color.r;textureArray[y*texSize*3+x*3+1]=color.g;textureArray[y*texSize*3+x*3+2]=color.b;xv1=xv1.add(rotDX1);xv2=xv2.add(rotDX2)}fy+=dy}return textureArray};PanoramaToCubeMapTools.CalcProjectionSpherical=function(vDir,float32Array,inputWidth,inputHeight){var theta=Math.atan2(vDir.z,vDir.x);var phi=Math.acos(vDir.y);while(theta<-Math.PI)theta+=2*Math.PI;while(theta>Math.PI)theta-=2*Math.PI;var dx=theta/Math.PI;var dy=phi/Math.PI;dx=dx*.5+.5;var px=Math.round(dx*inputWidth);if(px<0)px=0;else if(px>=inputWidth)px=inputWidth-1;var py=Math.round(dy*inputHeight);if(py<0)py=0;else if(py>=inputHeight)py=inputHeight-1;var inputY=inputHeight-py-1;var r=float32Array[inputY*inputWidth*3+px*3+0];var g=float32Array[inputY*inputWidth*3+px*3+1];var b=float32Array[inputY*inputWidth*3+px*3+2];return{r:r,g:g,b:b}};PanoramaToCubeMapTools.FACE_FRONT=[new BABYLON.Vector3(-1,-1,-1),new BABYLON.Vector3(1,-1,-1),new BABYLON.Vector3(-1,1,-1),new BABYLON.Vector3(1,1,-1)];PanoramaToCubeMapTools.FACE_BACK=[new BABYLON.Vector3(1,-1,1),new BABYLON.Vector3(-1,-1,1),new BABYLON.Vector3(1,1,1),new BABYLON.Vector3(-1,1,1)];PanoramaToCubeMapTools.FACE_RIGHT=[new BABYLON.Vector3(1,-1,-1),new BABYLON.Vector3(1,-1,1),new BABYLON.Vector3(1,1,-1),new BABYLON.Vector3(1,1,1)];PanoramaToCubeMapTools.FACE_LEFT=[new BABYLON.Vector3(-1,-1,1),new BABYLON.Vector3(-1,-1,-1),new BABYLON.Vector3(-1,1,1),new BABYLON.Vector3(-1,1,-1)];PanoramaToCubeMapTools.FACE_DOWN=[new BABYLON.Vector3(-1,1,-1),new BABYLON.Vector3(1,1,-1),new BABYLON.Vector3(-1,1,1),new BABYLON.Vector3(1,1,1)];PanoramaToCubeMapTools.FACE_UP=[new BABYLON.Vector3(-1,-1,1),new BABYLON.Vector3(1,-1,1),new BABYLON.Vector3(-1,-1,-1),new BABYLON.Vector3(1,-1,-1)];return PanoramaToCubeMapTools}();Internals.PanoramaToCubeMapTools=PanoramaToCubeMapTools})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var HDRTools=function(){function HDRTools(){}HDRTools.Ldexp=function(mantissa,exponent){if(exponent>1023){return mantissa*Math.pow(2,1023)*Math.pow(2,exponent-1023)}if(exponent<-1074){return mantissa*Math.pow(2,-1074)*Math.pow(2,exponent+1074)}return mantissa*Math.pow(2,exponent)};HDRTools.Rgbe2float=function(float32array,red,green,blue,exponent,index){if(exponent>0){exponent=this.Ldexp(1,exponent-(128+8));float32array[index+0]=red*exponent;float32array[index+1]=green*exponent;float32array[index+2]=blue*exponent}else{float32array[index+0]=0;float32array[index+1]=0;float32array[index+2]=0}};HDRTools.readStringLine=function(uint8array,startIndex){var line="";var character="";for(var i=startIndex;i<uint8array.length-startIndex;i++){character=String.fromCharCode(uint8array[i]);if(character=="\n"){break}line+=character}return line};HDRTools.RGBE_ReadHeader=function(uint8array){var height=0;var width=0;var line=this.readStringLine(uint8array,0);if(line[0]!="#"||line[1]!="?"){throw"Bad HDR Format."}var endOfHeader=false;var findFormat=false;var lineIndex=0;do{lineIndex+=line.length+1;line=this.readStringLine(uint8array,lineIndex);if(line=="FORMAT=32-bit_rle_rgbe"){findFormat=true}else if(line.length==0){endOfHeader=true}}while(!endOfHeader);if(!findFormat){throw"HDR Bad header format, unsupported FORMAT"}lineIndex+=line.length+1;line=this.readStringLine(uint8array,lineIndex);var sizeRegexp=/^\-Y (.*) \+X (.*)$/g;var match=sizeRegexp.exec(line);if(match.length<3){throw"HDR Bad header format, no size"}width=parseInt(match[2]);height=parseInt(match[1]);if(width<8||width>32767){throw"HDR Bad header format, unsupported size"}lineIndex+=line.length+1;return{height:height,width:width,dataPosition:lineIndex}};HDRTools.GetCubeMapTextureData=function(buffer,size){var uint8array=new Uint8Array(buffer);var hdrInfo=this.RGBE_ReadHeader(uint8array);var data=this.RGBE_ReadPixels_RLE(uint8array,hdrInfo);var cubeMapData=Internals.PanoramaToCubeMapTools.ConvertPanoramaToCubemap(data,hdrInfo.width,hdrInfo.height,size);return cubeMapData};HDRTools.RGBE_ReadPixels=function(uint8array,hdrInfo){return this.RGBE_ReadPixels_RLE(uint8array,hdrInfo)};HDRTools.RGBE_ReadPixels_RLE=function(uint8array,hdrInfo){var num_scanlines=hdrInfo.height;var scanline_width=hdrInfo.width;var a,b,c,d,count;var dataIndex=hdrInfo.dataPosition;var index=0,endIndex=0,i=0;var scanLineArrayBuffer=new ArrayBuffer(scanline_width*4);var scanLineArray=new Uint8Array(scanLineArrayBuffer);var resultBuffer=new ArrayBuffer(hdrInfo.width*hdrInfo.height*4*3);var resultArray=new Float32Array(resultBuffer);while(num_scanlines>0){a=uint8array[dataIndex++];b=uint8array[dataIndex++];c=uint8array[dataIndex++];d=uint8array[dataIndex++];if(a!=2||b!=2||c&128){throw"HDR Bad header format, not RLE"}if((c<<8|d)!=scanline_width){throw"HDR Bad header format, wrong scan line width"}index=0;for(i=0;i<4;i++){endIndex=(i+1)*scanline_width;while(index<endIndex){a=uint8array[dataIndex++];b=uint8array[dataIndex++];if(a>128){count=a-128;if(count==0||count>endIndex-index){throw"HDR Bad Format, bad scanline data (run)"}while(count-- >0){scanLineArray[index++]=b}}else{count=a;if(count==0||count>endIndex-index){throw"HDR Bad Format, bad scanline data (non-run)"}scanLineArray[index++]=b;if(--count>0){for(var j=0;j<count;j++){scanLineArray[index++]=uint8array[dataIndex++]}}}}}for(i=0;i<scanline_width;i++){a=scanLineArray[i];b=scanLineArray[i+scanline_width];c=scanLineArray[i+2*scanline_width];d=scanLineArray[i+3*scanline_width];this.Rgbe2float(resultArray,a,b,c,d,(hdrInfo.height-num_scanlines)*scanline_width*3+i*3)}num_scanlines--}return resultArray};return HDRTools}();Internals.HDRTools=HDRTools})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var HDRCubeTexture=function(_super){__extends(HDRCubeTexture,_super);function HDRCubeTexture(url,scene,size,noMipmap,generateHarmonics,useInGammaSpace,usePMREMGenerator,onLoad,onError){if(noMipmap===void 0){noMipmap=false}if(generateHarmonics===void 0){generateHarmonics=true}if(useInGammaSpace===void 0){useInGammaSpace=false}if(usePMREMGenerator===void 0){usePMREMGenerator=false}if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}var _this=_super.call(this,scene)||this;_this._useInGammaSpace=false;_this._generateHarmonics=true;_this._isBABYLONPreprocessed=false;_this._onLoad=null;_this._onError=null;_this.coordinatesMode=BABYLON.Texture.CUBIC_MODE;_this.isPMREM=false;_this._isBlocking=true;if(!url){return _this}_this.name=url;_this.url=url;_this.hasAlpha=false;_this.isCube=true;_this._textureMatrix=BABYLON.Matrix.Identity();_this._onLoad=onLoad;_this._onError=onError;_this.gammaSpace=false;if(size){_this._isBABYLONPreprocessed=false;_this._noMipmap=noMipmap;_this._size=size;_this._useInGammaSpace=useInGammaSpace;_this._usePMREMGenerator=usePMREMGenerator&&scene.getEngine().getCaps().textureLOD&&_this.getScene().getEngine().getCaps().textureFloat&&!_this._useInGammaSpace}else{_this._isBABYLONPreprocessed=true;_this._noMipmap=false;_this._useInGammaSpace=false;_this._usePMREMGenerator=scene.getEngine().getCaps().textureLOD&&_this.getScene().getEngine().getCaps().textureFloat&&!_this._useInGammaSpace}_this.isPMREM=_this._usePMREMGenerator;_this._texture=_this._getFromCache(url,_this._noMipmap);if(!_this._texture){if(!scene.useDelayedTextureLoading){_this.loadTexture()}else{_this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED}}return _this}Object.defineProperty(HDRCubeTexture.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(value){this._isBlocking=value},enumerable:true,configurable:true});HDRCubeTexture.prototype.loadBabylonTexture=function(){var _this=this;var mipLevels=0;var floatArrayView=null;var mipmapGenerator=!this._useInGammaSpace&&this.getScene().getEngine().getCaps().textureFloat?function(data){var mips=new Array;var startIndex=30;for(var level=0;level<mipLevels;level++){mips.push([]);var faceSize=Math.pow(_this._size>>level,2)*3;for(var faceIndex=0;faceIndex<6;faceIndex++){var faceData=floatArrayView.subarray(startIndex,startIndex+faceSize);mips[level].push(faceData);startIndex+=faceSize}}return mips}:null;var callback=function(buffer){var intArrayView=new Int32Array(buffer);floatArrayView=new Float32Array(buffer);var version=intArrayView[0];_this._size=intArrayView[1];_this._texture.updateSize(_this._size,_this._size);var sphericalPolynomial=new BABYLON.SphericalPolynomial;sphericalPolynomial.x.copyFromFloats(floatArrayView[2],floatArrayView[3],floatArrayView[4]);sphericalPolynomial.y.copyFromFloats(floatArrayView[5],floatArrayView[6],floatArrayView[7]);sphericalPolynomial.z.copyFromFloats(floatArrayView[8],floatArrayView[9],floatArrayView[10]);sphericalPolynomial.xx.copyFromFloats(floatArrayView[11],floatArrayView[12],floatArrayView[13]);sphericalPolynomial.yy.copyFromFloats(floatArrayView[14],floatArrayView[15],floatArrayView[16]);sphericalPolynomial.zz.copyFromFloats(floatArrayView[17],floatArrayView[18],floatArrayView[19]);sphericalPolynomial.xy.copyFromFloats(floatArrayView[20],floatArrayView[21],floatArrayView[22]);sphericalPolynomial.yz.copyFromFloats(floatArrayView[23],floatArrayView[24],floatArrayView[25]);sphericalPolynomial.zx.copyFromFloats(floatArrayView[26],floatArrayView[27],floatArrayView[28]);_this.sphericalPolynomial=sphericalPolynomial;mipLevels=intArrayView[29];var startIndex=30;var data=[];var faceSize=Math.pow(_this._size,2)*3;for(var faceIndex=0;faceIndex<6;faceIndex++){data.push(floatArrayView.subarray(startIndex,startIndex+faceSize));startIndex+=faceSize}var results=[];var byteArray=null;for(var k=0;k<6;k++){var dataFace=null;if(version===1){var j=[0,2,4,1,3,5][k];dataFace=data[j]}if(!mipmapGenerator){if(!_this.getScene().getEngine().getCaps().textureFloat){var byteBuffer=new ArrayBuffer(faceSize);byteArray=new Uint8Array(byteBuffer)}for(var i=0;i<_this._size*_this._size;i++){if(_this._useInGammaSpace){dataFace[i*3+0]=Math.pow(dataFace[i*3+0],BABYLON.ToGammaSpace);dataFace[i*3+1]=Math.pow(dataFace[i*3+1],BABYLON.ToGammaSpace);dataFace[i*3+2]=Math.pow(dataFace[i*3+2],BABYLON.ToGammaSpace)}if(byteArray){var r=Math.max(dataFace[i*3+0]*255,0);var g=Math.max(dataFace[i*3+1]*255,0);var b=Math.max(dataFace[i*3+2]*255,0);var max=Math.max(Math.max(r,g),b);if(max>255){var scale=255/max;r*=scale;g*=scale;b*=scale}byteArray[i*3+0]=r;byteArray[i*3+1]=g;byteArray[i*3+2]=b}}}if(byteArray){results.push(byteArray)}else{results.push(dataFace)}}return results};this._texture=this.getScene().getEngine().createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,BABYLON.Engine.TEXTUREFORMAT_RGB,this.getScene().getEngine().getCaps().textureFloat?BABYLON.Engine.TEXTURETYPE_FLOAT:BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,callback,mipmapGenerator,this._onLoad,this._onError)};HDRCubeTexture.prototype.loadHDRTexture=function(){var _this=this;var callback=function(buffer){var data=BABYLON.Internals.HDRTools.GetCubeMapTextureData(buffer,_this._size);if(_this._generateHarmonics){var sphericalPolynomial=BABYLON.Internals.CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial(data);_this.sphericalPolynomial=sphericalPolynomial}var results=[];var byteArray=null;for(var j=0;j<6;j++){if(!_this.getScene().getEngine().getCaps().textureFloat){var byteBuffer=new ArrayBuffer(_this._size*_this._size*3);byteArray=new Uint8Array(byteBuffer)}var dataFace=data[HDRCubeTexture._facesMapping[j]];if(_this._useInGammaSpace||byteArray){for(var i=0;i<_this._size*_this._size;i++){if(_this._useInGammaSpace){dataFace[i*3+0]=Math.pow(dataFace[i*3+0],BABYLON.ToGammaSpace);dataFace[i*3+1]=Math.pow(dataFace[i*3+1],BABYLON.ToGammaSpace);dataFace[i*3+2]=Math.pow(dataFace[i*3+2],BABYLON.ToGammaSpace)}if(byteArray){var r=Math.max(dataFace[i*3+0]*255,0);var g=Math.max(dataFace[i*3+1]*255,0);var b=Math.max(dataFace[i*3+2]*255,0);var max=Math.max(Math.max(r,g),b);if(max>255){var scale=255/max;r*=scale;g*=scale;b*=scale}byteArray[i*3+0]=r;byteArray[i*3+1]=g;byteArray[i*3+2]=b}}}if(byteArray){results.push(byteArray)}else{results.push(dataFace)}}return results};var mipmapGenerator=null;this._texture=this.getScene().getEngine().createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,BABYLON.Engine.TEXTUREFORMAT_RGB,this.getScene().getEngine().getCaps().textureFloat?BABYLON.Engine.TEXTURETYPE_FLOAT:BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,callback,mipmapGenerator,this._onLoad,this._onError)};HDRCubeTexture.prototype.loadTexture=function(){if(this._isBABYLONPreprocessed){this.loadBabylonTexture()}else{this.loadHDRTexture()}};HDRCubeTexture.prototype.clone=function(){var size=this._isBABYLONPreprocessed?null:this._size;var newTexture=new HDRCubeTexture(this.url,this.getScene(),size,this._noMipmap,this._generateHarmonics,this._useInGammaSpace,this._usePMREMGenerator);newTexture.level=this.level;newTexture.wrapU=this.wrapU;newTexture.wrapV=this.wrapV;newTexture.coordinatesIndex=this.coordinatesIndex;newTexture.coordinatesMode=this.coordinatesMode;return newTexture};HDRCubeTexture.prototype.delayLoad=function(){if(this.delayLoadState!==BABYLON.Engine.DELAYLOADSTATE_NOTLOADED){return}this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED;this._texture=this._getFromCache(this.url,this._noMipmap);if(!this._texture){this.loadTexture()}};HDRCubeTexture.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix};HDRCubeTexture.prototype.setReflectionTextureMatrix=function(value){this._textureMatrix=value};HDRCubeTexture.Parse=function(parsedTexture,scene,rootUrl){var texture=null;if(parsedTexture.name&&!parsedTexture.isRenderTarget){var size=parsedTexture.isBABYLONPreprocessed?null:parsedTexture.size;texture=new BABYLON.HDRCubeTexture(rootUrl+parsedTexture.name,scene,size,parsedTexture.noMipmap,parsedTexture.generateHarmonics,parsedTexture.useInGammaSpace,parsedTexture.usePMREMGenerator);texture.name=parsedTexture.name;texture.hasAlpha=parsedTexture.hasAlpha;texture.level=parsedTexture.level;texture.coordinatesMode=parsedTexture.coordinatesMode;texture.isBlocking=parsedTexture.isBlocking}return texture};HDRCubeTexture.prototype.serialize=function(){if(!this.name){return null}var serializationObject={};serializationObject.name=this.name;serializationObject.hasAlpha=this.hasAlpha;serializationObject.isCube=true;serializationObject.level=this.level;serializationObject.size=this._size;serializationObject.coordinatesMode=this.coordinatesMode;serializationObject.useInGammaSpace=this._useInGammaSpace;serializationObject.generateHarmonics=this._generateHarmonics;serializationObject.usePMREMGenerator=this._usePMREMGenerator;serializationObject.isBABYLONPreprocessed=this._isBABYLONPreprocessed;serializationObject.customType="BABYLON.HDRCubeTexture";serializationObject.noMipmap=this._noMipmap;serializationObject.isBlocking=this._isBlocking;return serializationObject};HDRCubeTexture.generateBabylonHDROnDisk=function(url,size,onError){if(onError===void 0){onError=null}var callback=function(buffer){var data=new Blob([buffer],{type:"application/octet-stream"});var objUrl=window.URL.createObjectURL(data);var a=document.createElement("a");document.body.appendChild(a);a.style.display="none";a.href=objUrl;a.download="envmap.babylon.hdr";a.click()};HDRCubeTexture.generateBabylonHDR(url,size,callback,onError)};HDRCubeTexture.generateBabylonHDR=function(url,size,callback,onError){if(onError===void 0){onError=null}if(!url){return null}if(!BABYLON.Tools.IsExponentOfTwo(size)){return null}BABYLON.Tools.Error("Generation of Babylon HDR is coming back in 3.1.");return null};HDRCubeTexture._facesMapping=["right","left","up","down","front","back"];return HDRCubeTexture}(BABYLON.BaseTexture);BABYLON.HDRCubeTexture=HDRCubeTexture})(BABYLON||(BABYLON={}));var Earcut;(function(Earcut){function earcut(data,holeIndices,dim){dim=dim||2;var hasHoles=holeIndices&&holeIndices.length,outerLen=hasHoles?holeIndices[0]*dim:data.length,outerNode=linkedList(data,0,outerLen,dim,true),triangles=new Array;if(!outerNode)return triangles;var minX,minY,maxX,maxY,x,y,size;if(hasHoles)outerNode=eliminateHoles(data,holeIndices,outerNode,dim);if(data.length>80*dim){minX=maxX=data[0];minY=maxY=data[1];for(var i=dim;i<outerLen;i+=dim){x=data[i];y=data[i+1];if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y}size=Math.max(maxX-minX,maxY-minY)}earcutLinked(outerNode,triangles,dim,minX,minY,size,undefined);return triangles}Earcut.earcut=earcut;var Node=function(){function Node(i,x,y){this.i=i;this.x=x;this.y=y;this.prev=null;this.next=null;this.z=null;this.prevZ=null;this.nextZ=null;this.steiner=false}return Node}();function linkedList(data,start,end,dim,clockwise){var i,last;if(clockwise===signedArea(data,start,end,dim)>0){for(i=start;i<end;i+=dim)last=insertNode(i,data[i],data[i+1],last)}else{for(i=end-dim;i>=start;i-=dim)last=insertNode(i,data[i],data[i+1],last)}if(last&&equals(last,last.next)){removeNode(last);last=last.next}return last}function filterPoints(start,end){if(!start)return start;if(!end)end=start;var p=start,again;do{again=false;if(!p.steiner&&(equals(p,p.next)||area(p.prev,p,p.next)===0)){removeNode(p);p=end=p.prev;if(p===p.next)return null;again=true}else{p=p.next}}while(again||p!==end);return end}function earcutLinked(ear,triangles,dim,minX,minY,size,pass){if(!ear)return;if(!pass&&size)indexCurve(ear,minX,minY,size);var stop=ear,prev,next;while(ear.prev!==ear.next){prev=ear.prev;next=ear.next;if(size?isEarHashed(ear,minX,minY,size):isEar(ear)){triangles.push(prev.i/dim);triangles.push(ear.i/dim);triangles.push(next.i/dim);removeNode(ear);ear=next.next;stop=next.next;continue}ear=next;if(ear===stop){if(!pass){earcutLinked(filterPoints(ear,undefined),triangles,dim,minX,minY,size,1)}else if(pass===1){ear=cureLocalIntersections(ear,triangles,dim);earcutLinked(ear,triangles,dim,minX,minY,size,2)}else if(pass===2){splitEarcut(ear,triangles,dim,minX,minY,size)}break}}}function isEar(ear){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return false;var p=ear.next.next;while(p!==ear.prev){if(pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return false;p=p.next}return true}function isEarHashed(ear,minX,minY,size){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return false;var minTX=a.x<b.x?a.x<c.x?a.x:c.x:b.x<c.x?b.x:c.x,minTY=a.y<b.y?a.y<c.y?a.y:c.y:b.y<c.y?b.y:c.y,maxTX=a.x>b.x?a.x>c.x?a.x:c.x:b.x>c.x?b.x:c.x,maxTY=a.y>b.y?a.y>c.y?a.y:c.y:b.y>c.y?b.y:c.y;var minZ=zOrder(minTX,minTY,minX,minY,size),maxZ=zOrder(maxTX,maxTY,minX,minY,size);var p=ear.nextZ;while(p&&p.z<=maxZ){if(p!==ear.prev&&p!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return false;p=p.nextZ}p=ear.prevZ;while(p&&p.z>=minZ){if(p!==ear.prev&&p!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return false;p=p.prevZ}return true}function cureLocalIntersections(start,triangles,dim){var p=start;do{var a=p.prev,b=p.next.next;if(!equals(a,b)&&intersects(a,p,p.next,b)&&locallyInside(a,b)&&locallyInside(b,a)){triangles.push(a.i/dim);triangles.push(p.i/dim);triangles.push(b.i/dim);removeNode(p);removeNode(p.next);p=start=b}p=p.next}while(p!==start);return p}function splitEarcut(start,triangles,dim,minX,minY,size){var a=start;do{var b=a.next.next;while(b!==a.prev){if(a.i!==b.i&&isValidDiagonal(a,b)){var c=splitPolygon(a,b);a=filterPoints(a,a.next);c=filterPoints(c,c.next);earcutLinked(a,triangles,dim,minX,minY,size,undefined);earcutLinked(c,triangles,dim,minX,minY,size,undefined);return}b=b.next}a=a.next}while(a!==start)}function eliminateHoles(data,holeIndices,outerNode,dim){var queue=[],i,len,start,end,list;for(i=0,len=holeIndices.length;i<len;i++){start=holeIndices[i]*dim;end=i<len-1?holeIndices[i+1]*dim:data.length;list=linkedList(data,start,end,dim,false);if(list===list.next)list.steiner=true;queue.push(getLeftmost(list))}queue.sort(compareX);for(i=0;i<queue.length;i++){eliminateHole(queue[i],outerNode);outerNode=filterPoints(outerNode,outerNode.next)}return outerNode}function compareX(a,b){return a.x-b.x}function eliminateHole(hole,outerNode){outerNode=findHoleBridge(hole,outerNode);if(outerNode){var b=splitPolygon(outerNode,hole);filterPoints(b,b.next)}}function findHoleBridge(hole,outerNode){var p=outerNode,hx=hole.x,hy=hole.y,qx=-Infinity,m;do{if(hy<=p.y&&hy>=p.next.y){var x=p.x+(hy-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(x<=hx&&x>qx){qx=x;if(x===hx){if(hy===p.y)return p;if(hy===p.next.y)return p.next}m=p.x<p.next.x?p:p.next}}p=p.next}while(p!==outerNode);if(!m)return null;if(hx===qx)return m.prev;var stop=m,mx=m.x,my=m.y,tanMin=Infinity,tan;p=m.next;while(p!==stop){if(hx>=p.x&&p.x>=mx&&pointInTriangle(hy<my?hx:qx,hy,mx,my,hy<my?qx:hx,hy,p.x,p.y)){tan=Math.abs(hy-p.y)/(hx-p.x);if((tan<tanMin||tan===tanMin&&p.x>m.x)&&locallyInside(p,hole)){m=p;tanMin=tan}}p=p.next}return m}function indexCurve(start,minX,minY,size){var p=start;do{if(p.z===null)p.z=zOrder(p.x,p.y,minX,minY,size);p.prevZ=p.prev;p.nextZ=p.next;p=p.next}while(p!==start);p.prevZ.nextZ=null;p.prevZ=null;sortLinked(p)}function sortLinked(list){var i,p,q,e,tail,numMerges,pSize,qSize,inSize=1;do{p=list;list=null;tail=null;numMerges=0;while(p){numMerges++;q=p;pSize=0;for(i=0;i<inSize;i++){pSize++;q=q.nextZ;if(!q)break}qSize=inSize;while(pSize>0||qSize>0&&q){if(pSize===0){e=q;q=q.nextZ;qSize--}else if(qSize===0||!q){e=p;p=p.nextZ;pSize--}else if(p.z<=q.z){e=p;p=p.nextZ;pSize--}else{e=q;q=q.nextZ;qSize--}if(tail)tail.nextZ=e;else list=e;e.prevZ=tail;tail=e}p=q}tail.nextZ=null;inSize*=2}while(numMerges>1);return list}function zOrder(x,y,minX,minY,size){x=32767*(x-minX)/size;y=32767*(y-minY)/size;x=(x|x<<8)&16711935;x=(x|x<<4)&252645135;x=(x|x<<2)&858993459;x=(x|x<<1)&1431655765;y=(y|y<<8)&16711935;y=(y|y<<4)&252645135;y=(y|y<<2)&858993459;y=(y|y<<1)&1431655765;return x|y<<1}function getLeftmost(start){var p=start,leftmost=start;do{if(p.x<leftmost.x)leftmost=p;p=p.next}while(p!==start);return leftmost}function pointInTriangle(ax,ay,bx,by,cx,cy,px,py){return(cx-px)*(ay-py)-(ax-px)*(cy-py)>=0&&(ax-px)*(by-py)-(bx-px)*(ay-py)>=0&&(bx-px)*(cy-py)-(cx-px)*(by-py)>=0}function isValidDiagonal(a,b){return a.next.i!==b.i&&a.prev.i!==b.i&&!intersectsPolygon(a,b)&&locallyInside(a,b)&&locallyInside(b,a)&&middleInside(a,b)}function area(p,q,r){return(q.y-p.y)*(r.x-q.x)-(q.x-p.x)*(r.y-q.y)}function equals(p1,p2){return p1.x===p2.x&&p1.y===p2.y}function intersects(p1,q1,p2,q2){if(equals(p1,q1)&&equals(p2,q2)||equals(p1,q2)&&equals(p2,q1))return true;return area(p1,q1,p2)>0!==area(p1,q1,q2)>0&&area(p2,q2,p1)>0!==area(p2,q2,q1)>0}function intersectsPolygon(a,b){var p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==b.i&&p.next.i!==b.i&&intersects(p,p.next,a,b))return true;p=p.next}while(p!==a);return false}function locallyInside(a,b){return area(a.prev,a,a.next)<0?area(a,b,a.next)>=0&&area(a,a.prev,b)>=0:area(a,b,a.prev)<0||area(a,a.next,b)<0}function middleInside(a,b){var p=a,inside=false,px=(a.x+b.x)/2,py=(a.y+b.y)/2;do{if(p.y>py!==p.next.y>py&&px<(p.next.x-p.x)*(py-p.y)/(p.next.y-p.y)+p.x)inside=!inside;p=p.next}while(p!==a);return inside}function splitPolygon(a,b){var a2=new Node(a.i,a.x,a.y),b2=new Node(b.i,b.x,b.y),an=a.next,bp=b.prev;a.next=b;b.prev=a;a2.next=an;an.prev=a2;b2.next=a2;a2.prev=b2;bp.next=b2;b2.prev=bp;return b2}function insertNode(i,x,y,last){var p=new Node(i,x,y);if(!last){p.prev=p;p.next=p}else{p.next=last.next;p.prev=last;last.next.prev=p;last.next=p}return p}function removeNode(p){p.next.prev=p.prev;p.prev.next=p.next;if(p.prevZ)p.prevZ.nextZ=p.nextZ;if(p.nextZ)p.nextZ.prevZ=p.prevZ}function deviation(data,holeIndices,dim,triangles){var hasHoles=holeIndices&&holeIndices.length;var outerLen=hasHoles?holeIndices[0]*dim:data.length;var polygonArea=Math.abs(signedArea(data,0,outerLen,dim));if(hasHoles){for(var i=0,len=holeIndices.length;i<len;i++){var start=holeIndices[i]*dim;var end=i<len-1?holeIndices[i+1]*dim:data.length;polygonArea-=Math.abs(signedArea(data,start,end,dim))}}var trianglesArea=0;for(i=0;i<triangles.length;i+=3){var a=triangles[i]*dim;var b=triangles[i+1]*dim;var c=triangles[i+2]*dim;trianglesArea+=Math.abs((data[a]-data[c])*(data[b+1]-data[a+1])-(data[a]-data[b])*(data[c+1]-data[a+1]))}return polygonArea===0&&trianglesArea===0?0:Math.abs((trianglesArea-polygonArea)/polygonArea)}Earcut.deviation=deviation;function signedArea(data,start,end,dim){var sum=0;for(var i=start,j=end-dim;i<end;i+=dim){sum+=(data[j]-data[i])*(data[i+1]+data[j+1]);j=i}return sum}function flatten(data){var dim=data[0][0].length,result={vertices:new Array,holes:new Array,dimensions:dim},holeIndex=0;for(var i=0;i<data.length;i++){for(var j=0;j<data[i].length;j++){for(var d=0;d<dim;d++)result.vertices.push(data[i][j][d])}if(i>0){holeIndex+=data[i-1].length;result.holes.push(holeIndex)}}return result}Earcut.flatten=flatten})(Earcut||(Earcut={}));var BABYLON;(function(BABYLON){var IndexedVector2=function(_super){__extends(IndexedVector2,_super);function IndexedVector2(original,index){var _this=_super.call(this,original.x,original.y)||this;_this.index=index;return _this}return IndexedVector2}(BABYLON.Vector2);var PolygonPoints=function(){function PolygonPoints(){this.elements=new Array}PolygonPoints.prototype.add=function(originalPoints){var _this=this;var result=new Array;originalPoints.forEach(function(point){if(result.length===0||!point.equalsWithEpsilon(result[0])){var newPoint=new IndexedVector2(point,_this.elements.length);result.push(newPoint);_this.elements.push(newPoint)}});return result};PolygonPoints.prototype.computeBounds=function(){var lmin=new BABYLON.Vector2(this.elements[0].x,this.elements[0].y);var lmax=new BABYLON.Vector2(this.elements[0].x,this.elements[0].y);this.elements.forEach(function(point){if(point.x<lmin.x){lmin.x=point.x}else if(point.x>lmax.x){lmax.x=point.x}if(point.y<lmin.y){lmin.y=point.y}else if(point.y>lmax.y){lmax.y=point.y}});return{min:lmin,max:lmax,width:lmax.x-lmin.x,height:lmax.y-lmin.y}};return PolygonPoints}();var Polygon=function(){function Polygon(){}Polygon.Rectangle=function(xmin,ymin,xmax,ymax){return[new BABYLON.Vector2(xmin,ymin),new BABYLON.Vector2(xmax,ymin),new BABYLON.Vector2(xmax,ymax),new BABYLON.Vector2(xmin,ymax)]};Polygon.Circle=function(radius,cx,cy,numberOfSides){if(cx===void 0){cx=0}if(cy===void 0){cy=0}if(numberOfSides===void 0){numberOfSides=32}var result=new Array;var angle=0;var increment=Math.PI*2/numberOfSides;for(var i=0;i<numberOfSides;i++){result.push(new BABYLON.Vector2(cx+Math.cos(angle)*radius,cy+Math.sin(angle)*radius));angle-=increment}return result};Polygon.Parse=function(input){var floats=input.split(/[^-+eE\.\d]+/).map(parseFloat).filter(function(val){return!isNaN(val)});var i,result=[];for(i=0;i<(floats.length&2147483646);i+=2){result.push(new BABYLON.Vector2(floats[i],floats[i+1]))}return result};Polygon.StartingAt=function(x,y){return BABYLON.Path2.StartingAt(x,y)};return Polygon}();BABYLON.Polygon=Polygon;var PolygonMeshBuilder=function(){function PolygonMeshBuilder(name,contours,scene){this._points=new PolygonPoints;this._outlinepoints=new PolygonPoints;this._holes=new Array;this._epoints=new Array;this._eholes=new Array;this._name=name;this._scene=scene;var points;if(contours instanceof BABYLON.Path2){points=contours.getPoints()}else{points=contours}this._addToepoint(points);this._points.add(points);this._outlinepoints.add(points)}PolygonMeshBuilder.prototype._addToepoint=function(points){for(var _i=0,points_1=points;_i<points_1.length;_i++){var p=points_1[_i];this._epoints.push(p.x,p.y)}};PolygonMeshBuilder.prototype.addHole=function(hole){this._points.add(hole);var holepoints=new PolygonPoints;holepoints.add(hole);this._holes.push(holepoints);this._eholes.push(this._epoints.length/2);this._addToepoint(hole);return this};PolygonMeshBuilder.prototype.build=function(updatable,depth){var _this=this;if(updatable===void 0){updatable=false}var result=new BABYLON.Mesh(this._name,this._scene);var normals=new Array;var positions=new Array;var uvs=new Array;var bounds=this._points.computeBounds();this._points.elements.forEach(function(p){normals.push(0,1,0);positions.push(p.x,0,p.y);uvs.push((p.x-bounds.min.x)/bounds.width,(p.y-bounds.min.y)/bounds.height)});var indices=new Array;var res=Earcut.earcut(this._epoints,this._eholes,2);for(var i=0;i<res.length;i++){indices.push(res[i])}if(depth>0){var positionscount=positions.length/3;this._points.elements.forEach(function(p){normals.push(0,-1,0);positions.push(p.x,-depth,p.y);uvs.push(1-(p.x-bounds.min.x)/bounds.width,1-(p.y-bounds.min.y)/bounds.height)});var totalCount=indices.length;for(var i=0;i<totalCount;i+=3){var i0=indices[i+0];var i1=indices[i+1];var i2=indices[i+2];indices.push(i2+positionscount);indices.push(i1+positionscount);indices.push(i0+positionscount)}this.addSide(positions,normals,uvs,indices,bounds,this._outlinepoints,depth,false);this._holes.forEach(function(hole){_this.addSide(positions,normals,uvs,indices,bounds,hole,depth,true)})}result.setVerticesData(BABYLON.VertexBuffer.PositionKind,positions,updatable);result.setVerticesData(BABYLON.VertexBuffer.NormalKind,normals,updatable);result.setVerticesData(BABYLON.VertexBuffer.UVKind,uvs,updatable);result.setIndices(indices);return result};PolygonMeshBuilder.prototype.addSide=function(positions,normals,uvs,indices,bounds,points,depth,flip){var StartIndex=positions.length/3;var ulength=0;for(var i=0;i<points.elements.length;i++){var p=points.elements[i];var p1;if(i+1>points.elements.length-1){p1=points.elements[0]}else{p1=points.elements[i+1]}positions.push(p.x,0,p.y);positions.push(p.x,-depth,p.y);positions.push(p1.x,0,p1.y);positions.push(p1.x,-depth,p1.y);var v1=new BABYLON.Vector3(p.x,0,p.y);var v2=new BABYLON.Vector3(p1.x,0,p1.y);var v3=v2.subtract(v1);var v4=new BABYLON.Vector3(0,1,0);var vn=BABYLON.Vector3.Cross(v3,v4);vn=vn.normalize();uvs.push(ulength/bounds.width,0);uvs.push(ulength/bounds.width,1);ulength+=v3.length();uvs.push(ulength/bounds.width,0);uvs.push(ulength/bounds.width,1);if(!flip){normals.push(-vn.x,-vn.y,-vn.z);normals.push(-vn.x,-vn.y,-vn.z);normals.push(-vn.x,-vn.y,-vn.z);normals.push(-vn.x,-vn.y,-vn.z);indices.push(StartIndex);indices.push(StartIndex+1);indices.push(StartIndex+2);indices.push(StartIndex+1);indices.push(StartIndex+3);indices.push(StartIndex+2)}else{normals.push(vn.x,vn.y,vn.z);normals.push(vn.x,vn.y,vn.z);normals.push(vn.x,vn.y,vn.z);normals.push(vn.x,vn.y,vn.z);indices.push(StartIndex);indices.push(StartIndex+2);indices.push(StartIndex+1);indices.push(StartIndex+1);indices.push(StartIndex+2);indices.push(StartIndex+3)}StartIndex+=4}};return PolygonMeshBuilder}();BABYLON.PolygonMeshBuilder=PolygonMeshBuilder})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var currentCSGMeshId=0;var Vertex=function(){function Vertex(pos,normal,uv){this.pos=pos;this.normal=normal;this.uv=uv}Vertex.prototype.clone=function(){return new Vertex(this.pos.clone(),this.normal.clone(),this.uv.clone())};Vertex.prototype.flip=function(){this.normal=this.normal.scale(-1)};Vertex.prototype.interpolate=function(other,t){return new Vertex(BABYLON.Vector3.Lerp(this.pos,other.pos,t),BABYLON.Vector3.Lerp(this.normal,other.normal,t),BABYLON.Vector2.Lerp(this.uv,other.uv,t))};return Vertex}();var Plane=function(){function Plane(normal,w){this.normal=normal;this.w=w}Plane.FromPoints=function(a,b,c){var v0=c.subtract(a);var v1=b.subtract(a);if(v0.lengthSquared()===0||v1.lengthSquared()===0){return null}var n=BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(v0,v1));return new Plane(n,BABYLON.Vector3.Dot(n,a))};Plane.prototype.clone=function(){return new Plane(this.normal.clone(),this.w)};Plane.prototype.flip=function(){this.normal.scaleInPlace(-1);this.w=-this.w};Plane.prototype.splitPolygon=function(polygon,coplanarFront,coplanarBack,front,back){var COPLANAR=0;var FRONT=1;var BACK=2;var SPANNING=3;var polygonType=0;var types=[];var i;var t;for(i=0;i<polygon.vertices.length;i++){t=BABYLON.Vector3.Dot(this.normal,polygon.vertices[i].pos)-this.w;var type=t<-Plane.EPSILON?BACK:t>Plane.EPSILON?FRONT:COPLANAR;polygonType|=type;types.push(type)}switch(polygonType){case COPLANAR:(BABYLON.Vector3.Dot(this.normal,polygon.plane.normal)>0?coplanarFront:coplanarBack).push(polygon);break;case FRONT:front.push(polygon);break;case BACK:back.push(polygon);break;case SPANNING:var f=[],b=[];for(i=0;i<polygon.vertices.length;i++){var j=(i+1)%polygon.vertices.length;var ti=types[i],tj=types[j];var vi=polygon.vertices[i],vj=polygon.vertices[j];if(ti!==BACK)f.push(vi);if(ti!==FRONT)b.push(ti!==BACK?vi.clone():vi);if((ti|tj)===SPANNING){t=(this.w-BABYLON.Vector3.Dot(this.normal,vi.pos))/BABYLON.Vector3.Dot(this.normal,vj.pos.subtract(vi.pos));var v=vi.interpolate(vj,t);f.push(v);b.push(v.clone())}}var poly;if(f.length>=3){poly=new Polygon(f,polygon.shared);if(poly.plane)front.push(poly)}if(b.length>=3){poly=new Polygon(b,polygon.shared);if(poly.plane)back.push(poly)}break}};Plane.EPSILON=1e-5;return Plane}();var Polygon=function(){function Polygon(vertices,shared){this.vertices=vertices;this.shared=shared;this.plane=Plane.FromPoints(vertices[0].pos,vertices[1].pos,vertices[2].pos)}Polygon.prototype.clone=function(){var vertices=this.vertices.map(function(v){return v.clone()});return new Polygon(vertices,this.shared)};Polygon.prototype.flip=function(){this.vertices.reverse().map(function(v){v.flip()});this.plane.flip()};return Polygon}();var Node=function(){function Node(polygons){this.plane=null;this.front=null;this.back=null;this.polygons=new Array;if(polygons){this.build(polygons)}}Node.prototype.clone=function(){var node=new Node;node.plane=this.plane&&this.plane.clone();node.front=this.front&&this.front.clone();node.back=this.back&&this.back.clone();node.polygons=this.polygons.map(function(p){return p.clone()});return node};Node.prototype.invert=function(){for(var i=0;i<this.polygons.length;i++){this.polygons[i].flip()}if(this.plane){this.plane.flip()}if(this.front){this.front.invert()}if(this.back){this.back.invert()}var temp=this.front;this.front=this.back;this.back=temp};Node.prototype.clipPolygons=function(polygons){if(!this.plane)return polygons.slice();var front=new Array,back=new Array;for(var i=0;i<polygons.length;i++){this.plane.splitPolygon(polygons[i],front,back,front,back)}if(this.front){front=this.front.clipPolygons(front)}if(this.back){back=this.back.clipPolygons(back)}else{back=[]}return front.concat(back)};Node.prototype.clipTo=function(bsp){this.polygons=bsp.clipPolygons(this.polygons);if(this.front)this.front.clipTo(bsp);if(this.back)this.back.clipTo(bsp)};Node.prototype.allPolygons=function(){var polygons=this.polygons.slice();if(this.front)polygons=polygons.concat(this.front.allPolygons());if(this.back)polygons=polygons.concat(this.back.allPolygons());return polygons};Node.prototype.build=function(polygons){if(!polygons.length)return;if(!this.plane)this.plane=polygons[0].plane.clone();var front=new Array,back=new Array;for(var i=0;i<polygons.length;i++){this.plane.splitPolygon(polygons[i],this.polygons,this.polygons,front,back)}if(front.length){if(!this.front)this.front=new Node;this.front.build(front)}if(back.length){if(!this.back)this.back=new Node;this.back.build(back)}};return Node}();var CSG=function(){function CSG(){this.polygons=new Array}CSG.FromMesh=function(mesh){var vertex,normal,uv,position,polygon,polygons=new Array,vertices;var matrix,meshPosition,meshRotation,meshRotationQuaternion,meshScaling;if(mesh instanceof BABYLON.Mesh){mesh.computeWorldMatrix(true);matrix=mesh.getWorldMatrix();meshPosition=mesh.position.clone();meshRotation=mesh.rotation.clone();if(mesh.rotationQuaternion){meshRotationQuaternion=mesh.rotationQuaternion.clone()}meshScaling=mesh.scaling.clone()}else{throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh"}var indices=mesh.getIndices(),positions=mesh.getVerticesData(BABYLON.VertexBuffer.PositionKind),normals=mesh.getVerticesData(BABYLON.VertexBuffer.NormalKind),uvs=mesh.getVerticesData(BABYLON.VertexBuffer.UVKind);var subMeshes=mesh.subMeshes;for(var sm=0,sml=subMeshes.length;sm<sml;sm++){for(var i=subMeshes[sm].indexStart,il=subMeshes[sm].indexCount+subMeshes[sm].indexStart;i<il;i+=3){vertices=[];for(var j=0;j<3;j++){var sourceNormal=new BABYLON.Vector3(normals[indices[i+j]*3],normals[indices[i+j]*3+1],normals[indices[i+j]*3+2]);uv=new BABYLON.Vector2(uvs[indices[i+j]*2],uvs[indices[i+j]*2+1]);var sourcePosition=new BABYLON.Vector3(positions[indices[i+j]*3],positions[indices[i+j]*3+1],positions[indices[i+j]*3+2]);position=BABYLON.Vector3.TransformCoordinates(sourcePosition,matrix);normal=BABYLON.Vector3.TransformNormal(sourceNormal,matrix);vertex=new Vertex(position,normal,uv);vertices.push(vertex)}polygon=new Polygon(vertices,{subMeshId:sm,meshId:currentCSGMeshId,materialIndex:subMeshes[sm].materialIndex});if(polygon.plane)polygons.push(polygon)}}var csg=CSG.FromPolygons(polygons);csg.matrix=matrix;csg.position=meshPosition;csg.rotation=meshRotation;csg.scaling=meshScaling;csg.rotationQuaternion=meshRotationQuaternion;currentCSGMeshId++;return csg};CSG.FromPolygons=function(polygons){var csg=new CSG;csg.polygons=polygons;return csg};CSG.prototype.clone=function(){var csg=new CSG;csg.polygons=this.polygons.map(function(p){return p.clone()});csg.copyTransformAttributes(this);return csg};CSG.prototype.union=function(csg){var a=new Node(this.clone().polygons);var b=new Node(csg.clone().polygons);a.clipTo(b);b.clipTo(a);b.invert();b.clipTo(a);b.invert();a.build(b.allPolygons());return CSG.FromPolygons(a.allPolygons()).copyTransformAttributes(this)};CSG.prototype.unionInPlace=function(csg){var a=new Node(this.polygons);var b=new Node(csg.polygons);a.clipTo(b);b.clipTo(a);b.invert();b.clipTo(a);b.invert();a.build(b.allPolygons());this.polygons=a.allPolygons()};CSG.prototype.subtract=function(csg){var a=new Node(this.clone().polygons);var b=new Node(csg.clone().polygons);a.invert();a.clipTo(b);b.clipTo(a);b.invert();b.clipTo(a);b.invert();a.build(b.allPolygons());a.invert();return CSG.FromPolygons(a.allPolygons()).copyTransformAttributes(this)};CSG.prototype.subtractInPlace=function(csg){var a=new Node(this.polygons);var b=new Node(csg.polygons);a.invert();a.clipTo(b);b.clipTo(a);b.invert();b.clipTo(a);b.invert();a.build(b.allPolygons());a.invert();this.polygons=a.allPolygons()};CSG.prototype.intersect=function(csg){var a=new Node(this.clone().polygons);var b=new Node(csg.clone().polygons);a.invert();b.clipTo(a);b.invert();a.clipTo(b);b.clipTo(a);a.build(b.allPolygons());a.invert();return CSG.FromPolygons(a.allPolygons()).copyTransformAttributes(this)};CSG.prototype.intersectInPlace=function(csg){var a=new Node(this.polygons);var b=new Node(csg.polygons);a.invert();b.clipTo(a);b.invert();a.clipTo(b);b.clipTo(a);a.build(b.allPolygons());a.invert();this.polygons=a.allPolygons()};CSG.prototype.inverse=function(){var csg=this.clone();csg.inverseInPlace();return csg};CSG.prototype.inverseInPlace=function(){this.polygons.map(function(p){p.flip()})};CSG.prototype.copyTransformAttributes=function(csg){this.matrix=csg.matrix;this.position=csg.position;this.rotation=csg.rotation;this.scaling=csg.scaling;this.rotationQuaternion=csg.rotationQuaternion;return this};CSG.prototype.buildMeshGeometry=function(name,scene,keepSubMeshes){var matrix=this.matrix.clone();matrix.invert();var mesh=new BABYLON.Mesh(name,scene),vertices=[],indices=[],normals=[],uvs=[],vertex=BABYLON.Vector3.Zero(),normal=BABYLON.Vector3.Zero(),uv=BABYLON.Vector2.Zero(),polygons=this.polygons,polygonIndices=[0,0,0],polygon,vertice_dict={},vertex_idx,currentIndex=0,subMesh_dict={},subMesh_obj;if(keepSubMeshes){polygons.sort(function(a,b){if(a.shared.meshId===b.shared.meshId){return a.shared.subMeshId-b.shared.subMeshId}else{return a.shared.meshId-b.shared.meshId}})}for(var i=0,il=polygons.length;i<il;i++){polygon=polygons[i];if(!subMesh_dict[polygon.shared.meshId]){subMesh_dict[polygon.shared.meshId]={}}if(!subMesh_dict[polygon.shared.meshId][polygon.shared.subMeshId]){subMesh_dict[polygon.shared.meshId][polygon.shared.subMeshId]={indexStart:+Infinity,indexEnd:-Infinity,materialIndex:polygon.shared.materialIndex}}subMesh_obj=subMesh_dict[polygon.shared.meshId][polygon.shared.subMeshId];for(var j=2,jl=polygon.vertices.length;j<jl;j++){polygonIndices[0]=0;polygonIndices[1]=j-1;polygonIndices[2]=j;for(var k=0;k<3;k++){vertex.copyFrom(polygon.vertices[polygonIndices[k]].pos);normal.copyFrom(polygon.vertices[polygonIndices[k]].normal);uv.copyFrom(polygon.vertices[polygonIndices[k]].uv);var localVertex=BABYLON.Vector3.TransformCoordinates(vertex,matrix);var localNormal=BABYLON.Vector3.TransformNormal(normal,matrix);vertex_idx=vertice_dict[localVertex.x+","+localVertex.y+","+localVertex.z];if(!(typeof vertex_idx!=="undefined"&&normals[vertex_idx*3]===localNormal.x&&normals[vertex_idx*3+1]===localNormal.y&&normals[vertex_idx*3+2]===localNormal.z&&uvs[vertex_idx*2]===uv.x&&uvs[vertex_idx*2+1]===uv.y)){vertices.push(localVertex.x,localVertex.y,localVertex.z);uvs.push(uv.x,uv.y);normals.push(normal.x,normal.y,normal.z);vertex_idx=vertice_dict[localVertex.x+","+localVertex.y+","+localVertex.z]=vertices.length/3-1}indices.push(vertex_idx);subMesh_obj.indexStart=Math.min(currentIndex,subMesh_obj.indexStart);subMesh_obj.indexEnd=Math.max(currentIndex,subMesh_obj.indexEnd);currentIndex++}}}mesh.setVerticesData(BABYLON.VertexBuffer.PositionKind,vertices);mesh.setVerticesData(BABYLON.VertexBuffer.NormalKind,normals);mesh.setVerticesData(BABYLON.VertexBuffer.UVKind,uvs);mesh.setIndices(indices);if(keepSubMeshes){var materialIndexOffset=0,materialMaxIndex;mesh.subMeshes=new Array;for(var m in subMesh_dict){materialMaxIndex=-1;for(var sm in subMesh_dict[m]){subMesh_obj=subMesh_dict[m][sm];BABYLON.SubMesh.CreateFromIndices(subMesh_obj.materialIndex+materialIndexOffset,subMesh_obj.indexStart,subMesh_obj.indexEnd-subMesh_obj.indexStart+1,mesh);materialMaxIndex=Math.max(subMesh_obj.materialIndex,materialMaxIndex)}materialIndexOffset+=++materialMaxIndex}}return mesh};CSG.prototype.toMesh=function(name,material,scene,keepSubMeshes){var mesh=this.buildMeshGeometry(name,scene,keepSubMeshes);mesh.material=material;mesh.position.copyFrom(this.position);mesh.rotation.copyFrom(this.rotation);if(this.rotationQuaternion){mesh.rotationQuaternion=this.rotationQuaternion.clone()}mesh.scaling.copyFrom(this.scaling);mesh.computeWorldMatrix(true);return mesh};return CSG}();BABYLON.CSG=CSG})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var LensFlare=function(){function LensFlare(size,position,color,imgUrl,system){this.size=size;this.position=position;this.alphaMode=BABYLON.Engine.ALPHA_ONEONE;this.color=color||new BABYLON.Color3(1,1,1);this.texture=imgUrl?new BABYLON.Texture(imgUrl,system.getScene(),true):null;this._system=system;system.lensFlares.push(this)}LensFlare.AddFlare=function(size,position,color,imgUrl,system){return new LensFlare(size,position,color,imgUrl,system)};LensFlare.prototype.dispose=function(){if(this.texture){this.texture.dispose()}var index=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(index,1)};return LensFlare}();BABYLON.LensFlare=LensFlare})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var LensFlareSystem=function(){function LensFlareSystem(name,emitter,scene){this.name=name;this.lensFlares=new Array;this.borderLimit=300;this.viewportBorder=0;this.layerMask=268435455;this._vertexBuffers={};this._isEnabled=true;this._scene=scene||BABYLON.Engine.LastCreatedScene;this._emitter=emitter;this.id=name;scene.lensFlareSystems.push(this);this.meshesSelectionPredicate=function(m){return m.material&&m.isVisible&&m.isEnabled()&&m.isBlocker&&(m.layerMask&scene.activeCamera.layerMask)!=0};var engine=scene.getEngine();var vertices=[];vertices.push(1,1);vertices.push(-1,1);vertices.push(-1,-1);vertices.push(1,-1);this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=new BABYLON.VertexBuffer(engine,vertices,BABYLON.VertexBuffer.PositionKind,false,false,2);var indices=[];indices.push(0);indices.push(1);indices.push(2);indices.push(0);indices.push(2);indices.push(3);this._indexBuffer=engine.createIndexBuffer(indices);this._effect=engine.createEffect("lensFlare",[BABYLON.VertexBuffer.PositionKind],["color","viewportMatrix"],["textureSampler"],"")}Object.defineProperty(LensFlareSystem.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(value){this._isEnabled=value},enumerable:true,configurable:true});LensFlareSystem.prototype.getScene=function(){return this._scene};LensFlareSystem.prototype.getEmitter=function(){return this._emitter};LensFlareSystem.prototype.setEmitter=function(newEmitter){this._emitter=newEmitter};LensFlareSystem.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position};LensFlareSystem.prototype.computeEffectivePosition=function(globalViewport){var position=this.getEmitterPosition();position=BABYLON.Vector3.Project(position,BABYLON.Matrix.Identity(),this._scene.getTransformMatrix(),globalViewport);this._positionX=position.x;this._positionY=position.y;position=BABYLON.Vector3.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix());if(this.viewportBorder>0){globalViewport.x-=this.viewportBorder;globalViewport.y-=this.viewportBorder;globalViewport.width+=this.viewportBorder*2;globalViewport.height+=this.viewportBorder*2;position.x+=this.viewportBorder;position.y+=this.viewportBorder;this._positionX+=this.viewportBorder;this._positionY+=this.viewportBorder}if(position.z>0){if(this._positionX>globalViewport.x&&this._positionX<globalViewport.x+globalViewport.width){if(this._positionY>globalViewport.y&&this._positionY<globalViewport.y+globalViewport.height)return true}return true}return false};LensFlareSystem.prototype._isVisible=function(){if(!this._isEnabled){return false}var emitterPosition=this.getEmitterPosition();var direction=emitterPosition.subtract(this._scene.activeCamera.globalPosition);var distance=direction.length();direction.normalize();var ray=new BABYLON.Ray(this._scene.activeCamera.globalPosition,direction);var pickInfo=this._scene.pickWithRay(ray,this.meshesSelectionPredicate,true);return!pickInfo.hit||pickInfo.distance>distance};LensFlareSystem.prototype.render=function(){if(!this._effect.isReady())return false;var engine=this._scene.getEngine();var viewport=this._scene.activeCamera.viewport;var globalViewport=viewport.toGlobal(engine.getRenderWidth(true),engine.getRenderHeight(true));if(!this.computeEffectivePosition(globalViewport)){return false}if(!this._isVisible()){return false}var awayX;var awayY;if(this._positionX<this.borderLimit+globalViewport.x){awayX=this.borderLimit+globalViewport.x-this._positionX}else if(this._positionX>globalViewport.x+globalViewport.width-this.borderLimit){awayX=this._positionX-globalViewport.x-globalViewport.width+this.borderLimit}else{awayX=0}if(this._positionY<this.borderLimit+globalViewport.y){awayY=this.borderLimit+globalViewport.y-this._positionY}else if(this._positionY>globalViewport.y+globalViewport.height-this.borderLimit){awayY=this._positionY-globalViewport.y-globalViewport.height+this.borderLimit}else{awayY=0}var away=awayX>awayY?awayX:awayY;away-=this.viewportBorder;if(away>this.borderLimit){away=this.borderLimit}var intensity=1-away/this.borderLimit;if(intensity<0){return false}if(intensity>1){intensity=1}if(this.viewportBorder>0){globalViewport.x+=this.viewportBorder;globalViewport.y+=this.viewportBorder;globalViewport.width-=this.viewportBorder*2;globalViewport.height-=this.viewportBorder*2;this._positionX-=this.viewportBorder;this._positionY-=this.viewportBorder}var centerX=globalViewport.x+globalViewport.width/2;var centerY=globalViewport.y+globalViewport.height/2;var distX=centerX-this._positionX;var distY=centerY-this._positionY;engine.enableEffect(this._effect);engine.setState(false);engine.setDepthBuffer(false);engine.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);for(var index=0;index<this.lensFlares.length;index++){var flare=this.lensFlares[index];engine.setAlphaMode(flare.alphaMode);var x=centerX-distX*flare.position;var y=centerY-distY*flare.position;var cw=flare.size;var ch=flare.size*engine.getAspectRatio(this._scene.activeCamera,true);var cx=2*(x/(globalViewport.width+globalViewport.x*2))-1;var cy=1-2*(y/(globalViewport.height+globalViewport.y*2));var viewportMatrix=BABYLON.Matrix.FromValues(cw/2,0,0,0,0,ch/2,0,0,0,0,1,0,cx,cy,0,1);this._effect.setMatrix("viewportMatrix",viewportMatrix);this._effect.setTexture("textureSampler",flare.texture);this._effect.setFloat4("color",flare.color.r*intensity,flare.color.g*intensity,flare.color.b*intensity,1);engine.draw(true,0,6)}engine.setDepthBuffer(true);engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE);return true};LensFlareSystem.prototype.dispose=function(){var vertexBuffer=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind];if(vertexBuffer){vertexBuffer.dispose();this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}while(this.lensFlares.length){this.lensFlares[0].dispose()}var index=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(index,1)};LensFlareSystem.Parse=function(parsedLensFlareSystem,scene,rootUrl){var emitter=scene.getLastEntryByID(parsedLensFlareSystem.emitterId);var name=parsedLensFlareSystem.name||"lensFlareSystem#"+parsedLensFlareSystem.emitterId;var lensFlareSystem=new LensFlareSystem(name,emitter,scene);lensFlareSystem.id=parsedLensFlareSystem.id||name;lensFlareSystem.borderLimit=parsedLensFlareSystem.borderLimit;for(var index=0;index<parsedLensFlareSystem.flares.length;index++){var parsedFlare=parsedLensFlareSystem.flares[index];BABYLON.LensFlare.AddFlare(parsedFlare.size,parsedFlare.position,BABYLON.Color3.FromArray(parsedFlare.color),parsedFlare.textureName?rootUrl+parsedFlare.textureName:"",lensFlareSystem)}return lensFlareSystem};LensFlareSystem.prototype.serialize=function(){var serializationObject={};serializationObject.id=this.id;serializationObject.name=this.name;serializationObject.emitterId=this.getEmitter().id;serializationObject.borderLimit=this.borderLimit;serializationObject.flares=[];for(var index=0;index<this.lensFlares.length;index++){var flare=this.lensFlares[index];serializationObject.flares.push({size:flare.size,position:flare.position,color:flare.color.asArray(),textureName:BABYLON.Tools.GetFilename(flare.texture.name)})}return serializationObject};return LensFlareSystem}();BABYLON.LensFlareSystem=LensFlareSystem})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PhysicsJoint=function(){function PhysicsJoint(type,jointData){this.type=type;this.jointData=jointData;jointData.nativeParams=jointData.nativeParams||{}}Object.defineProperty(PhysicsJoint.prototype,"physicsJoint",{get:function(){return this._physicsJoint},set:function(newJoint){if(this._physicsJoint){}this._physicsJoint=newJoint},enumerable:true,configurable:true});Object.defineProperty(PhysicsJoint.prototype,"physicsPlugin",{set:function(physicsPlugin){this._physicsPlugin=physicsPlugin},enumerable:true,configurable:true});PhysicsJoint.prototype.executeNativeFunction=function(func){func(this._physicsPlugin.world,this._physicsJoint)};PhysicsJoint.DistanceJoint=0;PhysicsJoint.HingeJoint=1;PhysicsJoint.BallAndSocketJoint=2;PhysicsJoint.WheelJoint=3;PhysicsJoint.SliderJoint=4;PhysicsJoint.PrismaticJoint=5;PhysicsJoint.UniversalJoint=6;PhysicsJoint.Hinge2Joint=PhysicsJoint.WheelJoint;PhysicsJoint.PointToPointJoint=8;PhysicsJoint.SpringJoint=9;PhysicsJoint.LockJoint=10;return PhysicsJoint}();BABYLON.PhysicsJoint=PhysicsJoint;var DistanceJoint=function(_super){__extends(DistanceJoint,_super);function DistanceJoint(jointData){return _super.call(this,PhysicsJoint.DistanceJoint,jointData)||this}DistanceJoint.prototype.updateDistance=function(maxDistance,minDistance){this._physicsPlugin.updateDistanceJoint(this,maxDistance,minDistance)};return DistanceJoint}(PhysicsJoint);BABYLON.DistanceJoint=DistanceJoint;var MotorEnabledJoint=function(_super){__extends(MotorEnabledJoint,_super);function MotorEnabledJoint(type,jointData){return _super.call(this,type,jointData)||this}MotorEnabledJoint.prototype.setMotor=function(force,maxForce){this._physicsPlugin.setMotor(this,force,maxForce)};MotorEnabledJoint.prototype.setLimit=function(upperLimit,lowerLimit){this._physicsPlugin.setLimit(this,upperLimit,lowerLimit)};return MotorEnabledJoint}(PhysicsJoint);BABYLON.MotorEnabledJoint=MotorEnabledJoint;var HingeJoint=function(_super){__extends(HingeJoint,_super);function HingeJoint(jointData){return _super.call(this,PhysicsJoint.HingeJoint,jointData)||this}HingeJoint.prototype.setMotor=function(force,maxForce){this._physicsPlugin.setMotor(this,force,maxForce)};HingeJoint.prototype.setLimit=function(upperLimit,lowerLimit){this._physicsPlugin.setLimit(this,upperLimit,lowerLimit)};return HingeJoint}(MotorEnabledJoint);BABYLON.HingeJoint=HingeJoint;var Hinge2Joint=function(_super){__extends(Hinge2Joint,_super);function Hinge2Joint(jointData){return _super.call(this,PhysicsJoint.Hinge2Joint,jointData)||this}Hinge2Joint.prototype.setMotor=function(force,maxForce,motorIndex){if(motorIndex===void 0){motorIndex=0}this._physicsPlugin.setMotor(this,force,maxForce,motorIndex)};Hinge2Joint.prototype.setLimit=function(upperLimit,lowerLimit,motorIndex){if(motorIndex===void 0){motorIndex=0}this._physicsPlugin.setLimit(this,upperLimit,lowerLimit,motorIndex)};return Hinge2Joint}(MotorEnabledJoint);BABYLON.Hinge2Joint=Hinge2Joint})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PhysicsImpostor=function(){function PhysicsImpostor(object,type,_options,_scene){if(_options===void 0){_options={mass:0}}var _this=this;this.object=object;this.type=type;this._options=_options;this._scene=_scene;this._bodyUpdateRequired=false;this._onBeforePhysicsStepCallbacks=new Array;this._onAfterPhysicsStepCallbacks=new Array;this._onPhysicsCollideCallbacks=[];this._deltaPosition=BABYLON.Vector3.Zero();this._isDisposed=false;this._tmpPositionWithDelta=BABYLON.Vector3.Zero();this._tmpRotationWithDelta=new BABYLON.Quaternion;this.beforeStep=function(){_this.object.position.subtractToRef(_this._deltaPosition,_this._tmpPositionWithDelta);if(_this._deltaRotationConjugated){_this.object.rotationQuaternion.multiplyToRef(_this._deltaRotationConjugated,_this._tmpRotationWithDelta)}else{_this._tmpRotationWithDelta.copyFrom(_this.object.rotationQuaternion)}_this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(_this,_this._tmpPositionWithDelta,_this._tmpRotationWithDelta);_this._onBeforePhysicsStepCallbacks.forEach(function(func){func(_this)})};this.afterStep=function(){_this._onAfterPhysicsStepCallbacks.forEach(function(func){func(_this)});_this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(_this);_this.object.position.addInPlace(_this._deltaPosition);if(_this._deltaRotation){_this.object.rotationQuaternion.multiplyInPlace(_this._deltaRotation)}};this.onCollideEvent=null;this.onCollide=function(e){if(!_this._onPhysicsCollideCallbacks.length&&!_this.onCollideEvent)return;var otherImpostor=_this._physicsEngine.getImpostorWithPhysicsBody(e.body);if(otherImpostor){if(_this.onCollideEvent){_this.onCollideEvent(_this,otherImpostor)}_this._onPhysicsCollideCallbacks.filter(function(obj){return obj.otherImpostors.indexOf(otherImpostor)!==-1}).forEach(function(obj){obj.callback(_this,otherImpostor)})}};if(!this.object){BABYLON.Tools.Error("No object was provided. A physics object is obligatory");return}if(!this._scene&&object.getScene){this._scene=object.getScene()}this._physicsEngine=this._scene.getPhysicsEngine();if(!this._physicsEngine){BABYLON.Tools.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors.")}else{if(!this.object.rotationQuaternion){if(this.object.rotation){this.object.rotationQuaternion=BABYLON.Quaternion.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z)}else{this.object.rotationQuaternion=new BABYLON.Quaternion}}this._options.mass=_options.mass===void 0?0:_options.mass;this._options.friction=_options.friction===void 0?.2:_options.friction;this._options.restitution=_options.restitution===void 0?.2:_options.restitution;this._joints=[];if(!this.object.parent){this._init()}else if(this.object.parent.physicsImpostor){BABYLON.Tools.Warn("You must affect impostors to children before affecting impostor to parent.")}}}Object.defineProperty(PhysicsImpostor.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:true,configurable:true});Object.defineProperty(PhysicsImpostor.prototype,"mass",{get:function(){return this._physicsEngine.getPhysicsPlugin().getBodyMass(this)},set:function(value){this.setMass(value)},enumerable:true,configurable:true});Object.defineProperty(PhysicsImpostor.prototype,"friction",{get:function(){return this._physicsEngine.getPhysicsPlugin().getBodyFriction(this)},set:function(value){this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,value)},enumerable:true,configurable:true});Object.defineProperty(PhysicsImpostor.prototype,"restitution",{get:function(){return this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this)},set:function(value){this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,value)},enumerable:true,configurable:true});PhysicsImpostor.prototype._init=function(){this._physicsEngine.removeImpostor(this);this.physicsBody=null;this._parent=this._parent||this._getPhysicsParent();if(!this.parent){this._physicsEngine.addImpostor(this)}};PhysicsImpostor.prototype._getPhysicsParent=function(){if(this.object.parent instanceof BABYLON.AbstractMesh){var parentMesh=this.object.parent;return parentMesh.physicsImpostor}return null};PhysicsImpostor.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&!this._parent};PhysicsImpostor.prototype.setScalingUpdated=function(updated){this.forceUpdate()};PhysicsImpostor.prototype.forceUpdate=function(){this._init();if(this.parent){this.parent.forceUpdate()}};Object.defineProperty(PhysicsImpostor.prototype,"physicsBody",{get:function(){return this._parent?this._parent.physicsBody:this._physicsBody},set:function(physicsBody){if(this._physicsBody){this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this)}this._physicsBody=physicsBody;this.resetUpdateFlags()},enumerable:true,configurable:true});Object.defineProperty(PhysicsImpostor.prototype,"parent",{get:function(){return this._parent},set:function(value){this._parent=value},enumerable:true,configurable:true});PhysicsImpostor.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=false};PhysicsImpostor.prototype.getObjectExtendSize=function(){if(this.object.getBoundingInfo){var q=this.object.rotationQuaternion;this.object.rotationQuaternion=PhysicsImpostor.IDENTITY_QUATERNION;this.object.computeWorldMatrix&&this.object.computeWorldMatrix(true);var size=this.object.getBoundingInfo().boundingBox.extendSizeWorld.scale(2);this.object.rotationQuaternion=q;this.object.computeWorldMatrix&&this.object.computeWorldMatrix(true);return size}else{return PhysicsImpostor.DEFAULT_OBJECT_SIZE}};PhysicsImpostor.prototype.getObjectCenter=function(){if(this.object.getBoundingInfo){return this.object.getBoundingInfo().boundingBox.centerWorld}else{return this.object.position}};PhysicsImpostor.prototype.getParam=function(paramName){return this._options[paramName]};PhysicsImpostor.prototype.setParam=function(paramName,value){this._options[paramName]=value;this._bodyUpdateRequired=true};PhysicsImpostor.prototype.setMass=function(mass){if(this.getParam("mass")!==mass){this.setParam("mass",mass)}this._physicsEngine.getPhysicsPlugin().setBodyMass(this,mass)};PhysicsImpostor.prototype.getLinearVelocity=function(){return this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this)};PhysicsImpostor.prototype.setLinearVelocity=function(velocity){this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,velocity)};PhysicsImpostor.prototype.getAngularVelocity=function(){return this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this)};PhysicsImpostor.prototype.setAngularVelocity=function(velocity){this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,velocity)};PhysicsImpostor.prototype.executeNativeFunction=function(func){func(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)};PhysicsImpostor.prototype.registerBeforePhysicsStep=function(func){this._onBeforePhysicsStepCallbacks.push(func)};PhysicsImpostor.prototype.unregisterBeforePhysicsStep=function(func){var index=this._onBeforePhysicsStepCallbacks.indexOf(func);if(index>-1){this._onBeforePhysicsStepCallbacks.splice(index,1)}else{BABYLON.Tools.Warn("Function to remove was not found")}};PhysicsImpostor.prototype.registerAfterPhysicsStep=function(func){this._onAfterPhysicsStepCallbacks.push(func)};PhysicsImpostor.prototype.unregisterAfterPhysicsStep=function(func){var index=this._onAfterPhysicsStepCallbacks.indexOf(func);if(index>-1){this._onAfterPhysicsStepCallbacks.splice(index,1)}else{BABYLON.Tools.Warn("Function to remove was not found")}};PhysicsImpostor.prototype.registerOnPhysicsCollide=function(collideAgainst,func){var collidedAgainstList=collideAgainst instanceof Array?collideAgainst:[collideAgainst];this._onPhysicsCollideCallbacks.push({callback:func,otherImpostors:collidedAgainstList})};PhysicsImpostor.prototype.unregisterOnPhysicsCollide=function(collideAgainst,func){var collidedAgainstList=collideAgainst instanceof Array?collideAgainst:[collideAgainst];var index=this._onPhysicsCollideCallbacks.indexOf({callback:func,otherImpostors:collidedAgainstList});if(index>-1){this._onPhysicsCollideCallbacks.splice(index,1)}else{BABYLON.Tools.Warn("Function to remove was not found")}};PhysicsImpostor.prototype.applyForce=function(force,contactPoint){this._physicsEngine.getPhysicsPlugin().applyForce(this,force,contactPoint)};PhysicsImpostor.prototype.applyImpulse=function(force,contactPoint){this._physicsEngine.getPhysicsPlugin().applyImpulse(this,force,contactPoint)};PhysicsImpostor.prototype.createJoint=function(otherImpostor,jointType,jointData){var joint=new BABYLON.PhysicsJoint(jointType,jointData);this.addJoint(otherImpostor,joint)};PhysicsImpostor.prototype.addJoint=function(otherImpostor,joint){this._joints.push({otherImpostor:otherImpostor,joint:joint});this._physicsEngine.addJoint(this,otherImpostor,joint)};PhysicsImpostor.prototype.sleep=function(){this._physicsEngine.getPhysicsPlugin().sleepBody(this)};PhysicsImpostor.prototype.wakeUp=function(){this._physicsEngine.getPhysicsPlugin().wakeUpBody(this)};PhysicsImpostor.prototype.clone=function(newObject){if(!newObject)return null;return new PhysicsImpostor(newObject,this.type,this._options,this._scene)};PhysicsImpostor.prototype.dispose=function(){var _this=this;if(!this._physicsEngine){return}this._joints.forEach(function(j){_this._physicsEngine.removeJoint(_this,j.otherImpostor,j.joint)});this._physicsEngine.removeImpostor(this);if(this.parent){this.parent.forceUpdate()}else{}this._isDisposed=true};PhysicsImpostor.prototype.setDeltaPosition=function(position){this._deltaPosition.copyFrom(position)};PhysicsImpostor.prototype.setDeltaRotation=function(rotation){if(!this._deltaRotation){this._deltaRotation=new BABYLON.Quaternion}this._deltaRotation.copyFrom(rotation);this._deltaRotationConjugated=this._deltaRotation.conjugate()};PhysicsImpostor.prototype.getBoxSizeToRef=function(result){this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,result)};PhysicsImpostor.prototype.getRadius=function(){return this._physicsEngine.getPhysicsPlugin().getRadius(this)};PhysicsImpostor.prototype.syncBoneWithImpostor=function(bone,boneMesh,jointPivot,distToJoint,adjustRotation){var tempVec=PhysicsImpostor._tmpVecs[0];var mesh=this.object;if(adjustRotation){var tempQuat=PhysicsImpostor._tmpQuat;mesh.rotationQuaternion.multiplyToRef(adjustRotation,tempQuat);bone.setRotationQuaternion(tempQuat,BABYLON.Space.WORLD,boneMesh)}else{bone.setRotationQuaternion(mesh.rotationQuaternion,BABYLON.Space.WORLD,boneMesh)}tempVec.x=0;tempVec.y=0;tempVec.z=0;if(jointPivot){tempVec.x=jointPivot.x;tempVec.y=jointPivot.y;tempVec.z=jointPivot.z;bone.getDirectionToRef(tempVec,boneMesh,tempVec);if(distToJoint===undefined||distToJoint===null){distToJoint=jointPivot.length()}tempVec.x*=distToJoint;tempVec.y*=distToJoint;tempVec.z*=distToJoint}if(bone.getParent()){tempVec.addInPlace(mesh.getAbsolutePosition());bone.setAbsolutePosition(tempVec,boneMesh)}else{boneMesh.setAbsolutePosition(mesh.getAbsolutePosition());boneMesh.position.x-=tempVec.x;boneMesh.position.y-=tempVec.y;boneMesh.position.z-=tempVec.z}};PhysicsImpostor.prototype.syncImpostorWithBone=function(bone,boneMesh,jointPivot,distToJoint,adjustRotation,boneAxis){var mesh=this.object;if(adjustRotation){var tempQuat=PhysicsImpostor._tmpQuat;bone.getRotationQuaternionToRef(BABYLON.Space.WORLD,boneMesh,tempQuat);tempQuat.multiplyToRef(adjustRotation,mesh.rotationQuaternion)}else{bone.getRotationQuaternionToRef(BABYLON.Space.WORLD,boneMesh,mesh.rotationQuaternion)}var pos=PhysicsImpostor._tmpVecs[0];var boneDir=PhysicsImpostor._tmpVecs[1];if(!boneAxis){boneAxis=PhysicsImpostor._tmpVecs[2];boneAxis.x=0;boneAxis.y=1;boneAxis.z=0}bone.getDirectionToRef(boneAxis,boneMesh,boneDir);bone.getAbsolutePositionToRef(boneMesh,pos);if((distToJoint===undefined||distToJoint===null)&&jointPivot){distToJoint=jointPivot.length()}if(distToJoint!==undefined&&distToJoint!==null){pos.x+=boneDir.x*distToJoint;pos.y+=boneDir.y*distToJoint;pos.z+=boneDir.z*distToJoint}mesh.setAbsolutePosition(pos)};PhysicsImpostor.DEFAULT_OBJECT_SIZE=new BABYLON.Vector3(1,1,1);PhysicsImpostor.IDENTITY_QUATERNION=BABYLON.Quaternion.Identity();PhysicsImpostor._tmpVecs=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];PhysicsImpostor._tmpQuat=BABYLON.Quaternion.Identity();PhysicsImpostor.NoImpostor=0;PhysicsImpostor.SphereImpostor=1;PhysicsImpostor.BoxImpostor=2;PhysicsImpostor.PlaneImpostor=3;PhysicsImpostor.MeshImpostor=4;PhysicsImpostor.CylinderImpostor=7;PhysicsImpostor.ParticleImpostor=8;PhysicsImpostor.HeightmapImpostor=9;return PhysicsImpostor}();BABYLON.PhysicsImpostor=PhysicsImpostor})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PhysicsEngine=function(){function PhysicsEngine(gravity,_physicsPlugin){if(_physicsPlugin===void 0){_physicsPlugin=new BABYLON.CannonJSPlugin}this._physicsPlugin=_physicsPlugin;this._impostors=[];this._joints=[];if(!this._physicsPlugin.isSupported()){throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. "+"Please make sure it is included.")}gravity=gravity||new BABYLON.Vector3(0,-9.807,0);this.setGravity(gravity);this.setTimeStep()}PhysicsEngine.prototype.setGravity=function(gravity){this.gravity=gravity;this._physicsPlugin.setGravity(this.gravity)};PhysicsEngine.prototype.setTimeStep=function(newTimeStep){if(newTimeStep===void 0){newTimeStep=1/60}this._physicsPlugin.setTimeStep(newTimeStep)};PhysicsEngine.prototype.getTimeStep=function(){return this._physicsPlugin.getTimeStep()};PhysicsEngine.prototype.dispose=function(){this._impostors.forEach(function(impostor){impostor.dispose()});this._physicsPlugin.dispose()};PhysicsEngine.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name};PhysicsEngine.prototype.addImpostor=function(impostor){impostor.uniqueId=this._impostors.push(impostor);if(!impostor.parent){this._physicsPlugin.generatePhysicsBody(impostor)}};PhysicsEngine.prototype.removeImpostor=function(impostor){var index=this._impostors.indexOf(impostor);if(index>-1){var removed=this._impostors.splice(index,1);if(removed.length){removed[0].physicsBody=null}}};PhysicsEngine.prototype.addJoint=function(mainImpostor,connectedImpostor,joint){var impostorJoint={mainImpostor:mainImpostor,connectedImpostor:connectedImpostor,joint:joint};joint.physicsPlugin=this._physicsPlugin;this._joints.push(impostorJoint);this._physicsPlugin.generateJoint(impostorJoint)};PhysicsEngine.prototype.removeJoint=function(mainImpostor,connectedImpostor,joint){var matchingJoints=this._joints.filter(function(impostorJoint){return impostorJoint.connectedImpostor===connectedImpostor&&impostorJoint.joint===joint&&impostorJoint.mainImpostor===mainImpostor});if(matchingJoints.length){this._physicsPlugin.removeJoint(matchingJoints[0])}};PhysicsEngine.prototype._step=function(delta){var _this=this;this._impostors.forEach(function(impostor){if(impostor.isBodyInitRequired()){_this._physicsPlugin.generatePhysicsBody(impostor)}});if(delta>.1){delta=.1}else if(delta<=0){delta=1/60}this._physicsPlugin.executeStep(delta,this._impostors)};PhysicsEngine.prototype.getPhysicsPlugin=function(){return this._physicsPlugin};PhysicsEngine.prototype.getImpostorForPhysicsObject=function(object){for(var i=0;i<this._impostors.length;++i){if(this._impostors[i].object===object){return this._impostors[i]}}return null};PhysicsEngine.prototype.getImpostorWithPhysicsBody=function(body){for(var i=0;i<this._impostors.length;++i){if(this._impostors[i].physicsBody===body){return this._impostors[i]}}return null};PhysicsEngine.Epsilon=.001;return PhysicsEngine}();BABYLON.PhysicsEngine=PhysicsEngine})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var CannonJSPlugin=function(){function CannonJSPlugin(_useDeltaForWorldStep,iterations){if(_useDeltaForWorldStep===void 0){_useDeltaForWorldStep=true}if(iterations===void 0){iterations=10}this._useDeltaForWorldStep=_useDeltaForWorldStep;this.name="CannonJSPlugin";this._physicsMaterials=new Array;this._fixedTimeStep=1/60;this.BJSCANNON=typeof CANNON!=="undefined"?CANNON:typeof require!=="undefined"?require("cannon"):undefined;this._minus90X=new BABYLON.Quaternion(-.7071067811865475,0,0,.7071067811865475);this._plus90X=new BABYLON.Quaternion(.7071067811865475,0,0,.7071067811865475);this._tmpPosition=BABYLON.Vector3.Zero();this._tmpDeltaPosition=BABYLON.Vector3.Zero();this._tmpUnityRotation=new BABYLON.Quaternion;if(!this.isSupported()){BABYLON.Tools.Error("CannonJS is not available. Please make sure you included the js file.");return}this.world=new this.BJSCANNON.World;this.world.broadphase=new this.BJSCANNON.NaiveBroadphase;this.world.solver.iterations=iterations}CannonJSPlugin.prototype.setGravity=function(gravity){this.world.gravity.copy(gravity)};CannonJSPlugin.prototype.setTimeStep=function(timeStep){this._fixedTimeStep=timeStep};CannonJSPlugin.prototype.getTimeStep=function(){return this._fixedTimeStep};CannonJSPlugin.prototype.executeStep=function(delta,impostors){this.world.step(this._fixedTimeStep,this._useDeltaForWorldStep?delta*1e3:0,3)};CannonJSPlugin.prototype.applyImpulse=function(impostor,force,contactPoint){var worldPoint=new this.BJSCANNON.Vec3(contactPoint.x,contactPoint.y,contactPoint.z);var impulse=new this.BJSCANNON.Vec3(force.x,force.y,force.z);impostor.physicsBody.applyImpulse(impulse,worldPoint)};CannonJSPlugin.prototype.applyForce=function(impostor,force,contactPoint){var worldPoint=new this.BJSCANNON.Vec3(contactPoint.x,contactPoint.y,contactPoint.z);var impulse=new this.BJSCANNON.Vec3(force.x,force.y,force.z);impostor.physicsBody.applyForce(impulse,worldPoint)};CannonJSPlugin.prototype.generatePhysicsBody=function(impostor){if(impostor.parent){if(impostor.physicsBody){this.removePhysicsBody(impostor);impostor.forceUpdate()}return}if(impostor.isBodyInitRequired()){var shape=this._createShape(impostor);var oldBody=impostor.physicsBody;if(oldBody){this.removePhysicsBody(impostor)}var material=this._addMaterial("mat-"+impostor.uniqueId,impostor.getParam("friction"),impostor.getParam("restitution"));var bodyCreationObject={mass:impostor.getParam("mass"),material:material};var nativeOptions=impostor.getParam("nativeOptions");for(var key in nativeOptions){if(nativeOptions.hasOwnProperty(key)){bodyCreationObject[key]=nativeOptions[key]}}impostor.physicsBody=new this.BJSCANNON.Body(bodyCreationObject);impostor.physicsBody.addEventListener("collide",impostor.onCollide);this.world.addEventListener("preStep",impostor.beforeStep);this.world.addEventListener("postStep",impostor.afterStep);impostor.physicsBody.addShape(shape);this.world.add(impostor.physicsBody);if(oldBody){["force","torque","velocity","angularVelocity"].forEach(function(param){impostor.physicsBody[param].copy(oldBody[param])})}this._processChildMeshes(impostor)}this._updatePhysicsBodyTransformation(impostor)};CannonJSPlugin.prototype._processChildMeshes=function(mainImpostor){var _this=this;var meshChildren=mainImpostor.object.getChildMeshes?mainImpostor.object.getChildMeshes(true):[];var currentRotation=mainImpostor.object.rotationQuaternion;if(meshChildren.length){var processMesh=function(localPosition,mesh){var childImpostor=mesh.getPhysicsImpostor();if(childImpostor){var parent=childImpostor.parent;if(parent!==mainImpostor){var pPosition=mesh.getAbsolutePosition().subtract(mainImpostor.object.getAbsolutePosition());var localRotation=mesh.rotationQuaternion.multiply(BABYLON.Quaternion.Inverse(currentRotation));if(childImpostor.physicsBody){_this.removePhysicsBody(childImpostor);childImpostor.physicsBody=null}childImpostor.parent=mainImpostor;childImpostor.resetUpdateFlags();mainImpostor.physicsBody.addShape(_this._createShape(childImpostor),new _this.BJSCANNON.Vec3(pPosition.x,pPosition.y,pPosition.z),new _this.BJSCANNON.Quaternion(localRotation.x,localRotation.y,localRotation.z,localRotation.w));mainImpostor.physicsBody.mass+=childImpostor.getParam("mass")}}currentRotation.multiplyInPlace(mesh.rotationQuaternion);mesh.getChildMeshes(true).filter(function(m){return!!m.physicsImpostor}).forEach(processMesh.bind(_this,mesh.getAbsolutePosition()))};meshChildren.filter(function(m){return!!m.physicsImpostor}).forEach(processMesh.bind(this,mainImpostor.object.getAbsolutePosition()))}};CannonJSPlugin.prototype.removePhysicsBody=function(impostor){impostor.physicsBody.removeEventListener("collide",impostor.onCollide);this.world.removeEventListener("preStep",impostor.beforeStep);this.world.removeEventListener("postStep",impostor.afterStep);this.world.remove(impostor.physicsBody)};CannonJSPlugin.prototype.generateJoint=function(impostorJoint){var mainBody=impostorJoint.mainImpostor.physicsBody;var connectedBody=impostorJoint.connectedImpostor.physicsBody;if(!mainBody||!connectedBody){return}var constraint;var jointData=impostorJoint.joint.jointData;var constraintData={pivotA:jointData.mainPivot?(new this.BJSCANNON.Vec3).copy(jointData.mainPivot):null,pivotB:jointData.connectedPivot?(new this.BJSCANNON.Vec3).copy(jointData.connectedPivot):null,axisA:jointData.mainAxis?(new this.BJSCANNON.Vec3).copy(jointData.mainAxis):null,axisB:jointData.connectedAxis?(new this.BJSCANNON.Vec3).copy(jointData.connectedAxis):null,maxForce:jointData.nativeParams.maxForce,collideConnected:!!jointData.collision};switch(impostorJoint.joint.type){case BABYLON.PhysicsJoint.HingeJoint:case BABYLON.PhysicsJoint.Hinge2Joint:constraint=new this.BJSCANNON.HingeConstraint(mainBody,connectedBody,constraintData);break;case BABYLON.PhysicsJoint.DistanceJoint:constraint=new this.BJSCANNON.DistanceConstraint(mainBody,connectedBody,jointData.maxDistance||2);break;case BABYLON.PhysicsJoint.SpringJoint:var springData=jointData;constraint=new this.BJSCANNON.Spring(mainBody,connectedBody,{restLength:springData.length,stiffness:springData.stiffness,damping:springData.damping,localAnchorA:constraintData.pivotA,localAnchorB:constraintData.pivotB});break;case BABYLON.PhysicsJoint.LockJoint:constraint=new this.BJSCANNON.LockConstraint(mainBody,connectedBody,constraintData);break;case BABYLON.PhysicsJoint.PointToPointJoint:case BABYLON.PhysicsJoint.BallAndSocketJoint:default:constraint=new this.BJSCANNON.PointToPointConstraint(mainBody,constraintData.pivotA,connectedBody,constraintData.pivotA,constraintData.maxForce);break}constraint.collideConnected=!!jointData.collision;impostorJoint.joint.physicsJoint=constraint;if(impostorJoint.joint.type!==BABYLON.PhysicsJoint.SpringJoint){this.world.addConstraint(constraint)}else{impostorJoint.mainImpostor.registerAfterPhysicsStep(function(){constraint.applyForce()})}};CannonJSPlugin.prototype.removeJoint=function(impostorJoint){this.world.removeConstraint(impostorJoint.joint.physicsJoint)};CannonJSPlugin.prototype._addMaterial=function(name,friction,restitution){var index;var mat;for(index=0;index<this._physicsMaterials.length;index++){mat=this._physicsMaterials[index];if(mat.friction===friction&&mat.restitution===restitution){return mat}}var currentMat=new this.BJSCANNON.Material(name);currentMat.friction=friction;currentMat.restitution=restitution;this._physicsMaterials.push(currentMat);return currentMat};CannonJSPlugin.prototype._checkWithEpsilon=function(value){return value<BABYLON.PhysicsEngine.Epsilon?BABYLON.PhysicsEngine.Epsilon:value};CannonJSPlugin.prototype._createShape=function(impostor){var object=impostor.object;var returnValue;var extendSize=impostor.getObjectExtendSize();switch(impostor.type){case BABYLON.PhysicsImpostor.SphereImpostor:var radiusX=extendSize.x;var radiusY=extendSize.y;var radiusZ=extendSize.z;returnValue=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(radiusX),this._checkWithEpsilon(radiusY),this._checkWithEpsilon(radiusZ))/2);break;case BABYLON.PhysicsImpostor.CylinderImpostor:returnValue=new this.BJSCANNON.Cylinder(this._checkWithEpsilon(extendSize.x)/2,this._checkWithEpsilon(extendSize.x)/2,this._checkWithEpsilon(extendSize.y),16);break;case BABYLON.PhysicsImpostor.BoxImpostor:var box=extendSize.scale(.5);returnValue=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(box.x),this._checkWithEpsilon(box.y),this._checkWithEpsilon(box.z)));break;case BABYLON.PhysicsImpostor.PlaneImpostor:BABYLON.Tools.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead");returnValue=new this.BJSCANNON.Plane;break;case BABYLON.PhysicsImpostor.MeshImpostor:var rawVerts=object.getVerticesData?object.getVerticesData(BABYLON.VertexBuffer.PositionKind):[];var rawFaces=object.getIndices?object.getIndices():[];BABYLON.Tools.Warn("MeshImpostor only collides against spheres.");returnValue=new this.BJSCANNON.Trimesh(rawVerts,rawFaces);break;case BABYLON.PhysicsImpostor.HeightmapImpostor:returnValue=this._createHeightmap(object);break;case BABYLON.PhysicsImpostor.ParticleImpostor:returnValue=new this.BJSCANNON.Particle;break}return returnValue};CannonJSPlugin.prototype._createHeightmap=function(object,pointDepth){var pos=object.getVerticesData(BABYLON.VertexBuffer.PositionKind);var matrix=new Array;var arraySize=pointDepth||~~(Math.sqrt(pos.length/3)-1);var dim=Math.min(object.getBoundingInfo().boundingBox.extendSizeWorld.x,object.getBoundingInfo().boundingBox.extendSizeWorld.z);var elementSize=dim*2/arraySize;var minY=object.getBoundingInfo().boundingBox.extendSizeWorld.y;for(var i=0;i<pos.length;i=i+3){var x=Math.round(pos[i+0]/elementSize+arraySize/2);var z=Math.round((pos[i+2]/elementSize-arraySize/2)*-1);var y=pos[i+1]+minY;if(!matrix[x]){matrix[x]=[]}if(!matrix[x][z]){matrix[x][z]=y}matrix[x][z]=Math.max(y,matrix[x][z])}for(var x=0;x<=arraySize;++x){if(!matrix[x]){var loc=1;while(!matrix[(x+loc)%arraySize]){loc++}matrix[x]=matrix[(x+loc)%arraySize].slice()}for(var z=0;z<=arraySize;++z){if(!matrix[x][z]){var loc=1;var newValue;while(newValue===undefined){newValue=matrix[x][(z+loc++)%arraySize]}matrix[x][z]=newValue}}}var shape=new this.BJSCANNON.Heightfield(matrix,{elementSize:elementSize});shape.minY=minY;return shape};CannonJSPlugin.prototype._updatePhysicsBodyTransformation=function(impostor){var object=impostor.object;object.computeWorldMatrix&&object.computeWorldMatrix(true);var center=impostor.getObjectCenter();this._tmpDeltaPosition.copyFrom(object.position.subtract(center));this._tmpPosition.copyFrom(center);var quaternion=object.rotationQuaternion;if(impostor.type===BABYLON.PhysicsImpostor.PlaneImpostor||impostor.type===BABYLON.PhysicsImpostor.HeightmapImpostor||impostor.type===BABYLON.PhysicsImpostor.CylinderImpostor){quaternion=quaternion.multiply(this._minus90X);impostor.setDeltaRotation(this._plus90X)}if(impostor.type===BABYLON.PhysicsImpostor.HeightmapImpostor){var mesh=object;var rotationQuaternion=mesh.rotationQuaternion;mesh.rotationQuaternion=this._tmpUnityRotation;mesh.computeWorldMatrix(true);var c=center.clone();var oldPivot=mesh.getPivotMatrix()||BABYLON.Matrix.Translation(0,0,0);mesh.rotationQuaternion=rotationQuaternion;var p=BABYLON.Matrix.Translation(mesh.getBoundingInfo().boundingBox.extendSizeWorld.x,0,-mesh.getBoundingInfo().boundingBox.extendSizeWorld.z);mesh.setPivotMatrix(p);mesh.computeWorldMatrix(true);var translation=mesh.getBoundingInfo().boundingBox.centerWorld.subtract(center).subtract(mesh.position).negate();this._tmpPosition.copyFromFloats(translation.x,translation.y-mesh.getBoundingInfo().boundingBox.extendSizeWorld.y,translation.z);this._tmpDeltaPosition.copyFrom(mesh.getBoundingInfo().boundingBox.centerWorld.subtract(c));this._tmpDeltaPosition.y+=mesh.getBoundingInfo().boundingBox.extendSizeWorld.y;mesh.setPivotMatrix(oldPivot);mesh.computeWorldMatrix(true)}else if(impostor.type===BABYLON.PhysicsImpostor.MeshImpostor){this._tmpDeltaPosition.copyFromFloats(0,0,0);this._tmpPosition.copyFrom(object.position)}impostor.setDeltaPosition(this._tmpDeltaPosition);impostor.physicsBody.position.copy(this._tmpPosition);impostor.physicsBody.quaternion.copy(quaternion)};CannonJSPlugin.prototype.setTransformationFromPhysicsBody=function(impostor){impostor.object.position.copyFrom(impostor.physicsBody.position);impostor.object.rotationQuaternion.copyFrom(impostor.physicsBody.quaternion)};CannonJSPlugin.prototype.setPhysicsBodyTransformation=function(impostor,newPosition,newRotation){impostor.physicsBody.position.copy(newPosition);impostor.physicsBody.quaternion.copy(newRotation)};CannonJSPlugin.prototype.isSupported=function(){return this.BJSCANNON!==undefined};CannonJSPlugin.prototype.setLinearVelocity=function(impostor,velocity){impostor.physicsBody.velocity.copy(velocity)};CannonJSPlugin.prototype.setAngularVelocity=function(impostor,velocity){impostor.physicsBody.angularVelocity.copy(velocity)};CannonJSPlugin.prototype.getLinearVelocity=function(impostor){var v=impostor.physicsBody.velocity;if(!v)return null;return new BABYLON.Vector3(v.x,v.y,v.z)};CannonJSPlugin.prototype.getAngularVelocity=function(impostor){var v=impostor.physicsBody.angularVelocity;if(!v)return null;return new BABYLON.Vector3(v.x,v.y,v.z)};CannonJSPlugin.prototype.setBodyMass=function(impostor,mass){impostor.physicsBody.mass=mass;impostor.physicsBody.updateMassProperties()};CannonJSPlugin.prototype.getBodyMass=function(impostor){return impostor.physicsBody.mass};CannonJSPlugin.prototype.getBodyFriction=function(impostor){return impostor.physicsBody.material.friction};CannonJSPlugin.prototype.setBodyFriction=function(impostor,friction){impostor.physicsBody.material.friction=friction};CannonJSPlugin.prototype.getBodyRestitution=function(impostor){return impostor.physicsBody.material.restitution};CannonJSPlugin.prototype.setBodyRestitution=function(impostor,restitution){impostor.physicsBody.material.restitution=restitution};CannonJSPlugin.prototype.sleepBody=function(impostor){impostor.physicsBody.sleep()};CannonJSPlugin.prototype.wakeUpBody=function(impostor){impostor.physicsBody.wakeUp()};CannonJSPlugin.prototype.updateDistanceJoint=function(joint,maxDistance,minDistance){joint.physicsJoint.distance=maxDistance};CannonJSPlugin.prototype.setMotor=function(joint,speed,maxForce,motorIndex){if(!motorIndex){joint.physicsJoint.enableMotor();joint.physicsJoint.setMotorSpeed(speed);if(maxForce){this.setLimit(joint,maxForce)}}};CannonJSPlugin.prototype.setLimit=function(joint,upperLimit,lowerLimit){joint.physicsJoint.motorEquation.maxForce=upperLimit;joint.physicsJoint.motorEquation.minForce=lowerLimit===void 0?-upperLimit:lowerLimit};CannonJSPlugin.prototype.syncMeshWithImpostor=function(mesh,impostor){var body=impostor.physicsBody;mesh.position.x=body.position.x;mesh.position.y=body.position.y;mesh.position.z=body.position.z;mesh.rotationQuaternion.x=body.quaternion.x;mesh.rotationQuaternion.y=body.quaternion.y;mesh.rotationQuaternion.z=body.quaternion.z;mesh.rotationQuaternion.w=body.quaternion.w};CannonJSPlugin.prototype.getRadius=function(impostor){var shape=impostor.physicsBody.shapes[0];return shape.boundingSphereRadius};CannonJSPlugin.prototype.getBoxSizeToRef=function(impostor,result){var shape=impostor.physicsBody.shapes[0];result.x=shape.halfExtents.x*2;result.y=shape.halfExtents.y*2;result.z=shape.halfExtents.z*2};CannonJSPlugin.prototype.dispose=function(){};return CannonJSPlugin}();BABYLON.CannonJSPlugin=CannonJSPlugin})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var OimoJSPlugin=function(){function OimoJSPlugin(iterations){this.name="OimoJSPlugin";this._tmpImpostorsArray=[];this._tmpPositionVector=BABYLON.Vector3.Zero();this.BJSOIMO=typeof OIMO!=="undefined"?OIMO:typeof require!=="undefined"?require("./Oimo"):undefined;this.world=new this.BJSOIMO.World(1/60,2,iterations,true);this.world.worldscale(1);this.world.clear();this.world.isNoStat=true}OimoJSPlugin.prototype.setGravity=function(gravity){this.world.gravity.copy(gravity)};OimoJSPlugin.prototype.setTimeStep=function(timeStep){this.world.timeStep=timeStep};OimoJSPlugin.prototype.getTimeStep=function(){return this.world.timeStep};OimoJSPlugin.prototype.executeStep=function(delta,impostors){var _this=this;impostors.forEach(function(impostor){impostor.beforeStep()});this.world.step();impostors.forEach(function(impostor){impostor.afterStep();_this._tmpImpostorsArray[impostor.uniqueId]=impostor});var contact=this.world.contacts;while(contact!==null){if(contact.touching&&!contact.body1.sleeping&&!contact.body2.sleeping){contact=contact.next;continue}var mainImpostor=this._tmpImpostorsArray[+contact.body1.name];var collidingImpostor=this._tmpImpostorsArray[+contact.body2.name];if(!mainImpostor||!collidingImpostor){contact=contact.next;continue}mainImpostor.onCollide({body:collidingImpostor.physicsBody});collidingImpostor.onCollide({body:mainImpostor.physicsBody});contact=contact.next}};OimoJSPlugin.prototype.applyImpulse=function(impostor,force,contactPoint){var mass=impostor.physicsBody.massInfo.mass;impostor.physicsBody.applyImpulse(contactPoint.scale(this.BJSOIMO.INV_SCALE),force.scale(this.BJSOIMO.INV_SCALE*mass))};OimoJSPlugin.prototype.applyForce=function(impostor,force,contactPoint){BABYLON.Tools.Warn("Oimo doesn't support applying force. Using impule instead.");this.applyImpulse(impostor,force,contactPoint)};OimoJSPlugin.prototype.generatePhysicsBody=function(impostor){var _this=this;if(impostor.parent){if(impostor.physicsBody){this.removePhysicsBody(impostor);impostor.forceUpdate()}return}if(impostor.isBodyInitRequired()){var bodyConfig={name:impostor.uniqueId,config:[impostor.getParam("mass")||1,impostor.getParam("friction"),impostor.getParam("restitution")],size:[],type:[],pos:[],rot:[],move:impostor.getParam("mass")!==0,world:this.world};var impostors=[impostor];var addToArray=function(parent){if(!parent.getChildMeshes)return;parent.getChildMeshes().forEach(function(m){if(m.physicsImpostor){impostors.push(m.physicsImpostor)}})};addToArray(impostor.object);var checkWithEpsilon_1=function(value){return Math.max(value,BABYLON.PhysicsEngine.Epsilon)};impostors.forEach(function(i){var oldQuaternion=i.object.rotationQuaternion;var rot=(new _this.BJSOIMO.Euler).setFromQuaternion({x:impostor.object.rotationQuaternion.x,y:impostor.object.rotationQuaternion.y,z:impostor.object.rotationQuaternion.z,s:impostor.object.rotationQuaternion.w});var extendSize=i.getObjectExtendSize();if(i===impostor){var center=impostor.getObjectCenter();impostor.object.position.subtractToRef(center,_this._tmpPositionVector);bodyConfig.pos.push(center.x);bodyConfig.pos.push(center.y);bodyConfig.pos.push(center.z);bodyConfig.rot.push(rot.x/(_this.BJSOIMO.degtorad||_this.BJSOIMO.TO_RAD));bodyConfig.rot.push(rot.y/(_this.BJSOIMO.degtorad||_this.BJSOIMO.TO_RAD));bodyConfig.rot.push(rot.z/(_this.BJSOIMO.degtorad||_this.BJSOIMO.TO_RAD))}else{var localPosition=i.object.getAbsolutePosition().subtract(impostor.object.getAbsolutePosition());bodyConfig.pos.push(localPosition.x);bodyConfig.pos.push(localPosition.y);bodyConfig.pos.push(localPosition.z);bodyConfig.rot.push(0);bodyConfig.rot.push(0);bodyConfig.rot.push(0)}switch(i.type){case BABYLON.PhysicsImpostor.ParticleImpostor:BABYLON.Tools.Warn("No Particle support in this.BJSOIMO.js. using SphereImpostor instead");case BABYLON.PhysicsImpostor.SphereImpostor:var radiusX=extendSize.x;var radiusY=extendSize.y;var radiusZ=extendSize.z;var size=Math.max(checkWithEpsilon_1(radiusX),checkWithEpsilon_1(radiusY),checkWithEpsilon_1(radiusZ))/2;bodyConfig.type.push("sphere");bodyConfig.size.push(size);bodyConfig.size.push(size);bodyConfig.size.push(size);break;case BABYLON.PhysicsImpostor.CylinderImpostor:var sizeX=checkWithEpsilon_1(extendSize.x)/2;var sizeY=checkWithEpsilon_1(extendSize.y);bodyConfig.type.push("cylinder");bodyConfig.size.push(sizeX);bodyConfig.size.push(sizeY);bodyConfig.size.push(sizeY);break;case BABYLON.PhysicsImpostor.PlaneImpostor:case BABYLON.PhysicsImpostor.BoxImpostor:default:var sizeX=checkWithEpsilon_1(extendSize.x);var sizeY=checkWithEpsilon_1(extendSize.y);var sizeZ=checkWithEpsilon_1(extendSize.z);bodyConfig.type.push("box");bodyConfig.size.push(sizeX);bodyConfig.size.push(sizeY);bodyConfig.size.push(sizeZ);break}i.object.rotationQuaternion=oldQuaternion});impostor.physicsBody=new this.BJSOIMO.Body(bodyConfig).body}else{this._tmpPositionVector.copyFromFloats(0,0,0)}impostor.setDeltaPosition(this._tmpPositionVector)};OimoJSPlugin.prototype.removePhysicsBody=function(impostor){this.world.removeRigidBody(impostor.physicsBody)};OimoJSPlugin.prototype.generateJoint=function(impostorJoint){var mainBody=impostorJoint.mainImpostor.physicsBody;var connectedBody=impostorJoint.connectedImpostor.physicsBody;if(!mainBody||!connectedBody){return}var jointData=impostorJoint.joint.jointData;var options=jointData.nativeParams||{};var type;var nativeJointData={body1:mainBody,body2:connectedBody,axe1:options.axe1||(jointData.mainAxis?jointData.mainAxis.asArray():null),axe2:options.axe2||(jointData.connectedAxis?jointData.connectedAxis.asArray():null),pos1:options.pos1||(jointData.mainPivot?jointData.mainPivot.asArray():null),pos2:options.pos2||(jointData.connectedPivot?jointData.connectedPivot.asArray():null),min:options.min,max:options.max,collision:options.collision||jointData.collision,spring:options.spring,world:this.world};switch(impostorJoint.joint.type){case BABYLON.PhysicsJoint.BallAndSocketJoint:type="jointBall";break;case BABYLON.PhysicsJoint.SpringJoint:BABYLON.Tools.Warn("this.BJSOIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");var springData=jointData;nativeJointData.min=springData.length||nativeJointData.min;nativeJointData.max=Math.max(nativeJointData.min,nativeJointData.max);case BABYLON.PhysicsJoint.DistanceJoint:type="jointDistance";nativeJointData.max=jointData.maxDistance;break;case BABYLON.PhysicsJoint.PrismaticJoint:type="jointPrisme";break;case BABYLON.PhysicsJoint.SliderJoint:type="jointSlide";break;case BABYLON.PhysicsJoint.WheelJoint:type="jointWheel";break;case BABYLON.PhysicsJoint.HingeJoint:default:type="jointHinge";break}nativeJointData.type=type;impostorJoint.joint.physicsJoint=new this.BJSOIMO.Link(nativeJointData).joint};OimoJSPlugin.prototype.removeJoint=function(impostorJoint){try{this.world.removeJoint(impostorJoint.joint.physicsJoint)}catch(e){BABYLON.Tools.Warn(e)}};OimoJSPlugin.prototype.isSupported=function(){return this.BJSOIMO!==undefined};OimoJSPlugin.prototype.setTransformationFromPhysicsBody=function(impostor){if(!impostor.physicsBody.sleeping){if(impostor.physicsBody.shapes.next){var parentShape=this._getLastShape(impostor.physicsBody);impostor.object.position.x=parentShape.position.x*this.BJSOIMO.WORLD_SCALE;impostor.object.position.y=parentShape.position.y*this.BJSOIMO.WORLD_SCALE;impostor.object.position.z=parentShape.position.z*this.BJSOIMO.WORLD_SCALE}else{impostor.object.position.copyFrom(impostor.physicsBody.getPosition())}impostor.object.rotationQuaternion.copyFrom(impostor.physicsBody.getQuaternion());impostor.object.rotationQuaternion.normalize()}};OimoJSPlugin.prototype.setPhysicsBodyTransformation=function(impostor,newPosition,newRotation){var body=impostor.physicsBody;body.position.init(newPosition.x*this.BJSOIMO.INV_SCALE,newPosition.y*this.BJSOIMO.INV_SCALE,newPosition.z*this.BJSOIMO.INV_SCALE);body.orientation.init(newRotation.w,newRotation.x,newRotation.y,newRotation.z);body.syncShapes();body.awake()};OimoJSPlugin.prototype._getLastShape=function(body){var lastShape=body.shapes;while(lastShape.next){lastShape=lastShape.next}return lastShape};OimoJSPlugin.prototype.setLinearVelocity=function(impostor,velocity){impostor.physicsBody.linearVelocity.init(velocity.x,velocity.y,velocity.z)};OimoJSPlugin.prototype.setAngularVelocity=function(impostor,velocity){impostor.physicsBody.angularVelocity.init(velocity.x,velocity.y,velocity.z)};OimoJSPlugin.prototype.getLinearVelocity=function(impostor){var v=impostor.physicsBody.linearVelocity;if(!v)return null;return new BABYLON.Vector3(v.x,v.y,v.z)};OimoJSPlugin.prototype.getAngularVelocity=function(impostor){var v=impostor.physicsBody.angularVelocity;if(!v)return null;return new BABYLON.Vector3(v.x,v.y,v.z)};OimoJSPlugin.prototype.setBodyMass=function(impostor,mass){var staticBody=mass===0;impostor.physicsBody.shapes.density=staticBody?1:mass;impostor.physicsBody.setupMass(staticBody?2:1)};OimoJSPlugin.prototype.getBodyMass=function(impostor){return impostor.physicsBody.shapes.density};OimoJSPlugin.prototype.getBodyFriction=function(impostor){return impostor.physicsBody.shapes.friction};OimoJSPlugin.prototype.setBodyFriction=function(impostor,friction){impostor.physicsBody.shapes.friction=friction};OimoJSPlugin.prototype.getBodyRestitution=function(impostor){return impostor.physicsBody.shapes.restitution};OimoJSPlugin.prototype.setBodyRestitution=function(impostor,restitution){impostor.physicsBody.shapes.restitution=restitution};OimoJSPlugin.prototype.sleepBody=function(impostor){impostor.physicsBody.sleep()};OimoJSPlugin.prototype.wakeUpBody=function(impostor){impostor.physicsBody.awake()};OimoJSPlugin.prototype.updateDistanceJoint=function(joint,maxDistance,minDistance){joint.physicsJoint.limitMotor.upperLimit=maxDistance;if(minDistance!==void 0){joint.physicsJoint.limitMotor.lowerLimit=minDistance}};OimoJSPlugin.prototype.setMotor=function(joint,speed,maxForce,motorIndex){var motor=motorIndex?joint.physicsJoint.rotationalLimitMotor2:joint.physicsJoint.rotationalLimitMotor1||joint.physicsJoint.rotationalLimitMotor||joint.physicsJoint.limitMotor;if(motor){motor.setMotor(speed,maxForce)}};OimoJSPlugin.prototype.setLimit=function(joint,upperLimit,lowerLimit,motorIndex){var motor=motorIndex?joint.physicsJoint.rotationalLimitMotor2:joint.physicsJoint.rotationalLimitMotor1||joint.physicsJoint.rotationalLimitMotor||joint.physicsJoint.limitMotor;if(motor){motor.setLimit(upperLimit,lowerLimit===void 0?-upperLimit:lowerLimit)}};OimoJSPlugin.prototype.syncMeshWithImpostor=function(mesh,impostor){var body=impostor.physicsBody;mesh.position.x=body.position.x;mesh.position.y=body.position.y;mesh.position.z=body.position.z;mesh.rotationQuaternion.x=body.orientation.x;mesh.rotationQuaternion.y=body.orientation.y;mesh.rotationQuaternion.z=body.orientation.z;mesh.rotationQuaternion.w=body.orientation.s};OimoJSPlugin.prototype.getRadius=function(impostor){return impostor.physicsBody.shapes.radius};OimoJSPlugin.prototype.getBoxSizeToRef=function(impostor,result){var shape=impostor.physicsBody.shapes;result.x=shape.halfWidth*2;result.y=shape.halfHeight*2;result.z=shape.halfDepth*2};OimoJSPlugin.prototype.dispose=function(){this.world.clear()};return OimoJSPlugin}();BABYLON.OimoJSPlugin=OimoJSPlugin})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var TGATools=function(){function TGATools(){}TGATools.GetTGAHeader=function(data){var offset=0;var header={id_length:data[offset++],colormap_type:data[offset++],image_type:data[offset++],colormap_index:data[offset++]|data[offset++]<<8,colormap_length:data[offset++]|data[offset++]<<8,colormap_size:data[offset++],origin:[data[offset++]|data[offset++]<<8,data[offset++]|data[offset++]<<8],width:data[offset++]|data[offset++]<<8,height:data[offset++]|data[offset++]<<8,pixel_size:data[offset++],flags:data[offset++]};return header};TGATools.UploadContent=function(gl,data){if(data.length<19){BABYLON.Tools.Error("Unable to load TGA file - Not enough data to contain header");return}var offset=18;var header=TGATools.GetTGAHeader(data);if(header.id_length+offset>data.length){BABYLON.Tools.Error("Unable to load TGA file - Not enough data");return}offset+=header.id_length;var use_rle=false;var use_pal=false;var use_rgb=false;var use_grey=false;switch(header.image_type){case TGATools._TYPE_RLE_INDEXED:use_rle=true;case TGATools._TYPE_INDEXED:use_pal=true;break;case TGATools._TYPE_RLE_RGB:use_rle=true;case TGATools._TYPE_RGB:use_rgb=true;break;case TGATools._TYPE_RLE_GREY:use_rle=true;case TGATools._TYPE_GREY:use_grey=true;break}var pixel_data;var pixel_size=header.pixel_size>>3;var pixel_total=header.width*header.height*pixel_size;var palettes;if(use_pal){palettes=data.subarray(offset,offset+=header.colormap_length*(header.colormap_size>>3))}if(use_rle){pixel_data=new Uint8Array(pixel_total);var c,count,i;var localOffset=0;var pixels=new Uint8Array(pixel_size);while(offset<pixel_total&&localOffset<pixel_total){c=data[offset++];count=(c&127)+1;if(c&128){for(i=0;i<pixel_size;++i){pixels[i]=data[offset++]}for(i=0;i<count;++i){pixel_data.set(pixels,localOffset+i*pixel_size)}localOffset+=pixel_size*count}else{count*=pixel_size;for(i=0;i<count;++i){pixel_data[localOffset+i]=data[offset++]}localOffset+=count}}}else{pixel_data=data.subarray(offset,offset+=use_pal?header.width*header.height:pixel_total)}var x_start,y_start,x_step,y_step,y_end,x_end;switch((header.flags&TGATools._ORIGIN_MASK)>>TGATools._ORIGIN_SHIFT){default:case TGATools._ORIGIN_UL:x_start=0;x_step=1;x_end=header.width;y_start=0;y_step=1;y_end=header.height;break;case TGATools._ORIGIN_BL:x_start=0;x_step=1;x_end=header.width;y_start=header.height-1;y_step=-1;y_end=-1;break;case TGATools._ORIGIN_UR:x_start=header.width-1;x_step=-1;x_end=-1;y_start=0;y_step=1;y_end=header.height;break;case TGATools._ORIGIN_BR:x_start=header.width-1;x_step=-1;x_end=-1;y_start=header.height-1;y_step=-1;y_end=-1;break}var func="_getImageData"+(use_grey?"Grey":"")+header.pixel_size+"bits";var imageData=TGATools[func](header,palettes,pixel_data,y_start,y_step,y_end,x_start,x_step,x_end);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,header.width,header.height,0,gl.RGBA,gl.UNSIGNED_BYTE,imageData)};TGATools._getImageData8bits=function(header,palettes,pixel_data,y_start,y_step,y_end,x_start,x_step,x_end){var image=pixel_data,colormap=palettes;var width=header.width,height=header.height;var color,i=0,x,y;var imageData=new Uint8Array(width*height*4);for(y=y_start;y!==y_end;y+=y_step){for(x=x_start;x!==x_end;x+=x_step,i++){color=image[i];imageData[(x+width*y)*4+3]=255;imageData[(x+width*y)*4+2]=colormap[color*3+0];imageData[(x+width*y)*4+1]=colormap[color*3+1];imageData[(x+width*y)*4+0]=colormap[color*3+2]}}return imageData};TGATools._getImageData16bits=function(header,palettes,pixel_data,y_start,y_step,y_end,x_start,x_step,x_end){var image=pixel_data;var width=header.width,height=header.height;var color,i=0,x,y;var imageData=new Uint8Array(width*height*4);for(y=y_start;y!==y_end;y+=y_step){for(x=x_start;x!==x_end;x+=x_step,i+=2){color=image[i+0]+(image[i+1]<<8);imageData[(x+width*y)*4+0]=(color&31744)>>7;imageData[(x+width*y)*4+1]=(color&992)>>2;imageData[(x+width*y)*4+2]=(color&31)>>3;imageData[(x+width*y)*4+3]=color&32768?0:255}}return imageData};TGATools._getImageData24bits=function(header,palettes,pixel_data,y_start,y_step,y_end,x_start,x_step,x_end){var image=pixel_data;var width=header.width,height=header.height;var i=0,x,y;var imageData=new Uint8Array(width*height*4);for(y=y_start;y!==y_end;y+=y_step){for(x=x_start;x!==x_end;x+=x_step,i+=3){imageData[(x+width*y)*4+3]=255;imageData[(x+width*y)*4+2]=image[i+0];imageData[(x+width*y)*4+1]=image[i+1];imageData[(x+width*y)*4+0]=image[i+2]}}return imageData};TGATools._getImageData32bits=function(header,palettes,pixel_data,y_start,y_step,y_end,x_start,x_step,x_end){var image=pixel_data;var width=header.width,height=header.height;var i=0,x,y;var imageData=new Uint8Array(width*height*4);for(y=y_start;y!==y_end;y+=y_step){for(x=x_start;x!==x_end;x+=x_step,i+=4){imageData[(x+width*y)*4+2]=image[i+0];imageData[(x+width*y)*4+1]=image[i+1];imageData[(x+width*y)*4+0]=image[i+2];imageData[(x+width*y)*4+3]=image[i+3]}}return imageData};TGATools._getImageDataGrey8bits=function(header,palettes,pixel_data,y_start,y_step,y_end,x_start,x_step,x_end){var image=pixel_data;var width=header.width,height=header.height;var color,i=0,x,y;var imageData=new Uint8Array(width*height*4);for(y=y_start;y!==y_end;y+=y_step){for(x=x_start;x!==x_end;x+=x_step,i++){color=image[i];imageData[(x+width*y)*4+0]=color;imageData[(x+width*y)*4+1]=color;imageData[(x+width*y)*4+2]=color;imageData[(x+width*y)*4+3]=255}}return imageData};TGATools._getImageDataGrey16bits=function(header,palettes,pixel_data,y_start,y_step,y_end,x_start,x_step,x_end){var image=pixel_data;var width=header.width,height=header.height;var i=0,x,y;var imageData=new Uint8Array(width*height*4);for(y=y_start;y!==y_end;y+=y_step){for(x=x_start;x!==x_end;x+=x_step,i+=2){imageData[(x+width*y)*4+0]=image[i+0];imageData[(x+width*y)*4+1]=image[i+0];imageData[(x+width*y)*4+2]=image[i+0];imageData[(x+width*y)*4+3]=image[i+1]}}return imageData};TGATools._TYPE_INDEXED=1;TGATools._TYPE_RGB=2;TGATools._TYPE_GREY=3;TGATools._TYPE_RLE_INDEXED=9;TGATools._TYPE_RLE_RGB=10;TGATools._TYPE_RLE_GREY=11;TGATools._ORIGIN_MASK=48;TGATools._ORIGIN_SHIFT=4;TGATools._ORIGIN_BL=0;TGATools._ORIGIN_BR=1;TGATools._ORIGIN_UL=2;TGATools._ORIGIN_UR=3;return TGATools}();Internals.TGATools=TGATools})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var DDS_MAGIC=542327876;var DDSD_MIPMAPCOUNT=131072;var DDSCAPS2_CUBEMAP=512;var DDPF_FOURCC=4,DDPF_RGB=64,DDPF_LUMINANCE=131072;function FourCCToInt32(value){return value.charCodeAt(0)+(value.charCodeAt(1)<<8)+(value.charCodeAt(2)<<16)+(value.charCodeAt(3)<<24)}function Int32ToFourCC(value){return String.fromCharCode(value&255,value>>8&255,value>>16&255,value>>24&255)}var FOURCC_DXT1=FourCCToInt32("DXT1");var FOURCC_DXT3=FourCCToInt32("DXT3");var FOURCC_DXT5=FourCCToInt32("DXT5");var FOURCC_DX10=FourCCToInt32("DX10");var FOURCC_D3DFMT_R16G16B16A16F=113;var FOURCC_D3DFMT_R32G32B32A32F=116;var DXGI_FORMAT_R16G16B16A16_FLOAT=10;var DXGI_FORMAT_B8G8R8X8_UNORM=88;var headerLengthInt=31;var off_magic=0;var off_size=1;var off_flags=2;var off_height=3;var off_width=4;var off_mipmapCount=7;var off_pfFlags=20;var off_pfFourCC=21;var off_RGBbpp=22;var off_caps2=28;var off_dxgiFormat=32;var DDSTools=function(){function DDSTools(){}DDSTools.GetDDSInfo=function(arrayBuffer){var header=new Int32Array(arrayBuffer,0,headerLengthInt);var extendedHeader=new Int32Array(arrayBuffer,0,headerLengthInt+4);var mipmapCount=1;if(header[off_flags]&DDSD_MIPMAPCOUNT){mipmapCount=Math.max(1,header[off_mipmapCount])}var fourCC=header[off_pfFourCC];var dxgiFormat=fourCC===FOURCC_DX10?extendedHeader[off_dxgiFormat]:0;var textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT;switch(fourCC){case FOURCC_D3DFMT_R16G16B16A16F:textureType=BABYLON.Engine.TEXTURETYPE_HALF_FLOAT;break;case FOURCC_D3DFMT_R32G32B32A32F:textureType=BABYLON.Engine.TEXTURETYPE_FLOAT;break;case FOURCC_DX10:if(dxgiFormat===DXGI_FORMAT_R16G16B16A16_FLOAT){textureType=BABYLON.Engine.TEXTURETYPE_HALF_FLOAT;break}}return{width:header[off_width],height:header[off_height],mipmapCount:mipmapCount,isFourCC:(header[off_pfFlags]&DDPF_FOURCC)===DDPF_FOURCC,isRGB:(header[off_pfFlags]&DDPF_RGB)===DDPF_RGB,isLuminance:(header[off_pfFlags]&DDPF_LUMINANCE)===DDPF_LUMINANCE,isCube:(header[off_caps2]&DDSCAPS2_CUBEMAP)===DDSCAPS2_CUBEMAP,isCompressed:fourCC===FOURCC_DXT1||fourCC===FOURCC_DXT3||FOURCC_DXT1===FOURCC_DXT5,dxgiFormat:dxgiFormat,textureType:textureType}};DDSTools._ToHalfFloat=function(value){if(!DDSTools._FloatView){DDSTools._FloatView=new Float32Array(1);DDSTools._Int32View=new Int32Array(DDSTools._FloatView.buffer)}DDSTools._FloatView[0]=value;var x=DDSTools._Int32View[0];var bits=x>>16&32768;var m=x>>12&2047;var e=x>>23&255;if(e<103){return bits}if(e>142){bits|=31744;bits|=(e==255?0:1)&&x&8388607;return bits}if(e<113){m|=2048;bits|=(m>>114-e)+(m>>113-e&1);return bits}bits|=e-112<<10|m>>1;bits+=m&1;return bits};DDSTools._FromHalfFloat=function(value){var s=(value&32768)>>15;var e=(value&31744)>>10;var f=value&1023;if(e===0){return(s?-1:1)*Math.pow(2,-14)*(f/Math.pow(2,10))}else if(e==31){return f?NaN:(s?-1:1)*Infinity}return(s?-1:1)*Math.pow(2,e-15)*(1+f/Math.pow(2,10))};DDSTools._GetHalfFloatAsFloatRGBAArrayBuffer=function(width,height,dataOffset,dataLength,arrayBuffer,lod){var destArray=new Float32Array(dataLength);var srcData=new Uint16Array(arrayBuffer,dataOffset);var index=0;for(var y=0;y<height;y++){for(var x=0;x<width;x++){var srcPos=(x+y*width)*4;destArray[index]=DDSTools._FromHalfFloat(srcData[srcPos]);destArray[index+1]=DDSTools._FromHalfFloat(srcData[srcPos+1]);destArray[index+2]=DDSTools._FromHalfFloat(srcData[srcPos+2]);if(DDSTools.StoreLODInAlphaChannel){destArray[index+3]=lod}else{destArray[index+3]=DDSTools._FromHalfFloat(srcData[srcPos+3])}index+=4}}return destArray};DDSTools._GetHalfFloatRGBAArrayBuffer=function(width,height,dataOffset,dataLength,arrayBuffer,lod){if(DDSTools.StoreLODInAlphaChannel){var destArray=new Uint16Array(dataLength);var srcData=new Uint16Array(arrayBuffer,dataOffset);var index=0;for(var y=0;y<height;y++){for(var x=0;x<width;x++){var srcPos=(x+y*width)*4;destArray[index]=srcData[srcPos];destArray[index+1]=srcData[srcPos+1];destArray[index+2]=srcData[srcPos+2];destArray[index+3]=DDSTools._ToHalfFloat(lod);index+=4}}return destArray}return new Uint16Array(arrayBuffer,dataOffset,dataLength)};DDSTools._GetFloatRGBAArrayBuffer=function(width,height,dataOffset,dataLength,arrayBuffer,lod){if(DDSTools.StoreLODInAlphaChannel){var destArray=new Float32Array(dataLength);var srcData=new Float32Array(arrayBuffer,dataOffset);var index=0;for(var y=0;y<height;y++){for(var x=0;x<width;x++){var srcPos=(x+y*width)*4;destArray[index]=srcData[srcPos];destArray[index+1]=srcData[srcPos+1];destArray[index+2]=srcData[srcPos+2];destArray[index+3]=lod;index+=4}}return destArray}return new Float32Array(arrayBuffer,dataOffset,dataLength)};DDSTools._GetFloatAsUIntRGBAArrayBuffer=function(width,height,dataOffset,dataLength,arrayBuffer,lod){var destArray=new Uint8Array(dataLength);var srcData=new Float32Array(arrayBuffer,dataOffset);var index=0;for(var y=0;y<height;y++){for(var x=0;x<width;x++){var srcPos=(x+y*width)*4;destArray[index]=BABYLON.Scalar.Clamp(srcData[srcPos])*255;destArray[index+1]=BABYLON.Scalar.Clamp(srcData[srcPos+1])*255;destArray[index+2]=BABYLON.Scalar.Clamp(srcData[srcPos+2])*255;if(DDSTools.StoreLODInAlphaChannel){destArray[index+3]=lod}else{destArray[index+3]=BABYLON.Scalar.Clamp(srcData[srcPos+3])*255}index+=4}}return destArray};DDSTools._GetHalfFloatAsUIntRGBAArrayBuffer=function(width,height,dataOffset,dataLength,arrayBuffer,lod){var destArray=new Uint8Array(dataLength);var srcData=new Uint16Array(arrayBuffer,dataOffset);var index=0;for(var y=0;y<height;y++){for(var x=0;x<width;x++){var srcPos=(x+y*width)*4;destArray[index]=BABYLON.Scalar.Clamp(DDSTools._FromHalfFloat(srcData[srcPos]))*255;destArray[index+1]=BABYLON.Scalar.Clamp(DDSTools._FromHalfFloat(srcData[srcPos+1]))*255;destArray[index+2]=BABYLON.Scalar.Clamp(DDSTools._FromHalfFloat(srcData[srcPos+2]))*255;if(DDSTools.StoreLODInAlphaChannel){destArray[index+3]=lod}else{destArray[index+3]=BABYLON.Scalar.Clamp(DDSTools._FromHalfFloat(srcData[srcPos+3]))*255}index+=4}}return destArray};DDSTools._GetRGBAArrayBuffer=function(width,height,dataOffset,dataLength,arrayBuffer){var byteArray=new Uint8Array(dataLength);var srcData=new Uint8Array(arrayBuffer,dataOffset);var index=0;for(var y=0;y<height;y++){for(var x=0;x<width;x++){var srcPos=(x+y*width)*4;byteArray[index]=srcData[srcPos+2];byteArray[index+1]=srcData[srcPos+1];byteArray[index+2]=srcData[srcPos];byteArray[index+3]=srcData[srcPos+3];index+=4}}return byteArray};DDSTools._GetRGBArrayBuffer=function(width,height,dataOffset,dataLength,arrayBuffer){var byteArray=new Uint8Array(dataLength);var srcData=new Uint8Array(arrayBuffer,dataOffset);var index=0;for(var y=0;y<height;y++){for(var x=0;x<width;x++){var srcPos=(x+y*width)*3;byteArray[index]=srcData[srcPos+2];byteArray[index+1]=srcData[srcPos+1];byteArray[index+2]=srcData[srcPos];index+=3}}return byteArray};DDSTools._GetLuminanceArrayBuffer=function(width,height,dataOffset,dataLength,arrayBuffer){var byteArray=new Uint8Array(dataLength);var srcData=new Uint8Array(arrayBuffer,dataOffset);var index=0;for(var y=0;y<height;y++){for(var x=0;x<width;x++){var srcPos=x+y*width;byteArray[index]=srcData[srcPos];index++}}return byteArray};DDSTools.UploadDDSLevels=function(engine,gl,arrayBuffer,info,loadMipmaps,faces,lodIndex){if(lodIndex===void 0){lodIndex=-1}var ext=engine.getCaps().s3tc;var header=new Int32Array(arrayBuffer,0,headerLengthInt),fourCC,blockBytes,internalFormat,format,width,height,dataLength,dataOffset,byteArray,mipmapCount,mip;if(header[off_magic]!=DDS_MAGIC){BABYLON.Tools.Error("Invalid magic number in DDS header");return}if(!info.isFourCC&&!info.isRGB&&!info.isLuminance){BABYLON.Tools.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(info.isCompressed&&!ext){BABYLON.Tools.Error("Compressed textures are not supported on this platform.");return}var bpp=header[off_RGBbpp];dataOffset=header[off_size]+4;var computeFormats=false;if(info.isFourCC){fourCC=header[off_pfFourCC];switch(fourCC){case FOURCC_DXT1:blockBytes=8;internalFormat=ext.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case FOURCC_DXT3:blockBytes=16;internalFormat=ext.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case FOURCC_DXT5:blockBytes=16;internalFormat=ext.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case FOURCC_D3DFMT_R16G16B16A16F:computeFormats=true;break;case FOURCC_D3DFMT_R32G32B32A32F:computeFormats=true;break;case FOURCC_DX10:dataOffset+=5*4;var supported=false;switch(info.dxgiFormat){case DXGI_FORMAT_R16G16B16A16_FLOAT:computeFormats=true;supported=true;break;case DXGI_FORMAT_B8G8R8X8_UNORM:info.isRGB=true;info.isFourCC=false;bpp=32;supported=true;break}if(supported){break}default:console.error("Unsupported FourCC code:",Int32ToFourCC(fourCC));return}}if(computeFormats){format=engine._getWebGLTextureType(info.textureType);internalFormat=engine._getRGBABufferInternalSizedFormat(info.textureType)}mipmapCount=1;if(header[off_flags]&DDSD_MIPMAPCOUNT&&loadMipmaps!==false){mipmapCount=Math.max(1,header[off_mipmapCount])}for(var face=0;face<faces;face++){var sampler=faces===1?gl.TEXTURE_2D:gl.TEXTURE_CUBE_MAP_POSITIVE_X+face;width=header[off_width];height=header[off_height];for(mip=0;mip<mipmapCount;++mip){if(lodIndex===-1||lodIndex===mip){var i=lodIndex===-1?mip:0;if(!info.isCompressed&&info.isFourCC){dataLength=width*height*4;var floatArray;if(engine.badOS||engine.badDesktopOS||!engine.getCaps().textureHalfFloat&&!engine.getCaps().textureFloat){if(bpp===128){floatArray=DDSTools._GetFloatAsUIntRGBAArrayBuffer(width,height,dataOffset,dataLength,arrayBuffer,i)}else if(bpp===64){floatArray=DDSTools._GetHalfFloatAsUIntRGBAArrayBuffer(width,height,dataOffset,dataLength,arrayBuffer,i)}info.textureType=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT;format=engine._getWebGLTextureType(info.textureType);internalFormat=engine._getRGBABufferInternalSizedFormat(info.textureType)}else{if(bpp===128){floatArray=DDSTools._GetFloatRGBAArrayBuffer(width,height,dataOffset,dataLength,arrayBuffer,i)}else if(bpp===64&&!engine.getCaps().textureHalfFloat){floatArray=DDSTools._GetHalfFloatAsFloatRGBAArrayBuffer(width,height,dataOffset,dataLength,arrayBuffer,i);info.textureType=BABYLON.Engine.TEXTURETYPE_FLOAT;format=engine._getWebGLTextureType(info.textureType);internalFormat=engine._getRGBABufferInternalSizedFormat(info.textureType)}else{floatArray=DDSTools._GetHalfFloatRGBAArrayBuffer(width,height,dataOffset,dataLength,arrayBuffer,i)}}engine._uploadDataToTexture(sampler,i,internalFormat,width,height,gl.RGBA,format,floatArray)}else if(info.isRGB){if(bpp===24){dataLength=width*height*3;byteArray=DDSTools._GetRGBArrayBuffer(width,height,dataOffset,dataLength,arrayBuffer);engine._uploadDataToTexture(sampler,i,gl.RGB,width,height,gl.RGB,gl.UNSIGNED_BYTE,byteArray)}else{dataLength=width*height*4;byteArray=DDSTools._GetRGBAArrayBuffer(width,height,dataOffset,dataLength,arrayBuffer);engine._uploadDataToTexture(sampler,i,gl.RGBA,width,height,gl.RGBA,gl.UNSIGNED_BYTE,byteArray)}}else if(info.isLuminance){var unpackAlignment=gl.getParameter(gl.UNPACK_ALIGNMENT);var unpaddedRowSize=width;var paddedRowSize=Math.floor((width+unpackAlignment-1)/unpackAlignment)*unpackAlignment;dataLength=paddedRowSize*(height-1)+unpaddedRowSize;byteArray=DDSTools._GetLuminanceArrayBuffer(width,height,dataOffset,dataLength,arrayBuffer);engine._uploadDataToTexture(sampler,i,gl.LUMINANCE,width,height,gl.LUMINANCE,gl.UNSIGNED_BYTE,byteArray)}else{dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;byteArray=new Uint8Array(arrayBuffer,dataOffset,dataLength);engine._uploadCompressedDataToTexture(sampler,i,internalFormat,width,height,byteArray)}}dataOffset+=width*height*(bpp/8);width*=.5;height*=.5;width=Math.max(1,width);height=Math.max(1,height)}}};DDSTools.StoreLODInAlphaChannel=false;return DDSTools}();Internals.DDSTools=DDSTools})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var KhronosTextureContainer=function(){function KhronosTextureContainer(arrayBuffer,facesExpected,threeDExpected,textureArrayExpected){this.arrayBuffer=arrayBuffer;var identifier=new Uint8Array(this.arrayBuffer,0,12);if(identifier[0]!==171||identifier[1]!==75||identifier[2]!==84||identifier[3]!==88||identifier[4]!==32||identifier[5]!==49||identifier[6]!==49||identifier[7]!==187||identifier[8]!==13||identifier[9]!==10||identifier[10]!==26||identifier[11]!==10){BABYLON.Tools.Error("texture missing KTX identifier");return}var header=new Int32Array(this.arrayBuffer,12,13);var oppositeEndianess=header[0]===16909060;this.glType=oppositeEndianess?this.switchEndainness(header[1]):header[1];this.glTypeSize=oppositeEndianess?this.switchEndainness(header[2]):header[2];this.glFormat=oppositeEndianess?this.switchEndainness(header[3]):header[3];this.glInternalFormat=oppositeEndianess?this.switchEndainness(header[4]):header[4];this.glBaseInternalFormat=oppositeEndianess?this.switchEndainness(header[5]):header[5];this.pixelWidth=oppositeEndianess?this.switchEndainness(header[6]):header[6];this.pixelHeight=oppositeEndianess?this.switchEndainness(header[7]):header[7];this.pixelDepth=oppositeEndianess?this.switchEndainness(header[8]):header[8];this.numberOfArrayElements=oppositeEndianess?this.switchEndainness(header[9]):header[9];this.numberOfFaces=oppositeEndianess?this.switchEndainness(header[10]):header[10];this.numberOfMipmapLevels=oppositeEndianess?this.switchEndainness(header[11]):header[11];this.bytesOfKeyValueData=oppositeEndianess?this.switchEndainness(header[12]):header[12];if(this.glType!==0){BABYLON.Tools.Error("only compressed formats currently supported");return}else{this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels)}if(this.pixelHeight===0||this.pixelDepth!==0){BABYLON.Tools.Error("only 2D textures currently supported");return}if(this.numberOfArrayElements!==0){BABYLON.Tools.Error("texture arrays not currently supported");return}if(this.numberOfFaces!==facesExpected){BABYLON.Tools.Error("number of faces expected"+facesExpected+", but found "+this.numberOfFaces);return}this.loadType=KhronosTextureContainer.COMPRESSED_2D}KhronosTextureContainer.prototype.switchEndainness=function(val){return(val&255)<<24|(val&65280)<<8|val>>8&65280|val>>24&255};KhronosTextureContainer.prototype.uploadLevels=function(gl,loadMipmaps){switch(this.loadType){case KhronosTextureContainer.COMPRESSED_2D:this._upload2DCompressedLevels(gl,loadMipmaps);break;case KhronosTextureContainer.TEX_2D:case KhronosTextureContainer.COMPRESSED_3D:case KhronosTextureContainer.TEX_3D:}};KhronosTextureContainer.prototype._upload2DCompressedLevels=function(gl,loadMipmaps){var dataOffset=KhronosTextureContainer.HEADER_LEN+this.bytesOfKeyValueData;var width=this.pixelWidth;var height=this.pixelHeight;var mipmapCount=loadMipmaps?this.numberOfMipmapLevels:1;for(var level=0;level<mipmapCount;level++){var imageSize=new Int32Array(this.arrayBuffer,dataOffset,1)[0];for(var face=0;face<this.numberOfFaces;face++){var sampler=this.numberOfFaces===1?gl.TEXTURE_2D:gl.TEXTURE_CUBE_MAP_POSITIVE_X+face;var byteArray=new Uint8Array(this.arrayBuffer,dataOffset+4,imageSize);gl.compressedTexImage2D(sampler,level,this.glInternalFormat,width,height,0,byteArray);dataOffset+=imageSize+4;dataOffset+=3-(imageSize+3)%4}width=Math.max(1,width*.5);height=Math.max(1,height*.5)}};KhronosTextureContainer.HEADER_LEN=12+13*4;KhronosTextureContainer.COMPRESSED_2D=0;KhronosTextureContainer.COMPRESSED_3D=1;KhronosTextureContainer.TEX_2D=2;KhronosTextureContainer.TEX_3D=3;return KhronosTextureContainer}();Internals.KhronosTextureContainer=KhronosTextureContainer})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DynamicFloatArrayElementInfo=function(){function DynamicFloatArrayElementInfo(){}return DynamicFloatArrayElementInfo}();BABYLON.DynamicFloatArrayElementInfo=DynamicFloatArrayElementInfo;var DynamicFloatArray=function(){function DynamicFloatArray(stride,initialElementCount){this.compareValueOffset=null;this.sortingAscending=true;this._stride=stride;this.buffer=new Float32Array(stride*initialElementCount);this._lastUsed=0;this._firstFree=0;this._allEntries=new Array(initialElementCount);this._freeEntries=new Array(initialElementCount);for(var i=0;i<initialElementCount;i++){var element=new DynamicFloatArrayElementInfo;element.offset=i*stride;this._allEntries[i]=element;this._freeEntries[initialElementCount-i-1]=element}}DynamicFloatArray.prototype.allocElement=function(){if(this._freeEntries.length===0){this._growBuffer()}var el=this._freeEntries.pop();this._lastUsed=Math.max(el.offset,this._lastUsed);if(el.offset===this._firstFree){if(this._freeEntries.length>0){this._firstFree=this._freeEntries[this._freeEntries.length-1].offset}else{this._firstFree+=this._stride}}return el};DynamicFloatArray.prototype.freeElement=function(elInfo){this._firstFree=Math.min(elInfo.offset,this._firstFree);this._freeEntries.push(elInfo)};DynamicFloatArray.prototype.pack=function(){if(this._freeEntries.length===0){return this.buffer}if(this._lastUsed<this._firstFree){var elementsBuffer_1=this.buffer.subarray(0,this._lastUsed+this._stride);return elementsBuffer_1}var s=this._stride;var lastFree=new DynamicFloatArrayElementInfo;lastFree.offset=this.totalElementCount*s;this._freeEntries.push(lastFree);var sortedFree=this._freeEntries.sort(function(a,b){return a.offset-b.offset});var sortedAll=this._allEntries.sort(function(a,b){return a.offset-b.offset});var firstFreeSlotOffset=sortedFree[0].offset;var freeZoneSize=1;var occupiedZoneSize=(this.usedElementCount+1)*s;var prevOffset=sortedFree[0].offset;for(var i=1;i<sortedFree.length;i++){if(firstFreeSlotOffset>=occupiedZoneSize){break}var curFree=sortedFree[i];var curOffset=curFree.offset;var distance=curOffset-prevOffset;if(distance===s){++freeZoneSize;prevOffset=curOffset;continue}var usedRange=distance/s-1;var curMoveOffset=curOffset-s;var copyCount=Math.min(freeZoneSize,usedRange);for(var j=0;j<copyCount;j++){var freeI=firstFreeSlotOffset/s;var curI=curMoveOffset/s;var moveEl=sortedAll[curI];this._moveElement(moveEl,firstFreeSlotOffset);var replacedEl=sortedAll[freeI];replacedEl.offset=curMoveOffset;sortedAll[freeI]=moveEl;sortedAll[curI]=replacedEl;curMoveOffset-=s;firstFreeSlotOffset+=s}if(freeZoneSize<=usedRange){firstFreeSlotOffset=curMoveOffset+s;freeZoneSize=1+copyCount}else{freeZoneSize=(curOffset-firstFreeSlotOffset)/s+1}prevOffset=curOffset}var elementsBuffer=this.buffer.subarray(0,firstFreeSlotOffset);this._lastUsed=firstFreeSlotOffset-s;this._firstFree=firstFreeSlotOffset;sortedFree.pop();this._freeEntries=sortedFree.sort(function(a,b){return b.offset-a.offset});this._allEntries=sortedAll;return elementsBuffer};DynamicFloatArray.prototype._moveElement=function(element,destOffset){for(var i=0;i<this._stride;i++){this.buffer[destOffset+i]=this.buffer[element.offset+i]}element.offset=destOffset};DynamicFloatArray.prototype._growBuffer=function(){var newElCount=Math.floor(this.totalElementCount*1.5);var newBuffer=new Float32Array(newElCount*this._stride);newBuffer.set(this.buffer);var curCount=this.totalElementCount;var addedCount=newElCount-this.totalElementCount;for(var i=0;i<addedCount;i++){var element=new DynamicFloatArrayElementInfo;element.offset=(curCount+i)*this.stride;this._allEntries.push(element);this._freeEntries[addedCount-i-1]=element}this._firstFree=curCount*this.stride;this.buffer=newBuffer};Object.defineProperty(DynamicFloatArray.prototype,"totalElementCount",{get:function(){return this._allEntries.length},enumerable:true,configurable:true});Object.defineProperty(DynamicFloatArray.prototype,"freeElementCount",{get:function(){return this._freeEntries.length},enumerable:true,configurable:true});Object.defineProperty(DynamicFloatArray.prototype,"usedElementCount",{get:function(){return this._allEntries.length-this._freeEntries.length},enumerable:true,configurable:true});Object.defineProperty(DynamicFloatArray.prototype,"stride",{get:function(){return this._stride},enumerable:true,configurable:true});DynamicFloatArray.prototype.sort=function(){var _this=this;if(!this.compareValueOffset){throw new Error("The DynamicFloatArray.sort() method needs a valid 'compareValueOffset' property")}var count=this.usedElementCount;if(!this._sortTable||this._sortTable.length<count){var newCount=Math.min(this.totalElementCount,count*2);this._sortTable=new Array(newCount)}if(!this._sortedTable||this._sortedTable.length!==count){this._sortedTable=new Array(count)}this.pack();var curOffset=0;var stride=this.stride;for(var i=0;i<count;i++,curOffset+=stride){var si=this._sortTable[i];if(!si){si=new SortInfo;this._sortTable[i]=si}si.compareData=this.buffer[curOffset+this.compareValueOffset];si.offset=curOffset;si.swapedOffset=null;this._sortedTable[i]=si}if(this.sortingAscending){this._sortedTable.sort(function(a,b){return a.compareData-b.compareData})}else{this._sortedTable.sort(function(a,b){return b.compareData-a.compareData})}var swapElements=function(src,dst){for(var i=0;i<stride;i++){var tps=_this.buffer[dst+i];_this.buffer[dst+i]=_this.buffer[src+i];_this.buffer[src+i]=tps}};for(var i=0;i<count;i++){var sourceSI=this._sortedTable[i];var destSI=this._sortTable[i];var sourceOff=sourceSI.offset;if(sourceSI.swapedOffset){var curSI=sourceSI;while(curSI.swapedOffset){curSI=this._sortTable[curSI.swapedOffset/stride]}sourceOff=curSI.offset}destSI.swapedOffset=sourceOff;if(sourceOff!==destSI.offset){swapElements(sourceOff,destSI.offset)}this._allEntries[sourceSI.offset/stride].offset=destSI.offset}this._allEntries.sort(function(a,b){return a.offset-b.offset});return true};return DynamicFloatArray}();BABYLON.DynamicFloatArray=DynamicFloatArray;var SortInfo=function(){function SortInfo(){this.compareData=this.offset=this.swapedOffset=null}return SortInfo}()})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Debug;(function(Debug){var SkeletonViewer=function(){function SkeletonViewer(skeleton,mesh,scene,autoUpdateBonesMatrices,renderingGroupId){if(autoUpdateBonesMatrices===void 0){autoUpdateBonesMatrices=true}if(renderingGroupId===void 0){renderingGroupId=1}this.skeleton=skeleton;this.mesh=mesh;this.autoUpdateBonesMatrices=autoUpdateBonesMatrices;this.renderingGroupId=renderingGroupId;this.color=BABYLON.Color3.White();this._debugLines=new Array;this._isEnabled=false;this._scene=scene;this.update();this._renderFunction=this.update.bind(this)}Object.defineProperty(SkeletonViewer.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(value){if(this._isEnabled===value){return}this._isEnabled=value;if(value){this._scene.registerBeforeRender(this._renderFunction)}else{this._scene.unregisterBeforeRender(this._renderFunction)}},enumerable:true,configurable:true});SkeletonViewer.prototype._getBonePosition=function(position,bone,meshMat,x,y,z){if(x===void 0){x=0}if(y===void 0){y=0}if(z===void 0){z=0}var tmat=BABYLON.Tmp.Matrix[0];var parentBone=bone.getParent();tmat.copyFrom(bone.getLocalMatrix());if(x!==0||y!==0||z!==0){var tmat2=BABYLON.Tmp.Matrix[1];BABYLON.Matrix.IdentityToRef(tmat2);tmat2.m[12]=x;tmat2.m[13]=y;tmat2.m[14]=z;tmat2.multiplyToRef(tmat,tmat)}if(parentBone){tmat.multiplyToRef(parentBone.getAbsoluteTransform(),tmat)}tmat.multiplyToRef(meshMat,tmat);position.x=tmat.m[12];position.y=tmat.m[13];position.z=tmat.m[14]};SkeletonViewer.prototype._getLinesForBonesWithLength=function(bones,meshMat){var len=bones.length;var meshPos=this.mesh.position;for(var i=0;i<len;i++){var bone=bones[i];var points=this._debugLines[i];if(!points){points=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];this._debugLines[i]=points}this._getBonePosition(points[0],bone,meshMat);this._getBonePosition(points[1],bone,meshMat,0,bone.length,0);points[0].subtractInPlace(meshPos);points[1].subtractInPlace(meshPos)}};SkeletonViewer.prototype._getLinesForBonesNoLength=function(bones,meshMat){var len=bones.length;var boneNum=0;var meshPos=this.mesh.position;for(var i=len-1;i>=0;i--){var childBone=bones[i];var parentBone=childBone.getParent();if(!parentBone){continue}var points=this._debugLines[boneNum];if(!points){points=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];this._debugLines[boneNum]=points}childBone.getAbsolutePositionToRef(this.mesh,points[0]);parentBone.getAbsolutePositionToRef(this.mesh,points[1]);points[0].subtractInPlace(meshPos);points[1].subtractInPlace(meshPos);boneNum++}};SkeletonViewer.prototype.update=function(){if(this.autoUpdateBonesMatrices){this.skeleton.computeAbsoluteTransforms()}if(this.skeleton.bones[0].length===undefined){this._getLinesForBonesNoLength(this.skeleton.bones,this.mesh.getWorldMatrix())}else{this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh.getWorldMatrix())}if(!this._debugMesh){this._debugMesh=BABYLON.MeshBuilder.CreateLineSystem(null,{lines:this._debugLines,updatable:true},this._scene);this._debugMesh.renderingGroupId=this.renderingGroupId}else{BABYLON.MeshBuilder.CreateLineSystem(null,{lines:this._debugLines,updatable:true,instance:this._debugMesh},this._scene)}this._debugMesh.position.copyFrom(this.mesh.position);this._debugMesh.color=this.color};SkeletonViewer.prototype.dispose=function(){if(this._debugMesh){this.isEnabled=false;this._debugMesh.dispose();this._debugMesh=null}};return SkeletonViewer}();Debug.SkeletonViewer=SkeletonViewer})(Debug=BABYLON.Debug||(BABYLON.Debug={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Debug;(function(Debug){var AxesViewer=function(){function AxesViewer(scene,scaleLines){if(scaleLines===void 0){scaleLines=1}this._xline=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];this._yline=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];this._zline=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()];this.scaleLines=1;this.scaleLines=scaleLines;this._xmesh=BABYLON.Mesh.CreateLines("xline",this._xline,scene,true);this._ymesh=BABYLON.Mesh.CreateLines("yline",this._yline,scene,true);this._zmesh=BABYLON.Mesh.CreateLines("zline",this._zline,scene,true);this._xmesh.renderingGroupId=2;this._ymesh.renderingGroupId=2;this._zmesh.renderingGroupId=2;this._xmesh.material.checkReadyOnlyOnce=true;this._xmesh.color=new BABYLON.Color3(1,0,0);this._ymesh.material.checkReadyOnlyOnce=true;this._ymesh.color=new BABYLON.Color3(0,1,0);this._zmesh.material.checkReadyOnlyOnce=true;this._zmesh.color=new BABYLON.Color3(0,0,1);this.scene=scene}AxesViewer.prototype.update=function(position,xaxis,yaxis,zaxis){var scaleLines=this.scaleLines;this._xmesh.position.copyFrom(position);this._ymesh.position.copyFrom(position);this._zmesh.position.copyFrom(position);var point2=this._xline[1];point2.x=xaxis.x*scaleLines;point2.y=xaxis.y*scaleLines;point2.z=xaxis.z*scaleLines;BABYLON.Mesh.CreateLines(null,this._xline,null,null,this._xmesh);point2=this._yline[1];point2.x=yaxis.x*scaleLines;point2.y=yaxis.y*scaleLines;point2.z=yaxis.z*scaleLines;BABYLON.Mesh.CreateLines(null,this._yline,null,null,this._ymesh);point2=this._zline[1];point2.x=zaxis.x*scaleLines;point2.y=zaxis.y*scaleLines;point2.z=zaxis.z*scaleLines;BABYLON.Mesh.CreateLines(null,this._zline,null,null,this._zmesh)};AxesViewer.prototype.dispose=function(){if(this._xmesh){this._xmesh.dispose();this._ymesh.dispose();this._zmesh.dispose();this._xmesh=null;this._ymesh=null;this._zmesh=null;this._xline=null;this._yline=null;this._zline=null;this.scene=null}};return AxesViewer}();Debug.AxesViewer=AxesViewer})(Debug=BABYLON.Debug||(BABYLON.Debug={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Debug;(function(Debug){var BoneAxesViewer=function(_super){__extends(BoneAxesViewer,_super);function BoneAxesViewer(scene,bone,mesh,scaleLines){if(scaleLines===void 0){scaleLines=1}var _this=_super.call(this,scene,scaleLines)||this;_this.pos=BABYLON.Vector3.Zero();_this.xaxis=BABYLON.Vector3.Zero();_this.yaxis=BABYLON.Vector3.Zero();_this.zaxis=BABYLON.Vector3.Zero();_this.mesh=mesh;_this.bone=bone;return _this}BoneAxesViewer.prototype.update=function(){var bone=this.bone;bone.getAbsolutePositionToRef(this.mesh,this.pos);bone.getDirectionToRef(BABYLON.Axis.X,this.mesh,this.xaxis);bone.getDirectionToRef(BABYLON.Axis.Y,this.mesh,this.yaxis);bone.getDirectionToRef(BABYLON.Axis.Z,this.mesh,this.zaxis);_super.prototype.update.call(this,this.pos,this.xaxis,this.yaxis,this.zaxis)};BoneAxesViewer.prototype.dispose=function(){if(this.pos){this.pos=null;this.xaxis=null;this.yaxis=null;this.zaxis=null;this.mesh=null;this.bone=null;_super.prototype.dispose.call(this)}};return BoneAxesViewer}(Debug.AxesViewer);Debug.BoneAxesViewer=BoneAxesViewer})(Debug=BABYLON.Debug||(BABYLON.Debug={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var RayHelper=function(){function RayHelper(ray){this.ray=ray}RayHelper.CreateAndShow=function(ray,scene,color){var helper=new RayHelper(ray);helper.show(scene,color);return helper};RayHelper.prototype.show=function(scene,color){if(!this._renderFunction){var ray=this.ray;this._renderFunction=this._render.bind(this);this._scene=scene;this._renderPoints=[ray.origin,ray.origin.add(ray.direction.scale(ray.length))];this._renderLine=BABYLON.Mesh.CreateLines("ray",this._renderPoints,scene,true);this._scene.registerBeforeRender(this._renderFunction)}if(color){this._renderLine.color.copyFrom(color)}};RayHelper.prototype.hide=function(){if(this._renderFunction){this._scene.unregisterBeforeRender(this._renderFunction);this._scene=null;this._renderFunction=null;this._renderLine.dispose();this._renderLine=null;this._renderPoints=null}};RayHelper.prototype._render=function(){var ray=this.ray;var point=this._renderPoints[1];var len=Math.min(ray.length,1e6);point.copyFrom(ray.direction);point.scaleInPlace(len);point.addInPlace(ray.origin);BABYLON.Mesh.CreateLines("ray",this._renderPoints,this._scene,true,this._renderLine)};RayHelper.prototype.attachToMesh=function(mesh,meshSpaceDirection,meshSpaceOrigin,length){this._attachedToMesh=mesh;var ray=this.ray;if(!ray.direction){ray.direction=BABYLON.Vector3.Zero()}if(!ray.origin){ray.origin=BABYLON.Vector3.Zero()}if(length){ray.length=length}if(!meshSpaceOrigin){meshSpaceOrigin=BABYLON.Vector3.Zero()}if(!meshSpaceDirection){meshSpaceDirection=new BABYLON.Vector3(0,0,-1)}if(!this._meshSpaceDirection){this._meshSpaceDirection=meshSpaceDirection.clone();this._meshSpaceOrigin=meshSpaceOrigin.clone()}else{this._meshSpaceDirection.copyFrom(meshSpaceDirection);this._meshSpaceOrigin.copyFrom(meshSpaceOrigin)}if(!this._updateToMeshFunction){this._updateToMeshFunction=this._updateToMesh.bind(this);this._attachedToMesh.getScene().registerBeforeRender(this._updateToMeshFunction)}this._updateToMesh()};RayHelper.prototype.detachFromMesh=function(){if(this._attachedToMesh){this._attachedToMesh.getScene().unregisterBeforeRender(this._updateToMeshFunction);this._attachedToMesh=null;this._updateToMeshFunction=null}};RayHelper.prototype._updateToMesh=function(){var ray=this.ray;if(this._attachedToMesh._isDisposed){this.detachFromMesh();return}this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,ray.direction);BABYLON.Vector3.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),ray.origin)};RayHelper.prototype.dispose=function(){this.hide();this.detachFromMesh();this.ray=null};return RayHelper}();BABYLON.RayHelper=RayHelper})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DebugLayer=function(){function DebugLayer(scene){this._scene=scene}DebugLayer.prototype._createInspector=function(config){if(config===void 0){config={}}var popup=config.popup||false;var initialTab=config.initialTab||0;var parentElement=config.parentElement||null;if(!this._inspector){this._inspector=new INSPECTOR.Inspector(this._scene,popup,initialTab,parentElement,config.newColors)}};DebugLayer.prototype.isVisible=function(){if(!this._inspector){return false}return true};DebugLayer.prototype.hide=function(){if(this._inspector){try{this._inspector.dispose()}catch(e){}this._inspector=null}};DebugLayer.prototype.show=function(config){if(config===void 0){config={}}if(typeof INSPECTOR=="undefined"){BABYLON.Tools.LoadScript(DebugLayer.InspectorURL,this._createInspector.bind(this,config))}else{this._createInspector(config)}};DebugLayer.InspectorURL="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js";return DebugLayer}();BABYLON.DebugLayer=DebugLayer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Debug;(function(Debug){var PhysicsViewer=function(){function PhysicsViewer(scene){this._impostors=[];this._meshes=[];this._numMeshes=0;this._scene=scene||BABYLON.Engine.LastCreatedScene;this._physicsEnginePlugin=this._scene.getPhysicsEngine().getPhysicsPlugin()}PhysicsViewer.prototype._updateDebugMeshes=function(){var plugin=this._physicsEnginePlugin;for(var i=0;i<this._numMeshes;i++){if(this._impostors[i].isDisposed){this.hideImpostor(this._impostors[i--])}else{plugin.syncMeshWithImpostor(this._meshes[i],this._impostors[i])}}};PhysicsViewer.prototype.showImpostor=function(impostor){for(var i=0;i<this._numMeshes;i++){if(this._impostors[i]==impostor){return}}var debugMesh=this._getDebugMesh(impostor,this._scene);if(debugMesh){this._impostors[this._numMeshes]=impostor;this._meshes[this._numMeshes]=debugMesh;if(this._numMeshes===0){this._renderFunction=this._updateDebugMeshes.bind(this);this._scene.registerBeforeRender(this._renderFunction)}this._numMeshes++}};PhysicsViewer.prototype.hideImpostor=function(impostor){var removed=false;for(var i=0;i<this._numMeshes;i++){if(this._impostors[i]==impostor){this._scene.removeMesh(this._meshes[i]);this._meshes[i].dispose();this._numMeshes--;if(this._numMeshes>0){this._meshes[i]=this._meshes[this._numMeshes];this._impostors[i]=this._impostors[this._numMeshes];this._meshes[this._numMeshes]=null;this._impostors[this._numMeshes]=null}else{this._meshes[0]=null;this._impostors[0]=null}removed=true;break}}if(removed&&this._numMeshes===0){this._scene.unregisterBeforeRender(this._renderFunction)}};PhysicsViewer.prototype._getDebugMaterial=function(scene){if(!this._debugMaterial){this._debugMaterial=new BABYLON.StandardMaterial("",scene);this._debugMaterial.wireframe=true}return this._debugMaterial};PhysicsViewer.prototype._getDebugBoxMesh=function(scene){if(!this._debugBoxMesh){this._debugBoxMesh=BABYLON.MeshBuilder.CreateBox("physicsBodyBoxViewMesh",{size:1},scene);this._debugBoxMesh.renderingGroupId=1;this._debugBoxMesh.rotationQuaternion=BABYLON.Quaternion.Identity();this._debugBoxMesh.material=this._getDebugMaterial(scene);scene.removeMesh(this._debugBoxMesh)}return this._debugBoxMesh.createInstance("physicsBodyBoxViewInstance")};PhysicsViewer.prototype._getDebugSphereMesh=function(scene){if(!this._debugSphereMesh){this._debugSphereMesh=BABYLON.MeshBuilder.CreateSphere("physicsBodySphereViewMesh",{diameter:1},scene);this._debugSphereMesh.renderingGroupId=1;this._debugSphereMesh.rotationQuaternion=BABYLON.Quaternion.Identity();this._debugSphereMesh.material=this._getDebugMaterial(scene);scene.removeMesh(this._debugSphereMesh)}return this._debugSphereMesh.createInstance("physicsBodyBoxViewInstance")};PhysicsViewer.prototype._getDebugMesh=function(impostor,scene){var mesh;if(impostor.type==BABYLON.PhysicsImpostor.BoxImpostor){mesh=this._getDebugBoxMesh(scene);impostor.getBoxSizeToRef(mesh.scaling)}else if(impostor.type==BABYLON.PhysicsImpostor.SphereImpostor){mesh=this._getDebugSphereMesh(scene);var radius=impostor.getRadius();mesh.scaling.x=radius*2;mesh.scaling.y=radius*2;mesh.scaling.z=radius*2}return mesh};PhysicsViewer.prototype.dispose=function(){for(var i=0;i<this._numMeshes;i++){this.hideImpostor(this._impostors[i])}if(this._debugBoxMesh){this._debugBoxMesh.dispose()}if(this._debugSphereMesh){this._debugSphereMesh.dispose()}if(this._debugMaterial){this._debugMaterial.dispose()}this._impostors.length=0;this._scene=null;this._physicsEnginePlugin=null};return PhysicsViewer}();Debug.PhysicsViewer=PhysicsViewer})(Debug=BABYLON.Debug||(BABYLON.Debug={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BoundingBoxRenderer=function(){function BoundingBoxRenderer(scene){this.frontColor=new BABYLON.Color3(1,1,1);this.backColor=new BABYLON.Color3(.1,.1,.1);this.showBackLines=true;this.renderList=new BABYLON.SmartArray(32);this._vertexBuffers={};this._scene=scene}BoundingBoxRenderer.prototype._prepareRessources=function(){if(this._colorShader){return}this._colorShader=new BABYLON.ShaderMaterial("colorShader",this._scene,"color",{attributes:[BABYLON.VertexBuffer.PositionKind],uniforms:["world","viewProjection","color"]});var engine=this._scene.getEngine();var boxdata=BABYLON.VertexData.CreateBox({size:1});this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=new BABYLON.VertexBuffer(engine,boxdata.positions,BABYLON.VertexBuffer.PositionKind,false);this._createIndexBuffer()};BoundingBoxRenderer.prototype._createIndexBuffer=function(){var engine=this._scene.getEngine();this._indexBuffer=engine.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])};BoundingBoxRenderer.prototype._rebuild=function(){this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]._rebuild();this._createIndexBuffer()};BoundingBoxRenderer.prototype.reset=function(){this.renderList.reset()};BoundingBoxRenderer.prototype.render=function(){if(this.renderList.length===0){return}this._prepareRessources();if(!this._colorShader.isReady()){return}var engine=this._scene.getEngine();engine.setDepthWrite(false);this._colorShader._preBind();for(var boundingBoxIndex=0;boundingBoxIndex<this.renderList.length;boundingBoxIndex++){var boundingBox=this.renderList.data[boundingBoxIndex];var min=boundingBox.minimum;var max=boundingBox.maximum;var diff=max.subtract(min);var median=min.add(diff.scale(.5));var worldMatrix=BABYLON.Matrix.Scaling(diff.x,diff.y,diff.z).multiply(BABYLON.Matrix.Translation(median.x,median.y,median.z)).multiply(boundingBox.getWorldMatrix());engine.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect());if(this.showBackLines){engine.setDepthFunctionToGreaterOrEqual();this._scene.resetCachedMaterial();this._colorShader.setColor4("color",this.backColor.toColor4());this._colorShader.bind(worldMatrix);engine.draw(false,0,24)}engine.setDepthFunctionToLess();this._scene.resetCachedMaterial();this._colorShader.setColor4("color",this.frontColor.toColor4());this._colorShader.bind(worldMatrix);engine.draw(false,0,24)}this._colorShader.unbind();engine.setDepthFunctionToLessOrEqual();engine.setDepthWrite(true)};BoundingBoxRenderer.prototype.renderOcclusionBoundingBox=function(mesh){this._prepareRessources();if(!this._colorShader.isReady()){return}var engine=this._scene.getEngine();engine.setDepthWrite(false);engine.setColorWrite(false);this._colorShader._preBind();var boundingBox=mesh._boundingInfo.boundingBox;var min=boundingBox.minimum;var max=boundingBox.maximum;var diff=max.subtract(min);var median=min.add(diff.scale(.5));var worldMatrix=BABYLON.Matrix.Scaling(diff.x,diff.y,diff.z).multiply(BABYLON.Matrix.Translation(median.x,median.y,median.z)).multiply(boundingBox.getWorldMatrix());engine.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect());engine.setDepthFunctionToLess();this._scene.resetCachedMaterial();this._colorShader.bind(worldMatrix);engine.draw(false,0,24);this._colorShader.unbind();engine.setDepthFunctionToLessOrEqual();engine.setDepthWrite(true);engine.setColorWrite(true)};BoundingBoxRenderer.prototype.dispose=function(){if(!this._colorShader){return}this.renderList.dispose();this._colorShader.dispose();var buffer=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind];if(buffer){buffer.dispose();this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=null}this._scene.getEngine()._releaseBuffer(this._indexBuffer)};return BoundingBoxRenderer}();BABYLON.BoundingBoxRenderer=BoundingBoxRenderer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MorphTarget=function(){function MorphTarget(name,influence){if(influence===void 0){influence=0}this.name=name;this.animations=new Array;this.onInfluenceChanged=new BABYLON.Observable;this.influence=influence}Object.defineProperty(MorphTarget.prototype,"influence",{get:function(){return this._influence},set:function(influence){if(this._influence===influence){return}var previous=this._influence;this._influence=influence;if(this.onInfluenceChanged.hasObservers){this.onInfluenceChanged.notifyObservers(previous===0||influence===0)}},enumerable:true,configurable:true});Object.defineProperty(MorphTarget.prototype,"hasNormals",{get:function(){return this._normals!==undefined},enumerable:true,configurable:true});Object.defineProperty(MorphTarget.prototype,"hasTangents",{get:function(){return this._tangents!==undefined},enumerable:true,configurable:true});MorphTarget.prototype.setPositions=function(data){this._positions=new Float32Array(data)};MorphTarget.prototype.getPositions=function(){return this._positions};MorphTarget.prototype.setNormals=function(data){this._normals=new Float32Array(data)};MorphTarget.prototype.getNormals=function(){return this._normals};MorphTarget.prototype.setTangents=function(data){this._tangents=new Float32Array(data)};MorphTarget.prototype.getTangents=function(){return this._tangents};MorphTarget.prototype.serialize=function(){var serializationObject={};serializationObject.name=this.name;serializationObject.influence=this.influence;serializationObject.positions=Array.prototype.slice.call(this.getPositions());if(this.hasNormals){serializationObject.normals=Array.prototype.slice.call(this.getNormals())}if(this.hasTangents){serializationObject.tangents=Array.prototype.slice.call(this.getTangents())}BABYLON.Animation.AppendSerializedAnimations(this,serializationObject);return serializationObject};MorphTarget.Parse=function(serializationObject){var result=new MorphTarget(serializationObject.name,serializationObject.influence);result.setPositions(serializationObject.positions);if(serializationObject.normals){result.setNormals(serializationObject.normals)}if(serializationObject.tangents){result.setTangents(serializationObject.tangents)}if(serializationObject.animations){for(var animationIndex=0;animationIndex<serializationObject.animations.length;animationIndex++){var parsedAnimation=serializationObject.animations[animationIndex];result.animations.push(BABYLON.Animation.Parse(parsedAnimation))}}return result};MorphTarget.FromMesh=function(mesh,name,influence){if(!name){name=mesh.name}var result=new MorphTarget(name,influence);result.setPositions(mesh.getVerticesData(BABYLON.VertexBuffer.PositionKind));if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){result.setNormals(mesh.getVerticesData(BABYLON.VertexBuffer.NormalKind))}if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.TangentKind)){result.setTangents(mesh.getVerticesData(BABYLON.VertexBuffer.TangentKind))}return result};return MorphTarget}();BABYLON.MorphTarget=MorphTarget})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MorphTargetManager=function(){function MorphTargetManager(scene){this._targets=new Array;this._targetObservable=new Array;this._activeTargets=new BABYLON.SmartArray(16);this._supportsNormals=false;this._supportsTangents=false;this._vertexCount=0;this._uniqueId=0;this._tempInfluences=new Array;if(!scene){scene=BABYLON.Engine.LastCreatedScene}this._scene=scene;this._scene.morphTargetManagers.push(this);this._uniqueId=scene.getUniqueId()}Object.defineProperty(MorphTargetManager.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:true,configurable:true});Object.defineProperty(MorphTargetManager.prototype,"vertexCount",{get:function(){return this._vertexCount},enumerable:true,configurable:true});Object.defineProperty(MorphTargetManager.prototype,"supportsNormals",{get:function(){return this._supportsNormals},enumerable:true,configurable:true});Object.defineProperty(MorphTargetManager.prototype,"supportsTangents",{get:function(){return this._supportsTangents},enumerable:true,configurable:true});Object.defineProperty(MorphTargetManager.prototype,"numTargets",{get:function(){return this._targets.length},enumerable:true,configurable:true});Object.defineProperty(MorphTargetManager.prototype,"numInfluencers",{get:function(){return this._activeTargets.length},enumerable:true,configurable:true});Object.defineProperty(MorphTargetManager.prototype,"influences",{get:function(){return this._influences},enumerable:true,configurable:true});MorphTargetManager.prototype.getActiveTarget=function(index){return this._activeTargets.data[index]};MorphTargetManager.prototype.getTarget=function(index){return this._targets[index]};MorphTargetManager.prototype.addTarget=function(target){var _this=this;if(this._vertexCount){if(this._vertexCount!==target.getPositions().length/3){BABYLON.Tools.Error("Incompatible target. Targets must all have the same vertices count.");return}}this._targets.push(target);this._targetObservable.push(target.onInfluenceChanged.add(function(needUpdate){_this._syncActiveTargets(needUpdate)}));this._syncActiveTargets(true)};MorphTargetManager.prototype.removeTarget=function(target){var index=this._targets.indexOf(target);if(index>=0){this._targets.splice(index,1);target.onInfluenceChanged.remove(this._targetObservable.splice(index,1)[0]);this._vertexCount=0;this._syncActiveTargets(true)}};MorphTargetManager.prototype.serialize=function(){var serializationObject={};serializationObject.id=this.uniqueId;serializationObject.targets=[];for(var _i=0,_a=this._targets;_i<_a.length;_i++){var target=_a[_i];serializationObject.targets.push(target.serialize())}return serializationObject};MorphTargetManager.prototype._syncActiveTargets=function(needUpdate){var influenceCount=0;this._activeTargets.reset();this._supportsNormals=true;this._supportsTangents=true;for(var _i=0,_a=this._targets;_i<_a.length;_i++){var target=_a[_i];if(target.influence>0){this._activeTargets.push(target);this._tempInfluences[influenceCount++]=target.influence;this._supportsNormals=this._supportsNormals&&target.hasNormals;this._supportsTangents=this._supportsTangents&&target.hasTangents;if(this._vertexCount===0){this._vertexCount=target.getPositions().length/3}}}if(!this._influences||this._influences.length!==influenceCount){this._influences=new Float32Array(influenceCount)}for(var index=0;index<influenceCount;index++){this._influences[index]=this._tempInfluences[index]}if(needUpdate){for(var _b=0,_c=this._scene.meshes;_b<_c.length;_b++){var mesh=_c[_b];if(mesh.morphTargetManager===this){mesh._syncGeometryWithMorphTargetManager()}}}};MorphTargetManager.Parse=function(serializationObject,scene){var result=new MorphTargetManager(scene);result._uniqueId=serializationObject.id;for(var _i=0,_a=serializationObject.targets;_i<_a.length;_i++){var targetData=_a[_i];result.addTarget(BABYLON.MorphTarget.Parse(targetData))}return result};return MorphTargetManager}();BABYLON.MorphTargetManager=MorphTargetManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Octree=function(){function Octree(creationFunc,maxBlockCapacity,maxDepth){if(maxDepth===void 0){maxDepth=2}this.maxDepth=maxDepth;this.dynamicContent=new Array;this._maxBlockCapacity=maxBlockCapacity||64;this._selectionContent=new BABYLON.SmartArray(1024);this._creationFunc=creationFunc}Octree.prototype.update=function(worldMin,worldMax,entries){Octree._CreateBlocks(worldMin,worldMax,entries,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)};Octree.prototype.addMesh=function(entry){for(var index=0;index<this.blocks.length;index++){var block=this.blocks[index];block.addEntry(entry)}};Octree.prototype.select=function(frustumPlanes,allowDuplicate){this._selectionContent.reset();for(var index=0;index<this.blocks.length;index++){var block=this.blocks[index];block.select(frustumPlanes,this._selectionContent,allowDuplicate)}if(allowDuplicate){this._selectionContent.concat(this.dynamicContent)}else{this._selectionContent.concatWithNoDuplicate(this.dynamicContent)}return this._selectionContent};Octree.prototype.intersects=function(sphereCenter,sphereRadius,allowDuplicate){this._selectionContent.reset();for(var index=0;index<this.blocks.length;index++){var block=this.blocks[index];block.intersects(sphereCenter,sphereRadius,this._selectionContent,allowDuplicate)}if(allowDuplicate){this._selectionContent.concat(this.dynamicContent)}else{this._selectionContent.concatWithNoDuplicate(this.dynamicContent)}return this._selectionContent};Octree.prototype.intersectsRay=function(ray){this._selectionContent.reset();for(var index=0;index<this.blocks.length;index++){var block=this.blocks[index];block.intersectsRay(ray,this._selectionContent)}this._selectionContent.concatWithNoDuplicate(this.dynamicContent);return this._selectionContent};Octree._CreateBlocks=function(worldMin,worldMax,entries,maxBlockCapacity,currentDepth,maxDepth,target,creationFunc){target.blocks=new Array;var blockSize=new BABYLON.Vector3((worldMax.x-worldMin.x)/2,(worldMax.y-worldMin.y)/2,(worldMax.z-worldMin.z)/2);for(var x=0;x<2;x++){for(var y=0;y<2;y++){for(var z=0;z<2;z++){var localMin=worldMin.add(blockSize.multiplyByFloats(x,y,z));var localMax=worldMin.add(blockSize.multiplyByFloats(x+1,y+1,z+1));var block=new BABYLON.OctreeBlock(localMin,localMax,maxBlockCapacity,currentDepth+1,maxDepth,creationFunc);block.addEntries(entries);target.blocks.push(block)}}}};Octree.CreationFuncForMeshes=function(entry,block){if(!entry.isBlocked&&entry.getBoundingInfo().boundingBox.intersectsMinMax(block.minPoint,block.maxPoint)){block.entries.push(entry)}};Octree.CreationFuncForSubMeshes=function(entry,block){if(entry.getBoundingInfo().boundingBox.intersectsMinMax(block.minPoint,block.maxPoint)){block.entries.push(entry)}};return Octree}();BABYLON.Octree=Octree})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var OctreeBlock=function(){function OctreeBlock(minPoint,maxPoint,capacity,depth,maxDepth,creationFunc){this.entries=new Array;this._boundingVectors=new Array;this._capacity=capacity;this._depth=depth;this._maxDepth=maxDepth;this._creationFunc=creationFunc;this._minPoint=minPoint;this._maxPoint=maxPoint;this._boundingVectors.push(minPoint.clone());this._boundingVectors.push(maxPoint.clone());this._boundingVectors.push(minPoint.clone());this._boundingVectors[2].x=maxPoint.x;this._boundingVectors.push(minPoint.clone());this._boundingVectors[3].y=maxPoint.y;this._boundingVectors.push(minPoint.clone());this._boundingVectors[4].z=maxPoint.z;this._boundingVectors.push(maxPoint.clone());this._boundingVectors[5].z=minPoint.z;this._boundingVectors.push(maxPoint.clone());this._boundingVectors[6].x=minPoint.x;this._boundingVectors.push(maxPoint.clone());this._boundingVectors[7].y=minPoint.y}Object.defineProperty(OctreeBlock.prototype,"capacity",{get:function(){return this._capacity},enumerable:true,configurable:true});Object.defineProperty(OctreeBlock.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:true,configurable:true});Object.defineProperty(OctreeBlock.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:true,configurable:true});OctreeBlock.prototype.addEntry=function(entry){if(this.blocks){for(var index=0;index<this.blocks.length;index++){var block=this.blocks[index];block.addEntry(entry)}return}this._creationFunc(entry,this);if(this.entries.length>this.capacity&&this._depth<this._maxDepth){this.createInnerBlocks()}};OctreeBlock.prototype.addEntries=function(entries){for(var index=0;index<entries.length;index++){var mesh=entries[index];this.addEntry(mesh)}};OctreeBlock.prototype.select=function(frustumPlanes,selection,allowDuplicate){if(BABYLON.BoundingBox.IsInFrustum(this._boundingVectors,frustumPlanes)){if(this.blocks){for(var index=0;index<this.blocks.length;index++){var block=this.blocks[index];block.select(frustumPlanes,selection,allowDuplicate)}return}if(allowDuplicate){selection.concat(this.entries)}else{selection.concatWithNoDuplicate(this.entries)}}};OctreeBlock.prototype.intersects=function(sphereCenter,sphereRadius,selection,allowDuplicate){if(BABYLON.BoundingBox.IntersectsSphere(this._minPoint,this._maxPoint,sphereCenter,sphereRadius)){if(this.blocks){for(var index=0;index<this.blocks.length;index++){var block=this.blocks[index];block.intersects(sphereCenter,sphereRadius,selection,allowDuplicate)}return}if(allowDuplicate){selection.concat(this.entries)}else{selection.concatWithNoDuplicate(this.entries)}}};OctreeBlock.prototype.intersectsRay=function(ray,selection){if(ray.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var index=0;index<this.blocks.length;index++){var block=this.blocks[index];block.intersectsRay(ray,selection)}return}selection.concatWithNoDuplicate(this.entries)}};OctreeBlock.prototype.createInnerBlocks=function(){BABYLON.Octree._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)};return OctreeBlock}();BABYLON.OctreeBlock=OctreeBlock})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SIMDVector3=function(){function SIMDVector3(){}SIMDVector3.TransformCoordinatesToRefSIMD=function(vector,transformation,result){SIMDVector3.TransformCoordinatesFromFloatsToRefSIMD(vector.x,vector.y,vector.z,transformation,result)};SIMDVector3.TransformCoordinatesFromFloatsToRefSIMD=function(x,y,z,transformation,result){var m=transformation.m;var m0=SIMD.Float32x4.load(m,0);var m1=SIMD.Float32x4.load(m,4);var m2=SIMD.Float32x4.load(m,8);var m3=SIMD.Float32x4.load(m,12);var r=SIMD.Float32x4.add(SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(x),m0),SIMD.Float32x4.mul(SIMD.Float32x4.splat(y),m1)),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(z),m2),m3));r=SIMD.Float32x4.div(r,SIMD.Float32x4.swizzle(r,3,3,3,3));result.x=SIMD.Float32x4.extractLane(r,0);result.y=SIMD.Float32x4.extractLane(r,1);result.z=SIMD.Float32x4.extractLane(r,2)};return SIMDVector3}();var SIMDMatrix=function(){function SIMDMatrix(){}SIMDMatrix.prototype.multiplyToArraySIMD=function(other,result,offset){var tm=this.m;var om=other.m;var m0=SIMD.Float32x4.load(om,0);var m1=SIMD.Float32x4.load(om,4);var m2=SIMD.Float32x4.load(om,8);var m3=SIMD.Float32x4.load(om,12);for(var i=0;i<16;i+=4){SIMD.Float32x4.store(result,i+offset,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(tm[i]),m0),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(tm[i+1]),m1),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(tm[i+2]),m2),SIMD.Float32x4.mul(SIMD.Float32x4.splat(tm[i+3]),m3)))))}return this};SIMDMatrix.prototype.invertToRefSIMD=function(other){var src=this.m;var dest=other.m;var src0=SIMD.Float32x4.load(src,0);var src1=SIMD.Float32x4.load(src,4);var src2=SIMD.Float32x4.load(src,8);var src3=SIMD.Float32x4.load(src,12);var tmp1=SIMD.Float32x4.shuffle(src0,src1,0,1,4,5);var row1=SIMD.Float32x4.shuffle(src2,src3,0,1,4,5);var row0=SIMD.Float32x4.shuffle(tmp1,row1,0,2,4,6);row1=SIMD.Float32x4.shuffle(row1,tmp1,1,3,5,7);tmp1=SIMD.Float32x4.shuffle(src0,src1,2,3,6,7);var row3=SIMD.Float32x4.shuffle(src2,src3,2,3,6,7);var row2=SIMD.Float32x4.shuffle(tmp1,row3,0,2,4,6);row3=SIMD.Float32x4.shuffle(row3,tmp1,1,3,5,7);tmp1=SIMD.Float32x4.mul(row2,row3);tmp1=SIMD.Float32x4.swizzle(tmp1,1,0,3,2);var minor0=SIMD.Float32x4.mul(row1,tmp1);var minor1=SIMD.Float32x4.mul(row0,tmp1);tmp1=SIMD.Float32x4.swizzle(tmp1,2,3,0,1);minor0=SIMD.Float32x4.sub(SIMD.Float32x4.mul(row1,tmp1),minor0);minor1=SIMD.Float32x4.sub(SIMD.Float32x4.mul(row0,tmp1),minor1);minor1=SIMD.Float32x4.swizzle(minor1,2,3,0,1);tmp1=SIMD.Float32x4.mul(row1,row2);tmp1=SIMD.Float32x4.swizzle(tmp1,1,0,3,2);minor0=SIMD.Float32x4.add(SIMD.Float32x4.mul(row3,tmp1),minor0);var minor3=SIMD.Float32x4.mul(row0,tmp1);tmp1=SIMD.Float32x4.swizzle(tmp1,2,3,0,1);minor0=SIMD.Float32x4.sub(minor0,SIMD.Float32x4.mul(row3,tmp1));minor3=SIMD.Float32x4.sub(SIMD.Float32x4.mul(row0,tmp1),minor3);minor3=SIMD.Float32x4.swizzle(minor3,2,3,0,1);tmp1=SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(row1,2,3,0,1),row3);tmp1=SIMD.Float32x4.swizzle(tmp1,1,0,3,2);row2=SIMD.Float32x4.swizzle(row2,2,3,0,1);minor0=SIMD.Float32x4.add(SIMD.Float32x4.mul(row2,tmp1),minor0);var minor2=SIMD.Float32x4.mul(row0,tmp1);tmp1=SIMD.Float32x4.swizzle(tmp1,2,3,0,1);minor0=SIMD.Float32x4.sub(minor0,SIMD.Float32x4.mul(row2,tmp1));minor2=SIMD.Float32x4.sub(SIMD.Float32x4.mul(row0,tmp1),minor2);minor2=SIMD.Float32x4.swizzle(minor2,2,3,0,1);tmp1=SIMD.Float32x4.mul(row0,row1);tmp1=SIMD.Float32x4.swizzle(tmp1,1,0,3,2);minor2=SIMD.Float32x4.add(SIMD.Float32x4.mul(row3,tmp1),minor2);minor3=SIMD.Float32x4.sub(SIMD.Float32x4.mul(row2,tmp1),minor3);tmp1=SIMD.Float32x4.swizzle(tmp1,2,3,0,1);minor2=SIMD.Float32x4.sub(SIMD.Float32x4.mul(row3,tmp1),minor2);minor3=SIMD.Float32x4.sub(minor3,SIMD.Float32x4.mul(row2,tmp1));tmp1=SIMD.Float32x4.mul(row0,row3);tmp1=SIMD.Float32x4.swizzle(tmp1,1,0,3,2);minor1=SIMD.Float32x4.sub(minor1,SIMD.Float32x4.mul(row2,tmp1));minor2=SIMD.Float32x4.add(SIMD.Float32x4.mul(row1,tmp1),minor2);tmp1=SIMD.Float32x4.swizzle(tmp1,2,3,0,1);minor1=SIMD.Float32x4.add(SIMD.Float32x4.mul(row2,tmp1),minor1);minor2=SIMD.Float32x4.sub(minor2,SIMD.Float32x4.mul(row1,tmp1));tmp1=SIMD.Float32x4.mul(row0,row2);tmp1=SIMD.Float32x4.swizzle(tmp1,1,0,3,2);minor1=SIMD.Float32x4.add(SIMD.Float32x4.mul(row3,tmp1),minor1);minor3=SIMD.Float32x4.sub(minor3,SIMD.Float32x4.mul(row1,tmp1));tmp1=SIMD.Float32x4.swizzle(tmp1,2,3,0,1);minor1=SIMD.Float32x4.sub(minor1,SIMD.Float32x4.mul(row3,tmp1));minor3=SIMD.Float32x4.add(SIMD.Float32x4.mul(row1,tmp1),minor3);var det=SIMD.Float32x4.mul(row0,minor0);det=SIMD.Float32x4.add(SIMD.Float32x4.swizzle(det,2,3,0,1),det);det=SIMD.Float32x4.add(SIMD.Float32x4.swizzle(det,1,0,3,2),det);tmp1=SIMD.Float32x4.reciprocalApproximation(det);det=SIMD.Float32x4.sub(SIMD.Float32x4.add(tmp1,tmp1),SIMD.Float32x4.mul(det,SIMD.Float32x4.mul(tmp1,tmp1)));det=SIMD.Float32x4.swizzle(det,0,0,0,0);SIMD.Float32x4.store(dest,0,SIMD.Float32x4.mul(det,minor0));SIMD.Float32x4.store(dest,4,SIMD.Float32x4.mul(det,minor1));SIMD.Float32x4.store(dest,8,minor2=SIMD.Float32x4.mul(det,minor2));SIMD.Float32x4.store(dest,12,SIMD.Float32x4.mul(det,minor3));return this};SIMDMatrix.LookAtLHToRefSIMD=function(eyeRef,targetRef,upRef,result){var out=result.m;var center=SIMD.Float32x4(targetRef.x,targetRef.y,targetRef.z,0);var eye=SIMD.Float32x4(eyeRef.x,eyeRef.y,eyeRef.z,0);var up=SIMD.Float32x4(upRef.x,upRef.y,upRef.z,0);var f=SIMD.Float32x4.sub(center,eye);var tmp=SIMD.Float32x4.mul(f,f);tmp=SIMD.Float32x4.add(tmp,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(tmp,1,2,0,3),SIMD.Float32x4.swizzle(tmp,2,0,1,3)));f=SIMD.Float32x4.mul(f,SIMD.Float32x4.reciprocalSqrtApproximation(tmp));tmp=SIMD.Float32x4.mul(up,up);tmp=SIMD.Float32x4.add(tmp,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(tmp,1,2,0,3),SIMD.Float32x4.swizzle(tmp,2,0,1,3)));up=SIMD.Float32x4.mul(up,SIMD.Float32x4.reciprocalSqrtApproximation(tmp));var s=SIMD.Float32x4.sub(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,1,2,0,3),SIMD.Float32x4.swizzle(up,2,0,1,3)),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,2,0,1,3),SIMD.Float32x4.swizzle(up,1,2,0,3)));tmp=SIMD.Float32x4.mul(s,s);tmp=SIMD.Float32x4.add(tmp,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(tmp,1,2,0,3),SIMD.Float32x4.swizzle(tmp,2,0,1,3)));s=SIMD.Float32x4.mul(s,SIMD.Float32x4.reciprocalSqrtApproximation(tmp));var u=SIMD.Float32x4.sub(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(s,1,2,0,3),SIMD.Float32x4.swizzle(f,2,0,1,3)),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(s,2,0,1,3),SIMD.Float32x4.swizzle(f,1,2,0,3)));tmp=SIMD.Float32x4.mul(s,s);tmp=SIMD.Float32x4.add(tmp,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(tmp,1,2,0,3),SIMD.Float32x4.swizzle(tmp,2,0,1,3)));s=SIMD.Float32x4.mul(s,SIMD.Float32x4.reciprocalSqrtApproximation(tmp));var zero=SIMD.Float32x4.splat(0);s=SIMD.Float32x4.neg(s);var tmp01=SIMD.Float32x4.shuffle(s,u,0,1,4,5);var tmp23=SIMD.Float32x4.shuffle(f,zero,0,1,4,5);var a0=SIMD.Float32x4.shuffle(tmp01,tmp23,0,2,4,6);var a1=SIMD.Float32x4.shuffle(tmp01,tmp23,1,3,5,7);var a2=SIMD.Float32x4.shuffle(SIMD.Float32x4.shuffle(s,u,2,3,6,7),SIMD.Float32x4.shuffle(f,zero,2,3,6,7),0,2,4,6);var a3=SIMD.Float32x4(0,0,0,1);var b=SIMD.Float32x4(1,0,0,0);SIMD.Float32x4.store(out,0,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,0,0,0,0),a0),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,1,1,1,1),a1),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,2,2,2,2),a2),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,3,3,3,3),a3)))));b=SIMD.Float32x4(0,1,0,0);SIMD.Float32x4.store(out,4,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,0,0,0,0),a0),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,1,1,1,1),a1),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,2,2,2,2),a2),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,3,3,3,3),a3)))));b=SIMD.Float32x4(0,0,1,0);SIMD.Float32x4.store(out,8,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,0,0,0,0),a0),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,1,1,1,1),a1),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,2,2,2,2),a2),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,3,3,3,3),a3)))));b=SIMD.Float32x4.replaceLane(SIMD.Float32x4.neg(eye),3,1);SIMD.Float32x4.store(out,12,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,0,0,0,0),a0),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,1,1,1,1),a1),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,2,2,2,2),a2),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(b,3,3,3,3),a3)))))};return SIMDMatrix}();var previousMultiplyToArray=BABYLON.Matrix.prototype.multiplyToArray;var previousInvertToRef=BABYLON.Matrix.prototype.invertToRef;var previousLookAtLHToRef=BABYLON.Matrix.LookAtLHToRef;var previousTransformCoordinatesToRef=BABYLON.Vector3.TransformCoordinatesToRef;var previousTransformCoordinatesFromFloatsToRef=BABYLON.Vector3.TransformCoordinatesFromFloatsToRef;var SIMDHelper=function(){function SIMDHelper(){}Object.defineProperty(SIMDHelper,"IsEnabled",{get:function(){return SIMDHelper._isEnabled},enumerable:true,configurable:true});SIMDHelper.DisableSIMD=function(){BABYLON.Matrix.prototype.multiplyToArray=previousMultiplyToArray;BABYLON.Matrix.prototype.invertToRef=previousInvertToRef;BABYLON.Matrix.LookAtLHToRef=previousLookAtLHToRef;BABYLON.Vector3.TransformCoordinatesToRef=previousTransformCoordinatesToRef;BABYLON.Vector3.TransformCoordinatesFromFloatsToRef=previousTransformCoordinatesFromFloatsToRef;SIMDHelper._isEnabled=false};SIMDHelper.EnableSIMD=function(){if(self.SIMD===undefined){return}if(!self.Math.fround){self.Math.fround=function(array){return function(x){return array[0]=x,array[0]}}(new Float32Array(1))}if(!self.Math.imul){self.Math.imul=function(a,b){var ah=a>>>16&65535;var al=a&65535;var bh=b>>>16&65535;var bl=b&65535;return al*bl+(ah*bl+al*bh<<16>>>0)|0}}BABYLON.Matrix.prototype.multiplyToArray=SIMDMatrix.prototype.multiplyToArraySIMD;BABYLON.Matrix.prototype.invertToRef=SIMDMatrix.prototype.invertToRefSIMD;BABYLON.Matrix.LookAtLHToRef=SIMDMatrix.LookAtLHToRefSIMD;BABYLON.Vector3.TransformCoordinatesToRef=SIMDVector3.TransformCoordinatesToRefSIMD;BABYLON.Vector3.TransformCoordinatesFromFloatsToRef=SIMDVector3.TransformCoordinatesFromFloatsToRefSIMD;SIMDHelper._isEnabled=true};SIMDHelper._isEnabled=false;return SIMDHelper}();BABYLON.SIMDHelper=SIMDHelper})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VRDistortionCorrectionPostProcess=function(_super){__extends(VRDistortionCorrectionPostProcess,_super);function VRDistortionCorrectionPostProcess(name,camera,isRightEye,vrMetrics){var _this=_super.call(this,name,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,vrMetrics.postProcessScaleFactor,camera,BABYLON.Texture.BILINEAR_SAMPLINGMODE,null,null)||this;_this._isRightEye=isRightEye;_this._distortionFactors=vrMetrics.distortionK;_this._postProcessScaleFactor=vrMetrics.postProcessScaleFactor;_this._lensCenterOffset=vrMetrics.lensCenterOffset;_this.adaptScaleToCurrentViewport=true;_this.onSizeChangedObservable.add(function(){_this.aspectRatio=_this.width*.5/_this.height;_this._scaleIn=new BABYLON.Vector2(2,2/_this.aspectRatio);_this._scaleFactor=new BABYLON.Vector2(.5*(1/_this._postProcessScaleFactor),.5*(1/_this._postProcessScaleFactor)*_this.aspectRatio);_this._lensCenter=new BABYLON.Vector2(_this._isRightEye?.5-_this._lensCenterOffset*.5:.5+_this._lensCenterOffset*.5,.5)});_this.onApplyObservable.add(function(effect){effect.setFloat2("LensCenter",_this._lensCenter.x,_this._lensCenter.y);effect.setFloat2("Scale",_this._scaleFactor.x,_this._scaleFactor.y);effect.setFloat2("ScaleIn",_this._scaleIn.x,_this._scaleIn.y);effect.setFloat4("HmdWarpParam",_this._distortionFactors[0],_this._distortionFactors[1],_this._distortionFactors[2],_this._distortionFactors[3])});return _this}return VRDistortionCorrectionPostProcess}(BABYLON.PostProcess);BABYLON.VRDistortionCorrectionPostProcess=VRDistortionCorrectionPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var AnaglyphPostProcess=function(_super){__extends(AnaglyphPostProcess,_super);function AnaglyphPostProcess(name,options,rigCameras,samplingMode,engine,reusable){var _this=_super.call(this,name,"anaglyph",null,["leftSampler"],options,rigCameras[1],samplingMode,engine,reusable)||this;_this._passedProcess=rigCameras[0]._rigPostProcess;_this.onApplyObservable.add(function(effect){effect.setTextureFromPostProcess("leftSampler",_this._passedProcess)});return _this}return AnaglyphPostProcess}(BABYLON.PostProcess);BABYLON.AnaglyphPostProcess=AnaglyphPostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var StereoscopicInterlacePostProcess=function(_super){__extends(StereoscopicInterlacePostProcess,_super);function StereoscopicInterlacePostProcess(name,rigCameras,isStereoscopicHoriz,samplingMode,engine,reusable){var _this=_super.call(this,name,"stereoscopicInterlace",["stepSize"],["camASampler"],1,rigCameras[1],samplingMode,engine,reusable,isStereoscopicHoriz?"#define IS_STEREOSCOPIC_HORIZ 1":undefined)||this;_this._passedProcess=rigCameras[0]._rigPostProcess;_this._stepSize=new BABYLON.Vector2(1/_this.width,1/_this.height);_this.onSizeChangedObservable.add(function(){_this._stepSize=new BABYLON.Vector2(1/_this.width,1/_this.height)});_this.onApplyObservable.add(function(effect){effect.setTextureFromPostProcess("camASampler",_this._passedProcess);effect.setFloat2("stepSize",_this._stepSize.x,_this._stepSize.y)});return _this}return StereoscopicInterlacePostProcess}(BABYLON.PostProcess);BABYLON.StereoscopicInterlacePostProcess=StereoscopicInterlacePostProcess})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FreeCameraDeviceOrientationInput=function(){function FreeCameraDeviceOrientationInput(){var _this=this;this._screenOrientationAngle=0;this._screenQuaternion=new BABYLON.Quaternion;this._alpha=0;this._beta=0;this._gamma=0;this._orientationChanged=function(){_this._screenOrientationAngle=window.orientation!==undefined?+window.orientation:window.screen.orientation&&window.screen.orientation["angle"]?window.screen.orientation.angle:0;_this._screenOrientationAngle=-BABYLON.Tools.ToRadians(_this._screenOrientationAngle/2);_this._screenQuaternion.copyFromFloats(0,Math.sin(_this._screenOrientationAngle),0,Math.cos(_this._screenOrientationAngle))};this._deviceOrientation=function(evt){_this._alpha=evt.alpha;_this._beta=evt.beta;_this._gamma=evt.gamma};this._constantTranform=new BABYLON.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));this._orientationChanged()}Object.defineProperty(FreeCameraDeviceOrientationInput.prototype,"camera",{get:function(){return this._camera},set:function(camera){this._camera=camera;if(this._camera!=null&&!this._camera.rotationQuaternion){this._camera.rotationQuaternion=new BABYLON.Quaternion}},enumerable:true,configurable:true});FreeCameraDeviceOrientationInput.prototype.attachControl=function(element,noPreventDefault){window.addEventListener("orientationchange",this._orientationChanged);window.addEventListener("deviceorientation",this._deviceOrientation);this._orientationChanged()};FreeCameraDeviceOrientationInput.prototype.detachControl=function(element){window.removeEventListener("orientationchange",this._orientationChanged);window.removeEventListener("deviceorientation",this._deviceOrientation)};FreeCameraDeviceOrientationInput.prototype.checkInputs=function(){if(!this._alpha)return;BABYLON.Quaternion.RotationYawPitchRollToRef(BABYLON.Tools.ToRadians(this._alpha),BABYLON.Tools.ToRadians(this._beta),-BABYLON.Tools.ToRadians(this._gamma),this.camera.rotationQuaternion);this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion);this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform);this._camera.rotationQuaternion.z*=-1;this._camera.rotationQuaternion.w*=-1};FreeCameraDeviceOrientationInput.prototype.getClassName=function(){return"FreeCameraDeviceOrientationInput"};FreeCameraDeviceOrientationInput.prototype.getSimpleName=function(){return"deviceOrientation"};return FreeCameraDeviceOrientationInput}();BABYLON.FreeCameraDeviceOrientationInput=FreeCameraDeviceOrientationInput;BABYLON.CameraInputTypes["FreeCameraDeviceOrientationInput"]=FreeCameraDeviceOrientationInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ArcRotateCameraVRDeviceOrientationInput=function(){function ArcRotateCameraVRDeviceOrientationInput(){this.alphaCorrection=1;this.betaCorrection=1;this.gammaCorrection=1;this._alpha=0;this._beta=0;this._gamma=0;this._dirty=false;this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}ArcRotateCameraVRDeviceOrientationInput.prototype.attachControl=function(element,noPreventDefault){this.camera.attachControl(element,noPreventDefault);window.addEventListener("deviceorientation",this._deviceOrientationHandler)};ArcRotateCameraVRDeviceOrientationInput.prototype._onOrientationEvent=function(evt){this._alpha=+evt.alpha|0;this._beta=+evt.beta|0;this._gamma=+evt.gamma|0;this._dirty=true};ArcRotateCameraVRDeviceOrientationInput.prototype.checkInputs=function(){if(this._dirty){this._dirty=false;if(this._gamma<0){this._gamma=180+this._gamma}this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2;this.camera.beta=this._gamma/180*Math.PI}};ArcRotateCameraVRDeviceOrientationInput.prototype.detachControl=function(element){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)};ArcRotateCameraVRDeviceOrientationInput.prototype.getClassName=function(){return"ArcRotateCameraVRDeviceOrientationInput"};ArcRotateCameraVRDeviceOrientationInput.prototype.getSimpleName=function(){return"VRDeviceOrientation"};return ArcRotateCameraVRDeviceOrientationInput}();BABYLON.ArcRotateCameraVRDeviceOrientationInput=ArcRotateCameraVRDeviceOrientationInput;BABYLON.CameraInputTypes["ArcRotateCameraVRDeviceOrientationInput"]=ArcRotateCameraVRDeviceOrientationInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VRCameraMetrics=function(){function VRCameraMetrics(){this.compensateDistortion=true}Object.defineProperty(VRCameraMetrics.prototype,"aspectRatio",{get:function(){return this.hResolution/(2*this.vResolution)},enumerable:true,configurable:true});Object.defineProperty(VRCameraMetrics.prototype,"aspectRatioFov",{get:function(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))},enumerable:true,configurable:true});Object.defineProperty(VRCameraMetrics.prototype,"leftHMatrix",{get:function(){var meters=this.hScreenSize/4-this.lensSeparationDistance/2;var h=4*meters/this.hScreenSize;return BABYLON.Matrix.Translation(h,0,0)},enumerable:true,configurable:true});Object.defineProperty(VRCameraMetrics.prototype,"rightHMatrix",{get:function(){var meters=this.hScreenSize/4-this.lensSeparationDistance/2;var h=4*meters/this.hScreenSize;return BABYLON.Matrix.Translation(-h,0,0)},enumerable:true,configurable:true});Object.defineProperty(VRCameraMetrics.prototype,"leftPreViewMatrix",{get:function(){return BABYLON.Matrix.Translation(.5*this.interpupillaryDistance,0,0)},enumerable:true,configurable:true});Object.defineProperty(VRCameraMetrics.prototype,"rightPreViewMatrix",{get:function(){return BABYLON.Matrix.Translation(-.5*this.interpupillaryDistance,0,0)},enumerable:true,configurable:true});VRCameraMetrics.GetDefault=function(){var result=new VRCameraMetrics;result.hResolution=1280;result.vResolution=800;result.hScreenSize=.149759993;result.vScreenSize=.0935999975;result.vScreenCenter=.0467999987;result.eyeToScreenDistance=.0410000011;result.lensSeparationDistance=.063500002;result.interpupillaryDistance=.064000003;result.distortionK=[1,.219999999,.239999995,0];result.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0];result.postProcessScaleFactor=1.714605507808412;result.lensCenterOffset=.151976421;return result};return VRCameraMetrics}();BABYLON.VRCameraMetrics=VRCameraMetrics})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var WebVRFreeCamera=function(_super){__extends(WebVRFreeCamera,_super);function WebVRFreeCamera(name,position,scene,webVROptions){if(webVROptions===void 0){webVROptions={}}var _this=_super.call(this,name,position,scene)||this;_this.webVROptions=webVROptions;_this._vrDevice=null;_this.rawPose=null;_this._specsVersion="1.1";_this._attached=false;_this._descendants=[];_this.devicePosition=BABYLON.Vector3.Zero();_this.deviceScaleFactor=1;_this.controllers=[];_this.onControllersAttachedObservable=new BABYLON.Observable;_this.onControllerMeshLoadedObservable=new BABYLON.Observable;_this.rigParenting=true;_this.minZ=.1;if(arguments.length===5){_this.webVROptions=arguments[4]}if(_this.webVROptions.trackPosition==undefined){_this.webVROptions.trackPosition=true}if(_this.webVROptions.controllerMeshes==undefined){_this.webVROptions.controllerMeshes=true}if(_this.webVROptions.defaultLightingOnControllers==undefined){_this.webVROptions.defaultLightingOnControllers=true}_this.rotationQuaternion=new BABYLON.Quaternion;_this.deviceRotationQuaternion=new BABYLON.Quaternion;if(_this.webVROptions&&_this.webVROptions.positionScale){_this.deviceScaleFactor=_this.webVROptions.positionScale}var engine=_this.getEngine();_this._onVREnabled=function(success){if(success){_this.initControllers()}};engine.onVRRequestPresentComplete.add(_this._onVREnabled);engine.initWebVR().add(function(event){if(!event.vrDisplay||_this._vrDevice===event.vrDisplay){return}_this._vrDevice=event.vrDisplay;_this.setCameraRigMode(BABYLON.Camera.RIG_MODE_WEBVR,{parentCamera:_this,vrDisplay:_this._vrDevice,frameData:_this._frameData,specs:_this._specsVersion});if(_this._attached){_this.getEngine().enableVR()}});if(typeof VRFrameData!=="undefined")_this._frameData=new VRFrameData;scene.onBeforeCameraRenderObservable.add(function(camera){if(camera.parent===_this&&_this.rigParenting){_this._descendants=_this.getDescendants(true,function(n){var isController=_this.controllers.some(function(controller){return controller._mesh===n});var isRigCamera=_this._rigCameras.indexOf(n)!==-1;return!isController&&!isRigCamera});_this._descendants.forEach(function(node){node.parent=camera})}});scene.onAfterCameraRenderObservable.add(function(camera){if(camera.parent===_this&&_this.rigParenting){_this._descendants.forEach(function(node){node.parent=_this})}});return _this}WebVRFreeCamera.prototype.dispose=function(){this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled);_super.prototype.dispose.call(this)};WebVRFreeCamera.prototype.getControllerByName=function(name){for(var _i=0,_a=this.controllers;_i<_a.length;_i++){var gp=_a[_i];if(gp.hand===name){return gp}}return undefined};Object.defineProperty(WebVRFreeCamera.prototype,"leftController",{get:function(){if(!this._leftController){this._leftController=this.getControllerByName("left")}return this._leftController},enumerable:true,configurable:true});Object.defineProperty(WebVRFreeCamera.prototype,"rightController",{get:function(){if(!this._rightController){this._rightController=this.getControllerByName("right")}return this._rightController},enumerable:true,configurable:true});WebVRFreeCamera.prototype.getForwardRay=function(length){if(length===void 0){length=100}if(this.leftCamera){return _super.prototype.getForwardRay.call(this,length,this.leftCamera.getWorldMatrix(),this.position.add(this.devicePosition))}else{return _super.prototype.getForwardRay.call(this,length)}};WebVRFreeCamera.prototype._checkInputs=function(){if(this._vrDevice&&this._vrDevice.isPresenting){this._vrDevice.getFrameData(this._frameData);this.updateFromDevice(this._frameData.pose)}_super.prototype._checkInputs.call(this)};WebVRFreeCamera.prototype.updateFromDevice=function(poseData){if(poseData&&poseData.orientation){this.rawPose=poseData;this.deviceRotationQuaternion.copyFromFloats(this.rawPose.orientation[0],this.rawPose.orientation[1],-this.rawPose.orientation[2],-this.rawPose.orientation[3]);if(this.getScene().useRightHandedSystem){this.deviceRotationQuaternion.z*=-1;this.deviceRotationQuaternion.w*=-1}if(this.webVROptions.trackPosition&&this.rawPose.position){this.devicePosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]);if(this.getScene().useRightHandedSystem){this.devicePosition.z*=-1}}}};WebVRFreeCamera.prototype.attachControl=function(element,noPreventDefault){_super.prototype.attachControl.call(this,element,noPreventDefault);this._attached=true;noPreventDefault=BABYLON.Camera.ForceAttachControlToAlwaysPreventDefault?false:noPreventDefault;if(this._vrDevice){this.getEngine().enableVR()}};WebVRFreeCamera.prototype.detachControl=function(element){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver);this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver);_super.prototype.detachControl.call(this,element);this._attached=false;this.getEngine().disableVR()};WebVRFreeCamera.prototype.getClassName=function(){return"WebVRFreeCamera"};WebVRFreeCamera.prototype.resetToCurrentRotation=function(){this._vrDevice.resetPose()};WebVRFreeCamera.prototype._updateRigCameras=function(){var camLeft=this._rigCameras[0];var camRight=this._rigCameras[1];camLeft.rotationQuaternion.copyFrom(this.deviceRotationQuaternion);camRight.rotationQuaternion.copyFrom(this.deviceRotationQuaternion);camLeft.position.copyFrom(this.devicePosition);camRight.position.copyFrom(this.devicePosition)};WebVRFreeCamera.prototype._getWebVRViewMatrix=function(){var _this=this;var viewArray=this._cameraRigParams["left"]?this._cameraRigParams["frameData"].leftViewMatrix:this._cameraRigParams["frameData"].rightViewMatrix;BABYLON.Matrix.FromArrayToRef(viewArray,0,this._webvrViewMatrix);if(!this.getScene().useRightHandedSystem){[2,6,8,9,14].forEach(function(num){_this._webvrViewMatrix.m[num]*=-1})}this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix);BABYLON.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint);this.position.addToRef(this._transformedReferencePoint,this._currentTarget);var parentCamera=this._cameraRigParams["parentCamera"];if(parentCamera.deviceScaleFactor!==1){this._webvrViewMatrix.invert();if(parentCamera.deviceScaleFactor){this._webvrViewMatrix.m[12]*=parentCamera.deviceScaleFactor;this._webvrViewMatrix.m[13]*=parentCamera.deviceScaleFactor;this._webvrViewMatrix.m[14]*=parentCamera.deviceScaleFactor}this._webvrViewMatrix.invert()}return this._webvrViewMatrix};WebVRFreeCamera.prototype._getWebVRProjectionMatrix=function(){var _this=this;var parentCamera=this.parent;parentCamera._vrDevice.depthNear=parentCamera.minZ;parentCamera._vrDevice.depthFar=parentCamera.maxZ;var projectionArray=this._cameraRigParams["left"]?this._cameraRigParams["frameData"].leftProjectionMatrix:this._cameraRigParams["frameData"].rightProjectionMatrix;BABYLON.Matrix.FromArrayToRef(projectionArray,0,this._projectionMatrix);if(!this.getScene().useRightHandedSystem){[8,9,10,11].forEach(function(num){_this._projectionMatrix.m[num]*=-1})}return this._projectionMatrix};WebVRFreeCamera.prototype.initControllers=function(){var _this=this;this.controllers=[];var manager=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=manager.onGamepadDisconnectedObservable.add(function(gamepad){if(gamepad.type===BABYLON.Gamepad.POSE_ENABLED){var webVrController=gamepad;if(webVrController.defaultModel){webVrController.defaultModel.setEnabled(false)}}});this._onGamepadConnectedObserver=manager.onGamepadConnectedObservable.add(function(gamepad){if(gamepad.type===BABYLON.Gamepad.POSE_ENABLED){var webVrController_1=gamepad;if(_this.webVROptions.controllerMeshes){if(webVrController_1.defaultModel){webVrController_1.defaultModel.setEnabled(true)}else{webVrController_1.initControllerMesh(_this.getScene(),function(loadedMesh){_this.onControllerMeshLoadedObservable.notifyObservers(webVrController_1);if(_this.webVROptions.defaultLightingOnControllers){if(!_this._lightOnControllers){_this._lightOnControllers=new BABYLON.HemisphericLight("vrControllersLight",new BABYLON.Vector3(0,1,0),_this.getScene())}var activateLightOnSubMeshes_1=function(mesh,light){var children=mesh.getChildren();if(children.length!==0){children.forEach(function(mesh){light.includedOnlyMeshes.push(mesh);activateLightOnSubMeshes_1(mesh,light)})}};_this._lightOnControllers.includedOnlyMeshes.push(loadedMesh);activateLightOnSubMeshes_1(loadedMesh,_this._lightOnControllers)}})}}webVrController_1.attachToPoseControlledCamera(_this);if(_this.controllers.indexOf(webVrController_1)===-1){_this.controllers.push(webVrController_1);if(_this.controllers.length>=2){var firstViveWandDetected=false;for(var i=0;i<_this.controllers.length;i++){if(_this.controllers[i].controllerType===BABYLON.PoseEnabledControllerType.VIVE){if(!firstViveWandDetected){firstViveWandDetected=true;_this.controllers[i].hand="left"}else{_this.controllers[i].hand="right"}}}_this.onControllersAttachedObservable.notifyObservers(_this.controllers)}}}})};return WebVRFreeCamera}(BABYLON.FreeCamera);BABYLON.WebVRFreeCamera=WebVRFreeCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var DeviceOrientationCamera=function(_super){__extends(DeviceOrientationCamera,_super);function DeviceOrientationCamera(name,position,scene){var _this=_super.call(this,name,position,scene)||this;_this._quaternionCache=new BABYLON.Quaternion;_this.inputs.addDeviceOrientation();return _this}DeviceOrientationCamera.prototype.getClassName=function(){return"DeviceOrientationCamera"};DeviceOrientationCamera.prototype._checkInputs=function(){_super.prototype._checkInputs.call(this);this._quaternionCache.copyFrom(this.rotationQuaternion);if(this._initialQuaternion){this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}};DeviceOrientationCamera.prototype.resetToCurrentRotation=function(axis){var _this=this;if(axis===void 0){axis=BABYLON.Axis.Y}if(!this.rotationQuaternion)return;if(!this._initialQuaternion){this._initialQuaternion=new BABYLON.Quaternion}this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion);["x","y","z"].forEach(function(axisName){if(!axis[axisName]){_this._initialQuaternion[axisName]=0}else{_this._initialQuaternion[axisName]*=-1}});this._initialQuaternion.normalize();this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)};return DeviceOrientationCamera}(BABYLON.FreeCamera);BABYLON.DeviceOrientationCamera=DeviceOrientationCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VRDeviceOrientationFreeCamera=function(_super){__extends(VRDeviceOrientationFreeCamera,_super);function VRDeviceOrientationFreeCamera(name,position,scene,compensateDistortion,vrCameraMetrics){if(compensateDistortion===void 0){compensateDistortion=true}if(vrCameraMetrics===void 0){vrCameraMetrics=BABYLON.VRCameraMetrics.GetDefault()}var _this=_super.call(this,name,position,scene)||this;vrCameraMetrics.compensateDistortion=compensateDistortion;_this.setCameraRigMode(BABYLON.Camera.RIG_MODE_VR,{vrCameraMetrics:vrCameraMetrics});return _this}VRDeviceOrientationFreeCamera.prototype.getClassName=function(){return"VRDeviceOrientationFreeCamera"};return VRDeviceOrientationFreeCamera}(BABYLON.DeviceOrientationCamera);BABYLON.VRDeviceOrientationFreeCamera=VRDeviceOrientationFreeCamera;var VRDeviceOrientationGamepadCamera=function(_super){__extends(VRDeviceOrientationGamepadCamera,_super);function VRDeviceOrientationGamepadCamera(name,position,scene,compensateDistortion,vrCameraMetrics){if(compensateDistortion===void 0){compensateDistortion=true}if(vrCameraMetrics===void 0){vrCameraMetrics=BABYLON.VRCameraMetrics.GetDefault()}var _this=_super.call(this,name,position,scene,compensateDistortion,vrCameraMetrics)||this;_this.inputs.addGamepad();return _this}VRDeviceOrientationGamepadCamera.prototype.getClassName=function(){return"VRDeviceOrientationGamepadCamera"};return VRDeviceOrientationGamepadCamera}(VRDeviceOrientationFreeCamera);BABYLON.VRDeviceOrientationGamepadCamera=VRDeviceOrientationGamepadCamera;var VRDeviceOrientationArcRotateCamera=function(_super){__extends(VRDeviceOrientationArcRotateCamera,_super);function VRDeviceOrientationArcRotateCamera(name,alpha,beta,radius,target,scene,compensateDistortion,vrCameraMetrics){if(compensateDistortion===void 0){compensateDistortion=true}if(vrCameraMetrics===void 0){vrCameraMetrics=BABYLON.VRCameraMetrics.GetDefault()}var _this=_super.call(this,name,alpha,beta,radius,target,scene)||this;vrCameraMetrics.compensateDistortion=compensateDistortion;_this.setCameraRigMode(BABYLON.Camera.RIG_MODE_VR,{vrCameraMetrics:vrCameraMetrics});_this.inputs.addVRDeviceOrientation();return _this}VRDeviceOrientationArcRotateCamera.prototype.getClassName=function(){return"VRDeviceOrientationArcRotateCamera"};return VRDeviceOrientationArcRotateCamera}(BABYLON.ArcRotateCamera);BABYLON.VRDeviceOrientationArcRotateCamera=VRDeviceOrientationArcRotateCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var AnaglyphFreeCamera=function(_super){__extends(AnaglyphFreeCamera,_super);function AnaglyphFreeCamera(name,position,interaxialDistance,scene){var _this=_super.call(this,name,position,scene)||this;_this.interaxialDistance=interaxialDistance;_this.setCameraRigMode(BABYLON.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:interaxialDistance});return _this}AnaglyphFreeCamera.prototype.getClassName=function(){return"AnaglyphFreeCamera"};return AnaglyphFreeCamera}(BABYLON.FreeCamera);BABYLON.AnaglyphFreeCamera=AnaglyphFreeCamera;var AnaglyphArcRotateCamera=function(_super){__extends(AnaglyphArcRotateCamera,_super);function AnaglyphArcRotateCamera(name,alpha,beta,radius,target,interaxialDistance,scene){var _this=_super.call(this,name,alpha,beta,radius,target,scene)||this;_this.interaxialDistance=interaxialDistance;_this.setCameraRigMode(BABYLON.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:interaxialDistance});return _this}AnaglyphArcRotateCamera.prototype.getClassName=function(){return"AnaglyphArcRotateCamera"};return AnaglyphArcRotateCamera}(BABYLON.ArcRotateCamera);BABYLON.AnaglyphArcRotateCamera=AnaglyphArcRotateCamera;var AnaglyphGamepadCamera=function(_super){__extends(AnaglyphGamepadCamera,_super);function AnaglyphGamepadCamera(name,position,interaxialDistance,scene){var _this=_super.call(this,name,position,scene)||this;_this.interaxialDistance=interaxialDistance;_this.setCameraRigMode(BABYLON.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:interaxialDistance});return _this}AnaglyphGamepadCamera.prototype.getClassName=function(){return"AnaglyphGamepadCamera"};return AnaglyphGamepadCamera}(BABYLON.GamepadCamera);BABYLON.AnaglyphGamepadCamera=AnaglyphGamepadCamera;var AnaglyphUniversalCamera=function(_super){__extends(AnaglyphUniversalCamera,_super);function AnaglyphUniversalCamera(name,position,interaxialDistance,scene){var _this=_super.call(this,name,position,scene)||this;_this.interaxialDistance=interaxialDistance;_this.setCameraRigMode(BABYLON.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:interaxialDistance});return _this}AnaglyphUniversalCamera.prototype.getClassName=function(){return"AnaglyphUniversalCamera"};return AnaglyphUniversalCamera}(BABYLON.UniversalCamera);BABYLON.AnaglyphUniversalCamera=AnaglyphUniversalCamera;var StereoscopicFreeCamera=function(_super){__extends(StereoscopicFreeCamera,_super);function StereoscopicFreeCamera(name,position,interaxialDistance,isStereoscopicSideBySide,scene){var _this=_super.call(this,name,position,scene)||this;_this.interaxialDistance=interaxialDistance;_this.isStereoscopicSideBySide=isStereoscopicSideBySide;_this.setCameraRigMode(isStereoscopicSideBySide?BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:BABYLON.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:interaxialDistance});return _this}StereoscopicFreeCamera.prototype.getClassName=function(){return"StereoscopicFreeCamera"};return StereoscopicFreeCamera}(BABYLON.FreeCamera);BABYLON.StereoscopicFreeCamera=StereoscopicFreeCamera;var StereoscopicArcRotateCamera=function(_super){__extends(StereoscopicArcRotateCamera,_super);function StereoscopicArcRotateCamera(name,alpha,beta,radius,target,interaxialDistance,isStereoscopicSideBySide,scene){var _this=_super.call(this,name,alpha,beta,radius,target,scene)||this;_this.interaxialDistance=interaxialDistance;_this.isStereoscopicSideBySide=isStereoscopicSideBySide;_this.setCameraRigMode(isStereoscopicSideBySide?BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:BABYLON.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:interaxialDistance});return _this}StereoscopicArcRotateCamera.prototype.getClassName=function(){return"StereoscopicArcRotateCamera"};return StereoscopicArcRotateCamera}(BABYLON.ArcRotateCamera);BABYLON.StereoscopicArcRotateCamera=StereoscopicArcRotateCamera;var StereoscopicGamepadCamera=function(_super){__extends(StereoscopicGamepadCamera,_super);function StereoscopicGamepadCamera(name,position,interaxialDistance,isStereoscopicSideBySide,scene){var _this=_super.call(this,name,position,scene)||this;_this.interaxialDistance=interaxialDistance;_this.isStereoscopicSideBySide=isStereoscopicSideBySide;_this.setCameraRigMode(isStereoscopicSideBySide?BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:BABYLON.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:interaxialDistance});return _this}StereoscopicGamepadCamera.prototype.getClassName=function(){return"StereoscopicGamepadCamera"};return StereoscopicGamepadCamera}(BABYLON.GamepadCamera);BABYLON.StereoscopicGamepadCamera=StereoscopicGamepadCamera;var StereoscopicUniversalCamera=function(_super){__extends(StereoscopicUniversalCamera,_super);function StereoscopicUniversalCamera(name,position,interaxialDistance,isStereoscopicSideBySide,scene){var _this=_super.call(this,name,position,scene)||this;_this.interaxialDistance=interaxialDistance;_this.isStereoscopicSideBySide=isStereoscopicSideBySide;_this.setCameraRigMode(isStereoscopicSideBySide?BABYLON.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:BABYLON.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:interaxialDistance});return _this}StereoscopicUniversalCamera.prototype.getClassName=function(){return"StereoscopicUniversalCamera"};return StereoscopicUniversalCamera}(BABYLON.UniversalCamera);BABYLON.StereoscopicUniversalCamera=StereoscopicUniversalCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VRExperienceHelper=function(){function VRExperienceHelper(scene,webVROptions){if(webVROptions===void 0){webVROptions={}}var _this=this;this.webVROptions=webVROptions;this._webVRsupported=false;this._webVRready=false;this._webVRrequesting=false;this._webVRpresenting=false;this._fullscreenVRpresenting=false;this._scene=scene;if(!this._scene.activeCamera||isNaN(this._scene.activeCamera.position.x)){this._deviceOrientationCamera=new BABYLON.DeviceOrientationCamera("deviceOrientationVRHelper",new BABYLON.Vector3(0,2,0),scene)}else{this._deviceOrientationCamera=new BABYLON.DeviceOrientationCamera("deviceOrientationVRHelper",this._scene.activeCamera.position,scene);if(scene.activeCamera.rotation){this._deviceOrientationCamera.rotation=scene.activeCamera.rotation.clone()}this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ;this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ}this._scene.activeCamera=this._deviceOrientationCamera;this._position=this._scene.activeCamera.position;this._canvas=scene.getEngine().getRenderingCanvas();this._scene.activeCamera.attachControl(this._canvas);this._btnVR=document.createElement("BUTTON");this._btnVR.className="babylonVRicon";this._btnVR.id="babylonVRiconbtn";this._btnVR.title="Click to switch to VR";var css=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url(data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";css+=".babylonVRicon.vrdisplaypresenting { display: none; }";var style=document.createElement("style");style.appendChild(document.createTextNode(css));document.getElementsByTagName("head")[0].appendChild(style);this._btnVR.style.top=this._canvas.offsetTop+this._canvas.offsetHeight-70+"px";this._btnVR.style.left=this._canvas.offsetLeft+this._canvas.offsetWidth-100+"px";this._btnVR.addEventListener("click",function(){_this.enterVR()});window.addEventListener("resize",function(){_this._btnVR.style.top=_this._canvas.offsetTop+_this._canvas.offsetHeight-70+"px";_this._btnVR.style.left=_this._canvas.offsetLeft+_this._canvas.offsetWidth-100+"px";if(_this._fullscreenVRpresenting&&_this._webVRready){_this.exitVR()}});document.addEventListener("fullscreenchange",function(){_this._onFullscreenChange()},false);document.addEventListener("mozfullscreenchange",function(){_this._onFullscreenChange()},false);document.addEventListener("webkitfullscreenchange",function(){_this._onFullscreenChange()},false);document.addEventListener("msfullscreenchange",function(){_this._onFullscreenChange()},false);document.body.appendChild(this._btnVR);this._onKeyDown=function(event){if(event.keyCode===27&&_this.isInVRMode()){_this.exitVR()}};document.addEventListener("keydown",this._onKeyDown);this._scene.onPrePointerObservable.add(function(pointerInfo,eventState){if(_this.isInVRMode()){_this.exitVR();if(_this._fullscreenVRpresenting){_this._scene.getEngine().switchFullscreen(true)}}},BABYLON.PointerEventTypes.POINTERDOUBLETAP,false);this._onVRDisplayChanged=function(eventArgs){return _this.onVRDisplayChanged(eventArgs)};this._onVrDisplayPresentChange=function(){return _this.onVrDisplayPresentChange()};this._onVRRequestPresentStart=function(){_this._webVRrequesting=true;_this.updateButtonVisibility()};this._onVRRequestPresentComplete=function(success){_this._webVRrequesting=false;_this.updateButtonVisibility()};scene.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChanged);scene.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart);scene.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete);window.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange);this._vrDeviceOrientationCamera=new BABYLON.VRDeviceOrientationFreeCamera("VRDeviceOrientationVRHelper",this._position,this._scene);this._webVRCamera=new BABYLON.WebVRFreeCamera("WebVRHelper",this._position,this._scene,webVROptions);this._webVRCamera.onControllerMeshLoadedObservable.add(function(webVRController){return _this._onDefaultMeshLoaded(webVRController)});this.updateButtonVisibility()}VRExperienceHelper.prototype._onDefaultMeshLoaded=function(webVRController){if(this.onControllerMeshLoaded){this.onControllerMeshLoaded(webVRController)}};VRExperienceHelper.prototype._onFullscreenChange=function(){if(document.fullscreen!==undefined){this._fullscreenVRpresenting=document.fullscreen}else if(document.mozFullScreen!==undefined){this._fullscreenVRpresenting=document.mozFullScreen}else if(document.webkitIsFullScreen!==undefined){this._fullscreenVRpresenting=document.webkitIsFullScreen}else if(document.msIsFullScreen!==undefined){this._fullscreenVRpresenting=document.msIsFullScreen}if(!this._fullscreenVRpresenting){this.exitVR();this._btnVR.style.top=this._canvas.offsetTop+this._canvas.offsetHeight-70+"px";this._btnVR.style.left=this._canvas.offsetLeft+this._canvas.offsetWidth-100+"px"}};VRExperienceHelper.prototype.isInVRMode=function(){return this._webVRpresenting||this._fullscreenVRpresenting};VRExperienceHelper.prototype.onVrDisplayPresentChange=function(){var vrDisplay=this._scene.getEngine().getVRDevice();if(vrDisplay){var wasPresenting=this._webVRpresenting;this._webVRpresenting=vrDisplay.isPresenting;if(wasPresenting&&!this._webVRpresenting)this.exitVR()}else{BABYLON.Tools.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?")}this.updateButtonVisibility()};VRExperienceHelper.prototype.onVRDisplayChanged=function(eventArgs){this._webVRsupported=eventArgs.vrSupported;this._webVRready=!!eventArgs.vrDisplay;this._webVRpresenting=eventArgs.vrDisplay&&eventArgs.vrDisplay.isPresenting;this.updateButtonVisibility()};VRExperienceHelper.prototype.updateButtonVisibility=function(){if(!this._btnVR){return}this._btnVR.className="babylonVRicon";if(this.isInVRMode()){this._btnVR.className+=" vrdisplaypresenting"}else{if(this._webVRready)this._btnVR.className+=" vrdisplayready";if(this._webVRsupported)this._btnVR.className+=" vrdisplaysupported";if(this._webVRrequesting)this._btnVR.className+=" vrdisplayrequesting"}};VRExperienceHelper.prototype.enterVR=function(){if(this.onEnteringVR){this.onEnteringVR()}if(this._webVRrequesting)return;if(this._webVRready){if(!this._webVRpresenting){this._webVRCamera.position=this._position;this._scene.activeCamera=this._webVRCamera}}else{this._vrDeviceOrientationCamera.position=this._position;this._scene.activeCamera=this._vrDeviceOrientationCamera;this._scene.getEngine().switchFullscreen(true);this.updateButtonVisibility()}this._scene.activeCamera.attachControl(this._canvas)};VRExperienceHelper.prototype.exitVR=function(){if(this.onExitingVR){this.onExitingVR()}if(this._webVRpresenting){this._scene.getEngine().disableVR()}if(this._scene.activeCamera){this._position=this._scene.activeCamera.position}this._deviceOrientationCamera.position=this._position;this._scene.activeCamera=this._deviceOrientationCamera;this._scene.activeCamera.attachControl(this._canvas);this.updateButtonVisibility()};Object.defineProperty(VRExperienceHelper.prototype,"position",{get:function(){return this._position},set:function(value){this._position=value;this._scene.activeCamera.position=value},enumerable:true,configurable:true});VRExperienceHelper.prototype.dispose=function(){if(this.isInVRMode()){this.exitVR()}this._deviceOrientationCamera.dispose();if(this._webVRCamera){this._webVRCamera.dispose()}if(this._vrDeviceOrientationCamera){this._vrDeviceOrientationCamera.dispose()}document.body.removeChild(this._btnVR);document.removeEventListener("keydown",this._onKeyDown);window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange)};VRExperienceHelper.prototype.getClassName=function(){return"VRExperienceHelper"};return VRExperienceHelper}();BABYLON.VRExperienceHelper=VRExperienceHelper})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var JoystickAxis;(function(JoystickAxis){JoystickAxis[JoystickAxis["X"]=0]="X";JoystickAxis[JoystickAxis["Y"]=1]="Y";JoystickAxis[JoystickAxis["Z"]=2]="Z"})(JoystickAxis=BABYLON.JoystickAxis||(BABYLON.JoystickAxis={}));var VirtualJoystick=function(){function VirtualJoystick(leftJoystick){var _this=this;if(leftJoystick){this._leftJoystick=true}else{this._leftJoystick=false}this._joystickIndex=VirtualJoystick._globalJoystickIndex;VirtualJoystick._globalJoystickIndex++;this._axisTargetedByLeftAndRight=JoystickAxis.X;this._axisTargetedByUpAndDown=JoystickAxis.Y;this.reverseLeftRight=false;this.reverseUpDown=false;this._touches=new BABYLON.StringDictionary;this.deltaPosition=BABYLON.Vector3.Zero();this._joystickSensibility=25;this._inversedSensibility=1/(this._joystickSensibility/1e3);this._rotationSpeed=25;this._inverseRotationSpeed=1/(this._rotationSpeed/1e3);this._rotateOnAxisRelativeToMesh=false;this._onResize=function(evt){VirtualJoystick.vjCanvasWidth=window.innerWidth;VirtualJoystick.vjCanvasHeight=window.innerHeight;VirtualJoystick.vjCanvas.width=VirtualJoystick.vjCanvasWidth;VirtualJoystick.vjCanvas.height=VirtualJoystick.vjCanvasHeight;VirtualJoystick.halfWidth=VirtualJoystick.vjCanvasWidth/2;VirtualJoystick.halfHeight=VirtualJoystick.vjCanvasHeight/2};if(!VirtualJoystick.vjCanvas){window.addEventListener("resize",this._onResize,false);VirtualJoystick.vjCanvas=document.createElement("canvas");VirtualJoystick.vjCanvasWidth=window.innerWidth;VirtualJoystick.vjCanvasHeight=window.innerHeight;VirtualJoystick.vjCanvas.width=window.innerWidth;VirtualJoystick.vjCanvas.height=window.innerHeight;VirtualJoystick.vjCanvas.style.width="100%";VirtualJoystick.vjCanvas.style.height="100%";VirtualJoystick.vjCanvas.style.position="absolute";VirtualJoystick.vjCanvas.style.backgroundColor="transparent";VirtualJoystick.vjCanvas.style.top="0px";VirtualJoystick.vjCanvas.style.left="0px";VirtualJoystick.vjCanvas.style.zIndex="5";VirtualJoystick.vjCanvas.style.msTouchAction="none";VirtualJoystick.vjCanvas.setAttribute("touch-action","none");VirtualJoystick.vjCanvasContext=VirtualJoystick.vjCanvas.getContext("2d");VirtualJoystick.vjCanvasContext.strokeStyle="#ffffff";VirtualJoystick.vjCanvasContext.lineWidth=2;document.body.appendChild(VirtualJoystick.vjCanvas)}VirtualJoystick.halfWidth=VirtualJoystick.vjCanvas.width/2;VirtualJoystick.halfHeight=VirtualJoystick.vjCanvas.height/2;this.pressed=false;this._joystickColor="cyan";this._joystickPointerID=-1;this._joystickPointerPos=new BABYLON.Vector2(0,0);this._joystickPreviousPointerPos=new BABYLON.Vector2(0,0);this._joystickPointerStartPos=new BABYLON.Vector2(0,0);this._deltaJoystickVector=new BABYLON.Vector2(0,0);this._onPointerDownHandlerRef=function(evt){_this._onPointerDown(evt)};this._onPointerMoveHandlerRef=function(evt){_this._onPointerMove(evt)};this._onPointerOutHandlerRef=function(evt){_this._onPointerUp(evt)};this._onPointerUpHandlerRef=function(evt){_this._onPointerUp(evt)};VirtualJoystick.vjCanvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,false);VirtualJoystick.vjCanvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,false);VirtualJoystick.vjCanvas.addEventListener("pointerup",this._onPointerUpHandlerRef,false);VirtualJoystick.vjCanvas.addEventListener("pointerout",this._onPointerUpHandlerRef,false);VirtualJoystick.vjCanvas.addEventListener("contextmenu",function(evt){evt.preventDefault()},false);requestAnimationFrame(function(){_this._drawVirtualJoystick()})}VirtualJoystick.prototype.setJoystickSensibility=function(newJoystickSensibility){this._joystickSensibility=newJoystickSensibility;this._inversedSensibility=1/(this._joystickSensibility/1e3)};VirtualJoystick.prototype._onPointerDown=function(e){var positionOnScreenCondition;e.preventDefault();if(this._leftJoystick===true){positionOnScreenCondition=e.clientX<VirtualJoystick.halfWidth}else{positionOnScreenCondition=e.clientX>VirtualJoystick.halfWidth}if(positionOnScreenCondition&&this._joystickPointerID<0){this._joystickPointerID=e.pointerId;this._joystickPointerStartPos.x=e.clientX;this._joystickPointerStartPos.y=e.clientY;this._joystickPointerPos=this._joystickPointerStartPos.clone();this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone();this._deltaJoystickVector.x=0;this._deltaJoystickVector.y=0;this.pressed=true;this._touches.add(e.pointerId.toString(),e)}else{if(VirtualJoystick._globalJoystickIndex<2&&this._action){this._action();this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY})}}};VirtualJoystick.prototype._onPointerMove=function(e){if(this._joystickPointerID==e.pointerId){this._joystickPointerPos.x=e.clientX;this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone();this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos);var directionLeftRight=this.reverseLeftRight?-1:1;var deltaJoystickX=directionLeftRight*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case JoystickAxis.X:this.deltaPosition.x=Math.min(1,Math.max(-1,deltaJoystickX));break;case JoystickAxis.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,deltaJoystickX));break;case JoystickAxis.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,deltaJoystickX));break}var directionUpDown=this.reverseUpDown?1:-1;var deltaJoystickY=directionUpDown*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case JoystickAxis.X:this.deltaPosition.x=Math.min(1,Math.max(-1,deltaJoystickY));break;case JoystickAxis.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,deltaJoystickY));break;case JoystickAxis.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,deltaJoystickY));break}}else{var data=this._touches.get(e.pointerId.toString());if(data){data.x=e.clientX;data.y=e.clientY}}};VirtualJoystick.prototype._onPointerUp=function(e){if(this._joystickPointerID==e.pointerId){VirtualJoystick.vjCanvasContext.clearRect(this._joystickPointerStartPos.x-64,this._joystickPointerStartPos.y-64,128,128);VirtualJoystick.vjCanvasContext.clearRect(this._joystickPreviousPointerPos.x-42,this._joystickPreviousPointerPos.y-42,84,84);this._joystickPointerID=-1;this.pressed=false}else{var touch=this._touches.get(e.pointerId.toString());if(touch){VirtualJoystick.vjCanvasContext.clearRect(touch.prevX-44,touch.prevY-44,88,88)}}this._deltaJoystickVector.x=0;this._deltaJoystickVector.y=0;this._touches.remove(e.pointerId.toString())};VirtualJoystick.prototype.setJoystickColor=function(newColor){this._joystickColor=newColor};VirtualJoystick.prototype.setActionOnTouch=function(action){this._action=action};VirtualJoystick.prototype.setAxisForLeftRight=function(axis){switch(axis){case JoystickAxis.X:case JoystickAxis.Y:case JoystickAxis.Z:this._axisTargetedByLeftAndRight=axis;break;default:this._axisTargetedByLeftAndRight=JoystickAxis.X;break}};VirtualJoystick.prototype.setAxisForUpDown=function(axis){switch(axis){case JoystickAxis.X:case JoystickAxis.Y:case JoystickAxis.Z:this._axisTargetedByUpAndDown=axis;break;default:this._axisTargetedByUpAndDown=JoystickAxis.Y;break}};VirtualJoystick.prototype._drawVirtualJoystick=function(){var _this=this;if(this.pressed){this._touches.forEach(function(key,touch){if(touch.pointerId===_this._joystickPointerID){VirtualJoystick.vjCanvasContext.clearRect(_this._joystickPointerStartPos.x-64,_this._joystickPointerStartPos.y-64,128,128);VirtualJoystick.vjCanvasContext.clearRect(_this._joystickPreviousPointerPos.x-42,_this._joystickPreviousPointerPos.y-42,84,84);VirtualJoystick.vjCanvasContext.beginPath();VirtualJoystick.vjCanvasContext.lineWidth=6;VirtualJoystick.vjCanvasContext.strokeStyle=_this._joystickColor;VirtualJoystick.vjCanvasContext.arc(_this._joystickPointerStartPos.x,_this._joystickPointerStartPos.y,40,0,Math.PI*2,true);VirtualJoystick.vjCanvasContext.stroke();VirtualJoystick.vjCanvasContext.closePath();VirtualJoystick.vjCanvasContext.beginPath();VirtualJoystick.vjCanvasContext.strokeStyle=_this._joystickColor;VirtualJoystick.vjCanvasContext.lineWidth=2;VirtualJoystick.vjCanvasContext.arc(_this._joystickPointerStartPos.x,_this._joystickPointerStartPos.y,60,0,Math.PI*2,true);VirtualJoystick.vjCanvasContext.stroke();VirtualJoystick.vjCanvasContext.closePath();VirtualJoystick.vjCanvasContext.beginPath();VirtualJoystick.vjCanvasContext.strokeStyle=_this._joystickColor;VirtualJoystick.vjCanvasContext.arc(_this._joystickPointerPos.x,_this._joystickPointerPos.y,40,0,Math.PI*2,true);VirtualJoystick.vjCanvasContext.stroke();VirtualJoystick.vjCanvasContext.closePath();_this._joystickPreviousPointerPos=_this._joystickPointerPos.clone()}else{VirtualJoystick.vjCanvasContext.clearRect(touch.prevX-44,touch.prevY-44,88,88);VirtualJoystick.vjCanvasContext.beginPath();VirtualJoystick.vjCanvasContext.fillStyle="white";VirtualJoystick.vjCanvasContext.beginPath();VirtualJoystick.vjCanvasContext.strokeStyle="red";VirtualJoystick.vjCanvasContext.lineWidth=6;VirtualJoystick.vjCanvasContext.arc(touch.x,touch.y,40,0,Math.PI*2,true);VirtualJoystick.vjCanvasContext.stroke();VirtualJoystick.vjCanvasContext.closePath();touch.prevX=touch.x;touch.prevY=touch.y}})}requestAnimationFrame(function(){_this._drawVirtualJoystick()})};VirtualJoystick.prototype.releaseCanvas=function(){if(VirtualJoystick.vjCanvas){VirtualJoystick.vjCanvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef);VirtualJoystick.vjCanvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef);VirtualJoystick.vjCanvas.removeEventListener("pointerup",this._onPointerUpHandlerRef);VirtualJoystick.vjCanvas.removeEventListener("pointerout",this._onPointerUpHandlerRef);window.removeEventListener("resize",this._onResize);document.body.removeChild(VirtualJoystick.vjCanvas);VirtualJoystick.vjCanvas=null}};VirtualJoystick._globalJoystickIndex=0;return VirtualJoystick}();BABYLON.VirtualJoystick=VirtualJoystick})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var VirtualJoysticksCamera=function(_super){__extends(VirtualJoysticksCamera,_super);function VirtualJoysticksCamera(name,position,scene){var _this=_super.call(this,name,position,scene)||this;_this.inputs.addVirtualJoystick();return _this}VirtualJoysticksCamera.prototype.getClassName=function(){return"VirtualJoysticksCamera"};return VirtualJoysticksCamera}(BABYLON.FreeCamera);BABYLON.VirtualJoysticksCamera=VirtualJoysticksCamera})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FreeCameraVirtualJoystickInput=function(){function FreeCameraVirtualJoystickInput(){}FreeCameraVirtualJoystickInput.prototype.getLeftJoystick=function(){return this._leftjoystick};FreeCameraVirtualJoystickInput.prototype.getRightJoystick=function(){return this._rightjoystick};FreeCameraVirtualJoystickInput.prototype.checkInputs=function(){if(this._leftjoystick){var camera=this.camera;var speed=camera._computeLocalCameraSpeed()*50;var cameraTransform=BABYLON.Matrix.RotationYawPitchRoll(camera.rotation.y,camera.rotation.x,0);var deltaTransform=BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(this._leftjoystick.deltaPosition.x*speed,this._leftjoystick.deltaPosition.y*speed,this._leftjoystick.deltaPosition.z*speed),cameraTransform);camera.cameraDirection=camera.cameraDirection.add(deltaTransform);camera.cameraRotation=camera.cameraRotation.addVector3(this._rightjoystick.deltaPosition);if(!this._leftjoystick.pressed){this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)}if(!this._rightjoystick.pressed){this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9)}}};FreeCameraVirtualJoystickInput.prototype.attachControl=function(element,noPreventDefault){this._leftjoystick=new BABYLON.VirtualJoystick(true);this._leftjoystick.setAxisForUpDown(BABYLON.JoystickAxis.Z);this._leftjoystick.setAxisForLeftRight(BABYLON.JoystickAxis.X);this._leftjoystick.setJoystickSensibility(.15);this._rightjoystick=new BABYLON.VirtualJoystick(false);this._rightjoystick.setAxisForUpDown(BABYLON.JoystickAxis.X);this._rightjoystick.setAxisForLeftRight(BABYLON.JoystickAxis.Y);this._rightjoystick.reverseUpDown=true;this._rightjoystick.setJoystickSensibility(.05);this._rightjoystick.setJoystickColor("yellow")};FreeCameraVirtualJoystickInput.prototype.detachControl=function(element){this._leftjoystick.releaseCanvas();this._rightjoystick.releaseCanvas()};FreeCameraVirtualJoystickInput.prototype.getClassName=function(){return"FreeCameraVirtualJoystickInput"};FreeCameraVirtualJoystickInput.prototype.getSimpleName=function(){return"virtualJoystick"};return FreeCameraVirtualJoystickInput}();BABYLON.FreeCameraVirtualJoystickInput=FreeCameraVirtualJoystickInput;BABYLON.CameraInputTypes["FreeCameraVirtualJoystickInput"]=FreeCameraVirtualJoystickInput})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SimplificationSettings=function(){function SimplificationSettings(quality,distance,optimizeMesh){this.quality=quality;this.distance=distance;this.optimizeMesh=optimizeMesh}return SimplificationSettings}();BABYLON.SimplificationSettings=SimplificationSettings;var SimplificationQueue=function(){function SimplificationQueue(){this.running=false;this._simplificationArray=[]}SimplificationQueue.prototype.addTask=function(task){this._simplificationArray.push(task)};SimplificationQueue.prototype.executeNext=function(){var task=this._simplificationArray.pop();if(task){this.running=true;this.runSimplification(task)}else{this.running=false}};SimplificationQueue.prototype.runSimplification=function(task){var _this=this;if(task.parallelProcessing){task.settings.forEach(function(setting){var simplifier=_this.getSimplifier(task);simplifier.simplify(setting,function(newMesh){task.mesh.addLODLevel(setting.distance,newMesh);newMesh.isVisible=true;if(setting.quality===task.settings[task.settings.length-1].quality&&task.successCallback){task.successCallback()}_this.executeNext()})})}else{var simplifier=this.getSimplifier(task);var runDecimation=function(setting,callback){simplifier.simplify(setting,function(newMesh){task.mesh.addLODLevel(setting.distance,newMesh);newMesh.isVisible=true;callback()})};BABYLON.AsyncLoop.Run(task.settings.length,function(loop){runDecimation(task.settings[loop.index],function(){loop.executeNext()})},function(){if(task.successCallback){task.successCallback()}_this.executeNext()})}};SimplificationQueue.prototype.getSimplifier=function(task){switch(task.simplificationType){case SimplificationType.QUADRATIC:default:return new QuadraticErrorSimplification(task.mesh)}};return SimplificationQueue}();BABYLON.SimplificationQueue=SimplificationQueue;var SimplificationType;(function(SimplificationType){SimplificationType[SimplificationType["QUADRATIC"]=0]="QUADRATIC"})(SimplificationType=BABYLON.SimplificationType||(BABYLON.SimplificationType={}));var DecimationTriangle=function(){function DecimationTriangle(vertices){this.vertices=vertices;this.error=new Array(4);this.deleted=false;this.isDirty=false;this.deletePending=false;this.borderFactor=0}return DecimationTriangle}();BABYLON.DecimationTriangle=DecimationTriangle;var DecimationVertex=function(){function DecimationVertex(position,id){this.position=position;this.id=id;this.isBorder=true;this.q=new QuadraticMatrix;this.triangleCount=0;this.triangleStart=0;this.originalOffsets=[]}DecimationVertex.prototype.updatePosition=function(newPosition){this.position.copyFrom(newPosition)};return DecimationVertex}();BABYLON.DecimationVertex=DecimationVertex;var QuadraticMatrix=function(){function QuadraticMatrix(data){this.data=new Array(10);for(var i=0;i<10;++i){if(data&&data[i]){this.data[i]=data[i]}else{this.data[i]=0}}}QuadraticMatrix.prototype.det=function(a11,a12,a13,a21,a22,a23,a31,a32,a33){var det=this.data[a11]*this.data[a22]*this.data[a33]+this.data[a13]*this.data[a21]*this.data[a32]+this.data[a12]*this.data[a23]*this.data[a31]-this.data[a13]*this.data[a22]*this.data[a31]-this.data[a11]*this.data[a23]*this.data[a32]-this.data[a12]*this.data[a21]*this.data[a33];return det};QuadraticMatrix.prototype.addInPlace=function(matrix){for(var i=0;i<10;++i){this.data[i]+=matrix.data[i]}};QuadraticMatrix.prototype.addArrayInPlace=function(data){for(var i=0;i<10;++i){this.data[i]+=data[i]}};QuadraticMatrix.prototype.add=function(matrix){var m=new QuadraticMatrix;for(var i=0;i<10;++i){m.data[i]=this.data[i]+matrix.data[i]}return m};QuadraticMatrix.FromData=function(a,b,c,d){return new QuadraticMatrix(QuadraticMatrix.DataFromNumbers(a,b,c,d))};QuadraticMatrix.DataFromNumbers=function(a,b,c,d){return[a*a,a*b,a*c,a*d,b*b,b*c,b*d,c*c,c*d,d*d]};return QuadraticMatrix}();BABYLON.QuadraticMatrix=QuadraticMatrix;var Reference=function(){function Reference(vertexId,triangleId){this.vertexId=vertexId;this.triangleId=triangleId}return Reference}();BABYLON.Reference=Reference;var QuadraticErrorSimplification=function(){function QuadraticErrorSimplification(_mesh){this._mesh=_mesh;this.initialized=false;this.syncIterations=5e3;this.aggressiveness=7;this.decimationIterations=100;this.boundingBoxEpsilon=BABYLON.Epsilon}QuadraticErrorSimplification.prototype.simplify=function(settings,successCallback){var _this=this;this.initDecimatedMesh();BABYLON.AsyncLoop.Run(this._mesh.subMeshes.length,function(loop){_this.initWithMesh(loop.index,function(){_this.runDecimation(settings,loop.index,function(){loop.executeNext()})},settings.optimizeMesh)},function(){setTimeout(function(){successCallback(_this._reconstructedMesh)},0)})};QuadraticErrorSimplification.prototype.runDecimation=function(settings,submeshIndex,successCallback){var _this=this;var targetCount=~~(this.triangles.length*settings.quality);var deletedTriangles=0;var triangleCount=this.triangles.length;var iterationFunction=function(iteration,callback){setTimeout(function(){if(iteration%5===0){_this.updateMesh(iteration===0)}for(var i=0;i<_this.triangles.length;++i){_this.triangles[i].isDirty=false}var threshold=1e-9*Math.pow(iteration+3,_this.aggressiveness);var trianglesIterator=function(i){var tIdx=~~((_this.triangles.length/2+i)%_this.triangles.length);var t=_this.triangles[tIdx];if(!t)return;if(t.error[3]>threshold||t.deleted||t.isDirty){return}for(var j=0;j<3;++j){if(t.error[j]<threshold){var deleted0=[];var deleted1=[];var v0=t.vertices[j];var v1=t.vertices[(j+1)%3];if(v0.isBorder||v1.isBorder)continue;var p=BABYLON.Vector3.Zero();var n=BABYLON.Vector3.Zero();var uv=BABYLON.Vector2.Zero();var color=new BABYLON.Color4(0,0,0,1);_this.calculateError(v0,v1,p,n,uv,color);var delTr=new Array;if(_this.isFlipped(v0,v1,p,deleted0,t.borderFactor,delTr))continue;if(_this.isFlipped(v1,v0,p,deleted1,t.borderFactor,delTr))continue;if(deleted0.indexOf(true)<0||deleted1.indexOf(true)<0)continue;var uniqueArray=new Array;delTr.forEach(function(deletedT){if(uniqueArray.indexOf(deletedT)===-1){deletedT.deletePending=true;uniqueArray.push(deletedT)}});if(uniqueArray.length%2!==0){continue}v0.q=v1.q.add(v0.q);v0.updatePosition(p);var tStart=_this.references.length;deletedTriangles=_this.updateTriangles(v0,v0,deleted0,deletedTriangles);deletedTriangles=_this.updateTriangles(v0,v1,deleted1,deletedTriangles);var tCount=_this.references.length-tStart;if(tCount<=v0.triangleCount){if(tCount){for(var c=0;c<tCount;c++){_this.references[v0.triangleStart+c]=_this.references[tStart+c]}}}else{v0.triangleStart=tStart}v0.triangleCount=tCount;break}}};BABYLON.AsyncLoop.SyncAsyncForLoop(_this.triangles.length,_this.syncIterations,trianglesIterator,callback,function(){return triangleCount-deletedTriangles<=targetCount})},0)};BABYLON.AsyncLoop.Run(this.decimationIterations,function(loop){if(triangleCount-deletedTriangles<=targetCount)loop.breakLoop();else{iterationFunction(loop.index,function(){loop.executeNext()})}},function(){setTimeout(function(){_this.reconstructMesh(submeshIndex);successCallback()},0)})};QuadraticErrorSimplification.prototype.initWithMesh=function(submeshIndex,callback,optimizeMesh){var _this=this;this.vertices=[];this.triangles=[];var positionData=this._mesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);var indices=this._mesh.getIndices();var submesh=this._mesh.subMeshes[submeshIndex];var findInVertices=function(positionToSearch){if(optimizeMesh){for(var ii=0;ii<_this.vertices.length;++ii){if(_this.vertices[ii].position.equals(positionToSearch)){return _this.vertices[ii]}}}return null};var vertexReferences=[];var vertexInit=function(i){var offset=i+submesh.verticesStart;var position=BABYLON.Vector3.FromArray(positionData,offset*3);var vertex=findInVertices(position)||new DecimationVertex(position,_this.vertices.length);vertex.originalOffsets.push(offset);if(vertex.id===_this.vertices.length){_this.vertices.push(vertex)}vertexReferences.push(vertex.id)};var totalVertices=submesh.verticesCount;BABYLON.AsyncLoop.SyncAsyncForLoop(totalVertices,this.syncIterations/4>>0,vertexInit,function(){var indicesInit=function(i){var offset=submesh.indexStart/3+i;var pos=offset*3;var i0=indices[pos+0];var i1=indices[pos+1];var i2=indices[pos+2];var v0=_this.vertices[vertexReferences[i0-submesh.verticesStart]];var v1=_this.vertices[vertexReferences[i1-submesh.verticesStart]];var v2=_this.vertices[vertexReferences[i2-submesh.verticesStart]];var triangle=new DecimationTriangle([v0,v1,v2]);triangle.originalOffset=pos;_this.triangles.push(triangle)};BABYLON.AsyncLoop.SyncAsyncForLoop(submesh.indexCount/3,_this.syncIterations,indicesInit,function(){_this.init(callback)})})};QuadraticErrorSimplification.prototype.init=function(callback){var _this=this;var triangleInit1=function(i){var t=_this.triangles[i];t.normal=BABYLON.Vector3.Cross(t.vertices[1].position.subtract(t.vertices[0].position),t.vertices[2].position.subtract(t.vertices[0].position)).normalize();for(var j=0;j<3;j++){t.vertices[j].q.addArrayInPlace(QuadraticMatrix.DataFromNumbers(t.normal.x,t.normal.y,t.normal.z,-BABYLON.Vector3.Dot(t.normal,t.vertices[0].position)))}};BABYLON.AsyncLoop.SyncAsyncForLoop(this.triangles.length,this.syncIterations,triangleInit1,function(){var triangleInit2=function(i){var t=_this.triangles[i];for(var j=0;j<3;++j){t.error[j]=_this.calculateError(t.vertices[j],t.vertices[(j+1)%3])}t.error[3]=Math.min(t.error[0],t.error[1],t.error[2])};BABYLON.AsyncLoop.SyncAsyncForLoop(_this.triangles.length,_this.syncIterations,triangleInit2,function(){_this.initialized=true;callback()})})};QuadraticErrorSimplification.prototype.reconstructMesh=function(submeshIndex){var newTriangles=[];var i;for(i=0;i<this.vertices.length;++i){this.vertices[i].triangleCount=0}var t;var j;for(i=0;i<this.triangles.length;++i){if(!this.triangles[i].deleted){t=this.triangles[i];for(j=0;j<3;++j){t.vertices[j].triangleCount=1}newTriangles.push(t)}}var newPositionData=this._reconstructedMesh.getVerticesData(BABYLON.VertexBuffer.PositionKind)||[];var newNormalData=this._reconstructedMesh.getVerticesData(BABYLON.VertexBuffer.NormalKind)||[];var newUVsData=this._reconstructedMesh.getVerticesData(BABYLON.VertexBuffer.UVKind)||[];var newColorsData=this._reconstructedMesh.getVerticesData(BABYLON.VertexBuffer.ColorKind)||[];var normalData=this._mesh.getVerticesData(BABYLON.VertexBuffer.NormalKind);var uvs=this._mesh.getVerticesData(BABYLON.VertexBuffer.UVKind);var colorsData=this._mesh.getVerticesData(BABYLON.VertexBuffer.ColorKind);var vertexCount=0;for(i=0;i<this.vertices.length;++i){var vertex=this.vertices[i];vertex.id=vertexCount;if(vertex.triangleCount){vertex.originalOffsets.forEach(function(originalOffset){newPositionData.push(vertex.position.x);newPositionData.push(vertex.position.y);newPositionData.push(vertex.position.z);newNormalData.push(normalData[originalOffset*3]);newNormalData.push(normalData[originalOffset*3+1]);newNormalData.push(normalData[originalOffset*3+2]);if(uvs&&uvs.length){newUVsData.push(uvs[originalOffset*2]);newUVsData.push(uvs[originalOffset*2+1])}else if(colorsData&&colorsData.length){newColorsData.push(colorsData[originalOffset*4]);newColorsData.push(colorsData[originalOffset*4+1]);newColorsData.push(colorsData[originalOffset*4+2]);newColorsData.push(colorsData[originalOffset*4+3])}++vertexCount})}}var startingIndex=this._reconstructedMesh.getTotalIndices();var startingVertex=this._reconstructedMesh.getTotalVertices();var submeshesArray=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];var newIndicesArray=this._reconstructedMesh.getIndices();var originalIndices=this._mesh.getIndices();for(i=0;i<newTriangles.length;++i){t=newTriangles[i];[0,1,2].forEach(function(idx){var id=originalIndices[t.originalOffset+idx];var offset=t.vertices[idx].originalOffsets.indexOf(id);if(offset<0)offset=0;newIndicesArray.push(t.vertices[idx].id+offset+startingVertex)})}this._reconstructedMesh.setIndices(newIndicesArray);this._reconstructedMesh.setVerticesData(BABYLON.VertexBuffer.PositionKind,newPositionData);this._reconstructedMesh.setVerticesData(BABYLON.VertexBuffer.NormalKind,newNormalData);if(newUVsData.length>0)this._reconstructedMesh.setVerticesData(BABYLON.VertexBuffer.UVKind,newUVsData);if(newColorsData.length>0)this._reconstructedMesh.setVerticesData(BABYLON.VertexBuffer.ColorKind,newColorsData);var originalSubmesh=this._mesh.subMeshes[submeshIndex];if(submeshIndex>0){this._reconstructedMesh.subMeshes=[];submeshesArray.forEach(function(submesh){BABYLON.SubMesh.AddToMesh(submesh.materialIndex,submesh.verticesStart,submesh.verticesCount,submesh.indexStart,submesh.indexCount,submesh.getMesh())});BABYLON.SubMesh.AddToMesh(originalSubmesh.materialIndex,startingVertex,vertexCount,startingIndex,newTriangles.length*3,this._reconstructedMesh)}};QuadraticErrorSimplification.prototype.initDecimatedMesh=function(){this._reconstructedMesh=new BABYLON.Mesh(this._mesh.name+"Decimated",this._mesh.getScene());this._reconstructedMesh.material=this._mesh.material;this._reconstructedMesh.parent=this._mesh.parent;this._reconstructedMesh.isVisible=false;this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId};QuadraticErrorSimplification.prototype.isFlipped=function(vertex1,vertex2,point,deletedArray,borderFactor,delTr){for(var i=0;i<vertex1.triangleCount;++i){var t=this.triangles[this.references[vertex1.triangleStart+i].triangleId];if(t.deleted)continue;var s=this.references[vertex1.triangleStart+i].vertexId;var v1=t.vertices[(s+1)%3];var v2=t.vertices[(s+2)%3];if(v1===vertex2||v2===vertex2){deletedArray[i]=true;delTr.push(t);continue}var d1=v1.position.subtract(point);d1=d1.normalize();var d2=v2.position.subtract(point);d2=d2.normalize();if(Math.abs(BABYLON.Vector3.Dot(d1,d2))>.999)return true;var normal=BABYLON.Vector3.Cross(d1,d2).normalize();deletedArray[i]=false;if(BABYLON.Vector3.Dot(normal,t.normal)<.2)return true}return false};QuadraticErrorSimplification.prototype.updateTriangles=function(origVertex,vertex,deletedArray,deletedTriangles){var newDeleted=deletedTriangles;for(var i=0;i<vertex.triangleCount;++i){var ref=this.references[vertex.triangleStart+i];var t=this.triangles[ref.triangleId];if(t.deleted)continue;if(deletedArray[i]&&t.deletePending){t.deleted=true;newDeleted++;continue}t.vertices[ref.vertexId]=origVertex;t.isDirty=true;t.error[0]=this.calculateError(t.vertices[0],t.vertices[1])+t.borderFactor/2;t.error[1]=this.calculateError(t.vertices[1],t.vertices[2])+t.borderFactor/2;t.error[2]=this.calculateError(t.vertices[2],t.vertices[0])+t.borderFactor/2;t.error[3]=Math.min(t.error[0],t.error[1],t.error[2]);this.references.push(ref)}return newDeleted};QuadraticErrorSimplification.prototype.identifyBorder=function(){for(var i=0;i<this.vertices.length;++i){var vCount=[];var vId=[];var v=this.vertices[i];var j;for(j=0;j<v.triangleCount;++j){var triangle=this.triangles[this.references[v.triangleStart+j].triangleId];for(var ii=0;ii<3;ii++){var ofs=0;var vv=triangle.vertices[ii];while(ofs<vCount.length){if(vId[ofs]===vv.id)break;++ofs}if(ofs===vCount.length){vCount.push(1);vId.push(vv.id)}else{vCount[ofs]++}}}for(j=0;j<vCount.length;++j){if(vCount[j]===1){this.vertices[vId[j]].isBorder=true}else{this.vertices[vId[j]].isBorder=false}}}};QuadraticErrorSimplification.prototype.updateMesh=function(identifyBorders){if(identifyBorders===void 0){identifyBorders=false}var i;if(!identifyBorders){var newTrianglesVector=[];for(i=0;i<this.triangles.length;++i){if(!this.triangles[i].deleted){newTrianglesVector.push(this.triangles[i])}}this.triangles=newTrianglesVector}for(i=0;i<this.vertices.length;++i){this.vertices[i].triangleCount=0;this.vertices[i].triangleStart=0}var t;var j;var v;for(i=0;i<this.triangles.length;++i){t=this.triangles[i];for(j=0;j<3;++j){v=t.vertices[j];v.triangleCount++}}var tStart=0;for(i=0;i<this.vertices.length;++i){this.vertices[i].triangleStart=tStart;tStart+=this.vertices[i].triangleCount;this.vertices[i].triangleCount=0}var newReferences=new Array(this.triangles.length*3);for(i=0;i<this.triangles.length;++i){t=this.triangles[i];for(j=0;j<3;++j){v=t.vertices[j];newReferences[v.triangleStart+v.triangleCount]=new Reference(j,i);v.triangleCount++}}this.references=newReferences;if(identifyBorders){this.identifyBorder()}};QuadraticErrorSimplification.prototype.vertexError=function(q,point){var x=point.x;var y=point.y;var z=point.z;return q.data[0]*x*x+2*q.data[1]*x*y+2*q.data[2]*x*z+2*q.data[3]*x+q.data[4]*y*y+2*q.data[5]*y*z+2*q.data[6]*y+q.data[7]*z*z+2*q.data[8]*z+q.data[9]};QuadraticErrorSimplification.prototype.calculateError=function(vertex1,vertex2,pointResult,normalResult,uvResult,colorResult){var q=vertex1.q.add(vertex2.q);var border=vertex1.isBorder&&vertex2.isBorder;var error=0;var qDet=q.det(0,1,2,1,4,5,2,5,7);if(qDet!==0&&!border){if(!pointResult){pointResult=BABYLON.Vector3.Zero()}pointResult.x=-1/qDet*q.det(1,2,3,4,5,6,5,7,8);pointResult.y=1/qDet*q.det(0,2,3,1,5,6,2,7,8);pointResult.z=-1/qDet*q.det(0,1,3,1,4,6,2,5,8);error=this.vertexError(q,pointResult)}else{var p3=vertex1.position.add(vertex2.position).divide(new BABYLON.Vector3(2,2,2));var error1=this.vertexError(q,vertex1.position);var error2=this.vertexError(q,vertex2.position);var error3=this.vertexError(q,p3);error=Math.min(error1,error2,error3);if(error===error1){if(pointResult){pointResult.copyFrom(vertex1.position)}}else if(error===error2){if(pointResult){pointResult.copyFrom(vertex2.position)}}else{if(pointResult){pointResult.copyFrom(p3)}}}return error};return QuadraticErrorSimplification}();BABYLON.QuadraticErrorSimplification=QuadraticErrorSimplification})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Internals;(function(Internals){var MeshLODLevel=function(){function MeshLODLevel(distance,mesh){this.distance=distance;this.mesh=mesh}return MeshLODLevel}();Internals.MeshLODLevel=MeshLODLevel})(Internals=BABYLON.Internals||(BABYLON.Internals={}))})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var SceneOptimization=function(){function SceneOptimization(priority){if(priority===void 0){priority=0}this.priority=priority;this.apply=function(scene){return true}}return SceneOptimization}();BABYLON.SceneOptimization=SceneOptimization;var TextureOptimization=function(_super){__extends(TextureOptimization,_super);function TextureOptimization(priority,maximumSize){if(priority===void 0){priority=0}if(maximumSize===void 0){maximumSize=1024}var _this=_super.call(this,priority)||this;_this.priority=priority;_this.maximumSize=maximumSize;_this.apply=function(scene){var allDone=true;for(var index=0;index<scene.textures.length;index++){var texture=scene.textures[index];if(!texture.canRescale||texture.getContext){continue}var currentSize=texture.getSize();var maxDimension=Math.max(currentSize.width,currentSize.height);if(maxDimension>_this.maximumSize){texture.scale(.5);allDone=false}}return allDone};return _this}return TextureOptimization}(SceneOptimization);BABYLON.TextureOptimization=TextureOptimization;var HardwareScalingOptimization=function(_super){__extends(HardwareScalingOptimization,_super);function HardwareScalingOptimization(priority,maximumScale){if(priority===void 0){priority=0}if(maximumScale===void 0){maximumScale=2}var _this=_super.call(this,priority)||this;_this.priority=priority;_this.maximumScale=maximumScale;_this._currentScale=1;_this.apply=function(scene){_this._currentScale++;scene.getEngine().setHardwareScalingLevel(_this._currentScale);return _this._currentScale>=_this.maximumScale};return _this}return HardwareScalingOptimization}(SceneOptimization);BABYLON.HardwareScalingOptimization=HardwareScalingOptimization;var ShadowsOptimization=function(_super){__extends(ShadowsOptimization,_super);function ShadowsOptimization(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.apply=function(scene){scene.shadowsEnabled=false;return true};return _this}return ShadowsOptimization}(SceneOptimization);BABYLON.ShadowsOptimization=ShadowsOptimization;var PostProcessesOptimization=function(_super){__extends(PostProcessesOptimization,_super);function PostProcessesOptimization(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.apply=function(scene){scene.postProcessesEnabled=false;return true};return _this}return PostProcessesOptimization}(SceneOptimization);BABYLON.PostProcessesOptimization=PostProcessesOptimization;var LensFlaresOptimization=function(_super){__extends(LensFlaresOptimization,_super);function LensFlaresOptimization(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.apply=function(scene){scene.lensFlaresEnabled=false;return true};return _this}return LensFlaresOptimization}(SceneOptimization);BABYLON.LensFlaresOptimization=LensFlaresOptimization;var ParticlesOptimization=function(_super){__extends(ParticlesOptimization,_super);function ParticlesOptimization(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.apply=function(scene){scene.particlesEnabled=false;return true};return _this}return ParticlesOptimization}(SceneOptimization);BABYLON.ParticlesOptimization=ParticlesOptimization;var RenderTargetsOptimization=function(_super){__extends(RenderTargetsOptimization,_super);function RenderTargetsOptimization(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.apply=function(scene){scene.renderTargetsEnabled=false;return true};return _this}return RenderTargetsOptimization}(SceneOptimization);BABYLON.RenderTargetsOptimization=RenderTargetsOptimization;var MergeMeshesOptimization=function(_super){__extends(MergeMeshesOptimization,_super);function MergeMeshesOptimization(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this._canBeMerged=function(abstractMesh){if(!(abstractMesh instanceof BABYLON.Mesh)){return false}var mesh=abstractMesh;if(!mesh.isVisible||!mesh.isEnabled()){return false}if(mesh.instances.length>0){return false}if(mesh.skeleton||mesh.hasLODLevels){return false}if(mesh.parent){return false}return true};_this.apply=function(scene,updateSelectionTree){var globalPool=scene.meshes.slice(0);var globalLength=globalPool.length;for(var index=0;index<globalLength;index++){var currentPool=new Array;var current=globalPool[index];if(!_this._canBeMerged(current)){continue}currentPool.push(current);for(var subIndex=index+1;subIndex<globalLength;subIndex++){var otherMesh=globalPool[subIndex];if(!_this._canBeMerged(otherMesh)){continue}if(otherMesh.material!==current.material){continue}if(otherMesh.checkCollisions!==current.checkCollisions){continue}currentPool.push(otherMesh);globalLength--;globalPool.splice(subIndex,1);subIndex--}if(currentPool.length<2){continue}BABYLON.Mesh.MergeMeshes(currentPool)}if(updateSelectionTree!=undefined){if(updateSelectionTree){scene.createOrUpdateSelectionOctree()}}else if(MergeMeshesOptimization.UpdateSelectionTree){scene.createOrUpdateSelectionOctree()}return true};return _this}Object.defineProperty(MergeMeshesOptimization,"UpdateSelectionTree",{get:function(){return MergeMeshesOptimization._UpdateSelectionTree},set:function(value){MergeMeshesOptimization._UpdateSelectionTree=value},enumerable:true,configurable:true});MergeMeshesOptimization._UpdateSelectionTree=false;return MergeMeshesOptimization}(SceneOptimization);BABYLON.MergeMeshesOptimization=MergeMeshesOptimization;var SceneOptimizerOptions=function(){function SceneOptimizerOptions(targetFrameRate,trackerDuration){if(targetFrameRate===void 0){targetFrameRate=60}if(trackerDuration===void 0){trackerDuration=2e3}this.targetFrameRate=targetFrameRate;this.trackerDuration=trackerDuration;this.optimizations=new Array}SceneOptimizerOptions.LowDegradationAllowed=function(targetFrameRate){var result=new SceneOptimizerOptions(targetFrameRate);var priority=0;result.optimizations.push(new MergeMeshesOptimization(priority));result.optimizations.push(new ShadowsOptimization(priority));result.optimizations.push(new LensFlaresOptimization(priority));priority++;result.optimizations.push(new PostProcessesOptimization(priority));result.optimizations.push(new ParticlesOptimization(priority));priority++;result.optimizations.push(new TextureOptimization(priority,1024));return result};SceneOptimizerOptions.ModerateDegradationAllowed=function(targetFrameRate){var result=new SceneOptimizerOptions(targetFrameRate);var priority=0;result.optimizations.push(new MergeMeshesOptimization(priority));result.optimizations.push(new ShadowsOptimization(priority));result.optimizations.push(new LensFlaresOptimization(priority));priority++;result.optimizations.push(new PostProcessesOptimization(priority));result.optimizations.push(new ParticlesOptimization(priority));priority++;result.optimizations.push(new TextureOptimization(priority,512));priority++;result.optimizations.push(new RenderTargetsOptimization(priority));priority++;result.optimizations.push(new HardwareScalingOptimization(priority,2));return result};SceneOptimizerOptions.HighDegradationAllowed=function(targetFrameRate){var result=new SceneOptimizerOptions(targetFrameRate);var priority=0;result.optimizations.push(new MergeMeshesOptimization(priority));result.optimizations.push(new ShadowsOptimization(priority));result.optimizations.push(new LensFlaresOptimization(priority));priority++;result.optimizations.push(new PostProcessesOptimization(priority));result.optimizations.push(new ParticlesOptimization(priority));priority++;result.optimizations.push(new TextureOptimization(priority,256));priority++;result.optimizations.push(new RenderTargetsOptimization(priority));priority++;result.optimizations.push(new HardwareScalingOptimization(priority,4));return result};return SceneOptimizerOptions}();BABYLON.SceneOptimizerOptions=SceneOptimizerOptions;var SceneOptimizer=function(){function SceneOptimizer(){}SceneOptimizer._CheckCurrentState=function(scene,options,currentPriorityLevel,onSuccess,onFailure){if(scene.getEngine().getFps()>=options.targetFrameRate){if(onSuccess){onSuccess()}return}var allDone=true;var noOptimizationApplied=true;for(var index=0;index<options.optimizations.length;index++){var optimization=options.optimizations[index];if(optimization.priority===currentPriorityLevel){noOptimizationApplied=false;allDone=allDone&&optimization.apply(scene)}}if(noOptimizationApplied){if(onFailure){onFailure()}return}if(allDone){currentPriorityLevel++}scene.executeWhenReady(function(){setTimeout(function(){SceneOptimizer._CheckCurrentState(scene,options,currentPriorityLevel,onSuccess,onFailure)},options.trackerDuration)})};SceneOptimizer.OptimizeAsync=function(scene,options,onSuccess,onFailure){if(!options){options=SceneOptimizerOptions.ModerateDegradationAllowed()}scene.executeWhenReady(function(){setTimeout(function(){SceneOptimizer._CheckCurrentState(scene,options,0,onSuccess,onFailure)},options.trackerDuration)})};return SceneOptimizer}();BABYLON.SceneOptimizer=SceneOptimizer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var OutlineRenderer=function(){function OutlineRenderer(scene){this.zOffset=1;this._scene=scene}OutlineRenderer.prototype.render=function(subMesh,batch,useOverlay){var _this=this;if(useOverlay===void 0){useOverlay=false}var scene=this._scene;var engine=this._scene.getEngine();var hardwareInstancedRendering=engine.getCaps().instancedArrays&&batch.visibleInstances[subMesh._id]!==null&&batch.visibleInstances[subMesh._id]!==undefined;if(!this.isReady(subMesh,hardwareInstancedRendering)){return}var mesh=subMesh.getRenderingMesh();var material=subMesh.getMaterial();engine.enableEffect(this._effect);if(material.useLogarithmicDepth){this._effect.setFloat("logarithmicDepthConstant",2/(Math.log(scene.activeCamera.maxZ+1)/Math.LN2))}this._effect.setFloat("offset",useOverlay?0:mesh.outlineWidth);this._effect.setColor4("color",useOverlay?mesh.overlayColor:mesh.outlineColor,useOverlay?mesh.overlayAlpha:material.alpha);this._effect.setMatrix("viewProjection",scene.getTransformMatrix());if(mesh.useBones&&mesh.computeBonesUsingShaders){this._effect.setMatrices("mBones",mesh.skeleton.getTransformMatrices(mesh))}mesh._bind(subMesh,this._effect,BABYLON.Material.TriangleFillMode);if(material&&material.needAlphaTesting()){var alphaTexture=material.getAlphaTestTexture();if(alphaTexture){this._effect.setTexture("diffuseSampler",alphaTexture);this._effect.setMatrix("diffuseMatrix",alphaTexture.getTextureMatrix())}}engine.setZOffset(-this.zOffset);mesh._processRendering(subMesh,this._effect,BABYLON.Material.TriangleFillMode,batch,hardwareInstancedRendering,function(isInstance,world){_this._effect.setMatrix("world",world)});engine.setZOffset(0)};OutlineRenderer.prototype.isReady=function(subMesh,useInstances){var defines=[];var attribs=[BABYLON.VertexBuffer.PositionKind,BABYLON.VertexBuffer.NormalKind];var mesh=subMesh.getMesh();var material=subMesh.getMaterial();if(material){if(material.needAlphaTesting()){defines.push("#define ALPHATEST");if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){attribs.push(BABYLON.VertexBuffer.UVKind);defines.push("#define UV1")}if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)){attribs.push(BABYLON.VertexBuffer.UV2Kind);defines.push("#define UV2")}}if(material.useLogarithmicDepth){defines.push("#define LOGARITHMICDEPTH")}}if(mesh.useBones&&mesh.computeBonesUsingShaders){attribs.push(BABYLON.VertexBuffer.MatricesIndicesKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsKind);if(mesh.numBoneInfluencers>4){attribs.push(BABYLON.VertexBuffer.MatricesIndicesExtraKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsExtraKind)}defines.push("#define NUM_BONE_INFLUENCERS "+mesh.numBoneInfluencers);defines.push("#define BonesPerMesh "+(mesh.skeleton.bones.length+1))}else{defines.push("#define NUM_BONE_INFLUENCERS 0")}if(useInstances){defines.push("#define INSTANCES");attribs.push("world0");attribs.push("world1");attribs.push("world2");attribs.push("world3")}var join=defines.join("\n");if(this._cachedDefines!==join){this._cachedDefines=join;this._effect=this._scene.getEngine().createEffect("outline",attribs,["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant"],["diffuseSampler"],join)}return this._effect.isReady()};return OutlineRenderer}();BABYLON.OutlineRenderer=OutlineRenderer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FaceAdjacencies=function(){function FaceAdjacencies(){this.edges=new Array;this.edgesConnectedCount=0}return FaceAdjacencies}();var EdgesRenderer=function(){function EdgesRenderer(source,epsilon,checkVerticesInsteadOfIndices){if(epsilon===void 0){epsilon=.95}if(checkVerticesInsteadOfIndices===void 0){checkVerticesInsteadOfIndices=false}this.edgesWidthScalerForOrthographic=1e3;this.edgesWidthScalerForPerspective=50;this._linesPositions=new Array;this._linesNormals=new Array;this._linesIndices=new Array;this._buffers={};this._checkVerticesInsteadOfIndices=false;this._source=source;this._checkVerticesInsteadOfIndices=checkVerticesInsteadOfIndices;this._epsilon=epsilon;this._prepareRessources();this._generateEdgesLines()}EdgesRenderer.prototype._prepareRessources=function(){if(this._lineShader){return}this._lineShader=new BABYLON.ShaderMaterial("lineShader",this._source.getScene(),"line",{attributes:["position","normal"],uniforms:["worldViewProjection","color","width","aspectRatio"]});this._lineShader.disableDepthWrite=true;this._lineShader.backFaceCulling=false};EdgesRenderer.prototype._rebuild=function(){var buffer=this._buffers[BABYLON.VertexBuffer.PositionKind];if(buffer){buffer._rebuild()}buffer=this._buffers[BABYLON.VertexBuffer.NormalKind];if(buffer){buffer._rebuild()}var scene=this._source.getScene();var engine=scene.getEngine();this._ib=engine.createIndexBuffer(this._linesIndices)};EdgesRenderer.prototype.dispose=function(){var buffer=this._buffers[BABYLON.VertexBuffer.PositionKind];if(buffer){buffer.dispose();this._buffers[BABYLON.VertexBuffer.PositionKind]=null}buffer=this._buffers[BABYLON.VertexBuffer.NormalKind];if(buffer){buffer.dispose();this._buffers[BABYLON.VertexBuffer.NormalKind]=null}this._source.getScene().getEngine()._releaseBuffer(this._ib);this._lineShader.dispose()};EdgesRenderer.prototype._processEdgeForAdjacencies=function(pa,pb,p0,p1,p2){if(pa===p0&&pb===p1||pa===p1&&pb===p0){return 0}if(pa===p1&&pb===p2||pa===p2&&pb===p1){return 1}if(pa===p2&&pb===p0||pa===p0&&pb===p2){return 2}return-1};EdgesRenderer.prototype._processEdgeForAdjacenciesWithVertices=function(pa,pb,p0,p1,p2){if(pa.equalsWithEpsilon(p0)&&pb.equalsWithEpsilon(p1)||pa.equalsWithEpsilon(p1)&&pb.equalsWithEpsilon(p0)){return 0}if(pa.equalsWithEpsilon(p1)&&pb.equalsWithEpsilon(p2)||pa.equalsWithEpsilon(p2)&&pb.equalsWithEpsilon(p1)){return 1}if(pa.equalsWithEpsilon(p2)&&pb.equalsWithEpsilon(p0)||pa.equalsWithEpsilon(p0)&&pb.equalsWithEpsilon(p2)){return 2}return-1};EdgesRenderer.prototype._checkEdge=function(faceIndex,edge,faceNormals,p0,p1){var needToCreateLine;if(edge===undefined){needToCreateLine=true}else{var dotProduct=BABYLON.Vector3.Dot(faceNormals[faceIndex],faceNormals[edge]);needToCreateLine=dotProduct<this._epsilon}if(needToCreateLine){var offset=this._linesPositions.length/3;var normal=p0.subtract(p1);normal.normalize();this._linesPositions.push(p0.x);this._linesPositions.push(p0.y);this._linesPositions.push(p0.z);this._linesPositions.push(p0.x);this._linesPositions.push(p0.y);this._linesPositions.push(p0.z);this._linesPositions.push(p1.x);this._linesPositions.push(p1.y);this._linesPositions.push(p1.z);this._linesPositions.push(p1.x);this._linesPositions.push(p1.y);this._linesPositions.push(p1.z);this._linesNormals.push(p1.x);this._linesNormals.push(p1.y);this._linesNormals.push(p1.z);this._linesNormals.push(-1);this._linesNormals.push(p1.x);this._linesNormals.push(p1.y);this._linesNormals.push(p1.z);this._linesNormals.push(1);this._linesNormals.push(p0.x);this._linesNormals.push(p0.y);this._linesNormals.push(p0.z);this._linesNormals.push(-1);this._linesNormals.push(p0.x);this._linesNormals.push(p0.y);this._linesNormals.push(p0.z);this._linesNormals.push(1);this._linesIndices.push(offset);this._linesIndices.push(offset+1);this._linesIndices.push(offset+2);this._linesIndices.push(offset);this._linesIndices.push(offset+2);this._linesIndices.push(offset+3)}};EdgesRenderer.prototype._generateEdgesLines=function(){var positions=this._source.getVerticesData(BABYLON.VertexBuffer.PositionKind);var indices=this._source.getIndices();var adjacencies=new Array;var faceNormals=new Array;var index;var faceAdjacencies;for(index=0;index<indices.length;index+=3){faceAdjacencies=new FaceAdjacencies;var p0Index=indices[index];var p1Index=indices[index+1];var p2Index=indices[index+2];faceAdjacencies.p0=new BABYLON.Vector3(positions[p0Index*3],positions[p0Index*3+1],positions[p0Index*3+2]);faceAdjacencies.p1=new BABYLON.Vector3(positions[p1Index*3],positions[p1Index*3+1],positions[p1Index*3+2]);faceAdjacencies.p2=new BABYLON.Vector3(positions[p2Index*3],positions[p2Index*3+1],positions[p2Index*3+2]);var faceNormal=BABYLON.Vector3.Cross(faceAdjacencies.p1.subtract(faceAdjacencies.p0),faceAdjacencies.p2.subtract(faceAdjacencies.p1));faceNormal.normalize();faceNormals.push(faceNormal);adjacencies.push(faceAdjacencies)}for(index=0;index<adjacencies.length;index++){faceAdjacencies=adjacencies[index];for(var otherIndex=index+1;otherIndex<adjacencies.length;otherIndex++){var otherFaceAdjacencies=adjacencies[otherIndex];if(faceAdjacencies.edgesConnectedCount===3){break}if(otherFaceAdjacencies.edgesConnectedCount===3){continue}var otherP0=indices[otherIndex*3];var otherP1=indices[otherIndex*3+1];var otherP2=indices[otherIndex*3+2];for(var edgeIndex=0;edgeIndex<3;edgeIndex++){var otherEdgeIndex;if(faceAdjacencies.edges[edgeIndex]!==undefined){continue}switch(edgeIndex){case 0:if(this._checkVerticesInsteadOfIndices){otherEdgeIndex=this._processEdgeForAdjacenciesWithVertices(faceAdjacencies.p0,faceAdjacencies.p1,otherFaceAdjacencies.p0,otherFaceAdjacencies.p1,otherFaceAdjacencies.p2)}else{otherEdgeIndex=this._processEdgeForAdjacencies(indices[index*3],indices[index*3+1],otherP0,otherP1,otherP2)}break;case 1:if(this._checkVerticesInsteadOfIndices){otherEdgeIndex=this._processEdgeForAdjacenciesWithVertices(faceAdjacencies.p1,faceAdjacencies.p2,otherFaceAdjacencies.p0,otherFaceAdjacencies.p1,otherFaceAdjacencies.p2)}else{otherEdgeIndex=this._processEdgeForAdjacencies(indices[index*3+1],indices[index*3+2],otherP0,otherP1,otherP2)}break;case 2:if(this._checkVerticesInsteadOfIndices){otherEdgeIndex=this._processEdgeForAdjacenciesWithVertices(faceAdjacencies.p2,faceAdjacencies.p0,otherFaceAdjacencies.p0,otherFaceAdjacencies.p1,otherFaceAdjacencies.p2)}else{otherEdgeIndex=this._processEdgeForAdjacencies(indices[index*3+2],indices[index*3],otherP0,otherP1,otherP2)}break}if(otherEdgeIndex===-1){continue}faceAdjacencies.edges[edgeIndex]=otherIndex;otherFaceAdjacencies.edges[otherEdgeIndex]=index;faceAdjacencies.edgesConnectedCount++;otherFaceAdjacencies.edgesConnectedCount++;if(faceAdjacencies.edgesConnectedCount===3){break}}}}for(index=0;index<adjacencies.length;index++){var current=adjacencies[index];this._checkEdge(index,current.edges[0],faceNormals,current.p0,current.p1);this._checkEdge(index,current.edges[1],faceNormals,current.p1,current.p2);this._checkEdge(index,current.edges[2],faceNormals,current.p2,current.p0)}var engine=this._source.getScene().getEngine();this._buffers[BABYLON.VertexBuffer.PositionKind]=new BABYLON.VertexBuffer(engine,this._linesPositions,BABYLON.VertexBuffer.PositionKind,false);this._buffers[BABYLON.VertexBuffer.NormalKind]=new BABYLON.VertexBuffer(engine,this._linesNormals,BABYLON.VertexBuffer.NormalKind,false,false,4);this._ib=engine.createIndexBuffer(this._linesIndices);this._indicesCount=this._linesIndices.length};EdgesRenderer.prototype.render=function(){if(!this._lineShader.isReady()){return}var scene=this._source.getScene();var engine=scene.getEngine();this._lineShader._preBind();engine.bindBuffers(this._buffers,this._ib,this._lineShader.getEffect());scene.resetCachedMaterial();this._lineShader.setColor4("color",this._source.edgesColor);if(scene.activeCamera.mode===BABYLON.Camera.ORTHOGRAPHIC_CAMERA){this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic)}else{this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective)}this._lineShader.setFloat("aspectRatio",engine.getAspectRatio(scene.activeCamera));this._lineShader.bind(this._source.getWorldMatrix());engine.draw(true,0,this._indicesCount);this._lineShader.unbind();engine.setDepthWrite(true)};return EdgesRenderer}();BABYLON.EdgesRenderer=EdgesRenderer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var GlowBlurPostProcess=function(_super){__extends(GlowBlurPostProcess,_super);function GlowBlurPostProcess(name,direction,kernel,options,camera,samplingMode,engine,reusable){if(samplingMode===void 0){samplingMode=BABYLON.Texture.BILINEAR_SAMPLINGMODE}var _this=_super.call(this,name,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,options,camera,samplingMode,engine,reusable)||this;_this.direction=direction;_this.kernel=kernel;_this.onApplyObservable.add(function(effect){effect.setFloat2("screenSize",_this.width,_this.height);effect.setVector2("direction",_this.direction);effect.setFloat("blurWidth",_this.kernel)});return _this}return GlowBlurPostProcess}(BABYLON.PostProcess);var HighlightLayer=function(){function HighlightLayer(name,scene,options){this.name=name;this._vertexBuffers={};this._mainTextureDesiredSize={width:0,height:0};this._meshes={};this._maxSize=0;this._shouldRender=false;this._instanceGlowingMeshStencilReference=HighlightLayer.glowingMeshStencilReference++;this._excludedMeshes={};this.innerGlow=true;this.outerGlow=true;this.isEnabled=true;this.onDisposeObservable=new BABYLON.Observable;this.onBeforeRenderMainTextureObservable=new BABYLON.Observable;this.onBeforeBlurObservable=new BABYLON.Observable;this.onAfterBlurObservable=new BABYLON.Observable;this.onBeforeComposeObservable=new BABYLON.Observable;this.onAfterComposeObservable=new BABYLON.Observable;this.onSizeChangedObservable=new BABYLON.Observable;this._scene=scene||BABYLON.Engine.LastCreatedScene;var engine=scene.getEngine();this._engine=engine;this._maxSize=this._engine.getCaps().maxTextureSize;this._scene.highlightLayers.push(this);if(!this._engine.isStencilEnable){BABYLON.Tools.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new BABYLON.Engine(canvas, antialias, { stencil: true }")}this._options=options||{mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:BABYLON.Engine.ALPHA_COMBINE};this._options.mainTextureRatio=this._options.mainTextureRatio||.5;this._options.blurTextureSizeRatio=this._options.blurTextureSizeRatio||1;this._options.blurHorizontalSize=this._options.blurHorizontalSize||1;this._options.blurVerticalSize=this._options.blurVerticalSize||1;this._options.alphaBlendingMode=this._options.alphaBlendingMode||BABYLON.Engine.ALPHA_COMBINE;var vertices=[];vertices.push(1,1);vertices.push(-1,1);vertices.push(-1,-1);vertices.push(1,-1);var vertexBuffer=new BABYLON.VertexBuffer(engine,vertices,BABYLON.VertexBuffer.PositionKind,false,false,2);this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=vertexBuffer;this._createIndexBuffer();this._glowMapMergeEffect=engine.createEffect("glowMapMerge",[BABYLON.VertexBuffer.PositionKind],["offset"],["textureSampler"],"");this.setMainTextureSize();this.createTextureAndPostProcesses()}Object.defineProperty(HighlightLayer.prototype,"blurHorizontalSize",{get:function(){return this._horizontalBlurPostprocess.kernel},set:function(value){this._horizontalBlurPostprocess.kernel=value},enumerable:true,configurable:true});Object.defineProperty(HighlightLayer.prototype,"blurVerticalSize",{get:function(){return this._verticalBlurPostprocess.kernel},set:function(value){this._verticalBlurPostprocess.kernel=value},enumerable:true,configurable:true});Object.defineProperty(HighlightLayer.prototype,"camera",{get:function(){return this._options.camera},enumerable:true,configurable:true});HighlightLayer.prototype._createIndexBuffer=function(){var engine=this._scene.getEngine();var indices=[];indices.push(0);indices.push(1);indices.push(2);indices.push(0);indices.push(2);indices.push(3);this._indexBuffer=engine.createIndexBuffer(indices)};HighlightLayer.prototype._rebuild=function(){this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]._rebuild();this._createIndexBuffer()};HighlightLayer.prototype.createTextureAndPostProcesses=function(){var _this=this;var blurTextureWidth=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio;var blurTextureHeight=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;blurTextureWidth=this._engine.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(blurTextureWidth,this._maxSize):blurTextureWidth;blurTextureHeight=this._engine.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(blurTextureHeight,this._maxSize):blurTextureHeight;this._mainTexture=new BABYLON.RenderTargetTexture("HighlightLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,false,true,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this._mainTexture.activeCamera=this._options.camera;this._mainTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;this._mainTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;this._mainTexture.anisotropicFilteringLevel=1;this._mainTexture.updateSamplingMode(BABYLON.Texture.BILINEAR_SAMPLINGMODE);this._mainTexture.renderParticles=false;this._mainTexture.renderList=null;this._mainTexture.ignoreCameraViewport=true;this._blurTexture=new BABYLON.RenderTargetTexture("HighlightLayerBlurRTT",{width:blurTextureWidth,height:blurTextureHeight},this._scene,false,true,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);this._blurTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;this._blurTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;this._blurTexture.anisotropicFilteringLevel=16;this._blurTexture.updateSamplingMode(BABYLON.Texture.TRILINEAR_SAMPLINGMODE);this._blurTexture.renderParticles=false;this._blurTexture.ignoreCameraViewport=true;this._downSamplePostprocess=new BABYLON.PassPostProcess("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._downSamplePostprocess.onApplyObservable.add(function(effect){effect.setTexture("textureSampler",_this._mainTexture)});if(this._options.alphaBlendingMode===BABYLON.Engine.ALPHA_COMBINE){this._horizontalBlurPostprocess=new GlowBlurPostProcess("HighlightLayerHBP",new BABYLON.Vector2(1,0),this._options.blurHorizontalSize,1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._horizontalBlurPostprocess.onApplyObservable.add(function(effect){effect.setFloat2("screenSize",blurTextureWidth,blurTextureHeight)});this._verticalBlurPostprocess=new GlowBlurPostProcess("HighlightLayerVBP",new BABYLON.Vector2(0,1),this._options.blurVerticalSize,1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._verticalBlurPostprocess.onApplyObservable.add(function(effect){effect.setFloat2("screenSize",blurTextureWidth,blurTextureHeight)})}else{this._horizontalBlurPostprocess=new BABYLON.BlurPostProcess("HighlightLayerHBP",new BABYLON.Vector2(1,0),this._options.blurHorizontalSize,1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._horizontalBlurPostprocess.onApplyObservable.add(function(effect){effect.setFloat2("screenSize",blurTextureWidth,blurTextureHeight)});this._verticalBlurPostprocess=new BABYLON.BlurPostProcess("HighlightLayerVBP",new BABYLON.Vector2(0,1),this._options.blurVerticalSize,1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._verticalBlurPostprocess.onApplyObservable.add(function(effect){effect.setFloat2("screenSize",blurTextureWidth,blurTextureHeight)})}this._mainTexture.onAfterUnbindObservable.add(function(){_this.onBeforeBlurObservable.notifyObservers(_this);_this._scene.postProcessManager.directRender([_this._downSamplePostprocess,_this._horizontalBlurPostprocess,_this._verticalBlurPostprocess],_this._blurTexture.getInternalTexture(),true);_this.onAfterBlurObservable.notifyObservers(_this)});var renderSubMesh=function(subMesh){var mesh=subMesh.getRenderingMesh();var scene=_this._scene;var engine=scene.getEngine();engine.setState(subMesh.getMaterial().backFaceCulling);var batch=mesh._getInstancesRenderList(subMesh._id);if(batch.mustReturn){return}if(_this._excludedMeshes[mesh.uniqueId]){return}var hardwareInstancedRendering=engine.getCaps().instancedArrays&&batch.visibleInstances[subMesh._id]!==null&&batch.visibleInstances[subMesh._id]!==undefined;var highlightLayerMesh=_this._meshes[mesh.uniqueId];var material=subMesh.getMaterial();var emissiveTexture=null;if(highlightLayerMesh&&highlightLayerMesh.glowEmissiveOnly&&material){emissiveTexture=material.emissiveTexture}if(_this.isReady(subMesh,hardwareInstancedRendering,emissiveTexture)){engine.enableEffect(_this._glowMapGenerationEffect);mesh._bind(subMesh,_this._glowMapGenerationEffect,BABYLON.Material.TriangleFillMode);_this._glowMapGenerationEffect.setMatrix("viewProjection",scene.getTransformMatrix());if(highlightLayerMesh){_this._glowMapGenerationEffect.setFloat4("color",highlightLayerMesh.color.r,highlightLayerMesh.color.g,highlightLayerMesh.color.b,1)}else{_this._glowMapGenerationEffect.setFloat4("color",HighlightLayer.neutralColor.r,HighlightLayer.neutralColor.g,HighlightLayer.neutralColor.b,HighlightLayer.neutralColor.a)}if(material&&material.needAlphaTesting()){var alphaTexture=material.getAlphaTestTexture();if(alphaTexture){_this._glowMapGenerationEffect.setTexture("diffuseSampler",alphaTexture);_this._glowMapGenerationEffect.setMatrix("diffuseMatrix",alphaTexture.getTextureMatrix())}}if(emissiveTexture){_this._glowMapGenerationEffect.setTexture("emissiveSampler",emissiveTexture);_this._glowMapGenerationEffect.setMatrix("emissiveMatrix",emissiveTexture.getTextureMatrix())}if(mesh.useBones&&mesh.computeBonesUsingShaders){_this._glowMapGenerationEffect.setMatrices("mBones",mesh.skeleton.getTransformMatrices(mesh))}mesh._processRendering(subMesh,_this._glowMapGenerationEffect,BABYLON.Material.TriangleFillMode,batch,hardwareInstancedRendering,function(isInstance,world){return _this._glowMapGenerationEffect.setMatrix("world",world)})}else{_this._mainTexture.resetRefreshCounter()}};this._mainTexture.customRenderFunction=function(opaqueSubMeshes,alphaTestSubMeshes,transparentSubMeshes,depthOnlySubMeshes){_this.onBeforeRenderMainTextureObservable.notifyObservers(_this);var index;var engine=_this._scene.getEngine();if(depthOnlySubMeshes.length){engine.setColorWrite(false);for(index=0;index<depthOnlySubMeshes.length;index++){renderSubMesh(depthOnlySubMeshes.data[index])}engine.setColorWrite(true)}for(index=0;index<opaqueSubMeshes.length;index++){renderSubMesh(opaqueSubMeshes.data[index])}for(index=0;index<alphaTestSubMeshes.length;index++){renderSubMesh(alphaTestSubMeshes.data[index])}for(index=0;index<transparentSubMeshes.length;index++){renderSubMesh(transparentSubMeshes.data[index])}};this._mainTexture.onClearObservable.add(function(engine){engine.clear(HighlightLayer.neutralColor,true,true,true)})};HighlightLayer.prototype.isReady=function(subMesh,useInstances,emissiveTexture){if(!subMesh.getMaterial().isReady(subMesh.getMesh(),useInstances)){return false}var defines=[];var attribs=[BABYLON.VertexBuffer.PositionKind];var mesh=subMesh.getMesh();var material=subMesh.getMaterial();var uv1=false;var uv2=false;if(material&&material.needAlphaTesting()){var alphaTexture=material.getAlphaTestTexture();if(alphaTexture){defines.push("#define ALPHATEST");if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)&&alphaTexture.coordinatesIndex===1){defines.push("#define DIFFUSEUV2");uv2=true}else if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){defines.push("#define DIFFUSEUV1");uv1=true}}}if(emissiveTexture){defines.push("#define EMISSIVE");if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)&&emissiveTexture.coordinatesIndex===1){defines.push("#define EMISSIVEUV2");uv2=true}else if(mesh.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)){defines.push("#define EMISSIVEUV1");uv1=true}}if(uv1){attribs.push(BABYLON.VertexBuffer.UVKind);defines.push("#define UV1")}if(uv2){attribs.push(BABYLON.VertexBuffer.UV2Kind);defines.push("#define UV2")}if(mesh.useBones&&mesh.computeBonesUsingShaders){attribs.push(BABYLON.VertexBuffer.MatricesIndicesKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsKind);if(mesh.numBoneInfluencers>4){attribs.push(BABYLON.VertexBuffer.MatricesIndicesExtraKind);attribs.push(BABYLON.VertexBuffer.MatricesWeightsExtraKind)}defines.push("#define NUM_BONE_INFLUENCERS "+mesh.numBoneInfluencers);defines.push("#define BonesPerMesh "+(mesh.skeleton.bones.length+1))}else{defines.push("#define NUM_BONE_INFLUENCERS 0")}if(useInstances){defines.push("#define INSTANCES");attribs.push("world0");attribs.push("world1");attribs.push("world2");attribs.push("world3")}var join=defines.join("\n");if(this._cachedDefines!==join){this._cachedDefines=join;this._glowMapGenerationEffect=this._scene.getEngine().createEffect("glowMapGeneration",attribs,["world","mBones","viewProjection","diffuseMatrix","color","emissiveMatrix"],["diffuseSampler","emissiveSampler"],join)}return this._glowMapGenerationEffect.isReady()};HighlightLayer.prototype.render=function(){var currentEffect=this._glowMapMergeEffect;if(!currentEffect.isReady()||!this._blurTexture.isReady())return;var engine=this._scene.getEngine();this.onBeforeComposeObservable.notifyObservers(this);engine.enableEffect(currentEffect);engine.setState(false);var previousStencilBuffer=engine.getStencilBuffer();var previousStencilFunction=engine.getStencilFunction();var previousStencilMask=engine.getStencilMask();var previousStencilOperationPass=engine.getStencilOperationPass();var previousStencilOperationFail=engine.getStencilOperationFail();var previousStencilOperationDepthFail=engine.getStencilOperationDepthFail();var previousAlphaMode=engine.getAlphaMode();currentEffect.setTexture("textureSampler",this._blurTexture);engine.bindBuffers(this._vertexBuffers,this._indexBuffer,currentEffect);engine.setStencilOperationPass(BABYLON.Engine.REPLACE);engine.setStencilOperationFail(BABYLON.Engine.KEEP);engine.setStencilOperationDepthFail(BABYLON.Engine.KEEP);engine.setAlphaMode(this._options.alphaBlendingMode);engine.setStencilMask(0);engine.setStencilBuffer(true);engine.setStencilFunctionReference(this._instanceGlowingMeshStencilReference);if(this.outerGlow){currentEffect.setFloat("offset",0);engine.setStencilFunction(BABYLON.Engine.NOTEQUAL);engine.draw(true,0,6)}if(this.innerGlow){currentEffect.setFloat("offset",1);engine.setStencilFunction(BABYLON.Engine.EQUAL);engine.draw(true,0,6)}engine.setStencilFunction(previousStencilFunction);engine.setStencilMask(previousStencilMask);engine.setAlphaMode(previousAlphaMode);engine.setStencilBuffer(previousStencilBuffer);engine.setStencilOperationPass(previousStencilOperationPass);engine.setStencilOperationFail(previousStencilOperationFail);engine.setStencilOperationDepthFail(previousStencilOperationDepthFail);engine._stencilState.reset();this.onAfterComposeObservable.notifyObservers(this);var size=this._mainTexture.getSize();this.setMainTextureSize();if(size.width!==this._mainTextureDesiredSize.width||size.height!==this._mainTextureDesiredSize.height){this.onSizeChangedObservable.notifyObservers(this);this.disposeTextureAndPostProcesses();this.createTextureAndPostProcesses()}};HighlightLayer.prototype.addExcludedMesh=function(mesh){var meshExcluded=this._excludedMeshes[mesh.uniqueId];if(!meshExcluded){this._excludedMeshes[mesh.uniqueId]={mesh:mesh,beforeRender:mesh.onBeforeRenderObservable.add(function(mesh){mesh.getEngine().setStencilBuffer(false)}),afterRender:mesh.onAfterRenderObservable.add(function(mesh){mesh.getEngine().setStencilBuffer(true)})}}};HighlightLayer.prototype.removeExcludedMesh=function(mesh){var meshExcluded=this._excludedMeshes[mesh.uniqueId];if(meshExcluded){mesh.onBeforeRenderObservable.remove(meshExcluded.beforeRender);mesh.onAfterRenderObservable.remove(meshExcluded.afterRender)}this._excludedMeshes[mesh.uniqueId]=undefined};HighlightLayer.prototype.addMesh=function(mesh,color,glowEmissiveOnly){var _this=this;if(glowEmissiveOnly===void 0){glowEmissiveOnly=false}var meshHighlight=this._meshes[mesh.uniqueId];if(meshHighlight){meshHighlight.color=color}else{this._meshes[mesh.uniqueId]={mesh:mesh,color:color,observerHighlight:mesh.onBeforeRenderObservable.add(function(mesh){if(_this._excludedMeshes[mesh.uniqueId]){_this.defaultStencilReference(mesh)}else{mesh.getScene().getEngine().setStencilFunctionReference(_this._instanceGlowingMeshStencilReference)}}),observerDefault:mesh.onAfterRenderObservable.add(this.defaultStencilReference),glowEmissiveOnly:glowEmissiveOnly}}this._shouldRender=true};HighlightLayer.prototype.removeMesh=function(mesh){var meshHighlight=this._meshes[mesh.uniqueId];if(meshHighlight){mesh.onBeforeRenderObservable.remove(meshHighlight.observerHighlight);mesh.onAfterRenderObservable.remove(meshHighlight.observerDefault)}this._meshes[mesh.uniqueId]=undefined;this._shouldRender=false;for(var meshHighlightToCheck in this._meshes){if(meshHighlightToCheck){this._shouldRender=true;break}}};HighlightLayer.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender};HighlightLayer.prototype.setMainTextureSize=function(){if(this._options.mainTextureFixedSize){this._mainTextureDesiredSize.width=this._options.mainTextureFixedSize;this._mainTextureDesiredSize.height=this._options.mainTextureFixedSize}else{this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._options.mainTextureRatio;this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._options.mainTextureRatio;this._mainTextureDesiredSize.width=this._engine.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width;this._mainTextureDesiredSize.height=this._engine.needPOTTextures?BABYLON.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height}};HighlightLayer.prototype.defaultStencilReference=function(mesh){mesh.getScene().getEngine().setStencilFunctionReference(HighlightLayer.normalMeshStencilReference)};HighlightLayer.prototype.disposeTextureAndPostProcesses=function(){this._blurTexture.dispose();this._mainTexture.dispose();this._downSamplePostprocess.dispose();this._horizontalBlurPostprocess.dispose();this._verticalBlurPostprocess.dispose()};HighlightLayer.prototype.dispose=function(){var vertexBuffer=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind];if(vertexBuffer){vertexBuffer.dispose();this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}this.disposeTextureAndPostProcesses();for(var id in this._meshes){var meshHighlight=this._meshes[id];if(meshHighlight&&meshHighlight.mesh){meshHighlight.mesh.onBeforeRenderObservable.remove(meshHighlight.observerHighlight);meshHighlight.mesh.onAfterRenderObservable.remove(meshHighlight.observerDefault)}}this._meshes=null;for(var id in this._excludedMeshes){var meshHighlight=this._excludedMeshes[id];if(meshHighlight){meshHighlight.mesh.onBeforeRenderObservable.remove(meshHighlight.beforeRender);meshHighlight.mesh.onAfterRenderObservable.remove(meshHighlight.afterRender)}}this._excludedMeshes=null;var index=this._scene.highlightLayers.indexOf(this,0);if(index>-1){this._scene.highlightLayers.splice(index,1)}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBeforeRenderMainTextureObservable.clear();this.onBeforeBlurObservable.clear();this.onBeforeComposeObservable.clear();this.onAfterComposeObservable.clear();this.onSizeChangedObservable.clear()};HighlightLayer.neutralColor=new BABYLON.Color4(0,0,0,0);HighlightLayer.glowingMeshStencilReference=2;HighlightLayer.normalMeshStencilReference=1;return HighlightLayer}();BABYLON.HighlightLayer=HighlightLayer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var AssetTaskState;(function(AssetTaskState){AssetTaskState[AssetTaskState["INIT"]=0]="INIT";AssetTaskState[AssetTaskState["RUNNING"]=1]="RUNNING";AssetTaskState[AssetTaskState["DONE"]=2]="DONE";AssetTaskState[AssetTaskState["ERROR"]=3]="ERROR"})(AssetTaskState=BABYLON.AssetTaskState||(BABYLON.AssetTaskState={}));var AbstractAssetTask=function(){function AbstractAssetTask(){this.isCompleted=false;this.taskState=AssetTaskState.INIT}AbstractAssetTask.prototype.run=function(scene,onSuccess,onError){var _this=this;this.taskState=AssetTaskState.RUNNING;this.runTask(scene,function(){_this.onDoneCallback(onSuccess,onError)},function(msg,exception){_this.onErrorCallback(onError,msg,exception)})};AbstractAssetTask.prototype.runTask=function(scene,onSuccess,onError){throw new Error("runTask is not implemented")};AbstractAssetTask.prototype.onErrorCallback=function(onError,message,exception){this.taskState=AssetTaskState.ERROR;this.errorObject={message:message,exception:exception};if(this.onError){this.onError(this,message,exception)}onError()};AbstractAssetTask.prototype.onDoneCallback=function(onSuccess,onError){try{this.taskState=AssetTaskState.DONE;this.isCompleted=true;if(this.onSuccess){this.onSuccess(this)}onSuccess()}catch(e){this.onErrorCallback(onError,"Task is done, error executing success callback(s)",e)}};return AbstractAssetTask}();BABYLON.AbstractAssetTask=AbstractAssetTask;var MeshAssetTask=function(_super){__extends(MeshAssetTask,_super);function MeshAssetTask(name,meshesNames,rootUrl,sceneFilename){var _this=_super.call(this)||this;_this.name=name;_this.meshesNames=meshesNames;_this.rootUrl=rootUrl;_this.sceneFilename=sceneFilename;return _this}MeshAssetTask.prototype.runTask=function(scene,onSuccess,onError){var _this=this;BABYLON.SceneLoader.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,scene,function(meshes,particleSystems,skeletons){_this.loadedMeshes=meshes;_this.loadedParticleSystems=particleSystems;_this.loadedSkeletons=skeletons;onSuccess()},null,function(scene,message,exception){onError(message,exception)})};return MeshAssetTask}(AbstractAssetTask);BABYLON.MeshAssetTask=MeshAssetTask;var TextFileAssetTask=function(_super){__extends(TextFileAssetTask,_super);function TextFileAssetTask(name,url){var _this=_super.call(this)||this;_this.name=name;_this.url=url;return _this}TextFileAssetTask.prototype.runTask=function(scene,onSuccess,onError){var _this=this;BABYLON.Tools.LoadFile(this.url,function(data){_this.text=data;onSuccess()},null,scene.database,false,function(request,exception){onError(request.status+" "+request.statusText,exception)})};return TextFileAssetTask}(AbstractAssetTask);BABYLON.TextFileAssetTask=TextFileAssetTask;var BinaryFileAssetTask=function(_super){__extends(BinaryFileAssetTask,_super);function BinaryFileAssetTask(name,url){var _this=_super.call(this)||this;_this.name=name;_this.url=url;return _this}BinaryFileAssetTask.prototype.runTask=function(scene,onSuccess,onError){var _this=this;BABYLON.Tools.LoadFile(this.url,function(data){_this.data=data;onSuccess()},null,scene.database,true,function(request,exception){onError(request.status+" "+request.statusText,exception)})};return BinaryFileAssetTask}(AbstractAssetTask);BABYLON.BinaryFileAssetTask=BinaryFileAssetTask;var ImageAssetTask=function(_super){__extends(ImageAssetTask,_super);function ImageAssetTask(name,url){var _this=_super.call(this)||this;_this.name=name;_this.url=url;return _this}ImageAssetTask.prototype.runTask=function(scene,onSuccess,onError){var _this=this;var img=new Image;BABYLON.Tools.SetCorsBehavior(this.url,img);img.onload=function(){_this.image=img;onSuccess()};img.onerror=function(err){onError("Error loading image",err)};img.src=this.url};return ImageAssetTask}(AbstractAssetTask);BABYLON.ImageAssetTask=ImageAssetTask;var TextureAssetTask=function(_super){__extends(TextureAssetTask,_super);function TextureAssetTask(name,url,noMipmap,invertY,samplingMode){if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}var _this=_super.call(this)||this;_this.name=name;_this.url=url;_this.noMipmap=noMipmap;_this.invertY=invertY;_this.samplingMode=samplingMode;return _this}TextureAssetTask.prototype.runTask=function(scene,onSuccess,onError){var onload=function(){onSuccess()};var onerror=function(msg,exception){onError(msg,exception)};this.texture=new BABYLON.Texture(this.url,scene,this.noMipmap,this.invertY,this.samplingMode,onload,onerror)};return TextureAssetTask}(AbstractAssetTask);BABYLON.TextureAssetTask=TextureAssetTask;var CubeTextureAssetTask=function(_super){__extends(CubeTextureAssetTask,_super);function CubeTextureAssetTask(name,url,extensions,noMipmap,files){var _this=_super.call(this)||this;_this.name=name;_this.url=url;_this.extensions=extensions;_this.noMipmap=noMipmap;_this.files=files;return _this}CubeTextureAssetTask.prototype.runTask=function(scene,onSuccess,onError){var onload=function(){onSuccess()};var onerror=function(msg,exception){onError(msg,exception)};this.texture=new BABYLON.CubeTexture(this.url,scene,this.extensions,this.noMipmap,this.files,onload,onerror)};return CubeTextureAssetTask}(AbstractAssetTask);BABYLON.CubeTextureAssetTask=CubeTextureAssetTask;var HDRCubeTextureAssetTask=function(_super){__extends(HDRCubeTextureAssetTask,_super);function HDRCubeTextureAssetTask(name,url,size,noMipmap,generateHarmonics,useInGammaSpace,usePMREMGenerator){if(noMipmap===void 0){noMipmap=false}if(generateHarmonics===void 0){generateHarmonics=true}if(useInGammaSpace===void 0){useInGammaSpace=false}if(usePMREMGenerator===void 0){usePMREMGenerator=false}var _this=_super.call(this)||this;_this.name=name;_this.url=url;_this.size=size;_this.noMipmap=noMipmap;_this.generateHarmonics=generateHarmonics;_this.useInGammaSpace=useInGammaSpace;_this.usePMREMGenerator=usePMREMGenerator;return _this}HDRCubeTextureAssetTask.prototype.run=function(scene,onSuccess,onError){var onload=function(){onSuccess()};var onerror=function(message,exception){onError(message,exception)};this.texture=new BABYLON.HDRCubeTexture(this.url,scene,this.size,this.noMipmap,this.generateHarmonics,this.useInGammaSpace,this.usePMREMGenerator,onload,onerror)};return HDRCubeTextureAssetTask}(AbstractAssetTask);BABYLON.HDRCubeTextureAssetTask=HDRCubeTextureAssetTask;var AssetsManager=function(){function AssetsManager(scene){this.tasks=new Array;this.waitingTasksCount=0;this.onTaskSuccessObservable=new BABYLON.Observable;this.onTaskErrorObservable=new BABYLON.Observable;this.onTasksDoneObservable=new BABYLON.Observable;this.useDefaultLoadingScreen=true;this._scene=scene}AssetsManager.prototype.addMeshTask=function(taskName,meshesNames,rootUrl,sceneFilename){var task=new MeshAssetTask(taskName,meshesNames,rootUrl,sceneFilename);this.tasks.push(task);return task};AssetsManager.prototype.addTextFileTask=function(taskName,url){var task=new TextFileAssetTask(taskName,url);this.tasks.push(task);return task};AssetsManager.prototype.addBinaryFileTask=function(taskName,url){var task=new BinaryFileAssetTask(taskName,url);this.tasks.push(task);return task};AssetsManager.prototype.addImageTask=function(taskName,url){var task=new ImageAssetTask(taskName,url);this.tasks.push(task);return task};AssetsManager.prototype.addTextureTask=function(taskName,url,noMipmap,invertY,samplingMode){if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}var task=new TextureAssetTask(taskName,url,noMipmap,invertY,samplingMode);this.tasks.push(task);return task};AssetsManager.prototype.addCubeTextureTask=function(name,url,extensions,noMipmap,files){var task=new CubeTextureAssetTask(name,url,extensions,noMipmap,files);this.tasks.push(task);return task};AssetsManager.prototype.addHDRCubeTextureTask=function(name,url,size,noMipmap,generateHarmonics,useInGammaSpace,usePMREMGenerator){if(noMipmap===void 0){noMipmap=false}if(generateHarmonics===void 0){generateHarmonics=true}if(useInGammaSpace===void 0){useInGammaSpace=false}if(usePMREMGenerator===void 0){usePMREMGenerator=false}var task=new HDRCubeTextureAssetTask(name,url,size,noMipmap,generateHarmonics,useInGammaSpace,usePMREMGenerator);this.tasks.push(task);return task};AssetsManager.prototype._decreaseWaitingTasksCount=function(){this.waitingTasksCount--;if(this.waitingTasksCount===0){try{if(this.onFinish){this.onFinish(this.tasks)}this.onTasksDoneObservable.notifyObservers(this.tasks)}catch(e){BABYLON.Tools.Error("Error running tasks-done callbacks.");console.log(e)}this._scene.getEngine().hideLoadingUI()}};AssetsManager.prototype._runTask=function(task){var _this=this;var done=function(){try{if(_this.onTaskSuccess){_this.onTaskSuccess(task)}_this.onTaskSuccessObservable.notifyObservers(task);_this._decreaseWaitingTasksCount()}catch(e){error("Error executing task success callbacks",e)}};var error=function(message,exception){task.errorObject=task.errorObject||{message:message,exception:exception};if(_this.onTaskError){_this.onTaskError(task)}_this.onTaskErrorObservable.notifyObservers(task);_this._decreaseWaitingTasksCount()};task.run(this._scene,done,error)};AssetsManager.prototype.reset=function(){this.tasks=new Array;return this};AssetsManager.prototype.load=function(){this.waitingTasksCount=this.tasks.length;if(this.waitingTasksCount===0){if(this.onFinish){this.onFinish(this.tasks)}this.onTasksDoneObservable.notifyObservers(this.tasks);return this}if(this.useDefaultLoadingScreen){this._scene.getEngine().displayLoadingUI()}for(var index=0;index<this.tasks.length;index++){var task=this.tasks[index];this._runTask(task)}return this};return AssetsManager}();BABYLON.AssetsManager=AssetsManager})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var MapTexture=function(_super){__extends(MapTexture,_super);function MapTexture(name,scene,size,samplingMode,useMipMap,margin){if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}if(useMipMap===void 0){useMipMap=false}if(margin===void 0){margin=0}var _this=_super.call(this,null,scene,!useMipMap,false,samplingMode)||this;_this.name=name;_this._size=size;_this.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;_this.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;_this._rectPackingMap=new BABYLON.RectPackingMap(new BABYLON.Size(size.width,size.height),margin);_this._texture=scene.getEngine().createRenderTargetTexture(size,{generateMipMaps:!_this.noMipmap,type:BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT});return _this}MapTexture.prototype.allocateRect=function(size){return this._rectPackingMap.addRect(size)};MapTexture.prototype.freeRect=function(rectInfo){if(rectInfo){rectInfo.freeContent()}};Object.defineProperty(MapTexture.prototype,"freeSpace",{get:function(){return this._rectPackingMap.freeSpace},enumerable:true,configurable:true});MapTexture.prototype.bindTextureForRect=function(rect,clear){return this.bindTextureForPosSize(rect.pos,rect.contentSize,clear)};MapTexture.prototype.bindTextureForPosSize=function(pos,size,clear){var engine=this.getScene().getEngine();engine.bindFramebuffer(this._texture);this._replacedViewport=engine.setDirectViewport(pos.x,pos.y,size.width,size.height);if(clear){engine.scissorClear(pos.x,pos.y,size.width,size.height,new BABYLON.Color4(0,0,0,0))}};MapTexture.prototype.unbindTexture=function(dumpForDebug){if(dumpForDebug){BABYLON.Tools.DumpFramebuffer(this._size.width,this._size.height,this.getScene().getEngine())}var engine=this.getScene().getEngine();if(this._replacedViewport){engine.setViewport(this._replacedViewport);this._replacedViewport=null}engine.unBindFramebuffer(this._texture)};Object.defineProperty(MapTexture.prototype,"canRescale",{get:function(){return false},enumerable:true,configurable:true});MapTexture.prototype.clone=function(){return null};return MapTexture}(BABYLON.Texture);BABYLON.MapTexture=MapTexture})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var PackedRect=function(){function PackedRect(root,parent,pos,size){this._pos=pos;this._size=size;this._root=root;this._parent=parent;this._contentSize=null;this._bottomNode=null;this._leftNode=null;this._initialSize=null;this._rightNode=null}Object.defineProperty(PackedRect.prototype,"pos",{get:function(){return this._pos},enumerable:true,configurable:true});Object.defineProperty(PackedRect.prototype,"contentSize",{get:function(){return this._contentSize},enumerable:true,configurable:true});PackedRect.prototype.getInnerPosToRef=function(res){var m=this._root._margin;res.x=this._pos.x+m;res.y=this._pos.y+m};PackedRect.prototype.getInnerSizeToRef=function(res){var m=this._root._margin;res.width=this._contentSize.width-m*2;res.height=this._contentSize.height-m*2};Object.defineProperty(PackedRect.prototype,"UVs",{get:function(){if(!this._contentSize){throw new Error("Can't compute UVs for this object because it's nor allocated")}return this.getUVsForCustomSize(this._contentSize)},enumerable:true,configurable:true});PackedRect.prototype.getUVsForCustomSize=function(customSize){var mainWidth=this._root._size.width;var mainHeight=this._root._size.height;var margin=this._root._margin;var topLeft=new BABYLON.Vector2((this._pos.x+margin)/mainWidth,(this._pos.y+margin)/mainHeight);var rightBottom=new BABYLON.Vector2((this._pos.x+customSize.width+margin-1)/mainWidth,(this._pos.y+customSize.height+margin-1)/mainHeight);var uvs=new Array;uvs.push(topLeft);uvs.push(new BABYLON.Vector2(rightBottom.x,topLeft.y));uvs.push(rightBottom);uvs.push(new BABYLON.Vector2(topLeft.x,rightBottom.y));return uvs};PackedRect.prototype.freeContent=function(){if(!this.contentSize){return}this._contentSize=null;this.attemptDefrag()};Object.defineProperty(PackedRect.prototype,"isUsed",{get:function(){return this._contentSize!=null||this._leftNode!=null},enumerable:true,configurable:true});PackedRect.prototype.findAndSplitNode=function(contentSize){var node=this.findNode(contentSize);if(!node){return null}node.splitNode(contentSize);return node};PackedRect.prototype.findNode=function(size){var resNode=null;var margin=this._root._margin*2;if(this.isUsed){if(this._leftNode){resNode=this._leftNode.findNode(size)}if(!resNode&&this._rightNode){resNode=this._rightNode.findNode(size)}if(!resNode&&this._bottomNode){resNode=this._bottomNode.findNode(size)}}else if(this._initialSize){if(size.width+margin<=this._initialSize.width&&size.height+margin<=this._initialSize.height){resNode=this}else{return null}}else if(size.width+margin<=this._size.width&&size.height+margin<=this._size.height){resNode=this}return resNode};PackedRect.prototype.splitNode=function(contentSize){var cs=PackedRect.TpsSize;var margin=this._root._margin*2;cs.copyFrom(contentSize);cs.width+=margin;cs.height+=margin;if(!this._contentSize&&this._initialSize){this._contentSize=cs.clone();this._leftNode=new PackedRect(this._root,this,new BABYLON.Vector2(this._pos.x,this._pos.y),new BABYLON.Size(this._initialSize.width,this._initialSize.height));return this._leftNode.splitNode(contentSize)}else{this._contentSize=cs.clone();this._initialSize=cs.clone();if(cs.width!==this._size.width){this._rightNode=new PackedRect(this._root,this,new BABYLON.Vector2(this._pos.x+cs.width,this._pos.y),new BABYLON.Size(this._size.width-cs.width,cs.height))}if(cs.height!==this._size.height){this._bottomNode=new PackedRect(this._root,this,new BABYLON.Vector2(this._pos.x,this._pos.y+cs.height),new BABYLON.Size(this._size.width,this._size.height-cs.height))}return this}};PackedRect.prototype.attemptDefrag=function(){if(!this.isUsed&&this.isRecursiveFree){this.clearNode();if(this._parent){this._parent.attemptDefrag()}}};PackedRect.prototype.clearNode=function(){this._initialSize=null;this._rightNode=null;this._bottomNode=null};Object.defineProperty(PackedRect.prototype,"isRecursiveFree",{get:function(){return!this.contentSize&&(!this._leftNode||this._leftNode.isRecursiveFree)&&(!this._rightNode||this._rightNode.isRecursiveFree)&&(!this._bottomNode||this._bottomNode.isRecursiveFree)},enumerable:true,configurable:true});PackedRect.prototype.evalFreeSize=function(size){var levelSize=0;if(!this.isUsed){var margin=this._root._margin;var is=this._initialSize;if(is){levelSize=is.surface-is.width*margin-is.height*margin}else{var size_1=this._size;levelSize=size_1.surface-size_1.width*margin-size_1.height*margin}}if(this._rightNode){levelSize+=this._rightNode.evalFreeSize(0)}if(this._bottomNode){levelSize+=this._bottomNode.evalFreeSize(0)}return levelSize+size};PackedRect.TpsSize=BABYLON.Size.Zero();return PackedRect}();BABYLON.PackedRect=PackedRect;var RectPackingMap=function(_super){__extends(RectPackingMap,_super);function RectPackingMap(size,margin){if(margin===void 0){margin=0}var _this=_super.call(this,null,null,BABYLON.Vector2.Zero(),size)||this;_this._margin=margin;_this._root=_this;return _this}RectPackingMap.prototype.addRect=function(size){var node=this.findAndSplitNode(size);return node};Object.defineProperty(RectPackingMap.prototype,"freeSpace",{get:function(){var freeSize=0;freeSize=this.evalFreeSize(freeSize);return freeSize/(this._size.width*this._size.height)},enumerable:true,configurable:true});return RectPackingMap}(PackedRect);BABYLON.RectPackingMap=RectPackingMap})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var serializedGeometries=[];var serializeGeometry=function(geometry,serializationGeometries){if(serializedGeometries[geometry.id]){return}if(geometry.doNotSerialize){return}if(geometry instanceof BABYLON.Geometry.Primitives.Box){serializationGeometries.boxes.push(geometry.serialize())}else if(geometry instanceof BABYLON.Geometry.Primitives.Sphere){serializationGeometries.spheres.push(geometry.serialize())}else if(geometry instanceof BABYLON.Geometry.Primitives.Cylinder){serializationGeometries.cylinders.push(geometry.serialize())}else if(geometry instanceof BABYLON.Geometry.Primitives.Torus){serializationGeometries.toruses.push(geometry.serialize())}else if(geometry instanceof BABYLON.Geometry.Primitives.Ground){serializationGeometries.grounds.push(geometry.serialize())}else if(geometry instanceof BABYLON.Geometry.Primitives.Plane){serializationGeometries.planes.push(geometry.serialize())}else if(geometry instanceof BABYLON.Geometry.Primitives.TorusKnot){serializationGeometries.torusKnots.push(geometry.serialize())}else if(geometry instanceof BABYLON.Geometry.Primitives._Primitive){throw new Error("Unknown primitive type")}else{serializationGeometries.vertexData.push(geometry.serializeVerticeData())}serializedGeometries[geometry.id]=true};var serializeMesh=function(mesh,serializationScene){var serializationObject={};var geometry=mesh._geometry;if(geometry){if(!mesh.getScene().getGeometryByID(geometry.id)){serializeGeometry(geometry,serializationScene.geometries)}}if(mesh.serialize){mesh.serialize(serializationObject)}return serializationObject};var finalizeSingleMesh=function(mesh,serializationObject){if(mesh.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADED||mesh.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_NONE){if(mesh.material){if(mesh.material instanceof BABYLON.StandardMaterial){serializationObject.materials=serializationObject.materials||[];if(!serializationObject.materials.some(function(mat){return mat.id===mesh.material.id})){serializationObject.materials.push(mesh.material.serialize())}}else if(mesh.material instanceof BABYLON.MultiMaterial){serializationObject.multiMaterials=serializationObject.multiMaterials||[];if(!serializationObject.multiMaterials.some(function(mat){return mat.id===mesh.material.id})){serializationObject.multiMaterials.push(mesh.material.serialize())}}}var geometry=mesh._geometry;if(geometry){if(!serializationObject.geometries){serializationObject.geometries={};serializationObject.geometries.boxes=[];serializationObject.geometries.spheres=[];serializationObject.geometries.cylinders=[];serializationObject.geometries.toruses=[];serializationObject.geometries.grounds=[];serializationObject.geometries.planes=[];serializationObject.geometries.torusKnots=[];serializationObject.geometries.vertexData=[]}serializeGeometry(geometry,serializationObject.geometries)}if(mesh.skeleton){serializationObject.skeletons=serializationObject.skeletons||[];serializationObject.skeletons.push(mesh.skeleton.serialize())}serializationObject.meshes=serializationObject.meshes||[];serializationObject.meshes.push(serializeMesh(mesh,serializationObject))}};var SceneSerializer=function(){function SceneSerializer(){}SceneSerializer.ClearCache=function(){serializedGeometries=[]};SceneSerializer.Serialize=function(scene){var serializationObject={};SceneSerializer.ClearCache();serializationObject.useDelayedTextureLoading=scene.useDelayedTextureLoading;serializationObject.autoClear=scene.autoClear;serializationObject.clearColor=scene.clearColor.asArray();serializationObject.ambientColor=scene.ambientColor.asArray();serializationObject.gravity=scene.gravity.asArray();serializationObject.collisionsEnabled=scene.collisionsEnabled;serializationObject.workerCollisions=scene.workerCollisions;if(scene.fogMode&&scene.fogMode!==0){serializationObject.fogMode=scene.fogMode;serializationObject.fogColor=scene.fogColor.asArray();serializationObject.fogStart=scene.fogStart;serializationObject.fogEnd=scene.fogEnd;serializationObject.fogDensity=scene.fogDensity}if(scene.isPhysicsEnabled()){serializationObject.physicsEnabled=true;serializationObject.physicsGravity=scene.getPhysicsEngine().gravity.asArray();serializationObject.physicsEngine=scene.getPhysicsEngine().getPhysicsPluginName()}if(scene.metadata){serializationObject.metadata=scene.metadata}serializationObject.morphTargetManagers=[];for(var _i=0,_a=scene.meshes;_i<_a.length;_i++){var abstractMesh=_a[_i];var manager=abstractMesh.morphTargetManager;if(manager){serializationObject.morphTargetManagers.push(manager.serialize())}}serializationObject.lights=[];var index;var light;for(index=0;index<scene.lights.length;index++){light=scene.lights[index];if(!light.doNotSerialize){serializationObject.lights.push(light.serialize())}}serializationObject.cameras=[];for(index=0;index<scene.cameras.length;index++){var camera=scene.cameras[index];if(!camera.doNotSerialize){serializationObject.cameras.push(camera.serialize())}}if(scene.activeCamera){serializationObject.activeCameraID=scene.activeCamera.id}BABYLON.Animation.AppendSerializedAnimations(scene,serializationObject);serializationObject.materials=[];serializationObject.multiMaterials=[];var material;for(index=0;index<scene.materials.length;index++){material=scene.materials[index];if(!material.doNotSerialize){serializationObject.materials.push(material.serialize())}}serializationObject.multiMaterials=[];for(index=0;index<scene.multiMaterials.length;index++){var multiMaterial=scene.multiMaterials[index];serializationObject.multiMaterials.push(multiMaterial.serialize())}serializationObject.skeletons=[];for(index=0;index<scene.skeletons.length;index++){serializationObject.skeletons.push(scene.skeletons[index].serialize())}serializationObject.geometries={};serializationObject.geometries.boxes=[];serializationObject.geometries.spheres=[];serializationObject.geometries.cylinders=[];serializationObject.geometries.toruses=[];serializationObject.geometries.grounds=[];serializationObject.geometries.planes=[];serializationObject.geometries.torusKnots=[];serializationObject.geometries.vertexData=[];serializedGeometries=[];var geometries=scene.getGeometries();for(index=0;index<geometries.length;index++){var geometry=geometries[index];if(geometry.isReady()){serializeGeometry(geometry,serializationObject.geometries)}}serializationObject.meshes=[];for(index=0;index<scene.meshes.length;index++){var abstractMesh=scene.meshes[index];if(abstractMesh instanceof BABYLON.Mesh){var mesh=abstractMesh;if(!mesh.doNotSerialize){if(mesh.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADED||mesh.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_NONE){serializationObject.meshes.push(serializeMesh(mesh,serializationObject))}}}}serializationObject.particleSystems=[];for(index=0;index<scene.particleSystems.length;index++){serializationObject.particleSystems.push(scene.particleSystems[index].serialize())}serializationObject.lensFlareSystems=[];for(index=0;index<scene.lensFlareSystems.length;index++){serializationObject.lensFlareSystems.push(scene.lensFlareSystems[index].serialize())}serializationObject.shadowGenerators=[];for(index=0;index<scene.lights.length;index++){light=scene.lights[index];var shadowGenerator=light.getShadowGenerator();if(shadowGenerator){serializationObject.shadowGenerators.push(shadowGenerator.serialize())}}if(scene.actionManager){serializationObject.actions=scene.actionManager.serialize("scene")}serializationObject.sounds=[];for(index=0;index<scene.soundTracks.length;index++){var soundtrack=scene.soundTracks[index];for(var soundId=0;soundId<soundtrack.soundCollection.length;soundId++){serializationObject.sounds.push(soundtrack.soundCollection[soundId].serialize())}}return serializationObject};SceneSerializer.SerializeMesh=function(toSerialize,withParents,withChildren){if(withParents===void 0){withParents=false}if(withChildren===void 0){withChildren=false}var serializationObject={};SceneSerializer.ClearCache();toSerialize=toSerialize instanceof Array?toSerialize:[toSerialize];if(withParents||withChildren){for(var i=0;i<toSerialize.length;++i){if(withChildren){toSerialize[i].getDescendants().forEach(function(node){if(node instanceof BABYLON.Mesh&&toSerialize.indexOf(node)<0){toSerialize.push(node)}})}if(withParents&&toSerialize[i].parent&&toSerialize.indexOf(toSerialize[i].parent)<0){toSerialize.push(toSerialize[i].parent)}}}toSerialize.forEach(function(mesh){finalizeSingleMesh(mesh,serializationObject)});return serializationObject};return SceneSerializer}();BABYLON.SceneSerializer=SceneSerializer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var ReflectionProbe=function(){function ReflectionProbe(name,size,scene,generateMipMaps){if(generateMipMaps===void 0){generateMipMaps=true}var _this=this;this.name=name;this._viewMatrix=BABYLON.Matrix.Identity();this._target=BABYLON.Vector3.Zero();this._add=BABYLON.Vector3.Zero();this.invertYAxis=false;this.position=BABYLON.Vector3.Zero();this._scene=scene;this._scene.reflectionProbes.push(this);this._renderTargetTexture=new BABYLON.RenderTargetTexture(name,size,scene,generateMipMaps,true,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT,true);this._renderTargetTexture.onBeforeRenderObservable.add(function(faceIndex){switch(faceIndex){case 0:_this._add.copyFromFloats(1,0,0);break;case 1:_this._add.copyFromFloats(-1,0,0);break;case 2:_this._add.copyFromFloats(0,_this.invertYAxis?1:-1,0);break;case 3:_this._add.copyFromFloats(0,_this.invertYAxis?-1:1,0);break;case 4:_this._add.copyFromFloats(0,0,1);break;case 5:_this._add.copyFromFloats(0,0,-1);break}if(_this._attachedMesh){_this.position.copyFrom(_this._attachedMesh.getAbsolutePosition())}_this.position.addToRef(_this._add,_this._target);BABYLON.Matrix.LookAtLHToRef(_this.position,_this._target,BABYLON.Vector3.Up(),_this._viewMatrix);scene.setTransformMatrix(_this._viewMatrix,_this._projectionMatrix)});this._renderTargetTexture.onAfterUnbindObservable.add(function(){scene.updateTransformMatrix(true)});this._projectionMatrix=BABYLON.Matrix.PerspectiveFovLH(Math.PI/2,1,scene.activeCamera.minZ,scene.activeCamera.maxZ)}Object.defineProperty(ReflectionProbe.prototype,"samples",{get:function(){return this._renderTargetTexture.samples},set:function(value){this._renderTargetTexture.samples=value},enumerable:true,configurable:true});Object.defineProperty(ReflectionProbe.prototype,"refreshRate",{get:function(){return this._renderTargetTexture.refreshRate},set:function(value){this._renderTargetTexture.refreshRate=value},enumerable:true,configurable:true});ReflectionProbe.prototype.getScene=function(){return this._scene};Object.defineProperty(ReflectionProbe.prototype,"cubeTexture",{get:function(){return this._renderTargetTexture},enumerable:true,configurable:true});Object.defineProperty(ReflectionProbe.prototype,"renderList",{get:function(){return this._renderTargetTexture.renderList},enumerable:true,configurable:true});ReflectionProbe.prototype.attachToMesh=function(mesh){this._attachedMesh=mesh};ReflectionProbe.prototype.setRenderingAutoClearDepthStencil=function(renderingGroupId,autoClearDepthStencil){this._renderTargetTexture.setRenderingAutoClearDepthStencil(renderingGroupId,autoClearDepthStencil)};ReflectionProbe.prototype.dispose=function(){var index=this._scene.reflectionProbes.indexOf(this);if(index!==-1){this._scene.reflectionProbes.splice(index,1)}if(this._renderTargetTexture){this._renderTargetTexture.dispose();this._renderTargetTexture=null}};return ReflectionProbe}();BABYLON.ReflectionProbe=ReflectionProbe})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var Layer=function(){function Layer(name,imgUrl,scene,isBackground,color){this.name=name;this.scale=new BABYLON.Vector2(1,1);this.offset=new BABYLON.Vector2(0,0);this.alphaBlendingMode=BABYLON.Engine.ALPHA_COMBINE;this.layerMask=268435455;this._vertexBuffers={};this.onDisposeObservable=new BABYLON.Observable;this.onBeforeRenderObservable=new BABYLON.Observable;this.onAfterRenderObservable=new BABYLON.Observable;this.texture=imgUrl?new BABYLON.Texture(imgUrl,scene,true):null;this.isBackground=isBackground===undefined?true:isBackground;this.color=color===undefined?new BABYLON.Color4(1,1,1,1):color;this._scene=scene||BABYLON.Engine.LastCreatedScene;this._scene.layers.push(this);var engine=this._scene.getEngine();var vertices=[];vertices.push(1,1);vertices.push(-1,1);vertices.push(-1,-1);vertices.push(1,-1);var vertexBuffer=new BABYLON.VertexBuffer(engine,vertices,BABYLON.VertexBuffer.PositionKind,false,false,2);this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=vertexBuffer;this._createIndexBuffer();this._effect=engine.createEffect("layer",[BABYLON.VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],"");this._alphaTestEffect=engine.createEffect("layer",[BABYLON.VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],"#define ALPHATEST")}Object.defineProperty(Layer.prototype,"onDispose",{set:function(callback){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Layer.prototype,"onBeforeRender",{set:function(callback){if(this._onBeforeRenderObserver){this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver)}this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(callback)},enumerable:true,configurable:true});Object.defineProperty(Layer.prototype,"onAfterRender",{set:function(callback){if(this._onAfterRenderObserver){this.onAfterRenderObservable.remove(this._onAfterRenderObserver)}this._onAfterRenderObserver=this.onAfterRenderObservable.add(callback)},enumerable:true,configurable:true});Layer.prototype._createIndexBuffer=function(){var engine=this._scene.getEngine();var indices=[];indices.push(0);indices.push(1);indices.push(2);indices.push(0);indices.push(2);indices.push(3);this._indexBuffer=engine.createIndexBuffer(indices)};Layer.prototype._rebuild=function(){this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]._rebuild();this._createIndexBuffer()};Layer.prototype.render=function(){var currentEffect=this.alphaTest?this._alphaTestEffect:this._effect;if(!currentEffect.isReady()||!this.texture||!this.texture.isReady())return;var engine=this._scene.getEngine();this.onBeforeRenderObservable.notifyObservers(this);engine.enableEffect(currentEffect);engine.setState(false);currentEffect.setTexture("textureSampler",this.texture);currentEffect.setMatrix("textureMatrix",this.texture.getTextureMatrix());currentEffect.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a);currentEffect.setVector2("offset",this.offset);currentEffect.setVector2("scale",this.scale);engine.bindBuffers(this._vertexBuffers,this._indexBuffer,currentEffect);if(!this.alphaTest){engine.setAlphaMode(this.alphaBlendingMode);engine.draw(true,0,6);engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE)}else{engine.draw(true,0,6)}this.onAfterRenderObservable.notifyObservers(this)};Layer.prototype.dispose=function(){var vertexBuffer=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind];if(vertexBuffer){vertexBuffer.dispose();this._vertexBuffers[BABYLON.VertexBuffer.PositionKind]=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}if(this.texture){this.texture.dispose();this.texture=null}var index=this._scene.layers.indexOf(this);this._scene.layers.splice(index,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onAfterRenderObservable.clear();this.onBeforeRenderObservable.clear()};return Layer}();BABYLON.Layer=Layer})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var TextureTools=function(){function TextureTools(){}TextureTools.CreateResizedCopy=function(texture,width,height,useBilinearMode){if(useBilinearMode===void 0){useBilinearMode=true}var scene=texture.getScene();var engine=scene.getEngine();var rtt=new BABYLON.RenderTargetTexture("resized"+texture.name,{width:width,height:height},scene,!texture.noMipmap,true,texture._texture.type,false,texture._samplingMode,false);rtt.wrapU=texture.wrapU;rtt.wrapV=texture.wrapV;rtt.uOffset=texture.uOffset;rtt.vOffset=texture.vOffset;rtt.uScale=texture.uScale;rtt.vScale=texture.vScale;rtt.uAng=texture.uAng;rtt.vAng=texture.vAng;rtt.wAng=texture.wAng;rtt.coordinatesIndex=texture.coordinatesIndex;rtt.level=texture.level;rtt.anisotropicFilteringLevel=texture.anisotropicFilteringLevel;rtt._texture.isReady=false;texture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;texture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;var passPostProcess=new BABYLON.PassPostProcess("pass",1,null,useBilinearMode?BABYLON.Texture.BILINEAR_SAMPLINGMODE:BABYLON.Texture.NEAREST_SAMPLINGMODE,engine,false,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);passPostProcess.getEffect().executeWhenCompiled(function(){passPostProcess.onApply=function(effect){effect.setTexture("textureSampler",texture)};scene.postProcessManager.directRender([passPostProcess],rtt.getInternalTexture());engine.unBindFramebuffer(rtt.getInternalTexture());rtt.disposeFramebufferObjects();passPostProcess.dispose();rtt._texture.isReady=true});return rtt};TextureTools.GetEnvironmentBRDFTexture=function(scene){if(!scene._environmentBRDFTexture){var texture=BABYLON.Texture.CreateFromBase64String(this._environmentBRDFBase64Texture,"EnvironmentBRDFTexture",scene,true,false,BABYLON.Texture.BILINEAR_SAMPLINGMODE);texture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;texture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;scene._environmentBRDFTexture=texture}return scene._environmentBRDFTexture};TextureTools._environmentBRDFBase64Texture="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR4Xu19Z7PtTHbW1g3jMMbGmGDAZAMm5xxMLDAU0WSKWOQcCoqccw6eGdtgk4yNbZxnvvAL+Af8Af6AsQl+06ako9X36dXPSi3pnPu+cz/cOntL3S1pq5+w1mrpLs/eud9fvn27rf9evPPwFz+v22S7fGZ/n7/70G79J5/Xv/qzbLP+Pnvvoc/6Tz7jX/15/c62LfeH7fofbpfP3l/ct36Wf+u4+D37+XYb++G26LPsr/zFttnPuh37bm1bt0f7MvtlnOx4uv0H4fty8UUsz77rfn/57u32cgXvDv72eQf0tl0+G38b0Nf9K4Dl704MEfA16KsE8Gw9JgD+DQE8EA0DT2b7GwK4GHnF4a8iguXZt9/vL5/dbisJbEq/uwD5vIK/fbbAv4N9U/8nJIDNCazKvBLBGwdwu62OhajxmQSAx6gqNp5HCg9wPan2nwSNjhLD8ux/3u8vP3y7vbwDAYjtR8AzFyDqLu1Q+YEINnew23rPCYiKb+q/K7o4AVT4tg0t/h4ydJZfkQASQ/d5b9fZ/Z1ENmuPn/cwYCYEELBguKC3nRkCnE0AFOwOKCOAR/sH/L4hgFMpbSWP5dn/uN9ffs7t9mJ5cAHoBLTyszBAFJ/F/xIKdASw5wgaEWDMLySxAk4svf6L+4QAGPiJCziNAPb4f3UZ2dh/m+z7BK4SAPYrxf5FB6ABPgCUAfANAZwKyscc7IEA/vv9/uLzbreXzx9cQCMACAl00m8jAlF7ov6SCMQ8gJsMFFBnCECSg5H6TxJAU3vPAbwhgFfz9AABeOEDBcIbB3AqPzwQwH+731/8sNvt5Ydut5e3B2C/fG9P+jESgGz/RgxG9r9VAwTUUh0goQDafUz+DYnAnSha5l99Z1l/yQVswAZSGIAugNd/9xBgCw9E8aECkHUB22QPHIAVDlQdQAMWAibhBgZAasAVHUAI8Cqg96Tm0bj3VBS9jwd7IIBvuN9ffMHt9vLTbreXy+32QlwAhgMIeuNzKwOqCoB2Aa00KHE+EsIeDuj4H2N+Hf/TfAC6A4nhgQCQDDwiaKDXiq9KgBEJNPArAtCk0AEd2mpAizW3/lYIoANpBPg3BPA+hjs/9eXZV+0E8Bm32wsJA9aEoBCAuAABPiEAC/yDC4gSgRgKRHkAlgsI6v7iEFqJEMgBwb4BGkEfEEDnDlReoAP/SQRgOYIB+IYDMEE/SQBbXoLNr0jhq4qOZc0PHBSf5oKW519xvz//kbfby8+83V68ABfwniIBgwgQ/HoRUMv8w5qAoQqgk4DWQiCw+63eD8k/XAPQgK5s/5a5xzAAqgR6wY9k+ZEMtCOoJABb230hEHMFWQdgAl0Ap/+uc6tKBrrP/n0AuwfiNwTwNKguHHV5/qX3+/M1B/Ddb7cXax7g2e324vaQB3hhkMAW92tHoFb96cVAbimwkgQ0Vv7R+D8iACfuxzKfLvnNlAAjAsBwwP2MwLQAD9sbYJME0AFcg5uBPSAA0x0AobhtcDKDA0j3KYDhk7Hp8uKj9/vzH3C7vfget9uLT9nDgDUZuOYCLBJA8MNKPyGGIftPrL+4gy3eh5p/lwRUYYAs9Fn7tM/E9lvJwCH2DxJ/mPTr4nyyLiDtBgTAGCrgNuPzNuETgN+suEEAFhng9lkCoICMLH7V0isCeEMCxylrefkl9/uzz90J4NNUGLDmAnYXINUBrf5dCCAuQCcCvYVAYPk3G++VAveVfkIAFRLolgbr2F9ifP33pAqAV/fHRF4HcAS7AKlAAEIYFNwITOszs/wMsB6II4BXFZ0QwBsSOEYCDwTw2TsBfPrt9uLlqzCgcwFABI0EVCiANl8Uvq0JWNsi2JPZ/0YKsOiHxftsW4v51ZqAaBWgZf91PsBL/jFHwEqBR1cCiuJ3gAfCmCEA3cf8rmz8AMZHIoA3JDBPAsuHVgL4jNvt+UoCH34ggK0asIYBGArsAB7AD+reQgCl+GwZ8LaNlP3MEEDaSg4ACMGr/+ulwV4JsAEfLH42/vdKgWElAJ4QpBl+LAlKErHwt+oGMgTA2ngE4IUIOH3dGr/hAKT/m/UBdSJYPuVL7vflU26352sScCWAD+0EsCcDVxewKjfmAzAsENVn4EfgdySgnYB81yEAgL4RA8T8mTUASAAYBgylQAkL8K/+zL6rsl8qF6ArAeS7WRGoAB8Sf7isN/VZqTs6jQ5wXlweWfyqpQ8I4I0TmCCAT/3I/b48u92ef9bt9nwNAdZE4FoOFALYXcAGegkDMByAzzQEgJh+cAIs/legH0IA5QTCPADE+7ISkD0TgA/8sBIgLQfOgF/F9kPcr+J8fIYguyCILQRKgV4DNviOzoKqeJS0u4AA3pBAjQSWT//I/b5OmC0MWB3ASgBrGLA+IryvDNxCgRXo+wKhjgwk8bcTwUACsJ09ANRVAALwCxmEoFcrAUsuAJ4M1E8BDuHABAHomJ8RgACrZfQLyT9dBWi2OOEG9NJd/TDQ8HAQuBE97ZhjGKy6o+imnU+4gDckkCeB5cMfud/v6zr9Dz84gOdCAM/3JwQhF9CAD25gBWWz/8wNgMpj3K9Lfy0foMMBVffXyT4r+cceC9bvCcDFP0311QrATPkvWgosYQFLAuoqQEcQuw3v2si25F+M1RkZXLUU+CgBmCBOEsCbvECOBJbP+Oj9fv+u2+3Zp91uz9cy4Kfebs/3ROD6iPD2b10YJCXB+0PyrgsHdtBuRACfBeTN+uM+suJPSEDbfh3/oxPoHgwiC3/06j8Eutj69sAQqj++I0CUfvIpwCEvYCT90O4Pn1XsT5Ve1/+dcp9FBh3woqXBSEJkvjHHEOUPqJPAjUUCeOMGfCJYPvOj9/t7//d2e7YmAlcS2B3A8xcPYcBm/7ULEDIQew+5gS0EIEA31R8Uf6gAoBsgKwBd9ddvBBJAs6XARgLQXQ2o7T8+IETe+9eRACg7rhCMVgCiE8D4O9wOCb2ubOht1/vYd2ubzLlgKbBHEDSnAMfL6durVm8qBPwXWz7rY/f7/X/fbsvL2+3Zqv4QAjzfw4COAMAJbEC3wC8koBJ9lAhgxZ+4hi3Oh/f8dU8EqtV/JhHgWn9cC4CJQZXZp6GAk/1nawMkrrcqAiwPIIA2FwOB2oaAF5UkcX+GADBs0I5gsNbBQqCorJcFJjqWKvhNMjky0Aek7/LZH7vf3/vO2215vruAD91uz/dSYCOAPQzYkoD7vw34sFIQw4LNymNSUKk8Wv0hCYhkoJ74Q6BboO9eDKoWAHXvBiCvAdPZf4nt3QqA924AbfXV8t8uN4Bt2We029WkoErWpSoCSm11TM8AOYA5uRS4RAITIQDDavaYHxCcm5exfM7H7vd3v2N9McDt9uxDD//WKsAG/ue32/M1DEACuO3g1jkBsf57fqCL/7UbIISAio85AAG0VQEYiIC9DJTYfy/+Dx8HlpeDRK8G90IBHQbgWgD2WT8LoOJ7NyeA5JEkAwwxmuqzur5X6y+sBEwDMggrqoBNH7c68Puk/fI9Vwfwvx4e6H724oEA1iSg5AAaAewlweeyLmAnAHQCTfU1CTAH4GyTMt+QDMRFQFEYQB71lXUAOjHYlvTqh4N2xe5yASoh2PpaJUGDBDrLr9cGIDlY1l+vDlQOAQHckYMiA68KMFsGtOy65RCGsMIDT+QqJoD3yUwCy/f+6P3+7koAt50AXrwigM0FrIuEoBrwHMMAUhmQUKAlAwHo7VmAPURo9h/r//ozLv1V7/5v6wGMV4B3rwYPXEBqIZAQwp4TYDE+LQlqtQfw6my/LgsyZaeLg7wVgmDnWQ5AA5ZWCDRx7ECzyn3udgFptFCIgTlyFRMEUCKgA+O/jl2Xz/3o/f7Otz88QvpszQOsLmAPARoBSDVgud02AthdwPZ5BSxUBVr8L3kAVHrvs076KSLQi3/M9QCJ7H/G/rf4n8X41XIgcwHecuBMDgAe+BHA6uQgqnvbF5DB5hwUQM3vQgIWkKOVftH+gAC6cz0RXZ9MjmD5fh/ZCWCd1CsB7CSwhgArAUgIIC5AQoDOCewJwab+CH79WR4C0mQAZT4hEQS9DgfEztNkoEECDfi6FAhZflb6Q1XXqwHDEECpvZX4a0qP1l7bfAS98cQfzQUo9a4mASMC0CsIm6JGK/2i/QkCuFK9PxmIYPm8nQDu795uy3K7LTvwVyJAB7ARwJoAVLkA7QIkJ9A5AQS95Ad2YmgvAJWwQFcBpB38pUuB9wVKbAWgCXwV86Mz2ICKTwUWFgOxMEBicr0eoBwCGBUADfxsDsAiA+zflNay31ZcfnAdAAXgDGkcdAcfZCJYfuCX3O9vf/vtthHAmgcQF7ATwOoAtn9IACsRSDkQ/wqIIUGoXYEQQ/sL5IDJP539776DwodVAGlr5QBgP8sDdApP3gSUXQa8/rZsRaBeHmy+HwDyCI1MUNlZzX9iJSBO9igJGJYCo4RdIqMfJQ4Ztq8C7FXjHuSnQ92XH/yvdwJ4Z68ErOXAlQRW0O9/JRG42v9GBHsuAImAqv+uzDo30C3yAfVHoHeg9xyAp/7wlp+WFCSWv1sOTBb+0EoAZP5DImBrApAUMFHolQG19c+EAkbpjyUEdQ6gm/QEsCzZFxKDlWNwprJVWfBm/1WAvWrcQ0ie7Lz80H91v7/9v263+9sPI2zrAZAEdvXvXMBKBJIIFDcgyUAEvHICg/o7wA/Bvyt35wCc2F9Cg03RvRyAA34N8hD0xsIfXP7bQgDMFSgyYO8GsF4N/hQ5ALak1yUGRQDZZJ5VWXgKEsie8yQuH63b8vn/8oEA3lsJYJ2EQgD73xX4z9bs/74gaHMBQgA7+DsXAJWBBniHCLTtNx2AUnkG/LYNiUCpvX7wp6sIOHF/lwgkNf8UGagwYMgLMBdgLQCyVgOyciCGCs5nz/Jr8EXOQOcQZEbrfjjTU8qaCBseMyx4vxPB8iP+RU8A24Kg9R8Qgaj/av8lDBgcwApQ+QdVgW0bKr3+jsk//AztzBKgtv4K+Kj08rl7JFgt9BnCAIsQcD2AsQAolQj0CAGAqhOFCK5u3cA+84dyIJLCPm6buAgoBa5qDoDF6wzUkZ13iSDKKwTamSKZSf29cuzJUwq7LV/wz18RwH2Nl9dKABLArv6bC5B/+9OBGxmsIIR1AQ3w2gk4RECTfwBulgC0rP96/FYJUOv9SzkAB/xuKTBY/qsTgZ0LILF/s/RW9v81ywEwhbeAwUIH6hRwGp+wEOhqoF49fojqQoPlR/+z+/3t77jd3n3rdru999CzEYAQAYJfXACEAqL8W5lQgA5uoJUK9zxBB3ii9ALiYT2AjvuN72wFILP+XdlP8gLKFeg6f5QM3AC+VlMMZ9ABGuN+VePHWL6tHVD23or3tQPo2iWfBRgShDp0ELcBjmIAbwTWqEzIJvLM6kEDEFcD9erxCzg3my4/9p/e7299x+323lu32+oAtjwAhgE7Cazqv7mAvRLQcgG7A9B5AAwHus87CWBYsIKFfe+eCSBgt2J+7QBQ+VsogOU/9fIPBvLhASEF8AHwlhPQ2wVYFhmo/Wby74QyYLcmQAEbbbue2FcnAb28QTmHQKBwNVCvHv8IESw//h/f7299pyIA7QIE/LsTeIbqL59hPUADvHIBG8jBIWgn0L4rsKMj2Noomz8QgZELsCoAAnh0Caj8lup7ib9tX+ZBoKgUmFkWTGJ8S/UHZa/kAHT+QGaeoeQmMUC/CoAzVYAjYDvSNwPCq8fPnINus/zEfwQE8O7tdt8dwGZjIQQQ9Y9cwAB+RQIC4I4MdvvdLL+O//E7LgLykn6q3Efjf6X8bOUfkoNYcQZ8z/KzBUBYCqT/YQgjBuOBHxPs7JHh7JoAy/IzWz+xEtBKBEYg8fIGw+SeQQQ+CzHZP+oWXWPU/8z9y0/+h/f729/5kAN4791X/6/cpl4SCsDfLRQwHEBLCmJFYH92vssNgBPo7D8qv4CekIHpAjKgx1iffGbKb5UAQwdguIAtz2KsEWj7vIQggNON91lYoIFN2mznYKj9UBmwQgXLLcDstRTdBchEFWAWcLP9MgC9cuzM8aXN8lP//v3+9v/uCUDyAM0FIBFADqAjAsgFiAvYwK3/MfAL8InSd/Yfy37Qpyv3OSTgxf8C5vZXPfF3aB2AA3hJGg5LghMOgCUBo8SgEAyC3Irvh5xAwhW0cT1iQBKYWds/QQLdeVUQcrEjeGoiWH7633sggHfWJOAaAkglYL/wLQyQf3tYsCp9CwmgFIgOgIJ/JwMdBuB3cQTDX4z9wR2whN+WE9idh67761p/F/8bpb8O/OotQCsJDhZfji0qT9p0LsCI83X9H8E9KH8iCSiTrQO29bwAAbvlCipPAw4T/oRKQAVElbaMJ472t7jnqnEjrlt+1t+539/6P4oAxLquawIkF7Bb/40M9hAAHcD2GVzABmBYKSgxfyMGAbROCipl1w6gs/8ZF0Cy/UIOOr7vHAIu9iHP/2v77yX9ROUt29+AHVUCnDJgtvSn8wXsnQGzIUAW3F27qFS4z2CrD07wCogqbR8LtGecUwR4vX/5OX/7FQFsOYC9FCiToBGAEAH83ZwA5AM06BspiPKrNQIt/kcg69iffBegNqVXb/wdQgIMC0DltUuQ+L+Bmz0OrNTdK/91+4JVf15SEPMCYRkwEfc3stBxurMS0AoTMKRocaV8cKw6jpcFsdUn2/8qRT8buGeP55HC8vP+5v3+1v99cADvvfNQBZB4dO24Kv5GAntSUOz/+n1wAis4wAnoMAC/N9svSUKsBABgmwPAbQTwWzsW/2vAI6j14h+1CEjnBYZFQWSxj+sEVFyPjgBBrhf+aOtPY39vRaBVJlQ2vyOGIATQsb6etBguDMSQyAF4IMhUAmZANNNnUNSqBDvtzzif6HSWL/wbuwN4eycA4gDEBQgRYPzfSGC3/BYBdOCHxKBHBAJoAbdWfIz1I9XXsf5g9y0yAJB7iUDPCaC6e2EA2ngMGyIHwAgBldncf4ID0EDXVp1NYmbnrclOtyfDhiPOoCO4CEXB/rOBfOZ4yy/8a7sDAALY1gKAfWMEgOovoNdk0IArKr+7gwH02gWQ2L4t/sEEoLL2IQnoFX96HYC4CIz/jcSgAJSVAtu2RPZ/SPRBHkC7AkYEqceC2fqBfdKaCcHAAeAkpKVBCANcElBVgBQRTC4HngHOTJ+rQo2jhEbP6xf/VU4AmBza7L+EAZgLgGSgxP8dGQDwmQOQbS2xp6oEWAnQn1seIEMCJO4fsv8Q2w/JQU0IJMvPiCCT/NPuQP/noJ0rAFBa23VSr1N/vQhIgxzzB9odMMIAkGvFZPF6JkyIlJeFFl6IcRYYX0ciOOOcll/6l+/3t/7fngPYy4BSCmyT0SGAlgvY4/+BAET10fZjUhAWCg2AV8nBEPQ6D6DJgSUAoQ/G+Dr+T9l/pfg0HxAs/e3WBUhbsihIgHKkHGiGCQHYO/UHomDgdd0BcRkZlYtyAFlgZNtlzqkSJcwc1xr/6FjLL/tLPQG8t+YA3tuXBKPiqISgAB//bjZdkoNE/Rs5EAIYXIAKCwYHYJADlvhalp8RgS4PogNwFN8jgo1A2LoALxRw1gA09TbCAjckQHBZlQEFwEoS0Iv1S3mAYFGPlwOIJn+0v+ocPohEsHzRX9gJYM0BvPvwTyoB2gGsP6iEAowANsBJWAAVgRYeAPCb/WdkAKEAttNJwRbzM+UPQI8K36k9Kf3RagBTe2vhj3o8uAFXLxUGxTdXBrK1AIltTZ2JzUe7Lp/Ralvxvrb5kcWP9nv2fwBzIRF4FRFkx/XcwRljHCGm5Vf++fv9re+63d4xCABVRhOAJoOtRCguQKoCmghwv7L/mBPQwB/KfMQhCEF0ym8RAUkIToUAxrP/gxOwSoDGmn9WCjTzASw3kHQA5poA7Q4g3n+MEMAChiadiopXwHZV26usvB43e/7Lr/pznADakmBdDcB8AFj+5ggcF4AhgAlwwyUM6m+pPgF8U3BS6jOdAAkJ3HUAO5C7ZKBT99/IVDsGhwyY3e8qNfhCERXDa5BrlW/ftaoqe265Ar0U+PIQQCUzqwqYBYfnSK4AcuW8sjmHaMzl1/zZnQDeud3eXRcCrfH/ngNYbyxzAKL8nQNAMiC5gI0gBNz42XIBAnAkBACwqDyWByPlp2BPWP7WD0Crs/5ewq+1JaBnWX8rEajbDiVAlbNpwHRyAJ4D6EqECQcQWfxo/0wI4E3wcPJnUbSLXqH5A26qHaD9kb7ssKaj+nV/ZiSALRG4rwhsJLBfUKt/k3yAJMGwEtCFBGD/PTIY4n6d8ANyaEk/Q/nPUv8h+WeRgXYCVgIwSwbK3osKi4PonEGUC2C2Pngc2LL73Xanlj9bBTg7BIgAFe2vuoxZS14B7wy/DCT8xX/qfn/rrYccwLtrElA7AJkgkrDSJUHJfO/Z/wZ4Kx8g4IXyYKfm0i9QfkoSJK5HghALr51Ce2Jwv0ad9BvAj1WCidKfZf1x3UDnvPQ90HYf7o1WfSQMGbOpU1D3H6oCynpjPE7VfSccpoalMEHNdAxFKkDLgDzTRo5ZaXukz1E34f1Gy2/8kzEB6MUlsjCoCwWMEAAdgOcGTECrnECn+JYTgPyABn0U82vwt7hfJft0rK9DAlHooTSolH94GxBUAnTSL/reAbz6UBADt344SDkIJBIT5E62HgnEAwgFmjq3ChFkAJUFd7Zd9fwsdZ89nnX85Tf/8Z0A1hwAOgDJAxBbuU1usboYCoiCKvWX+L/lAUDlNUG0bD8Bt7dviP9Vf0v9LbV3XQCz/3qbZf2d0h8D+JAPYDb/RAfArL1l92W7Z/OjEICpOZvkw7bES0EisET7M0RxRNkzx78qJGj37rf+MUUA+zoAnQjs1gTAhJNyFy4X7kBtkYHKB0ifDMgrLiADfJMESGa/Cwe0/a+CHsmA5QQ8N6ByAzJZh1IhEobOAegsvwaVDhEKDkCre0cielYbau4SQfIZggyIM0DMtMkc6ywnMHMsduzlt/+R+/2tt2+3d8QBiAtQSUBaEVDxPyYB22cEuiYDQgJtLUFk7539ke1vgAeAR05gC3ekbAclwuaEjEVA3XoAAnLpT6sBCuStrUrIpqsBHhkwcBOVTecFJAteCAFSyk/GzapwBOJofwV0mbEQkNX2p/X9HX9IEcB7eyLw3q8IlPgSbV/LBThEIMreQJkhAeYOIsDrsELV8VmIgHX9ITGo1L+BnxGB5wQY6IvKLzZZCKD7nsj8m+sADjoAVHk9ga19tF1CzSk5GO8T9MCUAdpZbSqEUW17lpNYfucfvN/fBgfwLlQBcEnwdkA9cdGiCjCgGrCpZhACDMSA6wL28dewgKl6GzuI963EXwtf1Nr/wQ0YMb+bCJwAPgKc5gPIPeiImeUC4B5J2zbZnGXBQjI4Mdk2HFNPYqv9MNlJCJByAzPPEezIiUAe7a8ANjPWGYpePc52Db/799/vb7/zKgQQAnhvDwH0cwFWLqBluwkRYJ7AqgoMTiHjApTqR9ZfbLxbCbCUX1wOKQGiO8ASn7XdKgMimL2SoG4nkxGVnqk+OoeBDHR4AN87EmCWnlULBGiBuiNJMFC5RJB8HsACRgYwZ7WpEEY2pNEuYOoYv/f37Q7g3dvtnT3+39YC6BBAv3IK1wVA9p8SAYC5gRDBqz53QDasvag/dQboGMCy0zBA7e/CgoTyszX/VeA35QeH1YGc2Hwr2YchGn5mJNGVd8FdoEOIHEBo9VkeQc3cqFJgEkPhxSBHwoIMCVTAlx1vlggq4y+/7/fe72+tDuDdV2XARgD7isDtd95BpZWjKRUov4Acwa6BT5OEsEjICg1aBUAl8DpwA2kgQeCYbHsjL0zygfKbll9XC5xk3zYGgM1yA0IKERGgI2PJQJ20M13CAQfgWv1kEjBj+Yc2zlqAGdWPgBPtrwI2O16FXMrn8Ad+z04AaxVgTwDiasAtBNgnrK4E6HBgSApichCBBHkBCnQNbmb1iTPoSEXlDXCfTv6x0EAA2OUDtCPA70bMT6sAXjVAlf4sIhieC8BYXy0CYk5gIPKCA8CJGzoAI5QYJqoRzx8NAZ6KCLLgzra7igSWP/i79hzA6gCAAMQFrBMNSUCrFypUm+x78k/cQRffY45AqatOGDJy0CDHkh5dDERielFhWvrTIYHO+icy/jK+qe6sCkCAH70erLsXylXMWv5GFowQrLyACISU6HZ0W+RALX0Qz2ug4NgYUWScRNQ+q6IZ8GbaVMCdHS99jX/4dwIBCAmsoNd5AHAB1sRDArByAV1YgLkBnfRDF6AtPbP4LNY32lkOgMX/tPynSKFzC466Y2JP+mT+mk8BOiVAVP2MA9COgH4nQGcgHxyCAe5uMicqARTcJ+QBIlB5+6O+V4E7c9wMCSx/9HfkCEDyAMPDJiQZ2AABqtZUVwG7s+ZWMlCDO/F9iPFZso9l/IkDaMRgxPqe4g8JQa30yg14pdaM7TddgWHxXcUPVgLqvnqyWw6AqrlT0jPV33AekYJb4IlAdfX+6LwR0BVi8Yhg+WO//X5/e68AyLMAawlwCAEwF2BkpTfgqwlu5QU6G45KrdYNsNi9qwAQMgjBnyEDI77XYGcxfjXut1wAhlfSptsGoNHJPab6XkLwTAeAk1MIidp+mJlRJYCqPxCABwizr0aUDl3I/ogEMsDMjJEZp0oYjECWP/HbSA4ACEDWAbA8gJ6MjADWbYP6i5LqvyRROBBABHgjXEAV14k963s7d0koOkm/s+J+FiaERADqbjkAHKNNrsRCoE7lmYsQ0HjlPm+dgMzKRLmQkkgyBJhR/SPWPwPyTJuriWD5U78FHMB7eyJQ5QDaYiBhXL0mgGWumRNQAO/KbieTASMOL8bvVgUSq2/lAvAaOvDiwiEjs6/BThdZ6bUBJNvfuQN0Z+pzVzI09nXqrT3UMRMAACAASURBVJcKg+J6xKAnLao7Tvruc6ZcyBS6EDpUXUIEvgyAz2oTnQuqe+aYzT386d98v69rALZ1AEIAazVgz/4zBzC8aorlAdS2rkIgC4e8v2TxkOsGMLeA45I6vgZ7ygFg4g8JQhOdl+FPZv+ZnRey0CQhE4PtH1TfCBmkXQd+S+1ZXkCTiQZq0gG4sb6qMHSAKFYQHpsIMoDMtKla/syYy5/9Tb0DWGP/7R8QgOUA2NtnzEw3LhRS6hjlA9CK6/gfS4XU5rOk427p9bg02cfATtS9CwGcSsB6/taTf9Zvx0ItvQ2JgH7WgEYyMMA+5AwmHMBMDsAjAhrPTz5M9H4mggy4M65g+XO/YSeAXf1lLYAsBca/24D7MwKdakBIYOUBxKYyJ0BDAeIOTOW2QI75AgVkXNVH7b+VBFTgDisAQda/gd5LrCrlZpa/WXJrEVBk+cGxNWAkqwDMQWiFNq2/zNKgDOi6A2NFICULRAV8rrSN7HgEzmh/NH4G2MZlDi8qXf78Fz8QgNj/thjIcADtvw9HNcgQwGxIwPIGLHTQVj8BfszWmzkAlZsQwFrlPbcCYOUCjBwKKwl6pUBRWyFhukxY7LmO7414X8f61BVY4YLY9iDBhy6BTX6LPJCoPHtcAXelbQRUD+gZEojGZyCvjrv8hV/fOwArBGBLgnFpcGdJYUJ0gNknxLDNCwm8xKEV6xtqPwt4DWpm92kIQICN7bSNF2Xv/pLfUgNd5wxoCEAA34GbqL0VAmhSuMIBuIqv8wGJRUQWmCzAfNIQwV/8tff7O+9BEhBKgEMiUIUAXjLQinMbAAAcCIruFWMVgBPFX28iLhW2Yvzu+JCo06A21wAQm69XRVJwk+RpaiEQCxeQKEDlaWhgtEWQWEqvt7vhwoQDKAFfjR+5hytdgjf20X1HLH/kIpa//GtUCLATgE4CogOQz628IwzslKx0gosuG1bWnuUGotJhyzUYYUIjBSsnoJKVXZnPCAeYo3EBH1UDDIA38CniiBR/CA1I1r5VEQBUg/1XVt8jjG7iWZUD5WEz5UIK8sRagIhYquQQgfqI/a/aeBYKZMOD5a/86r0MCGsApAqQcQDbgTQBMNuqJ70GE/nuOgMSGjDFj7ZZhNABnxBTIxon459Vfa9yYpUEEfRU5RXounEUkJEgGJlEYNb9O2IQ16hsO07y9nk2ETjzJKG4JIKUSlgQKqyDzgzQM22ic/AcxPLXflXSAew30no8eDsJvBGWyhmJsKojQOAOi3R0yRFtPcvuqxo/tf7qeryYv2T/mZqT0IARgfzmG9Eg6erP8Jvr+4Tk4Sk6IwnWfgA/IxsCPhmfKWuk3ugcqENIgLwC+hl1j4Ac7c+CPDNOd4/++q/ccwCRA1iFHkqAtBrA3ICh/J46Yp7AjM+DHIK27t1aA0YIbKGPIisrw59NAOqSH/0NEKyMCBS4qwnAtNpnk4JGnN8pfKYKoIgiA2R2DEYglW1XE8FZQI6AHu1vv8nf+BUPBNDKgFYOgDkAsHdmQhAnkhP74kNDg72OwgMP0CRuN90GW+CTdCwWoVluQKv3EAYQ1cZjuOpv9JXJNyT49KIgliMwlByVu7kJUFwvPBjcQuaxYSuUOBAGZMjGIxEP1BEQn3z/3/oi4gA0CQD4uxAACMBLCKLNjFSPJd3Q7rtJOWu1oZNcHMgmE+8H5T3P3Xj7OlCzCgEeN+sEVDs8Rpu4Ol9ggd1ScuYWkAQIsDv1lrYqB+BZ/2FfsBqQAe3sbZG6Xwn2aGzr3Ja//cuJA8CnAXfr314SajgBkwBwAs6EAwmwWWFChThY0s8iI297B3DDPYRtCLi3Psb2AdRAHrKvqb9BCEyNtaKXS4OkoqAnomXjKUEo9e/GSjqAs0HvAS8C5WzfaNwKES1/95cZDmAlAbIacPudIRcgi4H0oqBuUirgU6WDSVtJsHnJw8gtZNyGWeJLEJNn61vZzYjzo/3dQ0Ea1DgmUXMWAqTAbil9UOaLynttQj+iAzibCCLQRfstUM+ShJiqqP/y937p7gDuex5gBz5bByD23woDMA9ACeCAG8jkCLTis+8ZUhjCAisZOKvwySw/OoWONFWMrmv4ZsWAqX+wrXMGbLkwnMvgIowEIWuHTsV1CTKz978WeViA88IKDzRnA/Ts8TyCcUng7/+SngC2twFZJLBPljIB4IQ1wgA9waPM+rCfJApN9Tae1beOGZ1LO06CEKj7UbF9A7CVB7AShIa9R3Uf1gOwhF9V6S1iEEQFDqFN3my14IJEYNYRTANNERd+PZMMIsXXp7H8g198v68VgHf2uP9dBX5xAtvbgaUUqEqCg/1HKweAlx9vsLeGIlqxchWojCyqY1RCgXK5jxGHofIsD9B+V92nSAgIxCEkgLEGBU8mAaO4PgoVmEJbOQQG1CzIs+08Msg6kAwRzJBOlgiWf/SLRgewksCq8l0YAKBveQAgBGb/t4vDhJQmAwf4a9dQeZPWnJbiHMfgOYeNlAKlx3BFOxs3L6B+LySS8EUg6rzwuEgQ3luBGugDqx/lCzyCGPbtCBBi05M9Io2OFB4hEXgmGLMgzZDEjIvYruUf/0I7BGgkAJWAbY46SUArGThMyAIZVADH2ppEkiCBir2n5xmpu5ME1I5pUH+LYEnFICKEDpiFEADPSSu0JhQX/MphTBFBIYnI3MRjgLviLs48H9OR/JNf4IcAK9bxPwoV9TerAXgj4T0BOJk9MhAQDZOfACUCNgIy0zbTJpPZpyGAQwTiKug7AYkr0L+N991Vf00gpGyHINbK3yZVMQQwVT2xEMh1BEZ/Nvk1EKsKmgXyGeOeTQQdEf/TL3wggNX2b/H//jqwLRGo1gC0HMCeD9AlQPw+WDqZJEZIoCdaNY6OgOmFAVq5u7ae3Y9AHam7sd8kApUsZHaekclAvrv86eoBcwkZkFvrA1hf1wU4Cu4Btu1T/c8G/hWgrxDEmSFDc0D//OdDCEAqADoPIMnA7a8wrv6LpSEFfJlkoQtAdfKShEmAWlUDN7xgOYYE6DPuBY+Lv0W0HRXdK/cN2X6l0jqcsICubbx2AVeFAK7Sy+zV1YDiasAjgH6MvqZth+vXH6sksfyLn/eKAFaw6yoA5gEE9FYScDsZZfsR8CwhSJNb2Tq5UVLsQO0lE5Pk4bqRiBDU/oEcHFVn9X1T4dFZ6TKhYfWZcltqbm6HsZm6D07QKuGRcqQGgEUKSF5N2QySYPutbZkw4SmJwCIIJIXIYSz/8uf2BEDXAWAosN/w7gUhAHwhge7GY2wGBKFtf5oMGKgcl1Cx/wKwKKQY2hWB3oHbqver7ab6J8t/2L9VbaR6sM8auk4gArlRNbBchQnSaBw5RyV7lRCAgSYCerS/otRZwqiMmSECc7x/9XNUDkCvAyB5AAwDtrlBQgG8KegCOsvolQgrgPKcQKTQSReBhOCquBP3a8LTToXF/vpY8ls2J6AdBFH/rNJfov4YDoL6UzVP5gDc8MBJBFbBnwHrWW08EEcqrvhw+5oNBZZ//bMLBCDqb7kAcAJtUQeyOuQDcGIPnzFeJQClSbJqngBULW3xIzKpkBYe3wGxkISn/u5zASwccLbh5NHhht43ELsFcGeFXwfmA1UAdBsZ9YxU/ej+zDkwJ+RtO5Mkmhh9yc+637cKwJ79lxyAlP/kKcC1IqBzAJgL0K4AQwC0m7hgyAsBrAVEaL0HJU6SQKeiyT6dWictOwsTsqW+9ttosAax/pA3AKJBEqEhQLX+T+J2PG9GEIxEPPC6ag/SNzhOtm/fZo3JABYpfLT/KBFU+leUvxHNR37mSAAC/lYBUDkA76EgIYWOAHASKnXHm4/hwaB8pIxIV8oFFpxlziNws/0diSgF91bwuQQmE7QQ+2fUvwO+pf7KkXRA9db6W6QB1+KCHu1qMgTQE70DoTOG24/Y5qMuIEMOFYBXQ4FM++WjP2MnAFUClGTg5gCEAMhy4M4F7JNou/eZ0qBWELD7qO6D0uNkZXmEwKqb4HXI4wzAa8ejLTYSjb5mfXz8jgCvlP86YrhC/ZH4lfpSFU4SgAfMo88TZFxAlRgyY1aI4Iy2zQF87KfbBLCVAAP199YCaBJAV9AlnAxX0NqwnIBSrHSSziAPa/VeJt/ACMp0AY6l1+CNvofqb6h6NikoJMMUHN2apayZNt3YxRwAPa6Tb2iTXj4cVP2MwkdkUQFz5njsGt1tX/rTHghArwHY7P++DBhdwDanYCWgzgPIfh2TtfUB+6QcJhcBedfGUXoGwAaOyXhdKy4rC1rxPAtlymqfjP0x5h6ArVSdARJdiQa6BWC8t3h8RhQ616AnY+cEigRQdREWUZ1NDBnFz4I5Y+OroMf2y5f9VE4ACH50AS4B7OD28gDtxyEVgW6yOIQwWGlg/Uz8bQLXcBoa/AM56Dq8FcMbCTyx/o3ISF3fsvaMWPRv7JLEPht08nC4TyTDb5UNI1VnwO3coaHQFPBKxa0QwAO/G1LAucwA+2oHkDkny2Vs27/8pygCANUXF9D+h2CdC1CA334rcQf7Z7yxsp8qiFpBOKhPQAiW6jIlN9UdzllAKQBjdtxT9eF8HJLQ5xNae6Lska1nSu+pfyMjb3GOlxwEYrHANwA6sO/abdBxyRiPAf4ZoGf6WOA9y0Es/+YnAwHs4JfsP4v/JSEoTgD/is1veYFZEsB+xAp7gDEX0yRU2asQaHX2wD8QjEEsCDKt0pZqM2LpSqaiiNpteCW7mQSgukc4UTWxsH0Z8EaKT/erRGIW/E/pAo6AOdt35+Pxvwf/t0gA8BKQFfzZMiDmAYakoJ4oUB2gE4UtHDLiYQSa9bnsDEhJj4HfdBYHF/V4Vn8gvh3sh9Rfk60ot7c9Uf+Xc80AkDnCNGng+RrnzCa/RS6Z8zXBJDv0ORnf9bHY96Pbov7LV/ykMQfQrQMgVQABvP67//60BKgXA7UTU9Z/mDgk+TeAndjrBtpCBcEF9Wz23on7j1p9TW74mzaH4jgC/Vtri20uDdakzvIDbTL0y1I9Gx+V8CJHgNeTBfIMEXhjz5LDU5HB8pU/ccwByBOAXQ6AxP9sQVBL5EJGF8uByPYDCehJE1UGAuB7JKD3MadA22iFx9DCiPPpeZAFOZWyH46Jk2cDPiZFRX1IvI7XrMdg2fsOvCRsYGMM25QadgC8KAeQIg5BblAajOL26v5Z4DPrb6m95wKWf/cTxhwAPgJskQAu/aUhAIB5+22J9aelQa0uOuFFQoRBCY2Soc4PNBDBMQVAGJ50amqVI8kYOH4F3FTZsyU9EvuLMs4q/NBP3SNT1Y2FPQyQcs0RYYT7JxYTZQgiAmoE/Ki/8E80DgO+RQYe8Nvx/v2P3wng9updALgAyEoEYrY/ejS4katyBegG2OfOEqpSX7s4K0QohgVUpSft+5VgR7BFsb/nEkxScByD/s31pB2IIOMSIETRE9YLF0wiOGMtwcUu4EoyyIAe79uyEsDwIhAsBSrrT6sAuyJ0i4KU6p9CAkpl9boBNuHT7iCw9vThJBJfe8erKrt2IZZjoWSIcTkLCTwVt6oC6nojwLKYvuoWIsUf1DsZRljn7m3PAPcMBY/GqIK8YU/IHTYs/+HHKQLYAd+tBCQkMIQA7L0AQAxo8bbjI1MXPiOIqMJNOgIEly4HmvsUIaUA7oQ0tD/LuBsAzTqC7XosUnAy/MwBZADtKTl1fjhB2aT19j9RCHAGOWTGyII/Gyos//HHAgEo5c8kAbv4X6m+lRDEmy73EtViSEA5pcFOIVTSMHIEAgTLVuvVceXVeFWwO3F+ByIW5zuxv1ZRRqL6d2TK64E1Y/9dIiDWfVB3veqPEcEThAARcDNgPKtNdC6Dw/lPP+Z+fxcWAOHbgM2FQKDsQ/wP+7TSo+qzsiAqk1apLmGoVUor4kTpcCCDALzZen1EQpbNp+QEjgNdiZWxN8t4pCKQUXeLOChZOFacEoFxTmzsYRIjEZwQAnjjRwCL7Hu0PxofLnVc1IM7gzxGE96vWgkAHwUWF8AWAuGDQOyhIAQ/KwPu+9t5KmVvJwXtMHSgE9BQfU0g7oMy2g4byb9ZMFtkwUCMhNDtJ2VDDVoNLBoSEBLpQBYB18kPpElkv9HM1XRzwFB85gzw2BaArX4uoRRAFYG7up+RQYYgKm5i+aof/RACiPK39wAAEbB3ArSq3v4Bl//qpcAa8Nt3QhAM7N0FE7DTSWc4goEUAAwm8Ky1CNYCG69syWr/BJBWLkArvWflL1H/iDwE2I6dH0hKJkeyYtCRFYCThSdZYLuEwo6hCGwGlE9FBsNx//OP2gkAwwBJBBoVgK4SsE8KyQWwuJ8RAoIdCQJvpMXqVnlQA3z4TpRdjsHA1IEo6hss7JFzQQDQYwaE0AHAUmMrSWgAmJKomuRH7D8DmOVWGMAjgHb7T8oBeORR2XcFOcyMyfps2776C/ocwPr7df8rkEMC23xS/0uQLgVm3IBOAHYni1ldneHVcSMJKdbJEYYOQU7BDR+M8VMZeQZUY1tHVNYxlQJnQgJNKNbk9tzGAFovx0CWDXurDkPF1+MVcgBZhzDbbgaoVWdQsftNaIHcNwLQIYCQgCh9SwaC2jfgQ/lPg92qAnQnokIB6gCUcrlVAqNsZqqco+xMtTM2/FTwVxyBofAsvGGgNe25UxqskgxV+ETIkCaCAgFEzkLmqdXuqZ1ARBam6gMAl6/5kSoEUPYfwa/fBNSeBQBi2MZW7wRox8skBgnYTUfgKLeA11O4KDk3gJ0pWzI00BOYxuhOeU9fhwXWqdg/Io7MfuJKKNhBfRrAJisAFJgH1wF4oPYAF4HxyP6oLwN6xhls/f7Lj7jf5dHf9hdeBNoRgJH5L4UB+2TSpBDmBADsCG5U9izYq+Sg25uKqqsJhnJ64JdrcC13Mfan14tAdDL76MhM0qmOFdh2fRxGJBZQoycKI7BkQZ5tFx0v2h+BPw30BrhXH7bweCOA/eWf+kUgFvjxKcChGqAAbuYADCLQ4N5O14j9I/DjftcGe1UDpn7Ogh2LhCrHfyzw098Hwews/aVkkMzkD8qd7JciggNJQItUjoC0CuAjxMLOMzz3r/3h4ADgLcDM+ktOwKwC4HJg9ZmV/RoXWaGBUv1TiYABO8ofWLHwRDLPBd8JCn8quLMWPeMkiPozK5/dNpBCkAPIgnwWiLP9QqAqBc8of6rN1/3wh4VA8gRg9AxARwI7iFgJUCcAKwlBFg50lQIdDoCbMC1rpYKQrBygW+kUMcjkR+CsxvHus/sReCPQRvsR0A74rPCBnXtK6ZVTsdzgYwK+ovaVthE5zCi/8MnydZ+vQgC1AIiFARveINHnJQMbNlHlAbDbiTj7NBmUiYCoNqsiDBNUT+YjoHaSh3Lz3BDBcivedkaSjvqa8X2ypBe+QEQBVl9vBHrmCCi4H7EKcJban00GFcJYvv6H9UlA+i4AXAuAZT/1WWf/LdXv8G6VAQkxlMHPMsJFJ3CJylugstTaU2FPdT3wZpQ9UZ4LiYvU/TswJ1xDRsWZ88v0a0oIFjtDNt7YEQCPEEc0dnX/AwGQ2P9oDkDCAvld9XdP9dEV4I3tbpaenMZ3V2lIn0yCSlv0wyTh1Nkz9p6ppxVGoFU2VV/UOqn+6NKiMbtzdQgmcgRv1P/hJlXdw/C7/dcfajsAifeFDESU27MB+wa5jzoUaOB3LD4SA4v9NVF4LgAnd3ehgeozAHugHianEx6wCR+FG2YeA294whVQYtjvWQRUMw9BlDIkG7b6j4VmVrusOp9s/y0ncJX6R+POAD4kiI0A4L8BQ+Uf3gfg2H/2MBBTfdP+C7vAzdaPAFfIwLSERHVoIoqUBjNKm3EDGVIwx8kAOFLuaL86hkkkxcU/jDgrSh8CUhG9B6iMzc+0iUB7xO6H4EWszLqBb/ghJARgTwKytwI7OYAhBHBcQDYckOtlTmFYABIA3XILbCEJ3QaE1ampsRItHTbsF+mqqpUryCzZzYA/QzJJN+ICPLFqLwPCI/F/aXy5N4YjiRT6akB7BGmd2/INP/ghBGjJPwL+1QnIfGf2X8CuQ4GGEZXoO9UFEOdwhAxYDiCtXE79ngKh2t7LFWTAHwAbSTEKEby2kaqznEHUJ6XmCUJJjaPUdFbFK4CvtI2IprJ/+caVAHQSkD0ObL0MxCgJbnNNqb7+XlX+KATYLlwdky4NZVaRxY/ZcMGLZwNHkCaXCPwZ1bbOBZXNyS0wkJruSKmll1w9CsrHdACzZOBdYwWwYj7CcAhcijf+8o0/KHYAkgzs/u4Trqm+/g7gKYUDRNG7F4jKhTlAbz+SbgNjdz+g0S5yA0wFO5AQAnHVzwOoZ/vPAn8yMeclKSMlPwOspm1nhO2oeRZEM+0qgH8q9d/O8ZtWAig4AMGQuRDIWQ48JAUBkO3eRcDWuQSi+pETQOBSdpxQ/kjJI7IYljkrVXaBlajpZxbqeGrOQEDzGqA8OoywfvdqHP5+IICznEKFSDJOYhjvm35g0QEkFwIh2Bm4w3AgcAJ6MrV5R+y9BpcmCFQl+oOz8MByE0qNu/EK4UDkJBihWHF7Bvz4m5jAJct+I8Wn+6+I1a8YE0k4+OwBtaLwlbYZwIfjrQQwrP4jK/82+6+2y8q/IQmolR2SiNvvqFUc3x/A9jOwESfAgB6BnxGJFR6E9tWbhJ499ey9FUbIhDT6ejadAjwKMbSVtkgxY7kvAOuZjwFn1fvq0CACeAhucGPycejzzT9gdABYERheCLqDUQhh+0qeC2iYNcBvWf4wMWgQhE7+CdHoC04TAlFy0zkY6+41udAJkyANar8JKVIHEBFEspYfOZLIxofkmSEOr82B+H9WvWcIoALaStuILNj+bdtKAF4JUKu+uQpQx/5AFKj6NBwQeiLOYCCxKEegCELb++GHcCoCA2taYHXU0IrtXTJhjsd5kKcDpziDBEEgQZkkg+MBWVigiYjA/T3gZofjGI4kC+azwTszXgTaqwlgHX/5ls97tRRYVL2tADRCgUH1yYKgDofE4nc4VqDG/EGbE0ZiziMIF/yGYlCHYJEKKzviJLaOEWTbQ5CQpN9AAhcoP5JWGaBA8lmyKYHZI+FgldwMeLNhgncNlX0RWczufyAAWQqcjP2tCgACV+Z+t0RYAUmIpAOxEdtHTmDbTybBsHaAnIMmiuHmatcBk9m8iexcEgrqVgP2c6cxvFL+LMii2HkYJ5Er8H6TaeL4ANj/CKSPofiIowcH8P23COBGnwHQhOBVALxHg1l4kCED0mbIEVjqTIhk+4GT26dJIXAF0yGBQR4U6MR5ZNsNTkIRS0mVsa8ir+o4LnF4ZKvPYXKV3xWK/1o4gG/9/ioJKC8E9dyAAXaM75sDANDp+N8LA7p3CyjF1Y5B3xxKEsZ6AVo5SIDYZHMvGRUlqqLseLCSbzunpBVGMsy6hTA0icAWXf9sIjC45irZyPzKuJUjIH4KxR8cwLd+v50A1PMAmOzTnwXTYvkld7Bth5uM+9uBo3yAodKR8uP4HUEQ5dFtGYEM25QCDwQQqVAEzAgcQdx/JvipC4jICX50Cpxk/wzoorCkAsrM8WbHM0WCEGXU9qr9y0oAWwiglH8LCYz1/w3wqvznqr5BDhqsUwuEqg5BkUwHdgOI2yGsx02tHIHcaGd/pMQIbArMRF7hCGAwFMqAxWwTEdys+sO9zJzfjBuoKPVVba8lgGISsFsApElivyE45wdXADdNhwUdlkm8nnYCCeWXY+l439tecgvG5OxuZqSMjnPoJnwWYJETYUoenWOkaBP9M2C2yDML8my72fg/Am2FLKKxZvZvfb7t+77KAWxOwEj8NXUHp7DNb3QBCvwSAnSCq0MAQhiitugOcCzcbsX71qrAri9OXEY21nMGHUu9GnG4oQVncMg2Z8FPSDEFNMcVHemf6ssIidw3a6wsyM9oVwXhUQLwznkQMVIKbQRAV/45RKDJoAHcIQMhiwjUQwjQscer3hYh0BWBxhhCNCzej/ZZx9FuIsolHLbMFUWfAXIUviAY2ecKOUVjMTIoXH8EmAwhRSA/Cuoj/c255pHot33uQw6A5QFku5cLQGAjMSDmLCcw4BImixUaCDCZkntuwGtPCcABCx6nHBJkVDg7qSuvwEoAcQDIBPi9MTIAKyt59rcKyGWWHCr9IvJ4kv2NAII8gIC1Wwqs1wUAoi0yEABrx82UP+sGziCFDsgkHLDyBN1N80gjqCLg+CkQJOPqdn4BUOhEniENVJtE/2x8TduRa/IAmT1WBMSzxomO8yj7P/65r1YCotIPn0m8j28BFpVvwGdkoCRf2/gOd1k3MNgImIEEyBZZYEKJugVrHYEoi3EsTSzu5HEIZCCFyuQPnMIl4If7kgVMtt0hUkOCMj5XgVex7VM2XU3IlEAQxyPDdP0//n3GlYAh+FWs370OXBbbqWSfblNxAlbbsuUPyMLLBeA9YLafTZruB8+AO2vps+32650Flqem4b4T1d881oyreWICqJLL1e2XjQDkjUDkmX+d5WffEVeWE0CBNJU/qfq6f0eQBdVv/Qw1tdyCBWzGsDJGqBIZgiCAzjqK0kQ6A1hnjOGBNUEwIUmd5AAqxyndB0PFw7nkOAY9R5ePf+9XSUBGBAJudAVt234Ttn37xi4ESGyTE0rnAIBtBqwfAD/+Zl68r8nGdA3RykEsy2TtfJYkKsfWk+wM4GavJwnA2fj/CDCPgqzSPwoLov1HSOUVAeBKwGgtgJH80+AfbL8OC9A66Od0gFy0UiuCa+Sjt0cKboYQRGmHsR0w4vmGE0GRltk+AapuIlTbG9dcDh8mxpkCauL6wt/eUcojfY8AUiv0Wd+tc3ogAA/8xsKfDuykTVP2/YO1GlCLNnUCiii0Cpu7LUfgjUf2WTG/JgXLORwFtbkE2VLQRNKPTgiHjNKASBw7PZZ2J0Vnc+Q4ugsk6gAAG0BJREFUVVKKQH/muZxKCp/4Xv3DQGLn0fI3sEerAPVTghAaaFyllgcDi1Asq43t6yzwI2IIKgHiOFKWjZyjZ3XZBMuAOJqYbTJVwwuDfIb/l8FR2cy5VX6Ts0HmZdunz90i7eClJZnjZdoMv1EjAMcFbLiYAT+x8TpX0DCeAHPXxAA5XTug7YiW7on9NPYPwgLtEEKiSNjcTg2y4YSehCeBv+xUZid98ne5khCmwHaQDGeOGfVZVgKwqgAiiBH4U2XAfTCco1qxNcAZxiOAm+J/kSvwEoYU4Anl325ath0hr5BYNPDYq9Sr4LzY+reJfBZZVa/vhPYRGGf2Z/p4bZZPfM++CmCFAF4YIETR/upnApw3AqUJAQ4ShQPD/ovA3wjdANDwwxvKZbVjN45uSwI427eqnIywpsbIKOT7iAAy4Ix+p5kxMn2kzSsCCKoA+AiwJoOOAJTtF8vPSAK3NSFLhAJdPwLuTKiwHc8jhsx+1YaGBSRxJdeadQgWETBVTJNG0mVEE3TbXww9yg6lmPzL/gapawNSitpXgIdcF40783tlzmUd94EAEiVAuc8m+HWOoCH61fxAy19R/mplAElHicqrryeD3wM1fVkpm1gBkOgxHEV0gZA4VnpiFlQ5MzHNNoXjpM+9APBozKuI59BvpgAwJgE/B0KA6CWgrP7vZP4bWcBJZJYEI1FYQuzlAtw8gTFg2jXs12I+diz7gQA9tu/2GaRkOQvrfYapiZgNR6znyMn1zQCkpG7GOZfG0PenQAAZIM6cS2bcq9osnxAC0C6AgH14+Ie9EIQQwoY5FRo0HAbbKY5In3Yf2QtHEGVWiGEAVhHow1cHPHgeJnAZqAIll3GrSUdKBkdyBmQF41WTsxv3LMK6mAAe5bdwSKt6/AcCMEIAmevrbz88A7Dv1CofVQQ66w9ftAJrMdSuAHD46ucIiEGDeRDcKCwgB43KgZYa47l4biIav0QyybjfOufhWGcRiQHK7nivKQFUATcQ+Ylgnhl7+cT3sEOARgDO038dATjZ/w74AKTM9q05AScjBY8YEHRVy4/Kr4mEKZXbRnaSa/IAvR3HISk3CZkkr3AMOPeM3c2SiTtWAfyzgDyz3+xYZ/6e6XPoCMBZ9tuAboB8cALKIbT5x54H2CeVBrkGOHUFHjFQNlBJ6wnVZ+AWgogA3Fg6cVymuJ1zME/kYQdT0CwgXTUpEFdmUodtCgQQjrVf2NXtMuNn2lTu18x4rxyACgO8sp+n+ts+A+Rs+a+0Z1jFfXS/ASLLGQxjJEAYlgpn1FwdN0UazloDD6wR4aQVH4GTPP+ZCUkn/MmhxtWgsu7H7O9x5fkun/hsFQKw5B+AGsGfjfc9UrDIYjukmmjatlv4taoAFduvyccFWYJIvOSdFvIo7s8Avps0ScBaE606VoVUdFvL9byO4Inc2PvhnEcC2CfL+mf7p+P//ar1dgTsEA7AmJ1gFrZ36k36tXEjV8CshFwT3tEsqBPt2rDQNqX68GNl2kfEUQGmpcQR+VSOkQJIQf2vUMorxkxdd1R+hbl6aLzmAMhCnuEZAKPmrxW+EYAFcGtpsLM9dATgUrSiMvLQbSruYArQCaKIAJxyCjgxnGN6hGLuyy55npicFuEcJZSjAD7aPwvOK46TGfPBAej4nz3959T8B8VXYMR5aK4HIACOLD8DLZvzlp2nZiAB1G1+J9pVbD8jrdR6Awts5PymQL+Pf6j6EBCCNVHN/7iV/lgq6XkWCcn1k2NmwX2UxLLHyQBeLkPGXD7x3cccQGbdP1P9UPmt5CAAqiMLOVvD8re2XkjggHXASALUWfAzl4BzKLT0wblk+kdt0vuNc6lMbBPkhtU9tMpRgfUogGaApfmi8lsdPd9S/44ASLyPQEelZwlATQqIPU/56ctB1MtEGI61slP1NybvU4LfELBXmxMZfzZGxnGkQY8HgB9rxkVM9XkK0imqfYUYqgRYAnHBEelxXzkAJwcg4EOFz9p+5hSasBPlZuGCMgIPIkwmiN50RjWg+22zDsFxHRnwR21cEKtzjADvTUx0OzMgjsY2VbEI/iq4ps+L3JiKslfPszJ2pS2exwMBZHMA+8Re709HAGxxELTtnACgWZNIa5ew/APY9c0xngno+qlBXHxfDP7tBlaOwSZjsn+GFLZJciAMOUQYRQI4dKxHBvWVJDAz9vKJz4rXAYjidiHA/sPRtQDWE4LGOwIt1e+2KxvgEsD7DPyotNPqXwQNO84ApIkxI3IJwXryMcPjnUAAVeCd1f6MaxsJgNX9WXjgKbzlCIwyX7vn3jJhpZCUAGBjRBCKTzjukoraOlfbp04iooTk04mFic4I6QiwvQkvp+XlL44cewYkZwF0uDZ1D2Ztu76VR8ZZPv5ZDxpOwwDr+X9P4ZV9b66B2HodRmgXnHEGrc8Tgz98B4GF4wJp0Bud7B+BqDu9fcxMn6hNaT+5llL/IsnNkMNMn9eZUDYC0M/5I2jXzxqowzaw9l1bZzsCl1p9I1zQJCHkhffeVH+HJBgA9HwysZYE4TA/Z/sZziECi+clPAXOKg62y5xLFHJMjZFU2ciVnA30GRJ4jD7Lxz/zVQ5AwFVa/rt3osAv5gIQ3A+25OFuenbefV6AlBLZeBb4U/hMNSLQC8gonPyzx7Xq7gapyObwfKJx4SfIOJmzjveYQM78VlW7PktU2eseCSCI9wegW5Y/SQwakDpksPYLM1juofVTQHFxE71NKGkJQmyGDTyt9qsFGeCYo8N5ZcfJtnMnsvo9smNm2mWBUHU50bFnjvvYY67H6wiAvvLLyQPgk3xWqKCFRZSdAbdti5KBilws8YrcAd70cgxfJYtAYQPI97uPEog62DbxCmNGE7UKJjx2duwz2kVjXLl/hiAihzEz5isCCFYByhzRCj0A37H92xjE1neuwtmP/V1nQBYKWfMbQ40MCKvtD5EMO6ErgBqMGQGBnWa6z37sdPujoUYUipy4f9a+R0A/c9zl277bXgXYRQABjsDUIK0Anym7DiW0m2CCaS0ZHsggafuzYO6GSwCQNkn0CwnojDESYUwFjDjcTL9osVHZTTwigCMgvu77txCAEkCy7s9IAcHI3IIGNoJwIAV0ppmwYD+4xgn9HoCpAuIQl0aDsF9nH0J6KDWo2v5DKk86zxy/QjCZtq9Tm+hcrtq/EUCn9M4LQIYwYL+x5mpABUgK8H0jgmH47IC/U38Sl1fBnwV+GryzuYILwd+GTl5ENPmyzNONkzx2xg7PklP2ujLtHqtNdJxov3YljQBEibW1t7Y34CVW/Wngt3vv9MXxB4sPd5w5CBY+6PESTvihCUzU7JzF68uCwzrnSnKudCx1MZmJUxo/itWTP+bMeWX7PEW7s46ZGSdq00IA+uYfou4DkEG9vX2W7Weqz8gBccjcAQNPRfnNuUjcCQPB6a7BZIMqBI32SfBVjhZNtm6sxPFL48HglX5XtM2OeWa7zFhWm+VbP6NPAgrYXOX3VH8fwFT9qEqg+rvq76izRxQZfEVlQXcOJ4nDBdgZY6TZKoZ6ZpLFo4iq8JZHj1Htf1X7K8bNjDnTZiCAyPLPxvs4LnUEiaW/HaifCPyReEXEkSGfM22/nO82OaKTTyP4QMOLQo/M5NdnfXWf6viZ9pk263Vm2m0hwOoAUK3NxUCBsrvEkFH9YI1AN3+zFYHki0M6UBog8bCDYcth0SUHOgW3pwxyAPiJ9wvMjp6Z7Gzsx+pXPU62/RntGgFYyt/IQVnS9au3DwHL6vc6RIjWASDIBntvOMvsSkAPwBZuuu0HQBuNUwUFPd+LwZ+diFc4kPSxyQ/52H2rx6u0z7bV7ZZvkRyAEddr694BP3IFmXyAE/NHlt8iAv2fjXju1wJ/Cvhq4AzOzDZO58y4mXxClUxObX/4IvqzyU547xqOjnGkf7VvpX2p7bd8eCIJKIpLXAFTfq322jl0feCOee00qC2HYIHfUt408GFgb26n5v0JawVmiOVUgHuDpX6E+GwqEzseLRcnXz3OzDVV+3jtl5UAEKAIOhO40WO+mZifOA5KBEG7DuCJhUADIcDkZPPUJIQDil21/dP4KXYsNs9g46HNgYGrkz1/UucRwHrMo+c527/abwwBdgLoSIAou1bjSNU98jD/81Ct/t7/IyAuRPocAH9F9be2pEM0x+l+tTEag03u11H55Zy2yTZzURUUH2xbBVDmcEfGfOy+yzfrEMBaCrzfTAbsiBwyYcGg/oSEAOu9sKi2oe2fUP3WJQnacN4XbH84lp6VB9xJZoKn25RPPD3yaQ2PAC5zEkfHP9I/03cjAAbgAegHFv9YBMEsPyqsPgcNbNaWgb+bh4QsNLHgjWV9Q4IxZoZFIubxghmWcRWZSVrgj/xwb8Df/VYZMEY/7hVjPBAAgIIqvKHGkfJ3Y0UEsl99+L4AaQcoxLmm593Z4Gfz2pvrw76kg5giBXIiV+EwHDdsEE336/efAaiZszzzuEfHWr7508k7ARXIEMjMGZhKnnkpKGnDxhu2ESWfAX8K0Jn/ZwBmgjn3E7Y/i5uIWDITM3uszFgdYV01cPVEgvZHwXP0dK46fmXc5Zs+nZcBN8BFqn10v7H8V5NMZ7kTVYHBoicBTMkgqaqhC3AaRHiJ9m8TccJZeBM4dUw2wIHrjABVmdjkJ2nDV8eJzuus/VeelzX2RgCDwnuLghxV74CbedQ3Uy5MvBQkUn53P7odreIJUFnzvdueGKdq+b3xLwF2NqE/zRxnweiDNc6VpLD+Uo0AGnjBWg92f6dVur2yNFhA59h4nEfb5+T6fw2MCPxU9ZV8mG3UXKNzn1yjnqIRZtz9RXIpinaIplkiCgd+08D9Bc4ihuUbMQRQkzXrDBAv4UNBcllR+IDK/Ejgb5MZZnVEIJ7V9J4M9EAdEUI7ZqZhVrkzZJawFslTegPvR/gFMiSxEYBW2PX7oPIROWTe+JsIHzoygS/6fDTwjiq/Bv8s8BmJAOfR2x6BxnMW1dDBIyxrTkbnt/VzGqX6PwIgjhxCX0MGXEeO9xh912t4IIAo5nfAj2o0kAaqeDLb341hHNcDf/QEoAvsI8lCA4nW5D/iAE5558ABxR/O/SDCD3a/DCuZ83q/E8HyDZ/mVAF2pCEoKcizdj5DJEIaVfAnlgJXwT/lApxS3wzoM2DLTNSK8mfHE+UvtS/A9apxM6fwlMeW81vJ5WrnsREAA/W2LQHsVMyfGKez/gr8Q1ignEXm8V8PzFXXYIHJUmY2mWbIwPq/EvWEzkzeTJuQNMgg2XEzIJwJb6rjHgp7zjrYI43D3MryX8EBWHZ+VvUtEmGAbseAGUSPWwT/2apvglntOAv0bRwDWRnAXdYmM/BkEvKpgZm8tEeC7nWH6QhgRvVdkColt9rKcT1ioC4gsP0V8LttjUnMwFkBvjXJhu2EFGcBEk3saL8cN5uHmD3PaMpnzzMax9v/GMc4cn5n9N0IANXXBWnmPQCi0Enwb8AO2mbAXwFw1fJXiKQBxLg7FYJAR8aGiyboZfvVwNFxMhN1ZoyZPplzie5hZYzXve3y9RICEBAOZJAEdQnQxpiuG3DWBWA//RnJhu5TdyskFTIDKwBPtU2qfwQGb3/Ut/utEo0TTUxczPSd6ZMF5pVjZ88hanfkHDcCiAC7HSAqFQJthi4icAlU8YMyImPtAcAOmLBtCHzCHikwR6GEvtMnVxQY6ZFD2vMt8TDTjFN5yj5Xgisa29t/BNSV4y5f/6nj04ADABNZfI8kqJor5XcVPwF+D7RybimSgF/PHDNQ5YhAPCC2vkl3EYF6VvlpP7VxZpJW+lTasntbAYLVduYcKse9evzoXJav+9RX6wBkMnUKfgH4U+VFDcTkcmANCAR/SBIF8M+CPOUUCDnijZwB9UyfDlSJmZpo0s3HTPtMm7McRMkNRcgK9s9e18HDDt03AugArx7qMfftQ0XKP+MmvD4U4HguhDi8PpV9mfUGTJFToJdrMGaGNWHO2u46iYCQjgAwC4RsuyxRZoA0c8xo3CvGjI7p3dvla4kD2Dqom06JIOsOEs8A4A9jOZCzwV9yBKpxBtSZNt01JY5h3cwzicA7p84VZGZech1AFhjZdjPneYTIop+iet7ReGed60YAFuBc9T8R/IPiF2N+Rh6RWtM+xEmIw/EmlEckacA6KnsGuL0JaO5LJv2ykztqF+2fBXV23LNApcc5cnyPCM4Yd/kv6ACyoM62q7wSTD+BaDiQlAuYLBNSIBeAGRGBSQbkTlZAf0bb4dySbqQ62TOTNtPGDVkIarJjnkkCR45Z/V1nHMPa5xUBwEQ/TfnhF3DHJC8TYa7gKPhLqg8Hi4Bd3W9ZbDZhzgB3ZYx2bs7szUzsqM3R/Y/pBqJzPZM0HgP4eD0bAaTi/WxeoBDvD6SQIAzG/K1bslJgEUF3o48+XUhi32EiFev8WYKYAjzOPBCDSFkicHj7o75Zlc+MQy4vurS2vzp+9ryvtveZ81i+5lPGMiBT3zRJ7J3Tig9UHvVxHYC6SxmQm22csVwC2q8lcgTbGGRWHQF4tq83KbYxjNkegWAW6NG4mUk84wYyx50Zt3K+FgFUzu2o+9gIIALeVeBHuxmdQxb8VeAP48IAEZCn9zvHsCZQFuDZdvQ4CeWPJudTE0F0fjNOoDLmEQKoHmfmWjRhLF8dOQA1KVygFpKDrwP4B7IwgDkNdOYIDJBlgXt2O7wPenJEE3IG7DN9qhM9Ou8rx5slgMo5zzoT5hY2AjBBfTL48cfZhs6+OhzOvANtArBpR5AA5mEiIHc5GjPrCLLEcIXyW5O3uj07sTNgybTJgjU7Vna8KtEebe/1X/6z5QAmwT+AnL1g9CD4hTzcsMAiDba9mPCLQEv3G2RlTfoMoDNtvEnZ+quBZlR6Buwzx7lCvTMAz7SZIYDsuFlyZCrvnddGAIMDCMDfgbxCFIkKgUcg2q6m1X3/VWj7yTUD7Ec1iSHhLrJEcAT0dLIVKxHRRKwSQQSAq/dH15PdX2030z76LRj4oz7LV2kHQJRqIAgB1GOD31DRChF0bR3lM8GcKO91fYvuwmJr73y8yeQSRlL5zwL1rOJHk/jo/oxyR8e4GtDZ41fPoyeAQhKvVBk4Q/kD8FdIYLvhCTLxQozIAWzDBwCLQB3tj87BnQwTyl8hgkrbzKSNAHD1/gxJZNtkrhfVPLo2rfyV9hsBlMH8RMpfBjn8MpbyZ8asEEEbT/1GFZWOgB/tD13EBcpfBfwVbiCa+FfvrwA7OpfKWLNksZ7D8p8+lFwI9AS2H1U0A1Rp47YlwLTaTwF/7xSB9Oj+I+pfeX15SCYGyWYm5etGAhlQPmabqxwFjrsRgAaO+f0k5ccTcI+dBGuaHJLjReByCSNQ16PAj/qHgIUBKqrN2h7tH6ncFQQRgSoCeLQ/Gj+65gxxasufPSZrt/zHrAN4jcCfBjyG4RPPCZQdgAOuCLgeqUSEFIIeZt0VQD46pjeBryCBCMRX788CNjqPCplYx9wIIHQAB8GfVvwT3gNAgTQBflflme0l7qJCIDMgzwCvtQmcSZpECi82rTiECBTVsWbHi/pl9kdtzgT20bGW/xA5gNcc/K4bOAh8D8DdD3/kPygplhVLoL9Q+TPnESlUFdTV9rPOIgLw0f1HQRv9rjpE8I63EYDpAF5D8LuAP2j5o7GpSkMn/UNXvlfaZtxCa3Oh8lcAWWk7C9yzjpEFmAes2X3ZY2dIKNNm+feWA3hC8FeASNuS9QxZNbeOTfur38i6edkxI2BnVFc7kyPWPnO8yvhntI0m9WOSwBGQRy7g6P4skWwEMDiASfDjzTFdxX5m3f4CYCNyyCzwicZIkQUBv6fiFYWvtDVB9cjKnyWLqrqfBehZsM4CcbZfFrjR+BFRynGWf6cdwCT4GahSJBCAPwJrtx++6GOnQK3icVO5T3p+oAL0qG13fYScvImVAW/p+CoIzYxfPb8qkUSAuIIgZseMzjWzP9NmPb+NABpYXgPwlwAPE02vZjwT8BHJsMn7ZG6AzLoMAM9qU7H5Z6j7GWNkVLd6nCwAFVe2r5HCn7V/+crVAVSeAUALbyjhrPJ7LsIC9NaHKN4lDsBQVtMpOI7CIyg2ebxjzKr/DOgzfSok8NhtI2CeCfQjID3SN7pG3L985cvEOgAE/ZFXfSceCio7AMO1uIShriflFhySqQL2DMKgx0yofwbAnnupALYCpsx5PUaY8H4ILSoAjxzG8hUvi88C7Ee3VB5PjrZJuA02BgVp4EBSwM7E/cn1BBVV90A2tQ86RQCOCCuz/ygRZAF/lETOBLSnypXz9Igssy8igIp7WP7tTgAhcCfVuyOBE8DfLq4A/shVuERhAGsKpBeFBNH/gmRNqogoov2PRQJHj/MYJDBDDkeAPHs8fcxGAJaiVwHMwLZtS4Df7Kst+8HKgQX44fj7hizYz24XKbH8rmjzItAe3R+dU9WmZ53AB5UEZoE8228ggH+TdQAFADMgpQhGAZ0SAlHkSOGj/VZ4MRNCZPvMtuv6JQgqA9gqKWTBmAV3tl32uGcpvgWy6vZZpT8L5CgQlAA85a2qtwZ6RflDB5AEfwT4aL+21Fb7LIhn+kfAzfzHIhVgR22j8zmq/BVQZc61SgKV41fH9n6bWXI4q9/y5SoJiAMfBb9Xm7ccwXB8cQVE7QayIW8groI0s5KwOmYEHm9Cm/suUP+MEp/V5oiaV8B6VdsZEphR9Jk+FXLYCMAE0oTtb2OpCZoBq+kAjLFMsgDP4x33TOsfugohMnJuEUEM56lmRaSIV+/PnP8RwGfHrxzjyrZnksPlBPBlRhlwxrpnwW8CnWXJC0RymBCS5b4zwV5Wf+hwBNhH+lqW9rHdwVF1P9r/dQZ6ljiWlQC0SjIbPLRRilYFv0cC7Yc9WOrLAFWf94y9n+ljnZurdie8YnzquMS9PAUJHAVshqCs63oMsFeuzzvPaB8eZ/lS7QCU4jJVNckgUGurH1XuiVJfilSYFTdUtUIgR0nA67/tU7OjouBll2GEKVnQZ4EWXUPFps8es3KM15EEskoPt3T7KP02AojUO0UCk+CnoCWAzII7Au2w3yG8o6COzoUBioKCnKPrFBjJqRlQcQLVY2WJIjNuBaCvIwlUVX0G0NVjdATwMXEAAYBdEnhC8Ecgc/efGPNH5xFNdhOQRdt/ptpHCh3tj675CFE8JTFUjv2UriFz7GUlgOp/DNKRwUHwdxPfUeMjDoCCq5BfOOoEZvpr2x+BLavolXEyAM6obnTMzHEqoMuc09HxKv2rbTPAVYZO/ydUbXfkKP4/BnecprBuissAAAAASUVORK5CYII=";return TextureTools}();BABYLON.TextureTools=TextureTools})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var FramingBehavior=function(){function FramingBehavior(){this._mode=FramingBehavior.FitFrustumSidesMode;this._radiusScale=1;this._positionScale=.5;this._defaultElevation=.3;this._elevationReturnTime=1500;this._elevationReturnWaitTime=1e3;this._zoomStopsAnimation=false;this._framingTime=1500;this._isPointerDown=false;this._lastInteractionTime=-Infinity;this._animatables=new Array;this._betaIsAnimating=false}Object.defineProperty(FramingBehavior.prototype,"name",{get:function(){return"Framing"},enumerable:true,configurable:true});Object.defineProperty(FramingBehavior.prototype,"mode",{get:function(){return this._mode},set:function(mode){this._mode=mode},enumerable:true,configurable:true});Object.defineProperty(FramingBehavior.prototype,"radiusScale",{get:function(){return this._radiusScale},set:function(radius){this._radiusScale=radius},enumerable:true,configurable:true});Object.defineProperty(FramingBehavior.prototype,"positionScale",{get:function(){return this._positionScale},set:function(scale){this._positionScale=scale},enumerable:true,configurable:true});Object.defineProperty(FramingBehavior.prototype,"defaultElevation",{get:function(){return this._defaultElevation},set:function(elevation){this._defaultElevation=elevation},enumerable:true,configurable:true});Object.defineProperty(FramingBehavior.prototype,"elevationReturnTime",{get:function(){return this._elevationReturnTime},set:function(speed){this._elevationReturnTime=speed},enumerable:true,configurable:true});Object.defineProperty(FramingBehavior.prototype,"elevationReturnWaitTime",{get:function(){return this._elevationReturnWaitTime},set:function(time){this._elevationReturnWaitTime=time},enumerable:true,configurable:true});Object.defineProperty(FramingBehavior.prototype,"zoomStopsAnimation",{get:function(){return this._zoomStopsAnimation},set:function(flag){this._zoomStopsAnimation=flag},enumerable:true,configurable:true});Object.defineProperty(FramingBehavior.prototype,"framingTime",{get:function(){return this._framingTime},set:function(time){this._framingTime=time},enumerable:true,configurable:true});FramingBehavior.prototype.attach=function(camera){var _this=this;this._attachedCamera=camera;var scene=this._attachedCamera.getScene();FramingBehavior.EasingFunction.setEasingMode(FramingBehavior.EasingMode);this._onPrePointerObservableObserver=scene.onPrePointerObservable.add(function(pointerInfoPre){if(pointerInfoPre.type===BABYLON.PointerEventTypes.POINTERDOWN){_this._isPointerDown=true;return}if(pointerInfoPre.type===BABYLON.PointerEventTypes.POINTERUP){_this._isPointerDown=false}});this._onMeshTargetChangedObserver=camera.onMeshTargetChangedObservable.add(function(mesh){if(mesh){_this.zoomOnMesh(mesh)}});this._onAfterCheckInputsObserver=camera.onAfterCheckInputsObservable.add(function(){_this._applyUserInteraction();_this._maintainCameraAboveGround()})};FramingBehavior.prototype.detach=function(){var scene=this._attachedCamera.getScene();scene.onPrePointerObservable.remove(this._onPrePointerObservableObserver);this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver);this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver);this._attachedCamera=null};FramingBehavior.prototype.zoomOnMesh=function(mesh,focusOnOriginXZ,onAnimationEnd){if(focusOnOriginXZ===void 0){focusOnOriginXZ=false}if(onAnimationEnd===void 0){onAnimationEnd=null}mesh.computeWorldMatrix(true);var boundingBox=mesh.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(boundingBox.minimumWorld,boundingBox.maximumWorld,focusOnOriginXZ,onAnimationEnd)};FramingBehavior.prototype.zoomOnBoundingInfo=function(minimumWorld,maximumWorld,focusOnOriginXZ,onAnimationEnd){var _this=this;if(focusOnOriginXZ===void 0){focusOnOriginXZ=false}if(onAnimationEnd===void 0){onAnimationEnd=null}var zoomTarget;var bottom=minimumWorld.y;var top=maximumWorld.y;var zoomTargetY=bottom+(top-bottom)*this._positionScale;var radiusWorld=maximumWorld.subtract(minimumWorld).scale(.5);if(focusOnOriginXZ){zoomTarget=new BABYLON.Vector3(0,zoomTargetY,0)}else{var centerWorld=minimumWorld.add(radiusWorld);zoomTarget=new BABYLON.Vector3(centerWorld.x,zoomTargetY,centerWorld.z)}if(!this._vectorTransition){this._vectorTransition=BABYLON.Animation.CreateAnimation("target",BABYLON.Animation.ANIMATIONTYPE_VECTOR3,60,FramingBehavior.EasingFunction)}this._betaIsAnimating=true;this._animatables.push(BABYLON.Animation.TransitionTo("target",zoomTarget,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime));var radius=0;if(this._mode===FramingBehavior.FitFrustumSidesMode){var position=this._calculateLowerRadiusFromModelBoundingSphere(minimumWorld,maximumWorld);this._attachedCamera.lowerRadiusLimit=radiusWorld.length()+this._attachedCamera.minZ;radius=position}else if(this._mode===FramingBehavior.IgnoreBoundsSizeMode){radius=this._calculateLowerRadiusFromModelBoundingSphere(minimumWorld,maximumWorld);if(this._attachedCamera.lowerRadiusLimit===null){this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ}}var extend=maximumWorld.subtract(minimumWorld).length();this._attachedCamera.panningSensibility=5e3/extend;this._attachedCamera.wheelPrecision=100/radius;if(!this._radiusTransition){this._radiusTransition=BABYLON.Animation.CreateAnimation("radius",BABYLON.Animation.ANIMATIONTYPE_FLOAT,60,FramingBehavior.EasingFunction)}this._animatables.push(BABYLON.Animation.TransitionTo("radius",radius,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,function(){if(onAnimationEnd){onAnimationEnd()}_this._attachedCamera.storeState()}))};FramingBehavior.prototype._calculateLowerRadiusFromModelBoundingSphere=function(minimumWorld,maximumWorld){var size=maximumWorld.subtract(minimumWorld);var boxVectorGlobalDiagonal=size.length();var frustumSlope=this._getFrustumSlope();var radiusWithoutFraming=boxVectorGlobalDiagonal*.5;var radius=radiusWithoutFraming*this._radiusScale;var distanceForHorizontalFrustum=radius*Math.sqrt(1+1/(frustumSlope.x*frustumSlope.x));var distanceForVerticalFrustum=radius*Math.sqrt(1+1/(frustumSlope.y*frustumSlope.y));var distance=Math.max(distanceForHorizontalFrustum,distanceForVerticalFrustum);var camera=this._attachedCamera;if(camera.lowerRadiusLimit&&this._mode===FramingBehavior.IgnoreBoundsSizeMode){distance=distance<camera.lowerRadiusLimit?camera.lowerRadiusLimit:distance}if(camera.upperRadiusLimit){distance=distance>camera.upperRadiusLimit?camera.upperRadiusLimit:distance}return distance};FramingBehavior.prototype._maintainCameraAboveGround=function(){var _this=this;if(this._elevationReturnTime<0){return}var timeSinceInteraction=BABYLON.Tools.Now-this._lastInteractionTime;var defaultBeta=Math.PI*.5-this._defaultElevation;var limitBeta=Math.PI*.5;if(!this._betaIsAnimating&&this._attachedCamera.beta>limitBeta&&timeSinceInteraction>=this._elevationReturnWaitTime){this._betaIsAnimating=true;this.stopAllAnimations();if(!this._betaTransition){this._betaTransition=BABYLON.Animation.CreateAnimation("beta",BABYLON.Animation.ANIMATIONTYPE_FLOAT,60,FramingBehavior.EasingFunction)}this._animatables.push(BABYLON.Animation.TransitionTo("beta",defaultBeta,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,function(){_this._clearAnimationLocks();_this.stopAllAnimations()}))}};FramingBehavior.prototype._getFrustumSlope=function(){var camera=this._attachedCamera;var engine=camera.getScene().getEngine();var aspectRatio=engine.getAspectRatio(camera);var frustumSlopeY=Math.tan(camera.fov/2);var frustumSlopeX=frustumSlopeY*aspectRatio;return new BABYLON.Vector2(frustumSlopeX,frustumSlopeY)};FramingBehavior.prototype._clearAnimationLocks=function(){this._betaIsAnimating=false};FramingBehavior.prototype._applyUserInteraction=function(){if(this.isUserIsMoving){this._lastInteractionTime=BABYLON.Tools.Now;this.stopAllAnimations();this._clearAnimationLocks()}};FramingBehavior.prototype.stopAllAnimations=function(){this._attachedCamera.animations=[];while(this._animatables.length){if(this._animatables[0]){this._animatables[0].onAnimationEnd=null;this._animatables[0].stop()}this._animatables.shift()}};Object.defineProperty(FramingBehavior.prototype,"isUserIsMoving",{get:function(){return this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown},enumerable:true,configurable:true});FramingBehavior.EasingFunction=new BABYLON.ExponentialEase;FramingBehavior.EasingMode=BABYLON.EasingFunction.EASINGMODE_EASEINOUT;FramingBehavior.IgnoreBoundsSizeMode=0;FramingBehavior.FitFrustumSidesMode=1;return FramingBehavior}();BABYLON.FramingBehavior=FramingBehavior})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var BouncingBehavior=function(){function BouncingBehavior(){this.transitionDuration=450;this.lowerRadiusTransitionRange=2;this.upperRadiusTransitionRange=-2;this._autoTransitionRange=false;this._radiusIsAnimating=false;this._radiusBounceTransition=null;this._animatables=new Array}Object.defineProperty(BouncingBehavior.prototype,"name",{get:function(){return"Bouncing"},enumerable:true,configurable:true});Object.defineProperty(BouncingBehavior.prototype,"autoTransitionRange",{get:function(){return this._autoTransitionRange},set:function(value){var _this=this;if(this._autoTransitionRange===value){return}this._autoTransitionRange=value;var camera=this._attachedCamera;if(value){this._onMeshTargetChangedObserver=camera.onMeshTargetChangedObservable.add(function(mesh){if(!mesh){return}mesh.computeWorldMatrix(true);var diagonal=mesh.getBoundingInfo().diagonalLength;_this.lowerRadiusTransitionRange=diagonal*.05;_this.upperRadiusTransitionRange=diagonal*.05})}else if(this._onMeshTargetChangedObserver){camera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver)}},enumerable:true,configurable:true});BouncingBehavior.prototype.attach=function(camera){var _this=this;this._attachedCamera=camera;this._onAfterCheckInputsObserver=camera.onAfterCheckInputsObservable.add(function(){if(_this._isRadiusAtLimit(_this._attachedCamera.lowerRadiusLimit)){_this._applyBoundRadiusAnimation(_this.lowerRadiusTransitionRange)}if(_this._isRadiusAtLimit(_this._attachedCamera.upperRadiusLimit)){_this._applyBoundRadiusAnimation(_this.upperRadiusTransitionRange)}})};BouncingBehavior.prototype.detach=function(){this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver);if(this._onMeshTargetChangedObserver){this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver)}this._attachedCamera=null};BouncingBehavior.prototype._isRadiusAtLimit=function(radiusLimit){if(this._attachedCamera.radius===radiusLimit&&!this._radiusIsAnimating){return true}return false};BouncingBehavior.prototype._applyBoundRadiusAnimation=function(radiusDelta){var _this=this;if(!this._radiusBounceTransition){BouncingBehavior.EasingFunction.setEasingMode(BouncingBehavior.EasingMode);this._radiusBounceTransition=BABYLON.Animation.CreateAnimation("radius",BABYLON.Animation.ANIMATIONTYPE_FLOAT,60,BouncingBehavior.EasingFunction)}this._cachedWheelPrecision=this._attachedCamera.wheelPrecision;this._attachedCamera.wheelPrecision=Infinity;this._attachedCamera.inertialRadiusOffset=0;this.stopAllAnimations();this._radiusIsAnimating=true;this._animatables.push(BABYLON.Animation.TransitionTo("radius",this._attachedCamera.radius+radiusDelta,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,function(){return _this._clearAnimationLocks()}))};BouncingBehavior.prototype._clearAnimationLocks=function(){this._radiusIsAnimating=false;this._attachedCamera.wheelPrecision=this._cachedWheelPrecision};BouncingBehavior.prototype.stopAllAnimations=function(){this._attachedCamera.animations=[];while(this._animatables.length){this._animatables[0].onAnimationEnd=null;this._animatables[0].stop();this._animatables.shift()}};BouncingBehavior.EasingFunction=new BABYLON.BackEase(.3);BouncingBehavior.EasingMode=BABYLON.EasingFunction.EASINGMODE_EASEOUT;return BouncingBehavior}();BABYLON.BouncingBehavior=BouncingBehavior})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var AutoRotationBehavior=function(){function AutoRotationBehavior(){this._zoomStopsAnimation=false;this._idleRotationSpeed=.05;this._idleRotationWaitTime=2e3;this._idleRotationSpinupTime=2e3;this._isPointerDown=false;this._lastFrameTime=null;this._lastInteractionTime=-Infinity;this._cameraRotationSpeed=0;this._lastFrameRadius=0}Object.defineProperty(AutoRotationBehavior.prototype,"name",{get:function(){return"AutoRotation"},enumerable:true,configurable:true});Object.defineProperty(AutoRotationBehavior.prototype,"zoomStopsAnimation",{get:function(){return this._zoomStopsAnimation},set:function(flag){this._zoomStopsAnimation=flag},enumerable:true,configurable:true});Object.defineProperty(AutoRotationBehavior.prototype,"idleRotationSpeed",{get:function(){return this._idleRotationSpeed},set:function(speed){this._idleRotationSpeed=speed},enumerable:true,configurable:true});Object.defineProperty(AutoRotationBehavior.prototype,"idleRotationWaitTime",{get:function(){return this._idleRotationWaitTime},set:function(time){this._idleRotationWaitTime=time},enumerable:true,configurable:true});Object.defineProperty(AutoRotationBehavior.prototype,"idleRotationSpinupTime",{get:function(){return this._idleRotationSpinupTime},set:function(time){this._idleRotationSpinupTime=time},enumerable:true,configurable:true});Object.defineProperty(AutoRotationBehavior.prototype,"rotationInProgress",{get:function(){return Math.abs(this._cameraRotationSpeed)>0},enumerable:true,configurable:true});AutoRotationBehavior.prototype.attach=function(camera){var _this=this;this._attachedCamera=camera;var scene=this._attachedCamera.getScene();this._onPrePointerObservableObserver=scene.onPrePointerObservable.add(function(pointerInfoPre){if(pointerInfoPre.type===BABYLON.PointerEventTypes.POINTERDOWN){_this._isPointerDown=true;return}if(pointerInfoPre.type===BABYLON.PointerEventTypes.POINTERUP){_this._isPointerDown=false}});this._onAfterCheckInputsObserver=camera.onAfterCheckInputsObservable.add(function(){var now=BABYLON.Tools.Now;var dt=0;if(_this._lastFrameTime!=null){dt=now-_this._lastFrameTime}_this._lastFrameTime=now;_this._applyUserInteraction();var timeToRotation=now-_this._lastInteractionTime-_this._idleRotationWaitTime;var scale=Math.max(Math.min(timeToRotation/_this._idleRotationSpinupTime,1),0);_this._cameraRotationSpeed=_this._idleRotationSpeed*scale;_this._attachedCamera.alpha-=_this._cameraRotationSpeed*(dt/1e3)})};AutoRotationBehavior.prototype.detach=function(){var scene=this._attachedCamera.getScene();scene.onPrePointerObservable.remove(this._onPrePointerObservableObserver);this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver);this._attachedCamera=null};AutoRotationBehavior.prototype._userIsZooming=function(){return this._attachedCamera.inertialRadiusOffset!==0};AutoRotationBehavior.prototype._shouldAnimationStopForInteraction=function(){var zoomHasHitLimit=false;if(this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0){zoomHasHitLimit=true}this._lastFrameRadius=this._attachedCamera.radius;return this._zoomStopsAnimation?zoomHasHitLimit:this._userIsZooming()};AutoRotationBehavior.prototype._applyUserInteraction=function(){if(this._userIsMoving()&&!this._shouldAnimationStopForInteraction()){this._lastInteractionTime=BABYLON.Tools.Now}};AutoRotationBehavior.prototype._userIsMoving=function(){return this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown};return AutoRotationBehavior}();BABYLON.AutoRotationBehavior=AutoRotationBehavior})(BABYLON||(BABYLON={}));var BABYLON;(function(BABYLON){var NullEngineOptions=function(){function NullEngineOptions(){this.renderWidth=512;this.renderHeight=256;this.textureSize=512}return NullEngineOptions}();BABYLON.NullEngineOptions=NullEngineOptions;var NullEngine=function(_super){__extends(NullEngine,_super);function NullEngine(options){if(options===void 0){options=new NullEngineOptions}var _this=_super.call(this,null)||this;_this._options=options;_this._caps=new BABYLON.EngineCapabilities;_this._caps.maxTexturesImageUnits=16;_this._caps.maxVertexTextureImageUnits=16;_this._caps.maxTextureSize=512;_this._caps.maxCubemapTextureSize=512;_this._caps.maxRenderTextureSize=512;_this._caps.maxVertexAttribs=16;_this._caps.maxVaryingVectors=16;_this._caps.maxFragmentUniformVectors=16;_this._caps.maxVertexUniformVectors=16;_this._caps.standardDerivatives=false;_this._caps.astc=null;_this._caps.s3tc=null;_this._caps.pvrtc=null;_this._caps.etc1=null;_this._caps.etc2=null;_this._caps.textureAnisotropicFilterExtension=null;_this._caps.maxAnisotropy=0;_this._caps.uintIndices=false;_this._caps.fragmentDepthSupported=false;_this._caps.highPrecisionShaderSupported=true;_this._caps.colorBufferFloat=false;_this._caps.textureFloat=false;_this._caps.textureFloatLinearFiltering=false;_this._caps.textureFloatRender=false;_this._caps.textureHalfFloat=false;_this._caps.textureHalfFloatLinearFiltering=false;_this._caps.textureHalfFloatRender=false;_this._caps.textureLOD=false;_this._caps.drawBuffersExtension=false;_this._caps.depthTextureExtension=false;_this._caps.vertexArrayObject=false;_this._caps.instancedArrays=false;BABYLON.Tools.Log("Babylon.js null engine (v"+BABYLON.Engine.Version+") launched");if(typeof URL==="undefined"){URL={createObjectURL:function(){},revokeObjectURL:function(){}}}if(typeof Blob==="undefined"){Blob=function(){}}return _this}NullEngine.prototype.createVertexBuffer=function(vertices){return{capacity:0,references:1,is32Bits:false}};NullEngine.prototype.createIndexBuffer=function(indices){return{capacity:0,references:1,is32Bits:false}};NullEngine.prototype.clear=function(color,backBuffer,depth,stencil){if(stencil===void 0){stencil=false}};NullEngine.prototype.getRenderWidth=function(useScreen){if(useScreen===void 0){useScreen=false}if(!useScreen&&this._currentRenderTarget){return this._currentRenderTarget.width}return this._options.renderWidth};NullEngine.prototype.getRenderHeight=function(useScreen){if(useScreen===void 0){useScreen=false}if(!useScreen&&this._currentRenderTarget){return this._currentRenderTarget.height}return this._options.renderHeight};NullEngine.prototype.setViewport=function(viewport,requiredWidth,requiredHeight){this._cachedViewport=viewport};NullEngine.prototype.createShaderProgram=function(vertexCode,fragmentCode,defines,context){return{__SPECTOR_rebuildProgram:undefined}};NullEngine.prototype.getUniforms=function(shaderProgram,uniformsNames){return[]};NullEngine.prototype.getAttributes=function(shaderProgram,attributesNames){return[]};NullEngine.prototype.bindSamplers=function(effect){this._currentEffect=null};NullEngine.prototype.enableEffect=function(effect){this._currentEffect=effect;if(effect.onBind){effect.onBind(effect)}effect.onBindObservable.notifyObservers(effect)};NullEngine.prototype.setState=function(culling,zOffset,force,reverseSide){if(zOffset===void 0){zOffset=0}if(reverseSide===void 0){reverseSide=false}};NullEngine.prototype.setIntArray=function(uniform,array){};NullEngine.prototype.setIntArray2=function(uniform,array){};NullEngine.prototype.setIntArray3=function(uniform,array){};NullEngine.prototype.setIntArray4=function(uniform,array){};NullEngine.prototype.setFloatArray=function(uniform,array){};NullEngine.prototype.setFloatArray2=function(uniform,array){};NullEngine.prototype.setFloatArray3=function(uniform,array){};NullEngine.prototype.setFloatArray4=function(uniform,array){};NullEngine.prototype.setArray=function(uniform,array){};NullEngine.prototype.setArray2=function(uniform,array){};NullEngine.prototype.setArray3=function(uniform,array){};NullEngine.prototype.setArray4=function(uniform,array){};NullEngine.prototype.setMatrices=function(uniform,matrices){};NullEngine.prototype.setMatrix=function(uniform,matrix){};NullEngine.prototype.setMatrix3x3=function(uniform,matrix){};NullEngine.prototype.setMatrix2x2=function(uniform,matrix){};NullEngine.prototype.setFloat=function(uniform,value){};NullEngine.prototype.setFloat2=function(uniform,x,y){};NullEngine.prototype.setFloat3=function(uniform,x,y,z){};NullEngine.prototype.setBool=function(uniform,bool){};NullEngine.prototype.setFloat4=function(uniform,x,y,z,w){};NullEngine.prototype.setColor3=function(uniform,color3){};NullEngine.prototype.setColor4=function(uniform,color3,alpha){};NullEngine.prototype.setAlphaMode=function(mode,noDepthWriteChange){if(noDepthWriteChange===void 0){noDepthWriteChange=false}if(this._alphaMode===mode){return}this._alphaState.alphaBlend=mode!==BABYLON.Engine.ALPHA_DISABLE;if(!noDepthWriteChange){this.setDepthWrite(mode===BABYLON.Engine.ALPHA_DISABLE)}this._alphaMode=mode};NullEngine.prototype.bindBuffers=function(vertexBuffers,indexBuffer,effect){};NullEngine.prototype.wipeCaches=function(bruteForce){if(this.preventCacheWipeBetweenFrames){return}this.resetTextureCache();this._currentEffect=null;if(bruteForce){this._currentProgram=null;this._stencilState.reset();this._depthCullingState.reset();this.setDepthFunctionToLessOrEqual();this._alphaState.reset()}this._cachedVertexBuffers=null;this._cachedIndexBuffer=null;this._cachedEffectForVertexBuffers=null};NullEngine.prototype.draw=function(useTriangles,indexStart,indexCount,instancesCount){};NullEngine.prototype._createTexture=function(){return{}};NullEngine.prototype.createTexture=function(urlArg,noMipmap,invertY,scene,samplingMode,onLoad,onError,buffer,fallBack,format){if(samplingMode===void 0){samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}if(onLoad===void 0){onLoad=null}if(onError===void 0){onError=null}if(buffer===void 0){buffer=null}var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_URL);var url=String(urlArg);texture.url=url;texture.generateMipMaps=!noMipmap;texture.samplingMode=samplingMode;texture.invertY=invertY;texture.baseWidth=this._options.textureSize;texture.baseHeight=this._options.textureSize;texture.width=this._options.textureSize;texture.height=this._options.textureSize;texture.format=format;texture.isReady=true;if(onLoad){onLoad()}return texture};NullEngine.prototype.createRenderTargetTexture=function(size,options){var fullOptions=new BABYLON.RenderTargetCreationOptions;if(options!==undefined&&typeof options==="object"){fullOptions.generateMipMaps=options.generateMipMaps;fullOptions.generateDepthBuffer=options.generateDepthBuffer===undefined?true:options.generateDepthBuffer;fullOptions.generateStencilBuffer=fullOptions.generateDepthBuffer&&options.generateStencilBuffer;fullOptions.type=options.type===undefined?BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT:options.type;fullOptions.samplingMode=options.samplingMode===undefined?BABYLON.Texture.TRILINEAR_SAMPLINGMODE:options.samplingMode}else{fullOptions.generateMipMaps=options;fullOptions.generateDepthBuffer=true;fullOptions.generateStencilBuffer=false;fullOptions.type=BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT;fullOptions.samplingMode=BABYLON.Texture.TRILINEAR_SAMPLINGMODE}var texture=new BABYLON.InternalTexture(this,BABYLON.InternalTexture.DATASOURCE_RENDERTARGET);var width=size.width||size;var height=size.height||size;texture._depthStencilBuffer={};texture._framebuffer={};texture.baseWidth=width;texture.baseHeight=height;texture.width=width;texture.height=height;texture.isReady=true;texture.samples=1;texture.generateMipMaps=fullOptions.generateMipMaps;texture.samplingMode=fullOptions.samplingMode;texture.type=fullOptions.type;texture._generateDepthBuffer=fullOptions.generateDepthBuffer;texture._generateStencilBuffer=fullOptions.generateStencilBuffer;return texture};NullEngine.prototype.updateTextureSamplingMode=function(samplingMode,texture){texture.samplingMode=samplingMode};NullEngine.prototype.bindFramebuffer=function(texture,faceIndex,requiredWidth,requiredHeight,forceFullscreenViewport){if(this._currentRenderTarget){this.unBindFramebuffer(this._currentRenderTarget)}this._currentRenderTarget=texture;this._currentFramebuffer=texture._MSAAFramebuffer?texture._MSAAFramebuffer:texture._framebuffer;if(this._cachedViewport&&!forceFullscreenViewport){this.setViewport(this._cachedViewport,requiredWidth,requiredHeight)}};NullEngine.prototype.unBindFramebuffer=function(texture,disableGenerateMipMaps,onBeforeUnbind){if(disableGenerateMipMaps===void 0){disableGenerateMipMaps=false}this._currentRenderTarget=null;if(onBeforeUnbind){if(texture._MSAAFramebuffer){this._currentFramebuffer=texture._framebuffer}onBeforeUnbind()}this._currentFramebuffer=null};NullEngine.prototype.createDynamicVertexBuffer=function(vertices){var vbo={capacity:1,references:1,is32Bits:false};return vbo};NullEngine.prototype.updateDynamicIndexBuffer=function(indexBuffer,indices,offset){if(offset===void 0){offset=0}};NullEngine.prototype.updateDynamicVertexBuffer=function(vertexBuffer,vertices,offset,count){};NullEngine.prototype._bindTextureDirectly=function(target,texture){if(this._activeTexturesCache[this._activeTexture]!==texture){this._activeTexturesCache[this._activeTexture]=texture}};NullEngine.prototype._bindTexture=function(channel,texture){if(channel<0){return}this._bindTextureDirectly(0,texture)};return NullEngine}(BABYLON.Engine);BABYLON.NullEngine=NullEngine})(BABYLON||(BABYLON={}));BABYLON.Effect.ShadersStore={defaultVertexShader:"#include<__decl__defaultVertex>\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nvarying vec2 vDiffuseUV;\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nvarying vec2 vAmbientUV;\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nvarying vec2 vOpacityUV;\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nvarying vec2 vEmissiveUV;\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nvarying vec2 vLightmapUV;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM) && SPECULARDIRECTUV == 0\nvarying vec2 vSpecularUV;\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nvarying vec2 vBumpUV;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\nvec3 positionUpdated=position;\n#ifdef NORMAL \nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nif (vDiffuseInfos.x == 0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM) && SPECULARDIRECTUV == 0\nif (vSpecularInfos.x == 0.)\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\n\nvColor=color;\n#endif\n#include<pointCloudVertex>\n#include<logDepthVertex>\n}",defaultPixelShader:"#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define RECIPROCAL_PI2 0.15915494\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n\n#include<helperFunctions>\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV == 1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV == 2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef AMBIENT\n#if AMBIENTDIRECTUV == 1\n#define vAmbientUV vMainUV1\n#elif AMBIENTDIRECTUV == 2\n#define vAmbientUV vMainUV2\n#else\nvarying vec2 vAmbientUV;\n#endif\nuniform sampler2D ambientSampler;\n#endif\n#ifdef OPACITY \n#if OPACITYDIRECTUV == 1\n#define vOpacityUV vMainUV1\n#elif OPACITYDIRECTUV == 2\n#define vOpacityUV vMainUV2\n#else\nvarying vec2 vOpacityUV;\n#endif\nuniform sampler2D opacitySampler;\n#endif\n#ifdef EMISSIVE\n#if EMISSIVEDIRECTUV == 1\n#define vEmissiveUV vMainUV1\n#elif EMISSIVEDIRECTUV == 2\n#define vEmissiveUV vMainUV2\n#else\nvarying vec2 vEmissiveUV;\n#endif\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\n#if LIGHTMAPDIRECTUV == 1\n#define vLightmapUV vMainUV1\n#elif LIGHTMAPDIRECTUV == 2\n#define vLightmapUV vMainUV2\n#else\nvarying vec2 vLightmapUV;\n#endif\nuniform sampler2D lightmapSampler;\n#endif\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\n#if SPECULARDIRECTUV == 1\n#define vSpecularUV vMainUV1\n#elif SPECULARDIRECTUV == 2\n#define vSpecularUV vMainUV2\n#else\nvarying vec2 vSpecularUV;\n#endif\nuniform sampler2D specularSampler;\n#endif\n\n#include<fresnelFunction>\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\nvoid main(void) {\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\n\nfloat alpha=vDiffuseColor.a;\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#include<depthPrePass>\n#ifdef VERTEXCOLOR\nbaseColor.rgb*=vColor.rgb;\n#endif\n\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\n\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\n\nvec3 refractionColor=vec3(0.,0.,0.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0)\n{\nrefractionColor=textureCube(refractionCubeSampler,refractionVector).rgb*vRefractionInfos.x;\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords).rgb*vRefractionInfos.x;\n#endif\n#endif\n\nvec3 reflectionColor=vec3(0.,0.,0.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias).rgb*vReflectionInfos.x;\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW).rgb*vReflectionInfos.x;\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords).rgb*vReflectionInfos.x;\n#endif\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+emissiveColor+refractionColor,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+refractionColor,alpha);\n#endif\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor;\n#else\ncolor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n\n\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);\ncolor=applyImageProcessing(color);\n#endif\n#endif\ngl_FragColor=color;\n}",pbrVertexShader:"precision highp float;\n#include<__decl__pbrVertex>\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2; \n#endif \n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#if defined(ALBEDO) && ALBEDODIRECTUV == 0\nvarying vec2 vAlbedoUV;\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nvarying vec2 vAmbientUV;\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nvarying vec2 vOpacityUV;\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nvarying vec2 vEmissiveUV;\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nvarying vec2 vLightmapUV;\n#endif\n#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0\nvarying vec2 vReflectivityUV;\n#endif\n#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0\nvarying vec2 vMicroSurfaceSamplerUV;\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nvarying vec2 vBumpUV;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && !defined(USESPHERICALINFRAGMENT)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#if defined(USESPHERICALFROMREFLECTIONMAP) && !defined(USESPHERICALINFRAGMENT)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=environmentIrradianceJones(reflectionVector);\n#endif\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif \n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif \n#if defined(ALBEDO) && ALBEDODIRECTUV == 0 \nif (vAlbedoInfos.x == 0.)\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0 \nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0 \nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0 \nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0 \nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0 \nif (vReflectivityInfos.x == 0.)\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0 \nif (vMicroSurfaceSamplerInfos.x == 0.)\n{\nvMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0 \nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n\n#include<bumpVertex>\n\n#include<clipPlaneVertex>\n\n#include<fogVertex>\n\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n\n#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif\n\n#include<logDepthVertex>\n}",pbrPixelShader:"#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nprecision highp float;\n#include<__decl__pbrFragment>\nuniform vec4 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec4 vCameraInfos;\n\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && !defined(USESPHERICALINFRAGMENT)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n\n#ifdef ALBEDO\n#if ALBEDODIRECTUV == 1\n#define vAlbedoUV vMainUV1\n#elif ALBEDODIRECTUV == 2\n#define vAlbedoUV vMainUV2\n#else\nvarying vec2 vAlbedoUV;\n#endif\nuniform sampler2D albedoSampler;\n#endif\n#ifdef AMBIENT\n#if AMBIENTDIRECTUV == 1\n#define vAmbientUV vMainUV1\n#elif AMBIENTDIRECTUV == 2\n#define vAmbientUV vMainUV2\n#else\nvarying vec2 vAmbientUV;\n#endif\nuniform sampler2D ambientSampler;\n#endif\n#ifdef OPACITY\n#if OPACITYDIRECTUV == 1\n#define vOpacityUV vMainUV1\n#elif OPACITYDIRECTUV == 2\n#define vOpacityUV vMainUV2\n#else\nvarying vec2 vOpacityUV;\n#endif\nuniform sampler2D opacitySampler;\n#endif\n#ifdef EMISSIVE\n#if EMISSIVEDIRECTUV == 1\n#define vEmissiveUV vMainUV1\n#elif EMISSIVEDIRECTUV == 2\n#define vEmissiveUV vMainUV2\n#else\nvarying vec2 vEmissiveUV;\n#endif\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\n#if LIGHTMAPDIRECTUV == 1\n#define vLightmapUV vMainUV1\n#elif LIGHTMAPDIRECTUV == 2\n#define vLightmapUV vMainUV2\n#else\nvarying vec2 vLightmapUV;\n#endif\nuniform sampler2D lightmapSampler;\n#endif\n#ifdef REFLECTIVITY\n#if REFLECTIVITYDIRECTUV == 1\n#define vReflectivityUV vMainUV1\n#elif REFLECTIVITYDIRECTUV == 2\n#define vReflectivityUV vMainUV2\n#else\nvarying vec2 vReflectivityUV;\n#endif\nuniform sampler2D reflectivitySampler;\n#endif\n#ifdef MICROSURFACEMAP\n#if MICROSURFACEMAPDIRECTUV == 1\n#define vMicroSurfaceSamplerUV vMainUV1\n#elif MICROSURFACEMAPDIRECTUV == 2\n#define vMicroSurfaceSamplerUV vMainUV2\n#else\nvarying vec2 vMicroSurfaceSamplerUV;\n#endif\nuniform sampler2D microSurfaceSampler;\n#endif\n\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#endif\n#endif\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n\n#include<shadowsFragmentFunctions>\n#include<pbrFunctions>\n#include<harmonicsFunctions>\n#include<pbrLightFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\n#include<clipPlaneFragment>\n\n\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\n#include<bumpFragment>\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n\n\nvec3 surfaceAlbedo=vAlbedoColor.rgb;\n\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\nsurfaceAlbedo*=vAlbedoInfos.y;\n#endif\n\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#if !defined(LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\nif (alpha<=ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\n\nalpha=1.0;\n#endif\n#endif\n#endif\n#include<depthPrePass>\n#ifdef VERTEXCOLOR\nsurfaceAlbedo*=vColor.rgb;\n#endif\n\nvec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#endif\n\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\nvec4 surfaceMetallicColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicColorMap.r,surfaceMetallicColorMap.r,surfaceMetallicColorMap.r);\nambientOcclusionColor=mix(ambientOcclusionColor,aoStoreInMetalMap,vReflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicColorMap.g;\n#endif\n#endif\n#endif\n#ifdef MICROSURFACEMAP\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n\nmicroSurface=1.0-metallicRoughness.g;\n\nvec3 baseColor=surfaceAlbedo;\n\n\nconst vec3 DefaultSpecularReflectanceDielectric=vec3(0.04,0.04,0.04);\n\nsurfaceAlbedo=mix(baseColor.rgb*(1.0-DefaultSpecularReflectanceDielectric.r),vec3(0.,0.,0.),metallicRoughness.r);\n\nsurfaceReflectivityColor=mix(DefaultSpecularReflectanceDielectric,baseColor,metallicRoughness.r);\n#else\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nsurfaceReflectivityColor*=toLinearSpace(surfaceReflectivityColorMap.rgb);\nsurfaceReflectivityColor*=vReflectivityInfos.y;\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceReflectivityColorMap.a;\nmicroSurface*=vReflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#endif\n#endif\n#endif\n\nmicroSurface=clamp(microSurface,0.,1.);\n\nfloat roughness=1.-microSurface;\n\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\n\n\n\nfloat opacityPerceptual=alpha;\nfloat opacity0=opacityPerceptual*opacityPerceptual;\nfloat opacity90=fresnelGrazingReflectance(opacity0);\nvec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);\n\nalpha=fresnelSchlickEnvironmentGGX(clamp(dot(viewDirectionW,normalForward),0.0,1.0),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (alpha<=ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\n\nalpha=1.0;\n#endif\n#endif\n#endif\n#endif\n\n\nfloat NdotVUnclamped=dot(normalW,viewDirectionW);\nfloat NdotV=clamp(NdotVUnclamped,0.,1.)+0.00001;\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\n\n#ifdef REFRACTION\nvec3 environmentRefraction=vec3(0.,0.,0.);\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#ifdef REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nvec3 refractionCoords=refractionVector;\nrefractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODINREFRACTIONALPHA\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#else\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,1.0);\n#endif\n#ifdef LODBASEDMICROSFURACE\n\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef LODINREFRACTIONALPHA\n\n\n\n\n\n\n\n\n\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);\nfloat requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD).rgb;\n#else\nfloat lodRefractionNormalized=clamp(refractionLOD/log2(vRefractionMicrosurfaceInfos.x),0.,1.);\nfloat lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;\nvec3 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords).rgb;\nif(lodRefractionNormalizedDoubled<1.0){\nenvironmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords).rgb,\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);\n}else{\nenvironmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords).rgb,\nlodRefractionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef GAMMAREFRACTION\nenvironmentRefraction=toLinearSpace(environmentRefraction.rgb);\n#endif\n\nenvironmentRefraction*=vRefractionInfos.x;\n#endif\n\n#ifdef REFLECTION\nvec3 environmentRadiance=vec3(0.,0.,0.);\nvec3 environmentIrradiance=vec3(0.,0.,0.);\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,1.);\n#endif\n#ifdef LODBASEDMICROSFURACE\n\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\n\n\n\n\n\n\n\n\n\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);\nfloat requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,requestedReflectionLOD).rgb;\n#else\nfloat lodReflectionNormalized=clamp(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x),0.,1.);\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec3 environmentSpecularMid=sampleReflection(reflectionSampler,reflectionCoords).rgb;\nif(lodReflectionNormalizedDoubled<1.0){\nenvironmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords).rgb,\nenvironmentSpecularMid,\nlodReflectionNormalizedDoubled\n);\n}else{\nenvironmentRadiance=mix(\nenvironmentSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords).rgb,\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance=toLinearSpace(environmentRadiance.rgb);\n#endif\n\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && !defined(USESPHERICALINFRAGMENT)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\nenvironmentIrradiance=environmentIrradianceJones(irradianceVector);\n#endif\n#endif\n\nenvironmentRadiance*=vReflectionInfos.x;\nenvironmentRadiance*=vReflectionColor.rgb;\nenvironmentIrradiance*=vReflectionColor.rgb;\n#endif\n\n\n\nfloat reflectance=max(max(surfaceReflectivityColor.r,surfaceReflectivityColor.g),surfaceReflectivityColor.b);\nfloat reflectance90=fresnelGrazingReflectance(reflectance);\nvec3 specularEnvironmentR0=surfaceReflectivityColor.rgb;\nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0)*reflectance90;\n\nvec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\nlightingInfo info;\nfloat shadow=1.; \nfloat NdotL=-1.;\n#include<lightFragment>[0..maxSimultaneousLights]\n\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n\nvec2 brdfSamplerUV=vec2(NdotV,roughness);\n\nvec4 environmentBrdf=texture2D(environmentBrdfSampler,brdfSamplerUV);\nvec3 specularEnvironmentReflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\nspecularEnvironmentReflectance*=seo;\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(reflectionCoords,normalW);\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#else\n\nvec3 specularEnvironmentReflectance=fresnelSchlickEnvironmentGGX(NdotV,specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n\n#ifdef REFRACTION\nvec3 refractance=vec3(0.0,0.0,0.0);\nvec3 transmission=vec3(1.0,1.0,1.0);\n#ifdef LINKREFRACTIONTOTRANSPARENCY\n\ntransmission*=(1.0-alpha);\n\n\nvec3 mixedAlbedo=surfaceAlbedo;\nfloat maxChannel=max(max(mixedAlbedo.r,mixedAlbedo.g),mixedAlbedo.b);\nvec3 tint=clamp(maxChannel*mixedAlbedo,0.0,1.0);\n\nsurfaceAlbedo*=alpha;\n\nenvironmentIrradiance*=alpha;\n\nenvironmentRefraction*=tint;\n\nalpha=1.0;\n#endif\n\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\nspecularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,alpha);\n\ntransmission*=1.0-specularEnvironmentReflectance;\n\nrefractance=transmission;\n#endif\n\n\n\n\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n\nvec3 finalDiffuse=diffuseBase;\nfinalDiffuse.rgb+=vAmbientColor;\nfinalDiffuse*=surfaceAlbedo.rgb;\nfinalDiffuse=max(finalDiffuse,0.0);\n\n#ifdef REFLECTION\nvec3 finalIrradiance=environmentIrradiance;\nfinalIrradiance*=surfaceAlbedo.rgb;\n#endif\n\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;\nfinalSpecular=max(finalSpecular,0.0);\n\nvec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#endif\n\n#ifdef REFLECTION\nvec3 finalRadiance=environmentRadiance;\nfinalRadiance*=specularEnvironmentReflectance;\n\nvec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#endif\n\n#ifdef REFRACTION\nvec3 finalRefraction=environmentRefraction;\nfinalRefraction*=refractance;\n#endif\n\nvec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\nfinalEmissive*=vEmissiveInfos.y;\n#endif\n\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA)\nalpha=clamp(alpha+luminanceOverAlpha*luminanceOverAlpha,0.,1.);\n#endif\n#endif\n\n\n\nvec4 finalColor=vec4(finalDiffuse*ambientOcclusionColor*vLightingIntensity.x +\n#ifdef REFLECTION\nfinalIrradiance*ambientOcclusionColor*vLightingIntensity.z +\n#endif\n#ifdef SPECULARTERM\n\n\nfinalSpecularScaled +\n#endif\n#ifdef REFLECTION\n\n\nfinalRadianceScaled +\n#endif\n#ifdef REFRACTION\nfinalRefraction*vLightingIntensity.z +\n#endif\nfinalEmissive*vLightingIntensity.y,\nalpha);\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor;\n#else\nfinalColor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n\nfinalColor=max(finalColor,0.0);\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n\n\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#else\n\nfinalColor=applyImageProcessing(finalColor);\n#endif\n#ifdef PREMULTIPLYALPHA\n\nfinalColor.rgb*=finalColor.a;\n#endif\ngl_FragColor=finalColor;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n}",spritesVertexShader:"\nattribute vec4 position;\nattribute vec4 options;\nattribute vec4 cellInfo;\nattribute vec4 color;\n\nuniform vec2 textureInfos;\nuniform mat4 view;\nuniform mat4 projection;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<fogVertexDeclaration>\nvoid main(void) { \nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;\nfloat angle=position.w;\nvec2 size=vec2(options.x,options.y);\nvec2 offset=options.zw;\nvec2 uvScale=textureInfos.xy;\ncornerPos=vec2(offset.x-0.5,offset.y-0.5)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \n\nvColor=color;\n\nvec2 uvOffset=vec2(abs(offset.x-cellInfo.x),1.0-abs(offset.y-cellInfo.y));\nvUV=(uvOffset+cellInfo.zw)*uvScale;\n\n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n}",spritesPixelShader:"uniform bool alphaTest;\nvarying vec4 vColor;\n\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\nvec4 color=texture2D(diffuseSampler,vUV);\nif (alphaTest) \n{\nif (color.a<0.95)\ndiscard;\n}\ncolor*=vColor;\n#include<fogFragment>\ngl_FragColor=color;\n}",particlesVertexShader:"\nattribute vec3 position;\nattribute vec4 color;\nattribute vec4 options;\nattribute float cellIndex;\n\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec3 particlesInfos; \n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nuniform mat4 invView;\nvarying float fClipDistance;\n#endif\nvoid main(void) { \nvec3 viewPos=(view*vec4(position,1.0)).xyz; \nvec3 cornerPos;\nfloat size=options.y;\nfloat angle=options.x;\nvec2 offset=options.zw;\ncornerPos=vec3(offset.x-0.5,offset.y-0.5,0.)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \nvColor=color;\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex/particlesInfos.z);\nfloat columnOffset=cellIndex-rowOffset*particlesInfos.z;\nvec2 uvScale=particlesInfos.xy;\nvec2 uvOffset=vec2(offset.x ,1.0-offset.y);\nvUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=offset;\n#endif\n\n#ifdef CLIPPLANE\nvec4 worldPos=invView*vec4(viewPos,1.0);\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n}",particlesPixelShader:"\nvarying vec2 vUV;\nvarying vec4 vColor;\nuniform vec4 textureMask;\nuniform sampler2D diffuseSampler;\n#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\nvoid main(void) {\n#ifdef CLIPPLANE\nif (fClipDistance>0.0)\ndiscard;\n#endif\nvec4 baseColor=texture2D(diffuseSampler,vUV);\ngl_FragColor=(baseColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n}",colorVertexShader:"\nattribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\nuniform mat4 viewProjection;\nuniform mat4 world;\n\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\nvoid main(void) {\nmat4 finalWorld=world;\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#ifdef VERTEXCOLOR\n\nvColor=color;\n#endif\n}",colorPixelShader:"#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\nvoid main(void) {\n#ifdef VERTEXCOLOR\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n}",postprocessVertexShader:"\nattribute vec2 position;\nuniform vec2 scale;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n}",passPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}",shadowMapVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 biasAndScale;\nuniform vec2 depthValues;\nvarying float vDepthMetric;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\nvec4 worldPos=finalWorld*vec4(position,1.0);\ngl_Position=viewProjection*worldPos;\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y))+biasAndScale.x;\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",shadowMapPixelShader:"#ifndef FLOAT\nvec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n#endif\nvarying float vDepthMetric;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nuniform vec2 biasAndScale;\nuniform vec2 depthValues;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nfloat depth=vDepthMetric;\n#ifdef ESM\ndepth=clamp(exp(-min(87.,biasAndScale.y*depth)),0.,1.);\n#endif\n#ifdef FLOAT\ngl_FragColor=vec4(depth,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depth);\n#endif\n}",depthBoxBlurPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}",proceduralVertexShader:"\nattribute vec2 position;\n\nvarying vec2 vPosition;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvPosition=position;\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}",depthVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvarying float vDepthMetric;\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",depthPixelShader:"#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nvarying float vDepthMetric;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(vDepthMetric,vDepthMetric*vDepthMetric,0.0,1.0);\n}",ssaoPixelShader:"\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float radius;\nuniform float area;\nuniform float fallOff;\nuniform float base;\nvec3 normalFromDepth(float depth,vec2 coords)\n{\nvec2 offset1=vec2(0.0,radius);\nvec2 offset2=vec2(radius,0.0);\nfloat depth1=texture2D(textureSampler,coords+offset1).r;\nfloat depth2=texture2D(textureSampler,coords+offset2).r;\nvec3 p1=vec3(offset1,depth1-depth);\nvec3 p2=vec3(offset2,depth2-depth);\nvec3 normal=cross(p1,p2);\nnormal.z=-normal.z;\nreturn normalize(normal);\n}\nvoid main()\n{\nvec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);\nfloat depth=texture2D(textureSampler,vUV).r;\nvec3 position=vec3(vUV,depth);\nvec3 normal=normalFromDepth(depth,vUV);\nfloat radiusDepth=radius/depth;\nfloat occlusion=0.0;\nvec3 ray;\nvec3 hemiRay;\nfloat occlusionDepth;\nfloat difference;\nfor (int i=0; i<SAMPLES; i++)\n{\nray=radiusDepth*reflect(sampleSphere[i],random);\nhemiRay=position+sign(dot(ray,normal))*ray;\nocclusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;\ndifference=depth-occlusionDepth;\nocclusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));\n}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor.r=result;\ngl_FragColor.g=result;\ngl_FragColor.b=result;\ngl_FragColor.a=1.0;\n}\n#endif\n#ifdef BILATERAL_BLUR\nuniform sampler2D depthSampler;\nuniform float outSize;\nuniform float samplerOffsets[SAMPLES];\nvoid main()\n{\nfloat texelsize=1.0/outSize;\nfloat compareDepth=texture2D(depthSampler,vUV).r;\nfloat result=0.0;\nfloat weightSum=0.0;\nfor (int i=0; i<SAMPLES; ++i)\n{\n#ifdef BILATERAL_BLUR_H\nvec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);\n#else\nvec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);\n#endif\nvec2 samplePos=vUV+sampleOffset;\nfloat sampleDepth=texture2D(depthSampler,samplePos).r;\nfloat weight=(1.0/(0.0001+abs(compareDepth-sampleDepth)));\nresult+=texture2D(textureSampler,samplePos).r*weight;\nweightSum+=weight;\n}\nresult/=weightSum;\ngl_FragColor.rgb=vec3(result);\ngl_FragColor.a=1.0;\n}\n#endif\n",ssao2PixelShader:"\nprecision highp float;\nuniform sampler2D textureSampler;\nuniform float near;\nuniform float far;\nuniform float radius;\nvarying vec2 vUV;\nfloat perspectiveDepthToViewZ( const in float invClipZ,const in float near,const in float far ) {\nreturn ( near*far )/( ( far-near )*invClipZ-far );\n}\nfloat viewZToPerspectiveDepth( const in float viewZ,const in float near,const in float far ) {\nreturn ( near*far/viewZ+far)/( far-near );\n}\nfloat viewZToOrthographicDepth( const in float viewZ,const in float near,const in float far ) {\nreturn ( viewZ+near )/( near-far );\n}\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform sampler2D normalSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float base;\nuniform float xViewport;\nuniform float yViewport;\nuniform float maxZ;\nuniform float minZAspect;\nuniform vec2 texelSize;\nuniform mat4 projection;\nvoid main()\n{\nvec3 random=texture2D(randomSampler,vUV*randTextureTiles).rgb;\nfloat depth=abs(texture2D(textureSampler,vUV).r);\nvec3 normal=texture2D(normalSampler,vUV).rgb; \nfloat occlusion=0.0;\nfloat correctedRadius=min(radius,minZAspect*depth/near);\nvec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,1.0);\nvec3 origin=vViewRay*depth;\nvec3 rvec=random*2.0-1.0;\nrvec.z=0.0;\nvec3 tangent=normalize(rvec-normal*dot(rvec,normal));\nvec3 bitangent=cross(normal,tangent);\nmat3 tbn=mat3(tangent,bitangent,normal);\nfloat difference;\nif (depth>maxZ) {\ngl_FragColor=vec4(1.0,1.0,1.0,1.0);\nreturn;\n}\nfor (int i=0; i<SAMPLES; ++i) {\n\nvec3 samplePosition=tbn*sampleSphere[i];\nsamplePosition=samplePosition*correctedRadius+origin;\n\nvec4 offset=vec4(samplePosition,1.0);\noffset=projection*offset;\noffset.xyz/=offset.w;\noffset.xy=offset.xy*0.5+0.5;\nif (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {\ncontinue;\n}\n\nfloat sampleDepth=abs(texture2D(textureSampler,offset.xy).r);\n\nfloat rangeCheck=abs(depth-sampleDepth)<correctedRadius ? 1.0 : 0.0;\ndifference=samplePosition.z-sampleDepth;\n\nocclusion+=(difference>=1e-5 ? 1.0 : 0.0)*rangeCheck;\n}\n\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor=vec4(vec3(result),1.0);\n}\n#endif\n#ifdef BILATERAL_BLUR\nuniform sampler2D depthSampler;\nuniform float outSize;\nuniform float samplerOffsets[SAMPLES];\nvec4 blur9(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.3846153846)*direction;\nvec2 off2=vec2(3.2307692308)*direction;\ncolor+=texture2D(image,uv)*0.2270270270;\ncolor+=texture2D(image,uv+(off1/resolution))*0.3162162162;\ncolor+=texture2D(image,uv-(off1/resolution))*0.3162162162;\ncolor+=texture2D(image,uv+(off2/resolution))*0.0702702703;\ncolor+=texture2D(image,uv-(off2/resolution))*0.0702702703;\nreturn color;\n}\nvec4 blur13(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.411764705882353)*direction;\nvec2 off2=vec2(3.2941176470588234)*direction;\nvec2 off3=vec2(5.176470588235294)*direction;\ncolor+=texture2D(image,uv)*0.1964825501511404;\ncolor+=texture2D(image,uv+(off1/resolution))*0.2969069646728344;\ncolor+=texture2D(image,uv-(off1/resolution))*0.2969069646728344;\ncolor+=texture2D(image,uv+(off2/resolution))*0.09447039785044732;\ncolor+=texture2D(image,uv-(off2/resolution))*0.09447039785044732;\ncolor+=texture2D(image,uv+(off3/resolution))*0.010381362401148057;\ncolor+=texture2D(image,uv-(off3/resolution))*0.010381362401148057;\nreturn color;\n}\nvec4 blur13Bilateral(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.411764705882353)*direction;\nvec2 off2=vec2(3.2941176470588234)*direction;\nvec2 off3=vec2(5.176470588235294)*direction;\nfloat compareDepth=abs(texture2D(depthSampler,uv).r);\nfloat sampleDepth;\nfloat weight;\nfloat weightSum=30.0;\ncolor+=texture2D(image,uv)*30.0;\nsampleDepth=abs(texture2D(depthSampler,uv+(off1/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off1/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off1/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off1/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv+(off2/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off2/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off2/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off2/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv+(off3/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off3/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off3/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off3/resolution))*weight;\nreturn color/weightSum;\n}\nvoid main()\n{\n#if EXPENSIVE\nfloat compareDepth=abs(texture2D(depthSampler,vUV).r);\nfloat texelsize=1.0/outSize;\nfloat result=0.0;\nfloat weightSum=0.0;\nfor (int i=0; i<SAMPLES; ++i)\n{\n#ifdef BILATERAL_BLUR_H\nvec2 direction=vec2(1.0,0.0);\nvec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);\n#else\nvec2 direction=vec2(0.0,1.0);\nvec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);\n#endif\nvec2 samplePos=vUV+sampleOffset;\nfloat sampleDepth=abs(texture2D(depthSampler,samplePos).r);\nfloat weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30000.0);\nresult+=texture2D(textureSampler,samplePos).r*weight;\nweightSum+=weight;\n}\nresult/=weightSum;\ngl_FragColor.rgb=vec3(result);\ngl_FragColor.a=1.0;\n#else\nvec4 color;\n#ifdef BILATERAL_BLUR_H\nvec2 direction=vec2(1.0,0.0);\ncolor=blur13Bilateral(textureSampler,vUV,outSize,direction);\n#else\nvec2 direction=vec2(0.0,1.0);\ncolor=blur13Bilateral(textureSampler,vUV,outSize,direction);\n#endif\ngl_FragColor.rgb=vec3(color.r);\ngl_FragColor.a=1.0;\n#endif\n}\n#endif\n",ssaoCombinePixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D originalColor;\nvarying vec2 vUV;\nvoid main(void) {\nvec4 ssaoColor=texture2D(textureSampler,vUV);\nvec4 sceneColor=texture2D(originalColor,vUV);\ngl_FragColor=sceneColor*ssaoColor;\n}\n",chromaticAberrationPixelShader:"\nuniform sampler2D textureSampler; \n\nuniform float chromatic_aberration;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\nvoid main(void)\n{\nvec2 centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+centered_screen_pos.y*centered_screen_pos.y;\nfloat radius=sqrt(radius2);\nvec4 original=texture2D(textureSampler,vUV);\nif (chromatic_aberration>0.0) {\n\nvec3 ref_indices=vec3(-0.3,0.0,0.3);\nfloat ref_shiftX=chromatic_aberration*radius*17.0/screen_width;\nfloat ref_shiftY=chromatic_aberration*radius*17.0/screen_height;\n\nvec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);\nvec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);\nvec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);\noriginal.r=texture2D(textureSampler,ref_coords_r).r;\noriginal.g=texture2D(textureSampler,ref_coords_g).g;\noriginal.b=texture2D(textureSampler,ref_coords_b).b;\n}\ngl_FragColor=original;\n}",lensHighlightsPixelShader:"\nuniform sampler2D textureSampler; \n\nuniform float gain;\nuniform float threshold;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\n\nvec4 highlightColor(vec4 color) {\nvec4 highlight=color;\nfloat luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));\nfloat lum_threshold;\nif (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);\nhighlight*=luminance*gain;\nhighlight.a=1.0;\nreturn highlight;\n}\nvoid main(void)\n{\nvec4 original=texture2D(textureSampler,vUV);\n\nif (gain == -1.0) {\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nreturn;\n}\nfloat w=2.0/screen_width;\nfloat h=2.0/screen_height;\nfloat weight=1.0;\n\nvec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;\ngl_FragColor=blurred;\n\n}",depthOfFieldPixelShader:"\n\n\n\n\nuniform sampler2D textureSampler;\nuniform sampler2D highlightsSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D grainSampler;\n\nuniform float grain_amount;\nuniform bool blur_noise;\nuniform float screen_width;\nuniform float screen_height;\nuniform float distortion;\nuniform bool dof_enabled;\n\nuniform float screen_distance; \nuniform float aperture;\nuniform float darken;\nuniform float edge_blur;\nuniform bool highlights;\n\nuniform float near;\nuniform float far;\n\nvarying vec2 vUV;\n\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \n\nvec2 centered_screen_pos;\nvec2 distorted_coords;\nfloat radius2;\nfloat radius;\n\nvec2 rand(vec2 co)\n{\nfloat noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));\nfloat noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));\nreturn clamp(vec2(noise1,noise2),0.0,1.0);\n}\n\nvec2 getDistortedCoords(vec2 coords) {\nif (distortion == 0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);\nvec2 dist_coords=vec2(0.5,0.5);\ndist_coords.x=0.5+direction.x*radius2*1.0;\ndist_coords.y=0.5+direction.y*radius2*1.0;\nfloat dist_amount=clamp(distortion*0.23,0.0,1.0);\ndist_coords=mix(coords,dist_coords,dist_amount);\nreturn dist_coords;\n}\n\nfloat sampleScreen(inout vec4 color,const in vec2 offset,const in float weight) {\n\nvec2 coords=distorted_coords;\nfloat angle=rand(coords*100.0).x*TWOPI;\ncoords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));\ncolor+=texture2D(textureSampler,coords)*weight;\nreturn weight;\n}\n\nfloat getBlurLevel(float size) {\nreturn min(3.0,ceil(size/1.0));\n}\n\nvec4 getBlurColor(float size) {\nvec4 col=texture2D(textureSampler,distorted_coords);\nif (size == 0.0) { return col; }\n\n\nfloat blur_level=getBlurLevel(size);\nfloat w=(size/screen_width);\nfloat h=(size/screen_height);\nfloat total_weight=1.0;\nvec2 sample_coords;\ntotal_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);\ntotal_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);\ntotal_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);\ntotal_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);\ntotal_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);\ntotal_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);\ntotal_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);\ntotal_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);\ntotal_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);\nif (blur_level>1.0) {\ntotal_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);\ntotal_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);\ntotal_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);\ntotal_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);\ntotal_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);\ntotal_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);\ntotal_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);\ntotal_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);\ntotal_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);\n}\nif (blur_level>2.0) {\ntotal_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);\ntotal_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);\ntotal_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);\ntotal_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);\ntotal_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);\ntotal_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);\ntotal_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);\ntotal_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);\ntotal_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);\n}\ncol/=total_weight; \n\nif (darken>0.0) {\ncol.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);\n}\n\n\n\n\nreturn col;\n}\nvoid main(void)\n{\n\ncentered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nradius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;\nradius=sqrt(radius2);\ndistorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \n\n\nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));\n\nif (dof_enabled == false || coc<0.07) { coc=0.0; }\n\nfloat edge_blur_amount=0.0;\nif (edge_blur>0.0) {\nedge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;\n}\n\nfloat blur_amount=max(edge_blur_amount,coc);\n\nif (blur_amount == 0.0) {\ngl_FragColor=texture2D(textureSampler,distorted_coords);\n}\nelse {\n\ngl_FragColor=getBlurColor(blur_amount*1.7);\n\nif (highlights) {\ngl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;\n}\nif (blur_noise) {\n\nvec2 noise=rand(distorted_coords)*0.01*blur_amount;\nvec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);\ngl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;\n}\n}\n\nif (grain_amount>0.0) {\nvec4 grain_color=texture2D(grainSampler,texels_coords*0.003);\ngl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;\n}\n}\n",standardPixelShader:"uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{\nvec4 color=texture2D(textureSampler,vUV);\ngl_FragColor=color;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nuniform sampler2D lensSampler;\nuniform float exposure;\nvoid main(void)\n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\ncolour*=exposure;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\ncolour+=colour*texture2D(lensSampler,vUV).rgb;\nvec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);\ngl_FragColor=finalColor;\n}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;\nuniform mat4 lightWorld;\nuniform vec3 cameraPosition;\nuniform vec3 sunDirection;\nuniform vec3 sunColor;\nuniform vec2 depthValues;\nuniform float scatteringCoefficient;\nuniform float scatteringPower;\nuniform sampler2D shadowMapSampler;\nuniform sampler2D positionSampler;\nfloat computeScattering(float lightDotView)\n{\nfloat result=1.0-scatteringCoefficient*scatteringCoefficient;\nresult/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));\nreturn result;\n}\nvoid main(void)\n{\n\nvec3 worldPos=texture2D(positionSampler,vUV).rgb;\nvec3 startPosition=cameraPosition;\nvec3 rayVector=worldPos-startPosition;\nfloat rayLength=length(rayVector);\nvec3 rayDirection=rayVector/rayLength;\nfloat stepLength=rayLength/NB_STEPS;\nvec3 stepL=rayDirection*stepLength;\nvec3 currentPosition=startPosition;\nvec3 accumFog=vec3(0.0);\nfor (int i=0; i<int(NB_STEPS); i++)\n{\nvec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);\nfloat depthMetric=(worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depthMetric,0.0,1.0);\nworldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;\nworldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);\nfloat shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;\nif (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));\ncurrentPosition+=stepL;\n}\naccumFog/=NB_STEPS;\nvec3 color=accumFog*scatteringPower;\ngl_FragColor=vec4(color*exp(color) ,1.0);\n}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);\n}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];\nvoid main()\n{\nfloat average=0.0;\nvec4 color=vec4(0.0);\nfloat maximum=-1e20;\nvec3 weight=vec3(0.299,0.587,0.114);\nfor (int i=0; i<4; i++)\n{\ncolor=texture2D(textureSampler,vUV+ lumOffsets[i]);\n\nfloat GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);\naverage+=(0.25*log(1e-5+GreyValue));\n}\naverage=exp(average);\ngl_FragColor=vec4(average,maximum,0.0,1.0);\n}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];\nuniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\nvec4 pack(float value) {\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(value*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n#endif\nvoid main()\n{\nvec4 color=vec4(0.0);\nfloat average=0.0;\nfor (int i=0; i<9; i++)\n{\ncolor=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);\naverage+=color.r;\n}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;\nuniform float averageLuminance;\nvoid main()\n{\nvec4 color=texture2D(textureAdderSampler,vUV);\nvec4 adjustedColor=color/averageLuminance;\ncolor=adjustedColor;\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;\nuniform float strength;\nuniform float ghostDispersal;\nuniform float haloWidth;\nuniform vec2 resolution;\nuniform float distortionStrength;\nfloat hash(vec2 p)\n{\nfloat h=dot(p,vec2(127.1,311.7));\nreturn -1.0+2.0*fract(sin(h)*43758.5453123);\n}\nfloat noise(in vec2 p)\n{\nvec2 i=floor(p);\nvec2 f=fract(p);\nvec2 u=f*f*(3.0-2.0*f);\nreturn mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);\n}\nfloat fbm(vec2 p)\n{\nfloat f=0.0;\nf+=0.5000*noise(p); p*=2.02;\nf+=0.2500*noise(p); p*=2.03;\nf+=0.1250*noise(p); p*=2.01;\nf+=0.0625*noise(p); p*=2.04;\nf/=0.9375;\nreturn f;\n}\nvec3 pattern(vec2 uv)\n{\nvec2 p=-1.0+2.0*uv;\nfloat p2=dot(p,p);\nfloat f=fbm(vec2(15.0*p2))/2.0;\nfloat r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));\nfloat g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));\nfloat b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));\nreturn (1.0-f)*vec3(r,g,b);\n}\nfloat luminance(vec3 color)\n{\nreturn dot(color.rgb,vec3(0.2126,0.7152,0.0722));\n}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{\nreturn vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);\n}\nvoid main(void)\n{\nvec2 uv=-vUV+vec2(1.0);\nvec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;\nvec2 texelSize=1.0/resolution;\nvec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);\nvec4 result=vec4(0.0);\nfloat ghostIndice=1.0;\nfor (int i=0; i<GHOSTS; ++i)\n{\nvec2 offset=fract(uv+ghostDir*ghostIndice);\nfloat weight=length(vec2(0.5)-offset)/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;\nghostIndice+=1.0;\n}\nvec2 haloVec=normalize(ghostDir)*haloWidth;\nfloat weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;\nresult*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));\ngl_FragColor=result;\n}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;\nuniform sampler2D lensDirtSampler;\nuniform sampler2D lensStarSampler;\nuniform mat4 lensStarMatrix;\nvoid main(void)\n{\nvec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;\nvec4 lensMod=texture2D(lensDirtSampler,vUV);\nlensMod+=texture2D(lensStarSampler,vUV);\nvec4 result=texture2D(textureSampler,vUV)*lensMod;\ngl_FragColor=texture2D(otherSampler,vUV)+result;\n}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;\nuniform sampler2D depthSampler;\nuniform float distance;\nvoid main(void)\n{\nvec4 sharp=texture2D(otherSampler,vUV);\nvec4 blur=texture2D(textureSampler,vUV);\nfloat dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);\nfloat factor=0.0;\nif (dist<0.05)\nfactor=1.0;\nelse if (dist<0.1)\nfactor=20.0*(0.1-dist);\nelse if (dist<0.5)\nfactor=0.0;\nelse\nfactor=2.0*(dist-0.5);\nfactor=clamp(factor,0.0,0.90);\ngl_FragColor=mix(sharp,blur,factor);\n}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;\nuniform mat4 prevViewProjection;\nuniform vec2 screenSize;\nuniform float motionScale;\nuniform float motionStrength;\nuniform sampler2D depthSampler;\nvoid main(void)\n{\nvec2 texelSize=1.0/screenSize;\nfloat depth=texture2D(depthSampler,vUV).r;\nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);\ncpos=cpos*inverseViewProjection;\nvec4 ppos=cpos*prevViewProjection;\nppos.xyz/=ppos.w;\nppos.xy=ppos.xy*0.5+0.5;\nvec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {\nif (i>=nSamples)\nbreak;\nvec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\nresult+=texture2D(textureSampler,offset1);\n}\ngl_FragColor=result/float(nSamples);\n}\n#endif\n",fxaaVertexShader:"\nattribute vec2 position;\nuniform vec2 texelSize;\n\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=(position*madd+madd);\nsampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;\nsampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;\nsampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;\nsampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;\nsampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;\nsampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;\nsampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;\nsampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;\ngl_Position=vec4(position,0.0,1.0);\n}",fxaaPixelShader:"uniform sampler2D textureSampler;\nuniform vec2 texelSize;\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst float fxaaQualitySubpix=1.0;\nconst float fxaaQualityEdgeThreshold=0.166;\nconst float fxaaQualityEdgeThresholdMin=0.0833;\nconst vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){\nvec2 posM;\nposM.x=vUV.x;\nposM.y=vUV.y;\nvec4 rgbyM=texture2D(textureSampler,vUV,0.0);\nfloat lumaM=FxaaLuma(rgbyM);\nfloat lumaS=FxaaLuma(texture2D(textureSampler,sampleCoordS,0.0));\nfloat lumaE=FxaaLuma(texture2D(textureSampler,sampleCoordE,0.0));\nfloat lumaN=FxaaLuma(texture2D(textureSampler,sampleCoordN,0.0));\nfloat lumaW=FxaaLuma(texture2D(textureSampler,sampleCoordW,0.0));\nfloat maxSM=max(lumaS,lumaM);\nfloat minSM=min(lumaS,lumaM);\nfloat maxESM=max(lumaE,maxSM);\nfloat minESM=min(lumaE,minSM);\nfloat maxWN=max(lumaN,lumaW);\nfloat minWN=min(lumaN,lumaW);\nfloat rangeMax=max(maxWN,maxESM);\nfloat rangeMin=min(minWN,minESM);\nfloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;\nfloat range=rangeMax-rangeMin;\nfloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\nif(range<rangeMaxClamped) \n{\ngl_FragColor=rgbyM;\nreturn;\n}\nfloat lumaNW=FxaaLuma(texture2D(textureSampler,sampleCoordNW,0.0));\nfloat lumaSE=FxaaLuma(texture2D(textureSampler,sampleCoordSE,0.0));\nfloat lumaNE=FxaaLuma(texture2D(textureSampler,sampleCoordNE,0.0));\nfloat lumaSW=FxaaLuma(texture2D(textureSampler,sampleCoordSW,0.0));\nfloat lumaNS=lumaN+lumaS;\nfloat lumaWE=lumaW+lumaE;\nfloat subpixRcpRange=1.0/range;\nfloat subpixNSWE=lumaNS+lumaWE;\nfloat edgeHorz1=(-2.0*lumaM)+lumaNS;\nfloat edgeVert1=(-2.0*lumaM)+lumaWE;\nfloat lumaNESE=lumaNE+lumaSE;\nfloat lumaNWNE=lumaNW+lumaNE;\nfloat edgeHorz2=(-2.0*lumaE)+lumaNESE;\nfloat edgeVert2=(-2.0*lumaN)+lumaNWNE;\nfloat lumaNWSW=lumaNW+lumaSW;\nfloat lumaSWSE=lumaSW+lumaSE;\nfloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);\nfloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);\nfloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;\nfloat edgeVert3=(-2.0*lumaS)+lumaSWSE;\nfloat edgeHorz=abs(edgeHorz3)+edgeHorz4;\nfloat edgeVert=abs(edgeVert3)+edgeVert4;\nfloat subpixNWSWNESE=lumaNWSW+lumaNESE;\nfloat lengthSign=texelSize.x;\nbool horzSpan=edgeHorz>=edgeVert;\nfloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;\nif (!horzSpan)\n{\nlumaN=lumaW;\n}\nif (!horzSpan) \n{\nlumaS=lumaE;\n}\nif (horzSpan) \n{\nlengthSign=texelSize.y;\n}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;\nfloat gradientN=lumaN-lumaM;\nfloat gradientS=lumaS-lumaM;\nfloat lumaNN=lumaN+lumaM;\nfloat lumaSS=lumaS+lumaM;\nbool pairN=abs(gradientN)>=abs(gradientS);\nfloat gradient=max(abs(gradientN),abs(gradientS));\nif (pairN)\n{\nlengthSign=-lengthSign;\n}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);\nvec2 posB;\nposB.x=posM.x;\nposB.y=posM.y;\nvec2 offNP;\noffNP.x=(!horzSpan) ? 0.0 : texelSize.x;\noffNP.y=(horzSpan) ? 0.0 : texelSize.y;\nif (!horzSpan) \n{\nposB.x+=lengthSign*0.5;\n}\nif (horzSpan)\n{\nposB.y+=lengthSign*0.5;\n}\nvec2 posN;\nposN.x=posB.x-offNP.x*1.5;\nposN.y=posB.y-offNP.y*1.5;\nvec2 posP;\nposP.x=posB.x+offNP.x*1.5;\nposP.y=posB.y+offNP.y*1.5;\nfloat subpixD=((-2.0)*subpixC)+3.0;\nfloat lumaEndN=FxaaLuma(texture2D(textureSampler,posN,0.0));\nfloat subpixE=subpixC*subpixC;\nfloat lumaEndP=FxaaLuma(texture2D(textureSampler,posP,0.0));\nif (!pairN) \n{\nlumaNN=lumaSS;\n}\nfloat gradientScaled=gradient*1.0/4.0;\nfloat lumaMM=lumaM-lumaNN*0.5;\nfloat subpixF=subpixD*subpixE;\nbool lumaMLTZero=lumaMM<0.0;\nlumaEndN-=lumaNN*0.5;\nlumaEndP-=lumaNN*0.5;\nbool doneN=abs(lumaEndN)>=gradientScaled;\nbool doneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) \n{\nposN.x-=offNP.x*3.0;\n}\nif (!doneN) \n{\nposN.y-=offNP.y*3.0;\n}\nbool doneNP=(!doneN) || (!doneP);\nif (!doneP) \n{\nposP.x+=offNP.x*3.0;\n}\nif (!doneP)\n{\nposP.y+=offNP.y*3.0;\n}\nif (doneNP)\n{\nif (!doneN) lumaEndN=FxaaLuma(texture2D(textureSampler,posN.xy,0.0));\nif (!doneP) lumaEndP=FxaaLuma(texture2D(textureSampler,posP.xy,0.0));\nif (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;\nif (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;\ndoneN=abs(lumaEndN)>=gradientScaled;\ndoneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) posN.x-=offNP.x*12.0;\nif (!doneN) posN.y-=offNP.y*12.0;\ndoneNP=(!doneN) || (!doneP);\nif (!doneP) posP.x+=offNP.x*12.0;\nif (!doneP) posP.y+=offNP.y*12.0;\n}\nfloat dstN=posM.x-posN.x;\nfloat dstP=posP.x-posM.x;\nif (!horzSpan)\n{\ndstN=posM.y-posN.y;\n}\nif (!horzSpan) \n{\ndstP=posP.y-posM.y;\n}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;\nfloat spanLength=(dstP+dstN);\nbool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;\nfloat spanLengthRcp=1.0/spanLength;\nbool directionN=dstN<dstP;\nfloat dst=min(dstN,dstP);\nbool goodSpan=directionN ? goodSpanN : goodSpanP;\nfloat subpixG=subpixF*subpixF;\nfloat pixelOffset=(dst*(-spanLengthRcp))+0.5;\nfloat subpixH=subpixG*fxaaQualitySubpix;\nfloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;\nfloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);\nif (!horzSpan)\n{\nposM.x+=pixelOffsetSubpix*lengthSign;\n}\nif (horzSpan)\n{\nposM.y+=pixelOffsetSubpix*lengthSign;\n}\ngl_FragColor=texture2D(textureSampler,posM,0.0);\n}",geometryVertexShader:"precision highp float;\nprecision highp int;\n#include<bonesDeclaration>\n#include<instancesDeclaration>\nattribute vec3 position;\nattribute vec3 normal;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nvarying vec2 uv;\n#endif\n#ifdef UV2\nvarying vec2 uv2;\n#endif\n#endif\n\nuniform mat4 viewProjection;\nuniform mat4 view;\nvarying vec3 vNormalV;\nvarying vec4 vViewPos;\n#ifdef POSITION\nvarying vec3 vPosition;\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\nvec4 pos=vec4(finalWorld*vec4(position,1.0));\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normal,0.0)));\nvViewPos=view*pos;\n#ifdef POSITION\nvPosition=pos.xyz/pos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",geometryPixelShader:"#extension GL_EXT_draw_buffers : require\nprecision highp float;\nprecision highp int;\nvarying vec3 vNormalV;\nvarying vec4 vViewPos;\n#ifdef POSITION\nvarying vec3 vPosition;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef POSITION\n#include<mrtFragmentDeclaration>[3]\n#else\n#include<mrtFragmentDeclaration>[2]\n#endif\nvoid main() {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\ngl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n\ngl_FragData[1]=vec4(normalize(vNormalV),1.0);\n\n#ifdef POSITION\ngl_FragData[2]=vec4(vPosition,1.0);\n#endif\n}",refractionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\n\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\nvoid main() {\nfloat ref=1.0-texture2D(refractionSampler,vUV).r;\nvec2 uv=vUV-vec2(0.5);\nvec2 offset=uv*depth*ref;\nvec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;\ngl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);\n}",blackAndWhitePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float degree;\nvoid main(void) \n{\nvec3 color=texture2D(textureSampler,vUV).rgb;\nfloat luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);\ngl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);\n}",convolutionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform float kernel[9];\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];\nfloat kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];\nif (kernelWeight<=0.0) {\nkernelWeight=1.0;\n}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);\n}",filterPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 kernelMatrix;\nvoid main(void)\n{\nvec3 baseColor=texture2D(textureSampler,vUV).rgb;\nvec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;\ngl_FragColor=vec4(updatedColor,1.0);\n}",volumetricLightScatteringPixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D lightScatteringSampler;\nuniform float decay;\nuniform float exposure;\nuniform float weight;\nuniform float density;\nuniform vec2 meshPositionOnScreen;\nvarying vec2 vUV;\nvoid main(void) {\nvec2 tc=vUV;\nvec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);\ndeltaTexCoord*=1.0/float(NUM_SAMPLES)*density;\nfloat illuminationDecay=1.0;\nvec4 color=texture2D(lightScatteringSampler,tc)*0.4;\nfor(int i=0; i<NUM_SAMPLES; i++) {\ntc-=deltaTexCoord;\nvec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;\ndataSample*=illuminationDecay*weight;\ncolor+=dataSample;\nilluminationDecay*=decay;\n}\nvec4 realColor=texture2D(textureSampler,vUV);\ngl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n}\n",volumetricLightScatteringPassPixelShader:"#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);\nif (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\n}\n",colorCorrectionPixelShader:"\nuniform sampler2D textureSampler; \nuniform sampler2D colorTable; \n\nvarying vec2 vUV;\n\nconst float SLICE_COUNT=16.0; \n\nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {\nfloat sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);\nfloat zSlice1=min(zSlice0+1.0,width-1.0);\nfloat xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;\nfloat s0=xOffset+(zSlice0*sliceSize);\nfloat s1=xOffset+(zSlice1*sliceSize);\nvec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));\nvec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));\nfloat zOffset=mod(uv.z*width,1.0);\nvec4 result=mix(slice0Color,slice1Color,zOffset);\nreturn result;\n}\nvoid main(void)\n{\nvec4 screen_color=texture2D(textureSampler,vUV);\ngl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);\n}",tonemapPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;\nconst float B=0.50;\nconst float C=0.10;\nconst float D=0.20;\nconst float E=0.02;\nconst float F=0.30;\nconst float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{\nreturn dot(c,vec3(0.22,0.707,0.071));\n}\nvoid main(void) \n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;\nfloat scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nconst float ExposureBias=2.0;\nvec3 x=ExposureBias*colour;\nvec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\nx=vec3(W,W,W);\nvec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);\ncolour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour=vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);\n}",displayPassPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D passSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(passSampler,vUV);\n}",highlightsPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nconst vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\nvoid main(void) \n{\nvec4 tex=texture2D(textureSampler,vUV);\nvec3 c=tex.rgb;\nfloat luma=dot(c.rgb,RGBLuminanceCoefficients);\n\n\ngl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); \n}",imageProcessingPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\nvoid main(void)\n{\nvec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\n\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;\n}",kernelBlurVertexShader:"\nattribute vec2 position;\n\nuniform vec2 delta;\n\nvarying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n}",kernelBlurPixelShader:"\nuniform sampler2D textureSampler;\nuniform vec2 delta;\n\nvarying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\nvec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nvoid main(void)\n{\n#ifdef PACKEDFLOAT \nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n}",lensFlareVertexShader:"\nattribute vec2 position;\n\nuniform mat4 viewportMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=position*madd+madd;\ngl_Position=viewportMatrix*vec4(position,0.0,1.0);\n}",lensFlarePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\ngl_FragColor=baseColor*color;\n}",anaglyphPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\nvoid main(void)\n{\nvec4 leftFrag=texture2D(leftSampler,vUV);\nleftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);\nvec4 rightFrag=texture2D(textureSampler,vUV);\nrightFrag=vec4(rightFrag.r,1.0,1.0,1.0);\ngl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);\n}",stereoscopicInterlacePixelShader:"const vec3 TWO=vec3(2.0,2.0,2.0);\nvarying vec2 vUV;\nuniform sampler2D camASampler;\nuniform sampler2D textureSampler;\nuniform vec2 stepSize;\nvoid main(void)\n{\nbool useCamB;\nvec2 texCoord1;\nvec2 texCoord2;\nvec3 frag1;\nvec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;\ntexCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);\ntexCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;\ntexCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);\ntexCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n\nif (useCamB){\nfrag1=texture2D(textureSampler,texCoord1).rgb;\nfrag2=texture2D(textureSampler,texCoord2).rgb;\n}else{\nfrag1=texture2D(camASampler ,texCoord1).rgb;\nfrag2=texture2D(camASampler ,texCoord2).rgb;\n}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);\n}",vrDistortionCorrectionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\nvec2 HmdWarp(vec2 in01) {\nvec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;\nvec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);\nreturn LensCenter+Scale*rvector;\n}\nvoid main(void)\n{\nvec2 tc=HmdWarp(vUV);\nif (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);\nelse{\ngl_FragColor=texture2D(textureSampler,tc);\n}\n}",glowBlurPostProcessPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\n\nfloat getLuminance(vec3 color)\n{\nreturn dot(color,vec3(0.2126,0.7152,0.0722));\n}\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\n\nvec4 texel=texture2D(textureSampler,start+texelOffset);\nbaseColor.a+=texel.a*weights[i];\n\nfloat luminance=getLuminance(baseColor.rgb);\nfloat luminanceTexel=getLuminance(texel.rgb);\nfloat choice=step(luminanceTexel,luminance);\nbaseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}",glowMapGenerationPixelShader:"#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform sampler2D emissiveSampler;\n#endif\nuniform vec4 color;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUVDiffuse).a<0.4)\ndiscard;\n#endif\n#ifdef EMISSIVE\ngl_FragColor=texture2D(emissiveSampler,vUVEmissive);\n#else\ngl_FragColor=color;\n#endif\n}",glowMapGenerationVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform mat4 emissiveMatrix;\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\n#ifdef CUBEMAP\nvPosition=finalWorld*vec4(position,1.0);\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*finalWorld*vec4(position,1.0);\ngl_Position=vPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",glowMapMergePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform float offset;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\nbaseColor.a=abs(offset-baseColor.a);\ngl_FragColor=baseColor;\n}",glowMapMergeVertexShader:"\nattribute vec2 position;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) {\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}",lineVertexShader:"\nattribute vec3 position;\nattribute vec4 normal;\n\nuniform mat4 worldViewProjection;\nuniform float width;\nuniform float aspectRatio;\nvoid main(void) {\nvec4 viewPosition=worldViewProjection*vec4(position,1.0);\nvec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);\nvec2 currentScreen=viewPosition.xy/viewPosition.w;\nvec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;\ncurrentScreen.x*=aspectRatio;\nnextScreen.x*=aspectRatio;\nvec2 dir=normalize(nextScreen-currentScreen);\nvec2 normalDir=vec2(-dir.y,dir.x);\nnormalDir*=width/2.0;\nnormalDir.x/=aspectRatio;\nvec4 offset=vec4(normalDir*normal.w,0.0,0.0);\ngl_Position=viewPosition+offset;\n}",linePixelShader:"uniform vec4 color;\nvoid main(void) {\ngl_FragColor=color;\n}",outlineVertexShader:"\nattribute vec3 position;\nattribute vec3 normal;\n#include<bonesDeclaration>\n\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\nvoid main(void)\n{\nvec3 offsetPosition=position+normal*offset;\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(offsetPosition,1.0);\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<logDepthVertex>\n}\n",outlinePixelShader:"#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n}",layerVertexShader:"\nattribute vec2 position;\n\nuniform vec2 scale;\nuniform vec2 offset;\nuniform mat4 textureMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvec2 shiftedPosition=position*scale+offset;\nvUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));\ngl_Position=vec4(shiftedPosition,0.0,1.0);\n}",layerPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n}"};BABYLON.Effect.IncludesShadersStore={depthPrePass:"#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);\nreturn;\n#endif",bonesDeclaration:"#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#endif",instancesDeclaration:"#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#else\nuniform mat4 world;\n#endif",pointCloudVertexDeclaration:"#ifdef POINTSIZE\nuniform float pointSize;\n#endif",bumpVertexDeclaration:"#if defined(BUMP) || defined(PARALLAX)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n",clipPlaneVertexDeclaration:"#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif",fogVertexDeclaration:"#ifdef FOG\nvarying vec3 vFogDistance;\n#endif",morphTargetsVertexGlobalDeclaration:"#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#endif",morphTargetsVertexDeclaration:"#ifdef MORPHTARGETS\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#endif",logDepthDeclaration:"#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif",morphTargetsVertex:"#ifdef MORPHTARGETS\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#endif",instancesVertex:"#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#else\nmat4 finalWorld=world;\n#endif",bonesVertex:"#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif \nfinalWorld=finalWorld*influence;\n#endif",bumpVertex:"#if defined(BUMP) || defined(PARALLAX)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);\nvec3 tbnTangent=normalize(tangentUpdated.xyz);\nvec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;\nvTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif",clipPlaneVertex:"#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif",fogVertex:"#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif",shadowsVertex:"#ifdef SHADOWS\n#if defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\nvDepthMetric{X}=((vPositionFromLight{X}.z+light{X}.depthValues.x)/(light{X}.depthValues.y));\n#endif\n#endif",pointCloudVertex:"#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif",logDepthVertex:"#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif",helperFunctions:"const float PI=3.1415926535897932384626433832795;\nconst float LinearEncodePowerApprox=2.2;\nconst float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;\nconst vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);\nmat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{\nfloat mask=smoothstep(1.0-frustumEdgeFalloff,1.0,clamp(dot(clipSpace,clipSpace),0.,1.));\nreturn mix(value,1.0,mask);\n}\nvec3 applyEaseInOut(vec3 x){\nreturn x*x*(3.0-2.0*x);\n}\nvec3 toLinearSpace(vec3 color)\n{\nreturn pow(color,vec3(LinearEncodePowerApprox));\n}\nvec3 toGammaSpace(vec3 color)\n{\nreturn pow(color,vec3(GammaEncodePowerApprox));\n}\nfloat square(float value)\n{\nreturn value*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,LuminanceEncodeApprox),0.,1.);\n}",lightFragmentDeclaration:"#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec3 vLightSpecular{X};\n#else\nvec3 vLightSpecular{X}=vec3(0.);\n#endif\n#ifdef SHADOW{X}\n#if defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform sampler2D shadowSampler{X};\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\n#endif\n#ifdef HEMILIGHT{X}\nuniform vec3 vLightGround{X};\n#endif\n#endif",lightsFragmentFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w == 0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\n\nfloat cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\n\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\n",lightUboDeclaration:"#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec3 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\n#endif\n#ifdef HEMILIGHT{X}\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef SHADOW{X}\n#if defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform sampler2D shadowSampler{X};\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif",defaultVertexDeclaration:"\nuniform mat4 viewProjection;\nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n",defaultFragmentDeclaration:"uniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\n\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REFLECTIONMAP_SKYBOX\n#else\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION)\nuniform mat4 reflectionMatrix;\n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif",defaultUboDeclaration:"layout(std140,column_major) uniform;\nuniform Material\n{\nvec4 diffuseLeftColor;\nvec4 diffuseRightColor;\nvec4 opacityParts;\nvec4 reflectionLeftColor;\nvec4 reflectionRightColor;\nvec4 refractionLeftColor;\nvec4 refractionRightColor;\nvec4 emissiveLeftColor; \nvec4 emissiveRightColor;\nvec2 vDiffuseInfos;\nvec2 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vReflectionInfos;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec2 vSpecularInfos;\nvec3 vBumpInfos;\nmat4 diffuseMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 reflectionMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 specularMatrix;\nmat4 bumpMatrix; \nvec4 vTangentSpaceParams;\nmat4 refractionMatrix;\nvec4 vRefractionInfos;\nvec4 vSpecularColor;\nvec3 vEmissiveColor;\nvec4 vDiffuseColor;\nfloat pointSize; \n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};",shadowsFragmentFunctions:"#ifdef SHADOWS\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nif (depth>shadow)\n{\nreturn darkness;\n}\nreturn 1.0;\n}\nfloat computeShadowWithPCFCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\nfloat computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); \nreturn esm;\n}\nfloat computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn esm;\n}\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadow=texture2D(shadowSampler,uv).x;\n#endif\nif (shadowPixelDepth>shadow)\n{\nreturn computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff);\n}\nreturn 1.;\n}\nfloat computeShadowWithPCF(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n\n#ifndef SHADOWFLOAT\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<shadowPixelDepth) visibility-=0.25;\n#else\nif (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadowMapSample=texture2D(shadowSampler,uv).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadowMapSample=texture2D(shadowSampler,uv).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n#endif\n",fresnelFunction:"#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif",reflectionFunction:"vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvec3 direction=normalize(vDirectionW);\nfloat t=clamp(direction.y*-0.5+0.5,0.,1.0);\nfloat s=atan(direction.z,direction.x)*RECIPROCAL_PI2+0.5;\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nreturn vec3(1.0-s,t,0);\n#else\nreturn vec3(s,t,0);\n#endif\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nvec3 cameraToVertex=normalize(worldPos.xyz-vEyePosition.xyz);\nvec3 r=reflect(cameraToVertex,worldNormal);\nfloat t=clamp(r.y*-0.5+0.5,0.,1.0);\nfloat s=atan(r.z,r.x)*RECIPROCAL_PI2+0.5;\nreturn vec3(s,t,0);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nvec3 viewDir=worldPos.xyz-vEyePosition.xyz;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n#endif\n#ifdef REFLECTIONMAP_CUBIC\nvec3 viewDir=worldPos.xyz-vEyePosition.xyz;\nvec3 coords=reflect(viewDir,worldNormal);\n#ifdef INVERTCUBICMAP\ncoords.y=1.0-coords.y;\n#endif\nreturn vec3(reflectionMatrix*vec4(coords,0));\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn vec3(reflectionMatrix*(view*worldPos));\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}",imageProcessingDeclaration:"#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#ifdef VIGNETTE\nuniform vec2 vInverseScreenSize;\nuniform vec4 vignetteSettings1;\nuniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;\nuniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\nuniform sampler2D txColorTransform;\nuniform vec4 colorTransformSettings;\n#endif",imageProcessingFunctions:"#ifdef COLORGRADING\n\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{\nfloat sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);\n\n\nfloat sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;\nsliceUV.x+=sliceInteger*sliceSize;\nsliceUV=clamp(sliceUV,0.,1.);\nvec4 slice0Color=texture2D(colorTransform,sliceUV);\nsliceUV.x+=sliceSize;\nsliceUV=clamp(sliceUV,0.,1.);\nvec4 slice1Color=texture2D(colorTransform,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;\n}\n#endif\nvec4 applyImageProcessing(vec4 result) {\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\n\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;\nviewportXY=viewportXY*2.0-1.0;\nvec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);\nfloat vignetteTerm=dot(vignetteXY1,vignetteXY1);\nfloat vignette=pow(vignetteTerm,vignetteSettings2.w);\n\nvec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);\nresult.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\nconst float tonemappingCalibration=1.590579;\nresult.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n\nresult.rgb=toGammaSpace(result.rgb);\nresult.rgb=clamp(result.rgb,0.0,1.0);\n#ifdef CONTRAST\n\nvec3 resultHighContrast=applyEaseInOut(result.rgb);\nif (contrast<1.0) {\n\nresult.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);\n} else {\n\nresult.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);\n}\n#endif\n\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\n\nfloat luma=getLuminance(result.rgb);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\nreturn result;\n}",bumpFragmentFunctions:"#ifdef BUMP\n#if BUMPDIRECTUV == 1\n#define vBumpUV vMainUV1\n#elif BUMPDIRECTUV == 2\n#define vBumpUV vMainUV2\n#else\nvarying vec2 vBumpUV;\n#endif\nuniform sampler2D bumpSampler;\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv)\n{\n\nuv=gl_FrontFacing ? uv : -uv;\n\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\n\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;\n\ntangent*=vTangentSpaceParams.x;\nbitangent*=vTangentSpaceParams.y;\n\nfloat invmax=inversesqrt(max(dot(tangent,tangent),dot(bitangent,bitangent)));\nreturn mat3(tangent*invmax,bitangent*invmax,normal);\n}\nvec3 perturbNormal(mat3 cotangentFrame,vec2 uv)\n{\nvec3 map=texture2D(bumpSampler,uv).xyz;\nmap=map*2.0-1.0;\n#ifdef NORMALXYSCALE\nmap=normalize(map*vec3(vBumpInfos.y,vBumpInfos.y,1.0));\n#endif\nreturn normalize(cotangentFrame*map);\n}\n#ifdef PARALLAX\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\n\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\n\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,vBumpUV+vCurrOffset).w;\n\nif (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\n\nbreak;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\n\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n#endif",clipPlaneFragmentDeclaration:"#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif",fogFragmentDeclaration:"#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying vec3 vFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nfloat fogDistance=length(vFogDistance);\nif (FOGMODE_LINEAR == vFogInfos.x)\n{\nfogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2 == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif",clipPlaneFragment:"#ifdef CLIPPLANE\nif (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif",bumpFragment:"vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#else \nfloat normalScale=vBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,vBumpUV);\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef BUMP\nnormalW=perturbNormal(TBN,vBumpUV+uvOffset);\n#endif",lightFragment:"#ifdef LIGHT{X}\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,NdotL);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightGround,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,NdotL);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,NdotL);\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightGround,glossiness);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCLOSEESM{X}\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#else\n#ifdef SHADOWESM{X}\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#else \n#ifdef SHADOWPCF{X}\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPCFCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPCF(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#endif\n#endif\n#else\nshadow=1.;\n#endif\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor;\n#endif\n#endif\n#else\ndiffuseBase+=info.diffuse*shadow;\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#endif\n#endif",logDepthFragment:"#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif",fogFragment:"#ifdef FOG\nfloat fog=CalcFogFactor();\ncolor.rgb=fog*color.rgb+(1.0-fog)*vFogColor;\n#endif",pbrVertexDeclaration:"uniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\nuniform vec3 vRefractionMicrosurfaceInfos;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n",pbrFragmentDeclaration:"uniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\n\nuniform vec4 vLightingIntensity;\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\n\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\nuniform vec3 vRefractionMicrosurfaceInfos;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif",pbrUboDeclaration:"layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec2 vAlbedoInfos;\nuniform vec3 vAmbientInfos;\nuniform vec2 vOpacityInfos;\nuniform vec2 vEmissiveInfos;\nuniform vec2 vLightmapInfos;\nuniform vec3 vReflectivityInfos;\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform vec4 vRefractionInfos;\nuniform vec2 vReflectionInfos;\nuniform vec3 vBumpInfos;\nuniform mat4 albedoMatrix;\nuniform mat4 ambientMatrix;\nuniform mat4 opacityMatrix;\nuniform mat4 emissiveMatrix;\nuniform mat4 lightmapMatrix;\nuniform mat4 reflectivityMatrix;\nuniform mat4 microSurfaceSamplerMatrix;\nuniform mat4 bumpMatrix;\nuniform vec2 vTangentSpaceParams;\nuniform mat4 refractionMatrix;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\nuniform vec4 vLightingIntensity;\nuniform vec3 vRefractionMicrosurfaceInfos;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\nuniform float pointSize;\n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};",pbrFunctions:"\n#define RECIPROCAL_PI2 0.15915494\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n\nconst float kRougnhessToAlphaScale=0.1;\nconst float kRougnhessToAlphaOffset=0.29248125;\nfloat convertRoughnessToAverageSlope(float roughness)\n{\n\nconst float kMinimumVariance=0.0005;\nfloat alphaG=square(roughness)+kMinimumVariance;\nreturn alphaG;\n}\n\nfloat smithVisibilityG1_TrowbridgeReitzGGX(float dot,float alphaG)\n{\nfloat tanSquared=(1.0-dot*dot)/(dot*dot);\nreturn 2.0/(1.0+sqrt(1.0+alphaG*alphaG*tanSquared));\n}\nfloat smithVisibilityG_TrowbridgeReitzGGX_Walter(float NdotL,float NdotV,float alphaG)\n{\nreturn smithVisibilityG1_TrowbridgeReitzGGX(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGX(NdotV,alphaG);\n}\n\n\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\n\n\n\nfloat a2=square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(PI*d*d);\n}\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow(clamp(1.0-VdotH,0.,1.),5.0);\n}\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\n\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow(clamp(1.0-VdotN,0.,1.),5.0);\n}\n\nvec3 computeSpecularTerm(float NdotH,float NdotL,float NdotV,float VdotH,float roughness,vec3 reflectance0,vec3 reflectance90)\n{\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\nfloat visibility=smithVisibilityG_TrowbridgeReitzGGX_Walter(NdotL,NdotV,alphaG);\nvisibility/=(4.0*NdotL*NdotV); \nfloat specTerm=max(0.,visibility*distribution)*NdotL;\nvec3 fresnel=fresnelSchlickGGX(VdotH,reflectance0,reflectance90);\nreturn fresnel*specTerm;\n}\nfloat computeDiffuseTerm(float NdotL,float NdotV,float VdotH,float roughness)\n{\n\n\nfloat diffuseFresnelNV=pow(clamp(1.0-NdotL,0.000001,1.),5.0);\nfloat diffuseFresnelNL=pow(clamp(1.0-NdotV,0.000001,1.),5.0);\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn fresnel*NdotL/PI;\n}\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\n\nfloat lightRoughness=lightRadius/lightDistance;\n\nfloat totalRoughness=clamp(lightRoughness+roughness,0.,1.);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nconst float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\n\n\nfloat fresnelGrazingReflectance(float reflectance0) {\nfloat reflectance90=clamp(reflectance0*25.0,0.0,1.0);\nreturn reflectance90;\n}\n\n\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {\nfloat microsurfaceAverageSlope=alphaG;\n\n\n\n\n\n\nmicrosurfaceAverageSlope*=sqrt(abs(NdotV));\nfloat microsurfaceAverageSlopeTexels=microsurfaceAverageSlope*cubeMapDimensionPixels;\nfloat lod=log2(microsurfaceAverageSlopeTexels);\nreturn lod;\n}\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {\n\n\nfloat temp=NdotVUnclamped+ambientOcclusion;\nreturn clamp(square(temp)-1.0+ambientOcclusion,0.0,1.0);\n}\nfloat environmentHorizonOcclusion(vec3 reflection,vec3 normal) {\n\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflection.z*=-1.0;\n#endif\nfloat temp=clamp( 1.0+1.1*dot(reflection,normal),0.0,1.0);\nreturn square(temp);\n}",harmonicsFunctions:"#ifdef USESPHERICALFROMREFLECTIONMAP\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\nvec3 quaternionVectorRotation_ScaledSqrtTwo(vec4 Q,vec3 V){\nvec3 T=cross(Q.xyz,V);\nT+=Q.www*V;\nreturn cross(Q.xyz,T)+V;\n}\nvec3 environmentIrradianceJones(vec3 normal)\n{\n\n\n\n\n\n\n\n\n\nfloat Nx=normal.x;\nfloat Ny=normal.y;\nfloat Nz=normal.z;\nvec3 C1=vSphericalZZ.rgb;\nvec3 Cx=vSphericalX.rgb;\nvec3 Cy=vSphericalY.rgb;\nvec3 Cz=vSphericalZ.rgb;\nvec3 Cxx_zz=vSphericalXX_ZZ.rgb;\nvec3 Cyy_zz=vSphericalYY_ZZ.rgb;\nvec3 Cxy=vSphericalXY.rgb;\nvec3 Cyz=vSphericalYZ.rgb;\nvec3 Czx=vSphericalZX.rgb;\nvec3 a1=Cyy_zz*Ny+Cy;\nvec3 a2=Cyz*Nz+a1;\nvec3 b1=Czx*Nz+Cx;\nvec3 b2=Cxy*Ny+b1;\nvec3 b3=Cxx_zz*Nx+b2;\nvec3 t1=Cz*Nz+C1;\nvec3 t2=a2*Ny+t1;\nvec3 t3=b3*Nx+t2;\nreturn t3;\n}\n#endif",pbrLightFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n};\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range)\n{ \n#ifdef USEPHYSICALLIGHTFALLOFF\nfloat lightDistanceFalloff=1.0/((lightDistanceSquared+0.001));\n#else\nfloat lightDistanceFalloff=max(0.,1.0-length(lightOffset)/range);\n#endif\nreturn lightDistanceFalloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{\nfloat falloff=0.0;\n#ifdef USEPHYSICALLIGHTFALLOFF\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \n\n\n\n\n\nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\n\n\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfalloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\n#else\nfloat cosAngle=max(0.000000000000001,dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=cosHalfAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\n#endif\nreturn falloff;\n}\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\nvec3 lightDirection;\nfloat attenuation=1.0;\nfloat lightDistance;\n\nif (lightData.w == 0.)\n{\nvec3 lightOffset=lightData.xyz-vPositionW;\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nattenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\nlightDistance=sqrt(lightDistanceSquared);\nlightDirection=normalize(lightOffset);\n}\n\nelse\n{\nlightDistance=length(-lightData.xyz);\nlightDirection=normalize(-lightData.xyz);\n}\n\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW+lightDirection);\nNdotL=clamp(dot(vNormal,lightDirection),0.00000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90);\nresult.specular=specTerm*diffuseColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\nvec3 lightOffset=lightData.xyz-vPositionW;\nvec3 directionToLightCenterW=normalize(lightOffset);\n\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nfloat attenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\n\nfloat directionalAttenuation=computeDirectionalLightFalloff(lightDirection.xyz,directionToLightCenterW,lightDirection.w,lightData.w);\nattenuation*=directionalAttenuation;\n\nfloat lightDistance=sqrt(lightDistanceSquared);\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW+directionToLightCenterW);\nNdotL=clamp(dot(vNormal,directionToLightCenterW),0.000000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90);\nresult.specular=specTerm*diffuseColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\n\n\n\nNdotL=dot(vNormal,lightData.xyz)*0.5+0.5;\nresult.diffuse=mix(groundColor,diffuseColor,NdotL);\n#ifdef SPECULARTERM\n\nvec3 lightVectorW=normalize(lightData.xyz);\nvec3 H=normalize(viewDirectionW+lightVectorW);\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nNdotL=clamp(NdotL,0.000000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90);\nresult.specular=specTerm*diffuseColor;\n#endif\nreturn result;\n}",mrtFragmentDeclaration:"#if __VERSION__>=200\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n",bones300Declaration:"#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nin vec4 matricesIndices;\nin vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nin vec4 matricesIndicesExtra;\nin vec4 matricesWeightsExtra;\n#endif\n#endif",instances300Declaration:"#ifdef INSTANCES\nin vec4 world0;\nin vec4 world1;\nin vec4 world2;\nin vec4 world3;\n#else\nuniform mat4 world;\n#endif",kernelBlurFragment:"#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*KERNEL_WEIGHT{X};\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*KERNEL_WEIGHT{X};\n#endif",kernelBlurFragment2:"#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*KERNEL_DEP_WEIGHT{X};\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*KERNEL_DEP_WEIGHT{X};\n#endif",kernelBlurVaryingDeclaration:"varying vec2 sampleCoord{X};",kernelBlurVertex:"sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};"};(function universalModuleDefinition(root,factory){if(root&&root["BABYLON"]){return}if(typeof exports==="object"&&typeof module==="object")module.exports=factory();else if(typeof define==="function"&&define.amd)define([],factory);else if(typeof exports==="object")exports["BABYLON"]=factory();else{root["BABYLON"]=factory()}})(this,function(){return BABYLON})},{"./Oimo":1,cannon:3}],3:[function(require,module,exports){(function(global){!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&false)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.CANNON=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){module.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(_dereq_,module,exports){module.exports={version:_dereq_("../package.json").version,AABB:_dereq_("./collision/AABB"),ArrayCollisionMatrix:_dereq_("./collision/ArrayCollisionMatrix"),Body:_dereq_("./objects/Body"),Box:_dereq_("./shapes/Box"),Broadphase:_dereq_("./collision/Broadphase"),Constraint:_dereq_("./constraints/Constraint"),ContactEquation:_dereq_("./equations/ContactEquation"),Narrowphase:_dereq_("./world/Narrowphase"),ConeTwistConstraint:_dereq_("./constraints/ConeTwistConstraint"),ContactMaterial:_dereq_("./material/ContactMaterial"),ConvexPolyhedron:_dereq_("./shapes/ConvexPolyhedron"),Cylinder:_dereq_("./shapes/Cylinder"),DistanceConstraint:_dereq_("./constraints/DistanceConstraint"),Equation:_dereq_("./equations/Equation"),EventTarget:_dereq_("./utils/EventTarget"),FrictionEquation:_dereq_("./equations/FrictionEquation"),GSSolver:_dereq_("./solver/GSSolver"),GridBroadphase:_dereq_("./collision/GridBroadphase"),Heightfield:_dereq_("./shapes/Heightfield"),HingeConstraint:_dereq_("./constraints/HingeConstraint"),LockConstraint:_dereq_("./constraints/LockConstraint"),Mat3:_dereq_("./math/Mat3"),Material:_dereq_("./material/Material"),NaiveBroadphase:_dereq_("./collision/NaiveBroadphase"),ObjectCollisionMatrix:_dereq_("./collision/ObjectCollisionMatrix"),Pool:_dereq_("./utils/Pool"),Particle:_dereq_("./shapes/Particle"),Plane:_dereq_("./shapes/Plane"),PointToPointConstraint:_dereq_("./constraints/PointToPointConstraint"),Quaternion:_dereq_("./math/Quaternion"),Ray:_dereq_("./collision/Ray"),RaycastVehicle:_dereq_("./objects/RaycastVehicle"),RaycastResult:_dereq_("./collision/RaycastResult"),RigidVehicle:_dereq_("./objects/RigidVehicle"),RotationalEquation:_dereq_("./equations/RotationalEquation"),RotationalMotorEquation:_dereq_("./equations/RotationalMotorEquation"),SAPBroadphase:_dereq_("./collision/SAPBroadphase"),SPHSystem:_dereq_("./objects/SPHSystem"),Shape:_dereq_("./shapes/Shape"),Solver:_dereq_("./solver/Solver"),Sphere:_dereq_("./shapes/Sphere"),SplitSolver:_dereq_("./solver/SplitSolver"),Spring:_dereq_("./objects/Spring"),Trimesh:_dereq_("./shapes/Trimesh"),Vec3:_dereq_("./math/Vec3"),Vec3Pool:_dereq_("./utils/Vec3Pool"),World:_dereq_("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(_dereq_,module,exports){var Vec3=_dereq_("../math/Vec3");var Utils=_dereq_("../utils/Utils");module.exports=AABB;function AABB(options){options=options||{};this.lowerBound=new Vec3;if(options.lowerBound){this.lowerBound.copy(options.lowerBound)}this.upperBound=new Vec3;if(options.upperBound){this.upperBound.copy(options.upperBound)}}var tmp=new Vec3;AABB.prototype.setFromPoints=function(points,position,quaternion,skinSize){var l=this.lowerBound,u=this.upperBound,q=quaternion;l.copy(points[0]);if(q){q.vmult(l,l)}u.copy(l);for(var i=1;i<points.length;i++){var p=points[i];if(q){q.vmult(p,tmp);p=tmp}if(p.x>u.x){u.x=p.x}if(p.x<l.x){l.x=p.x}if(p.y>u.y){u.y=p.y}if(p.y<l.y){l.y=p.y}if(p.z>u.z){u.z=p.z}if(p.z<l.z){l.z=p.z}}if(position){position.vadd(l,l);position.vadd(u,u)}if(skinSize){l.x-=skinSize;l.y-=skinSize;l.z-=skinSize;u.x+=skinSize;u.y+=skinSize;u.z+=skinSize}return this};AABB.prototype.copy=function(aabb){this.lowerBound.copy(aabb.lowerBound);this.upperBound.copy(aabb.upperBound);return this};AABB.prototype.clone=function(){return(new AABB).copy(this)};AABB.prototype.extend=function(aabb){var l=aabb.lowerBound.x;if(this.lowerBound.x>l){this.lowerBound.x=l}var u=aabb.upperBound.x;if(this.upperBound.x<u){this.upperBound.x=u}var l=aabb.lowerBound.y;if(this.lowerBound.y>l){this.lowerBound.y=l}var u=aabb.upperBound.y;if(this.upperBound.y<u){this.upperBound.y=u}var l=aabb.lowerBound.z;if(this.lowerBound.z>l){this.lowerBound.z=l}var u=aabb.upperBound.z;if(this.upperBound.z<u){this.upperBound.z=u}};AABB.prototype.overlaps=function(aabb){var l1=this.lowerBound,u1=this.upperBound,l2=aabb.lowerBound,u2=aabb.upperBound;return(l2.x<=u1.x&&u1.x<=u2.x||l1.x<=u2.x&&u2.x<=u1.x)&&(l2.y<=u1.y&&u1.y<=u2.y||l1.y<=u2.y&&u2.y<=u1.y)&&(l2.z<=u1.z&&u1.z<=u2.z||l1.z<=u2.z&&u2.z<=u1.z)};AABB.prototype.contains=function(aabb){var l1=this.lowerBound,u1=this.upperBound,l2=aabb.lowerBound,u2=aabb.upperBound;return l1.x<=l2.x&&u1.x>=u2.x&&(l1.y<=l2.y&&u1.y>=u2.y)&&(l1.z<=l2.z&&u1.z>=u2.z)};AABB.prototype.getCorners=function(a,b,c,d,e,f,g,h){var l=this.lowerBound,u=this.upperBound;a.copy(l);b.set(u.x,l.y,l.z);c.set(u.x,u.y,l.z);d.set(l.x,u.y,u.z);e.set(u.x,l.y,l.z);f.set(l.x,u.y,l.z);g.set(l.x,l.y,u.z);h.copy(u)};var transformIntoFrame_corners=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];AABB.prototype.toLocalFrame=function(frame,target){var corners=transformIntoFrame_corners;var a=corners[0];var b=corners[1];var c=corners[2];var d=corners[3];var e=corners[4];var f=corners[5];var g=corners[6];var h=corners[7];this.getCorners(a,b,c,d,e,f,g,h);for(var i=0;i!==8;i++){var corner=corners[i];frame.pointToLocal(corner,corner)}return target.setFromPoints(corners)};AABB.prototype.toWorldFrame=function(frame,target){var corners=transformIntoFrame_corners;var a=corners[0];var b=corners[1];var c=corners[2];var d=corners[3];var e=corners[4];var f=corners[5];var g=corners[6];var h=corners[7];this.getCorners(a,b,c,d,e,f,g,h);for(var i=0;i!==8;i++){var corner=corners[i];frame.pointToWorld(corner,corner)}return target.setFromPoints(corners)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(_dereq_,module,exports){module.exports=ArrayCollisionMatrix;function ArrayCollisionMatrix(){this.matrix=[]}ArrayCollisionMatrix.prototype.get=function(i,j){i=i.index;j=j.index;if(j>i){var temp=j;j=i;i=temp}return this.matrix[(i*(i+1)>>1)+j-1]};ArrayCollisionMatrix.prototype.set=function(i,j,value){i=i.index;j=j.index;if(j>i){var temp=j;j=i;i=temp}this.matrix[(i*(i+1)>>1)+j-1]=value?1:0};ArrayCollisionMatrix.prototype.reset=function(){for(var i=0,l=this.matrix.length;i!==l;i++){this.matrix[i]=0}};ArrayCollisionMatrix.prototype.setNumObjects=function(n){this.matrix.length=n*(n-1)>>1}},{}],5:[function(_dereq_,module,exports){var Body=_dereq_("../objects/Body");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Shape=_dereq_("../shapes/Shape");var Plane=_dereq_("../shapes/Plane");module.exports=Broadphase;function Broadphase(){this.world=null;this.useBoundingBoxes=false;this.dirty=true}Broadphase.prototype.collisionPairs=function(world,p1,p2){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var Broadphase_needBroadphaseCollision_STATIC_OR_KINEMATIC=Body.STATIC|Body.KINEMATIC;Broadphase.prototype.needBroadphaseCollision=function(bodyA,bodyB){if((bodyA.collisionFilterGroup&bodyB.collisionFilterMask)===0||(bodyB.collisionFilterGroup&bodyA.collisionFilterMask)===0){return false}if(((bodyA.type&Broadphase_needBroadphaseCollision_STATIC_OR_KINEMATIC)!==0||bodyA.sleepState===Body.SLEEPING)&&((bodyB.type&Broadphase_needBroadphaseCollision_STATIC_OR_KINEMATIC)!==0||bodyB.sleepState===Body.SLEEPING)){return false}return true};Broadphase.prototype.intersectionTest=function(bodyA,bodyB,pairs1,pairs2){if(this.useBoundingBoxes){this.doBoundingBoxBroadphase(bodyA,bodyB,pairs1,pairs2)}else{this.doBoundingSphereBroadphase(bodyA,bodyB,pairs1,pairs2)}};var Broadphase_collisionPairs_r=new Vec3,Broadphase_collisionPairs_normal=new Vec3,Broadphase_collisionPairs_quat=new Quaternion,Broadphase_collisionPairs_relpos=new Vec3;Broadphase.prototype.doBoundingSphereBroadphase=function(bodyA,bodyB,pairs1,pairs2){var r=Broadphase_collisionPairs_r;bodyB.position.vsub(bodyA.position,r);var boundingRadiusSum2=Math.pow(bodyA.boundingRadius+bodyB.boundingRadius,2);var norm2=r.norm2();if(norm2<boundingRadiusSum2){pairs1.push(bodyA);pairs2.push(bodyB)}};Broadphase.prototype.doBoundingBoxBroadphase=function(bodyA,bodyB,pairs1,pairs2){if(bodyA.aabbNeedsUpdate){bodyA.computeAABB()}if(bodyB.aabbNeedsUpdate){bodyB.computeAABB()}if(bodyA.aabb.overlaps(bodyB.aabb)){pairs1.push(bodyA);pairs2.push(bodyB)}};var Broadphase_makePairsUnique_temp={keys:[]},Broadphase_makePairsUnique_p1=[],Broadphase_makePairsUnique_p2=[];Broadphase.prototype.makePairsUnique=function(pairs1,pairs2){var t=Broadphase_makePairsUnique_temp,p1=Broadphase_makePairsUnique_p1,p2=Broadphase_makePairsUnique_p2,N=pairs1.length;for(var i=0;i!==N;i++){p1[i]=pairs1[i];p2[i]=pairs2[i]}pairs1.length=0;pairs2.length=0;for(var i=0;i!==N;i++){var id1=p1[i].id,id2=p2[i].id;var key=id1<id2?id1+","+id2:id2+","+id1;t[key]=i;t.keys.push(key)}for(var i=0;i!==t.keys.length;i++){var key=t.keys.pop(),pairIndex=t[key];pairs1.push(p1[pairIndex]);pairs2.push(p2[pairIndex]);delete t[key]}};Broadphase.prototype.setWorld=function(world){};var bsc_dist=new Vec3;Broadphase.boundingSphereCheck=function(bodyA,bodyB){var dist=bsc_dist;bodyA.position.vsub(bodyB.position,dist);return Math.pow(bodyA.shape.boundingSphereRadius+bodyB.shape.boundingSphereRadius,2)>dist.norm2()};Broadphase.prototype.aabbQuery=function(world,aabb,result){console.warn(".aabbQuery is not implemented in this Broadphase subclass.");return[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(_dereq_,module,exports){module.exports=GridBroadphase;var Broadphase=_dereq_("./Broadphase");var Vec3=_dereq_("../math/Vec3");var Shape=_dereq_("../shapes/Shape");function GridBroadphase(aabbMin,aabbMax,nx,ny,nz){Broadphase.apply(this);this.nx=nx||10;this.ny=ny||10;this.nz=nz||10;this.aabbMin=aabbMin||new Vec3(100,100,100);this.aabbMax=aabbMax||new Vec3(-100,-100,-100);var nbins=this.nx*this.ny*this.nz;if(nbins<=0){throw"GridBroadphase: Each dimension's n must be >0"}this.bins=[];this.binLengths=[];this.bins.length=nbins;this.binLengths.length=nbins;for(var i=0;i<nbins;i++){this.bins[i]=[];this.binLengths[i]=0}}GridBroadphase.prototype=new Broadphase;GridBroadphase.prototype.constructor=GridBroadphase;var GridBroadphase_collisionPairs_d=new Vec3;var GridBroadphase_collisionPairs_binPos=new Vec3;GridBroadphase.prototype.collisionPairs=function(world,pairs1,pairs2){var N=world.numObjects(),bodies=world.bodies;var max=this.aabbMax,min=this.aabbMin,nx=this.nx,ny=this.ny,nz=this.nz;var xstep=ny*nz;var ystep=nz;var zstep=1;var xmax=max.x,ymax=max.y,zmax=max.z,xmin=min.x,ymin=min.y,zmin=min.z;var xmult=nx/(xmax-xmin),ymult=ny/(ymax-ymin),zmult=nz/(zmax-zmin);var binsizeX=(xmax-xmin)/nx,binsizeY=(ymax-ymin)/ny,binsizeZ=(zmax-zmin)/nz;var binRadius=Math.sqrt(binsizeX*binsizeX+binsizeY*binsizeY+binsizeZ*binsizeZ)*.5;var types=Shape.types;var SPHERE=types.SPHERE,PLANE=types.PLANE,BOX=types.BOX,COMPOUND=types.COMPOUND,CONVEXPOLYHEDRON=types.CONVEXPOLYHEDRON;var bins=this.bins,binLengths=this.binLengths,Nbins=this.bins.length;for(var i=0;i!==Nbins;i++){binLengths[i]=0}var ceil=Math.ceil;var min=Math.min;var max=Math.max;function addBoxToBins(x0,y0,z0,x1,y1,z1,bi){var xoff0=(x0-xmin)*xmult|0,yoff0=(y0-ymin)*ymult|0,zoff0=(z0-zmin)*zmult|0,xoff1=ceil((x1-xmin)*xmult),yoff1=ceil((y1-ymin)*ymult),zoff1=ceil((z1-zmin)*zmult);if(xoff0<0){xoff0=0}else if(xoff0>=nx){xoff0=nx-1}if(yoff0<0){yoff0=0}else if(yoff0>=ny){yoff0=ny-1}if(zoff0<0){zoff0=0}else if(zoff0>=nz){zoff0=nz-1}if(xoff1<0){xoff1=0}else if(xoff1>=nx){xoff1=nx-1}if(yoff1<0){yoff1=0}else if(yoff1>=ny){yoff1=ny-1}if(zoff1<0){zoff1=0}else if(zoff1>=nz){zoff1=nz-1}xoff0*=xstep;yoff0*=ystep;zoff0*=zstep;xoff1*=xstep;yoff1*=ystep;zoff1*=zstep;for(var xoff=xoff0;xoff<=xoff1;xoff+=xstep){for(var yoff=yoff0;yoff<=yoff1;yoff+=ystep){for(var zoff=zoff0;zoff<=zoff1;zoff+=zstep){var idx=xoff+yoff+zoff;bins[idx][binLengths[idx]++]=bi}}}}for(var i=0;i!==N;i++){var bi=bodies[i];var si=bi.shape;switch(si.type){case SPHERE:var x=bi.position.x,y=bi.position.y,z=bi.position.z;var r=si.radius;addBoxToBins(x-r,y-r,z-r,x+r,y+r,z+r,bi);break;case PLANE:if(si.worldNormalNeedsUpdate){si.computeWorldNormal(bi.quaternion)}var planeNormal=si.worldNormal;var xreset=xmin+binsizeX*.5-bi.position.x,yreset=ymin+binsizeY*.5-bi.position.y,zreset=zmin+binsizeZ*.5-bi.position.z;var d=GridBroadphase_collisionPairs_d;d.set(xreset,yreset,zreset);for(var xi=0,xoff=0;xi!==nx;xi++,xoff+=xstep,d.y=yreset,d.x+=binsizeX){for(var yi=0,yoff=0;yi!==ny;yi++,yoff+=ystep,d.z=zreset,d.y+=binsizeY){for(var zi=0,zoff=0;zi!==nz;zi++,zoff+=zstep,d.z+=binsizeZ){if(d.dot(planeNormal)<binRadius){var idx=xoff+yoff+zoff;bins[idx][binLengths[idx]++]=bi}}}}break;default:if(bi.aabbNeedsUpdate){bi.computeAABB()}addBoxToBins(bi.aabb.lowerBound.x,bi.aabb.lowerBound.y,bi.aabb.lowerBound.z,bi.aabb.upperBound.x,bi.aabb.upperBound.y,bi.aabb.upperBound.z,bi);break}}for(var i=0;i!==Nbins;i++){var binLength=binLengths[i];if(binLength>1){var bin=bins[i];for(var xi=0;xi!==binLength;xi++){var bi=bin[xi];for(var yi=0;yi!==xi;yi++){var bj=bin[yi];if(this.needBroadphaseCollision(bi,bj)){this.intersectionTest(bi,bj,pairs1,pairs2)}}}}}this.makePairsUnique(pairs1,pairs2)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(_dereq_,module,exports){module.exports=NaiveBroadphase;var Broadphase=_dereq_("./Broadphase");var AABB=_dereq_("./AABB");function NaiveBroadphase(){Broadphase.apply(this)}NaiveBroadphase.prototype=new Broadphase;NaiveBroadphase.prototype.constructor=NaiveBroadphase;NaiveBroadphase.prototype.collisionPairs=function(world,pairs1,pairs2){var bodies=world.bodies,n=bodies.length,i,j,bi,bj;for(i=0;i!==n;i++){for(j=0;j!==i;j++){bi=bodies[i];bj=bodies[j];if(!this.needBroadphaseCollision(bi,bj)){continue}this.intersectionTest(bi,bj,pairs1,pairs2)}}};var tmpAABB=new AABB;NaiveBroadphase.prototype.aabbQuery=function(world,aabb,result){result=result||[];for(var i=0;i<world.bodies.length;i++){var b=world.bodies[i];if(b.aabbNeedsUpdate){b.computeAABB()}if(b.aabb.overlaps(aabb)){result.push(b)}}return result}},{"./AABB":3,"./Broadphase":5}],8:[function(_dereq_,module,exports){module.exports=ObjectCollisionMatrix;function ObjectCollisionMatrix(){this.matrix={}}ObjectCollisionMatrix.prototype.get=function(i,j){i=i.id;j=j.id;if(j>i){var temp=j;j=i;i=temp}return i+"-"+j in this.matrix};ObjectCollisionMatrix.prototype.set=function(i,j,value){i=i.id;j=j.id;if(j>i){var temp=j;j=i;i=temp}if(value){this.matrix[i+"-"+j]=true}else{delete this.matrix[i+"-"+j]}};ObjectCollisionMatrix.prototype.reset=function(){this.matrix={}};ObjectCollisionMatrix.prototype.setNumObjects=function(n){}},{}],9:[function(_dereq_,module,exports){module.exports=Ray;var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Transform=_dereq_("../math/Transform");var ConvexPolyhedron=_dereq_("../shapes/ConvexPolyhedron");var Box=_dereq_("../shapes/Box");var RaycastResult=_dereq_("../collision/RaycastResult");var Shape=_dereq_("../shapes/Shape");var AABB=_dereq_("../collision/AABB");function Ray(from,to){this.from=from?from.clone():new Vec3;this.to=to?to.clone():new Vec3;this._direction=new Vec3;this.precision=1e-4;this.checkCollisionResponse=true;this.skipBackfaces=false;this.collisionFilterMask=-1;this.collisionFilterGroup=-1;this.mode=Ray.ANY;this.result=new RaycastResult;this.hasHit=false;this.callback=function(result){}}Ray.prototype.constructor=Ray;Ray.CLOSEST=1;Ray.ANY=2;Ray.ALL=4;var tmpAABB=new AABB;var tmpArray=[];Ray.prototype.intersectWorld=function(world,options){this.mode=options.mode||Ray.ANY;this.result=options.result||new RaycastResult;this.skipBackfaces=!!options.skipBackfaces;this.collisionFilterMask=typeof options.collisionFilterMask!=="undefined"?options.collisionFilterMask:-1;this.collisionFilterGroup=typeof options.collisionFilterGroup!=="undefined"?options.collisionFilterGroup:-1;if(options.from){this.from.copy(options.from)}if(options.to){this.to.copy(options.to)}this.callback=options.callback||function(){};this.hasHit=false;this.result.reset();this._updateDirection();this.getAABB(tmpAABB);tmpArray.length=0;world.broadphase.aabbQuery(world,tmpAABB,tmpArray);this.intersectBodies(tmpArray);return this.hasHit};var v1=new Vec3,v2=new Vec3;Ray.pointInTriangle=pointInTriangle;function pointInTriangle(p,a,b,c){c.vsub(a,v0);b.vsub(a,v1);p.vsub(a,v2);var dot00=v0.dot(v0);var dot01=v0.dot(v1);var dot02=v0.dot(v2);var dot11=v1.dot(v1);var dot12=v1.dot(v2);var u,v;return(u=dot11*dot02-dot01*dot12)>=0&&(v=dot00*dot12-dot01*dot02)>=0&&u+v<dot00*dot11-dot01*dot01}var intersectBody_xi=new Vec3;var intersectBody_qi=new Quaternion;Ray.prototype.intersectBody=function(body,result){if(result){this.result=result;this._updateDirection()}var checkCollisionResponse=this.checkCollisionResponse;if(checkCollisionResponse&&!body.collisionResponse){return}if((this.collisionFilterGroup&body.collisionFilterMask)===0||(body.collisionFilterGroup&this.collisionFilterMask)===0){return}var xi=intersectBody_xi;var qi=intersectBody_qi;for(var i=0,N=body.shapes.length;i<N;i++){var shape=body.shapes[i];if(checkCollisionResponse&&!shape.collisionResponse){continue}body.quaternion.mult(body.shapeOrientations[i],qi);body.quaternion.vmult(body.shapeOffsets[i],xi);xi.vadd(body.position,xi);this.intersectShape(shape,qi,xi,body);if(this.result._shouldStop){break}}};Ray.prototype.intersectBodies=function(bodies,result){if(result){this.result=result;this._updateDirection()}for(var i=0,l=bodies.length;!this.result._shouldStop&&i<l;i++){this.intersectBody(bodies[i])}};Ray.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction);this._direction.normalize()};Ray.prototype.intersectShape=function(shape,quat,position,body){var from=this.from;var distance=distanceFromIntersection(from,this._direction,position);if(distance>shape.boundingSphereRadius){return}var intersectMethod=this[shape.type];if(intersectMethod){intersectMethod.call(this,shape,quat,position,body)}};var vector=new Vec3;var normal=new Vec3;var intersectPoint=new Vec3;var a=new Vec3;var b=new Vec3;var c=new Vec3;var d=new Vec3;var tmpRaycastResult=new RaycastResult;Ray.prototype.intersectBox=function(shape,quat,position,body){return this.intersectConvex(shape.convexPolyhedronRepresentation,quat,position,body)};Ray.prototype[Shape.types.BOX]=Ray.prototype.intersectBox;Ray.prototype.intersectPlane=function(shape,quat,position,body){var from=this.from;var to=this.to;var direction=this._direction;var worldNormal=new Vec3(0,0,1);quat.vmult(worldNormal,worldNormal);var len=new Vec3;from.vsub(position,len);var planeToFrom=len.dot(worldNormal);to.vsub(position,len);var planeToTo=len.dot(worldNormal);if(planeToFrom*planeToTo>0){return}if(from.distanceTo(to)<planeToFrom){return}var n_dot_dir=worldNormal.dot(direction);if(Math.abs(n_dot_dir)<this.precision){return}var planePointToFrom=new Vec3;var dir_scaled_with_t=new Vec3;var hitPointWorld=new Vec3;from.vsub(position,planePointToFrom);var t=-worldNormal.dot(planePointToFrom)/n_dot_dir;direction.scale(t,dir_scaled_with_t);from.vadd(dir_scaled_with_t,hitPointWorld);this.reportIntersection(worldNormal,hitPointWorld,shape,body,-1)};Ray.prototype[Shape.types.PLANE]=Ray.prototype.intersectPlane;Ray.prototype.getAABB=function(result){var to=this.to;var from=this.from;result.lowerBound.x=Math.min(to.x,from.x);result.lowerBound.y=Math.min(to.y,from.y);result.lowerBound.z=Math.min(to.z,from.z);result.upperBound.x=Math.max(to.x,from.x);result.upperBound.y=Math.max(to.y,from.y);result.upperBound.z=Math.max(to.z,from.z)};var intersectConvexOptions={faceList:[0]};Ray.prototype.intersectHeightfield=function(shape,quat,position,body){var data=shape.data,w=shape.elementSize,worldPillarOffset=new Vec3;var localRay=new Ray(this.from,this.to);Transform.pointToLocalFrame(position,quat,localRay.from,localRay.from);Transform.pointToLocalFrame(position,quat,localRay.to,localRay.to);var index=[];var iMinX=null;var iMinY=null;var iMaxX=null;var iMaxY=null;var inside=shape.getIndexOfPosition(localRay.from.x,localRay.from.y,index,false);if(inside){iMinX=index[0];iMinY=index[1];iMaxX=index[0];iMaxY=index[1]}inside=shape.getIndexOfPosition(localRay.to.x,localRay.to.y,index,false);if(inside){if(iMinX===null||index[0]<iMinX){iMinX=index[0]}if(iMaxX===null||index[0]>iMaxX){iMaxX=index[0]}if(iMinY===null||index[1]<iMinY){iMinY=index[1]}if(iMaxY===null||index[1]>iMaxY){iMaxY=index[1]}}if(iMinX===null){return}var minMax=[];shape.getRectMinMax(iMinX,iMinY,iMaxX,iMaxY,minMax);var min=minMax[0];var max=minMax[1];for(var i=iMinX;i<=iMaxX;i++){for(var j=iMinY;j<=iMaxY;j++){if(this.result._shouldStop){return}shape.getConvexTrianglePillar(i,j,false);Transform.pointToWorldFrame(position,quat,shape.pillarOffset,worldPillarOffset);this.intersectConvex(shape.pillarConvex,quat,worldPillarOffset,body,intersectConvexOptions);if(this.result._shouldStop){return}shape.getConvexTrianglePillar(i,j,true);Transform.pointToWorldFrame(position,quat,shape.pillarOffset,worldPillarOffset);this.intersectConvex(shape.pillarConvex,quat,worldPillarOffset,body,intersectConvexOptions)}}};Ray.prototype[Shape.types.HEIGHTFIELD]=Ray.prototype.intersectHeightfield;var Ray_intersectSphere_intersectionPoint=new Vec3;var Ray_intersectSphere_normal=new Vec3;Ray.prototype.intersectSphere=function(shape,quat,position,body){var from=this.from,to=this.to,r=shape.radius;var a=Math.pow(to.x-from.x,2)+Math.pow(to.y-from.y,2)+Math.pow(to.z-from.z,2);var b=2*((to.x-from.x)*(from.x-position.x)+(to.y-from.y)*(from.y-position.y)+(to.z-from.z)*(from.z-position.z));var c=Math.pow(from.x-position.x,2)+Math.pow(from.y-position.y,2)+Math.pow(from.z-position.z,2)-Math.pow(r,2);var delta=Math.pow(b,2)-4*a*c;var intersectionPoint=Ray_intersectSphere_intersectionPoint;var normal=Ray_intersectSphere_normal;if(delta<0){return}else if(delta===0){from.lerp(to,delta,intersectionPoint);intersectionPoint.vsub(position,normal);normal.normalize();this.reportIntersection(normal,intersectionPoint,shape,body,-1)}else{var d1=(-b-Math.sqrt(delta))/(2*a);var d2=(-b+Math.sqrt(delta))/(2*a);if(d1>=0&&d1<=1){from.lerp(to,d1,intersectionPoint);intersectionPoint.vsub(position,normal);normal.normalize();this.reportIntersection(normal,intersectionPoint,shape,body,-1)}if(this.result._shouldStop){return}if(d2>=0&&d2<=1){from.lerp(to,d2,intersectionPoint);intersectionPoint.vsub(position,normal);normal.normalize();this.reportIntersection(normal,intersectionPoint,shape,body,-1)}}};Ray.prototype[Shape.types.SPHERE]=Ray.prototype.intersectSphere;var intersectConvex_normal=new Vec3;var intersectConvex_minDistNormal=new Vec3;var intersectConvex_minDistIntersect=new Vec3;var intersectConvex_vector=new Vec3;Ray.prototype.intersectConvex=function intersectConvex(shape,quat,position,body,options){var minDistNormal=intersectConvex_minDistNormal;var normal=intersectConvex_normal;var vector=intersectConvex_vector;var minDistIntersect=intersectConvex_minDistIntersect;var faceList=options&&options.faceList||null;var faces=shape.faces,vertices=shape.vertices,normals=shape.faceNormals;var direction=this._direction;var from=this.from;var to=this.to;var fromToDistance=from.distanceTo(to);var minDist=-1;var Nfaces=faceList?faceList.length:faces.length;var result=this.result;for(var j=0;!result._shouldStop&&j<Nfaces;j++){var fi=faceList?faceList[j]:j;var face=faces[fi];var faceNormal=normals[fi];var q=quat;var x=position;vector.copy(vertices[face[0]]);q.vmult(vector,vector);vector.vadd(x,vector);vector.vsub(from,vector);q.vmult(faceNormal,normal);var dot=direction.dot(normal);if(Math.abs(dot)<this.precision){continue}var scalar=normal.dot(vector)/dot;if(scalar<0){continue}direction.mult(scalar,intersectPoint);intersectPoint.vadd(from,intersectPoint);a.copy(vertices[face[0]]);q.vmult(a,a);x.vadd(a,a);for(var i=1;!result._shouldStop&&i<face.length-1;i++){b.copy(vertices[face[i]]);c.copy(vertices[face[i+1]]);q.vmult(b,b);q.vmult(c,c);x.vadd(b,b);x.vadd(c,c);var distance=intersectPoint.distanceTo(from);if(!(pointInTriangle(intersectPoint,a,b,c)||pointInTriangle(intersectPoint,b,a,c))||distance>fromToDistance){continue}this.reportIntersection(normal,intersectPoint,shape,body,fi)}}};Ray.prototype[Shape.types.CONVEXPOLYHEDRON]=Ray.prototype.intersectConvex;var intersectTrimesh_normal=new Vec3;var intersectTrimesh_localDirection=new Vec3;var intersectTrimesh_localFrom=new Vec3;var intersectTrimesh_localTo=new Vec3;var intersectTrimesh_worldNormal=new Vec3;var intersectTrimesh_worldIntersectPoint=new Vec3;var intersectTrimesh_localAABB=new AABB;var intersectTrimesh_triangles=[];var intersectTrimesh_treeTransform=new Transform;Ray.prototype.intersectTrimesh=function intersectTrimesh(mesh,quat,position,body,options){var normal=intersectTrimesh_normal;var triangles=intersectTrimesh_triangles;var treeTransform=intersectTrimesh_treeTransform;var minDistNormal=intersectConvex_minDistNormal;var vector=intersectConvex_vector;var minDistIntersect=intersectConvex_minDistIntersect;var localAABB=intersectTrimesh_localAABB;var localDirection=intersectTrimesh_localDirection;var localFrom=intersectTrimesh_localFrom;var localTo=intersectTrimesh_localTo;var worldIntersectPoint=intersectTrimesh_worldIntersectPoint;var worldNormal=intersectTrimesh_worldNormal;var faceList=options&&options.faceList||null;var indices=mesh.indices,vertices=mesh.vertices,normals=mesh.faceNormals;var from=this.from;var to=this.to;var direction=this._direction;var minDist=-1;treeTransform.position.copy(position);treeTransform.quaternion.copy(quat);Transform.vectorToLocalFrame(position,quat,direction,localDirection);Transform.pointToLocalFrame(position,quat,from,localFrom);Transform.pointToLocalFrame(position,quat,to,localTo);var fromToDistanceSquared=localFrom.distanceSquared(localTo);mesh.tree.rayQuery(this,treeTransform,triangles);for(var i=0,N=triangles.length;!this.result._shouldStop&&i!==N;i++){var trianglesIndex=triangles[i];mesh.getNormal(trianglesIndex,normal);mesh.getVertex(indices[trianglesIndex*3],a);a.vsub(localFrom,vector);var dot=localDirection.dot(normal);var scalar=normal.dot(vector)/dot;if(scalar<0){continue}localDirection.scale(scalar,intersectPoint);intersectPoint.vadd(localFrom,intersectPoint);mesh.getVertex(indices[trianglesIndex*3+1],b);mesh.getVertex(indices[trianglesIndex*3+2],c);var squaredDistance=intersectPoint.distanceSquared(localFrom);if(!(pointInTriangle(intersectPoint,b,a,c)||pointInTriangle(intersectPoint,a,b,c))||squaredDistance>fromToDistanceSquared){continue}Transform.vectorToWorldFrame(quat,normal,worldNormal);Transform.pointToWorldFrame(position,quat,intersectPoint,worldIntersectPoint);this.reportIntersection(worldNormal,worldIntersectPoint,mesh,body,trianglesIndex)}triangles.length=0};Ray.prototype[Shape.types.TRIMESH]=Ray.prototype.intersectTrimesh;Ray.prototype.reportIntersection=function(normal,hitPointWorld,shape,body,hitFaceIndex){var from=this.from;var to=this.to;var distance=from.distanceTo(hitPointWorld);var result=this.result;if(this.skipBackfaces&&normal.dot(this._direction)>0){return}result.hitFaceIndex=typeof hitFaceIndex!=="undefined"?hitFaceIndex:-1;switch(this.mode){case Ray.ALL:this.hasHit=true;result.set(from,to,normal,hitPointWorld,shape,body,distance);result.hasHit=true;this.callback(result);break;case Ray.CLOSEST:if(distance<result.distance||!result.hasHit){this.hasHit=true;result.hasHit=true;result.set(from,to,normal,hitPointWorld,shape,body,distance)}break;case Ray.ANY:this.hasHit=true;result.hasHit=true;result.set(from,to,normal,hitPointWorld,shape,body,distance);result._shouldStop=true;break}};var v0=new Vec3,intersect=new Vec3;function distanceFromIntersection(from,direction,position){position.vsub(from,v0);var dot=v0.dot(direction);direction.mult(dot,intersect);intersect.vadd(from,intersect);var distance=position.distanceTo(intersect);return distance}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(_dereq_,module,exports){var Vec3=_dereq_("../math/Vec3");module.exports=RaycastResult;function RaycastResult(){this.rayFromWorld=new Vec3;this.rayToWorld=new Vec3;this.hitNormalWorld=new Vec3;this.hitPointWorld=new Vec3;this.hasHit=false;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=false}RaycastResult.prototype.reset=function(){this.rayFromWorld.setZero();this.rayToWorld.setZero();this.hitNormalWorld.setZero();this.hitPointWorld.setZero();this.hasHit=false;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=false};RaycastResult.prototype.abort=function(){this._shouldStop=true};RaycastResult.prototype.set=function(rayFromWorld,rayToWorld,hitNormalWorld,hitPointWorld,shape,body,distance){this.rayFromWorld.copy(rayFromWorld);this.rayToWorld.copy(rayToWorld);this.hitNormalWorld.copy(hitNormalWorld);this.hitPointWorld.copy(hitPointWorld);this.shape=shape;this.body=body;this.distance=distance}},{"../math/Vec3":30}],11:[function(_dereq_,module,exports){var Shape=_dereq_("../shapes/Shape");var Broadphase=_dereq_("../collision/Broadphase");module.exports=SAPBroadphase;function SAPBroadphase(world){Broadphase.apply(this);this.axisList=[];this.world=null;this.axisIndex=0;var axisList=this.axisList;this._addBodyHandler=function(e){axisList.push(e.body)};this._removeBodyHandler=function(e){var idx=axisList.indexOf(e.body);if(idx!==-1){axisList.splice(idx,1)}};if(world){this.setWorld(world)}}SAPBroadphase.prototype=new Broadphase;SAPBroadphase.prototype.setWorld=function(world){this.axisList.length=0;for(var i=0;i<world.bodies.length;i++){this.axisList.push(world.bodies[i])}world.removeEventListener("addBody",this._addBodyHandler);world.removeEventListener("removeBody",this._removeBodyHandler);world.addEventListener("addBody",this._addBodyHandler);world.addEventListener("removeBody",this._removeBodyHandler);this.world=world;this.dirty=true};SAPBroadphase.insertionSortX=function(a){for(var i=1,l=a.length;i<l;i++){var v=a[i];for(var j=i-1;j>=0;j--){if(a[j].aabb.lowerBound.x<=v.aabb.lowerBound.x){break}a[j+1]=a[j]}a[j+1]=v}return a};SAPBroadphase.insertionSortY=function(a){for(var i=1,l=a.length;i<l;i++){var v=a[i];for(var j=i-1;j>=0;j--){if(a[j].aabb.lowerBound.y<=v.aabb.lowerBound.y){break}a[j+1]=a[j]}a[j+1]=v}return a};SAPBroadphase.insertionSortZ=function(a){for(var i=1,l=a.length;i<l;i++){var v=a[i];for(var j=i-1;j>=0;j--){if(a[j].aabb.lowerBound.z<=v.aabb.lowerBound.z){break}a[j+1]=a[j]}a[j+1]=v}return a};SAPBroadphase.prototype.collisionPairs=function(world,p1,p2){var bodies=this.axisList,N=bodies.length,axisIndex=this.axisIndex,i,j;if(this.dirty){this.sortList();this.dirty=false}for(i=0;i!==N;i++){var bi=bodies[i];for(j=i+1;j<N;j++){var bj=bodies[j];if(!this.needBroadphaseCollision(bi,bj)){continue}if(!SAPBroadphase.checkBounds(bi,bj,axisIndex)){break}this.intersectionTest(bi,bj,p1,p2)}}};SAPBroadphase.prototype.sortList=function(){var axisList=this.axisList;var axisIndex=this.axisIndex;var N=axisList.length;for(var i=0;i!==N;i++){var bi=axisList[i];if(bi.aabbNeedsUpdate){bi.computeAABB()}}if(axisIndex===0){SAPBroadphase.insertionSortX(axisList)}else if(axisIndex===1){SAPBroadphase.insertionSortY(axisList)}else if(axisIndex===2){SAPBroadphase.insertionSortZ(axisList)}};SAPBroadphase.checkBounds=function(bi,bj,axisIndex){var biPos;var bjPos;if(axisIndex===0){biPos=bi.position.x;bjPos=bj.position.x}else if(axisIndex===1){biPos=bi.position.y;bjPos=bj.position.y}else if(axisIndex===2){biPos=bi.position.z;bjPos=bj.position.z}var ri=bi.boundingRadius,rj=bj.boundingRadius,boundA1=biPos-ri,boundA2=biPos+ri,boundB1=bjPos-rj,boundB2=bjPos+rj;return boundB1<boundA2};SAPBroadphase.prototype.autoDetectAxis=function(){var sumX=0,sumX2=0,sumY=0,sumY2=0,sumZ=0,sumZ2=0,bodies=this.axisList,N=bodies.length,invN=1/N;for(var i=0;i!==N;i++){var b=bodies[i];var centerX=b.position.x;sumX+=centerX;sumX2+=centerX*centerX;var centerY=b.position.y;sumY+=centerY;sumY2+=centerY*centerY;var centerZ=b.position.z;sumZ+=centerZ;sumZ2+=centerZ*centerZ}var varianceX=sumX2-sumX*sumX*invN,varianceY=sumY2-sumY*sumY*invN,varianceZ=sumZ2-sumZ*sumZ*invN;if(varianceX>varianceY){if(varianceX>varianceZ){this.axisIndex=0}else{this.axisIndex=2}}else if(varianceY>varianceZ){this.axisIndex=1}else{this.axisIndex=2}};SAPBroadphase.prototype.aabbQuery=function(world,aabb,result){result=result||[];if(this.dirty){this.sortList();this.dirty=false}var axisIndex=this.axisIndex,axis="x";if(axisIndex===1){axis="y"}if(axisIndex===2){axis="z"}var axisList=this.axisList;var lower=aabb.lowerBound[axis];var upper=aabb.upperBound[axis];for(var i=0;i<axisList.length;i++){var b=axisList[i];if(b.aabbNeedsUpdate){b.computeAABB()}if(b.aabb.overlaps(aabb)){result.push(b)}}return result}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(_dereq_,module,exports){module.exports=ConeTwistConstraint;var Constraint=_dereq_("./Constraint");var PointToPointConstraint=_dereq_("./PointToPointConstraint");var ConeEquation=_dereq_("../equations/ConeEquation");var RotationalEquation=_dereq_("../equations/RotationalEquation");var ContactEquation=_dereq_("../equations/ContactEquation");var Vec3=_dereq_("../math/Vec3");function ConeTwistConstraint(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;var pivotA=options.pivotA?options.pivotA.clone():new Vec3;var pivotB=options.pivotB?options.pivotB.clone():new Vec3;this.axisA=options.axisA?options.axisA.clone():new Vec3;this.axisB=options.axisB?options.axisB.clone():new Vec3;PointToPointConstraint.call(this,bodyA,pivotA,bodyB,pivotB,maxForce);this.collideConnected=!!options.collideConnected;this.angle=typeof options.angle!=="undefined"?options.angle:0;var c=this.coneEquation=new ConeEquation(bodyA,bodyB,options);var t=this.twistEquation=new RotationalEquation(bodyA,bodyB,options);this.twistAngle=typeof options.twistAngle!=="undefined"?options.twistAngle:0;c.maxForce=0;c.minForce=-maxForce;t.maxForce=0;t.minForce=-maxForce;this.equations.push(c,t)}ConeTwistConstraint.prototype=new PointToPointConstraint;ConeTwistConstraint.constructor=ConeTwistConstraint;var ConeTwistConstraint_update_tmpVec1=new Vec3;var ConeTwistConstraint_update_tmpVec2=new Vec3;ConeTwistConstraint.prototype.update=function(){var bodyA=this.bodyA,bodyB=this.bodyB,cone=this.coneEquation,twist=this.twistEquation;PointToPointConstraint.prototype.update.call(this);bodyA.vectorToWorldFrame(this.axisA,cone.axisA);bodyB.vectorToWorldFrame(this.axisB,cone.axisB);this.axisA.tangents(twist.axisA,twist.axisA);bodyA.vectorToWorldFrame(twist.axisA,twist.axisA);this.axisB.tangents(twist.axisB,twist.axisB);bodyB.vectorToWorldFrame(twist.axisB,twist.axisB);cone.angle=this.angle;twist.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(_dereq_,module,exports){module.exports=Constraint;var Utils=_dereq_("../utils/Utils");function Constraint(bodyA,bodyB,options){options=Utils.defaults(options,{collideConnected:true,wakeUpBodies:true});this.equations=[];this.bodyA=bodyA;this.bodyB=bodyB;this.id=Constraint.idCounter++;this.collideConnected=options.collideConnected;if(options.wakeUpBodies){if(bodyA){bodyA.wakeUp()}if(bodyB){bodyB.wakeUp()}}}Constraint.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")};Constraint.prototype.enable=function(){var eqs=this.equations;for(var i=0;i<eqs.length;i++){eqs[i].enabled=true}};Constraint.prototype.disable=function(){var eqs=this.equations;for(var i=0;i<eqs.length;i++){eqs[i].enabled=false}};Constraint.idCounter=0},{"../utils/Utils":53}],14:[function(_dereq_,module,exports){module.exports=DistanceConstraint;var Constraint=_dereq_("./Constraint");var ContactEquation=_dereq_("../equations/ContactEquation");function DistanceConstraint(bodyA,bodyB,distance,maxForce){Constraint.call(this,bodyA,bodyB);if(typeof distance==="undefined"){distance=bodyA.position.distanceTo(bodyB.position)}if(typeof maxForce==="undefined"){maxForce=1e6}this.distance=distance;var eq=this.distanceEquation=new ContactEquation(bodyA,bodyB);this.equations.push(eq);eq.minForce=-maxForce;eq.maxForce=maxForce}DistanceConstraint.prototype=new Constraint;DistanceConstraint.prototype.update=function(){var bodyA=this.bodyA;var bodyB=this.bodyB;var eq=this.distanceEquation;var halfDist=this.distance*.5;var normal=eq.ni;bodyB.position.vsub(bodyA.position,normal);normal.normalize();normal.mult(halfDist,eq.ri);normal.mult(-halfDist,eq.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(_dereq_,module,exports){module.exports=HingeConstraint;var Constraint=_dereq_("./Constraint");var PointToPointConstraint=_dereq_("./PointToPointConstraint");var RotationalEquation=_dereq_("../equations/RotationalEquation");var RotationalMotorEquation=_dereq_("../equations/RotationalMotorEquation");var ContactEquation=_dereq_("../equations/ContactEquation");var Vec3=_dereq_("../math/Vec3");function HingeConstraint(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;var pivotA=options.pivotA?options.pivotA.clone():new Vec3;var pivotB=options.pivotB?options.pivotB.clone():new Vec3;PointToPointConstraint.call(this,bodyA,pivotA,bodyB,pivotB,maxForce);var axisA=this.axisA=options.axisA?options.axisA.clone():new Vec3(1,0,0);axisA.normalize();var axisB=this.axisB=options.axisB?options.axisB.clone():new Vec3(1,0,0);axisB.normalize();var r1=this.rotationalEquation1=new RotationalEquation(bodyA,bodyB,options);var r2=this.rotationalEquation2=new RotationalEquation(bodyA,bodyB,options);var motor=this.motorEquation=new RotationalMotorEquation(bodyA,bodyB,maxForce);motor.enabled=false;this.equations.push(r1,r2,motor)}HingeConstraint.prototype=new PointToPointConstraint;HingeConstraint.constructor=HingeConstraint;HingeConstraint.prototype.enableMotor=function(){this.motorEquation.enabled=true};HingeConstraint.prototype.disableMotor=function(){this.motorEquation.enabled=false};HingeConstraint.prototype.setMotorSpeed=function(speed){this.motorEquation.targetVelocity=speed};HingeConstraint.prototype.setMotorMaxForce=function(maxForce){this.motorEquation.maxForce=maxForce;this.motorEquation.minForce=-maxForce};var HingeConstraint_update_tmpVec1=new Vec3;var HingeConstraint_update_tmpVec2=new Vec3;HingeConstraint.prototype.update=function(){var bodyA=this.bodyA,bodyB=this.bodyB,motor=this.motorEquation,r1=this.rotationalEquation1,r2=this.rotationalEquation2,worldAxisA=HingeConstraint_update_tmpVec1,worldAxisB=HingeConstraint_update_tmpVec2;var axisA=this.axisA;var axisB=this.axisB;PointToPointConstraint.prototype.update.call(this);bodyA.quaternion.vmult(axisA,worldAxisA);bodyB.quaternion.vmult(axisB,worldAxisB);worldAxisA.tangents(r1.axisA,r2.axisA);r1.axisB.copy(worldAxisB);r2.axisB.copy(worldAxisB);if(this.motorEquation.enabled){bodyA.quaternion.vmult(this.axisA,motor.axisA);bodyB.quaternion.vmult(this.axisB,motor.axisB)}}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(_dereq_,module,exports){module.exports=LockConstraint;var Constraint=_dereq_("./Constraint");var PointToPointConstraint=_dereq_("./PointToPointConstraint");var RotationalEquation=_dereq_("../equations/RotationalEquation");var RotationalMotorEquation=_dereq_("../equations/RotationalMotorEquation");var ContactEquation=_dereq_("../equations/ContactEquation");var Vec3=_dereq_("../math/Vec3");function LockConstraint(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;var pivotA=new Vec3;var pivotB=new Vec3;var halfWay=new Vec3;bodyA.position.vadd(bodyB.position,halfWay);halfWay.scale(.5,halfWay);bodyB.pointToLocalFrame(halfWay,pivotB);bodyA.pointToLocalFrame(halfWay,pivotA);PointToPointConstraint.call(this,bodyA,pivotA,bodyB,pivotB,maxForce);var r1=this.rotationalEquation1=new RotationalEquation(bodyA,bodyB,options);var r2=this.rotationalEquation2=new RotationalEquation(bodyA,bodyB,options);var r3=this.rotationalEquation3=new RotationalEquation(bodyA,bodyB,options);this.equations.push(r1,r2,r3)}LockConstraint.prototype=new PointToPointConstraint;LockConstraint.constructor=LockConstraint;var LockConstraint_update_tmpVec1=new Vec3;var LockConstraint_update_tmpVec2=new Vec3;LockConstraint.prototype.update=function(){var bodyA=this.bodyA,bodyB=this.bodyB,motor=this.motorEquation,r1=this.rotationalEquation1,r2=this.rotationalEquation2,r3=this.rotationalEquation3,worldAxisA=LockConstraint_update_tmpVec1,worldAxisB=LockConstraint_update_tmpVec2;PointToPointConstraint.prototype.update.call(this);bodyA.vectorToWorldFrame(Vec3.UNIT_X,r1.axisA);bodyB.vectorToWorldFrame(Vec3.UNIT_Y,r1.axisB);bodyA.vectorToWorldFrame(Vec3.UNIT_Y,r2.axisA);bodyB.vectorToWorldFrame(Vec3.UNIT_Z,r2.axisB);bodyA.vectorToWorldFrame(Vec3.UNIT_Z,r3.axisA);bodyB.vectorToWorldFrame(Vec3.UNIT_X,r3.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(_dereq_,module,exports){module.exports=PointToPointConstraint;var Constraint=_dereq_("./Constraint");var ContactEquation=_dereq_("../equations/ContactEquation");var Vec3=_dereq_("../math/Vec3");function PointToPointConstraint(bodyA,pivotA,bodyB,pivotB,maxForce){Constraint.call(this,bodyA,bodyB);maxForce=typeof maxForce!=="undefined"?maxForce:1e6;this.pivotA=pivotA?pivotA.clone():new Vec3;this.pivotB=pivotB?pivotB.clone():new Vec3;var x=this.equationX=new ContactEquation(bodyA,bodyB);var y=this.equationY=new ContactEquation(bodyA,bodyB);var z=this.equationZ=new ContactEquation(bodyA,bodyB);this.equations.push(x,y,z);x.minForce=y.minForce=z.minForce=-maxForce;x.maxForce=y.maxForce=z.maxForce=maxForce;x.ni.set(1,0,0);y.ni.set(0,1,0);z.ni.set(0,0,1)}PointToPointConstraint.prototype=new Constraint;PointToPointConstraint.prototype.update=function(){var bodyA=this.bodyA;var bodyB=this.bodyB;var x=this.equationX;var y=this.equationY;var z=this.equationZ;bodyA.quaternion.vmult(this.pivotA,x.ri);bodyB.quaternion.vmult(this.pivotB,x.rj);y.ri.copy(x.ri);y.rj.copy(x.rj);z.ri.copy(x.ri);z.rj.copy(x.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(_dereq_,module,exports){module.exports=ConeEquation;var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");var Equation=_dereq_("./Equation");function ConeEquation(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;Equation.call(this,bodyA,bodyB,-maxForce,maxForce);this.axisA=options.axisA?options.axisA.clone():new Vec3(1,0,0);this.axisB=options.axisB?options.axisB.clone():new Vec3(0,1,0);this.angle=typeof options.angle!=="undefined"?options.angle:0}ConeEquation.prototype=new Equation;ConeEquation.prototype.constructor=ConeEquation;var tmpVec1=new Vec3;var tmpVec2=new Vec3;ConeEquation.prototype.computeB=function(h){var a=this.a,b=this.b,ni=this.axisA,nj=this.axisB,nixnj=tmpVec1,njxni=tmpVec2,GA=this.jacobianElementA,GB=this.jacobianElementB;ni.cross(nj,nixnj);nj.cross(ni,njxni);GA.rotational.copy(njxni);GB.rotational.copy(nixnj);var g=Math.cos(this.angle)-ni.dot(nj),GW=this.computeGW(),GiMf=this.computeGiMf();var B=-g*a-GW*b-h*GiMf;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(_dereq_,module,exports){module.exports=ContactEquation;var Equation=_dereq_("./Equation");var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");function ContactEquation(bodyA,bodyB,maxForce){maxForce=typeof maxForce!=="undefined"?maxForce:1e6;Equation.call(this,bodyA,bodyB,0,maxForce);this.restitution=0;this.ri=new Vec3;this.rj=new Vec3;this.ni=new Vec3}ContactEquation.prototype=new Equation;ContactEquation.prototype.constructor=ContactEquation;var ContactEquation_computeB_temp1=new Vec3;var ContactEquation_computeB_temp2=new Vec3;var ContactEquation_computeB_temp3=new Vec3;ContactEquation.prototype.computeB=function(h){var a=this.a,b=this.b,bi=this.bi,bj=this.bj,ri=this.ri,rj=this.rj,rixn=ContactEquation_computeB_temp1,rjxn=ContactEquation_computeB_temp2,vi=bi.velocity,wi=bi.angularVelocity,fi=bi.force,taui=bi.torque,vj=bj.velocity,wj=bj.angularVelocity,fj=bj.force,tauj=bj.torque,penetrationVec=ContactEquation_computeB_temp3,GA=this.jacobianElementA,GB=this.jacobianElementB,n=this.ni;ri.cross(n,rixn);rj.cross(n,rjxn);n.negate(GA.spatial);rixn.negate(GA.rotational);GB.spatial.copy(n);GB.rotational.copy(rjxn);penetrationVec.copy(bj.position);penetrationVec.vadd(rj,penetrationVec);penetrationVec.vsub(bi.position,penetrationVec);penetrationVec.vsub(ri,penetrationVec);var g=n.dot(penetrationVec);var ePlusOne=this.restitution+1;var GW=ePlusOne*vj.dot(n)-ePlusOne*vi.dot(n)+wj.dot(rjxn)-wi.dot(rixn);var GiMf=this.computeGiMf();var B=-g*a-GW*b-h*GiMf;return B};var ContactEquation_getImpactVelocityAlongNormal_vi=new Vec3;var ContactEquation_getImpactVelocityAlongNormal_vj=new Vec3;var ContactEquation_getImpactVelocityAlongNormal_xi=new Vec3;var ContactEquation_getImpactVelocityAlongNormal_xj=new Vec3;var ContactEquation_getImpactVelocityAlongNormal_relVel=new Vec3;ContactEquation.prototype.getImpactVelocityAlongNormal=function(){var vi=ContactEquation_getImpactVelocityAlongNormal_vi;var vj=ContactEquation_getImpactVelocityAlongNormal_vj;var xi=ContactEquation_getImpactVelocityAlongNormal_xi;var xj=ContactEquation_getImpactVelocityAlongNormal_xj;var relVel=ContactEquation_getImpactVelocityAlongNormal_relVel;this.bi.position.vadd(this.ri,xi);this.bj.position.vadd(this.rj,xj);this.bi.getVelocityAtWorldPoint(xi,vi);this.bj.getVelocityAtWorldPoint(xj,vj);vi.vsub(vj,relVel);return this.ni.dot(relVel)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(_dereq_,module,exports){module.exports=Equation;var JacobianElement=_dereq_("../math/JacobianElement"),Vec3=_dereq_("../math/Vec3");function Equation(bi,bj,minForce,maxForce){this.id=Equation.id++;this.minForce=typeof minForce==="undefined"?-1e6:minForce;this.maxForce=typeof maxForce==="undefined"?1e6:maxForce;this.bi=bi;this.bj=bj;this.a=0;this.b=0;this.eps=0;this.jacobianElementA=new JacobianElement;this.jacobianElementB=new JacobianElement;this.enabled=true;this.setSpookParams(1e7,4,1/60)}Equation.prototype.constructor=Equation;Equation.id=0;Equation.prototype.setSpookParams=function(stiffness,relaxation,timeStep){var d=relaxation,k=stiffness,h=timeStep;this.a=4/(h*(1+4*d));this.b=4*d/(1+4*d);this.eps=4/(h*h*k*(1+4*d))};Equation.prototype.computeB=function(a,b,h){var GW=this.computeGW(),Gq=this.computeGq(),GiMf=this.computeGiMf();return-Gq*a-GW*b-GiMf*h};Equation.prototype.computeGq=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,xi=bi.position,xj=bj.position;return GA.spatial.dot(xi)+GB.spatial.dot(xj)};var zero=new Vec3;Equation.prototype.computeGW=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,vi=bi.velocity,vj=bj.velocity,wi=bi.angularVelocity||zero,wj=bj.angularVelocity||zero;return GA.multiplyVectors(vi,wi)+GB.multiplyVectors(vj,wj)};Equation.prototype.computeGWlambda=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,vi=bi.vlambda,vj=bj.vlambda,wi=bi.wlambda||zero,wj=bj.wlambda||zero;return GA.multiplyVectors(vi,wi)+GB.multiplyVectors(vj,wj)};var iMfi=new Vec3,iMfj=new Vec3,invIi_vmult_taui=new Vec3,invIj_vmult_tauj=new Vec3;Equation.prototype.computeGiMf=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,fi=bi.force,ti=bi.torque,fj=bj.force,tj=bj.torque,invMassi=bi.invMassSolve,invMassj=bj.invMassSolve;if(bi.invInertiaWorldSolve){bi.invInertiaWorldSolve.vmult(ti,invIi_vmult_taui)}else{invIi_vmult_taui.set(0,0,0)}if(bj.invInertiaWorldSolve){bj.invInertiaWorldSolve.vmult(tj,invIj_vmult_tauj)}else{invIj_vmult_tauj.set(0,0,0)}fi.mult(invMassi,iMfi);fj.mult(invMassj,iMfj);return GA.multiplyVectors(iMfi,invIi_vmult_taui)+GB.multiplyVectors(iMfj,invIj_vmult_tauj)};var tmp=new Vec3;Equation.prototype.computeGiMGt=function(){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,invMassi=bi.invMassSolve,invMassj=bj.invMassSolve,invIi=bi.invInertiaWorldSolve,invIj=bj.invInertiaWorldSolve,result=invMassi+invMassj;if(invIi){invIi.vmult(GA.rotational,tmp);result+=tmp.dot(GA.rotational)}if(invIj){invIj.vmult(GB.rotational,tmp);result+=tmp.dot(GB.rotational)}return result};var addToWlambda_temp=new Vec3,addToWlambda_Gi=new Vec3,addToWlambda_Gj=new Vec3,addToWlambda_ri=new Vec3,addToWlambda_rj=new Vec3,addToWlambda_Mdiag=new Vec3;Equation.prototype.addToWlambda=function(deltalambda){var GA=this.jacobianElementA,GB=this.jacobianElementB,bi=this.bi,bj=this.bj,temp=addToWlambda_temp;GA.spatial.mult(bi.invMassSolve*deltalambda,temp);bi.vlambda.vadd(temp,bi.vlambda);GB.spatial.mult(bj.invMassSolve*deltalambda,temp);bj.vlambda.vadd(temp,bj.vlambda);if(bi.invInertiaWorldSolve){bi.invInertiaWorldSolve.vmult(GA.rotational,temp);temp.mult(deltalambda,temp);bi.wlambda.vadd(temp,bi.wlambda)}if(bj.invInertiaWorldSolve){bj.invInertiaWorldSolve.vmult(GB.rotational,temp);temp.mult(deltalambda,temp);bj.wlambda.vadd(temp,bj.wlambda)}};Equation.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(_dereq_,module,exports){module.exports=FrictionEquation;var Equation=_dereq_("./Equation");var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");function FrictionEquation(bodyA,bodyB,slipForce){Equation.call(this,bodyA,bodyB,-slipForce,slipForce);this.ri=new Vec3;this.rj=new Vec3;this.t=new Vec3}FrictionEquation.prototype=new Equation;FrictionEquation.prototype.constructor=FrictionEquation;var FrictionEquation_computeB_temp1=new Vec3;var FrictionEquation_computeB_temp2=new Vec3;FrictionEquation.prototype.computeB=function(h){var a=this.a,b=this.b,bi=this.bi,bj=this.bj,ri=this.ri,rj=this.rj,rixt=FrictionEquation_computeB_temp1,rjxt=FrictionEquation_computeB_temp2,t=this.t;ri.cross(t,rixt);rj.cross(t,rjxt);var GA=this.jacobianElementA,GB=this.jacobianElementB;t.negate(GA.spatial);rixt.negate(GA.rotational);GB.spatial.copy(t);GB.rotational.copy(rjxt);var GW=this.computeGW();var GiMf=this.computeGiMf();var B=-GW*b-h*GiMf;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(_dereq_,module,exports){module.exports=RotationalEquation;var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");var Equation=_dereq_("./Equation");function RotationalEquation(bodyA,bodyB,options){options=options||{};var maxForce=typeof options.maxForce!=="undefined"?options.maxForce:1e6;Equation.call(this,bodyA,bodyB,-maxForce,maxForce);this.axisA=options.axisA?options.axisA.clone():new Vec3(1,0,0);this.axisB=options.axisB?options.axisB.clone():new Vec3(0,1,0);this.maxAngle=Math.PI/2}RotationalEquation.prototype=new Equation;RotationalEquation.prototype.constructor=RotationalEquation;var tmpVec1=new Vec3;var tmpVec2=new Vec3;RotationalEquation.prototype.computeB=function(h){var a=this.a,b=this.b,ni=this.axisA,nj=this.axisB,nixnj=tmpVec1,njxni=tmpVec2,GA=this.jacobianElementA,GB=this.jacobianElementB;ni.cross(nj,nixnj);nj.cross(ni,njxni);GA.rotational.copy(njxni);GB.rotational.copy(nixnj);var g=Math.cos(this.maxAngle)-ni.dot(nj),GW=this.computeGW(),GiMf=this.computeGiMf();var B=-g*a-GW*b-h*GiMf;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(_dereq_,module,exports){module.exports=RotationalMotorEquation;var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");var Equation=_dereq_("./Equation");function RotationalMotorEquation(bodyA,bodyB,maxForce){maxForce=typeof maxForce!=="undefined"?maxForce:1e6;Equation.call(this,bodyA,bodyB,-maxForce,maxForce);this.axisA=new Vec3;this.axisB=new Vec3;this.targetVelocity=0}RotationalMotorEquation.prototype=new Equation;RotationalMotorEquation.prototype.constructor=RotationalMotorEquation;RotationalMotorEquation.prototype.computeB=function(h){var a=this.a,b=this.b,bi=this.bi,bj=this.bj,axisA=this.axisA,axisB=this.axisB,GA=this.jacobianElementA,GB=this.jacobianElementB;GA.rotational.copy(axisA);axisB.negate(GB.rotational);var GW=this.computeGW()-this.targetVelocity,GiMf=this.computeGiMf();var B=-GW*b-h*GiMf;return B}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(_dereq_,module,exports){var Utils=_dereq_("../utils/Utils");module.exports=ContactMaterial;function ContactMaterial(m1,m2,options){options=Utils.defaults(options,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.id=ContactMaterial.idCounter++;this.materials=[m1,m2];this.friction=options.friction;this.restitution=options.restitution;this.contactEquationStiffness=options.contactEquationStiffness;this.contactEquationRelaxation=options.contactEquationRelaxation;this.frictionEquationStiffness=options.frictionEquationStiffness;this.frictionEquationRelaxation=options.frictionEquationRelaxation}ContactMaterial.idCounter=0},{"../utils/Utils":53}],25:[function(_dereq_,module,exports){module.exports=Material;function Material(options){var name="";options=options||{};if(typeof options==="string"){name=options;options={}}else if(typeof options==="object"){name=""}this.name=name;this.id=Material.idCounter++;this.friction=typeof options.friction!=="undefined"?options.friction:-1;this.restitution=typeof options.restitution!=="undefined"?options.restitution:-1}Material.idCounter=0},{}],26:[function(_dereq_,module,exports){module.exports=JacobianElement;var Vec3=_dereq_("./Vec3");function JacobianElement(){this.spatial=new Vec3;this.rotational=new Vec3}JacobianElement.prototype.multiplyElement=function(element){return element.spatial.dot(this.spatial)+element.rotational.dot(this.rotational)};JacobianElement.prototype.multiplyVectors=function(spatial,rotational){return spatial.dot(this.spatial)+rotational.dot(this.rotational)}},{"./Vec3":30}],27:[function(_dereq_,module,exports){module.exports=Mat3;var Vec3=_dereq_("./Vec3");function Mat3(elements){if(elements){this.elements=elements}else{this.elements=[0,0,0,0,0,0,0,0,0]}}Mat3.prototype.identity=function(){var e=this.elements;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1};Mat3.prototype.setZero=function(){var e=this.elements;e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=0;e[6]=0;e[7]=0;e[8]=0};Mat3.prototype.setTrace=function(vec3){var e=this.elements;e[0]=vec3.x;e[4]=vec3.y;e[8]=vec3.z};Mat3.prototype.getTrace=function(target){var target=target||new Vec3;var e=this.elements;target.x=e[0];target.y=e[4];target.z=e[8]};Mat3.prototype.vmult=function(v,target){target=target||new Vec3;var e=this.elements,x=v.x,y=v.y,z=v.z;target.x=e[0]*x+e[1]*y+e[2]*z;target.y=e[3]*x+e[4]*y+e[5]*z;target.z=e[6]*x+e[7]*y+e[8]*z;return target};Mat3.prototype.smult=function(s){for(var i=0;i<this.elements.length;i++){this.elements[i]*=s}};Mat3.prototype.mmult=function(m,target){var r=target||new Mat3;for(var i=0;i<3;i++){for(var j=0;j<3;j++){var sum=0;for(var k=0;k<3;k++){sum+=m.elements[i+k*3]*this.elements[k+j*3]}r.elements[i+j*3]=sum}}return r};Mat3.prototype.scale=function(v,target){target=target||new Mat3;var e=this.elements,t=target.elements;for(var i=0;i!==3;i++){t[3*i+0]=v.x*e[3*i+0];t[3*i+1]=v.y*e[3*i+1];t[3*i+2]=v.z*e[3*i+2]}return target};Mat3.prototype.solve=function(b,target){target=target||new Vec3;var nr=3;var nc=4;var eqns=[];for(var i=0;i<nr*nc;i++){eqns.push(0)}var i,j;for(i=0;i<3;i++){for(j=0;j<3;j++){eqns[i+nc*j]=this.elements[i+3*j]}}eqns[3+4*0]=b.x;eqns[3+4*1]=b.y;eqns[3+4*2]=b.z;var n=3,k=n,np;var kp=4;var p,els;do{i=k-n;if(eqns[i+nc*i]===0){for(j=i+1;j<k;j++){if(eqns[i+nc*j]!==0){np=kp;do{p=kp-np;eqns[p+nc*i]+=eqns[p+nc*j]}while(--np);break}}}if(eqns[i+nc*i]!==0){for(j=i+1;j<k;j++){var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=kp;do{p=kp-np;eqns[p+nc*j]=p<=i?0:eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}}}while(--n);target.z=eqns[2*nc+3]/eqns[2*nc+2];target.y=(eqns[1*nc+3]-eqns[1*nc+2]*target.z)/eqns[1*nc+1];target.x=(eqns[0*nc+3]-eqns[0*nc+2]*target.z-eqns[0*nc+1]*target.y)/eqns[0*nc+0];if(isNaN(target.x)||isNaN(target.y)||isNaN(target.z)||target.x===Infinity||target.y===Infinity||target.z===Infinity){throw"Could not solve equation! Got x=["+target.toString()+"], b=["+b.toString()+"], A=["+this.toString()+"]"}return target};Mat3.prototype.e=function(row,column,value){if(value===undefined){return this.elements[column+3*row]}else{this.elements[column+3*row]=value}};Mat3.prototype.copy=function(source){for(var i=0;i<source.elements.length;i++){this.elements[i]=source.elements[i]}return this};Mat3.prototype.toString=function(){var r="";var sep=",";for(var i=0;i<9;i++){r+=this.elements[i]+sep}return r};Mat3.prototype.reverse=function(target){target=target||new Mat3;var nr=3;var nc=6;var eqns=[];for(var i=0;i<nr*nc;i++){eqns.push(0)}var i,j;for(i=0;i<3;i++){for(j=0;j<3;j++){eqns[i+nc*j]=this.elements[i+3*j]}}eqns[3+6*0]=1;eqns[3+6*1]=0;eqns[3+6*2]=0;eqns[4+6*0]=0;eqns[4+6*1]=1;eqns[4+6*2]=0;eqns[5+6*0]=0;eqns[5+6*1]=0;eqns[5+6*2]=1;var n=3,k=n,np;var kp=nc;var p;do{i=k-n;if(eqns[i+nc*i]===0){for(j=i+1;j<k;j++){if(eqns[i+nc*j]!==0){np=kp;do{p=kp-np;eqns[p+nc*i]+=eqns[p+nc*j]}while(--np);break}}}if(eqns[i+nc*i]!==0){for(j=i+1;j<k;j++){var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=kp;do{p=kp-np;eqns[p+nc*j]=p<=i?0:eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}}}while(--n);i=2;do{j=i-1;do{var multiplier=eqns[i+nc*j]/eqns[i+nc*i];np=nc;do{p=nc-np;eqns[p+nc*j]=eqns[p+nc*j]-eqns[p+nc*i]*multiplier}while(--np)}while(j--)}while(--i);i=2;do{var multiplier=1/eqns[i+nc*i];np=nc;do{p=nc-np;eqns[p+nc*i]=eqns[p+nc*i]*multiplier}while(--np)}while(i--);i=2;do{j=2;do{p=eqns[nr+j+nc*i];if(isNaN(p)||p===Infinity){throw"Could not reverse! A=["+this.toString()+"]"}target.e(i,j,p)}while(j--)}while(i--);return target};Mat3.prototype.setRotationFromQuaternion=function(q){var x=q.x,y=q.y,z=q.z,w=q.w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2,e=this.elements;e[3*0+0]=1-(yy+zz);e[3*0+1]=xy-wz;e[3*0+2]=xz+wy;e[3*1+0]=xy+wz;e[3*1+1]=1-(xx+zz);e[3*1+2]=yz-wx;e[3*2+0]=xz-wy;e[3*2+1]=yz+wx;e[3*2+2]=1-(xx+yy);return this};Mat3.prototype.transpose=function(target){target=target||new Mat3;var Mt=target.elements,M=this.elements;for(var i=0;i!==3;i++){for(var j=0;j!==3;j++){Mt[3*i+j]=M[3*j+i]}}return target}},{"./Vec3":30}],28:[function(_dereq_,module,exports){module.exports=Quaternion;var Vec3=_dereq_("./Vec3");function Quaternion(x,y,z,w){this.x=x!==undefined?x:0;this.y=y!==undefined?y:0;this.z=z!==undefined?z:0;this.w=w!==undefined?w:1}Quaternion.prototype.set=function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w};Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w};Quaternion.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]};Quaternion.prototype.setFromAxisAngle=function(axis,angle){var s=Math.sin(angle*.5);this.x=axis.x*s;this.y=axis.y*s;this.z=axis.z*s;this.w=Math.cos(angle*.5)};Quaternion.prototype.toAxisAngle=function(targetAxis){targetAxis=targetAxis||new Vec3;this.normalize();var angle=2*Math.acos(this.w);var s=Math.sqrt(1-this.w*this.w);if(s<.001){targetAxis.x=this.x;targetAxis.y=this.y;targetAxis.z=this.z}else{targetAxis.x=this.x/s;targetAxis.y=this.y/s;targetAxis.z=this.z/s}return[targetAxis,angle]};var sfv_t1=new Vec3,sfv_t2=new Vec3;Quaternion.prototype.setFromVectors=function(u,v){if(u.isAntiparallelTo(v)){var t1=sfv_t1;var t2=sfv_t2;u.tangents(t1,t2);this.setFromAxisAngle(t1,Math.PI)}else{var a=u.cross(v);this.x=a.x;this.y=a.y;this.z=a.z;this.w=Math.sqrt(Math.pow(u.norm(),2)*Math.pow(v.norm(),2))+u.dot(v);this.normalize()}};var Quaternion_mult_va=new Vec3;var Quaternion_mult_vb=new Vec3;var Quaternion_mult_vaxvb=new Vec3;Quaternion.prototype.mult=function(q,target){target=target||new Quaternion;var w=this.w,va=Quaternion_mult_va,vb=Quaternion_mult_vb,vaxvb=Quaternion_mult_vaxvb;va.set(this.x,this.y,this.z);vb.set(q.x,q.y,q.z);target.w=w*q.w-va.dot(vb);va.cross(vb,vaxvb);target.x=w*vb.x+q.w*va.x+vaxvb.x;target.y=w*vb.y+q.w*va.y+vaxvb.y;target.z=w*vb.z+q.w*va.z+vaxvb.z;return target};Quaternion.prototype.inverse=function(target){var x=this.x,y=this.y,z=this.z,w=this.w;target=target||new Quaternion;this.conjugate(target);var inorm2=1/(x*x+y*y+z*z+w*w);target.x*=inorm2;target.y*=inorm2;target.z*=inorm2;target.w*=inorm2;return target};Quaternion.prototype.conjugate=function(target){target=target||new Quaternion;target.x=-this.x;target.y=-this.y;target.z=-this.z;target.w=this.w;return target};Quaternion.prototype.normalize=function(){var l=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);if(l===0){this.x=0;this.y=0;this.z=0;this.w=0}else{l=1/l;this.x*=l;this.y*=l;this.z*=l;this.w*=l}};Quaternion.prototype.normalizeFast=function(){var f=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;if(f===0){this.x=0;this.y=0;this.z=0;this.w=0}else{this.x*=f;this.y*=f;this.z*=f;this.w*=f}};Quaternion.prototype.vmult=function(v,target){target=target||new Vec3;var x=v.x,y=v.y,z=v.z;var qx=this.x,qy=this.y,qz=this.z,qw=this.w;var ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;target.x=ix*qw+iw*-qx+iy*-qz-iz*-qy;target.y=iy*qw+iw*-qy+iz*-qx-ix*-qz;target.z=iz*qw+iw*-qz+ix*-qy-iy*-qx;return target};Quaternion.prototype.copy=function(source){this.x=source.x;this.y=source.y;this.z=source.z;this.w=source.w;return this};Quaternion.prototype.toEuler=function(target,order){order=order||"YZX";var heading,attitude,bank;var x=this.x,y=this.y,z=this.z,w=this.w;switch(order){case"YZX":var test=x*y+z*w;if(test>.499){heading=2*Math.atan2(x,w);attitude=Math.PI/2;bank=0}if(test<-.499){heading=-2*Math.atan2(x,w);attitude=-Math.PI/2;bank=0}if(isNaN(heading)){var sqx=x*x;var sqy=y*y;var sqz=z*z;heading=Math.atan2(2*y*w-2*x*z,1-2*sqy-2*sqz);attitude=Math.asin(2*test);bank=Math.atan2(2*x*w-2*y*z,1-2*sqx-2*sqz)}break;default:throw new Error("Euler order "+order+" not supported yet.")}target.y=heading;target.z=attitude;target.x=bank};Quaternion.prototype.setFromEuler=function(x,y,z,order){order=order||"XYZ";var c1=Math.cos(x/2);var c2=Math.cos(y/2);var c3=Math.cos(z/2);var s1=Math.sin(x/2);var s2=Math.sin(y/2);var s3=Math.sin(z/2);if(order==="XYZ"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="YXZ"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}else if(order==="ZXY"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="ZYX"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}else if(order==="YZX"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="XZY"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}return this};Quaternion.prototype.clone=function(){return new Quaternion(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(_dereq_,module,exports){var Vec3=_dereq_("./Vec3");var Quaternion=_dereq_("./Quaternion");module.exports=Transform;function Transform(options){options=options||{};this.position=new Vec3;if(options.position){this.position.copy(options.position)}this.quaternion=new Quaternion;if(options.quaternion){this.quaternion.copy(options.quaternion)}}var tmpQuat=new Quaternion;Transform.pointToLocalFrame=function(position,quaternion,worldPoint,result){var result=result||new Vec3;worldPoint.vsub(position,result);quaternion.conjugate(tmpQuat);tmpQuat.vmult(result,result);return result};Transform.prototype.pointToLocal=function(worldPoint,result){return Transform.pointToLocalFrame(this.position,this.quaternion,worldPoint,result)};Transform.pointToWorldFrame=function(position,quaternion,localPoint,result){var result=result||new Vec3;quaternion.vmult(localPoint,result);result.vadd(position,result);return result};Transform.prototype.pointToWorld=function(localPoint,result){return Transform.pointToWorldFrame(this.position,this.quaternion,localPoint,result)};Transform.prototype.vectorToWorldFrame=function(localVector,result){var result=result||new Vec3;this.quaternion.vmult(localVector,result);return result};Transform.vectorToWorldFrame=function(quaternion,localVector,result){quaternion.vmult(localVector,result);return result};Transform.vectorToLocalFrame=function(position,quaternion,worldVector,result){var result=result||new Vec3;quaternion.w*=-1;quaternion.vmult(worldVector,result);quaternion.w*=-1;return result}},{"./Quaternion":28,"./Vec3":30}],30:[function(_dereq_,module,exports){module.exports=Vec3;var Mat3=_dereq_("./Mat3");function Vec3(x,y,z){this.x=x||0;this.y=y||0;this.z=z||0}Vec3.ZERO=new Vec3(0,0,0);Vec3.UNIT_X=new Vec3(1,0,0);Vec3.UNIT_Y=new Vec3(0,1,0);Vec3.UNIT_Z=new Vec3(0,0,1);Vec3.prototype.cross=function(v,target){var vx=v.x,vy=v.y,vz=v.z,x=this.x,y=this.y,z=this.z;target=target||new Vec3;target.x=y*vz-z*vy;target.y=z*vx-x*vz;target.z=x*vy-y*vx;return target};Vec3.prototype.set=function(x,y,z){this.x=x;this.y=y;this.z=z;return this};Vec3.prototype.setZero=function(){this.x=this.y=this.z=0};Vec3.prototype.vadd=function(v,target){if(target){target.x=v.x+this.x;target.y=v.y+this.y;target.z=v.z+this.z}else{return new Vec3(this.x+v.x,this.y+v.y,this.z+v.z)}};Vec3.prototype.vsub=function(v,target){if(target){target.x=this.x-v.x;target.y=this.y-v.y;target.z=this.z-v.z}else{return new Vec3(this.x-v.x,this.y-v.y,this.z-v.z)}};Vec3.prototype.crossmat=function(){return new Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])};Vec3.prototype.normalize=function(){var x=this.x,y=this.y,z=this.z;var n=Math.sqrt(x*x+y*y+z*z);if(n>0){var invN=1/n;this.x*=invN;this.y*=invN;this.z*=invN}else{this.x=0;this.y=0;this.z=0}return n};Vec3.prototype.unit=function(target){target=target||new Vec3;var x=this.x,y=this.y,z=this.z;var ninv=Math.sqrt(x*x+y*y+z*z);if(ninv>0){ninv=1/ninv;target.x=x*ninv;target.y=y*ninv;target.z=z*ninv}else{target.x=1;target.y=0;target.z=0}return target};Vec3.prototype.norm=function(){var x=this.x,y=this.y,z=this.z;return Math.sqrt(x*x+y*y+z*z)};Vec3.prototype.length=Vec3.prototype.norm;Vec3.prototype.norm2=function(){return this.dot(this)};Vec3.prototype.lengthSquared=Vec3.prototype.norm2;Vec3.prototype.distanceTo=function(p){var x=this.x,y=this.y,z=this.z;var px=p.x,py=p.y,pz=p.z;return Math.sqrt((px-x)*(px-x)+(py-y)*(py-y)+(pz-z)*(pz-z))};Vec3.prototype.distanceSquared=function(p){var x=this.x,y=this.y,z=this.z;var px=p.x,py=p.y,pz=p.z;return(px-x)*(px-x)+(py-y)*(py-y)+(pz-z)*(pz-z)};Vec3.prototype.mult=function(scalar,target){target=target||new Vec3;var x=this.x,y=this.y,z=this.z;target.x=scalar*x;target.y=scalar*y;target.z=scalar*z;return target};Vec3.prototype.scale=Vec3.prototype.mult;Vec3.prototype.dot=function(v){return this.x*v.x+this.y*v.y+this.z*v.z};Vec3.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0};Vec3.prototype.negate=function(target){target=target||new Vec3;target.x=-this.x;target.y=-this.y;target.z=-this.z;return target};var Vec3_tangents_n=new Vec3;var Vec3_tangents_randVec=new Vec3;Vec3.prototype.tangents=function(t1,t2){var norm=this.norm();if(norm>0){var n=Vec3_tangents_n;var inorm=1/norm;n.set(this.x*inorm,this.y*inorm,this.z*inorm);var randVec=Vec3_tangents_randVec;if(Math.abs(n.x)<.9){randVec.set(1,0,0);n.cross(randVec,t1)}else{randVec.set(0,1,0);n.cross(randVec,t1)}n.cross(t1,t2)}else{t1.set(1,0,0);t2.set(0,1,0)}};Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z};Vec3.prototype.toArray=function(){return[this.x,this.y,this.z]};Vec3.prototype.copy=function(source){this.x=source.x;this.y=source.y;this.z=source.z;return this};Vec3.prototype.lerp=function(v,t,target){var x=this.x,y=this.y,z=this.z;target.x=x+(v.x-x)*t;target.y=y+(v.y-y)*t;target.z=z+(v.z-z)*t};Vec3.prototype.almostEquals=function(v,precision){if(precision===undefined){precision=1e-6}if(Math.abs(this.x-v.x)>precision||Math.abs(this.y-v.y)>precision||Math.abs(this.z-v.z)>precision){return false}return true};Vec3.prototype.almostZero=function(precision){if(precision===undefined){precision=1e-6}if(Math.abs(this.x)>precision||Math.abs(this.y)>precision||Math.abs(this.z)>precision){return false}return true};var antip_neg=new Vec3;Vec3.prototype.isAntiparallelTo=function(v,precision){this.negate(antip_neg);return antip_neg.almostEquals(v,precision)};Vec3.prototype.clone=function(){return new Vec3(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(_dereq_,module,exports){module.exports=Body;var EventTarget=_dereq_("../utils/EventTarget");var Shape=_dereq_("../shapes/Shape");var Vec3=_dereq_("../math/Vec3");var Mat3=_dereq_("../math/Mat3");var Quaternion=_dereq_("../math/Quaternion");var Material=_dereq_("../material/Material");var AABB=_dereq_("../collision/AABB");var Box=_dereq_("../shapes/Box");function Body(options){options=options||{};EventTarget.apply(this);this.id=Body.idCounter++;this.world=null;this.preStep=null;this.postStep=null;this.vlambda=new Vec3;this.collisionFilterGroup=typeof options.collisionFilterGroup==="number"?options.collisionFilterGroup:1;this.collisionFilterMask=typeof options.collisionFilterMask==="number"?options.collisionFilterMask:1;this.collisionResponse=true;this.position=new Vec3;if(options.position){this.position.copy(options.position)}this.previousPosition=new Vec3;this.initPosition=new Vec3;this.velocity=new Vec3;if(options.velocity){this.velocity.copy(options.velocity)}this.initVelocity=new Vec3;this.force=new Vec3;var mass=typeof options.mass==="number"?options.mass:0;this.mass=mass;this.invMass=mass>0?1/mass:0;this.material=options.material||null;this.linearDamping=typeof options.linearDamping==="number"?options.linearDamping:.01;this.type=mass<=0?Body.STATIC:Body.DYNAMIC;if(typeof options.type===typeof Body.STATIC){this.type=options.type}this.allowSleep=typeof options.allowSleep!=="undefined"?options.allowSleep:true;this.sleepState=0;this.sleepSpeedLimit=typeof options.sleepSpeedLimit!=="undefined"?options.sleepSpeedLimit:.1;this.sleepTimeLimit=typeof options.sleepTimeLimit!=="undefined"?options.sleepTimeLimit:1;this.timeLastSleepy=0;this._wakeUpAfterNarrowphase=false;this.torque=new Vec3;this.quaternion=new Quaternion;if(options.quaternion){this.quaternion.copy(options.quaternion)}this.initQuaternion=new Quaternion;this.angularVelocity=new Vec3;if(options.angularVelocity){this.angularVelocity.copy(options.angularVelocity)}this.initAngularVelocity=new Vec3;this.interpolatedPosition=new Vec3;this.interpolatedQuaternion=new Quaternion;this.shapes=[];this.shapeOffsets=[];this.shapeOrientations=[];this.inertia=new Vec3;this.invInertia=new Vec3;this.invInertiaWorld=new Mat3;this.invMassSolve=0;this.invInertiaSolve=new Vec3;this.invInertiaWorldSolve=new Mat3;this.fixedRotation=typeof options.fixedRotation!=="undefined"?options.fixedRotation:false;this.angularDamping=typeof options.angularDamping!=="undefined"?options.angularDamping:.01;this.aabb=new AABB;this.aabbNeedsUpdate=true;this.wlambda=new Vec3;if(options.shape){this.addShape(options.shape)}this.updateMassProperties()}Body.prototype=new EventTarget;Body.prototype.constructor=Body;Body.DYNAMIC=1;Body.STATIC=2;Body.KINEMATIC=4;Body.AWAKE=0;Body.SLEEPY=1;Body.SLEEPING=2;Body.idCounter=0;Body.prototype.wakeUp=function(){var s=this.sleepState;this.sleepState=0;if(s===Body.SLEEPING){this.dispatchEvent({type:"wakeup"})}};Body.prototype.sleep=function(){this.sleepState=Body.SLEEPING;this.velocity.set(0,0,0);this.angularVelocity.set(0,0,0)};Body.sleepyEvent={type:"sleepy"};Body.sleepEvent={type:"sleep"};Body.prototype.sleepTick=function(time){if(this.allowSleep){var sleepState=this.sleepState;var speedSquared=this.velocity.norm2()+this.angularVelocity.norm2();var speedLimitSquared=Math.pow(this.sleepSpeedLimit,2);if(sleepState===Body.AWAKE&&speedSquared<speedLimitSquared){this.sleepState=Body.SLEEPY;this.timeLastSleepy=time;this.dispatchEvent(Body.sleepyEvent)}else if(sleepState===Body.SLEEPY&&speedSquared>speedLimitSquared){this.wakeUp()}else if(sleepState===Body.SLEEPY&&time-this.timeLastSleepy>this.sleepTimeLimit){this.sleep();this.dispatchEvent(Body.sleepEvent)}}};Body.prototype.updateSolveMassProperties=function(){if(this.sleepState===Body.SLEEPING||this.type===Body.KINEMATIC){this.invMassSolve=0;this.invInertiaSolve.setZero();this.invInertiaWorldSolve.setZero()}else{this.invMassSolve=this.invMass;this.invInertiaSolve.copy(this.invInertia);this.invInertiaWorldSolve.copy(this.invInertiaWorld)}};Body.prototype.pointToLocalFrame=function(worldPoint,result){var result=result||new Vec3;worldPoint.vsub(this.position,result);this.quaternion.conjugate().vmult(result,result);return result};Body.prototype.vectorToLocalFrame=function(worldVector,result){var result=result||new Vec3;this.quaternion.conjugate().vmult(worldVector,result);return result};Body.prototype.pointToWorldFrame=function(localPoint,result){var result=result||new Vec3;this.quaternion.vmult(localPoint,result);result.vadd(this.position,result);return result};Body.prototype.vectorToWorldFrame=function(localVector,result){var result=result||new Vec3;this.quaternion.vmult(localVector,result);return result};var tmpVec=new Vec3;var tmpQuat=new Quaternion;Body.prototype.addShape=function(shape,_offset,_orientation){var offset=new Vec3;var orientation=new Quaternion;if(_offset){offset.copy(_offset)}if(_orientation){orientation.copy(_orientation)}this.shapes.push(shape);this.shapeOffsets.push(offset);this.shapeOrientations.push(orientation);this.updateMassProperties();this.updateBoundingRadius();this.aabbNeedsUpdate=true;return this};Body.prototype.updateBoundingRadius=function(){var shapes=this.shapes,shapeOffsets=this.shapeOffsets,N=shapes.length,radius=0;for(var i=0;i!==N;i++){var shape=shapes[i];shape.updateBoundingSphereRadius();var offset=shapeOffsets[i].norm(),r=shape.boundingSphereRadius;if(offset+r>radius){radius=offset+r}}this.boundingRadius=radius};var computeAABB_shapeAABB=new AABB;Body.prototype.computeAABB=function(){var shapes=this.shapes,shapeOffsets=this.shapeOffsets,shapeOrientations=this.shapeOrientations,N=shapes.length,offset=tmpVec,orientation=tmpQuat,bodyQuat=this.quaternion,aabb=this.aabb,shapeAABB=computeAABB_shapeAABB;for(var i=0;i!==N;i++){var shape=shapes[i];shapeOrientations[i].mult(bodyQuat,orientation);orientation.vmult(shapeOffsets[i],offset);offset.vadd(this.position,offset);shape.calculateWorldAABB(offset,orientation,shapeAABB.lowerBound,shapeAABB.upperBound);if(i===0){aabb.copy(shapeAABB)}else{aabb.extend(shapeAABB)}}this.aabbNeedsUpdate=false};var uiw_m1=new Mat3,uiw_m2=new Mat3,uiw_m3=new Mat3;Body.prototype.updateInertiaWorld=function(force){var I=this.invInertia;if(I.x===I.y&&I.y===I.z&&!force){}else{var m1=uiw_m1,m2=uiw_m2,m3=uiw_m3;m1.setRotationFromQuaternion(this.quaternion);m1.transpose(m2);m1.scale(I,m1);m1.mmult(m2,this.invInertiaWorld)}};var Body_applyForce_r=new Vec3;var Body_applyForce_rotForce=new Vec3;Body.prototype.applyForce=function(force,worldPoint){if(this.type!==Body.DYNAMIC){return}var r=Body_applyForce_r;worldPoint.vsub(this.position,r);var rotForce=Body_applyForce_rotForce;r.cross(force,rotForce);this.force.vadd(force,this.force);this.torque.vadd(rotForce,this.torque)};var Body_applyLocalForce_worldForce=new Vec3;var Body_applyLocalForce_worldPoint=new Vec3;Body.prototype.applyLocalForce=function(localForce,localPoint){if(this.type!==Body.DYNAMIC){return}var worldForce=Body_applyLocalForce_worldForce;var worldPoint=Body_applyLocalForce_worldPoint;this.vectorToWorldFrame(localForce,worldForce);this.pointToWorldFrame(localPoint,worldPoint);this.applyForce(worldForce,worldPoint)};var Body_applyImpulse_r=new Vec3;var Body_applyImpulse_velo=new Vec3;var Body_applyImpulse_rotVelo=new Vec3;Body.prototype.applyImpulse=function(impulse,worldPoint){if(this.type!==Body.DYNAMIC){return}var r=Body_applyImpulse_r;worldPoint.vsub(this.position,r);var velo=Body_applyImpulse_velo;velo.copy(impulse);velo.mult(this.invMass,velo);this.velocity.vadd(velo,this.velocity);var rotVelo=Body_applyImpulse_rotVelo;r.cross(impulse,rotVelo);this.invInertiaWorld.vmult(rotVelo,rotVelo);this.angularVelocity.vadd(rotVelo,this.angularVelocity)};var Body_applyLocalImpulse_worldImpulse=new Vec3;var Body_applyLocalImpulse_worldPoint=new Vec3;Body.prototype.applyLocalImpulse=function(localImpulse,localPoint){if(this.type!==Body.DYNAMIC){return}var worldImpulse=Body_applyLocalImpulse_worldImpulse;var worldPoint=Body_applyLocalImpulse_worldPoint;this.vectorToWorldFrame(localImpulse,worldImpulse);this.pointToWorldFrame(localPoint,worldPoint);this.applyImpulse(worldImpulse,worldPoint)};var Body_updateMassProperties_halfExtents=new Vec3;Body.prototype.updateMassProperties=function(){var halfExtents=Body_updateMassProperties_halfExtents;this.invMass=this.mass>0?1/this.mass:0;var I=this.inertia;var fixed=this.fixedRotation;this.computeAABB();halfExtents.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2);Box.calculateInertia(halfExtents,this.mass,I);this.invInertia.set(I.x>0&&!fixed?1/I.x:0,I.y>0&&!fixed?1/I.y:0,I.z>0&&!fixed?1/I.z:0);this.updateInertiaWorld(true)};Body.prototype.getVelocityAtWorldPoint=function(worldPoint,result){var r=new Vec3;worldPoint.vsub(this.position,r);this.angularVelocity.cross(r,result);this.velocity.vadd(result,result);return result}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(_dereq_,module,exports){var Body=_dereq_("./Body");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var RaycastResult=_dereq_("../collision/RaycastResult");var Ray=_dereq_("../collision/Ray");var WheelInfo=_dereq_("../objects/WheelInfo");module.exports=RaycastVehicle;function RaycastVehicle(options){this.chassisBody=options.chassisBody;this.wheelInfos=[];this.sliding=false;this.world=null;this.indexRightAxis=typeof options.indexRightAxis!=="undefined"?options.indexRightAxis:1;this.indexForwardAxis=typeof options.indexForwardAxis!=="undefined"?options.indexForwardAxis:0;this.indexUpAxis=typeof options.indexUpAxis!=="undefined"?options.indexUpAxis:2}var tmpVec1=new Vec3;var tmpVec2=new Vec3;var tmpVec3=new Vec3;var tmpVec4=new Vec3;var tmpVec5=new Vec3;var tmpVec6=new Vec3;var tmpRay=new Ray;RaycastVehicle.prototype.addWheel=function(options){options=options||{};var info=new WheelInfo(options);var index=this.wheelInfos.length;this.wheelInfos.push(info);return index};RaycastVehicle.prototype.setSteeringValue=function(value,wheelIndex){var wheel=this.wheelInfos[wheelIndex];wheel.steering=value};var torque=new Vec3;RaycastVehicle.prototype.applyEngineForce=function(value,wheelIndex){this.wheelInfos[wheelIndex].engineForce=value};RaycastVehicle.prototype.setBrake=function(brake,wheelIndex){this.wheelInfos[wheelIndex].brake=brake};RaycastVehicle.prototype.addToWorld=function(world){var constraints=this.constraints;world.add(this.chassisBody);var that=this;this.preStepCallback=function(){that.updateVehicle(world.dt)};world.addEventListener("preStep",this.preStepCallback);this.world=world};RaycastVehicle.prototype.getVehicleAxisWorld=function(axisIndex,result){result.set(axisIndex===0?1:0,axisIndex===1?1:0,axisIndex===2?1:0);this.chassisBody.vectorToWorldFrame(result,result)};RaycastVehicle.prototype.updateVehicle=function(timeStep){var wheelInfos=this.wheelInfos;var numWheels=wheelInfos.length;var chassisBody=this.chassisBody;for(var i=0;i<numWheels;i++){this.updateWheelTransform(i)}this.currentVehicleSpeedKmHour=3.6*chassisBody.velocity.norm();var forwardWorld=new Vec3;this.getVehicleAxisWorld(this.indexForwardAxis,forwardWorld);if(forwardWorld.dot(chassisBody.velocity)<0){this.currentVehicleSpeedKmHour*=-1}for(var i=0;i<numWheels;i++){this.castRay(wheelInfos[i])}this.updateSuspension(timeStep);var impulse=new Vec3;var relpos=new Vec3;for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var suspensionForce=wheel.suspensionForce;if(suspensionForce>wheel.maxSuspensionForce){suspensionForce=wheel.maxSuspensionForce}wheel.raycastResult.hitNormalWorld.scale(suspensionForce*timeStep,impulse);wheel.raycastResult.hitPointWorld.vsub(chassisBody.position,relpos);chassisBody.applyImpulse(impulse,wheel.raycastResult.hitPointWorld)}this.updateFriction(timeStep);var hitNormalWorldScaledWithProj=new Vec3;var fwd=new Vec3;var vel=new Vec3;for(i=0;i<numWheels;i++){var wheel=wheelInfos[i];chassisBody.getVelocityAtWorldPoint(wheel.chassisConnectionPointWorld,vel);var m=1;switch(this.indexUpAxis){case 1:m=-1;break}if(wheel.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,fwd);var proj=fwd.dot(wheel.raycastResult.hitNormalWorld);wheel.raycastResult.hitNormalWorld.scale(proj,hitNormalWorldScaledWithProj);fwd.vsub(hitNormalWorldScaledWithProj,fwd);var proj2=fwd.dot(vel);wheel.deltaRotation=m*proj2*timeStep/wheel.radius}if((wheel.sliding||!wheel.isInContact)&&wheel.engineForce!==0&&wheel.useCustomSlidingRotationalSpeed){wheel.deltaRotation=(wheel.engineForce>0?1:-1)*wheel.customSlidingRotationalSpeed*timeStep}if(Math.abs(wheel.brake)>Math.abs(wheel.engineForce)){wheel.deltaRotation=0}wheel.rotation+=wheel.deltaRotation;wheel.deltaRotation*=.99}};RaycastVehicle.prototype.updateSuspension=function(deltaTime){var chassisBody=this.chassisBody;var chassisMass=chassisBody.mass;var wheelInfos=this.wheelInfos;var numWheels=wheelInfos.length;for(var w_it=0;w_it<numWheels;w_it++){var wheel=wheelInfos[w_it];if(wheel.isInContact){var force;var susp_length=wheel.suspensionRestLength;var current_length=wheel.suspensionLength;var length_diff=susp_length-current_length;force=wheel.suspensionStiffness*length_diff*wheel.clippedInvContactDotSuspension;var projected_rel_vel=wheel.suspensionRelativeVelocity;var susp_damping;if(projected_rel_vel<0){susp_damping=wheel.dampingCompression}else{susp_damping=wheel.dampingRelaxation}force-=susp_damping*projected_rel_vel;wheel.suspensionForce=force*chassisMass;if(wheel.suspensionForce<0){wheel.suspensionForce=0}}else{wheel.suspensionForce=0}}};RaycastVehicle.prototype.removeFromWorld=function(world){var constraints=this.constraints;world.remove(this.chassisBody);world.removeEventListener("preStep",this.preStepCallback);this.world=null};var castRay_rayvector=new Vec3;var castRay_target=new Vec3;RaycastVehicle.prototype.castRay=function(wheel){var rayvector=castRay_rayvector;var target=castRay_target;this.updateWheelTransformWorld(wheel);var chassisBody=this.chassisBody;var depth=-1;var raylen=wheel.suspensionRestLength+wheel.radius;wheel.directionWorld.scale(raylen,rayvector);var source=wheel.chassisConnectionPointWorld;source.vadd(rayvector,target);var raycastResult=wheel.raycastResult;var param=0;raycastResult.reset();var oldState=chassisBody.collisionResponse;chassisBody.collisionResponse=false;this.world.rayTest(source,target,raycastResult);chassisBody.collisionResponse=oldState;var object=raycastResult.body;wheel.raycastResult.groundObject=0;if(object){depth=raycastResult.distance;wheel.raycastResult.hitNormalWorld=raycastResult.hitNormalWorld;wheel.isInContact=true;var hitDistance=raycastResult.distance;wheel.suspensionLength=hitDistance-wheel.radius;var minSuspensionLength=wheel.suspensionRestLength-wheel.maxSuspensionTravel;var maxSuspensionLength=wheel.suspensionRestLength+wheel.maxSuspensionTravel;if(wheel.suspensionLength<minSuspensionLength){wheel.suspensionLength=minSuspensionLength}if(wheel.suspensionLength>maxSuspensionLength){wheel.suspensionLength=maxSuspensionLength;wheel.raycastResult.reset()}var denominator=wheel.raycastResult.hitNormalWorld.dot(wheel.directionWorld);var chassis_velocity_at_contactPoint=new Vec3;chassisBody.getVelocityAtWorldPoint(wheel.raycastResult.hitPointWorld,chassis_velocity_at_contactPoint);var projVel=wheel.raycastResult.hitNormalWorld.dot(chassis_velocity_at_contactPoint);if(denominator>=-.1){wheel.suspensionRelativeVelocity=0;wheel.clippedInvContactDotSuspension=1/.1}else{var inv=-1/denominator;wheel.suspensionRelativeVelocity=projVel*inv;wheel.clippedInvContactDotSuspension=inv}}else{wheel.suspensionLength=wheel.suspensionRestLength+0*wheel.maxSuspensionTravel;wheel.suspensionRelativeVelocity=0;wheel.directionWorld.scale(-1,wheel.raycastResult.hitNormalWorld);wheel.clippedInvContactDotSuspension=1}return depth};RaycastVehicle.prototype.updateWheelTransformWorld=function(wheel){wheel.isInContact=false;var chassisBody=this.chassisBody;chassisBody.pointToWorldFrame(wheel.chassisConnectionPointLocal,wheel.chassisConnectionPointWorld);chassisBody.vectorToWorldFrame(wheel.directionLocal,wheel.directionWorld);chassisBody.vectorToWorldFrame(wheel.axleLocal,wheel.axleWorld)};RaycastVehicle.prototype.updateWheelTransform=function(wheelIndex){var up=tmpVec4;var right=tmpVec5;var fwd=tmpVec6;var wheel=this.wheelInfos[wheelIndex];this.updateWheelTransformWorld(wheel);wheel.directionLocal.scale(-1,up);right.copy(wheel.axleLocal);up.cross(right,fwd);fwd.normalize();right.normalize();var steering=wheel.steering;var steeringOrn=new Quaternion;steeringOrn.setFromAxisAngle(up,steering);var rotatingOrn=new Quaternion;rotatingOrn.setFromAxisAngle(right,wheel.rotation);var q=wheel.worldTransform.quaternion;this.chassisBody.quaternion.mult(steeringOrn,q);q.mult(rotatingOrn,q);q.normalize();var p=wheel.worldTransform.position;p.copy(wheel.directionWorld);p.scale(wheel.suspensionLength,p);p.vadd(wheel.chassisConnectionPointWorld,p)};var directions=[new Vec3(1,0,0),new Vec3(0,1,0),new Vec3(0,0,1)];RaycastVehicle.prototype.getWheelTransformWorld=function(wheelIndex){return this.wheelInfos[wheelIndex].worldTransform};var updateFriction_surfNormalWS_scaled_proj=new Vec3;var updateFriction_axle=[];var updateFriction_forwardWS=[];var sideFrictionStiffness2=1;RaycastVehicle.prototype.updateFriction=function(timeStep){var surfNormalWS_scaled_proj=updateFriction_surfNormalWS_scaled_proj;var wheelInfos=this.wheelInfos;var numWheels=wheelInfos.length;var chassisBody=this.chassisBody;var forwardWS=updateFriction_forwardWS;var axle=updateFriction_axle;var numWheelsOnGround=0;for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var groundObject=wheel.raycastResult.body;if(groundObject){numWheelsOnGround++}wheel.sideImpulse=0;wheel.forwardImpulse=0;if(!forwardWS[i]){forwardWS[i]=new Vec3}if(!axle[i]){axle[i]=new Vec3}}for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var groundObject=wheel.raycastResult.body;if(groundObject){var axlei=axle[i];var wheelTrans=this.getWheelTransformWorld(i);wheelTrans.vectorToWorldFrame(directions[this.indexRightAxis],axlei);var surfNormalWS=wheel.raycastResult.hitNormalWorld;var proj=axlei.dot(surfNormalWS);surfNormalWS.scale(proj,surfNormalWS_scaled_proj);axlei.vsub(surfNormalWS_scaled_proj,axlei);axlei.normalize();surfNormalWS.cross(axlei,forwardWS[i]);forwardWS[i].normalize();wheel.sideImpulse=resolveSingleBilateral(chassisBody,wheel.raycastResult.hitPointWorld,groundObject,wheel.raycastResult.hitPointWorld,axlei);wheel.sideImpulse*=sideFrictionStiffness2}}var sideFactor=1;var fwdFactor=.5;this.sliding=false;for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var groundObject=wheel.raycastResult.body;var rollingFriction=0;wheel.slipInfo=1;if(groundObject){var defaultRollingFrictionImpulse=0;var maxImpulse=wheel.brake?wheel.brake:defaultRollingFrictionImpulse;rollingFriction=calcRollingFriction(chassisBody,groundObject,wheel.raycastResult.hitPointWorld,forwardWS[i],maxImpulse);rollingFriction+=wheel.engineForce*timeStep;var factor=maxImpulse/rollingFriction;wheel.slipInfo*=factor}wheel.forwardImpulse=0;wheel.skidInfo=1;if(groundObject){wheel.skidInfo=1;var maximp=wheel.suspensionForce*timeStep*wheel.frictionSlip;var maximpSide=maximp;var maximpSquared=maximp*maximpSide;wheel.forwardImpulse=rollingFriction;var x=wheel.forwardImpulse*fwdFactor;var y=wheel.sideImpulse*sideFactor;var impulseSquared=x*x+y*y;wheel.sliding=false;if(impulseSquared>maximpSquared){this.sliding=true;wheel.sliding=true;var factor=maximp/Math.sqrt(impulseSquared);wheel.skidInfo*=factor}}}if(this.sliding){for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];if(wheel.sideImpulse!==0){if(wheel.skidInfo<1){wheel.forwardImpulse*=wheel.skidInfo;wheel.sideImpulse*=wheel.skidInfo}}}}for(var i=0;i<numWheels;i++){var wheel=wheelInfos[i];var rel_pos=new Vec3;rel_pos.copy(wheel.raycastResult.hitPointWorld);if(wheel.forwardImpulse!==0){var impulse=new Vec3;forwardWS[i].scale(wheel.forwardImpulse,impulse);chassisBody.applyImpulse(impulse,rel_pos)}if(wheel.sideImpulse!==0){var groundObject=wheel.raycastResult.body;var rel_pos2=new Vec3;rel_pos2.copy(wheel.raycastResult.hitPointWorld);var sideImp=new Vec3;axle[i].scale(wheel.sideImpulse,sideImp);chassisBody.pointToLocalFrame(rel_pos,rel_pos);rel_pos["xyz"[this.indexUpAxis]]*=wheel.rollInfluence;chassisBody.pointToWorldFrame(rel_pos,rel_pos);chassisBody.applyImpulse(sideImp,rel_pos);sideImp.scale(-1,sideImp);groundObject.applyImpulse(sideImp,rel_pos2)}}};var calcRollingFriction_vel1=new Vec3;var calcRollingFriction_vel2=new Vec3;var calcRollingFriction_vel=new Vec3;function calcRollingFriction(body0,body1,frictionPosWorld,frictionDirectionWorld,maxImpulse){var j1=0;var contactPosWorld=frictionPosWorld;var vel1=calcRollingFriction_vel1;var vel2=calcRollingFriction_vel2;var vel=calcRollingFriction_vel;body0.getVelocityAtWorldPoint(contactPosWorld,vel1);body1.getVelocityAtWorldPoint(contactPosWorld,vel2);vel1.vsub(vel2,vel);var vrel=frictionDirectionWorld.dot(vel);var denom0=computeImpulseDenominator(body0,frictionPosWorld,frictionDirectionWorld);var denom1=computeImpulseDenominator(body1,frictionPosWorld,frictionDirectionWorld);var relaxation=1;var jacDiagABInv=relaxation/(denom0+denom1);j1=-vrel*jacDiagABInv;if(maxImpulse<j1){j1=maxImpulse}if(j1<-maxImpulse){j1=-maxImpulse}return j1}var computeImpulseDenominator_r0=new Vec3;var computeImpulseDenominator_c0=new Vec3;var computeImpulseDenominator_vec=new Vec3;var computeImpulseDenominator_m=new Vec3;function computeImpulseDenominator(body,pos,normal){var r0=computeImpulseDenominator_r0;var c0=computeImpulseDenominator_c0;var vec=computeImpulseDenominator_vec;var m=computeImpulseDenominator_m;pos.vsub(body.position,r0);r0.cross(normal,c0);body.invInertiaWorld.vmult(c0,m);m.cross(r0,vec);return body.invMass+normal.dot(vec)}var resolveSingleBilateral_vel1=new Vec3;var resolveSingleBilateral_vel2=new Vec3;var resolveSingleBilateral_vel=new Vec3;function resolveSingleBilateral(body1,pos1,body2,pos2,normal,impulse){var normalLenSqr=normal.norm2();if(normalLenSqr>1.1){return 0}var vel1=resolveSingleBilateral_vel1;var vel2=resolveSingleBilateral_vel2;var vel=resolveSingleBilateral_vel;body1.getVelocityAtWorldPoint(pos1,vel1);body2.getVelocityAtWorldPoint(pos2,vel2);vel1.vsub(vel2,vel);var rel_vel=normal.dot(vel);var contactDamping=.2;var massTerm=1/(body1.invMass+body2.invMass);var impulse=-contactDamping*rel_vel*massTerm;return impulse}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(_dereq_,module,exports){var Body=_dereq_("./Body");var Sphere=_dereq_("../shapes/Sphere");var Box=_dereq_("../shapes/Box");var Vec3=_dereq_("../math/Vec3");var HingeConstraint=_dereq_("../constraints/HingeConstraint");module.exports=RigidVehicle;function RigidVehicle(options){this.wheelBodies=[];this.coordinateSystem=typeof options.coordinateSystem==="undefined"?new Vec3(1,2,3):options.coordinateSystem.clone();this.chassisBody=options.chassisBody;if(!this.chassisBody){var chassisShape=new Box(new Vec3(5,2,.5));this.chassisBody=new Body(1,chassisShape)}this.constraints=[];this.wheelAxes=[];this.wheelForces=[]}RigidVehicle.prototype.addWheel=function(options){options=options||{};var wheelBody=options.body;if(!wheelBody){wheelBody=new Body(1,new Sphere(1.2))}this.wheelBodies.push(wheelBody);this.wheelForces.push(0);var zero=new Vec3;var position=typeof options.position!=="undefined"?options.position.clone():new Vec3;var worldPosition=new Vec3;this.chassisBody.pointToWorldFrame(position,worldPosition);wheelBody.position.set(worldPosition.x,worldPosition.y,worldPosition.z);var axis=typeof options.axis!=="undefined"?options.axis.clone():new Vec3(0,1,0);this.wheelAxes.push(axis);var hingeConstraint=new HingeConstraint(this.chassisBody,wheelBody,{pivotA:position,axisA:axis,pivotB:Vec3.ZERO,axisB:axis,collideConnected:false});this.constraints.push(hingeConstraint);return this.wheelBodies.length-1};RigidVehicle.prototype.setSteeringValue=function(value,wheelIndex){var axis=this.wheelAxes[wheelIndex];var c=Math.cos(value),s=Math.sin(value),x=axis.x,y=axis.y;this.constraints[wheelIndex].axisA.set(c*x-s*y,s*x+c*y,0)};RigidVehicle.prototype.setMotorSpeed=function(value,wheelIndex){var hingeConstraint=this.constraints[wheelIndex];hingeConstraint.enableMotor();hingeConstraint.motorTargetVelocity=value};RigidVehicle.prototype.disableMotor=function(wheelIndex){var hingeConstraint=this.constraints[wheelIndex];hingeConstraint.disableMotor()};var torque=new Vec3;RigidVehicle.prototype.setWheelForce=function(value,wheelIndex){this.wheelForces[wheelIndex]=value};RigidVehicle.prototype.applyWheelForce=function(value,wheelIndex){var axis=this.wheelAxes[wheelIndex];var wheelBody=this.wheelBodies[wheelIndex];var bodyTorque=wheelBody.torque;axis.scale(value,torque);wheelBody.vectorToWorldFrame(torque,torque);bodyTorque.vadd(torque,bodyTorque)};RigidVehicle.prototype.addToWorld=function(world){var constraints=this.constraints;var bodies=this.wheelBodies.concat([this.chassisBody]);for(var i=0;i<bodies.length;i++){world.add(bodies[i])}for(var i=0;i<constraints.length;i++){world.addConstraint(constraints[i])}world.addEventListener("preStep",this._update.bind(this))};RigidVehicle.prototype._update=function(){var wheelForces=this.wheelForces;for(var i=0;i<wheelForces.length;i++){this.applyWheelForce(wheelForces[i],i)}};RigidVehicle.prototype.removeFromWorld=function(world){var constraints=this.constraints;var bodies=this.wheelBodies.concat([this.chassisBody]);for(var i=0;i<bodies.length;i++){world.remove(bodies[i])}for(var i=0;i<constraints.length;i++){world.removeConstraint(constraints[i])}};var worldAxis=new Vec3;RigidVehicle.prototype.getWheelSpeed=function(wheelIndex){var axis=this.wheelAxes[wheelIndex];var wheelBody=this.wheelBodies[wheelIndex];var w=wheelBody.angularVelocity;this.chassisBody.vectorToWorldFrame(axis,worldAxis);return w.dot(worldAxis)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(_dereq_,module,exports){module.exports=SPHSystem;var Shape=_dereq_("../shapes/Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Particle=_dereq_("../shapes/Particle");var Body=_dereq_("../objects/Body");var Material=_dereq_("../material/Material");function SPHSystem(){this.particles=[];this.density=1;this.smoothingRadius=1;this.speedOfSound=1;this.viscosity=.01;this.eps=1e-6;this.pressures=[];this.densities=[];this.neighbors=[]}SPHSystem.prototype.add=function(particle){this.particles.push(particle);if(this.neighbors.length<this.particles.length){this.neighbors.push([])}};SPHSystem.prototype.remove=function(particle){var idx=this.particles.indexOf(particle);if(idx!==-1){this.particles.splice(idx,1);if(this.neighbors.length>this.particles.length){this.neighbors.pop()}}};var SPHSystem_getNeighbors_dist=new Vec3;SPHSystem.prototype.getNeighbors=function(particle,neighbors){var N=this.particles.length,id=particle.id,R2=this.smoothingRadius*this.smoothingRadius,dist=SPHSystem_getNeighbors_dist;for(var i=0;i!==N;i++){var p=this.particles[i];p.position.vsub(particle.position,dist);if(id!==p.id&&dist.norm2()<R2){neighbors.push(p)}}};var SPHSystem_update_dist=new Vec3,SPHSystem_update_a_pressure=new Vec3,SPHSystem_update_a_visc=new Vec3,SPHSystem_update_gradW=new Vec3,SPHSystem_update_r_vec=new Vec3,SPHSystem_update_u=new Vec3;SPHSystem.prototype.update=function(){var N=this.particles.length,dist=SPHSystem_update_dist,cs=this.speedOfSound,eps=this.eps;for(var i=0;i!==N;i++){var p=this.particles[i];var neighbors=this.neighbors[i];neighbors.length=0;this.getNeighbors(p,neighbors);neighbors.push(this.particles[i]);var numNeighbors=neighbors.length;var sum=0;for(var j=0;j!==numNeighbors;j++){p.position.vsub(neighbors[j].position,dist);var len=dist.norm();var weight=this.w(len);sum+=neighbors[j].mass*weight}this.densities[i]=sum;this.pressures[i]=cs*cs*(this.densities[i]-this.density)}var a_pressure=SPHSystem_update_a_pressure;var a_visc=SPHSystem_update_a_visc;var gradW=SPHSystem_update_gradW;var r_vec=SPHSystem_update_r_vec;var u=SPHSystem_update_u;for(var i=0;i!==N;i++){var particle=this.particles[i];a_pressure.set(0,0,0);a_visc.set(0,0,0);var Pij;var nabla;var Vij;var neighbors=this.neighbors[i];var numNeighbors=neighbors.length;for(var j=0;j!==numNeighbors;j++){var neighbor=neighbors[j];particle.position.vsub(neighbor.position,r_vec);var r=r_vec.norm();Pij=-neighbor.mass*(this.pressures[i]/(this.densities[i]*this.densities[i]+eps)+this.pressures[j]/(this.densities[j]*this.densities[j]+eps));this.gradw(r_vec,gradW);gradW.mult(Pij,gradW);a_pressure.vadd(gradW,a_pressure);neighbor.velocity.vsub(particle.velocity,u);u.mult(1/(1e-4+this.densities[i]*this.densities[j])*this.viscosity*neighbor.mass,u);nabla=this.nablaw(r);u.mult(nabla,u);a_visc.vadd(u,a_visc)}a_visc.mult(particle.mass,a_visc);a_pressure.mult(particle.mass,a_pressure);particle.force.vadd(a_visc,particle.force);particle.force.vadd(a_pressure,particle.force)}};SPHSystem.prototype.w=function(r){var h=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(h,9))*Math.pow(h*h-r*r,3)};SPHSystem.prototype.gradw=function(rVec,resultVec){var r=rVec.norm(),h=this.smoothingRadius;rVec.mult(945/(32*Math.PI*Math.pow(h,9))*Math.pow(h*h-r*r,2),resultVec)};SPHSystem.prototype.nablaw=function(r){var h=this.smoothingRadius;var nabla=945/(32*Math.PI*Math.pow(h,9))*(h*h-r*r)*(7*r*r-3*h*h);return nabla}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(_dereq_,module,exports){var Vec3=_dereq_("../math/Vec3");module.exports=Spring;function Spring(bodyA,bodyB,options){options=options||{};this.restLength=typeof options.restLength==="number"?options.restLength:1;this.stiffness=options.stiffness||100;this.damping=options.damping||1;this.bodyA=bodyA;this.bodyB=bodyB;this.localAnchorA=new Vec3;this.localAnchorB=new Vec3;if(options.localAnchorA){this.localAnchorA.copy(options.localAnchorA)}if(options.localAnchorB){this.localAnchorB.copy(options.localAnchorB)}if(options.worldAnchorA){this.setWorldAnchorA(options.worldAnchorA)}if(options.worldAnchorB){this.setWorldAnchorB(options.worldAnchorB)}}Spring.prototype.setWorldAnchorA=function(worldAnchorA){this.bodyA.pointToLocalFrame(worldAnchorA,this.localAnchorA)};Spring.prototype.setWorldAnchorB=function(worldAnchorB){this.bodyB.pointToLocalFrame(worldAnchorB,this.localAnchorB)};Spring.prototype.getWorldAnchorA=function(result){this.bodyA.pointToWorldFrame(this.localAnchorA,result)};Spring.prototype.getWorldAnchorB=function(result){this.bodyB.pointToWorldFrame(this.localAnchorB,result)};var applyForce_r=new Vec3,applyForce_r_unit=new Vec3,applyForce_u=new Vec3,applyForce_f=new Vec3,applyForce_worldAnchorA=new Vec3,applyForce_worldAnchorB=new Vec3,applyForce_ri=new Vec3,applyForce_rj=new Vec3,applyForce_ri_x_f=new Vec3,applyForce_rj_x_f=new Vec3,applyForce_tmp=new Vec3;Spring.prototype.applyForce=function(){var k=this.stiffness,d=this.damping,l=this.restLength,bodyA=this.bodyA,bodyB=this.bodyB,r=applyForce_r,r_unit=applyForce_r_unit,u=applyForce_u,f=applyForce_f,tmp=applyForce_tmp;var worldAnchorA=applyForce_worldAnchorA,worldAnchorB=applyForce_worldAnchorB,ri=applyForce_ri,rj=applyForce_rj,ri_x_f=applyForce_ri_x_f,rj_x_f=applyForce_rj_x_f;this.getWorldAnchorA(worldAnchorA);this.getWorldAnchorB(worldAnchorB);worldAnchorA.vsub(bodyA.position,ri);worldAnchorB.vsub(bodyB.position,rj);worldAnchorB.vsub(worldAnchorA,r);var rlen=r.norm();r_unit.copy(r);r_unit.normalize();bodyB.velocity.vsub(bodyA.velocity,u);bodyB.angularVelocity.cross(rj,tmp);u.vadd(tmp,u);bodyA.angularVelocity.cross(ri,tmp);u.vsub(tmp,u);r_unit.mult(-k*(rlen-l)-d*u.dot(r_unit),f);bodyA.force.vsub(f,bodyA.force);bodyB.force.vadd(f,bodyB.force);ri.cross(f,ri_x_f);rj.cross(f,rj_x_f);bodyA.torque.vsub(ri_x_f,bodyA.torque);bodyB.torque.vadd(rj_x_f,bodyB.torque)}},{"../math/Vec3":30}],36:[function(_dereq_,module,exports){var Vec3=_dereq_("../math/Vec3");var Transform=_dereq_("../math/Transform");var RaycastResult=_dereq_("../collision/RaycastResult");var Utils=_dereq_("../utils/Utils");module.exports=WheelInfo;function WheelInfo(options){options=Utils.defaults(options,{chassisConnectionPointLocal:new Vec3,chassisConnectionPointWorld:new Vec3,directionLocal:new Vec3,directionWorld:new Vec3,axleLocal:new Vec3,axleWorld:new Vec3,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:true,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:false,customSlidingRotationalSpeed:-.1});this.maxSuspensionTravel=options.maxSuspensionTravel;this.customSlidingRotationalSpeed=options.customSlidingRotationalSpeed;this.useCustomSlidingRotationalSpeed=options.useCustomSlidingRotationalSpeed;this.sliding=false;this.chassisConnectionPointLocal=options.chassisConnectionPointLocal.clone();this.chassisConnectionPointWorld=options.chassisConnectionPointWorld.clone();this.directionLocal=options.directionLocal.clone();this.directionWorld=options.directionWorld.clone();this.axleLocal=options.axleLocal.clone();this.axleWorld=options.axleWorld.clone();this.suspensionRestLength=options.suspensionRestLength;this.suspensionMaxLength=options.suspensionMaxLength;this.radius=options.radius;this.suspensionStiffness=options.suspensionStiffness;this.dampingCompression=options.dampingCompression;this.dampingRelaxation=options.dampingRelaxation;this.frictionSlip=options.frictionSlip;this.steering=0;this.rotation=0;this.deltaRotation=0;this.rollInfluence=options.rollInfluence;this.maxSuspensionForce=options.maxSuspensionForce;this.engineForce=0;this.brake=0;this.isFrontWheel=options.isFrontWheel;this.clippedInvContactDotSuspension=1;this.suspensionRelativeVelocity=0;this.suspensionForce=0;this.skidInfo=0;this.suspensionLength=0;this.sideImpulse=0;this.forwardImpulse=0;this.raycastResult=new RaycastResult;this.worldTransform=new Transform;this.isInContact=false}var chassis_velocity_at_contactPoint=new Vec3;var relpos=new Vec3;var chassis_velocity_at_contactPoint=new Vec3;WheelInfo.prototype.updateWheel=function(chassis){var raycastResult=this.raycastResult;if(this.isInContact){var project=raycastResult.hitNormalWorld.dot(raycastResult.directionWorld);raycastResult.hitPointWorld.vsub(chassis.position,relpos);chassis.getVelocityAtWorldPoint(relpos,chassis_velocity_at_contactPoint);var projVel=raycastResult.hitNormalWorld.dot(chassis_velocity_at_contactPoint);if(project>=-.1){this.suspensionRelativeVelocity=0;this.clippedInvContactDotSuspension=1/.1}else{var inv=-1/project;this.suspensionRelativeVelocity=projVel*inv;this.clippedInvContactDotSuspension=inv}}else{raycastResult.suspensionLength=this.suspensionRestLength;this.suspensionRelativeVelocity=0;raycastResult.directionWorld.scale(-1,raycastResult.hitNormalWorld);this.clippedInvContactDotSuspension=1}}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(_dereq_,module,exports){module.exports=Box;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var ConvexPolyhedron=_dereq_("./ConvexPolyhedron");function Box(halfExtents){Shape.call(this);this.type=Shape.types.BOX;this.halfExtents=halfExtents;this.convexPolyhedronRepresentation=null;this.updateConvexPolyhedronRepresentation();this.updateBoundingSphereRadius()}Box.prototype=new Shape;Box.prototype.constructor=Box;Box.prototype.updateConvexPolyhedronRepresentation=function(){var sx=this.halfExtents.x;var sy=this.halfExtents.y;var sz=this.halfExtents.z;var V=Vec3;var vertices=[new V(-sx,-sy,-sz),new V(sx,-sy,-sz),new V(sx,sy,-sz),new V(-sx,sy,-sz),new V(-sx,-sy,sz),new V(sx,-sy,sz),new V(sx,sy,sz),new V(-sx,sy,sz)];var indices=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];var axes=[new V(0,0,1),new V(0,1,0),new V(1,0,0)];var h=new ConvexPolyhedron(vertices,indices);this.convexPolyhedronRepresentation=h;h.material=this.material};Box.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;Box.calculateInertia(this.halfExtents,mass,target);return target};Box.calculateInertia=function(halfExtents,mass,target){var e=halfExtents;target.x=1/12*mass*(2*e.y*2*e.y+2*e.z*2*e.z);target.y=1/12*mass*(2*e.x*2*e.x+2*e.z*2*e.z);target.z=1/12*mass*(2*e.y*2*e.y+2*e.x*2*e.x)};Box.prototype.getSideNormals=function(sixTargetVectors,quat){var sides=sixTargetVectors;var ex=this.halfExtents;sides[0].set(ex.x,0,0);sides[1].set(0,ex.y,0);sides[2].set(0,0,ex.z);sides[3].set(-ex.x,0,0);sides[4].set(0,-ex.y,0);sides[5].set(0,0,-ex.z);if(quat!==undefined){for(var i=0;i!==sides.length;i++){quat.vmult(sides[i],sides[i])}}return sides};Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z};Box.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var worldCornerTempPos=new Vec3;var worldCornerTempNeg=new Vec3;Box.prototype.forEachWorldCorner=function(pos,quat,callback){var e=this.halfExtents;var corners=[[e.x,e.y,e.z],[-e.x,e.y,e.z],[-e.x,-e.y,e.z],[-e.x,-e.y,-e.z],[e.x,-e.y,-e.z],[e.x,e.y,-e.z],[-e.x,e.y,-e.z],[e.x,-e.y,e.z]];for(var i=0;i<corners.length;i++){worldCornerTempPos.set(corners[i][0],corners[i][1],corners[i][2]);quat.vmult(worldCornerTempPos,worldCornerTempPos);pos.vadd(worldCornerTempPos,worldCornerTempPos);callback(worldCornerTempPos.x,worldCornerTempPos.y,worldCornerTempPos.z)}};var worldCornersTemp=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];Box.prototype.calculateWorldAABB=function(pos,quat,min,max){var e=this.halfExtents;worldCornersTemp[0].set(e.x,e.y,e.z);worldCornersTemp[1].set(-e.x,e.y,e.z);worldCornersTemp[2].set(-e.x,-e.y,e.z);worldCornersTemp[3].set(-e.x,-e.y,-e.z);worldCornersTemp[4].set(e.x,-e.y,-e.z);worldCornersTemp[5].set(e.x,e.y,-e.z);worldCornersTemp[6].set(-e.x,e.y,-e.z);worldCornersTemp[7].set(e.x,-e.y,e.z);var wc=worldCornersTemp[0];quat.vmult(wc,wc);pos.vadd(wc,wc);max.copy(wc);min.copy(wc);for(var i=1;i<8;i++){var wc=worldCornersTemp[i];quat.vmult(wc,wc);pos.vadd(wc,wc);var x=wc.x;var y=wc.y;var z=wc.z;if(x>max.x){max.x=x}if(y>max.y){max.y=y}if(z>max.z){max.z=z}if(x<min.x){min.x=x}if(y<min.y){min.y=y}if(z<min.z){min.z=z}}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(_dereq_,module,exports){module.exports=ConvexPolyhedron;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Transform=_dereq_("../math/Transform");function ConvexPolyhedron(points,faces,uniqueAxes){var that=this;Shape.call(this);this.type=Shape.types.CONVEXPOLYHEDRON;this.vertices=points||[];this.worldVertices=[];this.worldVerticesNeedsUpdate=true;this.faces=faces||[];this.faceNormals=[];this.computeNormals();this.worldFaceNormalsNeedsUpdate=true;this.worldFaceNormals=[];this.uniqueEdges=[];this.uniqueAxes=uniqueAxes?uniqueAxes.slice():null;this.computeEdges();this.updateBoundingSphereRadius()}ConvexPolyhedron.prototype=new Shape;ConvexPolyhedron.prototype.constructor=ConvexPolyhedron;var computeEdges_tmpEdge=new Vec3;ConvexPolyhedron.prototype.computeEdges=function(){var faces=this.faces;var vertices=this.vertices;var nv=vertices.length;var edges=this.uniqueEdges;edges.length=0;var edge=computeEdges_tmpEdge;for(var i=0;i!==faces.length;i++){var face=faces[i];var numVertices=face.length;for(var j=0;j!==numVertices;j++){var k=(j+1)%numVertices;vertices[face[j]].vsub(vertices[face[k]],edge);edge.normalize();var found=false;for(var p=0;p!==edges.length;p++){if(edges[p].almostEquals(edge)||edges[p].almostEquals(edge)){found=true;break}}if(!found){edges.push(edge.clone())}}}};ConvexPolyhedron.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var i=0;i<this.faces.length;i++){for(var j=0;j<this.faces[i].length;j++){if(!this.vertices[this.faces[i][j]]){throw new Error("Vertex "+this.faces[i][j]+" not found!")}}var n=this.faceNormals[i]||new Vec3;this.getFaceNormal(i,n);n.negate(n);this.faceNormals[i]=n;var vertex=this.vertices[this.faces[i][0]];if(n.dot(vertex)<0){console.error(".faceNormals["+i+"] = Vec3("+n.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var j=0;j<this.faces[i].length;j++){console.warn(".vertices["+this.faces[i][j]+"] = Vec3("+this.vertices[this.faces[i][j]].toString()+")")}}}};var cb=new Vec3;var ab=new Vec3;ConvexPolyhedron.computeNormal=function(va,vb,vc,target){vb.vsub(va,ab);vc.vsub(vb,cb);cb.cross(ab,target);if(!target.isZero()){target.normalize()}};ConvexPolyhedron.prototype.getFaceNormal=function(i,target){var f=this.faces[i];var va=this.vertices[f[0]];var vb=this.vertices[f[1]];var vc=this.vertices[f[2]];return ConvexPolyhedron.computeNormal(va,vb,vc,target)};var cah_WorldNormal=new Vec3;ConvexPolyhedron.prototype.clipAgainstHull=function(posA,quatA,hullB,posB,quatB,separatingNormal,minDist,maxDist,result){var WorldNormal=cah_WorldNormal;var hullA=this;var curMaxDist=maxDist;var closestFaceB=-1;var dmax=-Number.MAX_VALUE;for(var face=0;face<hullB.faces.length;face++){WorldNormal.copy(hullB.faceNormals[face]);quatB.vmult(WorldNormal,WorldNormal);var d=WorldNormal.dot(separatingNormal);if(d>dmax){dmax=d;closestFaceB=face}}var worldVertsB1=[];var polyB=hullB.faces[closestFaceB];var numVertices=polyB.length;for(var e0=0;e0<numVertices;e0++){var b=hullB.vertices[polyB[e0]];var worldb=new Vec3;worldb.copy(b);quatB.vmult(worldb,worldb);posB.vadd(worldb,worldb);worldVertsB1.push(worldb)}if(closestFaceB>=0){this.clipFaceAgainstHull(separatingNormal,posA,quatA,worldVertsB1,minDist,maxDist,result)}};var fsa_faceANormalWS3=new Vec3,fsa_Worldnormal1=new Vec3,fsa_deltaC=new Vec3,fsa_worldEdge0=new Vec3,fsa_worldEdge1=new Vec3,fsa_Cross=new Vec3;ConvexPolyhedron.prototype.findSeparatingAxis=function(hullB,posA,quatA,posB,quatB,target,faceListA,faceListB){var faceANormalWS3=fsa_faceANormalWS3,Worldnormal1=fsa_Worldnormal1,deltaC=fsa_deltaC,worldEdge0=fsa_worldEdge0,worldEdge1=fsa_worldEdge1,Cross=fsa_Cross;var dmin=Number.MAX_VALUE;var hullA=this;var curPlaneTests=0;if(!hullA.uniqueAxes){var numFacesA=faceListA?faceListA.length:hullA.faces.length;for(var i=0;i<numFacesA;i++){var fi=faceListA?faceListA[i]:i;faceANormalWS3.copy(hullA.faceNormals[fi]);quatA.vmult(faceANormalWS3,faceANormalWS3);var d=hullA.testSepAxis(faceANormalWS3,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;target.copy(faceANormalWS3)}}}else{for(var i=0;i!==hullA.uniqueAxes.length;i++){quatA.vmult(hullA.uniqueAxes[i],faceANormalWS3);var d=hullA.testSepAxis(faceANormalWS3,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;target.copy(faceANormalWS3)}}}if(!hullB.uniqueAxes){var numFacesB=faceListB?faceListB.length:hullB.faces.length;for(var i=0;i<numFacesB;i++){var fi=faceListB?faceListB[i]:i;Worldnormal1.copy(hullB.faceNormals[fi]);quatB.vmult(Worldnormal1,Worldnormal1);curPlaneTests++;var d=hullA.testSepAxis(Worldnormal1,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;target.copy(Worldnormal1)}}}else{for(var i=0;i!==hullB.uniqueAxes.length;i++){quatB.vmult(hullB.uniqueAxes[i],Worldnormal1);curPlaneTests++;var d=hullA.testSepAxis(Worldnormal1,hullB,posA,quatA,posB,quatB);if(d===false){return false}if(d<dmin){dmin=d;target.copy(Worldnormal1)}}}for(var e0=0;e0!==hullA.uniqueEdges.length;e0++){quatA.vmult(hullA.uniqueEdges[e0],worldEdge0);for(var e1=0;e1!==hullB.uniqueEdges.length;e1++){quatB.vmult(hullB.uniqueEdges[e1],worldEdge1);worldEdge0.cross(worldEdge1,Cross);if(!Cross.almostZero()){Cross.normalize();var dist=hullA.testSepAxis(Cross,hullB,posA,quatA,posB,quatB);if(dist===false){return false}if(dist<dmin){dmin=dist;target.copy(Cross)}}}}posB.vsub(posA,deltaC);if(deltaC.dot(target)>0){target.negate(target)}return true};var maxminA=[],maxminB=[];ConvexPolyhedron.prototype.testSepAxis=function(axis,hullB,posA,quatA,posB,quatB){var hullA=this;ConvexPolyhedron.project(hullA,axis,posA,quatA,maxminA);ConvexPolyhedron.project(hullB,axis,posB,quatB,maxminB);var maxA=maxminA[0];var minA=maxminA[1];var maxB=maxminB[0];var minB=maxminB[1];if(maxA<minB||maxB<minA){return false}var d0=maxA-minB;var d1=maxB-minA;var depth=d0<d1?d0:d1;return depth};var cli_aabbmin=new Vec3,cli_aabbmax=new Vec3;ConvexPolyhedron.prototype.calculateLocalInertia=function(mass,target){this.computeLocalAABB(cli_aabbmin,cli_aabbmax);var x=cli_aabbmax.x-cli_aabbmin.x,y=cli_aabbmax.y-cli_aabbmin.y,z=cli_aabbmax.z-cli_aabbmin.z;target.x=1/12*mass*(2*y*2*y+2*z*2*z);target.y=1/12*mass*(2*x*2*x+2*z*2*z);target.z=1/12*mass*(2*y*2*y+2*x*2*x)};ConvexPolyhedron.prototype.getPlaneConstantOfFace=function(face_i){var f=this.faces[face_i];var n=this.faceNormals[face_i];var v=this.vertices[f[0]];var c=-n.dot(v);return c};var cfah_faceANormalWS=new Vec3,cfah_edge0=new Vec3,cfah_WorldEdge0=new Vec3,cfah_worldPlaneAnormal1=new Vec3,cfah_planeNormalWS1=new Vec3,cfah_worldA1=new Vec3,cfah_localPlaneNormal=new Vec3,cfah_planeNormalWS=new Vec3;ConvexPolyhedron.prototype.clipFaceAgainstHull=function(separatingNormal,posA,quatA,worldVertsB1,minDist,maxDist,result){var faceANormalWS=cfah_faceANormalWS,edge0=cfah_edge0,WorldEdge0=cfah_WorldEdge0,worldPlaneAnormal1=cfah_worldPlaneAnormal1,planeNormalWS1=cfah_planeNormalWS1,worldA1=cfah_worldA1,localPlaneNormal=cfah_localPlaneNormal,planeNormalWS=cfah_planeNormalWS;var hullA=this;var worldVertsB2=[];var pVtxIn=worldVertsB1;var pVtxOut=worldVertsB2;var closestFaceA=-1;var dmin=Number.MAX_VALUE;for(var face=0;face<hullA.faces.length;face++){faceANormalWS.copy(hullA.faceNormals[face]);quatA.vmult(faceANormalWS,faceANormalWS);var d=faceANormalWS.dot(separatingNormal);if(d<dmin){dmin=d;closestFaceA=face}}if(closestFaceA<0){return}var polyA=hullA.faces[closestFaceA];polyA.connectedFaces=[];for(var i=0;i<hullA.faces.length;i++){for(var j=0;j<hullA.faces[i].length;j++){if(polyA.indexOf(hullA.faces[i][j])!==-1&&i!==closestFaceA&&polyA.connectedFaces.indexOf(i)===-1){polyA.connectedFaces.push(i)}}}var numContacts=pVtxIn.length;var numVerticesA=polyA.length;var res=[];for(var e0=0;e0<numVerticesA;e0++){var a=hullA.vertices[polyA[e0]];var b=hullA.vertices[polyA[(e0+1)%numVerticesA]];a.vsub(b,edge0);WorldEdge0.copy(edge0);quatA.vmult(WorldEdge0,WorldEdge0);posA.vadd(WorldEdge0,WorldEdge0);worldPlaneAnormal1.copy(this.faceNormals[closestFaceA]);quatA.vmult(worldPlaneAnormal1,worldPlaneAnormal1);posA.vadd(worldPlaneAnormal1,worldPlaneAnormal1);WorldEdge0.cross(worldPlaneAnormal1,planeNormalWS1);planeNormalWS1.negate(planeNormalWS1);worldA1.copy(a);quatA.vmult(worldA1,worldA1);posA.vadd(worldA1,worldA1);var planeEqWS1=-worldA1.dot(planeNormalWS1);var planeEqWS;if(true){var otherFace=polyA.connectedFaces[e0];localPlaneNormal.copy(this.faceNormals[otherFace]);var localPlaneEq=this.getPlaneConstantOfFace(otherFace);planeNormalWS.copy(localPlaneNormal);quatA.vmult(planeNormalWS,planeNormalWS);var planeEqWS=localPlaneEq-planeNormalWS.dot(posA)}else{planeNormalWS.copy(planeNormalWS1);planeEqWS=planeEqWS1}this.clipFaceAgainstPlane(pVtxIn,pVtxOut,planeNormalWS,planeEqWS);while(pVtxIn.length){pVtxIn.shift()}while(pVtxOut.length){pVtxIn.push(pVtxOut.shift())}}localPlaneNormal.copy(this.faceNormals[closestFaceA]);var localPlaneEq=this.getPlaneConstantOfFace(closestFaceA);planeNormalWS.copy(localPlaneNormal);quatA.vmult(planeNormalWS,planeNormalWS);var planeEqWS=localPlaneEq-planeNormalWS.dot(posA);for(var i=0;i<pVtxIn.length;i++){var depth=planeNormalWS.dot(pVtxIn[i])+planeEqWS;if(depth<=minDist){console.log("clamped: depth="+depth+" to minDist="+(minDist+""));depth=minDist}if(depth<=maxDist){var point=pVtxIn[i];if(depth<=0){var p={point:point,normal:planeNormalWS,depth:depth};result.push(p)}}}};ConvexPolyhedron.prototype.clipFaceAgainstPlane=function(inVertices,outVertices,planeNormal,planeConstant){var n_dot_first,n_dot_last;var numVerts=inVertices.length;if(numVerts<2){return outVertices}var firstVertex=inVertices[inVertices.length-1],lastVertex=inVertices[0];n_dot_first=planeNormal.dot(firstVertex)+planeConstant;for(var vi=0;vi<numVerts;vi++){lastVertex=inVertices[vi];n_dot_last=planeNormal.dot(lastVertex)+planeConstant;if(n_dot_first<0){if(n_dot_last<0){var newv=new Vec3;newv.copy(lastVertex);outVertices.push(newv)}else{var newv=new Vec3;firstVertex.lerp(lastVertex,n_dot_first/(n_dot_first-n_dot_last),newv);outVertices.push(newv)}}else{if(n_dot_last<0){var newv=new Vec3;firstVertex.lerp(lastVertex,n_dot_first/(n_dot_first-n_dot_last),newv);outVertices.push(newv);outVertices.push(lastVertex)}}firstVertex=lastVertex;n_dot_first=n_dot_last}return outVertices};ConvexPolyhedron.prototype.computeWorldVertices=function(position,quat){var N=this.vertices.length;while(this.worldVertices.length<N){this.worldVertices.push(new Vec3)}var verts=this.vertices,worldVerts=this.worldVertices;for(var i=0;i!==N;i++){quat.vmult(verts[i],worldVerts[i]);position.vadd(worldVerts[i],worldVerts[i])}this.worldVerticesNeedsUpdate=false};var computeLocalAABB_worldVert=new Vec3;ConvexPolyhedron.prototype.computeLocalAABB=function(aabbmin,aabbmax){var n=this.vertices.length,vertices=this.vertices,worldVert=computeLocalAABB_worldVert;aabbmin.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);aabbmax.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<n;i++){var v=vertices[i];if(v.x<aabbmin.x){aabbmin.x=v.x}else if(v.x>aabbmax.x){aabbmax.x=v.x}if(v.y<aabbmin.y){aabbmin.y=v.y}else if(v.y>aabbmax.y){aabbmax.y=v.y}if(v.z<aabbmin.z){aabbmin.z=v.z}else if(v.z>aabbmax.z){aabbmax.z=v.z}}};ConvexPolyhedron.prototype.computeWorldFaceNormals=function(quat){var N=this.faceNormals.length;while(this.worldFaceNormals.length<N){this.worldFaceNormals.push(new Vec3)}var normals=this.faceNormals,worldNormals=this.worldFaceNormals;for(var i=0;i!==N;i++){quat.vmult(normals[i],worldNormals[i])}this.worldFaceNormalsNeedsUpdate=false};ConvexPolyhedron.prototype.updateBoundingSphereRadius=function(){var max2=0;var verts=this.vertices;for(var i=0,N=verts.length;i!==N;i++){var norm2=verts[i].norm2();if(norm2>max2){max2=norm2}}this.boundingSphereRadius=Math.sqrt(max2)};var tempWorldVertex=new Vec3;ConvexPolyhedron.prototype.calculateWorldAABB=function(pos,quat,min,max){var n=this.vertices.length,verts=this.vertices;var minx,miny,minz,maxx,maxy,maxz;for(var i=0;i<n;i++){tempWorldVertex.copy(verts[i]);quat.vmult(tempWorldVertex,tempWorldVertex);pos.vadd(tempWorldVertex,tempWorldVertex);var v=tempWorldVertex;if(v.x<minx||minx===undefined){minx=v.x}else if(v.x>maxx||maxx===undefined){maxx=v.x}if(v.y<miny||miny===undefined){miny=v.y}else if(v.y>maxy||maxy===undefined){maxy=v.y}if(v.z<minz||minz===undefined){minz=v.z}else if(v.z>maxz||maxz===undefined){maxz=v.z}}min.set(minx,miny,minz);max.set(maxx,maxy,maxz)};ConvexPolyhedron.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};ConvexPolyhedron.prototype.getAveragePointLocal=function(target){target=target||new Vec3;var n=this.vertices.length,verts=this.vertices;for(var i=0;i<n;i++){target.vadd(verts[i],target)}target.mult(1/n,target);return target};ConvexPolyhedron.prototype.transformAllPoints=function(offset,quat){var n=this.vertices.length,verts=this.vertices;if(quat){for(var i=0;i<n;i++){var v=verts[i];quat.vmult(v,v)}for(var i=0;i<this.faceNormals.length;i++){var v=this.faceNormals[i];quat.vmult(v,v)}}if(offset){for(var i=0;i<n;i++){var v=verts[i];v.vadd(offset,v)}}};var ConvexPolyhedron_pointIsInside=new Vec3;var ConvexPolyhedron_vToP=new Vec3;var ConvexPolyhedron_vToPointInside=new Vec3;ConvexPolyhedron.prototype.pointIsInside=function(p){var n=this.vertices.length,verts=this.vertices,faces=this.faces,normals=this.faceNormals;var positiveResult=null;var N=this.faces.length;var pointInside=ConvexPolyhedron_pointIsInside;this.getAveragePointLocal(pointInside);for(var i=0;i<N;i++){var numVertices=this.faces[i].length;var n=normals[i];var v=verts[faces[i][0]];var vToP=ConvexPolyhedron_vToP;p.vsub(v,vToP);var r1=n.dot(vToP);var vToPointInside=ConvexPolyhedron_vToPointInside;pointInside.vsub(v,vToPointInside);var r2=n.dot(vToPointInside);if(r1<0&&r2>0||r1>0&&r2<0){return false}else{}}return positiveResult?1:-1};var project_worldVertex=new Vec3;var project_localAxis=new Vec3;var project_localOrigin=new Vec3;ConvexPolyhedron.project=function(hull,axis,pos,quat,result){var n=hull.vertices.length,worldVertex=project_worldVertex,localAxis=project_localAxis,max=0,min=0,localOrigin=project_localOrigin,vs=hull.vertices;localOrigin.setZero();Transform.vectorToLocalFrame(pos,quat,axis,localAxis);Transform.pointToLocalFrame(pos,quat,localOrigin,localOrigin);var add=localOrigin.dot(localAxis);min=max=vs[0].dot(localAxis);for(var i=1;i<n;i++){var val=vs[i].dot(localAxis);if(val>max){max=val}if(val<min){min=val}}min-=add;max-=add;if(min>max){var temp=min;min=max;max=temp}result[0]=max;result[1]=min}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(_dereq_,module,exports){module.exports=Cylinder;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var ConvexPolyhedron=_dereq_("./ConvexPolyhedron");function Cylinder(radiusTop,radiusBottom,height,numSegments){var N=numSegments,verts=[],axes=[],faces=[],bottomface=[],topface=[],cos=Math.cos,sin=Math.sin;verts.push(new Vec3(radiusBottom*cos(0),radiusBottom*sin(0),-height*.5));bottomface.push(0);verts.push(new Vec3(radiusTop*cos(0),radiusTop*sin(0),height*.5));topface.push(1);for(var i=0;i<N;i++){var theta=2*Math.PI/N*(i+1);var thetaN=2*Math.PI/N*(i+.5);if(i<N-1){verts.push(new Vec3(radiusBottom*cos(theta),radiusBottom*sin(theta),-height*.5));bottomface.push(2*i+2);verts.push(new Vec3(radiusTop*cos(theta),radiusTop*sin(theta),height*.5));topface.push(2*i+3);faces.push([2*i+2,2*i+3,2*i+1,2*i])}else{faces.push([0,1,2*i+1,2*i])}if(N%2===1||i<N/2){axes.push(new Vec3(cos(thetaN),sin(thetaN),0))}}faces.push(topface);axes.push(new Vec3(0,0,1));var temp=[];for(var i=0;i<bottomface.length;i++){temp.push(bottomface[bottomface.length-i-1])}faces.push(temp);this.type=Shape.types.CONVEXPOLYHEDRON;ConvexPolyhedron.call(this,verts,faces,axes)}Cylinder.prototype=new ConvexPolyhedron},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape");var ConvexPolyhedron=_dereq_("./ConvexPolyhedron");var Vec3=_dereq_("../math/Vec3");var Utils=_dereq_("../utils/Utils");module.exports=Heightfield;function Heightfield(data,options){options=Utils.defaults(options,{maxValue:null,minValue:null,elementSize:1});this.data=data;this.maxValue=options.maxValue;this.minValue=options.minValue;this.elementSize=options.elementSize;if(options.minValue===null){this.updateMinValue()}if(options.maxValue===null){this.updateMaxValue()}this.cacheEnabled=true;Shape.call(this);this.pillarConvex=new ConvexPolyhedron;this.pillarOffset=new Vec3;this.type=Shape.types.HEIGHTFIELD;this.updateBoundingSphereRadius();this._cachedPillars={}}Heightfield.prototype=new Shape;Heightfield.prototype.update=function(){this._cachedPillars={}};Heightfield.prototype.updateMinValue=function(){var data=this.data;var minValue=data[0][0];for(var i=0;i!==data.length;i++){for(var j=0;j!==data[i].length;j++){var v=data[i][j];if(v<minValue){minValue=v}}}this.minValue=minValue};Heightfield.prototype.updateMaxValue=function(){var data=this.data;var maxValue=data[0][0];for(var i=0;i!==data.length;i++){for(var j=0;j!==data[i].length;j++){var v=data[i][j];if(v>maxValue){maxValue=v}}}this.maxValue=maxValue};Heightfield.prototype.setHeightValueAtIndex=function(xi,yi,value){var data=this.data;data[xi][yi]=value;this.clearCachedConvexTrianglePillar(xi,yi,false);if(xi>0){this.clearCachedConvexTrianglePillar(xi-1,yi,true);this.clearCachedConvexTrianglePillar(xi-1,yi,false)}if(yi>0){this.clearCachedConvexTrianglePillar(xi,yi-1,true);this.clearCachedConvexTrianglePillar(xi,yi-1,false)}if(yi>0&&xi>0){this.clearCachedConvexTrianglePillar(xi-1,yi-1,true)}};Heightfield.prototype.getRectMinMax=function(iMinX,iMinY,iMaxX,iMaxY,result){result=result||[];var data=this.data,max=this.minValue;for(var i=iMinX;i<=iMaxX;i++){for(var j=iMinY;j<=iMaxY;j++){var height=data[i][j];if(height>max){max=height}}}result[0]=this.minValue;result[1]=max};Heightfield.prototype.getIndexOfPosition=function(x,y,result,clamp){var w=this.elementSize;var data=this.data;var xi=Math.floor(x/w);var yi=Math.floor(y/w);result[0]=xi;result[1]=yi;if(clamp){if(xi<0){xi=0}if(yi<0){yi=0}if(xi>=data.length-1){xi=data.length-1}if(yi>=data[0].length-1){yi=data[0].length-1}}if(xi<0||yi<0||xi>=data.length-1||yi>=data[0].length-1){return false}return true};Heightfield.prototype.getHeightAt=function(x,y,edgeClamp){var idx=[];this.getIndexOfPosition(x,y,idx,edgeClamp);var minmax=[];this.getRectMinMax(idx[0],idx[1]+1,idx[0],idx[1]+1,minmax);return(minmax[0]+minmax[1])/2};Heightfield.prototype.getCacheConvexTrianglePillarKey=function(xi,yi,getUpperTriangle){return xi+"_"+yi+"_"+(getUpperTriangle?1:0)};Heightfield.prototype.getCachedConvexTrianglePillar=function(xi,yi,getUpperTriangle){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(xi,yi,getUpperTriangle)]};Heightfield.prototype.setCachedConvexTrianglePillar=function(xi,yi,getUpperTriangle,convex,offset){this._cachedPillars[this.getCacheConvexTrianglePillarKey(xi,yi,getUpperTriangle)]={convex:convex,offset:offset}};Heightfield.prototype.clearCachedConvexTrianglePillar=function(xi,yi,getUpperTriangle){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(xi,yi,getUpperTriangle)]};Heightfield.prototype.getConvexTrianglePillar=function(xi,yi,getUpperTriangle){var result=this.pillarConvex;var offsetResult=this.pillarOffset;if(this.cacheEnabled){var data=this.getCachedConvexTrianglePillar(xi,yi,getUpperTriangle);if(data){this.pillarConvex=data.convex;this.pillarOffset=data.offset;return}result=new ConvexPolyhedron;offsetResult=new Vec3;this.pillarConvex=result;this.pillarOffset=offsetResult}var data=this.data;var elementSize=this.elementSize;var faces=result.faces;result.vertices.length=6;for(var i=0;i<6;i++){if(!result.vertices[i]){result.vertices[i]=new Vec3}}faces.length=5;for(var i=0;i<5;i++){if(!faces[i]){faces[i]=[]}}var verts=result.vertices;var h=(Math.min(data[xi][yi],data[xi+1][yi],data[xi][yi+1],data[xi+1][yi+1])-this.minValue)/2+this.minValue;if(!getUpperTriangle){offsetResult.set((xi+.25)*elementSize,(yi+.25)*elementSize,h);verts[0].set(-.25*elementSize,-.25*elementSize,data[xi][yi]-h);verts[1].set(.75*elementSize,-.25*elementSize,data[xi+1][yi]-h);verts[2].set(-.25*elementSize,.75*elementSize,data[xi][yi+1]-h);verts[3].set(-.25*elementSize,-.25*elementSize,-h-1);verts[4].set(.75*elementSize,-.25*elementSize,-h-1);verts[5].set(-.25*elementSize,.75*elementSize,-h-1);faces[0][0]=0;faces[0][1]=1;faces[0][2]=2;faces[1][0]=5;faces[1][1]=4;faces[1][2]=3;faces[2][0]=0;faces[2][1]=2;faces[2][2]=5;faces[2][3]=3;faces[3][0]=1;faces[3][1]=0;faces[3][2]=3;faces[3][3]=4;faces[4][0]=4;faces[4][1]=5;faces[4][2]=2;faces[4][3]=1}else{offsetResult.set((xi+.75)*elementSize,(yi+.75)*elementSize,h);verts[0].set(.25*elementSize,.25*elementSize,data[xi+1][yi+1]-h);verts[1].set(-.75*elementSize,.25*elementSize,data[xi][yi+1]-h);verts[2].set(.25*elementSize,-.75*elementSize,data[xi+1][yi]-h);verts[3].set(.25*elementSize,.25*elementSize,-h-1);verts[4].set(-.75*elementSize,.25*elementSize,-h-1);verts[5].set(.25*elementSize,-.75*elementSize,-h-1);faces[0][0]=0;faces[0][1]=1;faces[0][2]=2;faces[1][0]=5;faces[1][1]=4;faces[1][2]=3;faces[2][0]=2;faces[2][1]=5;faces[2][2]=3;faces[2][3]=0;faces[3][0]=3;faces[3][1]=4;faces[3][2]=1;faces[3][3]=0;faces[4][0]=1;faces[4][1]=4;faces[4][2]=5;faces[4][3]=2}result.computeNormals();result.computeEdges();result.updateBoundingSphereRadius();this.setCachedConvexTrianglePillar(xi,yi,getUpperTriangle,result,offsetResult)};Heightfield.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;target.set(0,0,0);return target};Heightfield.prototype.volume=function(){return Number.MAX_VALUE};Heightfield.prototype.calculateWorldAABB=function(pos,quat,min,max){min.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);max.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};Heightfield.prototype.updateBoundingSphereRadius=function(){var data=this.data,s=this.elementSize;this.boundingSphereRadius=new Vec3(data.length*s,data[0].length*s,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(_dereq_,module,exports){module.exports=Particle;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");function Particle(){Shape.call(this);this.type=Shape.types.PARTICLE}Particle.prototype=new Shape;Particle.prototype.constructor=Particle;Particle.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;target.set(0,0,0);return target};Particle.prototype.volume=function(){return 0};Particle.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0};Particle.prototype.calculateWorldAABB=function(pos,quat,min,max){min.copy(pos);max.copy(pos)}},{"../math/Vec3":30,"./Shape":43}],42:[function(_dereq_,module,exports){module.exports=Plane;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");function Plane(){Shape.call(this);this.type=Shape.types.PLANE;this.worldNormal=new Vec3;this.worldNormalNeedsUpdate=true;this.boundingSphereRadius=Number.MAX_VALUE}Plane.prototype=new Shape;Plane.prototype.constructor=Plane;Plane.prototype.computeWorldNormal=function(quat){var n=this.worldNormal;n.set(0,0,1);quat.vmult(n,n);this.worldNormalNeedsUpdate=false};Plane.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;return target};Plane.prototype.volume=function(){return Number.MAX_VALUE};var tempNormal=new Vec3;Plane.prototype.calculateWorldAABB=function(pos,quat,min,max){tempNormal.set(0,0,1);quat.vmult(tempNormal,tempNormal);var maxVal=Number.MAX_VALUE;min.set(-maxVal,-maxVal,-maxVal);max.set(maxVal,maxVal,maxVal);if(tempNormal.x===1){max.x=pos.x}if(tempNormal.y===1){max.y=pos.y}if(tempNormal.z===1){max.z=pos.z}if(tempNormal.x===-1){min.x=pos.x}if(tempNormal.y===-1){min.y=pos.y}if(tempNormal.z===-1){min.z=pos.z}};Plane.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(_dereq_,module,exports){module.exports=Shape;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Material=_dereq_("../material/Material");function Shape(){this.id=Shape.idCounter++;this.type=0;this.boundingSphereRadius=0;this.collisionResponse=true;this.material=null}Shape.prototype.constructor=Shape;Shape.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type};Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type};Shape.prototype.calculateLocalInertia=function(mass,target){throw"calculateLocalInertia() not implemented for shape type "+this.type};Shape.idCounter=0;Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(_dereq_,module,exports){module.exports=Sphere;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");function Sphere(radius){Shape.call(this);this.radius=radius!==undefined?Number(radius):1;this.type=Shape.types.SPHERE;if(this.radius<0){throw new Error("The sphere radius cannot be negative.")}this.updateBoundingSphereRadius()}Sphere.prototype=new Shape;Sphere.prototype.constructor=Sphere;Sphere.prototype.calculateLocalInertia=function(mass,target){target=target||new Vec3;var I=2*mass*this.radius*this.radius/5;target.x=I;target.y=I;target.z=I;return target};Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3};Sphere.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius};Sphere.prototype.calculateWorldAABB=function(pos,quat,min,max){var r=this.radius;var axes=["x","y","z"];for(var i=0;i<axes.length;i++){var ax=axes[i];min[ax]=pos[ax]-r;max[ax]=pos[ax]+r}}},{"../math/Vec3":30,"./Shape":43}],45:[function(_dereq_,module,exports){module.exports=Trimesh;var Shape=_dereq_("./Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Transform=_dereq_("../math/Transform");var AABB=_dereq_("../collision/AABB");var Octree=_dereq_("../utils/Octree");function Trimesh(vertices,indices){Shape.call(this);this.type=Shape.types.TRIMESH;this.vertices=new Float32Array(vertices);this.indices=new Int16Array(indices);this.normals=new Float32Array(indices.length);this.aabb=new AABB;this.edges=null;this.scale=new Vec3(1,1,1);this.tree=new Octree;this.updateEdges();this.updateNormals();this.updateAABB();this.updateBoundingSphereRadius();this.updateTree()}Trimesh.prototype=new Shape;Trimesh.prototype.constructor=Trimesh;var computeNormals_n=new Vec3;Trimesh.prototype.updateTree=function(){var tree=this.tree;tree.reset();tree.aabb.copy(this.aabb);var scale=this.scale;tree.aabb.lowerBound.x*=1/scale.x;tree.aabb.lowerBound.y*=1/scale.y;tree.aabb.lowerBound.z*=1/scale.z;tree.aabb.upperBound.x*=1/scale.x;tree.aabb.upperBound.y*=1/scale.y;tree.aabb.upperBound.z*=1/scale.z;var triangleAABB=new AABB;var a=new Vec3;var b=new Vec3;var c=new Vec3;var points=[a,b,c];for(var i=0;i<this.indices.length/3;i++){var i3=i*3;this._getUnscaledVertex(this.indices[i3],a);this._getUnscaledVertex(this.indices[i3+1],b);this._getUnscaledVertex(this.indices[i3+2],c);triangleAABB.setFromPoints(points);tree.insert(triangleAABB,i)}tree.removeEmptyNodes()};var unscaledAABB=new AABB;Trimesh.prototype.getTrianglesInAABB=function(aabb,result){unscaledAABB.copy(aabb);var scale=this.scale;var isx=scale.x;var isy=scale.y;var isz=scale.z;var l=unscaledAABB.lowerBound;var u=unscaledAABB.upperBound;l.x/=isx;l.y/=isy;l.z/=isz;u.x/=isx;u.y/=isy;u.z/=isz;return this.tree.aabbQuery(unscaledAABB,result)};Trimesh.prototype.setScale=function(scale){var wasUniform=this.scale.x===this.scale.y===this.scale.z;var isUniform=scale.x===scale.y===scale.z;if(!(wasUniform&&isUniform)){this.updateNormals()}this.scale.copy(scale);this.updateAABB();this.updateBoundingSphereRadius()};Trimesh.prototype.updateNormals=function(){var n=computeNormals_n;var normals=this.normals;for(var i=0;i<this.indices.length/3;i++){var i3=i*3;var a=this.indices[i3],b=this.indices[i3+1],c=this.indices[i3+2];this.getVertex(a,va);this.getVertex(b,vb);this.getVertex(c,vc);Trimesh.computeNormal(vb,va,vc,n);normals[i3]=n.x;normals[i3+1]=n.y;normals[i3+2]=n.z}};Trimesh.prototype.updateEdges=function(){var edges={};var add=function(indexA,indexB){var key=a<b?a+"_"+b:b+"_"+a;edges[key]=true};for(var i=0;i<this.indices.length/3;i++){var i3=i*3;var a=this.indices[i3],b=this.indices[i3+1],c=this.indices[i3+2];add(a,b);add(b,c);add(c,a)}var keys=Object.keys(edges);this.edges=new Int16Array(keys.length*2);for(var i=0;i<keys.length;i++){var indices=keys[i].split("_");this.edges[2*i]=parseInt(indices[0],10);this.edges[2*i+1]=parseInt(indices[1],10)}};Trimesh.prototype.getEdgeVertex=function(edgeIndex,firstOrSecond,vertexStore){var vertexIndex=this.edges[edgeIndex*2+(firstOrSecond?1:0)];this.getVertex(vertexIndex,vertexStore)};var getEdgeVector_va=new Vec3;var getEdgeVector_vb=new Vec3;Trimesh.prototype.getEdgeVector=function(edgeIndex,vectorStore){var va=getEdgeVector_va;var vb=getEdgeVector_vb;this.getEdgeVertex(edgeIndex,0,va);this.getEdgeVertex(edgeIndex,1,vb);vb.vsub(va,vectorStore)};var cb=new Vec3;var ab=new Vec3;Trimesh.computeNormal=function(va,vb,vc,target){vb.vsub(va,ab);vc.vsub(vb,cb);cb.cross(ab,target);if(!target.isZero()){target.normalize()}};var va=new Vec3;var vb=new Vec3;var vc=new Vec3;Trimesh.prototype.getVertex=function(i,out){var scale=this.scale;this._getUnscaledVertex(i,out);out.x*=scale.x;out.y*=scale.y;out.z*=scale.z;return out};Trimesh.prototype._getUnscaledVertex=function(i,out){var i3=i*3;var vertices=this.vertices;return out.set(vertices[i3],vertices[i3+1],vertices[i3+2])};Trimesh.prototype.getWorldVertex=function(i,pos,quat,out){this.getVertex(i,out);Transform.pointToWorldFrame(pos,quat,out,out);return out};Trimesh.prototype.getTriangleVertices=function(i,a,b,c){var i3=i*3;this.getVertex(this.indices[i3],a);this.getVertex(this.indices[i3+1],b);this.getVertex(this.indices[i3+2],c)};Trimesh.prototype.getNormal=function(i,target){var i3=i*3;return target.set(this.normals[i3],this.normals[i3+1],this.normals[i3+2])};var cli_aabb=new AABB;Trimesh.prototype.calculateLocalInertia=function(mass,target){this.computeLocalAABB(cli_aabb);var x=cli_aabb.upperBound.x-cli_aabb.lowerBound.x,y=cli_aabb.upperBound.y-cli_aabb.lowerBound.y,z=cli_aabb.upperBound.z-cli_aabb.lowerBound.z;return target.set(1/12*mass*(2*y*2*y+2*z*2*z),1/12*mass*(2*x*2*x+2*z*2*z),1/12*mass*(2*y*2*y+2*x*2*x))};var computeLocalAABB_worldVert=new Vec3;Trimesh.prototype.computeLocalAABB=function(aabb){var l=aabb.lowerBound,u=aabb.upperBound,n=this.vertices.length,vertices=this.vertices,v=computeLocalAABB_worldVert;this.getVertex(0,v);l.copy(v);u.copy(v);for(var i=0;i!==n;i++){this.getVertex(i,v);if(v.x<l.x){l.x=v.x}else if(v.x>u.x){u.x=v.x}if(v.y<l.y){l.y=v.y}else if(v.y>u.y){u.y=v.y}if(v.z<l.z){l.z=v.z}else if(v.z>u.z){u.z=v.z}}};Trimesh.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)};Trimesh.prototype.updateBoundingSphereRadius=function(){var max2=0;var vertices=this.vertices;var v=new Vec3;for(var i=0,N=vertices.length/3;i!==N;i++){this.getVertex(i,v);var norm2=v.norm2();if(norm2>max2){max2=norm2}}this.boundingSphereRadius=Math.sqrt(max2)};var tempWorldVertex=new Vec3;var calculateWorldAABB_frame=new Transform;var calculateWorldAABB_aabb=new AABB;Trimesh.prototype.calculateWorldAABB=function(pos,quat,min,max){var frame=calculateWorldAABB_frame;var result=calculateWorldAABB_aabb;frame.position=pos;frame.quaternion=quat;this.aabb.toWorldFrame(frame,result);min.copy(result.lowerBound);max.copy(result.upperBound)};Trimesh.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};Trimesh.createTorus=function(radius,tube,radialSegments,tubularSegments,arc){radius=radius||1;tube=tube||.5;radialSegments=radialSegments||8;tubularSegments=tubularSegments||6;arc=arc||Math.PI*2;var vertices=[];var indices=[];for(var j=0;j<=radialSegments;j++){for(var i=0;i<=tubularSegments;i++){var u=i/tubularSegments*arc;var v=j/radialSegments*Math.PI*2;var x=(radius+tube*Math.cos(v))*Math.cos(u);var y=(radius+tube*Math.cos(v))*Math.sin(u);var z=tube*Math.sin(v);vertices.push(x,y,z)}}for(var j=1;j<=radialSegments;j++){for(var i=1;i<=tubularSegments;i++){var a=(tubularSegments+1)*j+i-1;var b=(tubularSegments+1)*(j-1)+i-1;var c=(tubularSegments+1)*(j-1)+i;var d=(tubularSegments+1)*j+i;indices.push(a,b,d);indices.push(b,c,d)}}return new Trimesh(vertices,indices)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(_dereq_,module,exports){module.exports=GSSolver;var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Solver=_dereq_("./Solver");function GSSolver(){Solver.call(this);this.iterations=10;this.tolerance=1e-7}GSSolver.prototype=new Solver;var GSSolver_solve_lambda=[];var GSSolver_solve_invCs=[];var GSSolver_solve_Bs=[];GSSolver.prototype.solve=function(dt,world){var iter=0,maxIter=this.iterations,tolSquared=this.tolerance*this.tolerance,equations=this.equations,Neq=equations.length,bodies=world.bodies,Nbodies=bodies.length,h=dt,q,B,invC,deltalambda,deltalambdaTot,GWlambda,lambdaj;if(Neq!==0){for(var i=0;i!==Nbodies;i++){bodies[i].updateSolveMassProperties()}}var invCs=GSSolver_solve_invCs,Bs=GSSolver_solve_Bs,lambda=GSSolver_solve_lambda;invCs.length=Neq;Bs.length=Neq;lambda.length=Neq;for(var i=0;i!==Neq;i++){var c=equations[i];lambda[i]=0;Bs[i]=c.computeB(h);invCs[i]=1/c.computeC()}if(Neq!==0){for(var i=0;i!==Nbodies;i++){var b=bodies[i],vlambda=b.vlambda,wlambda=b.wlambda;vlambda.set(0,0,0);if(wlambda){wlambda.set(0,0,0)}}for(iter=0;iter!==maxIter;iter++){deltalambdaTot=0;for(var j=0;j!==Neq;j++){var c=equations[j];B=Bs[j];invC=invCs[j];lambdaj=lambda[j];GWlambda=c.computeGWlambda();deltalambda=invC*(B-GWlambda-c.eps*lambdaj);if(lambdaj+deltalambda<c.minForce){deltalambda=c.minForce-lambdaj}else if(lambdaj+deltalambda>c.maxForce){deltalambda=c.maxForce-lambdaj}lambda[j]+=deltalambda;deltalambdaTot+=deltalambda>0?deltalambda:-deltalambda;c.addToWlambda(deltalambda)}if(deltalambdaTot*deltalambdaTot<tolSquared){break}}for(var i=0;i!==Nbodies;i++){var b=bodies[i],v=b.velocity,w=b.angularVelocity;v.vadd(b.vlambda,v);if(w){w.vadd(b.wlambda,w)}}}return iter}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(_dereq_,module,exports){module.exports=Solver;function Solver(){this.equations=[]}Solver.prototype.solve=function(dt,world){return 0};Solver.prototype.addEquation=function(eq){if(eq.enabled){this.equations.push(eq)}};Solver.prototype.removeEquation=function(eq){var eqs=this.equations;var i=eqs.indexOf(eq);if(i!==-1){eqs.splice(i,1)}};Solver.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(_dereq_,module,exports){module.exports=SplitSolver;var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var Solver=_dereq_("./Solver");var Body=_dereq_("../objects/Body");function SplitSolver(subsolver){Solver.call(this);this.iterations=10;this.tolerance=1e-7;this.subsolver=subsolver;this.nodes=[];this.nodePool=[];while(this.nodePool.length<128){this.nodePool.push(this.createNode())}}SplitSolver.prototype=new Solver;var SplitSolver_solve_nodes=[];var SplitSolver_solve_nodePool=[];var SplitSolver_solve_eqs=[];var SplitSolver_solve_bds=[];var SplitSolver_solve_dummyWorld={bodies:[]};var STATIC=Body.STATIC;function getUnvisitedNode(nodes){var Nnodes=nodes.length;for(var i=0;i!==Nnodes;i++){var node=nodes[i];if(!node.visited&&!(node.body.type&STATIC)){return node}}return false}var queue=[];function bfs(root,visitFunc,bds,eqs){queue.push(root);root.visited=true;visitFunc(root,bds,eqs);while(queue.length){var node=queue.pop();var child;while(child=getUnvisitedNode(node.children)){child.visited=true;visitFunc(child,bds,eqs);queue.push(child)}}}function visitFunc(node,bds,eqs){bds.push(node.body);var Neqs=node.eqs.length;for(var i=0;i!==Neqs;i++){var eq=node.eqs[i];if(eqs.indexOf(eq)===-1){eqs.push(eq)}}}SplitSolver.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:false}};SplitSolver.prototype.solve=function(dt,world){var nodes=SplitSolver_solve_nodes,nodePool=this.nodePool,bodies=world.bodies,equations=this.equations,Neq=equations.length,Nbodies=bodies.length,subsolver=this.subsolver;while(nodePool.length<Nbodies){nodePool.push(this.createNode())}nodes.length=Nbodies;for(var i=0;i<Nbodies;i++){nodes[i]=nodePool[i]}for(var i=0;i!==Nbodies;i++){var node=nodes[i];node.body=bodies[i];node.children.length=0;node.eqs.length=0;node.visited=false}for(var k=0;k!==Neq;k++){var eq=equations[k],i=bodies.indexOf(eq.bi),j=bodies.indexOf(eq.bj),ni=nodes[i],nj=nodes[j];ni.children.push(nj);ni.eqs.push(eq);nj.children.push(ni);nj.eqs.push(eq)}var child,n=0,eqs=SplitSolver_solve_eqs;subsolver.tolerance=this.tolerance;subsolver.iterations=this.iterations;var dummyWorld=SplitSolver_solve_dummyWorld;while(child=getUnvisitedNode(nodes)){eqs.length=0;dummyWorld.bodies.length=0;bfs(child,visitFunc,dummyWorld.bodies,eqs);var Neqs=eqs.length;eqs=eqs.sort(sortById);for(var i=0;i!==Neqs;i++){subsolver.addEquation(eqs[i])}var iter=subsolver.solve(dt,dummyWorld);subsolver.removeAllEquations();n++}return n};function sortById(a,b){return b.id-a.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(_dereq_,module,exports){var EventTarget=function(){};module.exports=EventTarget;EventTarget.prototype={constructor:EventTarget,addEventListener:function(type,listener){if(this._listeners===undefined){this._listeners={}}var listeners=this._listeners;if(listeners[type]===undefined){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}return this},hasEventListener:function(type,listener){if(this._listeners===undefined){return false}var listeners=this._listeners;if(listeners[type]!==undefined&&listeners[type].indexOf(listener)!==-1){return true}return false},removeEventListener:function(type,listener){if(this._listeners===undefined){return this}var listeners=this._listeners;if(listeners[type]===undefined){return this}var index=listeners[type].indexOf(listener);if(index!==-1){listeners[type].splice(index,1)}return this},dispatchEvent:function(event){if(this._listeners===undefined){return this}var listeners=this._listeners;var listenerArray=listeners[event.type];if(listenerArray!==undefined){event.target=this;for(var i=0,l=listenerArray.length;i<l;i++){listenerArray[i].call(this,event)}}return this}}},{}],50:[function(_dereq_,module,exports){var AABB=_dereq_("../collision/AABB");var Vec3=_dereq_("../math/Vec3");module.exports=Octree;function OctreeNode(options){options=options||{};this.root=options.root||null;this.aabb=options.aabb?options.aabb.clone():new AABB;this.data=[];this.children=[]}function Octree(aabb,options){options=options||{};options.root=null;options.aabb=aabb;OctreeNode.call(this,options);this.maxDepth=typeof options.maxDepth!=="undefined"?options.maxDepth:8}Octree.prototype=new OctreeNode;OctreeNode.prototype.reset=function(aabb,options){this.children.length=this.data.length=0};OctreeNode.prototype.insert=function(aabb,elementData,level){var nodeData=this.data;level=level||0;if(!this.aabb.contains(aabb)){return false}var children=this.children;if(level<(this.maxDepth||this.root.maxDepth)){var subdivided=false;if(!children.length){this.subdivide();subdivided=true}for(var i=0;i!==8;i++){if(children[i].insert(aabb,elementData,level+1)){return true}}if(subdivided){children.length=0}}nodeData.push(elementData);return true};var halfDiagonal=new Vec3;OctreeNode.prototype.subdivide=function(){var aabb=this.aabb;var l=aabb.lowerBound;var u=aabb.upperBound;var children=this.children;children.push(new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,0,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,0,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,1,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,1,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,1,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,0,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,0,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,1,0)})}));u.vsub(l,halfDiagonal);halfDiagonal.scale(.5,halfDiagonal);var root=this.root||this;for(var i=0;i!==8;i++){var child=children[i];child.root=root;var lowerBound=child.aabb.lowerBound;lowerBound.x*=halfDiagonal.x;lowerBound.y*=halfDiagonal.y;lowerBound.z*=halfDiagonal.z;lowerBound.vadd(l,lowerBound);lowerBound.vadd(halfDiagonal,child.aabb.upperBound)}};OctreeNode.prototype.aabbQuery=function(aabb,result){var nodeData=this.data;var children=this.children;var queue=[this];while(queue.length){var node=queue.pop();if(node.aabb.overlaps(aabb)){Array.prototype.push.apply(result,node.data)}Array.prototype.push.apply(queue,node.children)}return result};var tmpAABB=new AABB;OctreeNode.prototype.rayQuery=function(ray,treeTransform,result){ray.getAABB(tmpAABB);tmpAABB.toLocalFrame(treeTransform,tmpAABB);this.aabbQuery(tmpAABB,result);return result};OctreeNode.prototype.removeEmptyNodes=function(){var queue=[this];while(queue.length){var node=queue.pop();for(var i=node.children.length-1;i>=0;i--){if(!node.children[i].data.length){node.children.splice(i,1)}}Array.prototype.push.apply(queue,node.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(_dereq_,module,exports){module.exports=Pool;function Pool(){this.objects=[];this.type=Object}Pool.prototype.release=function(){var Nargs=arguments.length;for(var i=0;i!==Nargs;i++){this.objects.push(arguments[i])}};Pool.prototype.get=function(){if(this.objects.length===0){return this.constructObject()}else{return this.objects.pop()}};Pool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(_dereq_,module,exports){module.exports=TupleDictionary;function TupleDictionary(){this.data={keys:[]}}TupleDictionary.prototype.get=function(i,j){if(i>j){var temp=j;j=i;i=temp}return this.data[i+"-"+j]};TupleDictionary.prototype.set=function(i,j,value){if(i>j){var temp=j;j=i;i=temp}var key=i+"-"+j;if(!this.get(i,j)){this.data.keys.push(key)}this.data[key]=value};TupleDictionary.prototype.reset=function(){var data=this.data,keys=data.keys;while(keys.length>0){var key=keys.pop();delete data[key]}}},{}],53:[function(_dereq_,module,exports){function Utils(){}module.exports=Utils;Utils.defaults=function(options,defaults){options=options||{};for(var key in defaults){if(!(key in options)){options[key]=defaults[key]}}return options}},{}],54:[function(_dereq_,module,exports){module.exports=Vec3Pool;var Vec3=_dereq_("../math/Vec3");var Pool=_dereq_("./Pool");function Vec3Pool(){Pool.call(this);this.type=Vec3}Vec3Pool.prototype=new Pool;Vec3Pool.prototype.constructObject=function(){return new Vec3}},{"../math/Vec3":30,"./Pool":51}],55:[function(_dereq_,module,exports){module.exports=Narrowphase;var AABB=_dereq_("../collision/AABB");var Shape=_dereq_("../shapes/Shape");var Ray=_dereq_("../collision/Ray");var Vec3=_dereq_("../math/Vec3");var Transform=_dereq_("../math/Transform");var ConvexPolyhedron=_dereq_("../shapes/ConvexPolyhedron");var Quaternion=_dereq_("../math/Quaternion");var Solver=_dereq_("../solver/Solver");var Vec3Pool=_dereq_("../utils/Vec3Pool");var ContactEquation=_dereq_("../equations/ContactEquation");var FrictionEquation=_dereq_("../equations/FrictionEquation");function Narrowphase(world){this.contactPointPool=[];this.frictionEquationPool=[];this.result=[];this.frictionResult=[];this.v3pool=new Vec3Pool;this.world=world;this.currentContactMaterial=null;this.enableFrictionReduction=false}Narrowphase.prototype.createContactEquation=function(bi,bj,si,sj,rsi,rsj){var c;if(this.contactPointPool.length){c=this.contactPointPool.pop();c.bi=bi;c.bj=bj}else{c=new ContactEquation(bi,bj)}c.enabled=bi.collisionResponse&&bj.collisionResponse&&si.collisionResponse&&sj.collisionResponse;var cm=this.currentContactMaterial;c.restitution=cm.restitution;c.setSpookParams(cm.contactEquationStiffness,cm.contactEquationRelaxation,this.world.dt);var matA=si.material||bi.material;var matB=sj.material||bj.material;if(matA&&matB&&matA.restitution>=0&&matB.restitution>=0){c.restitution=matA.restitution*matB.restitution}c.si=rsi||si;c.sj=rsj||sj;return c};Narrowphase.prototype.createFrictionEquationsFromContact=function(contactEquation,outArray){var bodyA=contactEquation.bi;var bodyB=contactEquation.bj;var shapeA=contactEquation.si;var shapeB=contactEquation.sj;var world=this.world;var cm=this.currentContactMaterial;var friction=cm.friction;var matA=shapeA.material||bodyA.material;var matB=shapeB.material||bodyB.material;if(matA&&matB&&matA.friction>=0&&matB.friction>=0){friction=matA.friction*matB.friction}if(friction>0){var mug=friction*world.gravity.length();var reducedMass=bodyA.invMass+bodyB.invMass;if(reducedMass>0){reducedMass=1/reducedMass}var pool=this.frictionEquationPool;var c1=pool.length?pool.pop():new FrictionEquation(bodyA,bodyB,mug*reducedMass);var c2=pool.length?pool.pop():new FrictionEquation(bodyA,bodyB,mug*reducedMass);c1.bi=c2.bi=bodyA;c1.bj=c2.bj=bodyB;c1.minForce=c2.minForce=-mug*reducedMass;c1.maxForce=c2.maxForce=mug*reducedMass;c1.ri.copy(contactEquation.ri);c1.rj.copy(contactEquation.rj);c2.ri.copy(contactEquation.ri);c2.rj.copy(contactEquation.rj);contactEquation.ni.tangents(c1.t,c2.t);c1.setSpookParams(cm.frictionEquationStiffness,cm.frictionEquationRelaxation,world.dt);c2.setSpookParams(cm.frictionEquationStiffness,cm.frictionEquationRelaxation,world.dt);c1.enabled=c2.enabled=contactEquation.enabled;outArray.push(c1,c2);return true}return false};var averageNormal=new Vec3;var averageContactPointA=new Vec3;var averageContactPointB=new Vec3;Narrowphase.prototype.createFrictionFromAverage=function(numContacts){var c=this.result[this.result.length-1];if(!this.createFrictionEquationsFromContact(c,this.frictionResult)||numContacts===1){return}var f1=this.frictionResult[this.frictionResult.length-2];var f2=this.frictionResult[this.frictionResult.length-1];averageNormal.setZero();averageContactPointA.setZero();averageContactPointB.setZero();var bodyA=c.bi;var bodyB=c.bj;for(var i=0;i!==numContacts;i++){c=this.result[this.result.length-1-i];if(c.bodyA!==bodyA){averageNormal.vadd(c.ni,averageNormal);averageContactPointA.vadd(c.ri,averageContactPointA);averageContactPointB.vadd(c.rj,averageContactPointB)}else{averageNormal.vsub(c.ni,averageNormal);averageContactPointA.vadd(c.rj,averageContactPointA);averageContactPointB.vadd(c.ri,averageContactPointB)}}var invNumContacts=1/numContacts;averageContactPointA.scale(invNumContacts,f1.ri);averageContactPointB.scale(invNumContacts,f1.rj);f2.ri.copy(f1.ri);f2.rj.copy(f1.rj);averageNormal.normalize();averageNormal.tangents(f1.t,f2.t)};var tmpVec1=new Vec3;var tmpVec2=new Vec3;var tmpQuat1=new Quaternion;var tmpQuat2=new Quaternion;Narrowphase.prototype.getContacts=function(p1,p2,world,result,oldcontacts,frictionResult,frictionPool){this.contactPointPool=oldcontacts;this.frictionEquationPool=frictionPool;this.result=result;this.frictionResult=frictionResult;var qi=tmpQuat1;var qj=tmpQuat2;var xi=tmpVec1;var xj=tmpVec2;for(var k=0,N=p1.length;k!==N;k++){var bi=p1[k],bj=p2[k];var bodyContactMaterial=null;if(bi.material&&bj.material){bodyContactMaterial=world.getContactMaterial(bi.material,bj.material)||null}for(var i=0;i<bi.shapes.length;i++){bi.quaternion.mult(bi.shapeOrientations[i],qi);bi.quaternion.vmult(bi.shapeOffsets[i],xi);xi.vadd(bi.position,xi);var si=bi.shapes[i];for(var j=0;j<bj.shapes.length;j++){bj.quaternion.mult(bj.shapeOrientations[j],qj);bj.quaternion.vmult(bj.shapeOffsets[j],xj);xj.vadd(bj.position,xj);var sj=bj.shapes[j];if(xi.distanceTo(xj)>si.boundingSphereRadius+sj.boundingSphereRadius){continue}var shapeContactMaterial=null;if(si.material&&sj.material){shapeContactMaterial=world.getContactMaterial(si.material,sj.material)||null}this.currentContactMaterial=shapeContactMaterial||bodyContactMaterial||world.defaultContactMaterial;var resolver=this[si.type|sj.type];if(resolver){if(si.type<sj.type){resolver.call(this,si,sj,xi,xj,qi,qj,bi,bj,si,sj)}else{resolver.call(this,sj,si,xj,xi,qj,qi,bj,bi,si,sj)}}}}}};var numWarnings=0;var maxWarnings=10;function warn(msg){if(numWarnings>maxWarnings){return}numWarnings++;console.warn(msg)}Narrowphase.prototype[Shape.types.BOX|Shape.types.BOX]=Narrowphase.prototype.boxBox=function(si,sj,xi,xj,qi,qj,bi,bj){si.convexPolyhedronRepresentation.material=si.material;sj.convexPolyhedronRepresentation.material=sj.material;si.convexPolyhedronRepresentation.collisionResponse=si.collisionResponse;sj.convexPolyhedronRepresentation.collisionResponse=sj.collisionResponse;this.convexConvex(si.convexPolyhedronRepresentation,sj.convexPolyhedronRepresentation,xi,xj,qi,qj,bi,bj,si,sj)};Narrowphase.prototype[Shape.types.BOX|Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.boxConvex=function(si,sj,xi,xj,qi,qj,bi,bj){si.convexPolyhedronRepresentation.material=si.material;si.convexPolyhedronRepresentation.collisionResponse=si.collisionResponse;this.convexConvex(si.convexPolyhedronRepresentation,sj,xi,xj,qi,qj,bi,bj,si,sj)};Narrowphase.prototype[Shape.types.BOX|Shape.types.PARTICLE]=Narrowphase.prototype.boxParticle=function(si,sj,xi,xj,qi,qj,bi,bj){si.convexPolyhedronRepresentation.material=si.material;si.convexPolyhedronRepresentation.collisionResponse=si.collisionResponse;this.convexParticle(si.convexPolyhedronRepresentation,sj,xi,xj,qi,qj,bi,bj,si,sj)};Narrowphase.prototype[Shape.types.SPHERE]=Narrowphase.prototype.sphereSphere=function(si,sj,xi,xj,qi,qj,bi,bj){var r=this.createContactEquation(bi,bj,si,sj);xj.vsub(xi,r.ni);r.ni.normalize();r.ri.copy(r.ni);r.rj.copy(r.ni);r.ri.mult(si.radius,r.ri);r.rj.mult(-sj.radius,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)};var planeTrimesh_normal=new Vec3;var planeTrimesh_relpos=new Vec3;var planeTrimesh_projected=new Vec3;Narrowphase.prototype[Shape.types.PLANE|Shape.types.TRIMESH]=Narrowphase.prototype.planeTrimesh=function(planeShape,trimeshShape,planePos,trimeshPos,planeQuat,trimeshQuat,planeBody,trimeshBody){var v=new Vec3;var normal=planeTrimesh_normal;normal.set(0,0,1);planeQuat.vmult(normal,normal);for(var i=0;i<trimeshShape.vertices.length/3;i++){trimeshShape.getVertex(i,v);var v2=new Vec3;v2.copy(v);Transform.pointToWorldFrame(trimeshPos,trimeshQuat,v2,v);var relpos=planeTrimesh_relpos;v.vsub(planePos,relpos);var dot=normal.dot(relpos);if(dot<=0){var r=this.createContactEquation(planeBody,trimeshBody,planeShape,trimeshShape);r.ni.copy(normal);var projected=planeTrimesh_projected;normal.scale(relpos.dot(normal),projected);v.vsub(projected,projected);r.ri.copy(projected);r.ri.vsub(planeBody.position,r.ri);r.rj.copy(v);r.rj.vsub(trimeshBody.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}};var sphereTrimesh_normal=new Vec3;var sphereTrimesh_relpos=new Vec3;var sphereTrimesh_projected=new Vec3;var sphereTrimesh_v=new Vec3;var sphereTrimesh_v2=new Vec3;var sphereTrimesh_edgeVertexA=new Vec3;var sphereTrimesh_edgeVertexB=new Vec3;var sphereTrimesh_edgeVector=new Vec3;var sphereTrimesh_edgeVectorUnit=new Vec3;var sphereTrimesh_localSpherePos=new Vec3;var sphereTrimesh_tmp=new Vec3;var sphereTrimesh_va=new Vec3;var sphereTrimesh_vb=new Vec3;var sphereTrimesh_vc=new Vec3;var sphereTrimesh_localSphereAABB=new AABB;var sphereTrimesh_triangles=[];Narrowphase.prototype[Shape.types.SPHERE|Shape.types.TRIMESH]=Narrowphase.prototype.sphereTrimesh=function(sphereShape,trimeshShape,spherePos,trimeshPos,sphereQuat,trimeshQuat,sphereBody,trimeshBody){var edgeVertexA=sphereTrimesh_edgeVertexA;var edgeVertexB=sphereTrimesh_edgeVertexB;var edgeVector=sphereTrimesh_edgeVector;var edgeVectorUnit=sphereTrimesh_edgeVectorUnit;var localSpherePos=sphereTrimesh_localSpherePos;var tmp=sphereTrimesh_tmp;var localSphereAABB=sphereTrimesh_localSphereAABB;var v2=sphereTrimesh_v2;var relpos=sphereTrimesh_relpos;var triangles=sphereTrimesh_triangles;Transform.pointToLocalFrame(trimeshPos,trimeshQuat,spherePos,localSpherePos);var sphereRadius=sphereShape.radius;localSphereAABB.lowerBound.set(localSpherePos.x-sphereRadius,localSpherePos.y-sphereRadius,localSpherePos.z-sphereRadius);localSphereAABB.upperBound.set(localSpherePos.x+sphereRadius,localSpherePos.y+sphereRadius,localSpherePos.z+sphereRadius);trimeshShape.getTrianglesInAABB(localSphereAABB,triangles);var v=sphereTrimesh_v;var radiusSquared=sphereShape.radius*sphereShape.radius;for(var i=0;i<triangles.length;i++){for(var j=0;j<3;j++){trimeshShape.getVertex(trimeshShape.indices[triangles[i]*3+j],v);v.vsub(localSpherePos,relpos);if(relpos.norm2()<=radiusSquared){v2.copy(v);Transform.pointToWorldFrame(trimeshPos,trimeshQuat,v2,v);v.vsub(spherePos,relpos);var r=this.createContactEquation(sphereBody,trimeshBody,sphereShape,trimeshShape);r.ni.copy(relpos);r.ni.normalize();r.ri.copy(r.ni);r.ri.scale(sphereShape.radius,r.ri);r.ri.vadd(spherePos,r.ri);r.ri.vsub(sphereBody.position,r.ri);r.rj.copy(v);r.rj.vsub(trimeshBody.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}}for(var i=0;i<triangles.length;i++){for(var j=0;j<3;j++){trimeshShape.getVertex(trimeshShape.indices[triangles[i]*3+j],edgeVertexA);trimeshShape.getVertex(trimeshShape.indices[triangles[i]*3+(j+1)%3],edgeVertexB);edgeVertexB.vsub(edgeVertexA,edgeVector);localSpherePos.vsub(edgeVertexB,tmp);var positionAlongEdgeB=tmp.dot(edgeVector);localSpherePos.vsub(edgeVertexA,tmp);var positionAlongEdgeA=tmp.dot(edgeVector);if(positionAlongEdgeA>0&&positionAlongEdgeB<0){localSpherePos.vsub(edgeVertexA,tmp);edgeVectorUnit.copy(edgeVector);edgeVectorUnit.normalize();positionAlongEdgeA=tmp.dot(edgeVectorUnit);edgeVectorUnit.scale(positionAlongEdgeA,tmp);tmp.vadd(edgeVertexA,tmp);var dist=tmp.distanceTo(localSpherePos);if(dist<sphereShape.radius){var r=this.createContactEquation(sphereBody,trimeshBody,sphereShape,trimeshShape);tmp.vsub(localSpherePos,r.ni);r.ni.normalize();r.ni.scale(sphereShape.radius,r.ri);Transform.pointToWorldFrame(trimeshPos,trimeshQuat,tmp,tmp);tmp.vsub(trimeshBody.position,r.rj);Transform.vectorToWorldFrame(trimeshQuat,r.ni,r.ni);Transform.vectorToWorldFrame(trimeshQuat,r.ri,r.ri);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}}}var va=sphereTrimesh_va;var vb=sphereTrimesh_vb;var vc=sphereTrimesh_vc;var normal=sphereTrimesh_normal;for(var i=0,N=triangles.length;i!==N;i++){trimeshShape.getTriangleVertices(triangles[i],va,vb,vc);trimeshShape.getNormal(triangles[i],normal);localSpherePos.vsub(va,tmp);var dist=tmp.dot(normal);normal.scale(dist,tmp);localSpherePos.vsub(tmp,tmp);dist=tmp.distanceTo(localSpherePos);if(Ray.pointInTriangle(tmp,va,vb,vc)&&dist<sphereShape.radius){var r=this.createContactEquation(sphereBody,trimeshBody,sphereShape,trimeshShape);tmp.vsub(localSpherePos,r.ni);r.ni.normalize();r.ni.scale(sphereShape.radius,r.ri);Transform.pointToWorldFrame(trimeshPos,trimeshQuat,tmp,tmp);tmp.vsub(trimeshBody.position,r.rj);Transform.vectorToWorldFrame(trimeshQuat,r.ni,r.ni);Transform.vectorToWorldFrame(trimeshQuat,r.ri,r.ri);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}triangles.length=0};var point_on_plane_to_sphere=new Vec3;var plane_to_sphere_ortho=new Vec3;Narrowphase.prototype[Shape.types.SPHERE|Shape.types.PLANE]=Narrowphase.prototype.spherePlane=function(si,sj,xi,xj,qi,qj,bi,bj){var r=this.createContactEquation(bi,bj,si,sj);r.ni.set(0,0,1);qj.vmult(r.ni,r.ni);r.ni.negate(r.ni);r.ni.normalize();r.ni.mult(si.radius,r.ri);xi.vsub(xj,point_on_plane_to_sphere);r.ni.mult(r.ni.dot(point_on_plane_to_sphere),plane_to_sphere_ortho);point_on_plane_to_sphere.vsub(plane_to_sphere_ortho,r.rj);if(-point_on_plane_to_sphere.dot(r.ni)<=si.radius){var ri=r.ri;var rj=r.rj;ri.vadd(xi,ri);ri.vsub(bi.position,ri);rj.vadd(xj,rj);rj.vsub(bj.position,rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}};var pointInPolygon_edge=new Vec3;var pointInPolygon_edge_x_normal=new Vec3;var pointInPolygon_vtp=new Vec3;function pointInPolygon(verts,normal,p){var positiveResult=null;var N=verts.length;for(var i=0;i!==N;i++){var v=verts[i];var edge=pointInPolygon_edge;verts[(i+1)%N].vsub(v,edge);var edge_x_normal=pointInPolygon_edge_x_normal;edge.cross(normal,edge_x_normal);var vertex_to_p=pointInPolygon_vtp;p.vsub(v,vertex_to_p);var r=edge_x_normal.dot(vertex_to_p);if(positiveResult===null||r>0&&positiveResult===true||r<=0&&positiveResult===false){if(positiveResult===null){positiveResult=r>0}continue}else{return false}}return true}var box_to_sphere=new Vec3;var sphereBox_ns=new Vec3;var sphereBox_ns1=new Vec3;var sphereBox_ns2=new Vec3;var sphereBox_sides=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];var sphereBox_sphere_to_corner=new Vec3;var sphereBox_side_ns=new Vec3;var sphereBox_side_ns1=new Vec3;var sphereBox_side_ns2=new Vec3;Narrowphase.prototype[Shape.types.SPHERE|Shape.types.BOX]=Narrowphase.prototype.sphereBox=function(si,sj,xi,xj,qi,qj,bi,bj){var v3pool=this.v3pool;var sides=sphereBox_sides;xi.vsub(xj,box_to_sphere);sj.getSideNormals(sides,qj);var R=si.radius;var penetrating_sides=[];var found=false;var side_ns=sphereBox_side_ns;var side_ns1=sphereBox_side_ns1;var side_ns2=sphereBox_side_ns2;var side_h=null;var side_penetrations=0;var side_dot1=0;var side_dot2=0;var side_distance=null;for(var idx=0,nsides=sides.length;idx!==nsides&&found===false;idx++){var ns=sphereBox_ns;ns.copy(sides[idx]);var h=ns.norm();ns.normalize();var dot=box_to_sphere.dot(ns);if(dot<h+R&&dot>0){var ns1=sphereBox_ns1;var ns2=sphereBox_ns2;ns1.copy(sides[(idx+1)%3]);ns2.copy(sides[(idx+2)%3]);var h1=ns1.norm();var h2=ns2.norm();ns1.normalize();ns2.normalize();var dot1=box_to_sphere.dot(ns1);var dot2=box_to_sphere.dot(ns2);if(dot1<h1&&dot1>-h1&&dot2<h2&&dot2>-h2){var dist=Math.abs(dot-h-R);if(side_distance===null||dist<side_distance){side_distance=dist;side_dot1=dot1;side_dot2=dot2;side_h=h;side_ns.copy(ns);side_ns1.copy(ns1);side_ns2.copy(ns2);side_penetrations++}}}}if(side_penetrations){found=true;var r=this.createContactEquation(bi,bj,si,sj);side_ns.mult(-R,r.ri);r.ni.copy(side_ns);r.ni.negate(r.ni);side_ns.mult(side_h,side_ns);side_ns1.mult(side_dot1,side_ns1);side_ns.vadd(side_ns1,side_ns);side_ns2.mult(side_dot2,side_ns2);side_ns.vadd(side_ns2,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}var rj=v3pool.get();var sphere_to_corner=sphereBox_sphere_to_corner;for(var j=0;j!==2&&!found;j++){for(var k=0;k!==2&&!found;k++){for(var l=0;l!==2&&!found;l++){rj.set(0,0,0);if(j){rj.vadd(sides[0],rj)}else{rj.vsub(sides[0],rj)}if(k){rj.vadd(sides[1],rj)}else{rj.vsub(sides[1],rj)}if(l){rj.vadd(sides[2],rj)}else{rj.vsub(sides[2],rj)}xj.vadd(rj,sphere_to_corner);sphere_to_corner.vsub(xi,sphere_to_corner);if(sphere_to_corner.norm2()<R*R){found=true;var r=this.createContactEquation(bi,bj,si,sj);r.ri.copy(sphere_to_corner);r.ri.normalize();r.ni.copy(r.ri);r.ri.mult(R,r.ri);r.rj.copy(rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}}}}v3pool.release(rj);rj=null;var edgeTangent=v3pool.get();var edgeCenter=v3pool.get();var r=v3pool.get();var orthogonal=v3pool.get();var dist=v3pool.get();var Nsides=sides.length;for(var j=0;j!==Nsides&&!found;j++){for(var k=0;k!==Nsides&&!found;k++){if(j%3!==k%3){sides[k].cross(sides[j],edgeTangent);edgeTangent.normalize();sides[j].vadd(sides[k],edgeCenter);r.copy(xi);r.vsub(edgeCenter,r);r.vsub(xj,r);var orthonorm=r.dot(edgeTangent);edgeTangent.mult(orthonorm,orthogonal);var l=0;while(l===j%3||l===k%3){l++}dist.copy(xi);dist.vsub(orthogonal,dist);dist.vsub(edgeCenter,dist);dist.vsub(xj,dist);var tdist=Math.abs(orthonorm);var ndist=dist.norm();if(tdist<sides[l].norm()&&ndist<R){found=true;var res=this.createContactEquation(bi,bj,si,sj);edgeCenter.vadd(orthogonal,res.rj);res.rj.copy(res.rj);dist.negate(res.ni);res.ni.normalize();res.ri.copy(res.rj);res.ri.vadd(xj,res.ri);res.ri.vsub(xi,res.ri);res.ri.normalize();res.ri.mult(R,res.ri);res.ri.vadd(xi,res.ri);res.ri.vsub(bi.position,res.ri);res.rj.vadd(xj,res.rj);res.rj.vsub(bj.position,res.rj);this.result.push(res);this.createFrictionEquationsFromContact(res,this.frictionResult)}}}}v3pool.release(edgeTangent,edgeCenter,r,orthogonal,dist)};var convex_to_sphere=new Vec3;var sphereConvex_edge=new Vec3;var sphereConvex_edgeUnit=new Vec3;var sphereConvex_sphereToCorner=new Vec3;var sphereConvex_worldCorner=new Vec3;var sphereConvex_worldNormal=new Vec3;var sphereConvex_worldPoint=new Vec3;var sphereConvex_worldSpherePointClosestToPlane=new Vec3;var sphereConvex_penetrationVec=new Vec3;var sphereConvex_sphereToWorldPoint=new Vec3;Narrowphase.prototype[Shape.types.SPHERE|Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.sphereConvex=function(si,sj,xi,xj,qi,qj,bi,bj){var v3pool=this.v3pool;xi.vsub(xj,convex_to_sphere);var normals=sj.faceNormals;var faces=sj.faces;var verts=sj.vertices;var R=si.radius;var penetrating_sides=[];for(var i=0;i!==verts.length;i++){var v=verts[i];var worldCorner=sphereConvex_worldCorner;qj.vmult(v,worldCorner);xj.vadd(worldCorner,worldCorner);var sphere_to_corner=sphereConvex_sphereToCorner;worldCorner.vsub(xi,sphere_to_corner);if(sphere_to_corner.norm2()<R*R){found=true;var r=this.createContactEquation(bi,bj,si,sj);r.ri.copy(sphere_to_corner);r.ri.normalize();r.ni.copy(r.ri);r.ri.mult(R,r.ri);worldCorner.vsub(xj,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult);return}}var found=false;for(var i=0,nfaces=faces.length;i!==nfaces&&found===false;i++){var normal=normals[i];var face=faces[i];var worldNormal=sphereConvex_worldNormal;qj.vmult(normal,worldNormal);var worldPoint=sphereConvex_worldPoint;qj.vmult(verts[face[0]],worldPoint);worldPoint.vadd(xj,worldPoint);var worldSpherePointClosestToPlane=sphereConvex_worldSpherePointClosestToPlane;worldNormal.mult(-R,worldSpherePointClosestToPlane);xi.vadd(worldSpherePointClosestToPlane,worldSpherePointClosestToPlane);var penetrationVec=sphereConvex_penetrationVec;worldSpherePointClosestToPlane.vsub(worldPoint,penetrationVec);var penetration=penetrationVec.dot(worldNormal);var worldPointToSphere=sphereConvex_sphereToWorldPoint;xi.vsub(worldPoint,worldPointToSphere);if(penetration<0&&worldPointToSphere.dot(worldNormal)>0){var faceVerts=[];for(var j=0,Nverts=face.length;j!==Nverts;j++){var worldVertex=v3pool.get();qj.vmult(verts[face[j]],worldVertex);xj.vadd(worldVertex,worldVertex);faceVerts.push(worldVertex)}if(pointInPolygon(faceVerts,worldNormal,xi)){found=true;var r=this.createContactEquation(bi,bj,si,sj);worldNormal.mult(-R,r.ri);worldNormal.negate(r.ni);var penetrationVec2=v3pool.get();worldNormal.mult(-penetration,penetrationVec2);var penetrationSpherePoint=v3pool.get();worldNormal.mult(-R,penetrationSpherePoint);xi.vsub(xj,r.rj);r.rj.vadd(penetrationSpherePoint,r.rj);r.rj.vadd(penetrationVec2,r.rj);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);v3pool.release(penetrationVec2);v3pool.release(penetrationSpherePoint);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult);for(var j=0,Nfaceverts=faceVerts.length;j!==Nfaceverts;j++){v3pool.release(faceVerts[j])}return}else{for(var j=0;j!==face.length;j++){var v1=v3pool.get();var v2=v3pool.get();qj.vmult(verts[face[(j+1)%face.length]],v1);qj.vmult(verts[face[(j+2)%face.length]],v2);xj.vadd(v1,v1);xj.vadd(v2,v2);var edge=sphereConvex_edge;v2.vsub(v1,edge);var edgeUnit=sphereConvex_edgeUnit;edge.unit(edgeUnit);var p=v3pool.get();var v1_to_xi=v3pool.get();xi.vsub(v1,v1_to_xi);var dot=v1_to_xi.dot(edgeUnit);edgeUnit.mult(dot,p);p.vadd(v1,p);var xi_to_p=v3pool.get();p.vsub(xi,xi_to_p);if(dot>0&&dot*dot<edge.norm2()&&xi_to_p.norm2()<R*R){var r=this.createContactEquation(bi,bj,si,sj);p.vsub(xj,r.rj);p.vsub(xi,r.ni);r.ni.normalize();r.ni.mult(R,r.ri);r.rj.vadd(xj,r.rj);r.rj.vsub(bj.position,r.rj);r.ri.vadd(xi,r.ri);r.ri.vsub(bi.position,r.ri);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult);for(var j=0,Nfaceverts=faceVerts.length;j!==Nfaceverts;j++){v3pool.release(faceVerts[j])}v3pool.release(v1);v3pool.release(v2);v3pool.release(p);v3pool.release(xi_to_p);v3pool.release(v1_to_xi);return}v3pool.release(v1);v3pool.release(v2);v3pool.release(p);v3pool.release(xi_to_p);v3pool.release(v1_to_xi)}}for(var j=0,Nfaceverts=faceVerts.length;j!==Nfaceverts;j++){v3pool.release(faceVerts[j])}}}};var planeBox_normal=new Vec3;var plane_to_corner=new Vec3;Narrowphase.prototype[Shape.types.PLANE|Shape.types.BOX]=Narrowphase.prototype.planeBox=function(si,sj,xi,xj,qi,qj,bi,bj){sj.convexPolyhedronRepresentation.material=sj.material;sj.convexPolyhedronRepresentation.collisionResponse=sj.collisionResponse;this.planeConvex(si,sj.convexPolyhedronRepresentation,xi,xj,qi,qj,bi,bj)};var planeConvex_v=new Vec3;var planeConvex_normal=new Vec3;var planeConvex_relpos=new Vec3;var planeConvex_projected=new Vec3;Narrowphase.prototype[Shape.types.PLANE|Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.planeConvex=function(planeShape,convexShape,planePosition,convexPosition,planeQuat,convexQuat,planeBody,convexBody){var worldVertex=planeConvex_v,worldNormal=planeConvex_normal;worldNormal.set(0,0,1);planeQuat.vmult(worldNormal,worldNormal);var numContacts=0;var relpos=planeConvex_relpos;for(var i=0;i!==convexShape.vertices.length;i++){worldVertex.copy(convexShape.vertices[i]);convexQuat.vmult(worldVertex,worldVertex);convexPosition.vadd(worldVertex,worldVertex);worldVertex.vsub(planePosition,relpos);var dot=worldNormal.dot(relpos);if(dot<=0){var r=this.createContactEquation(planeBody,convexBody,planeShape,convexShape);var projected=planeConvex_projected;worldNormal.mult(worldNormal.dot(relpos),projected);worldVertex.vsub(projected,projected);projected.vsub(planePosition,r.ri);r.ni.copy(worldNormal);worldVertex.vsub(convexPosition,r.rj);r.ri.vadd(planePosition,r.ri);r.ri.vsub(planeBody.position,r.ri);r.rj.vadd(convexPosition,r.rj);r.rj.vsub(convexBody.position,r.rj);this.result.push(r);numContacts++;if(!this.enableFrictionReduction){this.createFrictionEquationsFromContact(r,this.frictionResult)}}}if(this.enableFrictionReduction&&numContacts){this.createFrictionFromAverage(numContacts)}};var convexConvex_sepAxis=new Vec3;var convexConvex_q=new Vec3;Narrowphase.prototype[Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.convexConvex=function(si,sj,xi,xj,qi,qj,bi,bj,rsi,rsj,faceListA,faceListB){var sepAxis=convexConvex_sepAxis;if(xi.distanceTo(xj)>si.boundingSphereRadius+sj.boundingSphereRadius){return}if(si.findSeparatingAxis(sj,xi,qi,xj,qj,sepAxis,faceListA,faceListB)){var res=[];var q=convexConvex_q;si.clipAgainstHull(xi,qi,sj,xj,qj,sepAxis,-100,100,res);var numContacts=0;for(var j=0;j!==res.length;j++){var r=this.createContactEquation(bi,bj,si,sj,rsi,rsj),ri=r.ri,rj=r.rj;sepAxis.negate(r.ni);res[j].normal.negate(q);q.mult(res[j].depth,q);res[j].point.vadd(q,ri);rj.copy(res[j].point);ri.vsub(xi,ri);rj.vsub(xj,rj);ri.vadd(xi,ri);ri.vsub(bi.position,ri);rj.vadd(xj,rj);rj.vsub(bj.position,rj);this.result.push(r);numContacts++;if(!this.enableFrictionReduction){this.createFrictionEquationsFromContact(r,this.frictionResult)}}if(this.enableFrictionReduction&&numContacts){this.createFrictionFromAverage(numContacts)}}};var particlePlane_normal=new Vec3;var particlePlane_relpos=new Vec3;var particlePlane_projected=new Vec3;Narrowphase.prototype[Shape.types.PLANE|Shape.types.PARTICLE]=Narrowphase.prototype.planeParticle=function(sj,si,xj,xi,qj,qi,bj,bi){var normal=particlePlane_normal;normal.set(0,0,1);bj.quaternion.vmult(normal,normal);var relpos=particlePlane_relpos;xi.vsub(bj.position,relpos);var dot=normal.dot(relpos);if(dot<=0){var r=this.createContactEquation(bi,bj,si,sj);r.ni.copy(normal);r.ni.negate(r.ni);r.ri.set(0,0,0);var projected=particlePlane_projected;normal.mult(normal.dot(xi),projected);xi.vsub(projected,projected);r.rj.copy(projected);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}};var particleSphere_normal=new Vec3;Narrowphase.prototype[Shape.types.PARTICLE|Shape.types.SPHERE]=Narrowphase.prototype.sphereParticle=function(sj,si,xj,xi,qj,qi,bj,bi){var normal=particleSphere_normal;normal.set(0,0,1);xi.vsub(xj,normal);var lengthSquared=normal.norm2();if(lengthSquared<=sj.radius*sj.radius){var r=this.createContactEquation(bi,bj,si,sj);normal.normalize();r.rj.copy(normal);r.rj.mult(sj.radius,r.rj);r.ni.copy(normal);r.ni.negate(r.ni);r.ri.set(0,0,0);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}};var cqj=new Quaternion;var convexParticle_local=new Vec3;var convexParticle_normal=new Vec3;var convexParticle_penetratedFaceNormal=new Vec3;var convexParticle_vertexToParticle=new Vec3;var convexParticle_worldPenetrationVec=new Vec3;Narrowphase.prototype[Shape.types.PARTICLE|Shape.types.CONVEXPOLYHEDRON]=Narrowphase.prototype.convexParticle=function(sj,si,xj,xi,qj,qi,bj,bi){var penetratedFaceIndex=-1;var penetratedFaceNormal=convexParticle_penetratedFaceNormal;var worldPenetrationVec=convexParticle_worldPenetrationVec;var minPenetration=null;var numDetectedFaces=0;var local=convexParticle_local;local.copy(xi);local.vsub(xj,local);qj.conjugate(cqj);cqj.vmult(local,local);if(sj.pointIsInside(local)){if(sj.worldVerticesNeedsUpdate){sj.computeWorldVertices(xj,qj)}if(sj.worldFaceNormalsNeedsUpdate){sj.computeWorldFaceNormals(qj)}for(var i=0,nfaces=sj.faces.length;i!==nfaces;i++){var verts=[sj.worldVertices[sj.faces[i][0]]];var normal=sj.worldFaceNormals[i];xi.vsub(verts[0],convexParticle_vertexToParticle);var penetration=-normal.dot(convexParticle_vertexToParticle);if(minPenetration===null||Math.abs(penetration)<Math.abs(minPenetration)){minPenetration=penetration;penetratedFaceIndex=i;penetratedFaceNormal.copy(normal);numDetectedFaces++}}if(penetratedFaceIndex!==-1){var r=this.createContactEquation(bi,bj,si,sj);penetratedFaceNormal.mult(minPenetration,worldPenetrationVec);worldPenetrationVec.vadd(xi,worldPenetrationVec);worldPenetrationVec.vsub(xj,worldPenetrationVec);r.rj.copy(worldPenetrationVec);penetratedFaceNormal.negate(r.ni);r.ri.set(0,0,0);var ri=r.ri,rj=r.rj;ri.vadd(xi,ri);ri.vsub(bi.position,ri);rj.vadd(xj,rj);rj.vsub(bj.position,rj);this.result.push(r);this.createFrictionEquationsFromContact(r,this.frictionResult)}else{console.warn("Point found inside convex, but did not find penetrating face!")}}};Narrowphase.prototype[Shape.types.BOX|Shape.types.HEIGHTFIELD]=Narrowphase.prototype.boxHeightfield=function(si,sj,xi,xj,qi,qj,bi,bj){si.convexPolyhedronRepresentation.material=si.material;si.convexPolyhedronRepresentation.collisionResponse=si.collisionResponse;this.convexHeightfield(si.convexPolyhedronRepresentation,sj,xi,xj,qi,qj,bi,bj)};var convexHeightfield_tmp1=new Vec3;var convexHeightfield_tmp2=new Vec3;var convexHeightfield_faceList=[0];Narrowphase.prototype[Shape.types.CONVEXPOLYHEDRON|Shape.types.HEIGHTFIELD]=Narrowphase.prototype.convexHeightfield=function(convexShape,hfShape,convexPos,hfPos,convexQuat,hfQuat,convexBody,hfBody){var data=hfShape.data,w=hfShape.elementSize,radius=convexShape.boundingSphereRadius,worldPillarOffset=convexHeightfield_tmp2,faceList=convexHeightfield_faceList;var localConvexPos=convexHeightfield_tmp1;Transform.pointToLocalFrame(hfPos,hfQuat,convexPos,localConvexPos);var iMinX=Math.floor((localConvexPos.x-radius)/w)-1,iMaxX=Math.ceil((localConvexPos.x+radius)/w)+1,iMinY=Math.floor((localConvexPos.y-radius)/w)-1,iMaxY=Math.ceil((localConvexPos.y+radius)/w)+1;if(iMaxX<0||iMaxY<0||iMinX>data.length||iMinY>data[0].length){return}if(iMinX<0){iMinX=0}if(iMaxX<0){iMaxX=0}if(iMinY<0){iMinY=0}if(iMaxY<0){iMaxY=0}if(iMinX>=data.length){iMinX=data.length-1}if(iMaxX>=data.length){iMaxX=data.length-1}if(iMaxY>=data[0].length){iMaxY=data[0].length-1}if(iMinY>=data[0].length){iMinY=data[0].length-1}var minMax=[];hfShape.getRectMinMax(iMinX,iMinY,iMaxX,iMaxY,minMax);var min=minMax[0];var max=minMax[1];if(localConvexPos.z-radius>max||localConvexPos.z+radius<min){return}for(var i=iMinX;i<iMaxX;i++){for(var j=iMinY;j<iMaxY;j++){hfShape.getConvexTrianglePillar(i,j,false);Transform.pointToWorldFrame(hfPos,hfQuat,hfShape.pillarOffset,worldPillarOffset);if(convexPos.distanceTo(worldPillarOffset)<hfShape.pillarConvex.boundingSphereRadius+convexShape.boundingSphereRadius){this.convexConvex(convexShape,hfShape.pillarConvex,convexPos,worldPillarOffset,convexQuat,hfQuat,convexBody,hfBody,null,null,faceList,null)}hfShape.getConvexTrianglePillar(i,j,true);Transform.pointToWorldFrame(hfPos,hfQuat,hfShape.pillarOffset,worldPillarOffset);if(convexPos.distanceTo(worldPillarOffset)<hfShape.pillarConvex.boundingSphereRadius+convexShape.boundingSphereRadius){this.convexConvex(convexShape,hfShape.pillarConvex,convexPos,worldPillarOffset,convexQuat,hfQuat,convexBody,hfBody,null,null,faceList,null)}}}};var sphereHeightfield_tmp1=new Vec3;var sphereHeightfield_tmp2=new Vec3;Narrowphase.prototype[Shape.types.SPHERE|Shape.types.HEIGHTFIELD]=Narrowphase.prototype.sphereHeightfield=function(sphereShape,hfShape,spherePos,hfPos,sphereQuat,hfQuat,sphereBody,hfBody){var data=hfShape.data,radius=sphereShape.radius,w=hfShape.elementSize,worldPillarOffset=sphereHeightfield_tmp2;var localSpherePos=sphereHeightfield_tmp1;Transform.pointToLocalFrame(hfPos,hfQuat,spherePos,localSpherePos);var iMinX=Math.floor((localSpherePos.x-radius)/w)-1,iMaxX=Math.ceil((localSpherePos.x+radius)/w)+1,iMinY=Math.floor((localSpherePos.y-radius)/w)-1,iMaxY=Math.ceil((localSpherePos.y+radius)/w)+1;if(iMaxX<0||iMaxY<0||iMinX>data.length||iMaxY>data[0].length){return}if(iMinX<0){iMinX=0}if(iMaxX<0){iMaxX=0}if(iMinY<0){iMinY=0}if(iMaxY<0){iMaxY=0}if(iMinX>=data.length){iMinX=data.length-1}if(iMaxX>=data.length){iMaxX=data.length-1}if(iMaxY>=data[0].length){iMaxY=data[0].length-1}if(iMinY>=data[0].length){iMinY=data[0].length-1}var minMax=[];hfShape.getRectMinMax(iMinX,iMinY,iMaxX,iMaxY,minMax);var min=minMax[0];var max=minMax[1];if(localSpherePos.z-radius>max||localSpherePos.z+radius<min){return}var result=this.result;for(var i=iMinX;i<iMaxX;i++){for(var j=iMinY;j<iMaxY;j++){var numContactsBefore=result.length;hfShape.getConvexTrianglePillar(i,j,false);Transform.pointToWorldFrame(hfPos,hfQuat,hfShape.pillarOffset,worldPillarOffset);if(spherePos.distanceTo(worldPillarOffset)<hfShape.pillarConvex.boundingSphereRadius+sphereShape.boundingSphereRadius){this.sphereConvex(sphereShape,hfShape.pillarConvex,spherePos,worldPillarOffset,sphereQuat,hfQuat,sphereBody,hfBody)}hfShape.getConvexTrianglePillar(i,j,true);Transform.pointToWorldFrame(hfPos,hfQuat,hfShape.pillarOffset,worldPillarOffset);if(spherePos.distanceTo(worldPillarOffset)<hfShape.pillarConvex.boundingSphereRadius+sphereShape.boundingSphereRadius){this.sphereConvex(sphereShape,hfShape.pillarConvex,spherePos,worldPillarOffset,sphereQuat,hfQuat,sphereBody,hfBody)}var numContacts=result.length-numContactsBefore;if(numContacts>2){return}}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(_dereq_,module,exports){module.exports=World;var Shape=_dereq_("../shapes/Shape");var Vec3=_dereq_("../math/Vec3");var Quaternion=_dereq_("../math/Quaternion");var GSSolver=_dereq_("../solver/GSSolver");var Vec3Pool=_dereq_("../utils/Vec3Pool");var ContactEquation=_dereq_("../equations/ContactEquation");var FrictionEquation=_dereq_("../equations/FrictionEquation");var Narrowphase=_dereq_("./Narrowphase");var EventTarget=_dereq_("../utils/EventTarget");var ArrayCollisionMatrix=_dereq_("../collision/ArrayCollisionMatrix");var Material=_dereq_("../material/Material");var ContactMaterial=_dereq_("../material/ContactMaterial");var Body=_dereq_("../objects/Body");var TupleDictionary=_dereq_("../utils/TupleDictionary");var RaycastResult=_dereq_("../collision/RaycastResult");var AABB=_dereq_("../collision/AABB");var Ray=_dereq_("../collision/Ray");var NaiveBroadphase=_dereq_("../collision/NaiveBroadphase");function World(){EventTarget.apply(this);this.dt=-1;this.allowSleep=false;this.contacts=[];this.frictionEquations=[];this.quatNormalizeSkip=0;this.quatNormalizeFast=false;this.time=0;this.stepnumber=0;this.default_dt=1/60;this.nextId=0;this.gravity=new Vec3;this.broadphase=new NaiveBroadphase;this.bodies=[];this.solver=new GSSolver;this.constraints=[];this.narrowphase=new Narrowphase(this);this.collisionMatrix=new ArrayCollisionMatrix;this.collisionMatrixPrevious=new ArrayCollisionMatrix;this.materials=[];this.contactmaterials=[];this.contactMaterialTable=new TupleDictionary;this.defaultMaterial=new Material("default");this.defaultContactMaterial=new ContactMaterial(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0});this.doProfiling=false;this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0};this.subsystems=[];this.addBodyEvent={type:"addBody",body:null};this.removeBodyEvent={type:"removeBody",body:null}}World.prototype=new EventTarget;var tmpAABB1=new AABB;var tmpArray1=[];var tmpRay=new Ray;World.prototype.getContactMaterial=function(m1,m2){return this.contactMaterialTable.get(m1.id,m2.id)};World.prototype.numObjects=function(){return this.bodies.length};World.prototype.collisionMatrixTick=function(){var temp=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix;this.collisionMatrix=temp;this.collisionMatrix.reset()};World.prototype.add=World.prototype.addBody=function(body){if(this.bodies.indexOf(body)!==-1){return}body.index=this.bodies.length;this.bodies.push(body);body.world=this;body.initPosition.copy(body.position);body.initVelocity.copy(body.velocity);body.timeLastSleepy=this.time;if(body instanceof Body){body.initAngularVelocity.copy(body.angularVelocity);body.initQuaternion.copy(body.quaternion)}this.collisionMatrix.setNumObjects(this.bodies.length);this.addBodyEvent.body=body;this.dispatchEvent(this.addBodyEvent)};World.prototype.addConstraint=function(c){this.constraints.push(c)};World.prototype.removeConstraint=function(c){var idx=this.constraints.indexOf(c);if(idx!==-1){this.constraints.splice(idx,1)}};World.prototype.rayTest=function(from,to,result){if(result instanceof RaycastResult){this.raycastClosest(from,to,{skipBackfaces:true},result)}else{this.raycastAll(from,to,{skipBackfaces:true},result)}};World.prototype.raycastAll=function(from,to,options,callback){options.mode=Ray.ALL;options.from=from;options.to=to;options.callback=callback;return tmpRay.intersectWorld(this,options)};World.prototype.raycastAny=function(from,to,options,result){options.mode=Ray.ANY;options.from=from;options.to=to;options.result=result;return tmpRay.intersectWorld(this,options)};World.prototype.raycastClosest=function(from,to,options,result){options.mode=Ray.CLOSEST;options.from=from;options.to=to;options.result=result;return tmpRay.intersectWorld(this,options)};World.prototype.remove=function(body){body.world=null;var n=this.bodies.length-1,bodies=this.bodies,idx=bodies.indexOf(body);if(idx!==-1){bodies.splice(idx,1);for(var i=0;i!==bodies.length;i++){bodies[i].index=i}this.collisionMatrix.setNumObjects(n);this.removeBodyEvent.body=body;this.dispatchEvent(this.removeBodyEvent)}};World.prototype.removeBody=World.prototype.remove;World.prototype.addMaterial=function(m){this.materials.push(m)};World.prototype.addContactMaterial=function(cmat){this.contactmaterials.push(cmat);this.contactMaterialTable.set(cmat.materials[0].id,cmat.materials[1].id,cmat)};if(typeof performance==="undefined"){performance={}}if(!performance.now){var nowOffset=Date.now();if(performance.timing&&performance.timing.navigationStart){nowOffset=performance.timing.navigationStart}performance.now=function(){return Date.now()-nowOffset}}var step_tmp1=new Vec3;World.prototype.step=function(dt,timeSinceLastCalled,maxSubSteps){maxSubSteps=maxSubSteps||10;timeSinceLastCalled=timeSinceLastCalled||0;if(timeSinceLastCalled===0){this.internalStep(dt);this.time+=dt}else{var internalSteps=Math.floor((this.time+timeSinceLastCalled)/dt)-Math.floor(this.time/dt);internalSteps=Math.min(internalSteps,maxSubSteps);var t0=performance.now();for(var i=0;i!==internalSteps;i++){this.internalStep(dt);if(performance.now()-t0>dt*1e3){break}}this.time+=timeSinceLastCalled;var h=this.time%dt;var h_div_dt=h/dt;var interpvelo=step_tmp1;var bodies=this.bodies;for(var j=0;j!==bodies.length;j++){var b=bodies[j];if(b.type!==Body.STATIC&&b.sleepState!==Body.SLEEPING){b.position.vsub(b.previousPosition,interpvelo);interpvelo.scale(h_div_dt,interpvelo);b.position.vadd(interpvelo,b.interpolatedPosition)}else{b.interpolatedPosition.copy(b.position);b.interpolatedQuaternion.copy(b.quaternion)}}}};var World_step_postStepEvent={type:"postStep"},World_step_preStepEvent={type:"preStep"},World_step_collideEvent={type:"collide",body:null,contact:null},World_step_oldContacts=[],World_step_frictionEquationPool=[],World_step_p1=[],World_step_p2=[],World_step_gvec=new Vec3,World_step_vi=new Vec3,World_step_vj=new Vec3,World_step_wi=new Vec3,World_step_wj=new Vec3,World_step_t1=new Vec3,World_step_t2=new Vec3,World_step_rixn=new Vec3,World_step_rjxn=new Vec3,World_step_step_q=new Quaternion,World_step_step_w=new Quaternion,World_step_step_wq=new Quaternion,invI_tau_dt=new Vec3;World.prototype.internalStep=function(dt){this.dt=dt;var world=this,that=this,contacts=this.contacts,p1=World_step_p1,p2=World_step_p2,N=this.numObjects(),bodies=this.bodies,solver=this.solver,gravity=this.gravity,doProfiling=this.doProfiling,profile=this.profile,DYNAMIC=Body.DYNAMIC,profilingStart,constraints=this.constraints,frictionEquationPool=World_step_frictionEquationPool,gnorm=gravity.norm(),gx=gravity.x,gy=gravity.y,gz=gravity.z,i=0;if(doProfiling){profilingStart=performance.now()}for(i=0;i!==N;i++){var bi=bodies[i];if(bi.type&DYNAMIC){var f=bi.force,m=bi.mass;f.x+=m*gx;f.y+=m*gy;f.z+=m*gz}}for(var i=0,Nsubsystems=this.subsystems.length;i!==Nsubsystems;i++){this.subsystems[i].update()}if(doProfiling){profilingStart=performance.now()}p1.length=0;p2.length=0;this.broadphase.collisionPairs(this,p1,p2);if(doProfiling){profile.broadphase=performance.now()-profilingStart}var Nconstraints=constraints.length;for(i=0;i!==Nconstraints;i++){var c=constraints[i];if(!c.collideConnected){for(var j=p1.length-1;j>=0;j-=1){if(c.bodyA===p1[j]&&c.bodyB===p2[j]||c.bodyB===p1[j]&&c.bodyA===p2[j]){p1.splice(j,1);p2.splice(j,1)}}}}this.collisionMatrixTick();if(doProfiling){profilingStart=performance.now()}var oldcontacts=World_step_oldContacts;var NoldContacts=contacts.length;for(i=0;i!==NoldContacts;i++){oldcontacts.push(contacts[i])}contacts.length=0;var NoldFrictionEquations=this.frictionEquations.length;for(i=0;i!==NoldFrictionEquations;i++){frictionEquationPool.push(this.frictionEquations[i])}this.frictionEquations.length=0;this.narrowphase.getContacts(p1,p2,this,contacts,oldcontacts,this.frictionEquations,frictionEquationPool);if(doProfiling){profile.narrowphase=performance.now()-profilingStart}if(doProfiling){profilingStart=performance.now()}for(var i=0;i<this.frictionEquations.length;i++){solver.addEquation(this.frictionEquations[i])}var ncontacts=contacts.length;for(var k=0;k!==ncontacts;k++){var c=contacts[k];var bi=c.bi,bj=c.bj,si=c.si,sj=c.sj;var cm;if(bi.material&&bj.material){cm=this.getContactMaterial(bi.material,bj.material)||this.defaultContactMaterial}else{cm=this.defaultContactMaterial}var mu=cm.friction;if(bi.material&&bj.material){if(bi.material.friction>=0&&bj.material.friction>=0){mu=bi.material.friction*bj.material.friction}if(bi.material.restitution>=0&&bj.material.restitution>=0){c.restitution=bi.material.restitution*bj.material.restitution}}solver.addEquation(c);if(bi.allowSleep&&bi.type===Body.DYNAMIC&&bi.sleepState===Body.SLEEPING&&bj.sleepState===Body.AWAKE&&bj.type!==Body.STATIC){var speedSquaredB=bj.velocity.norm2()+bj.angularVelocity.norm2();var speedLimitSquaredB=Math.pow(bj.sleepSpeedLimit,2);if(speedSquaredB>=speedLimitSquaredB*2){bi._wakeUpAfterNarrowphase=true}}if(bj.allowSleep&&bj.type===Body.DYNAMIC&&bj.sleepState===Body.SLEEPING&&bi.sleepState===Body.AWAKE&&bi.type!==Body.STATIC){var speedSquaredA=bi.velocity.norm2()+bi.angularVelocity.norm2();var speedLimitSquaredA=Math.pow(bi.sleepSpeedLimit,2);if(speedSquaredA>=speedLimitSquaredA*2){bj._wakeUpAfterNarrowphase=true}}this.collisionMatrix.set(bi,bj,true);if(!this.collisionMatrixPrevious.get(bi,bj)){World_step_collideEvent.body=bj;World_step_collideEvent.contact=c;bi.dispatchEvent(World_step_collideEvent);World_step_collideEvent.body=bi;bj.dispatchEvent(World_step_collideEvent)}}if(doProfiling){profile.makeContactConstraints=performance.now()-profilingStart;profilingStart=performance.now()}for(i=0;i!==N;i++){var bi=bodies[i];if(bi._wakeUpAfterNarrowphase){bi.wakeUp();bi._wakeUpAfterNarrowphase=false}}var Nconstraints=constraints.length;for(i=0;i!==Nconstraints;i++){var c=constraints[i];c.update();for(var j=0,Neq=c.equations.length;j!==Neq;j++){var eq=c.equations[j];solver.addEquation(eq)}}solver.solve(dt,this);if(doProfiling){profile.solve=performance.now()-profilingStart}solver.removeAllEquations();var pow=Math.pow;for(i=0;i!==N;i++){var bi=bodies[i];if(bi.type&DYNAMIC){var ld=pow(1-bi.linearDamping,dt);var v=bi.velocity;v.mult(ld,v);var av=bi.angularVelocity;if(av){var ad=pow(1-bi.angularDamping,dt);av.mult(ad,av)}}}this.dispatchEvent(World_step_preStepEvent);for(i=0;i!==N;i++){var bi=bodies[i];if(bi.preStep){bi.preStep.call(bi)}}if(doProfiling){profilingStart=performance.now()}var q=World_step_step_q;var w=World_step_step_w;var wq=World_step_step_wq;var stepnumber=this.stepnumber;var DYNAMIC_OR_KINEMATIC=Body.DYNAMIC|Body.KINEMATIC;var quatNormalize=stepnumber%(this.quatNormalizeSkip+1)===0;var quatNormalizeFast=this.quatNormalizeFast;var half_dt=dt*.5;var PLANE=Shape.types.PLANE,CONVEX=Shape.types.CONVEXPOLYHEDRON;for(i=0;i!==N;i++){var b=bodies[i],force=b.force,tau=b.torque;if(b.type&DYNAMIC_OR_KINEMATIC&&b.sleepState!==Body.SLEEPING){var velo=b.velocity,angularVelo=b.angularVelocity,pos=b.position,quat=b.quaternion,invMass=b.invMass,invInertia=b.invInertiaWorld;velo.x+=force.x*invMass*dt;velo.y+=force.y*invMass*dt;velo.z+=force.z*invMass*dt;if(b.angularVelocity){invInertia.vmult(tau,invI_tau_dt);invI_tau_dt.mult(dt,invI_tau_dt);invI_tau_dt.vadd(angularVelo,angularVelo)}pos.x+=velo.x*dt;pos.y+=velo.y*dt;pos.z+=velo.z*dt;if(b.angularVelocity){w.set(angularVelo.x,angularVelo.y,angularVelo.z,0);w.mult(quat,wq);quat.x+=half_dt*wq.x;quat.y+=half_dt*wq.y;quat.z+=half_dt*wq.z;quat.w+=half_dt*wq.w;if(quatNormalize){if(quatNormalizeFast){quat.normalizeFast()}else{quat.normalize()}}}if(b.aabb){b.aabbNeedsUpdate=true}if(b.updateInertiaWorld){b.updateInertiaWorld()}}}this.clearForces();this.broadphase.dirty=true;if(doProfiling){profile.integrate=performance.now()-profilingStart}this.time+=dt;this.stepnumber+=1;this.dispatchEvent(World_step_postStepEvent);for(i=0;i!==N;i++){var bi=bodies[i];var postStep=bi.postStep;if(postStep){postStep.call(bi)}}if(this.allowSleep){for(i=0;i!==N;i++){bodies[i].sleepTick(this.time)}}};World.prototype.clearForces=function(){var bodies=this.bodies;var N=bodies.length;for(var i=0;i!==N;i++){var b=bodies[i],force=b.force,tau=b.torque;b.force.set(0,0,0);b.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var registry={};var Component3d=function(){function Component3d(){_classCallCheck(this,Component3d)}_createClass(Component3d,null,[{key:"register",value:function register(type,clazz){if(!clazz)return registry[type];registry[type]=clazz}}]);return Component3d}();exports.default=Component3d;scene.Component3d=Component3d},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _babylonjs=require("babylonjs");var BABYLON=_interopRequireWildcard(_babylonjs);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Floor=function(){function Floor(visualizer,model,scene){_classCallCheck(this,Floor);this._visualizer=visualizer;this._model=model;this._scene=scene;this.createObject(model,scene)}_createClass(Floor,[{key:"getAssets",value:function getAssets(url){var task=this._visualizer.assetsManager.addTextureTask("floor-material task",url);task.onSuccess=function(task){this._material.opacityTexture=task.texture;this._material.diffuseTexture=task.texture}.bind(this)}},{key:"createObject",value:function createObject(model,scene){var x=model.x,y=model.y,z=model.z,width=model.width,height=model.height,depth=model.depth,rotation=model.rotation,id=model.id,_model$fillStyle=model.fillStyle,fillStyle=_model$fillStyle===undefined?"#fff":_model$fillStyle;var rgbaRegExp=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/;this.type=model.type;this._object=BABYLON.Mesh.CreateGround(id,width,depth,1,scene);this._material=new BABYLON.StandardMaterial("floor-material",scene);if(fillStyle.type=="pattern"&&fillStyle.image)this.getAssets(this._visualizer.app.url(fillStyle.image));else{var rgba={};var color;var matched=rgbaRegExp.exec(fillStyle);if(matched&&matched.length>0){matched=matched.splice(1);matched=matched.filter(function(m){return!!m});if(matched.length===3)color=BABYLON.Color3.FromArray(matched);else{color=BABYLON.Color4.FromArray(matched);this._material.alpha=matched[3]}}else{color=BABYLON.Color3.FromHexString(fillStyle)}this._material.diffuseColor=color}this._object.material=this._material}}]);return Floor}();exports.default=Floor;scene.Component3d.register("floor",Floor)},{babylonjs:2}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _component3d=require("./component-3d");Object.defineProperty(exports,"Component3d",{enumerable:true,get:function get(){return _interopRequireDefault(_component3d).default}});var _visualizer=require("./visualizer");Object.defineProperty(exports,"Visualizer",{enumerable:true,get:function get(){return _interopRequireDefault(_visualizer).default}});var _floor=require("./floor");Object.defineProperty(exports,"Floor",{enumerable:true,get:function get(){return _interopRequireDefault(_floor).default}});var _rack=require("./rack");Object.defineProperty(exports,"Rack",{enumerable:true,get:function get(){return _interopRequireDefault(_rack).default}});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}},{"./component-3d":4,"./floor":5,"./rack":7,"./visualizer":8}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _babylonjs=require("babylonjs");var BABYLON=_interopRequireWildcard(_babylonjs);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Rack=function(){function Rack(visualizer,model,scene){_classCallCheck(this,Rack);this._visualizer=visualizer;this._model=model;this._scene=scene;this.createObject(model,scene)}_createClass(Rack,[{key:"createObject",value:function createObject(model,scene){var id=model.id,_model$x=model.x,x=_model$x===undefined?0:_model$x,_model$y=model.y,y=_model$y===undefined?0:_model$y,_model$z=model.z,z=_model$z===undefined?0:_model$z,height=model.height,_model$shelves=model.shelves,shelves=_model$shelves===undefined?1:_model$shelves;this._object=new BABYLON.Mesh(id,scene);this.createRackFrame(model,scene);y=y>height/2?y:0;this._object.setAbsolutePosition(new BABYLON.Vector3(x,y+height*shelves/2,z))}},{key:"createRackFrame",value:function createRackFrame(model,scene){var stockScaleFactor=.7;var width=model.width,height=model.height,depth=model.depth,x=model.x,y=model.y,z=model.z,_model$shelves2=model.shelves,shelves=_model$shelves2===undefined?1:_model$shelves2,shelfPattern=model.shelfPattern;var frameWeight=Math.round(Math.min(width,depth)/10);var frameHeight=height*shelves;var frameModel={height:frameHeight,width:frameWeight,depth:frameWeight};var frameBottom=frameHeight/2;var frameWidthArr=[width/2-frameWeight/2,width/2-frameWeight/2,-(width/2-frameWeight/2),-(width/2-frameWeight/2)];var frameDepthArr=[depth/2-frameWeight/2,-depth/2-frameWeight/2,depth/2-frameWeight/2,-depth/2-frameWeight/2];var parent=this._object;for(var i=0;i<4;i++){var frame=BABYLON.MeshBuilder.CreateBox(null,frameModel,scene);frame.parent=parent;frame.position.set(frameWidthArr[i],0,frameDepthArr[i])}var boardModel={width:width,height:depth,sideOrientation:BABYLON.Mesh.DOUBLESIDE};var boardMaterial=new BABYLON.StandardMaterial("boardMaterial",scene);boardMaterial.useAlphaFromDiffuseTexture=true;boardMaterial.diffuseColor=BABYLON.Color3.FromInts(33,33,33);boardMaterial.alpha=.5;var stockModel={width:width*.7,height:height*.7,depth:depth*.7};var stockMaterial=new BABYLON.StandardMaterial("stockMaterial",scene);stockMaterial.diffuseColor=BABYLON.Color3.FromHexString("#ccaa76");for(var i=0;i<shelves;i++){var bottom=-model.height*model.shelves*.5;if(i>0){var board=BABYLON.MeshBuilder.CreatePlane(null,boardModel,scene);board.parent=parent;board.position.set(0,bottom+model.height*i,0);board.rotation.x=-Math.PI/2;board.material=boardMaterial}var stockId=this.makeLocationString(this.makeShelfString(shelfPattern,i+1,model.shelves));var stock=BABYLON.MeshBuilder.CreateBox(stockId,stockModel,scene);stock.parent=parent;stock.material=stockMaterial;stock.position.set(0,bottom+model.height*i+stockModel.height/2,0)}}},{key:"makeLocationString",value:function makeLocationString(shelfString){var _model=this._model,_model$locPattern=_model.locPattern,locPattern=_model$locPattern===undefined?"{z}{s}-{u}-{sh}":_model$locPattern,_model$zone=_model.zone,zone=_model$zone===undefined?"":_model$zone,_model$section=_model.section,section=_model$section===undefined?"":_model$section,_model$unit=_model.unit,unit=_model$unit===undefined?"":_model$unit;var locationString=locPattern;locationString=locationString.replace(/{z}/i,zone);locationString=locationString.replace(/{s}/i,section);locationString=locationString.replace(/{u}/i,unit);locationString=locationString.replace(/{sh}/i,shelfString);return locationString}},{key:"makeShelfString",value:function makeShelfString(pattern,shelf,length){if(!pattern||!shelf||!length)return;var isReverse=/^\-/.test(pattern);pattern=pattern.replace(/#+/,"#");var fixedLength=(pattern.match(/0/g)||[]).length||0;var shelfString=String(isReverse?length-shelf+1:shelf);if(shelfString.length>fixedLength&&fixedLength>0){shelfString=shelfString.split("").shift(shelfString.length-fixedLength).join("")}else{var prefix="";for(var i=0;i<fixedLength-shelfString.length;i++){prefix+="0"}shelfString=prefix+shelfString}return shelfString}},{key:"raycast",value:function raycast(raycaster,intersects){}},{key:"onchange",value:function onchange(after,before){if(after.hasOwnProperty("data")){this.data=after.data}}}],[{key:"boardMaterial",get:function get(){if(!Rack._boardMaterial)Rack._boardMaterial=new THREE.MeshBasicMaterial({color:"#dedede",side:THREE.DoubleSide});return Rack._boardMaterial}},{key:"frameMaterial",get:function get(){if(!Rack._frameMaterial)Rack._frameMaterial=new THREE.MeshLambertMaterial({color:13421772});return Rack._frameMaterial}}]);return Rack}();exports.default=Rack;scene.Component3d.register("rack",Rack)},{babylonjs:2}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _babylonjs=require("babylonjs");var BABYLON=_interopRequireWildcard(_babylonjs);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _scene=scene,Component=_scene.Component,Container=_scene.Container,Layout=_scene.Layout;var NATURE={mutable:false,resizable:true,rotatable:true,properties:[{type:"number",label:"fov",name:"fov",property:"fov"},{type:"number",label:"near",name:"near",property:"near"},{type:"number",label:"far",name:"far",property:"far"},{type:"number",label:"zoom",name:"zoom",property:"zoom"},{type:"select",label:"precision",name:"precision",property:{options:["highp","mediump","lowp"]}},{type:"checkbox",label:"anti-alias",name:"antialias",property:"antialias"},{type:"checkbox",label:"auto-rotate",name:"autoRotate",property:"autoRotate"},{type:"checkbox",label:"show-axis",name:"showAxis",property:"showAxis"},{type:"checkbox",label:"3dmode",name:"threed",property:"threed"}]};var WEBGL_NO_SUPPORT_TEXT="WebGL is not supported";function registerLoaders(){if(!registerLoaders.done){THREE.Loader.Handlers.add(/\.tga$/i,new THREE.TGALoader);registerLoaders.done=true}}var Visualizer=function(_Container){_inherits(Visualizer,_Container);function Visualizer(){_classCallCheck(this,Visualizer);return _possibleConstructorReturn(this,(Visualizer.__proto__||Object.getPrototypeOf(Visualizer)).apply(this,arguments))}_createClass(Visualizer,[{key:"containable",value:function containable(component){return component.is3dish()}},{key:"putObject",value:function putObject(id,object){if(!this._objects)this._objects={};this._objects[id]=object}},{key:"getObject",value:function getObject(id){if(!this._objects)this._objects={};return this._objects[id]}},{key:"getRegister",value:function getRegister(type){return scene.Component3d.register(type)}},{key:"createObjects",value:function createObjects(components){var _this2=this;components.forEach(function(component){var clazz=scene.Component3d.register(component.type);var transModel=_this2.transcoord3d(component);if(!clazz){console.warn("Class not found : 3d class is not exist");return}var item=new clazz(_this2,transModel,_this2.scene);if(item){_this2.putObject(component.id,item)}});this.assetsManager.load()}},{key:"createScene",value:function createScene(){var model=this.transcoord3d(this.model);var maxSize=Math.max(model.width,model.depth);var minSize=Math.min(model.width,model.depth);var scene=new BABYLON.Scene(this.engine);this.assetsManager=new BABYLON.AssetsManager(scene);this.assetsManager.onFinish=function(tasks){this.engine.runRenderLoop(function(){this.scene.render()}.bind(this))}.bind(this);var camera=new BABYLON.ArcRotateCamera("camera1",0,0,10,new BABYLON.Vector3(0,0,0),scene);camera.upperBetaLimit=1.4835298642;camera.allowUpsideDown=false;camera.setPosition(new BABYLON.Vector3(0,minSize,maxSize));camera.attachControl(this.canvas,true);var light=new BABYLON.HemisphericLight("hemi-light",new BABYLON.Vector3(0,1,0),scene);var ground=new(this.getRegister("floor"))(this,model,scene);scene.registerBeforeRender(function(){if(model.autoRotate)camera.alpha+=.001*scene.getAnimationRatio()});return scene}},{key:"_draw",value:function _draw(ctx){if(this.app.isViewMode){if(!this.model.threed)this.model.threed=true}if(this.model.threed&&!this._noSupportWebgl){return}_get(Visualizer.prototype.__proto__||Object.getPrototypeOf(Visualizer.prototype),"_draw",this).call(this,ctx)}},{key:"_post_draw",value:function _post_draw(ctx){var _model=this.model,left=_model.left,top=_model.top,width=_model.width,height=_model.height,threed=_model.threed,showAxis=_model.showAxis;if(threed){this._initialize()}else{_get(Visualizer.prototype.__proto__||Object.getPrototypeOf(Visualizer.prototype),"_post_draw",this).call(this,ctx)}}},{key:"_initialize",value:function _initialize(){var components=this.hierarchy.components;var antialias=this.model.antialias;var transModel=this.transcoord3d(this.model);var threedLayer=this.root.assist_layers.filter(function(layer){return layer.model.type=="threed-layer"})[0];this.canvas=threedLayer.canvas;this.engine=new BABYLON.Engine(this.canvas,antialias);this.scene=this.createScene();if(this.model.showAxis)this.showAxis(Math.min(transModel.width,transModel.depth));this.engine.runRenderLoop(function(){this.scene.render()}.bind(this));window.addEventListener("resize",function(){this.engine.resize()}.bind(this));this.createObjects(components)}},{key:"showAxis",value:function showAxis(size){var scene=this.scene;var makeTextPlane=function makeTextPlane(text,color,size){var dynamicTexture=new BABYLON.DynamicTexture("DynamicTexture",50,scene,true);dynamicTexture.hasAlpha=true;dynamicTexture.drawText(text,5,40,"bold 36px Arial",color,"transparent",true);var plane=new BABYLON.Mesh.CreatePlane("TextPlane",size,scene,true);plane.material=new BABYLON.StandardMaterial("TextPlaneMaterial",scene);plane.material.backFaceCulling=false;plane.material.specularColor=new BABYLON.Color3(0,0,0);plane.material.diffuseTexture=dynamicTexture;return plane};var axisX=BABYLON.Mesh.CreateLines("axisX",[new BABYLON.Vector3.Zero,new BABYLON.Vector3(size,0,0),new BABYLON.Vector3(size*.95,.05*size,0),new BABYLON.Vector3(size,0,0),new BABYLON.Vector3(size*.95,-.05*size,0)],scene);axisX.color=new BABYLON.Color3(1,0,0);var xChar=makeTextPlane("X","red",size/10);xChar.position=new BABYLON.Vector3(.9*size,-.05*size,0);var axisY=BABYLON.Mesh.CreateLines("axisY",[new BABYLON.Vector3.Zero,new BABYLON.Vector3(0,size,0),new BABYLON.Vector3(-.05*size,size*.95,0),new BABYLON.Vector3(0,size,0),new BABYLON.Vector3(.05*size,size*.95,0)],scene);axisY.color=new BABYLON.Color3(0,1,0);var yChar=makeTextPlane("Y","green",size/10);yChar.position=new BABYLON.Vector3(0,.9*size,-.05*size);var axisZ=BABYLON.Mesh.CreateLines("axisZ",[new BABYLON.Vector3.Zero,new BABYLON.Vector3(0,0,size),new BABYLON.Vector3(0,-.05*size,size*.95),new BABYLON.Vector3(0,0,size),new BABYLON.Vector3(0,.05*size,size*.95)],scene);axisZ.color=new BABYLON.Color3(0,0,1);var zChar=makeTextPlane("Z","blue",size/10);zChar.position=new BABYLON.Vector3(0,.05*size,.9*size)}},{key:"dispose",value:function dispose(){_get(Visualizer.prototype.__proto__||Object.getPrototypeOf(Visualizer.prototype),"dispose",this).call(this);this.destroy_scene3d()}},{key:"transcoord3d",value:function transcoord3d(position){var left=position.left,top=position.top,_position$zPos=position.zPos,zPos=_position$zPos===undefined?0:_position$zPos,width=position.width,height=position.height,_position$depth=position.depth,depth=_position$depth===undefined?0:_position$depth;var transPos=JSON.parse(JSON.stringify(position));transPos.width=width;transPos.height=depth;transPos.depth=height;transPos.x=-(left-this.model.width/2+width/2);transPos.y=zPos+depth/2;transPos.z=top-this.model.height/2+height/2;return transPos}},{key:"_onDataChanged",value:function _onDataChanged(){var _this3=this;if(this._data){if(this._data instanceof Array){this._data.forEach(function(d){var data=d;setTimeout(function(){var loc=data.loc||data.LOC||data.location||data.LOCATION;var object=this.getObject(loc);if(object){object.userData=data;object.onUserDataChanged()}}.bind(_this3))})}else{var _loop=function _loop(){var location=loc;if(_this3._data.hasOwnProperty(location)){setTimeout(function(){var d=this._data[location];var object=this.getObject(location);if(object){object.userData=d;object.onUserDataChanged()}}.bind(_this3))}};for(var loc in this._data){_loop()}}}this._dataChanged=false;this.render_threed()}},{key:"onchange",value:function onchange(after,before){if(after.hasOwnProperty("width")||after.hasOwnProperty("height")||after.hasOwnProperty("threed"))this.destroy_scene3d();if(after.hasOwnProperty("autoRotate")){this._controls.autoRotate=after.autoRotate}if(after.hasOwnProperty("fov")||after.hasOwnProperty("near")||after.hasOwnProperty("far")||after.hasOwnProperty("zoom")){this._camera.near=this.model.near;this._camera.far=this.model.far;this._camera.zoom=this.model.zoom*.01;this._camera.fov=this.model.fov;this._camera.updateProjectionMatrix();this._controls.cameraChanged=true;this._controls.update()}if(after.hasOwnProperty("data")){if(this._data!==after.data){this._data=after.data;this._dataChanged=true}}this.invalidate()}},{key:"onmousedown",value:function onmousedown(e){if(this._controls){this._controls.onMouseDown(e)}}},{key:"onmousemove",value:function onmousemove(e){if(this._controls){var pointer=this.transcoordC2S(e.offsetX,e.offsetY);this._mouse.x=(pointer.x-this.model.left)/this.model.width*2-1;this._mouse.y=-((pointer.y-this.model.top)/this.model.height)*2+1;var object=this.getObjectByRaycast();if(object&&object.onmousemove)object.onmousemove(e,this);else{if(!this._scene2d)return;this._scene2d.remove(this._scene2d.getObjectByName("tooltip"));this.render_threed()}this._controls.onMouseMove(e);e.stopPropagation()}}},{key:"onmouseleave",value:function onmouseleave(e){if(!this._scene2d)return;var tooltip=this._scene2d.getObjectByName("tooltip");if(tooltip){this._scene2d.remove(tooltip)}}},{key:"onwheel",value:function onwheel(e){if(this._controls){this.handleMouseWheel(e);e.stopPropagation()}}},{key:"ondragstart",value:function ondragstart(e){if(this._controls){var pointer=this.transcoordC2S(e.offsetX,e.offsetY);this._mouse.x=(pointer.x-this.model.left)/this.model.width*2-1;this._mouse.y=-((pointer.y-this.model.top)/this.model.height)*2+1;this._controls.onDragStart(e);e.stopPropagation()}}},{key:"ondragmove",value:function ondragmove(e){if(this._controls){this._controls.onDragMove(e);e.stopPropagation()}}},{key:"ondragend",value:function ondragend(e){if(this._controls){this._controls.onDragEnd(e);e.stopPropagation()}}},{key:"ontouchstart",value:function ontouchstart(e){if(this._controls){this._controls.onTouchStart(e);e.stopPropagation()}}},{key:"ontouchmove",value:function ontouchmove(e){if(this._controls){this._controls.onTouchMove(e);e.stopPropagation()}}},{key:"ontouchend",value:function ontouchend(e){if(this._controls){this._controls.onTouchEnd(e);e.stopPropagation()}}},{key:"onkeydown",value:function onkeydown(e){if(this._controls){this._controls.onKeyDown(e);e.stopPropagation()}}},{key:"handleMouseWheel",value:function handleMouseWheel(event){var delta=0;var zoom=this.model.zoom;delta=-event.deltaY;zoom+=delta*.01;if(zoom<0)zoom=0;this.set("zoom",zoom)}},{key:"nature",get:function get(){return NATURE}}]);return Visualizer}(Container);exports.default=Visualizer;Component.register("visualizer",Visualizer)},{babylonjs:2}]},{},[6]);